(window.webpackJsonp=window.webpackJsonp||[]).push([[12],[,,,,,,,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ClientReady="im.vector.ready",e.HangupCall="im.vector.hangup",e.OpenIntegrationManager="integration_manager_open",e.ViewRoom="io.element.view_room"}(n||(n={}))},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(17),a=s.n(n);async function i(e=""){""===e||e.endsWith("/")||(e+="/");const t=o(`${e}config.${document.domain}.json`),s=o(e+"config.json");try{const e=await t;if(0===Object.keys(e).length)throw new Error;return e}catch(e){return await s}}function o(e){return new Promise((function(t,s){a()({method:"GET",url:e,qs:{cachebuster:Date.now()}},(e,n,a)=>{try{if(e||n.status<200||n.status>=300)return n&&(404==n.status||0==n.status&&""==a)&&t({}),void s({err:e,response:n});t(JSON.parse(a))}catch(e){s({err:e})}})}))}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"rageshakePromise",(function(){return $})),s.d(t,"preparePlatform",(function(){return Y})),s.d(t,"loadConfig",(function(){return J})),s.d(t,"loadOlm",(function(){return Q})),s.d(t,"loadLanguage",(function(){return X})),s.d(t,"loadSkin",(function(){return Z})),s.d(t,"loadTheme",(function(){return ee})),s.d(t,"loadApp",(function(){return te})),s.d(t,"showError",(function(){return se})),s.d(t,"showIncompatibleBrowser",(function(){return ne})),s.d(t,"_t",(function(){return ae}));var n=s(771),a=s(772),i=s.n(a),o=s(139),r=s(81),l=s.n(r),c=s(83),d=s(88),m=s(100),h=s.n(m),u=s(252),p=s(37),g=s(1485);class f extends u.e{constructor(...e){super(...e),h()(this,"_favicon",void 0)}async getConfig(){return Object(p.a)()}getHumanReadableName(){return"Vector Base Platform"}get favicon(){return this._favicon?this._favicon:this._favicon=new g.a}_updateFavicon(){let e="#d00",t=this.notificationCount;this.errorDidOccur&&(t=t||"×",e="#f00"),this.favicon.badge(t,{bgColor:e})}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),this._updateFavicon())}setErrorStatus(e){this.errorDidOccur!==e&&(super.setErrorStatus(e),this._updateFavicon())}startUpdater(){}getDefaultDeviceDisplayName(){return Object(c.a)("Unknown device")}}var b=s(87),v=s(92),_=s(461),y=s(89),E=s(290),C=s(117),w=s(459),S=s(99),x=s(179),R=s(94),O=s(456),k=s(138),I=s(753);function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const j=window.electron,N=navigator.platform.toUpperCase().includes("MAC");function P(e){["call_state"].includes(e.action)&&j.send("app_onAction",e)}class D extends class{async supportsEventIndexing(){return!0}async initEventIndex(e,t){throw new Error("Unimplemented")}async addEventToIndex(e,t){throw new Error("Unimplemented")}async deleteEvent(e){throw new Error("Unimplemented")}indexIsEmpty(){throw new Error("Unimplemented")}isRoomIndexed(e){throw new Error("Unimplemented")}async getStats(){throw new Error("Unimplemented")}async getUserVersion(){throw new Error("Unimplemented")}async setUserVersion(e){throw new Error("Unimplemented")}async commitLiveEvents(){throw new Error("Unimplemented")}async searchEventIndex(e){throw new Error("Unimplemented")}async addHistoricEvents(e,t,s){throw new Error("Unimplemented")}async addCrawlerCheckpoint(e){throw new Error("Unimplemented")}async removeCrawlerCheckpoint(e){throw new Error("Unimplemented")}async loadCheckpoints(){throw new Error("Unimplemented")}async loadFileEvents(e){throw new Error("Unimplemented")}async closeEventIndex(){throw new Error("Unimplemented")}async deleteEventIndex(){throw new Error("Unimplemented")}}{constructor(){super(),h()(this,"pendingIpcCalls",{}),h()(this,"nextIpcCallId",0),h()(this,"_onIpcReply",(e,t)=>{if(void 0===t.id)return void console.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void console.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),j.on("seshatReply",this._onIpcReply)}async _ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,a)=>{this.pendingIpcCalls[s]={resolve:n,reject:a},window.electron.send("seshat",{id:s,name:e,args:t})})}async supportsEventIndexing(){return this._ipcCall("supportsEventIndexing")}async initEventIndex(e,t){return this._ipcCall("initEventIndex",e,t)}async addEventToIndex(e,t){return this._ipcCall("addEventToIndex",e,t)}async deleteEvent(e){return this._ipcCall("deleteEvent",e)}async isEventIndexEmpty(){return this._ipcCall("isEventIndexEmpty")}async isRoomIndexed(e){return this._ipcCall("isRoomIndexed",e)}async commitLiveEvents(){return this._ipcCall("commitLiveEvents")}async searchEventIndex(e){return this._ipcCall("searchEventIndex",e)}async addHistoricEvents(e,t,s){return this._ipcCall("addHistoricEvents",e,t,s)}async addCrawlerCheckpoint(e){return this._ipcCall("addCrawlerCheckpoint",e)}async removeCrawlerCheckpoint(e){return this._ipcCall("removeCrawlerCheckpoint",e)}async loadFileEvents(e){return this._ipcCall("loadFileEvents",e)}async loadCheckpoints(){return this._ipcCall("loadCheckpoints")}async closeEventIndex(){return this._ipcCall("closeEventIndex")}async getStats(){return this._ipcCall("getStats")}async getUserVersion(){return this._ipcCall("getUserVersion")}async setUserVersion(e){return this._ipcCall("setUserVersion",e)}async deleteEventIndex(){return this._ipcCall("deleteEventIndex")}}class A extends f{constructor(){super(),h()(this,"eventIndexManager",new D),h()(this,"pendingIpcCalls",{}),h()(this,"nextIpcCallId",0),h()(this,"ssoID",Object(x.a)(32)),h()(this,"onUpdateDownloaded",async(e,{releaseNotes:t,releaseName:s})=>{b.a.dispatch({action:R.a.CheckUpdates,status:u.d.Ready}),this.shouldShowUpdate(s)&&Object(O.b)(await this.getAppVersion(),s,t)}),h()(this,"_onIpcReply",(e,t)=>{if(void 0===t.id)return void console.warn("Ignoring IPC reply with no ID");if(void 0===this.pendingIpcCalls[t.id])return void console.warn("Unknown IPC payload ID: "+t.id);const s=this.pendingIpcCalls[t.id];delete this.pendingIpcCalls[t.id],t.error?s.reject(t.error):s.resolve(t.reply)}),b.a.register(P),j.on("check_updates",(e,t)=>{b.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){h()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:R.a.CheckUpdates},function(e){return!0===e?{status:u.d.Downloading}:!1===e?{status:u.d.NotAvailable}:{status:u.d.Error,detail:e}}(t)))}),j.on("before-quit",(function(){console.log("element-desktop closing"),_.b()})),j.on("ipcReply",this._onIpcReply),j.on("update-downloaded",this.onUpdateDownloaded),j.on("preferences",()=>{b.a.fire(R.a.ViewUserSettings)}),j.on("userDownloadCompleted",(e,{path:t,name:s})=>{k.a.sharedInstance().addOrReplaceToast({key:"DOWNLOAD_TOAST_"+t,title:Object(c.a)("Download Completed"),props:{description:s,acceptLabel:Object(c.a)("Open"),onAccept:()=>{j.send("userDownloadOpen",{path:t})},dismissLabel:Object(c.a)("Dismiss"),numSeconds:10},component:I.a,priority:99})}),N?(Object(w.c)(w.a.NAVIGATION,{keybinds:[{modifiers:[w.b.COMMAND],key:S.a.COMMA}],description:Object(c.b)("Open user settings")}),Object(w.c)(w.a.NAVIGATION,{keybinds:[{modifiers:[w.b.COMMAND],key:S.a.SQUARE_BRACKET_LEFT},{modifiers:[w.b.COMMAND],key:S.a.SQUARE_BRACKET_RIGHT}],description:Object(c.b)("Previous/next recently visited room or community")})):Object(w.c)(w.a.NAVIGATION,{keybinds:[{modifiers:[w.b.ALT],key:S.a.ARROW_LEFT},{modifiers:[w.b.ALT],key:S.a.ARROW_RIGHT}],description:Object(c.b)("Previous/next recently visited room or community")}),this._ipcCall("startSSOFlow",this.ssoID)}async getConfig(){return this._ipcCall("getConfig")}getHumanReadableName(){return"Electron Platform"}setNotificationCount(e){this.notificationCount!==e&&(super.setNotificationCount(e),j.send("setBadgeCount",e))}supportsNotifications(){return!0}maySendNotifications(){return!0}displayNotification(e,t,s,n){navigator.userAgent.includes("Linux")&&(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;"));const a={body:t,silent:!0};s&&(a.icon=s);const i=new window.Notification(e,a);return i.onclick=()=>{b.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),this._ipcCall("focusWindow")},i}loudNotification(e,t){j.send("loudNotification")}async getAppVersion(){return this._ipcCall("getAppVersion")}supportsAutoLaunch(){return!0}async getAutoLaunchEnabled(){return this._ipcCall("getAutoLaunchEnabled")}async setAutoLaunchEnabled(e){return this._ipcCall("setAutoLaunchEnabled",e)}supportsAutoHideMenuBar(){return!N}async getAutoHideMenuBarEnabled(){return this._ipcCall("getAutoHideMenuBarEnabled")}async setAutoHideMenuBarEnabled(e){return this._ipcCall("setAutoHideMenuBarEnabled",e)}supportsMinimizeToTray(){return!N}async getMinimizeToTrayEnabled(){return this._ipcCall("getMinimizeToTrayEnabled")}async setMinimizeToTrayEnabled(e){return this._ipcCall("setMinimizeToTrayEnabled",e)}async canSelfUpdate(){const e=await this._ipcCall("getUpdateFeedUrl");return Boolean(e)}startUpdateCheck(){super.startUpdateCheck(),j.send("check_updates")}installUpdate(){j.send("install_update")}getDefaultDeviceDisplayName(){const e=v.a.get().brand;return Object(c.a)("%(brand)s Desktop (%(platformName)s)",{brand:e,platformName:navigator.userAgent.includes("Macintosh")?"macOS":navigator.userAgent.includes("FreeBSD")?"FreeBSD":navigator.userAgent.includes("OpenBSD")?"OpenBSD":navigator.userAgent.includes("SunOS")?"SunOS":navigator.userAgent.includes("Windows")?"Windows":navigator.userAgent.includes("Linux")?"Linux":"Unknown"})}screenCaptureErrorString(){return null}requestNotificationPermission(){return Promise.resolve("granted")}reload(){window.location.reload(!1)}async _ipcCall(e,...t){const s=++this.nextIpcCallId;return new Promise((n,a)=>{this.pendingIpcCalls[s]={resolve:n,reject:a},window.electron.send("ipcCall",{id:s,name:e,args:t})})}getEventIndexingManager(){return this.eventIndexManager}setLanguage(e){this._ipcCall("setLanguage",e).catch(e=>{console.log("Failed to send setLanguage IPC to Electron"),console.error(e)})}getSSOCallbackUrl(e){const t=super.getSSOCallbackUrl(e);return t.protocol="element",t.searchParams.set("element-desktop-ssoid",this.ssoID),t}startSingleSignOn(e,t,s,n){super.startSingleSignOn(e,t,s,n),y.a.createTrackedDialog("Electron","SSO",E.a,{title:Object(c.a)("Go to your browser to complete Sign In"),description:l.a.createElement(C.a,null)})}_navigateForwardBack(e){this._ipcCall(e?"navigateBack":"navigateForward")}onKeyDown(e){let t=!1;switch(e.key){case S.a.SQUARE_BRACKET_LEFT:case S.a.SQUARE_BRACKET_RIGHT:!N||!e.metaKey||e.altKey||e.ctrlKey||e.shiftKey||(this._navigateForwardBack(e.key===S.a.SQUARE_BRACKET_LEFT),t=!0);break;case S.a.ARROW_LEFT:case S.a.ARROW_RIGHT:N||!e.altKey||e.metaKey||e.ctrlKey||e.shiftKey||(this._navigateForwardBack(e.key===S.a.ARROW_LEFT),t=!0)}return t}async getPickleKey(e,t){try{return await this._ipcCall("getPickleKey",e,t)}catch(e){return null}}async createPickleKey(e,t){try{return await this._ipcCall("createPickleKey",e,t)}catch(e){return null}}async destroyPickleKey(e,t){try{await this._ipcCall("destroyPickleKey",e,t)}catch(e){}}}var U=s(17),M=s.n(U),L=s(112),F=s.n(L),B=s(1486),V=s.n(B);function W(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class H extends f{constructor(){super(),h()(this,"runningVersion",null),h()(this,"pollForUpdate",()=>this._getVersion().then(e=>{if(null===this.runningVersion)this.runningVersion=e;else{if(this.runningVersion!==e)return this.shouldShowUpdate(e)&&Object(O.b)(this.runningVersion,e),{status:u.d.Ready};Object(O.a)()}return{status:u.d.NotAvailable}},e=>(console.error("Failed to poll for update",e),{status:u.d.Error,detail:e.message||e.status?e.status.toString():"Unknown Error"}))),"serviceWorker"in navigator&&navigator.serviceWorker.register("sw.js")}getHumanReadableName(){return"Web Platform"}supportsNotifications(){return Boolean(window.Notification)}maySendNotifications(){return"granted"===window.Notification.permission}requestNotificationPermission(){return new Promise((function(e,t){window.Notification.requestPermission(t=>{e(t)})}))}displayNotification(e,t,s,n){const a={body:t,tag:"tchap",silent:!0};s&&(a.icon=s);const i=new window.Notification(e,a);return i.onclick=function(){b.a.dispatch({action:"view_room",room_id:n.roomId}),window.focus(),i.close()},i}_getVersion(){return new Promise((function(e,t){M()({method:"GET",url:"version",qs:{cachebuster:Date.now()}},(s,n,a)=>{if(s||n.status<200||n.status>=300)return null===s&&(s={status:n.status}),void t(s);const i=a.trim();e(i)})}))}getAppVersion(){return null!==this.runningVersion?Promise.resolve(this.runningVersion):this._getVersion()}startUpdater(){this.pollForUpdate(),setInterval(this.pollForUpdate,6e5)}async canSelfUpdate(){return!0}startUpdateCheck(){super.startUpdateCheck(),this.pollForUpdate().then(e=>{b.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?W(Object(s),!0).forEach((function(t){h()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):W(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:R.a.CheckUpdates},e))})}installUpdate(){window.location.reload(!0)}getDefaultDeviceDisplayName(){const e=F.a.parse(window.location.href);e.protocol="",e.search="",e.hash="",e.pathname=e.pathname.replace(/\/$/,"");let t=e.format();t=t.replace(/^\/\//,"");const s=new V.a,n=s.getBrowser().name||"unknown browser";let a=s.getOS().name||"unknown OS";return"Mac OS"===a&&(a="macOS"),Object(c.a)("%(appName)s (%(browserName)s, %(osName)s)",{appName:t,browserName:n,osName:a})}screenCaptureErrorString(){return"https:"!==window.location.protocol?Object(c.a)("You need to be using HTTPS to place a screen-sharing call."):null}reload(){window.location.reload(!1)}}class G extends H{setNotificationCount(e){if(!navigator.setAppBadge)return super.setNotificationCount(e);this.notificationCount!==e&&(this.notificationCount=e,navigator.setAppBadge(e).catch(e=>{console.error("Failed to update PWA app badge",e)}))}}var q=s(107),K=s(253),z=s(665);window.mxSendRageshake=function(e,t){const s=v.a.get().bug_report_endpoint_url;s?(void 0===t&&(t=!0),e&&e.trim()?Object(z.a)(s,{userText:e,sendLogs:t,progressCallback:console.log.bind(console)}).then(()=>{console.log("Bug report sent!")},e=>{console.error(e)}):console.error("Cannot send a rageshake without a message - please tell us what went wrong")):console.error("Cannot send a rageshake - no bug_report_endpoint_url configured")};const $=function(){const e=_.d();return e.then(()=>{console.log("Initialised rageshake."),console.log("To fix line numbers in Chrome: Meatball menu → Settings → Blackboxing → Add /rageshake\\.js$"),window.addEventListener("beforeunload",e=>{console.log("element-web closing"),_.b()}),_.a()},e=>{console.error("Failed to initialise rageshake: "+e)}),e}();function Y(){window.electron?(console.log("Using Electron platform"),q.a.set(new A)):window.matchMedia("(display-mode: standalone)").matches?(console.log("Using PWA platform"),q.a.set(new G)):(console.log("Using Web platform"),q.a.set(new H))}async function J(){v.a.put(await q.a.get().getConfig()||{})}function Q(){return i.a.init({locateFile:()=>n.a}).then(()=>{console.log("Using WebAssembly Olm")}).catch(e=>(console.log("Failed to load Olm: trying legacy version",e),new Promise((e,t)=>{const s=document.createElement("script");s.src="olm_legacy.js",s.onload=e,s.onerror=t,document.body.appendChild(s)}).then(()=>window.Olm.init()).then(()=>{console.log("Using legacy Olm")}).catch(e=>{console.log("Both WebAssembly and asm.js Olm failed!",e)})))}async function X(){const e=d.a.getValue("language",null,!0);let t=[];e?t=[e]:c.f().forEach(e=>{t.push(...c.g(e))});try{await c.k(t),document.documentElement.setAttribute("lang",c.d())}catch(e){console.error("Unable to set language",e)}}async function Z(){console.log("Loading skin...");const[e,t]=await Promise.all([Promise.resolve().then(s.bind(null,85)),s.e(9).then(s.bind(null,1511))]);e.loadSkin(t),console.log("Skin loaded!")}async function ee(){Object(K.d)()}async function te(e){const t=await s.e(8).then(s.bind(null,1503));window.matrixChat=o.render(await t.loadApp(e),document.getElementById("matrixchat"))}async function se(e,t){const n=(await s.e(10).then(s.bind(null,1504))).default;window.matrixChat=o.render(r.createElement(n,{title:e,messages:t}),document.getElementById("matrixchat"))}async function ne(e){const t=(await s.e(7).then(s.bind(null,1505))).default;window.matrixChat=o.render(r.createElement(t,{onAccept:e}),document.getElementById("matrixchat"))}const ae=c.a},,,function(e,t,s){"use strict";s.d(t,"h",(function(){return p})),s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return f})),s.d(t,"k",(function(){return v})),s.d(t,"c",(function(){return _})),s.d(t,"f",(function(){return y})),s.d(t,"e",(function(){return E})),s.d(t,"g",(function(){return C})),s.d(t,"i",(function(){return w})),s.d(t,"d",(function(){return S})),s.d(t,"j",(function(){return x}));var n=s(261),a=s.n(n),i=s(777),o=s.n(i),r=s(81),l=s.n(r),c=s(88),d=s(107),m=s.p+"i18n/languages.4e5c7be.json",h=s(96),u=s(134);function p(e){const t=new Error(e);return t.translatedMessage=f(e),t}function g(e){return e}function f(e,t,s){const n=function(e,t,s){let n=e;if(void 0!==t){const e={};for(const s in t)e[`%\\(${s}\\)s`]=t[s];n=b(n,e)}if(void 0!==s){const e={};for(const t in s)e[`(<${t}>(.*?)<\\/${t}>|<${t}>|<${t}\\s*\\/>)`]=s[t];n=b(n,e)}return n}(function(e,t){let s;t&&"object"==typeof t&&(s=t.count,Object.keys(t).forEach(e=>{void 0===t[e]&&(console.warn("safeCounterpartTranslate called with undefined interpolation name: "+e),t[e]="undefined"),null===t[e]&&(console.warn("safeCounterpartTranslate called with null interpolation name: "+e),t[e]="null")}));let n=o.a.translate(e,t);return void 0===n&&void 0!==s&&(n=o.a.translate(e,Object.assign({},t,{locale:"en"}))),n}(e,Object.assign({interpolate:!1},t)),t,s);return n}function b(e,t){const s=[e];let n=!1;for(const a in t){const i=new RegExp(a,"g");let o=!1;for(let e=0;e<s.length;e++){const r=s[e];if("string"!=typeof r)continue;let l=i.exec(r);if(!l)continue;o=!0;const c=r.substr(0,l.index),d=[];let m;for(;l;){m=l;const e=l.slice(2);let s,o;if(s=t[a]instanceof Function?t[a].apply(null,e):t[a],"object"==typeof s&&(n=!0),"string"==typeof s&&""===s||d.push(s),l=i.exec(r),l){const e=m.index+m[0].length;o=r.substr(e,l.index-e)}else o=r.substr(m.index+m[0].length);o&&d.push(o)}s.splice(e,1,...d),""!==c&&s.splice(e,0,c)}o||"%\\(count\\)s"!==a&&console.log(`Could not find ${i} in ${e}`)}return n?l.a.createElement("span",null,...s):s.join("")}function v(e){Array.isArray(e)||(e=[e]);const t=d.a.get();let s,n;return t&&t.setLanguage(e),R().then(t=>{n=t;for(let t=0;t<e.length;++t)if(n.hasOwnProperty(e[t])){s=e[t];break}return s||(s="en",console.error("Unable to find an appropriate language")),O("i18n/"+n[s].fileName)}).then(e=>{if(o.a.registerTranslations(s,e),o.a.setLocale(s),c.a.setValue("language",null,h.a.DEVICE,s),console.log("set language to "+s),"en"!==s)return O("i18n/"+n.en.fileName)}).then(e=>{e&&o.a.registerTranslations("en",e)})}function _(){return R().then(e=>{const t=[];for(const s in e)e.hasOwnProperty(s)&&t.push({value:s,label:e[s].label});return t})}function y(){return navigator.languages&&navigator.languages.length?navigator.languages:navigator.language?[navigator.language]:[navigator.userLanguage||"en"]}function E(){return y()[0]}function C(e){const t=[],s=w(e),n=s.split("-");return 2===n.length&&n[0]===n[1]?t.push(n[0]):(t.push(s),2===n.length&&t.push(n[0])),t}function w(e){return e.toLowerCase().replace("_","-")}function S(){return o.a.getLocale()}function x(e){const t=S(),s=e.map(w);{const n=s.indexOf(t);if(n>-1)return e[n]}{const n=s.findIndex(e=>e.substr(0,2)===t.substr(0,2));if(n>-1)return e[n]}{const t=s.findIndex(e=>e.startsWith("en"));if(t>-1)return e[t]}return e[0]}function R(){return new Promise((e,t)=>{let s;s="string"==typeof m?m:"i18n/languages.json",a()({method:"GET",url:s},(s,n,a)=>{s||n.status<200||n.status>=300?t(s):e(JSON.parse(a))})})}async function O(e,t=3){return Object(u.c)(()=>function(e){return new Promise((t,s)=>{a()({method:"GET",url:e},(e,n,a)=>{e||n.status<200||n.status>=300?s(e):t(function(e){const t={};for(const s of Object.keys(e)){const n=s.split("|",2);if(2===n.length){let a=t[n[0]];void 0===a&&(a={},t[n[0]]=a),a[n[1]]=e[s]}else t[s]=e[s]}return t}(JSON.parse(a)))})})}(e),t,t=>(console.log("Failed to load i18n",e),console.error(t),!0))}o.a.setSeparator("|"),o.a.setFallbackLocale("en")},,function(e,t,s){"use strict";s.r(t),s.d(t,"loadSkin",(function(){return a})),s.d(t,"resetSkin",(function(){return i})),s.d(t,"getComponent",(function(){return o}));var n=s(788);function a(e){n.a.load(e)}function i(){n.a.reset()}function o(e){return n.a.getComponent(e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return N}));var n=s(82),a=s.n(n),i=s(262),o=s(1),r=s(165),l=s(363),c=s(85),d=s(658),m=s(88),h=s(87);function u(e,t,s){return{action:"MatrixActions.sync",state:t,prevState:s,matrixClient:e}}function p(e,t){return{action:"MatrixActions.accountData",event:t,event_type:t.getType(),event_content:t.getContent()}}function g(e,t,s){return{action:"MatrixActions.Room.accountData",event:t,event_type:t.getType(),event_content:t.getContent(),room:s}}function f(e,t){return{action:"MatrixActions.Room",room:t}}function b(e,t,s){return{action:"MatrixActions.Room.tags",room:s}}function v(e,t,s){return{action:"MatrixActions.Room.receipt",event:t,room:s,matrixClient:e}}function _(e,t,s,n,a,i){return{action:"MatrixActions.Room.timeline",event:t,isLiveEvent:i.liveEvent,isLiveUnfilteredRoomTimelineEvent:s&&i.timeline.getTimelineSet()===s.getUnfilteredTimelineSet()}}function y(e,t,s,n){return{action:"MatrixActions.Room.myMembership",room:t,membership:s,oldMembership:n}}function E(e,t){return{action:"MatrixActions.Event.decrypted",event:t}}var C={_matrixClientListenersStop:[],start(e){this._addMatrixClientListener(e,"sync",u),this._addMatrixClientListener(e,"accountData",p),this._addMatrixClientListener(e,"Room.accountData",g),this._addMatrixClientListener(e,"Room",f),this._addMatrixClientListener(e,"Room.tags",b),this._addMatrixClientListener(e,"Room.receipt",v),this._addMatrixClientListener(e,"Room.timeline",_),this._addMatrixClientListener(e,"Room.myMembership",y),this._addMatrixClientListener(e,"Event.decrypted",E)},_addMatrixClientListener(e,t,s){const n=(...t)=>{const n=s(e,...t);n&&h.a.dispatch(n,!0)};e.on(t,n),this._matrixClientListenersStop.push(()=>{e.removeListener(t,n)})},stop(){this._matrixClientListenersStop.forEach(e=>e())}},w=s(89),S=s(318),x=s(359),R=s(347),O=s(215),k=s(175),I=s(274),T=s(248);class j{constructor(){a()(this,"opts",{initialSyncLimit:20}),a()(this,"matrixClient",null),a()(this,"justRegisteredUserId",void 0),a()(this,"currentClientCreds",void 0)}setIndexedDbWorkerScript(e){d.a.indexedDbWorkerScript=e}get(){return this.matrixClient}unset(){this.matrixClient=null,C.stop()}setJustRegisteredUserId(e){this.justRegisteredUserId=e,e&&window.localStorage.setItem("mx_registration_time",String((new Date).getTime()))}currentUserIsJustRegistered(){return this.matrixClient&&this.matrixClient.credentials.userId===this.justRegisteredUserId}userRegisteredWithinLastHours(e){try{const t=new Date(window.localStorage.getItem("mx_registration_time"));return((new Date).getTime()-t.getTime())/36e5<=e}catch(e){return!1}}replaceUsingCreds(e){this.currentClientCreds=e,this.createClient(e)}async assign(){for(const e of["indexeddb","memory"])try{const e=this.matrixClient.store.startup();console.log("MatrixClientPeg: waiting for MatrixClient store to initialise"),await e;break}catch(t){if("indexeddb"!==e)throw console.error("Failed to start memory store!",t),t;console.error("Error starting matrixclient store - falling back to memory store",t),this.matrixClient.store=new i.a({localStorage:localStorage})}R.f(this.matrixClient);try{!m.a.getValue("lowBandwidth")&&this.matrixClient.initCrypto&&(await this.matrixClient.initCrypto(),this.matrixClient.setCryptoTrustCrossSignedDevices(!m.a.getValue("e2ee.manuallyVerifyAllSessions")),await Object(k.f)(this.matrixClient),R.e(!0))}catch(e){if(e&&"InvalidCryptoStoreError"===e.name){const e=c.getComponent("views.dialogs.CryptoStoreTooNewDialog");w.a.createDialog(e)}console.warn("Unable to initialise e2e",e)}const e=o.f(this.opts);return e.pendingEventOrdering="detached",e.lazyLoadMembers=!0,e.clientWellKnownPollPeriod=7200,C.start(this.matrixClient),x.a.matrixClient=this.matrixClient,e}async start(){const e=await this.assign();console.log("MatrixClientPeg: really starting MatrixClient"),await this.get().startClient(e),console.log("MatrixClientPeg: MatrixClient started")}getCredentials(){return{homeserverUrl:this.matrixClient.baseUrl,identityServerUrl:this.matrixClient.idBaseUrl,userId:this.matrixClient.credentials.userId,deviceId:this.matrixClient.getDeviceId(),accessToken:this.matrixClient.getAccessToken(),guest:this.matrixClient.isGuest()}}getHomeserverName(){const e=/^@.+:(.+)$/.exec(this.matrixClient.credentials.userId);if(null===e||e.length<1)throw new Error("Failed to derive homeserver name from user ID!");return e[1]}createClient(e){const t={baseUrl:e.homeserverUrl,idBaseUrl:e.identityServerUrl,accessToken:e.accessToken,userId:e.userId,deviceId:e.deviceId,pickleKey:e.pickleKey,timelineSupport:!0,forceTURN:!m.a.getValue("webRtcAllowPeerToPeer"),fallbackICEServerAllowed:!!m.a.getValue("fallbackICEServerAllowed"),verificationMethods:[S.d.SAS,I.d,S.d.RECIPROCATE_QR_CODE],unstableClientRelationAggregation:!0,identityServer:new O.a,cryptoCallbacks:{}},s={getDehydrationKey:T.a.getDehydrationKey};Object.assign(t.cryptoCallbacks,k.c,s),this.matrixClient=Object(d.a)(t),this.matrixClient.setMaxListeners(500),this.matrixClient.setGuest(Boolean(e.guest));const n=new l.a(null,{timelineSupport:!0});n.getLiveTimeline().setPaginationToken("",r.a.BACKWARDS),this.matrixClient.setNotifTimelineSet(n)}}window.mxMatrixClientPeg||(window.mxMatrixClientPeg=new j);const N=window.mxMatrixClientPeg},function(e,t,s){"use strict";(function(e){var n=s(792),a=s(367);class i extends n.Dispatcher{dispatch(e,t=!1){e instanceof a.a?e.fn(e=>{this.dispatch(e,t)}):t?super.dispatch(e):setTimeout(super.dispatch.bind(this,e),0)}fire(e,t=!1){this.dispatch({action:e},t)}}const o=new i,r=e;r.mxDispatcher||(r.mxDispatcher=o),t.a=o}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return te}));var n=s(82),a=s.n(n),i=s(224),o=s(86),r=s(96);class l extends i.a{constructor(e,t){super(),this.featureNames=e,this.watchers=t}getValue(e,t){if(this.featureNames.includes(e))return this.readFeature(e);if("notificationsEnabled"===e){const e=localStorage.getItem("notifications_enabled");return"string"==typeof e?"true"===e:null}if("notificationBodyEnabled"===e){const e=localStorage.getItem("notifications_body_enabled");return"string"==typeof e?"true"===e:null}if("audioNotificationsEnabled"===e){const e=localStorage.getItem("audio_notifications_enabled");return"string"==typeof e?"true"===e:null}if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e)){return JSON.parse(localStorage.getItem("mx_"+e)||"{}").value}return(this.getSettings()||{})[e]}setValue(e,t,s){if(this.featureNames.includes(e))return this.writeFeature(e,s),Promise.resolve();if("notificationsEnabled"===e)return localStorage.setItem("notifications_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("notificationBodyEnabled"===e)return localStorage.setItem("notifications_body_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if("audioNotificationsEnabled"===e)return localStorage.setItem("audio_notifications_enabled",s),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();if(["showRightPanelInRoom","showRightPanelInGroup","lastRightPanelPhaseForRoom","lastRightPanelPhaseForGroup"].includes(e))return localStorage.setItem("mx_"+e,JSON.stringify({value:s})),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve();const n=this.getSettings()||{};return n[e]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,null,r.a.DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}watchSetting(e,t,s){this.watchers.watchSetting(e,t,s)}unwatchSetting(e){this.watchers.unwatchSetting(e)}getSettings(){const e=localStorage.getItem("mx_local_settings");return e?JSON.parse(e):null}readFeature(e){if(o.a.get()&&o.a.get().isGuest())return!1;const t=localStorage.getItem("mx_labs_feature_"+e);return"true"===t||"false"!==t&&null}writeFeature(e,t){localStorage.setItem("mx_labs_feature_"+e,""+t),this.watchers.notifyUpdate(e,null,r.a.DEVICE,t)}}class c extends i.a{constructor(e){super(),this.watchers=e}getValue(e,t){if("blacklistUnverifiedDevices"===e){const e=this.read("mx_local_settings");if(e&&e.blacklistUnverifiedDevicesPerRoom)return e.blacklistUnverifiedDevicesPerRoom[t]}const s=this.read(this.getKey(e,t));return s?s.value:null}setValue(e,t,s){if("blacklistUnverifiedDevices"===e){let n=this.read("mx_local_settings");return n||(n={}),n.blacklistUnverifiedDevicesPerRoom||(n.blacklistUnverifiedDevicesPerRoom={}),n.blacklistUnverifiedDevicesPerRoom[t]=s,localStorage.setItem("mx_local_settings",JSON.stringify(n)),this.watchers.notifyUpdate(e,t,r.a.ROOM_DEVICE,s),Promise.resolve()}return null===s?localStorage.removeItem(this.getKey(e,t)):(s=JSON.stringify({value:s}),localStorage.setItem(this.getKey(e,t),s)),this.watchers.notifyUpdate(e,t,r.a.ROOM_DEVICE,s),Promise.resolve()}canSetValue(e,t){return!0}isSupported(){return void 0!==localStorage&&null!==localStorage}read(e){const t=localStorage.getItem(e);return t?JSON.parse(t):null}getKey(e,t){return"mx_setting_"+e+"_"+t}}class d extends i.a{constructor(e,t){super(),this.defaults=e,this.invertedDefaults=t}getValue(e,t){let s=this.defaults[e];return void 0===s&&(s=this.invertedDefaults[e]),s}async setValue(e,t,s){throw new Error("Cannot set values on the default level handler")}canSetValue(e,t){return!1}isSupported(){return!0}}var m=s(359),h=s(152);class u extends m.a{constructor(e){super(),this.watchers=e,a()(this,"onAccountData",(e,t,s)=>{const n=t.roomId;if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,r.a.ROOM_ACCOUNT,t)}else if("org.matrix.room.color_scheme"===e.getType())this.watchers.notifyUpdate("roomColor",n,r.a.ROOM_ACCOUNT,e.getContent());else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},a=Object(h.d)(t,e.getContent());for(const t of a){const s=e.getContent()[t];this.watchers.notifyUpdate(t,n,r.a.ROOM_ACCOUNT,s)}}else"im.vector.setting.allowed_widgets"===e.getType()&&this.watchers.notifyUpdate("allowedWidgets",n,r.a.ROOM_ACCOUNT,e.getContent())})}initMatrixClient(e,t){e&&e.removeListener("Room.accountData",this.onAccountData),t.on("Room.accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("roomColor"===e)return this.getSettings(t,"org.matrix.room.color_scheme");if("allowedWidgets"===e)return this.getSettings(t,"im.vector.setting.allowed_widgets");return(this.getSettings(t)||{})[e]}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,o.a.get().setRoomAccountData(t,"org.matrix.room.preview_urls",e)}if("roomColor"===e)return o.a.get().setRoomAccountData(t,"org.matrix.room.color_scheme",s);if("allowedWidgets"===e)return o.a.get().setRoomAccountData(t,"im.vector.setting.allowed_widgets",s);const n=this.getSettings(t)||{};return n[e]=s,o.a.get().setRoomAccountData(t,"im.vector.web.settings",n)}canSetValue(e,t){const s=o.a.get().getRoom(t);return null!=s}isSupported(){const e=o.a.get();return null!=e&&!e.isGuest()}getSettings(e,t="im.vector.web.settings"){const s=o.a.get().getRoom(e);if(!s)return null;const n=s.getAccountData(t);return n&&n.getContent()?Object(h.a)(n.getContent()):null}}const p=["im.vector.riot.breadcrumb_rooms","im.vector.setting.breadcrumbs"];class g extends m.a{constructor(e){super(),this.watchers=e,a()(this,"onAccountData",(e,t)=>{if("org.matrix.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",null,r.a.ACCOUNT,t)}else if("im.vector.web.settings"===e.getType()){const s=t?t.getContent():{},n=Object(h.d)(s,e.getContent());for(const t of n){const s=e.getContent()[t];this.watchers.notifyUpdate(t,null,r.a.ACCOUNT,s)}}else if(p.includes(e.getType()))this.notifyBreadcrumbsUpdate(e);else if("im.vector.setting.integration_provisioning"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("integrationProvisioning",null,r.a.ACCOUNT,t)}else if("io.element.recent_emoji"===e.getType()){const t=e.getContent().enabled;this.watchers.notifyUpdate("recent_emoji",null,r.a.ACCOUNT,t)}})}initMatrixClient(e,t){e&&e.removeListener("accountData",this.onAccountData),t.on("accountData",this.onAccountData)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms"),e&&(e.recent_rooms=e.rooms)),e&&e.recent_rooms?e.recent_rooms:[]}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji");return e?e.recent_emoji:null}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning");return e?e.enabled:null}const s=this.getSettings()||{};let n=s[e];return null==n&&("hideAvatarChanges"!==e&&"hideDisplaynameChanges"!==e||(n=s.hideAvatarDisplaynameChanges)),n}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings("org.matrix.preview_urls")||{};return e.disable=!s,o.a.get().setAccountData("org.matrix.preview_urls",e)}if("breadcrumb_rooms"===e){let e=this.getSettings("im.vector.setting.breadcrumbs");return e&&e.recent_rooms||(e=this.getSettings("im.vector.riot.breadcrumb_rooms")),e||(e={}),e.recent_rooms=s,o.a.get().setAccountData("im.vector.setting.breadcrumbs",e)}if("recent_emoji"===e){const e=this.getSettings("io.element.recent_emoji")||{};return e.recent_emoji=s,o.a.get().setAccountData("io.element.recent_emoji",e)}if("integrationProvisioning"===e){const e=this.getSettings("im.vector.setting.integration_provisioning")||{};return e.enabled=s,o.a.get().setAccountData("im.vector.setting.integration_provisioning",e)}const n=this.getSettings()||{};return n[e]=s,o.a.get().setAccountData("im.vector.web.settings",n)}canSetValue(e,t){return!0}isSupported(){const e=o.a.get();return null!=e&&!e.isGuest()}getSettings(e="im.vector.web.settings"){const t=o.a.get();if(!t)return null;const s=t.getAccountData(e);return s&&s.getContent()?Object(h.a)(s.getContent()):null}notifyBreadcrumbsUpdate(e){let t=[];if("im.vector.riot.breadcrumb_rooms"===e.getType()){const s=this.getSettings("im.vector.setting.breadcrumbs");t=s?s.recent_rooms:e.getContent().rooms}else{if("im.vector.setting.breadcrumbs"!==e.getType())return;t=e.getContent().recent_rooms}this.watchers.notifyUpdate("breadcrumb_rooms",null,r.a.ACCOUNT,t||[])}}class f extends m.a{constructor(e){super(),this.watchers=e,a()(this,"onEvent",(e,t,s)=>{const n=e.getRoomId(),a=this.client.getRoom(n);if(a&&(!a||t===a.currentState))if("org.matrix.room.preview_urls"===e.getType()){let t=e.getContent().disable;t="boolean"!=typeof t?null:!t,this.watchers.notifyUpdate("urlPreviewsEnabled",n,r.a.ROOM,t)}else if("im.vector.web.settings"===e.getType()){const t=s?s.getContent():{},a=Object(h.d)(t,e.getContent());for(const t of a)this.watchers.notifyUpdate(t,n,r.a.ROOM,e.getContent()[t])}})}initMatrixClient(e,t){e&&e.removeListener("RoomState.events",this.onEvent),t.on("RoomState.events",this.onEvent)}getValue(e,t){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return"boolean"!=typeof e.disable?null:!e.disable}return(this.getSettings(t)||{})[e]}setValue(e,t,s){if("urlPreviewsEnabled"===e){const e=this.getSettings(t,"org.matrix.room.preview_urls")||{};return e.disable=!s,o.a.get().sendStateEvent(t,"org.matrix.room.preview_urls",e)}const n=this.getSettings(t)||{};return n[e]=s,o.a.get().sendStateEvent(t,"im.vector.web.settings",n,"")}canSetValue(e,t){const s=o.a.get(),n=s.getRoom(t);let a="im.vector.web.settings";return"urlPreviewsEnabled"===e&&(a="org.matrix.room.preview_urls"),!!n&&n.currentState.maySendStateEvent(a,s.getUserId())}isSupported(){const e=o.a.get();return null!=e}getSettings(e,t="im.vector.web.settings"){const s=o.a.get().getRoom(e);if(!s)return null;const n=s.currentState.getStateEvents(t,"");return n&&n.getContent()?Object(h.a)(n.getContent()):null}}var b=s(92),v=s(1);class _ extends i.a{constructor(e){super(),this.featureNames=e}getValue(e,t){const s=b.a.get()||{};if(this.featureNames.includes(e)){const t=(s.features||{})[e];return Object(v.r)(t)?null:!0===t||!1===t?t:"enable"===t||"disable"!==t&&null}if("theme"===e)return s.default_theme;const n=s.settingDefaults;return!n||Object(v.r)(n[e])?null:n[e]}async setValue(e,t,s){throw new Error("Cannot change settings at the config level")}canSetValue(e,t){return!1}isSupported(){return!0}}var y=s(83),E=s(87),C=s(209),w=s(659),S=s(159);class x extends S.a{onChange(e,t,s){E.a.dispatch({action:"feature_custom_status_changed"})}}var R=s(458);class O extends S.a{constructor(e,t){super(),this.setter=e,this.inverse=t}onChange(e,t,s){this.setter.call(o.a.get(),this.inverse?!s:s)}}var k=s(107);class I extends S.a{onChange(e,t,s){k.a.get().reload()}}var T=s(94);class j extends S.a{constructor(){super()}onChange(e,t,s){E.a.dispatch({action:T.a.UpdateFontSize,size:s})}}class N extends S.a{constructor(){super()}onChange(e,t,s){E.a.dispatch({action:T.a.UpdateSystemFont,useSystemFont:te.getValue("useSystemFont"),font:s})}}class P extends S.a{constructor(){super()}onChange(e,t,s){E.a.dispatch({action:T.a.UpdateSystemFont,useSystemFont:s,font:te.getValue("systemFont")})}}var D=s(123),A=s(99);class U extends S.a{constructor(e,t=!1){super(),this.uiFeatureName=e,this.forcedValue=t}getValueOverride(e,t,s,n){return this.settingDisabled?this.forcedValue:null}get settingDisabled(){return!te.getValue(this.uiFeatureName)}}var M=s(108);class L extends S.a{constructor(e){super(),this.controllers=e}getValueOverride(e,t,s,n){for(const a of this.controllers){const i=a.getValueOverride(e,t,s,n);if(null!=i)return i}return null}onChange(e,t,s){for(const n of this.controllers)n.onChange(e,t,s)}get settingDisabled(){for(const e of this.controllers)if(e.settingDisabled)return!0;return!1}}const F=[r.a.DEVICE,r.a.ROOM_DEVICE,r.a.ROOM_ACCOUNT,r.a.ACCOUNT,r.a.CONFIG],B=[r.a.ROOM_ACCOUNT,r.a.ACCOUNT],V=[r.a.DEVICE,r.a.ROOM_DEVICE,r.a.ROOM_ACCOUNT,r.a.ACCOUNT,r.a.CONFIG,r.a.ROOM],W=[r.a.DEVICE,r.a.ACCOUNT,r.a.CONFIG],H=[r.a.DEVICE,r.a.CONFIG],G=[r.a.DEVICE],q=[r.a.DEVICE,r.a.CONFIG],K=[r.a.CONFIG],z={feature_latex_maths:{isFeature:!0,displayName:Object(y.b)("Render LaTeX maths in messages"),supportedLevels:H,default:!1},feature_communities_v2_prototypes:{isFeature:!0,displayName:Object(y.b)("Communities v2 prototypes. Requires compatible homeserver. Highly experimental - use with caution."),supportedLevels:H,default:!1},feature_new_spinner:{isFeature:!0,displayName:Object(y.b)("New spinner design"),supportedLevels:H,default:!1},feature_pinning:{isFeature:!0,displayName:Object(y.b)("Message Pinning"),supportedLevels:H,default:!1},feature_custom_status:{isFeature:!0,displayName:Object(y.b)("Custom user status messages"),supportedLevels:H,default:!1,controller:new x},feature_custom_tags:{isFeature:!0,displayName:Object(y.b)("Group & filter rooms by custom tags (refresh to apply changes)"),supportedLevels:H,default:!1},feature_state_counters:{isFeature:!0,displayName:Object(y.b)("Render simple counters in room header"),supportedLevels:H,default:!1},feature_many_integration_managers:{isFeature:!0,displayName:Object(y.b)("Multiple integration managers"),supportedLevels:H,default:!1},feature_mjolnir:{isFeature:!0,displayName:Object(y.b)("Try out new ways to ignore people (experimental)"),supportedLevels:H,default:!1},feature_custom_themes:{isFeature:!0,displayName:Object(y.b)("Support adding custom themes"),supportedLevels:H,default:!1},feature_roomlist_preview_reactions_dms:{isFeature:!0,displayName:Object(y.b)("Show message previews for reactions in DMs"),supportedLevels:H,default:!1},feature_roomlist_preview_reactions_all:{isFeature:!0,displayName:Object(y.b)("Show message previews for reactions in all rooms"),supportedLevels:H,default:!1},feature_dehydration:{isFeature:!0,displayName:Object(y.b)("Offline encrypted messaging using dehydrated devices"),supportedLevels:H,default:!1},advancedRoomListLogging:{displayName:Object(y.b)("Enable advanced debugging for the room list"),supportedLevels:G,default:!1},mjolnirRooms:{supportedLevels:[r.a.ACCOUNT],default:[]},mjolnirPersonalRoom:{supportedLevels:[r.a.ACCOUNT],default:null},feature_bridge_state:{isFeature:!0,supportedLevels:H,displayName:Object(y.b)("Show info about bridges in room settings"),default:!1},"RoomList.backgroundImage":{supportedLevels:W,default:null},baseFontSize:{displayName:Object(y.b)("Font size"),supportedLevels:W,default:10,controller:new j},useCustomFontSize:{displayName:Object(y.b)("Use custom size"),supportedLevels:W,default:!1},"MessageComposerInput.suggestEmoji":{supportedLevels:W,displayName:Object(y.b)("Enable Emoji suggestions while typing"),default:!0,invertedSettingName:"MessageComposerInput.dontSuggestEmoji"},"MessageComposerInput.showStickersButton":{supportedLevels:W,displayName:Object(y.b)("Show stickers button"),default:!1},"Notifications.alwaysShowBadgeCounts":{supportedLevels:B,default:!1},useCompactLayout:{supportedLevels:G,displayName:Object(y.b)("Use a more compact ‘Modern’ layout"),default:!1},showRedactions:{supportedLevels:V,displayName:Object(y.b)("Show a placeholder for removed messages"),default:!0,invertedSettingName:"hideRedactions"},showJoinLeaves:{supportedLevels:V,displayName:Object(y.b)("Show join/leave messages (invites/kicks/bans unaffected)"),default:!1,invertedSettingName:"hideJoinLeaves"},showAvatarChanges:{supportedLevels:V,displayName:Object(y.b)("Show avatar changes"),default:!1,invertedSettingName:"hideAvatarChanges"},showDisplaynameChanges:{supportedLevels:V,displayName:Object(y.b)("Show display name changes"),default:!1,invertedSettingName:"hideDisplaynameChanges"},showReadReceipts:{supportedLevels:F,displayName:Object(y.b)("Show read receipts sent by other users"),default:!0,invertedSettingName:"hideReadReceipts"},showTwelveHourTimestamps:{supportedLevels:W,displayName:Object(y.b)("Show timestamps in 12 hour format (e.g. 2:30pm)"),default:!1},alwaysShowTimestamps:{supportedLevels:W,displayName:Object(y.b)("Always show message timestamps"),default:!0},autoplayGifsAndVideos:{supportedLevels:W,displayName:Object(y.b)("Autoplay GIFs and videos"),default:!1},enableSyntaxHighlightLanguageDetection:{supportedLevels:W,displayName:Object(y.b)("Enable automatic language detection for syntax highlighting"),default:!0},expandCodeByDefault:{supportedLevels:W,displayName:Object(y.b)("Expand code blocks by default"),default:!1},showCodeLineNumbers:{supportedLevels:W,displayName:Object(y.b)("Show line numbers in code blocks"),default:!0},"Pill.shouldShowPillAvatar":{supportedLevels:W,displayName:Object(y.b)("Show avatars in user and room mentions"),default:!0,invertedSettingName:"Pill.shouldHidePillAvatar"},"TextualBody.enableBigEmoji":{supportedLevels:W,displayName:Object(y.b)("Enable big emoji in chat"),default:!0,invertedSettingName:"TextualBody.disableBigEmoji"},"MessageComposerInput.isRichTextEnabled":{supportedLevels:W,default:!1},"MessageComposer.showFormatting":{supportedLevels:W,default:!1},sendTypingNotifications:{supportedLevels:W,displayName:Object(y.b)("Send typing notifications"),default:!0,invertedSettingName:"dontSendTypingNotifications"},showTypingNotifications:{supportedLevels:W,displayName:Object(y.b)("Show typing notifications"),default:!0},ctrlFForSearch:{supportedLevels:W,displayName:A.b?Object(y.b)("Use Command + F to search"):Object(y.b)("Use Ctrl + F to search"),default:!1},"MessageComposerInput.ctrlEnterToSend":{supportedLevels:W,displayName:A.b?Object(y.b)("Use Command + Enter to send a message"):Object(y.b)("Use Ctrl + Enter to send a message"),default:!1},"MessageComposerInput.autoReplaceEmoji":{supportedLevels:W,displayName:Object(y.b)("Automatically replace plain text Emoji"),default:!1},"VideoView.flipVideoHorizontally":{supportedLevels:W,displayName:Object(y.b)("Mirror local video feed"),default:!1},"TagPanel.enableTagPanel":{supportedLevels:W,displayName:Object(y.b)("Enable Community Filter Panel"),default:!1,invertedSettingName:"TagPanel.disableTagPanel",controller:new U(M.a.Communities,!0)},theme:{supportedLevels:W,default:"tchap",controller:new R.a},custom_themes:{supportedLevels:W,default:[]},use_system_theme:{supportedLevels:G,default:!1,displayName:Object(y.b)("Match system theme")},useSystemFont:{supportedLevels:G,default:!1,displayName:Object(y.b)("Use a system font"),controller:new P},systemFont:{supportedLevels:G,default:"",displayName:Object(y.b)("System font name"),controller:new N},webRtcAllowPeerToPeer:{supportedLevels:q,displayName:Object(y.b)("Allow Peer-to-Peer for 1:1 calls"),default:!0,invertedSettingName:"webRtcForceTURN"},webrtc_audiooutput:{supportedLevels:G,default:null},webrtc_audioinput:{supportedLevels:G,default:null},webrtc_videoinput:{supportedLevels:G,default:null},language:{supportedLevels:q,default:"fr"},breadcrumb_rooms:{supportedLevels:[r.a.ACCOUNT],default:[]},recent_emoji:{supportedLevels:[r.a.ACCOUNT],default:[]},room_directory_servers:{supportedLevels:[r.a.ACCOUNT],default:[]},integrationProvisioning:{supportedLevels:[r.a.ACCOUNT],default:!1},allowedWidgets:{supportedLevels:[r.a.ROOM_ACCOUNT,r.a.ROOM_DEVICE],supportedLevelsAreOrdered:!0,default:{}},analyticsOptIn:{supportedLevels:q,displayName:Object(y.b)("Send analytics data"),default:!1},showCookieBar:{supportedLevels:q,default:!1},autocompleteDelay:{supportedLevels:q,default:200},readMarkerInViewThresholdMs:{supportedLevels:q,default:3e3},readMarkerOutOfViewThresholdMs:{supportedLevels:q,default:3e4},blacklistUnverifiedDevices:{supportedLevels:[r.a.ROOM_DEVICE,r.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:{default:Object(y.b)("Never send encrypted messages to unverified sessions from this session"),"room-device":Object(y.b)("Never send encrypted messages to unverified sessions in this room from this session")},default:!1,controller:new U(M.a.AdvancedEncryption)},urlPreviewsEnabled:{supportedLevels:V,displayName:{default:Object(y.b)("Enable inline URL previews by default"),"room-account":Object(y.b)("Enable URL previews for this room (only affects you)"),room:Object(y.b)("Enable URL previews by default for participants in this room")},default:!1,controller:new U(M.a.URLPreviews)},urlPreviewsEnabled_e2ee:{supportedLevels:[r.a.ROOM_DEVICE,r.a.ROOM_ACCOUNT],displayName:{"room-account":Object(y.b)("Enable URL previews for this room (only affects you)")},default:!1,controller:new U(M.a.URLPreviews)},roomColor:{supportedLevels:V,displayName:Object(y.b)("Room Colour"),default:{primary_color:null,secondary_color:null}},notificationsEnabled:{supportedLevels:G,default:!0,controller:new w.b},notificationSound:{supportedLevels:B,default:!0},notificationBodyEnabled:{supportedLevels:G,default:!0,controller:new w.a},audioNotificationsEnabled:{supportedLevels:G,default:!0},enableWidgetScreenshots:{supportedLevels:W,displayName:Object(y.b)("Enable widget screenshots on supported widgets"),default:!1},"PinnedEvents.isOpen":{supportedLevels:[r.a.ROOM_DEVICE],default:!1},promptBeforeInviteUnknownUsers:{supportedLevels:W,displayName:Object(y.b)("Prompt before sending invites to potentially invalid matrix IDs"),default:!1},showDeveloperTools:{supportedLevels:W,displayName:Object(y.b)("Show developer tools"),default:!1},widgetOpenIDPermissions:{supportedLevels:G,default:{allow:[],deny:[]}},"RoomList.orderAlphabetically":{supportedLevels:W,displayName:Object(y.b)("Order rooms by name"),default:!1},"RoomList.orderByImportance":{supportedLevels:W,displayName:Object(y.b)("Show rooms with unread notifications first"),default:!0},breadcrumbs:{supportedLevels:W,displayName:Object(y.b)("Show shortcuts to recently viewed rooms above the room list"),default:!1},showHiddenEventsInTimeline:{displayName:Object(y.b)("Show hidden events in timeline"),supportedLevels:G,default:!1},lowBandwidth:{supportedLevels:q,displayName:Object(y.b)("Low bandwidth mode"),default:!1,controller:new I},fallbackICEServerAllowed:{supportedLevels:G,displayName:Object(y.b)("Allow fallback call assist server turn.matrix.org when your homeserver does not offer one (your IP address would be shared during a call)"),default:null},showImages:{supportedLevels:W,displayName:Object(y.b)("Show previews/thumbnails for images"),default:!0},showRightPanelInRoom:{supportedLevels:G,default:!0},showRightPanelInGroup:{supportedLevels:G,default:!1},lastRightPanelPhaseForRoom:{supportedLevels:G,default:D.b.RoomSummary},lastRightPanelPhaseForGroup:{supportedLevels:G,default:D.b.GroupMemberList},enableEventIndexing:{supportedLevels:G,displayName:Object(y.b)("Enable message search in encrypted rooms"),default:!0},crawlerSleepTime:{supportedLevels:G,displayName:Object(y.b)("How fast should messages be downloaded."),default:3e3},showCallButtonsInComposer:{supportedLevels:q,default:!0,controller:new U(M.a.Voip)},"e2ee.manuallyVerifyAllSessions":{supportedLevels:G,displayName:Object(y.b)("Manually verify all remote sessions"),default:!1,controller:new L([new U(M.a.AdvancedEncryption),new O(C.b.prototype.setCryptoTrustCrossSignedDevices,!0)])},ircDisplayNameWidth:{supportedLevels:[r.a.ROOM_DEVICE,r.a.DEVICE],supportedLevelsAreOrdered:!0,displayName:Object(y.b)("IRC display name width"),default:80},useIRCLayout:{supportedLevels:W,displayName:Object(y.b)("Enable experimental, compact IRC style layout"),default:!1},showChatEffects:{supportedLevels:W,displayName:Object(y.b)("Show chat effects"),default:!0},"Widgets.pinned":{supportedLevels:B,default:{}},"Widgets.layout":{supportedLevels:B,default:{}},"Widgets.leftPanel":{supportedLevels:W,default:null},[M.a.RoomHistorySettings]:{supportedLevels:K,default:!0},[M.a.AdvancedEncryption]:{supportedLevels:K,default:!0},[M.a.URLPreviews]:{supportedLevels:K,default:!1},[M.a.Widgets]:{supportedLevels:K,default:!1},[M.a.Voip]:{supportedLevels:K,default:!1},[M.a.Feedback]:{supportedLevels:K,default:!0},[M.a.Registration]:{supportedLevels:K,default:!0},[M.a.PasswordReset]:{supportedLevels:K,default:!0},[M.a.Deactivate]:{supportedLevels:K,default:!0},[M.a.ShareQRCode]:{supportedLevels:K,default:!0},[M.a.ShareSocial]:{supportedLevels:K,default:!0},[M.a.IdentityServer]:{supportedLevels:K,default:!1,controller:new U(M.a.ThirdPartyID)},[M.a.ThirdPartyID]:{supportedLevels:K,default:!0},[M.a.Flair]:{supportedLevels:K,default:!1,controller:new U(M.a.Communities)},[M.a.Communities]:{supportedLevels:K,default:!1},[M.a.AdvancedSettings]:{supportedLevels:K,default:!0}};class $ extends i.a{constructor(e){super(),this.handler=e,a()(this,"cache",{})}getValue(e,t){const s=t||"UNDEFINED",n=this.cache[e];return n&&n.hasOwnProperty(s)?n[s]:this.handler.getValue(e,t)}setValue(e,t,s){this.cache[e]||(this.cache[e]={});const n=this.cache[e],a=t||"UNDEFINED";n[a]=s;const i=this.handler.setValue(e,t,s);return Promise.resolve(i).finally(()=>{delete n[a]})}canSetValue(e,t){return this.handler.canSetValue(e,t)}isSupported(){return this.handler.isSupported()}}const Y=new class{constructor(){a()(this,"watchers",{})}watchSetting(e,t,s){this.watchers[e]||(this.watchers[e]={}),this.watchers[e][t]||(this.watchers[e][t]=[]),this.watchers[e][t].push(s)}unwatchSetting(e){for(const t of Object.keys(this.watchers))for(const s of Object.keys(this.watchers[t])){let n;for(;-1!==(n=this.watchers[t][s].indexOf(e));)this.watchers[t][s].splice(n,1)}}notifyUpdate(e,t,s,n){if(!this.watchers[e])return;const a=this.watchers[e],i=[];null!==t&&a[t]&&i.push(...a[t]),t?a.null&&i.push(...a.null):i.push(...Object.values(a).flat(1));for(const e of i)e(t,s,n)}},J={},Q={},X=[];for(const e of Object.keys(z))J[e]=z[e].default,z[e].isFeature&&X.push(e),z[e].invertedSettingName&&(Q[z[e].invertedSettingName]=!z[e].default);const Z={[r.a.DEVICE]:new l(X,Y),[r.a.ROOM_DEVICE]:new c(Y),[r.a.ROOM_ACCOUNT]:new u(Y),[r.a.ACCOUNT]:new g(Y),[r.a.ROOM]:new f(Y),[r.a.CONFIG]:new _(X),[r.a.DEFAULT]:new d(J,Q)};for(const e of Object.keys(Z))Z[e]=new $(Z[e]);const ee=[r.a.DEVICE,r.a.ROOM_DEVICE,r.a.ROOM_ACCOUNT,r.a.ACCOUNT,r.a.ROOM,r.a.CONFIG,r.a.DEFAULT];class te{static getFeatureSettingNames(){return Object.keys(z).filter(e=>te.isFeature(e))}static watchSetting(e,t,s){const n=z[e],a=e;if(!n)throw new Error(e+" is not a setting");n.invertedSettingName&&(e=n.invertedSettingName);const i=`${(new Date).getTime()}_${te.watcherCount++}_${e}_${t}`,o=(e,t,n)=>{const i=te.getValue(a);s(a,e,t,n,i)};return te.watchers[i]=o,Y.watchSetting(e,t,o),i}static unwatchSetting(e){te.watchers[e]?(Y.unwatchSetting(te.watchers[e]),delete te.watchers[e]):console.warn("Ending non-existent watcher ID "+e)}static monitorSetting(e,t){t=t||null,this.monitors[e]||(this.monitors[e]={});const s=()=>{this.monitors[e][t]=te.watchSetting(e,t,(e,t,s,n,a)=>{E.a.dispatch({action:"setting_updated",settingName:e,roomId:t,level:s,newValueAtLevel:n,newValue:a})})};if(Object.keys(this.monitors[e]).find(e=>e===t||null===e)){if(null===t){for(const t of Object.keys(this.monitors[e]))te.unwatchSetting(this.monitors[e][t]);this.monitors[e]={},s()}}else s()}static getDisplayName(e,t=r.a.DEFAULT){if(!z[e]||!z[e].displayName)return null;let s=z[e].displayName;return s instanceof Object&&(s=s[t]?s[t]:s.default),Object(y.a)(s)}static isFeature(e){return!!z[e]&&z[e].isFeature}static isEnabled(e){return!!z[e]&&(!z[e].controller||!z[e].controller.settingDisabled)}static getValue(e,t=null,s=!1){if(!z[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");const n=z[e],a=n.supportedLevelsAreOrdered?n.supportedLevels:ee;return te.getValueAt(a[0],e,t,!1,s)}static getValueAt(e,t,s=null,n=!1,a=!1){const i=z[t];if(!i)throw new Error("Setting '"+t+"' does not appear to be a setting.");const o=i.supportedLevelsAreOrdered?i.supportedLevels:ee;o.includes(r.a.DEFAULT)||o.push(r.a.DEFAULT);const l=o.indexOf(e);if(-1===l)throw new Error("Level "+e+" is not prioritized");const c=te.getHandlers(t);if(i.invertedSettingName&&(t=i.invertedSettingName),n){const n=c[e];if(!n)return te.getFinalValue(i,e,s,null,null);const a=n.getValue(t,s);return te.getFinalValue(i,e,s,a,e)}for(let n=l;n<o.length;n++){const r=c[o[n]];if(!r)continue;if(a&&"default"===o[n])continue;const l=r.getValue(t,s);if(null!=l)return te.getFinalValue(i,e,s,l,o[n])}return te.getFinalValue(i,e,s,null,null)}static getDefaultValue(e){if(!z[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");return z[e].default}static getFinalValue(e,t,s,n,a){let i=n;if(e.controller){const o=e.controller.getValueOverride(t,s,n,a);null!=o&&(i=o)}return e.invertedSettingName&&(i=!i),i}static async setValue(e,t,s,n){const a=z[e];if(!a)throw new Error("Setting '"+e+"' does not appear to be a setting.");const i=te.getHandler(e,s);if(!i)throw new Error("Setting "+e+" does not have a handler for "+s);if(a.invertedSettingName&&(e=a.invertedSettingName,n=!n),!i.canSetValue(e,t))throw new Error("User cannot set "+e+" at "+s+" in "+t);await i.setValue(e,t,n);const o=a.controller;o&&o.onChange(s,t,n)}static canSetValue(e,t,s){if(!z[e])throw new Error("Setting '"+e+"' does not appear to be a setting.");if(te.isFeature(e)){const s=te.getValueAt(r.a.CONFIG,e,t,!0,!0);if(!0===s||!1===s)return!1}const n=te.getHandler(e,s);return!!n&&n.canSetValue(e,t)}static isLevelSupported(e){return!!Z[e]&&Z[e].isSupported()}static firstSupportedLevel(e){const t=z[e];if(!t)throw new Error("Setting '"+e+"' does not appear to be a setting.");const s=t.supportedLevelsAreOrdered?t.supportedLevels:ee;s.includes(r.a.DEFAULT)||s.push(r.a.DEFAULT);const n=te.getHandlers(e);for(const e of s){if(n[e])return e}return null}static debugSetting(e,t){console.log("--- DEBUG "+e);const s=z[e];console.log("--- definition: "+(s?JSON.stringify(s):"<NOT_FOUND>")),console.log("--- default level order: "+JSON.stringify(ee)),console.log("--- registered handlers: "+JSON.stringify(Object.keys(Z)));const n=e=>{for(const s of Object.keys(Z)){const n=Z[s];try{const a=n.getValue(e,t);console.log(`---     ${s}@${t||"<no_room>"} = ${JSON.stringify(a)}`)}catch(e){console.log(`---     ${n}@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=n.getValue(e,null);console.log(`---     ${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){console.log(`---     ${n}@<no_room> THREW ERROR: ${e.message}`),console.error(e)}}console.log("--- calculating as returned by SettingsStore"),console.log("--- these might not match if the setting uses a controller - be warned!");try{const s=te.getValue(e,t);console.log(`---     SettingsStore#generic@${t||"<no_room>"}  = ${JSON.stringify(s)}`)}catch(e){console.log(`---     SettingsStore#generic@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=te.getValue(e,null);console.log("---     SettingsStore#generic@<no_room>  = "+JSON.stringify(t))}catch(e){console.log("---     SettingsStore#generic@$<no_room> THREW ERROR: "+e.message),console.error(e)}for(const s of ee){try{const n=te.getValueAt(s,e,t);console.log(`---     SettingsStore#${s}@${t||"<no_room>"} = ${JSON.stringify(n)}`)}catch(e){console.log(`---     SettingsStore#${s}@${t||"<no_room>"} THREW ERROR: ${e.message}`),console.error(e)}if(t)try{const t=te.getValueAt(s,e,null);console.log(`---     SettingsStore#${s}@<no_room> = ${JSON.stringify(t)}`)}catch(e){console.log(`---     SettingsStore#${s}@$<no_room> THREW ERROR: ${e.message}`),console.error(e)}}};n(e),s.invertedSettingName&&(console.log("--- TESTING INVERTED SETTING NAME"),console.log("--- inverted: "+s.invertedSettingName),n(s.invertedSettingName)),console.log("--- END DEBUG")}static getHandler(e,t){const s=te.getHandlers(e);return s[t]?s[t]:null}static getHandlers(e){if(!z[e])return{};const t={};for(const s of z[e].supportedLevels){if(!Z[s])throw new Error("Unexpected level "+s);te.isLevelSupported(s)&&(t[s]=Z[s])}return t.default||(t.default=Z.default),t}}a()(te,"watchers",{}),a()(te,"monitors",{}),a()(te,"watcherCount",1),window.mxSettingsStore=te},function(e,t,s){"use strict";var n=s(93),a=s.n(n),i=s(82),o=s.n(i),r=s(81),l=s.n(r),c=s(139),d=s.n(c),m=s(90),h=s.n(m),u=s(116),p=s(87),g=s(134),f=s(85),b=s(84),v=s.n(b),_=s(83);class y extends l.a.Component{constructor(...e){super(...e),o()(this,"state",{component:null,error:null}),o()(this,"_onWrapperCancelClick",()=>{this.props.onFinished(!1)})}componentDidMount(){this._unmounted=!1,console.log("Starting load of AsyncWrapper for modal"),this.props.prom.then(e=>{if(this._unmounted)return;const t=e.default?e.default:e;this.setState({component:t})}).catch(e=>{console.warn("AsyncWrapper promise failed",e),this.setState({error:e})})}componentWillUnmount(){this._unmounted=!0}render(){if(this.state.component){const e=this.state.component;return l.a.createElement(e,this.props)}if(this.state.error){const e=f.getComponent("views.dialogs.BaseDialog"),t=f.getComponent("views.elements.DialogButtons");return l.a.createElement(e,{onFinished:this.props.onFinished,title:Object(_.a)("Error")},Object(_.a)("Unable to load! Check your network connectivity and try again."),l.a.createElement(t,{primaryButton:Object(_.a)("Dismiss"),onPrimaryButtonClick:this._onWrapperCancelClick,hasCancel:!1}))}{const e=f.getComponent("elements.Spinner");return l.a.createElement(e,null)}}}o()(y,"propTypes",{prom:v.a.object.isRequired});class E{constructor(){o()(this,"counter",0),o()(this,"priorityModal",null),o()(this,"staticModal",null),o()(this,"modals",[]),o()(this,"onBackgroundClick",()=>{const e=this.getCurrentModal();e&&(e.closeReason="backgroundClick",e.close(),e.closeReason=null)})}static getOrCreateContainer(){let e=document.getElementById("mx_Dialog_Container");return e||(e=document.createElement("div"),e.id="mx_Dialog_Container",document.body.appendChild(e)),e}static getOrCreateStaticContainer(){let e=document.getElementById("mx_Dialog_StaticContainer");return e||(e=document.createElement("div"),e.id="mx_Dialog_StaticContainer",document.body.appendChild(e)),e}hasDialogs(){return this.priorityModal||this.staticModal||this.modals.length>0}createTrackedDialog(e,t,...s){return u.a.trackEvent("Modal",e,t),this.createDialog(...s)}appendTrackedDialog(e,t,...s){return u.a.trackEvent("Modal",e,t),this.appendDialog(...s)}createDialog(e,...t){return this.createDialogAsync(Promise.resolve(e),...t)}appendDialog(e,...t){return this.appendDialogAsync(Promise.resolve(e),...t)}createTrackedDialogAsync(e,t,...s){return u.a.trackEvent("Modal",e,t),this.createDialogAsync(...s)}appendTrackedDialogAsync(e,t,...s){return u.a.trackEvent("Modal",e,t),this.appendDialogAsync(...s)}closeCurrentModal(e){const t=this.getCurrentModal();t&&(t.closeReason=e,t.close())}buildModal(e,t,s,n){const i={onFinished:t?t.onFinished:null,onBeforeClose:n.onBeforeClose,beforeClosePromise:null,closeReason:null,className:s,elem:null,close:null},[o,r]=this.getCloseFn(i,t),c=this.counter++;return i.elem=l.a.createElement(y,a()({key:c,prom:e},t,{onFinished:o})),i.close=o,{modal:i,closeDialog:o,onFinishedProm:r}}getCloseFn(e,t){const s=Object(g.b)();return[async(...n)=>{if(e.beforeClosePromise)await e.beforeClosePromise;else if(e.onBeforeClose){e.beforeClosePromise=e.onBeforeClose(e.closeReason);const t=await e.beforeClosePromise;if(e.beforeClosePromise=null,!t)return}s.resolve(n),t&&t.onFinished&&t.onFinished.apply(null,n);const a=this.modals.indexOf(e);a>=0&&this.modals.splice(a,1),this.priorityModal===e&&(this.priorityModal=null,this.modals=[]),this.staticModal===e&&(this.staticModal=null,this.modals=[]),this.reRender()},s.promise]}createDialogAsync(e,t,s,n=!1,a=!1,i={}){const{modal:o,closeDialog:r,onFinishedProm:l}=this.buildModal(e,t,s,i);return n?this.priorityModal=o:a?this.staticModal=o:this.modals.unshift(o),this.reRender(),{close:r,finished:l}}appendDialogAsync(e,t,s){const{modal:n,closeDialog:a,onFinishedProm:i}=this.buildModal(e,t,s,{});return this.modals.push(n),this.reRender(),{close:a,finished:i}}getCurrentModal(){return this.priorityModal?this.priorityModal:this.modals[0]||this.staticModal}reRender(){if(0===this.modals.length&&!this.priorityModal&&!this.staticModal)return p.a.dispatch({action:"aria_unhide_main_app"}),d.a.unmountComponentAtNode(E.getOrCreateContainer()),void d.a.unmountComponentAtNode(E.getOrCreateStaticContainer());if(p.a.dispatch({action:"aria_hide_main_app"}),this.staticModal){const e=h()("mx_Dialog_wrapper mx_Dialog_staticWrapper",this.staticModal.className),t=l.a.createElement("div",{className:e},l.a.createElement("div",{className:"mx_Dialog"},this.staticModal.elem),l.a.createElement("div",{className:"mx_Dialog_background mx_Dialog_staticBackground",onClick:this.onBackgroundClick}));d.a.render(t,E.getOrCreateStaticContainer())}else d.a.unmountComponentAtNode(E.getOrCreateStaticContainer());const e=this.getCurrentModal();if(e!==this.staticModal){const t=h()("mx_Dialog_wrapper",e.className,{mx_Dialog_wrapperWithStaticUnder:this.staticModal}),s=l.a.createElement("div",{className:t},l.a.createElement("div",{className:"mx_Dialog"},e.elem),l.a.createElement("div",{className:"mx_Dialog_background",onClick:this.onBackgroundClick}));d.a.render(s,E.getOrCreateContainer())}else d.a.unmountComponentAtNode(E.getOrCreateContainer())}}window.singletonModalManager||(window.singletonModalManager=new E);t.a=window.singletonModalManager},,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(101),a=s.n(n),i=s(81),o=s.n(i),r=s(99),l=s(90),c=s.n(l);function d(e){let{element:t,onClick:s,children:n,kind:i,disabled:l,inputRef:d,className:m}=e,h=a()(e,["element","onClick","children","kind","disabled","inputRef","className"]);const u=h;return l||(u.onClick=s,u.onKeyDown=e=>{if(e.key===r.a.ENTER)return e.stopPropagation(),e.preventDefault(),s(e);e.key===r.a.SPACE&&(e.stopPropagation(),e.preventDefault())},u.onKeyUp=e=>{if(e.key===r.a.SPACE)return e.stopPropagation(),e.preventDefault(),s(e);e.key===r.a.ENTER&&(e.stopPropagation(),e.preventDefault())}),u.ref=d,u.className=c()("mx_AccessibleButton",m,{mx_AccessibleButton_hasKind:i,["mx_AccessibleButton_kind_"+i]:i,mx_AccessibleButton_disabled:l}),o.a.createElement(t,h,n)}d.defaultProps={element:"div",role:"button",tabIndex:0},d.displayName="AccessibleButton"},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(82),a=s.n(n);const i={brand:"Element",integrations_ui_url:"https://scalar.vector.im/",integrations_rest_url:"https://scalar.vector.im/api",bug_report_endpoint_url:null,jitsi:{preferredDomain:"jitsi.riot.im"},desktopBuilds:{available:!0,logo:s(791),url:"https://element.io/get-started"}};class o{static setInstance(e){o.instance=e,window.mxReactSdkConfig=e}static get(){return o.instance||{}}static put(e){const t=Object.keys(i);for(let s=0;s<t.length;++s)void 0===e[t[s]]&&(e[t[s]]=i[t[s]]);o.setInstance(e)}static unset(){o.setInstance({})}static add(e){const t=o.get(),s=Object.assign({},t,e);o.put(s)}}a()(o,"instance",void 0)},,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.ViewUser="view_user",e.ViewUserSettings="view_user_settings",e.ViewRoomDirectory="view_room_directory",e.RecheckTheme="recheck_theme",e.CheckUpdates="check_updates",e.FocusComposer="focus_composer",e.ToggleUserMenu="toggle_user_menu",e.UpdateFontSize="update_font_size",e.UpdateSystemFont="update_system_font",e.ViewRoomDelta="view_room_delta",e.SetRightPanelPhase="set_right_panel_phase",e.ToggleRightPanel="toggle_right_panel",e.AfterRightPanelPhaseChange="after_right_panel_phase_change",e.OpenDialPad="open_dial_pad",e.PstnSupportUpdated="pstn_support_updated"}(n||(n={}))},,function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.DEVICE="device",e.ROOM_DEVICE="room-device",e.ROOM_ACCOUNT="room-account",e.ACCOUNT="account",e.ROOM="room",e.CONFIG="config",e.DEFAULT="default"}(n||(n={}))},function(e,t,s){"use strict";var n=s(81);const a=Object(n.createContext)(void 0);a.displayName="MatrixClientContext",t.a=a},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(86),a=s(92),i=s(109),o=s(83),r=s(368),l=s(369);class c{static getShortDomain(){const e=n.a.get().getDomain().split(".tchap.gouv.fr")[0].split(".").reverse().filter(Boolean)[0];return Object(l.a)(e)||"Tchap"}static getDomainFromId(e){const t=e.split(":").reverse()[0].split(".tchap.gouv.fr")[0].split(".").filter(Boolean).reverse()[0];return Object(l.a)(t)||"Tchap"}static getLongDomainFromId(e){return e.split(":").filter(Boolean).reverse()[0]}static getHSInfoFromEmail(e){const t=Object(l.d)(a.a.get().hs_url_list),s=r.a.hostBase,n=r.a.infoFromEmailUrl;return fetch(s+t[0]+n+e).then(e=>e.json())}static discoverPlatform(e){const t=r.a.hostBase,s=r.a.infoFromEmailUrl;return new Promise((n,i)=>{const o=Object(l.d)(a.a.get().hs_url_list);if(o){const a=o.map(n=>this._httpRequest(t+n+s+e,{}));Promise.all(a).then(e=>{let s=null,a=null;for(let t=0;t<=e.length;t++)e[t]&&e[t].hs&&""!==e[t].hs&&null!==e[t].hs?s=e[t].hs:a=!e[t]||""!==e[t].hs&&null!==e[t].hs?"ERR_UNREACHABLE_HOMESERVER":"ERR_UNAUTHORIZED_EMAIL";null!==s?n(t+s):i(a)})}})}static getRandomHSUrlFromList(){return r.a.hostBase+Object(l.d)(a.a.get().hs_url_list)[0]}static isUserExpired(e){const t=r.a.expiredInfoUrl,s=n.a.get().getHomeserverUrl(),a=n.a.get().getAccessToken();return fetch(`${s}${t}${e}/info`,{method:"GET",headers:{Authorization:"Bearer "+a}}).then(e=>e.json()).then(e=>e).then(e=>!!(e.errcode&&"ORG_MATRIX_EXPIRED_ACCOUNT"===e.errcode||e.expired&&!0===e.expired))}static isCurrentUserExtern(){const e=n.a.get().getHomeserverUrl();return e.includes(".e.")||e.includes(".externe.")}static isUserExternFromServer(e){return e.includes(".e.")||e.includes(".externe.")}static isUserExternFromServerHostname(e){return e.includes("e.")||e.includes("externe.")}static isUserExtern(e){if(e){const t=e.split(":");if(t&&t[1])return t[1].startsWith("e.")||t[1].startsWith("agent.externe.")}return!1}static looksLikeMxId(e){return!(!e.startsWith("@")||!e.includes(":"))}static computeLongRoomNameFromRoom(e){return`${e.name} [${this.computeDomainFromRoomId(e.roomId)}]`}static computeDomainFromRoomId(e){let t=e;return t=t.split(":")[1],t=t.startsWith("agent")?t.split(".")[1]:t.split(".")[0],Object(l.a)(t)}static computeDisplayNameFromUserId(e){let t="",s=new RegExp("\\d*$"),n=e.split(":")[0];if(n=n.replace("@",""),n=n.replace(s.exec(n),""),t=n,this.isUserExtern(e))-1!==n.lastIndexOf("-")&&(t=n.substring(0,n.lastIndexOf("-"))+"@"+n.substring(n.lastIndexOf("-")+1));else{let e=n.substring(0,n.lastIndexOf("-"));e=e.replace("."," "),t=e.split(" ").map(e=>Object(l.a)(e)).join(" ")}return t}static lookupThreePid(e,t){const s=n.a.get().getHomeserverUrl(),a=n.a.get().getIdentityServerUrl().split("https://")[1],i=n.a.get().getAccessToken(),o=`${s}${r.a.lookupUrl}?medium=${e}&address=${t}&id_server=${a}`;return fetch(o,{method:"GET",headers:{Authorization:"Bearer "+i}}).then(e=>e.json()).catch(e=>{console.log(e)})}static requestNewExpiredAccountEmail(){const e=n.a.get().getHomeserverUrl(),t=n.a.get().getAccessToken(),s=`${e}${r.a.accountValidityResendEmailUrl}`;fetch(s,{method:"POST",headers:{Authorization:"Bearer "+t}})}static isUserLastAdmin(e){const t=n.a.get().getUserId(),s=e.getJoinedMembers();let a=0,i=!1;return s.forEach(e=>{e.powerLevelNorm>=100&&(e.userId===t&&(i=!0),a++)}),i&&a<=1}static isRoomForum(e){return!n.a.get().isRoomEncrypted(e)&&"public"===this.getJoinRules(e)}static getAccessRules(e){const t=n.a.get().getRoom(e),s=t.currentState.getStateEvents("im.vector.room.access_rules","");if(!s){const e=Object(l.c)(t,"im.vector.room.access_rules","rule");return e||"restricted"}const a=s.getContent();return"rule"in a?a.rule:"restricted"}static getJoinRules(e){const t=n.a.get().getRoom(e).currentState.getStateEvents("m.room.join_rules","");if(!t)return"public";const s=t.getContent();return"join_rule"in s?s.join_rule:"public"}static getExistingRoom(e,t){const s=i.a.shared().getDMRoomsForUserId(t);let a={state:null,roomId:null,weight:0};for(const e of s){const s=n.a.get().getRoom(e);if(s){const n=s.getMyMembership(),i=s.currentState.members[t].membership;"invite"===n&&"join"===i&&a.weight<2?a={state:"invite",roomId:e,weight:2}:"join"===n&&"leave"===i&&a.weight<1&&(a={state:"leave",roomId:e,weight:1})}}return null!==a.roomId?a:void 0}static isRoomNotice(e){return Object.keys(e.tags).includes("m.server_notice")}static transformServerErrors(e,t=!1){let s=e;return e?e.includes("** Unable to decrypt: ")&&(s=t?Object(o.a)("Decryption fail"):Object(o.a)("Decryption fail: Please open Tchap on an other connected device to allow key sharing.")):s=Object(o.a)("Decryption fail"),s}static imgUrlToUri(e){if(e&&e.includes("/thumbnail/")){return"//"+e.split("/thumbnail/")[1]}if(e&&e.includes("/download/")){return"//"+e.split("/download/")[1]}return null}static _httpRequest(e,t){const s=t||{},n=(null==s?void 0:s.timeout)||3e4;return new Promise((t,a)=>{const i=setTimeout(()=>{t(new Error("timeout"))},n);fetch(e,s).then(e=>{clearTimeout(i),t(e.json())},e=>{clearTimeout(i),t({err:e})})})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return a})),s.d(t,"d",(function(){return i})),s.d(t,"c",(function(){return o}));const n={HOME:"Home",END:"End",PAGE_UP:"PageUp",PAGE_DOWN:"PageDown",BACKSPACE:"Backspace",DELETE:"Delete",ARROW_UP:"ArrowUp",ARROW_DOWN:"ArrowDown",ARROW_LEFT:"ArrowLeft",ARROW_RIGHT:"ArrowRight",TAB:"Tab",ESCAPE:"Escape",ENTER:"Enter",ALT:"Alt",CONTROL:"Control",META:"Meta",SHIFT:"Shift",CONTEXT_MENU:"ContextMenu",COMMA:",",PERIOD:".",LESS_THAN:"<",GREATER_THAN:">",BACKTICK:"`",SPACE:" ",SLASH:"/",SQUARE_BRACKET_LEFT:"[",SQUARE_BRACKET_RIGHT:"]",A:"a",B:"b",C:"c",D:"d",E:"e",F:"f",G:"g",H:"h",I:"i",J:"j",K:"k",L:"l",M:"m",N:"n",O:"o",P:"p",Q:"q",R:"r",S:"s",T:"t",U:"u",V:"v",W:"w",X:"x",Y:"y",Z:"z"},a=navigator.platform.toUpperCase().indexOf("MAC")>=0;function i(e){return a?e.metaKey&&!e.altKey&&!e.ctrlKey&&!e.shiftKey:e.ctrlKey&&!e.altKey&&!e.metaKey&&!e.shiftKey}function o(e){return a?e.metaKey&&!e.altKey&&!e.ctrlKey:e.ctrlKey&&!e.altKey&&!e.metaKey}},,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return R})),s.d(t,"b",(function(){return O})),s.d(t,"p",(function(){return k})),s.d(t,"k",(function(){return I})),s.d(t,"l",(function(){return T})),s.d(t,"m",(function(){return j})),s.d(t,"q",(function(){return N})),s.d(t,"o",(function(){return P})),s.d(t,"n",(function(){return D}));var n=s(93),a=s.n(n),i=s(82),o=s.n(i),r=s(81),l=s.n(r),c=s(139),d=s.n(c),m=s(90),h=s.n(m),u=s(99),p=s(495);s.d(t,"c",(function(){return p.a}));var g=s(496);s.d(t,"d",(function(){return g.a}));var f=s(497);s.d(t,"e",(function(){return f.a}));var b=s(498);s.d(t,"f",(function(){return b.a}));var v=s(499);s.d(t,"g",(function(){return v.a}));var _=s(500);s.d(t,"h",(function(){return _.a}));var y=s(501);s.d(t,"i",(function(){return y.a}));var E=s(502);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function w(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}s.d(t,"j",(function(){return E.a}));function S(){let e=document.getElementById("mx_ContextualMenu_Container");return e||(e=document.createElement("div"),e.id="mx_ContextualMenu_Container",document.body.appendChild(e)),e}const x=new Set(["menuitem","menuitemcheckbox","menuitemradio"]);let R;!function(e){e.Top="top",e.Bottom="bottom",e.Left="left",e.Right="right",e.None="none"}(R||(R={}));class O extends l.a.PureComponent{constructor(t,s){super(t,s),o()(this,"initialFocus",void 0),o()(this,"collectContextMenuRect",e=>{if(!e)return;let t=e.querySelector('[role^="menuitem"]');t||(t=e.querySelector("[tab-index]")),t&&t.focus(),this.setState({contextMenuElem:e})}),o()(this,"onContextMenu",t=>{if(this.props.onFinished){this.props.onFinished(),t.preventDefault(),t.stopPropagation();const s=t.clientX,n=t.clientY;e(()=>{const e=document.createEvent("MouseEvents");e.initMouseEvent("contextmenu",!0,!0,window,0,0,0,s,n,!1,!1,!1,!1,0,null),document.elementFromPoint(s,n).dispatchEvent(e)})}}),o()(this,"onContextMenuPreventBubbling",e=>{e.stopPropagation()}),o()(this,"onFinished",e=>{e.stopPropagation(),e.preventDefault(),this.props.onFinished&&this.props.onFinished()}),o()(this,"onMoveFocus",(e,t)=>{let s=!1;do{const n=t?e.lastElementChild:e.firstElementChild,a=t?e.previousElementSibling:e.nextElementSibling;s?n?e=n:a?e=a:(s=!1,e=e.parentElement):a?(e=a,s=!0):e=e.parentElement,e&&e.classList.contains("mx_ContextualMenu")&&(e=t?e.lastElementChild:e.firstElementChild,s=!0)}while(e&&!x.has(e.getAttribute("role")));e&&e.focus()}),o()(this,"onMoveFocusHomeEnd",(e,t)=>{let s=e.querySelectorAll('[role^="menuitem"]');s||(s=e.querySelectorAll("[tab-index]")),s&&s.length&&(t?s[0].focus():s[s.length-1].focus())}),o()(this,"onKeyDown",e=>{if(!this.props.managed)return void(e.key===u.a.ESCAPE&&(this.props.onFinished(),e.stopPropagation(),e.preventDefault()));let t=!0;switch(e.key){case u.a.TAB:case u.a.ESCAPE:case u.a.ARROW_LEFT:case u.a.ARROW_RIGHT:this.props.onFinished();break;case u.a.ARROW_UP:this.onMoveFocus(e.target,!0);break;case u.a.ARROW_DOWN:this.onMoveFocus(e.target,!1);break;case u.a.HOME:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!0);break;case u.a.END:this.onMoveFocusHomeEnd(this.state.contextMenuElem,!1);break;default:t=!1}t&&(e.stopPropagation(),e.preventDefault())}),this.state={contextMenuElem:null},this.initialFocus=document.activeElement}componentWillUnmount(){this.initialFocus.focus()}renderMenu(e=this.props.hasBackground){const t={},s=this.props;let n;s.top?t.top=s.top:t.bottom=s.bottom,s.left?(t.left=s.left,n=R.Left):(t.right=s.right,n=R.Right);const a=this.state.contextMenuElem?this.state.contextMenuElem.getBoundingClientRect():null,i={};s.chevronFace&&(n=s.chevronFace);const o=n&&n!==R.None;if(n===R.Top||n===R.Bottom)i.left=s.chevronOffset;else if(void 0!==t.top){const e=t.top;let n=e;if(a){const e=10;n=Math.min(t.top,document.body.clientHeight-a.height+e)}t.top=n,i.top=Math.max(s.chevronOffset,s.chevronOffset+e-n)}let r;o&&(r=l.a.createElement("div",{style:i,className:"mx_ContextualMenu_chevron_"+n}));const c=h()({mx_ContextualMenu:!0,mx_ContextualMenu_left:!o&&t.left,mx_ContextualMenu_right:!o&&t.right,mx_ContextualMenu_top:!o&&t.top,mx_ContextualMenu_bottom:!o&&t.bottom,mx_ContextualMenu_withChevron_left:n===R.Left,mx_ContextualMenu_withChevron_right:n===R.Right,mx_ContextualMenu_withChevron_top:n===R.Top,mx_ContextualMenu_withChevron_bottom:n===R.Bottom}),d={};s.menuWidth&&(d.width=s.menuWidth),s.menuHeight&&(d.height=s.menuHeight),isNaN(Number(s.menuPaddingTop))||(d.paddingTop=s.menuPaddingTop),isNaN(Number(s.menuPaddingLeft))||(d.paddingLeft=s.menuPaddingLeft),isNaN(Number(s.menuPaddingBottom))||(d.paddingBottom=s.menuPaddingBottom),isNaN(Number(s.menuPaddingRight))||(d.paddingRight=s.menuPaddingRight);const m={};let u;return isNaN(Number(s.zIndex))||(d.zIndex=s.zIndex+1,m.zIndex=s.zIndex),e&&(u=l.a.createElement("div",{className:"mx_ContextualMenu_background",style:m,onClick:this.onFinished,onContextMenu:this.onContextMenu})),l.a.createElement("div",{className:"mx_ContextualMenu_wrapper",style:w(w({},t),m),onKeyDown:this.onKeyDown,onContextMenu:this.onContextMenuPreventBubbling},l.a.createElement("div",{className:c,style:d,ref:this.collectContextMenuRect,role:this.props.managed?"menu":void 0},r,s.children),u)}render(){return d.a.createPortal(this.renderMenu(),S())}}o()(O,"defaultProps",{hasBackground:!0,managed:!0});const k=(e,t=12)=>{const s=e.right+window.pageXOffset+3;let n=e.top+e.height/2+window.pageYOffset;return n-=t+8,{left:s,top:n,chevronOffset:t}},I=(e,t=R.None,s=0)=>{const n={chevronFace:t},a=e.right+window.pageXOffset,i=e.bottom+window.pageYOffset,o=e.top+window.pageYOffset;return n.right=window.innerWidth-a,i<window.innerHeight/2?n.top=i+s:n.bottom=window.innerHeight-o+s,n},T=(e,t=R.None,s=0)=>{const n={chevronFace:t},a=e.right+window.pageXOffset,i=e.bottom+window.pageYOffset,o=e.top+window.pageYOffset;return n.right=window.innerWidth-a,i<window.innerHeight/2?n.top=i+s:n.bottom=window.innerHeight-o+s,n},j=(e,t=R.None,s=0)=>{const n={chevronFace:t},a=e.left+window.pageXOffset,i=e.top+window.pageYOffset;return n.left=a,n.bottom=window.innerHeight-i+s,n},N=()=>{const e=Object(r.useRef)(null),[t,s]=Object(r.useState)(!1);return[t,e,()=>{s(!0)},()=>{s(!1)},s]};class P extends O{render(){return this.renderMenu(!1)}}function D(e,t){const s=function(...e){d.a.unmountComponentAtNode(S()),t&&t.onFinished&&t.onFinished.apply(null,e)},n=l.a.createElement(P,a()({},t,{onFinished:s,windowResize:s}),l.a.createElement(e,a()({},t,{onFinished:s})));return d.a.render(n,S()),{close:s}}}).call(this,s(167).setImmediate)},,function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(101),a=s.n(n),i=s(82),o=s.n(i),r=s(81),l=s.n(r),c=s(90),d=s.n(c),m=s(85),h=s(106);function u(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?u(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):u(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let g=1;class f extends l.a.PureComponent{constructor(e){super(e),o()(this,"id",void 0),o()(this,"input",void 0),o()(this,"validateOnChange",Object(h.debounce)(()=>{this.validate({focused:!0})},200)),o()(this,"onFocus",e=>{this.setState({focused:!0}),this.props.validateOnFocus&&this.validate({focused:!0}),this.props.onFocus&&this.props.onFocus(e)}),o()(this,"onChange",e=>{this.props.validateOnChange&&this.validateOnChange(),this.props.onChange&&this.props.onChange(e)}),o()(this,"onBlur",e=>{this.setState({focused:!1}),this.props.validateOnBlur&&this.validate({focused:!1}),this.props.onBlur&&this.props.onBlur(e)}),this.state={valid:void 0,feedback:void 0,feedbackVisible:!1,focused:!1},this.id=this.props.id||"mx_Field_"+g++}focus(){this.input.focus()}async validate({focused:e,allowEmpty:t=!0}){if(!this.props.onValidate)return;const s=this.input?this.input.value:null,{valid:n,feedback:a}=await this.props.onValidate({value:s,focused:e,allowEmpty:t});return this.state.focused&&a?this.setState({valid:n,feedback:a,feedbackVisible:!0}):this.setState({valid:n,feedbackVisible:!1}),n}render(){const e=this.props,{element:t,prefixComponent:s,postfixComponent:n,className:i,onValidate:o,children:r,tooltipContent:c,forceValidity:h,tooltipClassName:u,list:g,validateOnBlur:f,validateOnChange:b,validateOnFocus:v}=e,_=a()(e,["element","prefixComponent","postfixComponent","className","onValidate","children","tooltipContent","forceValidity","tooltipClassName","list","validateOnBlur","validateOnChange","validateOnFocus"]);_.placeholder=_.placeholder||_.label,_.id=this.id,_.onFocus=this.onFocus,_.onChange=this.onChange,_.onBlur=this.onBlur;const y=p(p({},_),{},{ref:e=>this.input=e,list:g}),E=l.a.createElement(this.props.element,y,r);let C=null;s&&(C=l.a.createElement("span",{className:"mx_Field_prefix"},s));let w=null;n&&(w=l.a.createElement("span",{className:"mx_Field_postfix"},n));const S=null!=h,x=d()("mx_Field","mx_Field_"+this.props.element,i,{mx_Field_labelAlwaysTopLeft:s,mx_Field_valid:S?h:o&&!0===this.state.valid,mx_Field_invalid:S?!h:o&&!1===this.state.valid}),R=m.getComponent("elements.Tooltip");let O;return(c||this.state.feedback)&&(O=l.a.createElement(R,{tooltipClassName:d()("mx_Field_tooltip",u),visible:this.state.focused&&this.props.forceTooltipVisible||this.state.feedbackVisible,label:c||this.state.feedback,forceOnRight:!0})),l.a.createElement("div",{className:x},C,E,l.a.createElement("label",{htmlFor:this.id},this.props.label),w,O)}}o()(f,"defaultProps",{element:"input",type:"text",validateOnFocus:!0,validateOnBlur:!0,validateOnChange:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return C}));var n=s(101),a=s.n(n),i=s(82),o=s.n(i),r=s(179),l=s(83),c=s(107),d=s(92),m=s(86),h=s(134),u=s(128),p=s(302);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function f(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){o()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}let b=window.TextEncoder;b||(b=p.TextEncoder);var v;!function(e){e.Landscape="landscape",e.Portrait="portrait"}(v||(v={}));const _=async e=>{const t=(new b).encode(e),s=await window.crypto.subtle.digest("sha-256",t);return[...new Uint8Array(s)].map(e=>e.toString(16).padStart(2,"0")).join("")},y=new Set(["register","login","forgot_password","soft_logout","new","settings","welcome","home","start","directory","start_sso","start_cas","groups","complete_security","post_registration","room","user","group"]);const E=e=>{var t,s;const n=m.a.get(),a=null==n?void 0:n.getRoom(e);return{num_users:null==a?void 0:a.getJoinedMemberCount(),is_encrypted:null==n?void 0:n.isRoomEncrypted(e),is_public:"public"===(null==a||null===(t=a.currentState.getStateEvents("m.room.join_rules",""))||void 0===t||null===(s=t.getContent())||void 0===s?void 0:s.join_rule)}};class C{constructor(){o()(this,"baseUrl",null),o()(this,"appKey",null),o()(this,"userKey",null),o()(this,"anonymous",void 0),o()(this,"appPlatform",void 0),o()(this,"appVersion","unknown"),o()(this,"initTime",C.getTimestamp()),o()(this,"firstPage",!0),o()(this,"heartbeatIntervalId",void 0),o()(this,"activityIntervalId",void 0),o()(this,"trackTime",!0),o()(this,"lastBeat",void 0),o()(this,"storedDuration",0),o()(this,"lastView",void 0),o()(this,"lastViewTime",0),o()(this,"lastViewStoredDuration",0),o()(this,"sessionStarted",!1),o()(this,"heartbeatEnabled",!1),o()(this,"inactivityCounter",0),o()(this,"pendingEvents",[]),o()(this,"lastMsTs",0),o()(this,"getOrientation",()=>window.innerWidth>window.innerHeight?v.Landscape:v.Portrait),o()(this,"reportOrientation",()=>{this.track("[CLY]_orientation",{mode:this.getOrientation()})}),o()(this,"endSession",()=>{this.sessionStarted&&(window.removeEventListener("resize",this.reportOrientation),this.reportViewDuration(),this.request({end_session:1,session_duration:C.getTimestamp()-this.lastBeat})),this.sessionStarted=!1}),o()(this,"onVisibilityChange",()=>{document.hidden?this.stopTime():this.startTime()}),o()(this,"onUserActivity",()=>{this.inactivityCounter>=20&&this.startTime(),this.inactivityCounter=0})}static get instance(){return C.internalInstance}get disabled(){return!this.baseUrl}canEnable(){var e,t;const s=d.a.get();return Boolean("1"!==navigator.doNotTrack&&(null==s||null===(e=s.countly)||void 0===e?void 0:e.url)&&(null==s||null===(t=s.countly)||void 0===t?void 0:t.appKey))}async changeUserKey(e,t=!1){const s=this.userKey;this.userKey=e,s&&t&&await this.request({old_device_id:s})}async enable(e=!0){if(!this.disabled&&this.anonymous===e)return;if(!this.canEnable())return;this.disabled||this.request();const t=d.a.get();this.baseUrl=new URL("/i",t.countly.url),this.appKey=t.countly.appKey,this.anonymous=e,e?await this.changeUserKey(Object(r.a)(64)):await this.changeUserKey(await _(m.a.get().getUserId()),!0);const s=c.a.get();this.appPlatform=s.getHumanReadableName();try{this.appVersion=await s.getAppVersion()}catch(e){console.warn("Failed to get app version, using 'unknown'")}this.heartbeatIntervalId=setInterval(this.heartbeat.bind(this),5e3),this.trackSessions(),this.trackErrors()}async disable(){this.disabled||(await this.track("Opt-Out"),this.endSession(),window.clearInterval(this.heartbeatIntervalId),window.clearTimeout(this.activityIntervalId),this.baseUrl=null,window.removeEventListener("beforeunload",this.endSession),window.removeEventListener("unload",this.endSession),window.removeEventListener("visibilitychange",this.onVisibilityChange),window.removeEventListener("mousemove",this.onUserActivity),window.removeEventListener("click",this.onUserActivity),window.removeEventListener("keydown",this.onUserActivity),window.removeEventListener("scroll",this.onUserActivity))}reportFeedback(e,t){this.track("[CLY]_star_rating",{rating:e,comment:t},null,{},!0)}trackPageChange(e){this.disabled||this.trackPageView()}async trackPageView(){this.reportViewDuration(),await Object(h.d)(0);const e=await async function(e=!0){const t=Object(r.a)(8),{origin:s,hash:n}=window.location;let{pathname:a}=window.location;s.startsWith("file://")&&(a=`/<redacted_${t}>/`);let[i,o,...l]=n.split("/");y.has(o)||(o=`<redacted_${t}>`);for(let s=0;s<l.length;s++)l[s]=e?`<redacted_${t}>`:await _(l[s]);const c=s+a+`${i}/${o}/${l.join("/")}`,d={};let m="$/"+n;switch(o){case"room":{m="view_room";const e=u.a.getRoomId();m+=" "+l[0],d.room_id=l[0],Object.assign(d,E(e));break}}return{name:m,url:c,meta:d}}(this.anonymous),t=e.name;this.lastView=t,this.lastViewTime=C.getTimestamp();const s=f(f({},e.meta),{},{name:t,visit:1,domain:window.location.hostname,view:e.url,segment:this.appPlatform,start:this.firstPage});this.firstPage&&(this.firstPage=!1),this.track("[CLY]_view",s)}static getTimestamp(){return Math.floor((new Date).getTime()/1e3)}getMsTimestamp(){const e=(new Date).getTime();return this.lastMsTs>=e?this.lastMsTs++:this.lastMsTs=e,this.lastMsTs}async recordError(e,t=!1){if(this.disabled||this.anonymous)return;let s="";"object"==typeof e?void 0!==e.stack?s=e.stack:(void 0!==e.name&&(s+=e.name+":"),void 0!==e.message&&(s+=e.message+"\n"),void 0!==e.fileName&&(s+="in "+e.fileName+"\n"),void 0!==e.lineNumber&&(s+="on "+e.lineNumber),void 0!==e.columnNumber&&(s+=":"+e.columnNumber)):s=e+"",s=await(async(e,t,s)=>{const n=[];e.replace(t,(...e)=>(n.push(s(...e)),""));const a=await Promise.all(n);return e.replace(t,()=>a.shift())})(s,/([!@+#]).+?:[\w:.]+/g,async(e,t)=>t+await _(e.substring(1)));const n=this.getMetrics(),a={_resolution:null==n?void 0:n._resolution,_error:s,_app_version:this.appVersion,_run:C.getTimestamp()-this.initTime,_nonfatal:!t,_view:this.lastView};void 0!==navigator.onLine&&(a._online=navigator.onLine),a._background=document.hasFocus(),this.request({crash:JSON.stringify(a)})}trackErrors(){window.onerror=(e,t,s,n,a)=>{if(void 0!==a)this.recordError(a,!1);else{let a="";void 0!==e&&(a+=e+"\n"),void 0!==t&&(a+="at "+t),void 0!==s&&(a+=":"+s),void 0!==n&&(a+=":"+n),a+="\n";try{const e=[];let t=arguments.callee.caller;for(;t;)e.push(t.name),t=t.caller;a+=e.join("\n")}catch(e){}this.recordError(a,!1)}},window.addEventListener("unhandledrejection",e=>{var t;this.recordError(new Error(`Unhandled rejection (reason: ${(null===(t=e.reason)||void 0===t?void 0:t.stack)||e.reason}).`),!0)})}heartbeat(){const e={};if(this.sessionStarted&&this.trackTime){const t=C.getTimestamp();t-this.lastBeat>=60&&(e.session_duration=t-this.lastBeat,this.lastBeat=t)}(this.pendingEvents.length>0||e.session_duration)&&this.request(e)}async request(e={}){const t=f(f({app_key:this.appKey,device_id:this.userKey},this.getTimeParams()),e);if(this.pendingEvents.length>0){const e=10,s=this.pendingEvents.splice(0,e);t.events=JSON.stringify(s)}const s=new URLSearchParams(t);try{await window.fetch(this.baseUrl.toString(),{method:"POST",mode:"no-cors",cache:"no-cache",redirect:"follow",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:s})}catch(e){console.error("Analytics error: ",e)}}getTimeParams(){const e=new Date;return{timestamp:this.getMsTimestamp(),hour:e.getHours(),dow:e.getDay()}}queue(e){const{count:t=1}=e,s=a()(e,["count"]),n=f(f(f({},this.getTimeParams()),s),{},{count:t,platform:this.appPlatform,app_version:this.appVersion});this.pendingEvents.push(n),this.pendingEvents.length>1e3&&this.pendingEvents.shift()}startTime(){this.trackTime||(this.trackTime=!0,this.lastBeat=C.getTimestamp()-this.storedDuration,this.lastViewTime=C.getTimestamp()-this.lastViewStoredDuration,this.lastViewStoredDuration=0)}stopTime(){this.trackTime&&(this.trackTime=!1,this.storedDuration=C.getTimestamp()-this.lastBeat,this.lastViewStoredDuration=C.getTimestamp()-this.lastViewTime)}getMetrics(){if(this.anonymous)return;const e={};return e._app_version=this.appVersion,e._ua=navigator.userAgent,screen.width&&screen.height&&(e._resolution=`${screen.width}x${screen.height}`),window.devicePixelRatio&&(e._density=window.devicePixelRatio),e._locale=Object(l.d)(),e}async beginSession(e=!0){if(!this.sessionStarted){this.reportOrientation(),window.addEventListener("resize",this.reportOrientation),this.lastBeat=C.getTimestamp(),this.sessionStarted=!0,this.heartbeatEnabled=e;const t={custom:{home_server:m.a.get()&&m.a.getHomeserverName(),anonymous:this.anonymous}},s={begin_session:1,user_details:JSON.stringify(t)},n=this.getMetrics();n&&(s.metrics=JSON.stringify(n)),await this.request(s)}}reportViewDuration(){this.lastView&&(this.track("[CLY]_view",{name:this.lastView},null,{dur:this.trackTime?C.getTimestamp()-this.lastViewTime:this.lastViewStoredDuration}),this.lastView=null)}trackSessions(){this.beginSession(),this.startTime(),window.addEventListener("beforeunload",this.endSession),window.addEventListener("unload",this.endSession),window.addEventListener("visibilitychange",this.onVisibilityChange),window.addEventListener("mousemove",this.onUserActivity),window.addEventListener("click",this.onUserActivity),window.addEventListener("keydown",this.onUserActivity),window.addEventListener("scroll",this.onUserActivity),this.activityIntervalId=setInterval(()=>{this.inactivityCounter++,this.inactivityCounter>=20&&this.stopTime()},6e4)}trackBeginInvite(e){this.track("begin_invite",{},e)}trackSendInvite(e,t,s){this.track("send_invite",{},t,{dur:C.getTimestamp()-e,sum:s})}async trackRoomCreate(e,t){if(this.disabled)return;let s=C.getTimestamp();const n=m.a.get();n.getRoom(t)||(await new Promise(e=>{const s=a=>{a.roomId===t&&(n.off("Room",s),e())};n.on("Room",s)}),s=C.getTimestamp()),this.track("create_room",{},t,{dur:s-e})}trackRoomJoin(e,t,s){this.track("join_room",{type:s},t,{dur:C.getTimestamp()-e})}async trackSendMessage(e,t,s,n,a,i){if(this.disabled)return;const o=m.a.get().getRoom(s),r=(await t).event_id;let l=C.getTimestamp();o.findEventById(r)||(await new Promise(e=>{const t=s=>{s.getId()===r&&(o.off("Room.localEchoUpdated",t),e())};o.on("Room.localEchoUpdated",t)}),l=C.getTimestamp()),this.track("send_message",{is_edit:n,is_reply:a,msgtype:i.msgtype,format:i.format},s,{dur:l-e})}trackStartCall(e,t=!1,s=!1){this.track("start_call",{is_video:t,is_jitsi:s},e)}trackJoinCall(e,t=!1,s=!1){this.track("join_call",{is_video:t,is_jitsi:s},e)}trackRoomDirectoryBegin(){this.track("room_directory")}trackRoomDirectory(e){this.track("room_directory_done",{},null,{dur:C.getTimestamp()-e})}trackRoomDirectorySearch(e,t){this.track("room_directory_search",{query_length:t.length,query_num_words:t.split(" ").length},null,{sum:e})}async track(e,t,s,n,a=!1){if(this.disabled&&!a)return;let i=t||{};s&&(i=f(f({room_id:await _(s)},E(s)),t)),this.queue(f({key:e,count:1,segmentation:i},n)),this.disabled&&a&&await this.request({device_id:Object(r.a)(64)})}}o()(C,"internalInstance",new C),window.mxCountlyAnalytics=C},,function(e,t,s){"use strict";var n=s(82),a=s.n(n);class i{constructor(){a()(this,"platform",null)}get(){return this.platform}set(e){this.platform=e}}window.mxPlatformPeg||(window.mxPlatformPeg=new i),t.a=window.mxPlatformPeg},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.AdvancedEncryption="UIFeature.advancedEncryption",e.URLPreviews="UIFeature.urlPreviews",e.Widgets="UIFeature.widgets",e.Voip="UIFeature.voip",e.Feedback="UIFeature.feedback",e.Registration="UIFeature.registration",e.PasswordReset="UIFeature.passwordReset",e.Deactivate="UIFeature.deactivate",e.ShareQRCode="UIFeature.shareQrCode",e.ShareSocial="UIFeature.shareSocial",e.IdentityServer="UIFeature.identityServer",e.ThirdPartyID="UIFeature.thirdPartyId",e.Flair="UIFeature.flair",e.Communities="UIFeature.communities",e.AdvancedSettings="UIFeature.advancedSettings",e.RoomHistorySettings="UIFeature.roomHistorySettings"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(86),o=s(106);class r{constructor(e){a()(this,"matrixClient",void 0),a()(this,"roomToUser",null),a()(this,"userToRooms",null),a()(this,"hasSentOutPatchDirectAccountDataPatch",void 0),a()(this,"mDirectEvent",void 0),a()(this,"onAccountData",e=>{"m.direct"==e.getType()&&(this.mDirectEvent=this.matrixClient.getAccountData("m.direct").getContent()||{},this.userToRooms=null,this.roomToUser=null)}),this.matrixClient=e,this.hasSentOutPatchDirectAccountDataPatch=!1;const t=e.getAccountData("m.direct");this.mDirectEvent=t?t.getContent():{}}static makeShared(){return r.sharedInstance=new r(i.a.get()),r.sharedInstance}static shared(){return r.sharedInstance}start(){this.populateRoomToUser(),this.matrixClient.on("accountData",this.onAccountData)}stop(){this.matrixClient.removeListener("accountData",this.onAccountData)}patchUpSelfDMs(e){const t=this.matrixClient.getUserId(),s=e[t];if(s){const n=s.map(e=>{const s=this.matrixClient.getRoom(e);if(s){const n=s.guessDMUserId();if(n&&n!==t)return{userId:n,roomId:e}}}).filter(e=>!!e);return!!n.length&&(e[t]=s.filter(e=>!n.some(t=>t.roomId===e)),n.forEach(({userId:t,roomId:s})=>{const n=e[t];n?(n.push(s),e[t]=Object(o.uniq)(n)):e[t]=[s]}),!0)}}getDMRoomsForUserId(e){return this.getUserToRooms()[e]||[]}getDMRoomForIdentifiers(e){let t=this.getDMRoomsForUserId(e[0]);for(let s=1;s<e.length;s++){const n=this.getDMRoomsForUserId(e[s]);t=t.filter(e=>n.includes(e))}return t.map(e=>i.a.get().getRoom(e)).filter(e=>e&&"join"===e.getMyMembership())[0]}getUserIdForRoomId(e){if(null==this.roomToUser&&this.populateRoomToUser(),void 0===this.roomToUser[e]){const t=this.matrixClient.getRoom(e);if(t)return t.getDMInviter()}return this.roomToUser[e]}getUniqueRoomsWithIndividuals(){return this.roomToUser?Object.keys(this.roomToUser).map(e=>({userId:this.getUserIdForRoomId(e),room:this.matrixClient.getRoom(e)})).filter(e=>e.userId&&e.room&&2===e.room.getInvitedAndJoinedMemberCount()).reduce((e,t)=>(e[t.userId]=t.room)&&e,{}):{}}getUserToRooms(){if(!this.userToRooms){const e=this.mDirectEvent,t=e[this.matrixClient.getUserId()];if(t&&t.length){const t=this.patchUpSelfDMs(e);console.warn("Invalid m.direct account data detected (self-chats that shouldn't be), patching it up."),t&&!this.hasSentOutPatchDirectAccountDataPatch&&(this.hasSentOutPatchDirectAccountDataPatch=!0,this.matrixClient.setAccountData("m.direct",e))}this.userToRooms=e}return this.userToRooms}populateRoomToUser(){this.roomToUser={};for(const e of Object.keys(this.getUserToRooms()))for(const t of this.userToRooms[e])this.roomToUser[t]=e}}a()(r,"sharedInstance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return p})),s.d(t,"d",(function(){return g})),s.d(t,"g",(function(){return f})),s.d(t,"f",(function(){return b})),s.d(t,"e",(function(){return v})),s.d(t,"c",(function(){return _})),s.d(t,"j",(function(){return y})),s.d(t,"k",(function(){return E})),s.d(t,"b",(function(){return C})),s.d(t,"i",(function(){return S})),s.d(t,"h",(function(){return x}));var n=s(86),a=s(966),i=s.n(a),o=s(1),r=s(565),l=s(406),c=s(82),d=s.n(c);class m extends l.b{constructor(e){if(super(),d()(this,"_elementUrl",void 0),this._elementUrl=e,!this._elementUrl.startsWith("http:")&&!this._elementUrl.startsWith("https:"))throw new Error("Tchap prefix URL does not appear to be an HTTP(S) URL")}forEvent(e,t,s){return`${this._elementUrl}/#/room/${e}/${t}`}forRoom(e,t){return`${this._elementUrl}/#/room/${e}`}forUser(e){return`${this._elementUrl}/#/user/${e}`}forGroup(e){return`${this._elementUrl}/#/group/${e}`}forEntity(e){if("!"===e[0]||"#"===e[0])return this.forRoom(e);if("@"===e[0])return this.forUser(e);if("+"===e[0])return this.forGroup(e);throw new Error("Unrecognized entity")}isPermalinkHost(e){const t=new URL(this._elementUrl);return e===(t.host||t.hostname)}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(this._elementUrl))throw new Error("Does not appear to be a permalink");const t=e.substring((this._elementUrl+"/#/").length);return m.parseAppRoute(t)}static parseAppRoute(e){const t=e.split("/");if(t.length<2)throw new Error("URL is missing parts");const[s]=t.splice(-1,1),[n,a=""]=s.split("?");t.push(n);const i=t[0],o=t[1];if("user"===i)return l.a.forUser(o);if("group"===i)return l.a.forGroup(o);if("room"===i){const e=t.length>2?t.slice(2).join("/"):"",s=a.split(/&?via=/).filter(e=>!!e);return l.a.forEvent(o,e,s)}throw new Error("Unknown entity type in permalink")}}var h=s(407),u=s(92);class p{constructor(e,t=null){if(this._room=e,this._roomId=e?e.roomId:t,this._highestPlUserId=null,this._populationMap=null,this._bannedHostsRegexps=null,this._allowedHostsRegexps=null,this._serverCandidates=null,this._started=!1,!this._roomId)throw new Error("Failed to resolve a roomId for the permalink creator to use");this.onMembership=this.onMembership.bind(this),this.onRoomState=this.onRoomState.bind(this)}load(){this._room&&this._room.currentState?(this._updateAllowedServers(),this._updateHighestPlUser(),this._updatePopulationMap(),this._updateServerCandidates()):console.warn("Tried to load a permalink creator with no room state")}start(){this.load(),this._room.on("RoomMember.membership",this.onMembership),this._room.on("RoomState.events",this.onRoomState),this._started=!0}stop(){this._room.removeListener("RoomMember.membership",this.onMembership),this._room.removeListener("RoomState.events",this.onRoomState),this._started=!1}isStarted(){return this._started}forEvent(e){let t=this._roomId;return this._room&&this._room.getCanonicalAlias()&&(t=this._room.getCanonicalAlias()),w().forEvent(t,e,this._serverCandidates)}forShareableRoom(){if(this._room){const e=this._room.getCanonicalAlias();if(e)return w().forRoom(e,this._serverCandidates)}return w().forRoom(this._roomId,this._serverCandidates)}forRoom(){let e=this._roomId;return this._room&&this._room.getCanonicalAlias()&&(e=this._room.getCanonicalAlias()),w().forRoom(e,this._serverCandidates)}onRoomState(e){switch(e.getType()){case"m.room.server_acl":return this._updateAllowedServers(),this._updateHighestPlUser(),this._updatePopulationMap(),void this._updateServerCandidates();case"m.room.power_levels":return this._updateHighestPlUser(),void this._updateServerCandidates()}}onMembership(e,t,s){const n=t.userId,a=t.membership,i=R(n),o="join"!==s&&"join"===a;"join"===s&&"join"!==a?this._populationMap[i]--:o&&this._populationMap[i]++,this._updateHighestPlUser(),this._updateServerCandidates()}_updateHighestPlUser(){const e=this._room.currentState.getStateEvents("m.room.power_levels","");if(e){const t=e.getContent();if(t){const e=t.users;if(e){const t=Object.entries(e).filter(([e])=>{const t=this._room.getMember(e);if(!t||"join"!==t.membership)return!1;const s=R(e);return!I(s)&&!k(s,this._bannedHostsRegexps)&&k(s,this._allowedHostsRegexps)}).reduce((e,t)=>t[1]>e[1]?t:e,[null,0]),[s,n]=t;if(null!==s&&n>=50)return void(this._highestPlUserId=s)}}}this._highestPlUserId=null}_updateAllowedServers(){const e=[];let t=[new RegExp(".*")];if(this._room.currentState){const s=this._room.currentState.getStateEvents("m.room.server_acl","");if(s&&s.getContent()){const n=e=>new RegExp("^"+o.o(e,!1)+"$");(s.getContent().deny||[]).forEach(t=>e.push(n(t)));const a=s.getContent().allow||[];t=[],a.forEach(e=>t.push(n(e)))}}this._bannedHostsRegexps=e,this._allowedHostsRegexps=t}_updatePopulationMap(){const e={};for(const t of this._room.getJoinedMembers()){const s=R(t.userId);e[s]||(e[s]=0),e[s]++}this._populationMap=e}_updateServerCandidates(){let e=[];this._highestPlUserId&&e.push(R(this._highestPlUserId));const t=Object.keys(this._populationMap).sort((e,t)=>this._populationMap[t]-this._populationMap[e]).filter(t=>!e.includes(t)&&!I(t)&&!k(t,this._bannedHostsRegexps)&&k(t,this._allowedHostsRegexps)).slice(0,3-e.length);e=e.concat(t),this._serverCandidates=e}}function g(e){return w().forEntity(e)}function f(e){return w().forUser(e)}function b(e){if(!e)throw new Error("can't permalink a falsey roomId");if("!"!==e[0])return w().forRoom(e,[]);const t=n.a.get().getRoom(e);if(!t)return w().forRoom(e,[]);const s=new p(t);return s.load(),s.forRoom()}function v(e){return w().forGroup(e)}function _(e){return!!(new r.b).isPermalinkHost(e)||w().isPermalinkHost(e)}function y(e){return e?"#"===e[0]||"!"===e[0]?b(e):"@"===e[0]?f(e):"+"===e[0]?v(e):E(e):null}function E(e){if(!e.startsWith("http:")&&!e.startsWith("https:"))return e;const t=e.match(h.a.TCHAP_URL_PATTERN);if(t)return t[1];try{const t=S(e);if(t)if(t.roomIdOrAlias){const s=t.eventId?"/"+t.eventId:"";e=`#/room/${t.roomIdOrAlias}${s}`}else t.groupId?e="#/group/"+t.groupId:t.userId&&(e="#/user/"+t.userId)}catch(e){}return e}function C(e){try{let t=S(e);if(!t){const s=e.match(h.a.TCHAP_URL_PATTERN);if(s){const e=new m("http://localhost"),n=s[1].split("#").slice(1).join("#");t=e.parsePermalink("http://localhost/#"+n)}}if(!t)return null;if(t.userId)return t.userId;if(t.groupId)return t.groupId;if(t.roomIdOrAlias)return t.roomIdOrAlias}catch(e){}return null}function w(){const e=u.a.get().permalinkPrefix;return e&&e!==r.a?new m(e):new r.b}function S(e){const t=u.a.get().permalinkPrefix;return e.startsWith(r.a)?(new r.b).parsePermalink(e):t&&e.startsWith(t)?new m(t).parsePermalink(e):null}function x(e){try{const t=e.replace("#/","");return m.parseAppRoute(t)}catch(e){}return null}function R(e){return e.split(":").splice(1).join(":")}function O(e){return e?new URL("https://"+e).hostname:null}function k(e,t){if(!(e=O(e)))return!0;if(t.length>0&&!t[0].test)throw new Error(t[0]);return t.filter(t=>t.test(e)).length>0}function I(e){return!!(e=O(e))&&(e.startsWith("[")&&e.endsWith("]")&&(e=e.substring(1,e.length-1)),i()(e))}},,,function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c}));var n=s(82),a=s.n(n),i=s(6),o=s(505),r=s.n(o);const l="update";class c extends i.EventEmitter{constructor(e,t={}){super(),this.dispatcher=e,a()(this,"storeState",void 0),a()(this,"lock",new r.a),a()(this,"dispatcherRef",void 0),this.dispatcherRef=e.register(this.onDispatch.bind(this)),this.storeState=t}get state(){return this.storeState}stop(){this.dispatcherRef&&this.dispatcher.unregister(this.dispatcherRef)}async updateState(e){await this.lock.acquireAsync();try{this.storeState=Object.freeze(Object.assign({},this.storeState,e)),this.emit(l,this)}finally{await this.lock.release()}}async reset(e=null,t=!1){await this.lock.acquireAsync();try{this.storeState=Object.freeze(e||{}),t||this.emit(l,this)}finally{await this.lock.release()}}}},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(6),o=s.n(i),r=s(303),l=s(148),c=s(86),d=s(87);function m(e){return e.chunk.map(e=>Object(r.c)(e))}function h(e){return e.chunk.map(e=>Object(r.d)(e))}let u=0;const p=[];async function g(e){u>=3&&await new Promise((e,t)=>{p.push(e)}),u++;try{return await e()}catch(e){throw e}finally{u--,function(){const e=p.shift();"function"==typeof e&&e()}()}}class f extends o.a{constructor(){super(),a()(this,"STATE_KEY",{GroupMembers:"GroupMembers",GroupInvitedMembers:"GroupInvitedMembers",Summary:"Summary",GroupRooms:"GroupRooms"}),this._state={},this._state[this.STATE_KEY.Summary]={},this._state[this.STATE_KEY.GroupRooms]={},this._state[this.STATE_KEY.GroupMembers]={},this._state[this.STATE_KEY.GroupInvitedMembers]={},this._ready={},this._ready[this.STATE_KEY.Summary]={},this._ready[this.STATE_KEY.GroupRooms]={},this._ready[this.STATE_KEY.GroupMembers]={},this._ready[this.STATE_KEY.GroupInvitedMembers]={},this._fetchResourcePromise={[this.STATE_KEY.Summary]:{},[this.STATE_KEY.GroupRooms]:{},[this.STATE_KEY.GroupMembers]:{},[this.STATE_KEY.GroupInvitedMembers]:{}},this._resourceFetcher={[this.STATE_KEY.Summary]:e=>g(()=>c.a.get().getGroupSummary(e)),[this.STATE_KEY.GroupRooms]:e=>g(()=>c.a.get().getGroupRooms(e).then(h)),[this.STATE_KEY.GroupMembers]:e=>g(()=>c.a.get().getGroupUsers(e).then(m)),[this.STATE_KEY.GroupInvitedMembers]:e=>g(()=>c.a.get().getGroupInvitedUsers(e).then(m))}}_fetchResource(e,t){if(this._fetchResourcePromise[e][t])return;const s=this._resourceFetcher[e](t);return this._fetchResourcePromise[e][t]=s,s.then(s=>{this._state[e][t]=s,this._ready[e][t]=!0,this._notifyListeners()}).catch(s=>{e===this.STATE_KEY.GroupInvitedMembers&&403===s.httpStatus||(console.error(`Failed to get resource ${e} for ${t}`,s),this.emit("error",s,t,e))}).finally(()=>{delete this._fetchResourcePromise[e][t]}),s}_notifyListeners(){this.emit("update")}registerListener(e,t){return this.on("update",t),this.emit("update"),e&&(this._fetchResource(this.STATE_KEY.Summary,e),this._fetchResource(this.STATE_KEY.GroupRooms,e),this._fetchResource(this.STATE_KEY.GroupMembers,e),this._fetchResource(this.STATE_KEY.GroupInvitedMembers,e)),{unregister:()=>{this.unregisterListener(t)}}}unregisterListener(e){this.removeListener("update",e)}isStateReady(e,t){return this._ready[t][e]}getGroupIdsForRoomId(e){return Object.keys(this._state[this.STATE_KEY.GroupRooms]).filter(t=>(this._state[this.STATE_KEY.GroupRooms][t]||[]).some(t=>t.roomId===e))}getSummary(e){return this._state[this.STATE_KEY.Summary][e]||{}}getGroupRooms(e){return this._state[this.STATE_KEY.GroupRooms][e]||[]}getGroupMembers(e){return this._state[this.STATE_KEY.GroupMembers][e]||[]}getGroupInvitedMembers(e){return this._state[this.STATE_KEY.GroupInvitedMembers][e]||[]}getGroupPublicity(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_publicised:null}isUserPrivileged(e){return(this._state[this.STATE_KEY.Summary][e]||{}).user?(this._state[this.STATE_KEY.Summary][e]||{}).user.is_privileged:null}refreshGroupRooms(e){return this._fetchResource(this.STATE_KEY.GroupRooms,e)}refreshGroupMembers(e){return this._fetchResource(this.STATE_KEY.GroupMembers,e)}addRoomToGroup(e,t,s){return c.a.get().addRoomToGroup(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}updateGroupRoomVisibility(e,t,s){return c.a.get().updateGroupRoomVisibility(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}removeRoomFromGroup(e,t){return c.a.get().removeRoomFromGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e))}inviteUserToGroup(e,t){return c.a.get().inviteUserToGroup(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}acceptGroupInvite(e){return c.a.get().acceptGroupInvite(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}joinGroup(e){return c.a.get().joinGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupInvitedMembers,e))}leaveGroup(e){return d.a.dispatch({action:"deselect_tags",tag:e}),c.a.get().leaveGroup(e).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupRooms,e)).then(this._fetchResource.bind(this,this.STATE_KEY.GroupMembers,e))}addRoomToGroupSummary(e,t,s){return c.a.get().addRoomToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}addUserToGroupSummary(e,t,s){return c.a.get().addUserToGroupSummary(e,t,s).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeRoomFromGroupSummary(e,t){return c.a.get().removeRoomFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}removeUserFromGroupSummary(e,t){return c.a.get().removeUserFromGroupSummary(e,t).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}setGroupPublicity(e,t){return c.a.get().setGroupPublicity(e,t).then(()=>{l.a.invalidatePublicisedGroups(c.a.get().credentials.userId)}).then(this._fetchResource.bind(this,this.STATE_KEY.Summary,e))}}let b=null;b||(b=new f),t.a=b},function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(82),l=s.n(r),c=s(81),d=s.n(c),m=s(90),h=s.n(m),u=s(91),p=s(298);class g extends d.a.PureComponent{constructor(e){super(e),l()(this,"onMouseOver",()=>{this.props.forceHide||this.setState({hover:!0})}),l()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}componentDidUpdate(e){!e.forceHide&&this.props.forceHide&&this.state.hover&&this.setState({hover:!1})}render(){const e=this.props,{title:t,tooltip:s,children:n,tooltipClassName:i,forceHide:r,yOffset:l}=e,c=o()(e,["title","tooltip","children","tooltipClassName","forceHide","yOffset"]),m=this.state.hover?d.a.createElement(p.a,{className:"mx_AccessibleTooltipButton_container",tooltipClassName:h()("mx_AccessibleTooltipButton_tooltip",i),label:s||t,yOffset:l}):d.a.createElement("div",null);return d.a.createElement(u.a,a()({},c,{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,"aria-label":t}),n,m)}}},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(83),l=s(107),c=s(92),d=s(89),m=s(85);function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function u(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const p=/#\/(groups?|room|user|settings|register|login|forgot_password|home|directory)/,g=/#\/(group|room|user)\/.*$/;function f(){const{origin:e,hash:t}=window.location;let{pathname:s}=window.location;return e.startsWith("file://")&&(s="/<redacted>/"),e+s+function(e){return p.exec(e)?g.test(e)?e.replace(g,"#/$1/<redacted>"):e.replace(p,"#/$1"):(console.warn(`Unexpected hash location "${e}"`),"#/<unexpected hash location>")}(t)}const b={"App Platform":{id:1,expl:Object(r.b)("The platform you're on"),example:"Electron Platform"},"App Version":{id:2,expl:Object(r.b)("The version of %(brand)s"),getTextVariables:()=>({brand:c.a.get().brand}),example:"15.0.0"},"User Type":{id:3,expl:Object(r.b)("Whether or not you're logged in (we don't record your username)"),example:"Logged In"},"Chosen Language":{id:4,expl:Object(r.b)("Your language of choice"),example:"en"},Instance:{id:5,expl:Object(r.b)("Which officially provided instance you are using, if any"),example:"app"},"RTE: Uses Richtext Mode":{id:6,expl:Object(r.b)("Whether or not you're using the Richtext mode of the Rich Text Editor"),example:"off"},"Homeserver URL":{id:7,expl:Object(r.b)("Your homeserver's URL"),example:"https://matrix.org"},"Touch Input":{id:8,expl:Object(r.b)("Whether you're using %(brand)s on a device where touch is the primary input mechanism"),getTextVariables:()=>({brand:c.a.get().brand}),example:"false"},Breadcrumbs:{id:9,expl:Object(r.b)("Whether or not you're using the 'breadcrumbs' feature (avatars above the room list)"),example:"disabled"},"Installed PWA":{id:10,expl:Object(r.b)("Whether you're using %(brand)s as an installed Progressive Web App"),getTextVariables:()=>({brand:c.a.get().brand}),example:"false"}};const v="mx_Riot_Analytics_uid";class _{constructor(){a()(this,"baseUrl",null),a()(this,"siteId",null),a()(this,"visitVariables",{}),a()(this,"firstPage",!0),a()(this,"heartbeatIntervalID",null),a()(this,"creationTs",void 0),a()(this,"lastVisitTs",void 0),a()(this,"visitCount",void 0),a()(this,"showDetailsModal",()=>{let e=[];e=this.disabled?Object.keys(b).map(e=>[e,Object(r.a)("e.g. %(exampleValue)s",{exampleValue:b[e].example})]):Object.values(this.visitVariables);const t=`${window.screen.width}x${window.screen.height}`,s=[{expl:Object(r.b)("Every page you use in the app"),value:Object(r.a)("e.g. <CurrentPageURL>",{},{CurrentPageURL:f})},{expl:Object(r.b)("Your user agent"),value:navigator.userAgent},{expl:Object(r.b)("Your device resolution"),value:t}],n=m.getComponent("dialogs.ErrorDialog");d.a.createTrackedDialog("Analytics Details","",n,{title:Object(r.a)("Analytics"),description:o.a.createElement("div",{className:"mx_AnalyticsModal"},o.a.createElement("div",null,Object(r.a)("The information being sent to us to help make %(brand)s better includes:",{brand:c.a.get().brand})),o.a.createElement("table",null,e.map(e=>o.a.createElement("tr",{key:e[0]},o.a.createElement("td",null,Object(r.a)(b[e[0]].expl,b[e[0]].getTextVariables?b[e[0]].getTextVariables():null)),void 0!==e[1]&&o.a.createElement("td",null,o.a.createElement("code",null,e[1])))),s.map((e,t)=>o.a.createElement("tr",{key:t},o.a.createElement("td",null,Object(r.a)(e.expl)),o.a.createElement("td",null,o.a.createElement("code",null,e.value))))),o.a.createElement("div",null,Object(r.a)("Where this page includes identifiable information, such as a room, user or group ID, that data is removed before being sent to the server.")))})}),this.creationTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_cts"),!this.creationTs&&localStorage&&localStorage.setItem("mx_Riot_Analytics_cts",this.creationTs=String((new Date).getTime())),this.lastVisitTs=localStorage&&localStorage.getItem("mx_Riot_Analytics_lvts"),this.visitCount=localStorage&&localStorage.getItem("mx_Riot_Analytics_vc")||"0",this.visitCount=String(parseInt(this.visitCount,10)+1),localStorage&&localStorage.setItem("mx_Riot_Analytics_vc",this.visitCount)}get disabled(){return!this.baseUrl}canEnable(){const e=c.a.get();return"1"!==navigator.doNotTrack&&e&&e.piwik&&e.piwik.url&&e.piwik.siteId}async enable(){if(!this.disabled)return;if(!this.canEnable())return;const e=c.a.get();this.baseUrl=new URL("piwik.php",e.piwik.url),this.baseUrl.searchParams.set("rec","1"),this.baseUrl.searchParams.set("idsite",e.piwik.siteId),this.baseUrl.searchParams.set("apiv","1"),this.baseUrl.searchParams.set("send_image","0"),this.baseUrl.searchParams.set("_id",function(){try{let e=localStorage&&localStorage.getItem(v);return!e&&localStorage&&localStorage.setItem(v,e=[...Array(16)].map(()=>Math.random().toString(16)[2]).join("")),e}catch(e){return console.error("Analytics error: ",e),""}}()),this.baseUrl.searchParams.set("_idts",this.creationTs),this.baseUrl.searchParams.set("_idvc",this.visitCount),this.lastVisitTs&&this.baseUrl.searchParams.set("_viewts",this.lastVisitTs);const t=l.a.get();this.setVisitVariable("App Platform",t.getHumanReadableName());try{this.setVisitVariable("App Version",await t.getAppVersion())}catch(e){this.setVisitVariable("App Version","unknown")}this.setVisitVariable("Chosen Language",Object(r.d)());const s=window.location.hostname;"riot.im"===s?this.setVisitVariable("Instance",window.location.pathname):s.endsWith(".element.io")&&this.setVisitVariable("Instance",s.replace(".element.io",""));let n="unknown";try{n=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}this.setVisitVariable("Installed PWA",n);let a="unknown";try{a=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}this.setVisitVariable("Touch Input",a),this.heartbeatIntervalID=window.setInterval(this.ping.bind(this),3e4)}disable(){this.disabled||(this.trackEvent("Analytics","opt-out"),window.clearInterval(this.heartbeatIntervalID),this.baseUrl=null,this.visitVariables={},localStorage.removeItem(v),localStorage.removeItem("mx_Riot_Analytics_cts"),localStorage.removeItem("mx_Riot_Analytics_vc"),localStorage.removeItem("mx_Riot_Analytics_lvts"))}async _track(e){if(this.disabled)return;const t=new Date,s=u(u({},e),{},{url:f(),_cvar:JSON.stringify(this.visitVariables),res:`${window.screen.width}x${window.screen.height}`,rand:String(Math.random()).slice(2,8),h:t.getHours(),m:t.getMinutes(),s:t.getSeconds()}),n=new URL(this.baseUrl.toString());for(const e in s)n.searchParams.set(e,s[e]);try{await window.fetch(n.toString(),{method:"GET",mode:"no-cors",cache:"no-cache",redirect:"follow"})}catch(e){console.error("Analytics error: ",e)}}ping(){this._track({ping:"1"}),localStorage.setItem("mx_Riot_Analytics_lvts",String((new Date).getTime()))}trackPageChange(e){this.disabled||(this.firstPage?this.firstPage=!1:("number"!=typeof e&&console.warn("Analytics.trackPageChange: expected generationTimeMs to be a number"),this._track({gt_ms:String(e)})))}trackEvent(e,t,s,n){this.disabled||this._track({e_c:e,e_a:t,e_n:s,e_v:n})}setVisitVariable(e,t){this.disabled||(this.visitVariables[b[e].id]=[e,t])}setLoggedIn(e,t){if(this.disabled)return;const s=c.a.get();if(!s.piwik)return;const n=s.piwik.whitelistedHSUrls||[];var a;this.setVisitVariable("User Type",e?"Guest":"Logged In"),this.setVisitVariable("Homeserver URL",(a=t,n.includes(a)?a:"<redacted>"))}setBreadcrumbs(e){this.disabled||this.setVisitVariable("Breadcrumbs",e?"enabled":"disabled")}}window.mxAnalytics||(window.mxAnalytics=new _),t.a=window.mxAnalytics},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(84),o=s.n(i),r=s(83),l=s(88);const c=({w:e=32,h:t=32,imgClassName:n,message:i})=>{let o;return o=l.a.getValue("feature_new_spinner")?s(653):s(247),a.a.createElement("div",{className:"mx_Spinner"},i&&a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:"mx_Spinner_Msg"},i)," "),a.a.createElement("img",{src:o,width:e,height:t,className:n,"aria-label":Object(r.a)("Loading...")}))};c.propTypes={w:o.a.number,h:o.a.number,imgClassName:o.a.string,message:o.a.node},t.a=c},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(81),a=s.n(n);class i extends a.a.Component{constructor(e){super(e),this._collectContainerRef=this._collectContainerRef.bind(this)}_collectContainerRef(e){e&&!this.containerRef&&(this.containerRef=e),this.props.wrappedRef&&this.props.wrappedRef(e)}getScrollTop(){return this.containerRef.scrollTop}render(){return a.a.createElement("div",{ref:this._collectContainerRef,style:this.props.style,className:["mx_AutoHideScrollbar",this.props.className].join(" "),onScroll:this.props.onScroll,onWheel:this.props.onWheel,tabIndex:this.props.tabIndex},this.props.children)}}},function(e,t,s){"use strict";function n(e){return e.slice(0,e.length)}function a(e,t){if(e.length===t.length){for(let s=0;s<e.length;s++)if(e[s]!==t[s])return!0;return!1}return!0}function i(e,t){return e.length!==t.length||(!!t.some(t=>!e.includes(t))||!!e.some(e=>!t.includes(e)))}function o(e,t){return{added:t.filter(t=>!e.includes(t)),removed:e.filter(e=>!t.includes(e))}}function r(e,t){return e.filter(e=>t.includes(e))}function l(...e){return Array.from(e.reduce((e,t)=>(t.forEach(t=>e.add(t)),e),new Set))}s.d(t,"c",(function(){return n})),s.d(t,"e",(function(){return a})),s.d(t,"d",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"g",(function(){return r})),s.d(t,"f",(function(){return l})),s.d(t,"a",(function(){return c}));class c{constructor(e){this.a=e}get value(){return this.a}groupBy(e){const t=this.a.reduce((t,s)=>{const n=e(s);return t.has(n)||t.set(n,[]),t.get(n).push(s),t},new Map);return new d(t)}}class d{constructor(e){this.val=e}orderBy(e){const t=[];for(const s of e)this.val.has(s)&&t.push(...this.val.get(s));return new c(t)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return F})),s.d(t,"j",(function(){return B})),s.d(t,"i",(function(){return V})),s.d(t,"g",(function(){return W})),s.d(t,"h",(function(){return H})),s.d(t,"d",(function(){return G})),s.d(t,"b",(function(){return Y})),s.d(t,"f",(function(){return J})),s.d(t,"e",(function(){return Q})),s.d(t,"c",(function(){return X}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(330),l=s.n(r),c=s(969),d=s(407),m=s(974),h=s.n(m),u=s(976),p=s.n(u),g=s(90),f=s.n(g),b=s(590),v=s.n(b),_=s(112),y=s.n(_),E=s(978),C=s.n(E),w=s(410),S=s(88),x=s(412),R=s.n(x),O=s(86),k=s(110),I=s(277),T=s(238);function j(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function N(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?j(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):j(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}Object(d.a)(c);const P=/([\ud800-\udbff])([\udc00-\udfff])/,D=/([\u2100-\u2bff])/,A=new RegExp("‍| ","g"),U=new RegExp("\\s","g"),M=new RegExp(`^(${v.a.source})+$`,"i"),L=/^#[0-9a-fA-F]{6}$/,F=["http","https","ftp","mailto","magnet"];function B(e){const t=Object(I.e)(e);return t&&t.shortcodes?`:${t.shortcodes[0]}:`:""}function V(e){e=e.slice(1,e.length-1);const t=I.d.get(e);return t?t.unicode:null}function W(e){const t=l()(e,K);return o.a.createElement("div",{dangerouslySetInnerHTML:{__html:t},dir:"auto"})}function H(e){const t=l()(e,K),s=document.createElement("div");return s.innerHTML=t,s.innerText}function G(e){try{const t=y.a.parse(e);return!!t.protocol&&F.includes(t.protocol.slice(0,-1))}catch(e){return!1}}const q={a:function(e,t){if(t.href){t.target="_blank";const e=Object(k.k)(t.href);(e!==t.href||t.href.match(d.a.TCHAP_URL_PATTERN))&&(t.href=e,delete t.target)}return t.rel="noreferrer noopener",{tagName:e,attribs:t}},img:function(e,t){return t.src&&t.src.startsWith("mxc://")&&S.a.getValue("showImages")?(t.src=O.a.get().mxcUrlToHttp(t.src,t.width||800,t.height||600),{tagName:e,attribs:t}):{tagName:e,attribs:{}}},code:function(e,t){if(void 0!==t.class){const e=t.class.split(/\s/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")}));t.class=e.join(" ")}return{tagName:e,attribs:t}},"*":function(e,t){delete t.style;const s={"data-mx-color":"color","data-mx-bg-color":"background-color"};let n="";return Object.keys(s).forEach(e=>{const a=s[e],i=t[e];i&&"string"==typeof i&&L.test(i)&&(n+=a+":"+i+";",delete t[e])}),n&&(t.style=n),{tagName:e,attribs:t}}},K={allowedTags:["font","del","h1","h2","h3","h4","h5","h6","blockquote","p","a","ul","ol","sup","sub","nl","li","b","i","u","strong","em","strike","code","hr","br","div","table","thead","caption","tbody","tr","th","td","pre","span","img"],allowedAttributes:{font:["color","data-mx-bg-color","data-mx-color","style"],span:["data-mx-maths","data-mx-bg-color","data-mx-color","data-mx-spoiler","style"],div:["data-mx-maths"],a:["href","name","target","rel"],img:["src","width","height","alt","title"],ol:["start"],code:["class"]},selfClosing:["img","br","hr","area","base","basefont","input","link","meta"],allowedSchemes:F,allowProtocolRelative:!1,transformTags:q,nestingLimit:50},z=N(N({},K),{},{transformTags:{code:q.code,"*":q["*"]}});class $ extends class{constructor(e,t){this.highlightClass=e,this.highlightLink=t}applyHighlights(e,t){let s,n=0,a=[];const i=t[0];for(;(s=e.toLowerCase().indexOf(i.toLowerCase(),n))>=0;){if(s>n){const i=e.substring(n,s);a=a.concat(this.applySubHighlights(i,t))}const o=s+i.length;a.push(this.processSnippet(e.substring(s,o),!0)),n=o}if(n!==e.length){const s=e.substring(n,void 0);a=a.concat(this.applySubHighlights(s,t))}return a}applySubHighlights(e,t){return t[1]?this.applyHighlights(e,t.slice(1)):[this.processSnippet(e,!1)]}}{processSnippet(e,t){if(!t)return e;let s=`<span class="${this.highlightClass}">${e}</span>`;return this.highlightLink&&(s=`<a href="${encodeURI(this.highlightLink)}">${s}</a>`),s}}function Y(e,t,s={}){const n="org.matrix.custom.html"===e.format&&e.formatted_body;let a,i,r,c=!1,d=K;s.forComposerQuote&&(d=z);try{if(t&&t.length>0){const e=new $("mx_EventTile_searchHighlight",s.highlightLink),n=t.map((function(e){return l()(e,d)}));d.textFilter=function(t){return e.applyHighlights(t,n).join("")}}let o="string"==typeof e.formatted_body?e.formatted_body:null;const h="string"==typeof e.body?e.body:"";if(s.stripReplyFallback&&o&&(o=T.a.stripHTMLReply(o)),a=s.stripReplyFallback?T.a.stripPlainReply(h):h,m=n?o:h,c=P.test(m)||D.test(m),n&&(r=!0,i=l()(o,d),S.a.getValue("feature_latex_maths"))){const e=R.a.load(i,{_useHtmlParser2:!0,decodeEntities:!1});e('div, span[data-mx-maths!=""]').replaceWith((function(t,s){return C.a.renderToString(w.AllHtmlEntities.decode(e(s).attr("data-mx-maths")),{throwOnError:!1,displayMode:"div"==s.name,output:"htmlAndMathml"})})),i=e.html()}}finally{delete d.textFilter}var m;const h=r?i:a;if(s.returnString)return h;let u=!1;if(!s.disableBigEmoji&&c){let t=void 0!==h?h.trim():"";t=t.replace(U,""),t=t.replace(A,"");const s=M.exec(t);u=s&&s[0]&&s[0].length===t.length&&(a===i||void 0===e.formatted_body||!e.formatted_body.includes("http:")&&!e.formatted_body.includes("https:"))}const p=f()({mx_EventTile_body:!0,mx_EventTile_bigEmoji:u,"markdown-body":n&&!u});return r?o.a.createElement("span",{key:"body",ref:s.ref,className:p,dangerouslySetInnerHTML:{__html:i},dir:"auto"}):o.a.createElement("span",{key:"body",ref:s.ref,className:p,dir:"auto"},a)}function J(e,t=d.a.options){return h()(e,t)}function Q(e,t=d.a.options){return l()(function(e,t=d.a.options){return p()(e,t)}(e,t),K)}function X(e){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":case"PRE":case"BLOCKQUOTE":case"P":case"UL":case"OL":case"LI":case"HR":case"TABLE":case"THEAD":case"TBODY":case"TR":case"TH":case"TD":return!0;case"DIV":return!e.hasAttribute("data-mx-maths");default:return!1}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(112),a=s(86),i=s(92),o=s(87),r=s(243),l=s(88),c=s(164),d=s(132),m=s(152),h=s(83),u=s(137);class p{static canUserModifyWidgets(e){if(!e)return console.warn("No room ID specified"),!1;const t=a.a.get();if(!t)return console.warn("User must be be logged in"),!1;const s=t.getRoom(e);if(!s)return console.warn(`Room ID ${e} is not recognised`),!1;const n=t.credentials.userId;return n?"join"!==s.getMyMembership()?(console.warn(`User ${n} is not in room ${e}`),!1):s.currentState.maySendStateEvent("im.vector.modular.widgets",n):(console.warn("Failed to get user ID"),!1)}static isScalarUrl(e){if(!e)return console.error("Scalar URL check failed. No URL specified"),!1;const t=n.parse(e);let s=i.a.get().integrations_widgets_urls;if(!s||0===s.length){const e=c.a.sharedInstance().getPrimaryManager();s=e?[e.apiUrl]:[]}for(let e=0;e<s.length;e++){const a=n.parse(s[e]);if(t&&a&&t.protocol===a.protocol&&t.host===a.host&&t.pathname.startsWith(a.pathname))return!0}return!1}static waitForUserWidget(e,t){return new Promise((s,n)=>{function i(s){return!(!s||!s.getContent())&&(t?void 0!==s.getContent()[e]:void 0===s.getContent()[e])}if(i(a.a.get().getAccountData("m.widgets")))return void s();function o(e){i(a.a.get().getAccountData("m.widgets"))&&(a.a.get().removeListener("accountData",o),clearTimeout(r),s())}const r=setTimeout(()=>{a.a.get().removeListener("accountData",o),n(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);a.a.get().on("accountData",o)})}static waitForRoomWidget(e,t,s){return new Promise((n,i)=>{function o(t){const n=t.some(t=>t.getContent()&&t.getContent().id===e);return s?n:!n}const r=a.a.get().getRoom(t);if(o(r.currentState.getStateEvents("im.vector.modular.widgets")))return void n();function l(e){if(e.getRoomId()!==t)return;o(r.currentState.getStateEvents("im.vector.modular.widgets"))&&(a.a.get().removeListener("RoomState.events",l),clearTimeout(c),n())}const c=setTimeout(()=>{a.a.get().removeListener("RoomState.events",l),i(new Error("Timed out waiting for widget ID "+e+" to appear"))},2e4);a.a.get().on("RoomState.events",l)})}static setUserWidget(e,t,s,n,i){const r={type:t.preferred,url:s,name:n,data:i},l=a.a.get(),c=Object(m.a)(p.getUserWidgets());try{delete c[e]}catch(e){console.error("$widgetId is non-configurable")}const d=Boolean(s);return d&&(c[e]={content:r,sender:l.getUserId(),state_key:e,type:"m.widget",id:e}),l.setAccountData("m.widgets",c).then(()=>p.waitForUserWidget(e,d)).then(()=>{o.a.dispatch({action:"user_widget_updated"})})}static setRoomWidget(e,t,s,n,a,i){let o;return o=Boolean(n)?{type:s.legacy,url:n,name:a,data:i}:{},p.setRoomWidgetContent(e,t,o)}static setRoomWidgetContent(e,t,s){const n=!!s.url;r.a.setRoomWidgetEcho(e,t,s);return a.a.get().sendStateEvent(e,"im.vector.modular.widgets",s,t).then(()=>p.waitForRoomWidget(t,e,n)).finally(()=>{r.a.removeRoomWidgetEcho(e,t)})}static getRoomWidgets(e){const t=e.currentState.getStateEvents("im.vector.modular.widgets");return t?t.filter(e=>e.getContent().type&&e.getContent().url):[]}static getUserWidgets(){const e=a.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");return t&&t.getContent()?t.getContent():{}}static getUserWidgetsArray(){return Object.values(p.getUserWidgets())}static getStickerpickerWidgets(){return p.getUserWidgetsArray().filter(e=>e.content&&"m.stickerpicker"===e.content.type)}static getIntegrationManagerWidgets(){return p.getUserWidgetsArray().filter(e=>e.content&&"m.integration_manager"===e.content.type)}static getRoomWidgetsOfType(e,t){return(p.getRoomWidgets(e)||[]).filter(e=>{const s=e.getContent();return s.url&&t.matches(s.type)})}static removeIntegrationManagerWidgets(){const e=a.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};return Object.entries(s).forEach(([e,t])=>{t.content&&"m.integration_manager"===t.content.type&&delete s[e]}),e.setAccountData("m.widgets",s)}static addIntegrationManagerWidget(e,t,s){return p.setUserWidget("integration_manager_"+(new Date).getTime(),d.a.INTEGRATION_MANAGER,t,"Integration Manager: "+e,{api_url:s})}static removeStickerpickerWidgets(){const e=a.a.get();if(!e)throw new Error("User not logged in");const t=e.getAccountData("m.widgets");if(!t)return;const s=t.getContent()||{};return Object.entries(s).forEach(([e,t])=>{t.content&&"m.stickerpicker"===t.content.type&&delete s[e]}),e.setAccountData("m.widgets",s)}static makeAppConfig(e,t,s,n,a){if(!s)throw new Error("Widgets must be created by someone - provide a senderUserId");return t.creatorUserId=s,t.id=e,t.roomId=n,t.eventId=a,t.name=t.name||t.type,t}static getCapWhitelistForAppTypeInRoomId(e,t){const s=l.a.getValue("enableWidgetScreenshots",t)?[u.MatrixCapabilities.Screenshots]:[];return d.a.JITSI.matches(e)&&s.push(u.MatrixCapabilities.AlwaysOnScreen),s}static getLocalJitsiWrapperUrl(e={}){const t=["conferenceDomain=$domain","conferenceId=$conferenceId","isAudioOnly=$isAudioOnly","displayName=$matrix_display_name","avatarUrl=$matrix_avatar_url","userId=$matrix_user_id","roomId=$matrix_room_id","theme=$theme"];e.auth&&t.push("auth="+e.auth);const s=t.join("&");let n=window.location.href;"https:"===window.location.protocol||e.forLocalRender||(n="https://app.element.io/");return new URL("jitsi.html#"+s,n).href}static getWidgetName(e){var t;return(null==e||null===(t=e.name)||void 0===t?void 0:t.trim())||Object(h.a)("Unknown App")}static getWidgetDataTitle(e){var t,s;return(null==e||null===(t=e.data)||void 0===t||null===(s=t.title)||void 0===s?void 0:s.trim())||""}static editWidget(e,t){l.a.getValue("feature_many_integration_managers")?c.a.sharedInstance().openAll(e,"type_"+t.type,t.id):c.a.sharedInstance().getPrimaryManager().open(e,"type_"+t.type,t.id)}static isManagedByManager(e){if(p.isScalarUrl(e.url)){const e=c.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();return p.isScalarUrl(t.apiUrl)}}return!1}}},function(e,t,s){"use strict";let n;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a})),function(e){e.RoomMemberList="RoomMemberList",e.FilePanel="FilePanel",e.NotificationPanel="NotificationPanel",e.RoomMemberInfo="RoomMemberInfo",e.EncryptionPanel="EncryptionPanel",e.RoomSummary="RoomSummary",e.Widget="Widget",e.Room3pidMemberInfo="Room3pidMemberInfo",e.GroupMemberList="GroupMemberList",e.GroupRoomList="GroupRoomList",e.GroupRoomInfo="GroupRoomInfo",e.GroupMemberInfo="GroupMemberInfo"}(n||(n={}));const a=[n.RoomSummary,n.NotificationPanel,n.FilePanel,n.RoomMemberList,n.GroupMemberList,n.GroupRoomList]},,function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return r}));var n=s(552);let a;!function(e){e.Invite="im.vector.fake.invite",e.Untagged="im.vector.fake.recent",e.Archived="im.vector.fake.archived",e.LowPriority="m.lowpriority",e.Favourite="m.favourite",e.DM="im.vector.fake.direct",e.ServerNotice="m.server_notice"}(a||(a={}));const i=[a.Invite,a.Favourite,a.DM,a.Untagged,a.LowPriority,a.ServerNotice,a.Archived];function o(e){return!Object(n.b)(a,e)}let r;!function(e){e.Timeline="TIMELINE",e.PossibleTagChange="POSSIBLE_TAG_CHANGE",e.ReadReceipt="READ_RECEIPT",e.NewRoom="NEW_ROOM",e.RoomRemoved="ROOM_REMOVED"}(r||(r={}))},,,function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(301),l=s(87),c=s(86),d=s(85),m=s(89),h=s(83),u=s(513),p=s(134),g=s(105);const f={joining:!1,joinError:null,roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:!1,roomAlias:null,roomLoading:!1,roomLoadError:null,forwardingEvent:null,quotingEvent:null,replyingToEvent:null,shouldPeek:!1};class b extends r.Store{constructor(){super(l.a),a()(this,"state",f)}setState(e){let t=!1;for(const s of Object.keys(e))if(this.state[s]!==e[s]){t=!0;break}t&&(this.state=Object.assign(this.state,e),this.__emitChange())}__onDispatch(e){switch(e.action){case"view_room":this.viewRoom(e);break;case"view_create_group":case"view_welcome_page":case"view_home_page":case"view_my_groups":case"view_group":this.setState({roomId:null,roomAlias:null});break;case"view_room_error":this.viewRoomError(e);break;case"will_join":this.setState({joining:!0});break;case"cancel_join":this.setState({joining:!1});break;case"join_room":this.joinRoom(e);break;case"join_room_error":this.joinRoomError(e);break;case"join_room_ready":this.setState({shouldPeek:!1});break;case"on_client_not_viable":case"on_logged_out":this.reset();break;case"forward_event":this.setState({forwardingEvent:e.event});break;case"reply_to_event":e.event&&e.event.getRoomId()!==this.state.roomId?l.a.dispatch({action:"view_room",room_id:e.event.getRoomId(),replyingToEvent:e.event}):this.setState({replyingToEvent:e.event});break;case"open_room_settings":{const t=d.getComponent("dialogs.RoomSettingsDialog");m.a.createTrackedDialog("Room settings","",t,{roomId:e.room_id||this.state.roomId},null,!1,!0);break}}}async viewRoom(e){if(e.room_id){const t={roomId:e.room_id,roomAlias:e.room_alias,initialEventId:e.event_id,isInitialEventHighlighted:e.highlighted,forwardingEvent:null,roomLoading:!1,roomLoadError:null,shouldPeek:void 0===e.should_peek||e.should_peek,joining:e.joining||!1,replyingToEvent:null,isEditingSettings:!1};e.replyingToEvent&&e.replyingToEvent.getRoomId()===e.room_id&&(t.replyingToEvent=e.replyingToEvent),this.state.forwardingEvent&&l.a.dispatch({action:"send_event",room_id:t.roomId,event:this.state.forwardingEvent}),this.setState(t),e.auto_join&&this.joinRoom(e)}else if(e.room_alias){let t=Object(u.a)(e.room_alias);if(!t){this.setState({roomId:null,initialEventId:null,initialEventPixelOffset:null,isInitialEventHighlighted:null,roomAlias:e.room_alias,roomLoading:!0,roomLoadError:null});try{const s=await c.a.get().getRoomIdForAlias(e.room_alias);Object(u.b)(e.room_alias,s.room_id),t=s.room_id}catch(t){return console.error("RVS failed to get room id for alias: ",t),void l.a.dispatch({action:"view_room_error",room_id:null,room_alias:e.room_alias,err:t})}}l.a.dispatch({action:"view_room",room_id:t,event_id:e.event_id,highlighted:e.highlighted,room_alias:e.room_alias,auto_join:e.auto_join,oob_data:e.oob_data})}}viewRoomError(e){this.setState({roomId:e.room_id,roomAlias:e.room_alias,roomLoading:!1,roomLoadError:e.err})}async joinRoom(e){const t=g.a.getTimestamp();this.setState({joining:!0});const s=c.a.get(),n=this.state.roomAlias||this.state.roomId;try{await Object(p.c)(()=>s.joinRoom(n,e.opts),5,e=>504===e.httpStatus),g.a.instance.trackRoomJoin(t,this.state.roomId,e._type),l.a.dispatch({action:"join_room_ready"})}catch(e){l.a.dispatch({action:"join_room_error",err:e});let t=e.message?e.message:JSON.stringify(e);if(console.log("Failed to join room:",t),"ConnectionError"===e.name)t=Object(h.a)("There was an error joining the room");else if("M_INCOMPATIBLE_ROOM_VERSION"===e.errcode)t=o.a.createElement("div",null,Object(h.a)("Sorry, your homeserver is too old to participate in this room."),o.a.createElement("br",null),Object(h.a)("Please contact your homeserver administrator."));else if(404===e.httpStatus){const e=this.getInvitingUserId(this.state.roomId);e&&(t=e.endsWith(":"+c.a.get().getDomain())?Object(h.a)("The person who invited you already left the room."):Object(h.a)("The person who invited you already left the room, or their server is offline."))}const s=d.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Failed to join room","",s,{title:Object(h.a)("Failed to join room"),description:t})}}getInvitingUserId(e){const t=c.a.get(),s=t.getRoom(e);if(s&&"invite"===s.getMyMembership()){const e=s.getMember(t.getUserId()),n=e?e.events.member:null;return n&&n.getSender()}}joinRoomError(e){this.setState({joining:!1,joinError:e.err})}reset(){this.state=Object.assign({},f)}getRoomId(){return this.state.roomId}getInitialEventId(){return this.state.initialEventId}isInitialEventHighlighted(){return this.state.isInitialEventHighlighted}getRoomAlias(){return this.state.roomAlias}isRoomLoading(){return this.state.roomLoading}getRoomLoadError(){return this.state.roomLoadError}isJoining(){return this.state.joining}getJoinError(){return this.state.joinError}getForwardingEvent(){return this.state.forwardingEvent}getQuotingEvent(){return this.state.replyingToEvent}shouldPeek(){return this.state.shouldPeek}}let v=null;v||(v=new b),t.a=v},,function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"c",(function(){return c})),s.d(t,"b",(function(){return d})),s.d(t,"d",(function(){return h})),s.d(t,"e",(function(){return u}));var n=s(83);function a(){return[Object(n.a)("Sun"),Object(n.a)("Mon"),Object(n.a)("Tue"),Object(n.a)("Wed"),Object(n.a)("Thu"),Object(n.a)("Fri"),Object(n.a)("Sat")]}function i(){return[Object(n.a)("Jan"),Object(n.a)("Feb"),Object(n.a)("Mar"),Object(n.a)("Apr"),Object(n.a)("May"),Object(n.a)("Jun"),Object(n.a)("Jul"),Object(n.a)("Aug"),Object(n.a)("Sep"),Object(n.a)("Oct"),Object(n.a)("Nov"),Object(n.a)("Dec")]}function o(e){return(e<10?"0":"")+e}function r(e,t=!1){let s=e.getHours()%12;const a=o(e.getMinutes()),i=e.getHours()>=12?Object(n.a)("PM"):Object(n.a)("AM");if(s=s||12,t){return`${s}:${a}:${o(e.getSeconds())}${i}`}return`${s}:${a}${i}`}function l(e,t=!1){const s=new Date,o=a(),r=i();return e.toDateString()===s.toDateString()?h(e,t):s.getTime()-e.getTime()<5184e5?Object(n.a)("%(weekDayName)s %(time)s",{weekDayName:o[e.getDay()],time:h(e,t)}):s.getFullYear()===e.getFullYear()?Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(time)s",{weekDayName:o[e.getDay()],monthName:r[e.getMonth()],day:e.getDate(),time:h(e,t)}):d(e,t)}function c(e){const t=a(),s=i();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s",{weekDayName:t[e.getDay()],monthName:s[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear()})}function d(e,t=!1){const s=a(),o=i();return Object(n.a)("%(weekDayName)s, %(monthName)s %(day)s %(fullYear)s %(time)s",{weekDayName:s[e.getDay()],monthName:o[e.getMonth()],day:e.getDate(),fullYear:e.getFullYear(),time:m(e,t)})}function m(e,t=!1){return t?r(e,!0):o(e.getHours())+":"+o(e.getMinutes())+":"+o(e.getSeconds())}function h(e,t=!1){return t?r(e):o(e.getHours())+":"+o(e.getMinutes())}function u(e,t){return!(!t||!e)&&(Math.abs(e.getTime()-t.getTime())>864e5||e.getDay()!==t.getDay())}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(616),l=s.n(r),c=s(84),d=s.n(c),m=s(90),h=s.n(m),u=s(99),p=s(91),g=s(86),f=s(83),b=s(97);class v extends o.a.Component{constructor(e){super(e),a()(this,"_onKeyDown",e=>{this.props.onKeyDown&&this.props.onKeyDown(e),this.props.hasCancel&&e.key===u.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1))}),a()(this,"_onCancelClick",e=>{this.props.onFinished(!1)}),this._matrixClient=g.a.get()}render(){let e,t;return this.props.hasCancel&&(e=o.a.createElement(p.a,{onClick:this._onCancelClick,className:"mx_Dialog_cancelButton","aria-label":Object(f.a)("Close dialog")})),this.props.headerImage&&(t=o.a.createElement("img",{className:"mx_Dialog_titleImage",src:this.props.headerImage,alt:""})),o.a.createElement(b.a.Provider,{value:this._matrixClient},o.a.createElement(l.a,{returnFocus:!0,lockProps:{onKeyDown:this._onKeyDown,role:"dialog","aria-labelledby":"mx_BaseDialog_title","aria-describedby":this.props.contentId},className:h()({[this.props.className]:!0,mx_Dialog_fixedWidth:this.props.fixedWidth})},o.a.createElement("div",{className:h()("mx_Dialog_header",{mx_Dialog_headerWithButton:!!this.props.headerButton,mx_Dialog_headerWithCancel:!!e})},o.a.createElement("div",{className:h()("mx_Dialog_title",this.props.titleClass),id:"mx_BaseDialog_title"},t,this.props.title),this.props.headerButton,e),this.props.children))}}a()(v,"propTypes",{onFinished:d.a.func.isRequired,hasCancel:d.a.bool,onKeyDown:d.a.func,className:d.a.string,fixedWidth:d.a.bool,title:d.a.node.isRequired,headerImage:d.a.string,children:d.a.node,contentId:d.a.string,titleClass:d.a.oneOfType([d.a.string,d.a.object,d.a.arrayOf(d.a.string)])}),a()(v,"defaultProps",{hasCancel:!0,fixedWidth:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82),a=s.n(n);class i{constructor(e,t){this.preferred=e,this.legacy=t}matches(e){return e===this.preferred||e===this.legacy}static fromString(e){const t=Object.values(i).filter(e=>e instanceof i).find(t=>t.matches(e));return t||new i(e,e)}}a()(i,"JITSI",new i("m.jitsi","jitsi")),a()(i,"STICKERPICKER",new i("m.stickerpicker","m.stickerpicker")),a()(i,"INTEGRATION_MANAGER",new i("m.integration_manager","m.integration_manager")),a()(i,"CUSTOM",new i("m.custom","m.custom"))},,function(e,t,s){"use strict";function n(e,t){return new Promise(s=>{setTimeout(s,e,t)})}async function a(e,t,s){const n=new Promise(n=>{const a=setTimeout(n,s,t);e.then(()=>{clearTimeout(a)})});return Promise.race([e,n])}function i(){let e,t;const s=new Promise((s,n)=>{e=s,t=n});return{resolve:e,reject:t,promise:s}}function o(e){return Promise.allSettled?Promise.allSettled(e):Promise.all(e.map(e=>e.then(e=>({status:"fulfilled",value:e})).catch(e=>({status:"rejected",reason:e}))))}async function r(e,t,s){let n;for(let a=0;a<t;a++)try{return await e()}catch(e){if(s&&!s(e))throw e;n=e}throw n}s.d(t,"d",(function(){return n})),s.d(t,"e",(function(){return a})),s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o})),s.d(t,"c",(function(){return r}))},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(6),o=s.n(i);class r extends o.a{constructor(...e){super(...e),a()(this,"toasts",[]),a()(this,"countSeen",0)}static sharedInstance(){return window.mxToastStore||(window.mxToastStore=new r),window.mxToastStore}reset(){this.toasts=[],this.countSeen=0}addOrReplaceToast(e){const t=this.toasts.findIndex(t=>t.key===e.key);if(-1===t){let t=this.toasts.length;for(;t>0&&this.toasts[t-1].priority<e.priority;)--t;this.toasts.splice(t,0,e)}else this.toasts[t]=e;this.emit("update")}dismissToast(e){this.toasts[0]&&this.toasts[0].key===e&&this.countSeen++;const t=this.toasts.length;this.toasts=this.toasts.filter(t=>t.key!==e),t!==this.toasts.length&&(0===this.toasts.length&&(this.countSeen=0),this.emit("update"))}getToasts(){return this.toasts}getCountSeen(){return this.countSeen}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(83);class m extends o.a.Component{constructor(...e){super(...e),a()(this,"onClick",()=>{this.props.onFinished(!0)})}render(){const e=c.getComponent("views.dialogs.BaseDialog");return o.a.createElement(e,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:this.props.title||Object(d.a)("Error"),headerImage:this.props.headerImage,contentId:"mx_Dialog_content"},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description||Object(d.a)("An error has occurred.")),o.a.createElement("div",{className:"mx_Dialog_buttons"},o.a.createElement("button",{className:"mx_Dialog_primary",onClick:this.onClick,autoFocus:this.props.focus},this.props.button||Object(d.a)("OK"))))}}a()(m,"propTypes",{title:l.a.string,description:l.a.oneOfType([l.a.element,l.a.string]),button:l.a.string,focus:l.a.bool,onFinished:l.a.func.isRequired,headerImage:l.a.string}),a()(m,"defaultProps",{focus:!0,title:null,description:null,button:null})},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return A})),s.d(t,"b",(function(){return U}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(86),l=s(107),c=s(89),d=s(83),m=s(127),h=s(87),u=s(122),p=s(243),g=s(88),f=s(1132),b=s(447),v=s(132),_=s(96),y=s(654),E=s(142),C=s(140),w=s(197),S=s(260),x=s(7),R=s(116),O=s(105),k=s(108),I=s(0),T=s(655),j=s(94),N=s(639),P=s(1136);var D;let A;!function(e){e.Ring="ringAudio",e.Ringback="ringbackAudio",e.CallEnd="callendAudio",e.Busy="busyAudio"}(D||(D={})),function(e){e.Voice="voice",e.Video="video",e.ScreenSharing="screensharing"}(A||(A={}));class U{constructor(){a()(this,"calls",new Map),a()(this,"audioPromises",new Map),a()(this,"dispatcherRef",null),a()(this,"supportsPstnProtocol",null),a()(this,"pstnSupportCheckTimer",void 0),a()(this,"onCallIncoming",e=>{h.a.dispatch({action:"incoming_call",call:e},!0)}),a()(this,"onAction",e=>{switch(e.action){case"place_call":{if(Object(P.b)())return void Object(P.a)(e.room_id);if(!r.a.get().supportsVoip())return void c.a.createTrackedDialog("Call Handler","VoIP is unsupported",C.a,{title:Object(d.a)("VoIP is unsupported"),description:Object(d.a)("You cannot place VoIP calls in this browser.")});if(this.getAllActiveCalls().length>1)return void c.a.createTrackedDialog("Call Handler","Existing Call",C.a,{title:Object(d.a)("Too Many Calls"),description:Object(d.a)("You've reached the maximum number of simultaneous calls.")});const t=r.a.get().getRoom(e.room_id);if(!t)return void console.error(`Room ${e.room_id} does not exist.`);const s=t.getJoinedMembers();if(s.length<=1)return void c.a.createTrackedDialog("Call Handler","Cannot place call with self",C.a,{description:Object(d.a)("You cannot place a call with yourself.")});2===s.length?(console.info(`Place ${e.type} call in ${e.room_id}`),this.placeCall(e.room_id,e.type,e.local_element,e.remote_element)):h.a.dispatch({action:"place_conference_call",room_id:e.room_id,type:e.type,remote_element:e.remote_element,local_element:e.local_element})}break;case"place_conference_call":console.info("Place conference call in "+e.room_id),R.a.trackEvent("voip","placeConferenceCall"),O.a.instance.trackStartCall(e.room_id,e.type===A.Video,!0),this.startCallApp(e.room_id,e.type);break;case"end_conference":console.info("Terminating conference call in "+e.room_id),this.terminateCallApp(e.room_id);break;case"hangup_conference":console.info("Leaving conference call in "+e.room_id),this.hangupCallApp(e.room_id);break;case"incoming_call":{if(!r.a.get().supportsVoip())return;const t=e.call,s=U.roomIdForCall(t);if(this.getCallForRoom(s))return;R.a.trackEvent("voip","receiveCall","type",t.type),this.calls.set(s,t),this.setCallListeners(t)}break;case"hangup":case"reject":if(!this.calls.get(e.room_id))return;"reject"===e.action?this.calls.get(e.room_id).reject():this.calls.get(e.room_id).hangup(m.b.UserHangup,!1);break;case"answer":{if(!this.calls.has(e.room_id))return;if(this.getAllActiveCalls().length>1)return void c.a.createTrackedDialog("Call Handler","Existing Call",C.a,{title:Object(d.a)("Too Many Calls"),description:Object(d.a)("You've reached the maximum number of simultaneous calls.")});const t=this.calls.get(e.room_id);t.answer(),this.setCallAudioElement(t),this.setActiveCallRoomId(e.room_id),O.a.instance.trackJoinCall(e.room_id,t.type===m.f.Video,!1),h.a.dispatch({action:"view_room",room_id:e.room_id});break}}})}static sharedInstance(){return window.mxCallHandler||(window.mxCallHandler=new U),window.mxCallHandler}static roomIdForCall(e){return e?Object(N.c)(e.roomId)||e.roomId:null}start(){this.dispatcherRef=h.a.register(this.onAction),navigator.mediaSession&&(navigator.mediaSession.setActionHandler("play",(function(){})),navigator.mediaSession.setActionHandler("pause",(function(){})),navigator.mediaSession.setActionHandler("seekbackward",(function(){})),navigator.mediaSession.setActionHandler("seekforward",(function(){})),navigator.mediaSession.setActionHandler("previoustrack",(function(){})),navigator.mediaSession.setActionHandler("nexttrack",(function(){}))),g.a.getValue(k.a.Voip)&&r.a.get().on("Call.incoming",this.onCallIncoming),this.checkForPstnSupport(3)}stop(){const e=r.a.get();e&&e.removeListener("Call.incoming",this.onCallIncoming),null!==this.dispatcherRef&&(h.a.unregister(this.dispatcherRef),this.dispatcherRef=null)}async checkForPstnSupport(e){try{const e=await r.a.get().getThirdpartyProtocols();void 0!==e["im.vector.protocol.pstn"]?this.supportsPstnProtocol=e["im.vector.protocol.pstn"]:void 0!==e["m.protocol.pstn"]?this.supportsPstnProtocol=e["m.protocol.pstn"]:this.supportsPstnProtocol=null,h.a.dispatch({action:j.a.PstnSupportUpdated})}catch(t){1===e?console.log("Failed to check for pstn protocol support and no retries remain: assuming no support",t):(console.log("Failed to check for pstn protocol support: will retry",t),this.pstnSupportCheckTimer=setTimeout(()=>{this.checkForPstnSupport(e-1)},1e4))}}getSupportsPstnProtocol(){return this.supportsPstnProtocol}getCallForRoom(e){return this.calls.get(e)||null}getAnyActiveCall(){for(const e of this.calls.values())if(e.state!==m.e.Ended)return e;return null}getAllActiveCalls(){const e=[];for(const t of this.calls.values())t.state!==m.e.Ended&&t.state!==m.e.Ringing&&e.push(t);return e}getAllActiveCallsNotInRoom(e){const t=[];for(const[s,n]of this.calls.entries())s!==e&&n.state!==m.e.Ended&&t.push(n);return t}play(e){const t=document.getElementById(e);if(t){const s=async()=>{try{await t.play()}catch(e){console.log("Unable to play audio clip",e)}};this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>(t.load(),s()))):this.audioPromises.set(e,s())}}pause(e){const t=document.getElementById(e);t&&(this.audioPromises.has(e)?this.audioPromises.set(e,this.audioPromises.get(e).then(()=>t.pause())):t.pause())}matchesCallForThisRoom(e){const t=U.roomIdForCall(e),s=this.getCallForRoom(t);return s&&e.callId===s.callId}setCallListeners(e){const t=U.roomIdForCall(e);e.on(m.c.Error,t=>{this.matchesCallForThisRoom(e)&&(R.a.trackEvent("voip","callError","error",t.toString()),console.error("Call error:",t),t.code!==m.b.NoUserMedia?0!==r.a.get().getTurnServers().length||null!==g.a.getValue("fallbackICEServerAllowed")?c.a.createTrackedDialog("Call Failed","",C.a,{title:Object(d.a)("Call Failed"),description:t.message}):this.showICEFallbackPrompt():this.showMediaCaptureError(e))}),e.on(m.c.Hangup,()=>{this.matchesCallForThisRoom(e)&&(R.a.trackEvent("voip","callHangup"),this.removeCallForRoom(t))}),e.on(m.c.State,(s,n)=>{if(this.matchesCallForThisRoom(e)){switch(this.setCallState(e,s),n){case m.e.Ringing:this.pause(D.Ring);break;case m.e.InviteSent:this.pause(D.Ringback)}switch(s){case m.e.Ringing:this.play(D.Ring);break;case m.e.InviteSent:this.play(D.Ringback);break;case m.e.Ended:if(R.a.trackEvent("voip","callEnded","hangupReason",e.hangupReason),this.removeCallForRoom(t),n===m.e.InviteSent&&(e.hangupParty===m.d.Remote||e.hangupParty===m.d.Local&&e.hangupReason===m.b.InviteTimeout)){let t,s;this.play(D.Busy),e.hangupReason===m.b.UserHangup?(t=Object(d.a)("Call Declined"),s=Object(d.a)("The other party declined the call.")):e.hangupReason===m.b.InviteTimeout?(t=Object(d.a)("Call Failed"),s=Object(d.a)("The remote side failed to pick up")+"."):(t=Object(d.a)("Call Failed"),s=Object(d.a)("The call could not be established")),c.a.createTrackedDialog("Call Handler","Call Failed",C.a,{title:t,description:s})}else e.hangupReason===m.b.AnsweredElsewhere&&n===m.e.Connecting?c.a.createTrackedDialog("Call Handler","Call Failed",C.a,{title:Object(d.a)("Answered Elsewhere"),description:Object(d.a)("The call was answered on another device.")}):n!==m.e.Fledgling&&n!==m.e.Ringing&&this.play(D.CallEnd);this.logCallStats(e,t)}}}),e.on(m.c.Replaced,s=>{this.matchesCallForThisRoom(e)&&(console.log(`Call ID ${e.callId} is being replaced by call ID ${s.callId}`),e.state===m.e.Ringing?this.pause(D.Ring):e.state===m.e.InviteSent&&this.pause(D.Ringback),this.calls.set(t,s),this.setCallListeners(s),this.setCallState(s,s.state))})}async logCallStats(e,t){const s=await e.getCurrentCallStats();if(I.a.debug(`Call completed. Call ID: ${e.callId}, virtual room ID: ${e.roomId}, user-facing room ID: ${t}, direction: ${e.direction}, our Party ID: ${e.ourPartyId}, hangup party: ${e.hangupParty}, hangup reason: `+e.hangupReason),s){I.a.debug("Local candidates:");for(const e of s.filter(e=>"local-candidate"===e.type)){const t=e.address||e.ip;I.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: ${e.protocol}, relay protocol: ${e.relayProtocol}, network type: ${e.networkType}`)}I.a.debug("Remote candidates:");for(const e of s.filter(e=>"remote-candidate"===e.type)){const t=e.address||e.ip;I.a.debug(`${e.id} - type: ${e.candidateType}, address: ${t}, port: ${e.port}, protocol: `+e.protocol)}I.a.debug("Candidate pairs:");for(const e of s.filter(e=>"candidate-pair"===e.type))I.a.debug(`${e.localCandidateId} / ${e.remoteCandidateId} - state: ${e.state}, nominated: ${e.nominated}, requests sent ${e.requestsSent}, requests received  ${e.requestsReceived},  responses received: ${e.responsesReceived}, responses sent: ${e.responsesSent}, bytes received: ${e.bytesReceived}, bytes sent: ${e.bytesSent}, `)}else I.a.debug("Call statistics are undefined. The call has probably failed before a peerConn was established")}setCallAudioElement(e){const t=function(){const e=document.getElementById("remoteAudio");return e||(console.error("Failed to find remoteAudio element - cannot play audio!You need to add an <audio/> to the DOM."),null)}();t&&e.setRemoteAudioElement(t)}setCallState(e,t){const s=U.roomIdForCall(e);console.log(`Call state in ${s} changed to ${t}`),h.a.dispatch({action:"call_state",room_id:s,state:t})}removeCallForRoom(e){this.calls.delete(e)}showICEFallbackPrompt(){const e=r.a.get(),t=e=>o.a.createElement("code",null,e);c.a.createTrackedDialog("No TURN servers","",E.a,{title:Object(d.a)("Call failed due to misconfigured server"),description:o.a.createElement("div",null,o.a.createElement("p",null,Object(d.a)("Please ask the administrator of your homeserver (<code>%(homeserverDomain)s</code>) to configure a TURN server in order for calls to work reliably.",{homeserverDomain:e.getDomain()},{code:t})),o.a.createElement("p",null,Object(d.a)("Alternatively, you can try to use the public server at <code>turn.matrix.org</code>, but this will not be as reliable, and it will share your IP address with that server. You can also manage this in Settings.",null,{code:t}))),button:Object(d.a)("Try using turn.matrix.org"),cancelButton:Object(d.a)("OK"),onFinished:t=>{g.a.setValue("fallbackICEServerAllowed",null,_.a.DEVICE,t),e.setFallbackICEServerAllowed(t)}},null,!0)}showMediaCaptureError(e){let t,s;e.type===m.f.Voice?(t=Object(d.a)("Unable to access microphone"),s=o.a.createElement("div",null,Object(d.a)("Call failed because microphone could not be accessed. Check that a microphone is plugged in and set up correctly."))):e.type===m.f.Video&&(t=Object(d.a)("Unable to access webcam / microphone"),s=o.a.createElement("div",null,Object(d.a)("Call failed because webcam or microphone could not be accessed. Check that:"),o.a.createElement("ul",null,o.a.createElement("li",null,Object(d.a)("A microphone and webcam are plugged in and set up correctly")),o.a.createElement("li",null,Object(d.a)("Permission is granted to use the webcam")),o.a.createElement("li",null,Object(d.a)("No other application is using the webcam"))))),c.a.createTrackedDialog("Media capture failed","",C.a,{title:t,description:s},null,!0)}async placeCall(e,t,s,n){R.a.trackEvent("voip","placeCall","type",t),O.a.instance.trackStartCall(e,t===A.Video,!1);const a=await Object(N.a)(e)||e;I.a.debug("Mapped real room "+e+" to room ID "+a);const i=Object(m.g)(r.a.get(),a);if(this.calls.set(e,i),this.setCallListeners(i),this.setCallAudioElement(i),this.setActiveCallRoomId(e),t===A.Voice)i.placeVoiceCall();else if("video"===t)i.placeVideoCall(n,s);else if(t===A.ScreenSharing){const t=l.a.get().screenCaptureErrorString();if(t)return this.removeCallForRoom(e),console.log("Can't capture screen: "+t),void c.a.createTrackedDialog("Call Handler","Unable to capture screen",C.a,{title:Object(d.a)("Unable to capture screen"),description:t});i.placeScreenSharingCall(n,s,async()=>{const{finished:e}=c.a.createDialog(T.a),[t]=await e;return t})}else console.error("Unknown conf call type: "+t)}setActiveCallRoomId(e){I.a.info("Setting call in room "+e+" active");for(const[t,s]of this.calls.entries())s.state!==m.e.Ended&&(t===e?s.setRemoteOnHold(!1):(I.a.info("Holding call in room "+t+" because another call is being set active"),s.setRemoteOnHold(!0)))}hasAnyUnheldCall(){for(const e of this.calls.values())if(e.state!==m.e.Ended&&!e.isRemoteOnHold())return!0;return!1}async startCallApp(t,s){h.a.dispatch({action:"appsDrawer",show:!0});const n=r.a.get().getRoom(t),a=u.a.getRoomWidgetsOfType(n,v.a.JITSI);if(a.length>0||p.a.roomHasPendingWidgetsOfType(t,a,v.a.JITSI))return void c.a.createTrackedDialog("Call already in progress","",C.a,{title:Object(d.a)("Call in Progress"),description:Object(d.a)("A call is currently being placed!")});const i=b.a.getInstance().preferredDomain,o=await b.a.getInstance().getJitsiAuth();let l;l="openidtoken-jwt"===o?y.base32.stringify(e.from(t),{pad:!1}):"JitsiConference"+Object(f.a)();let m=u.a.getLocalJitsiWrapperUrl({auth:o});const g=new URL(m);g.search="",g.searchParams.set("confId",l),m=g.toString();const _={conferenceId:l,isAudioOnly:"voice"===s,domain:i,auth:o},E="jitsi_"+r.a.get().credentials.userId+"_"+Date.now();u.a.setRoomWidget(t,E,v.a.JITSI,m,"Jitsi",_).then(()=>{console.log("Jitsi widget added")}).catch(e=>{"M_FORBIDDEN"===e.errcode&&c.a.createTrackedDialog("Call Failed","",C.a,{title:Object(d.a)("Permission Required"),description:Object(d.a)("You do not have permission to start a conference call in this room")}),console.error(e)})}terminateCallApp(e){c.a.createTrackedDialog("Confirm Jitsi Terminate","",E.a,{hasCancelButton:!0,title:Object(d.a)("End conference"),description:Object(d.a)("This will end the conference for everyone. Continue?"),button:Object(d.a)("End conference"),onFinished:t=>{if(!t)return;w.a.instance.getRoom(e).widgets.filter(e=>v.a.JITSI.matches(e.type)).forEach(t=>{u.a.setRoomWidget(e,t.id)})}})}hangupCallApp(e){const t=w.a.instance.getRoom(e);if(!t)return;t.widgets.filter(e=>v.a.JITSI.matches(e.type)).forEach(e=>{const t=S.a.instance.getMessagingForId(e.id);t&&t.transport.send(x.a.HangupCall,{})})}}}).call(this,s(32).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(90),d=s.n(c),m=s(85),h=s(83);class u extends o.a.Component{constructor(...e){super(...e),a()(this,"onOk",()=>{this.props.onFinished(!0)}),a()(this,"onCancel",()=>{this.props.onFinished(!1)})}render(){const e=m.getComponent("views.dialogs.BaseDialog"),t=m.getComponent("views.elements.DialogButtons");let s="";return this.props.danger&&(s="danger"),o.a.createElement(e,{className:d()("mx_QuestionDialog",this.props.className),onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",headerImage:this.props.headerImage,hasCancel:this.props.hasCancelButton,fixedWidth:this.props.fixedWidth},o.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},this.props.description),o.a.createElement(t,{primaryButton:this.props.button||Object(h.a)("OK"),primaryButtonClass:s,primaryDisabled:this.props.buttonDisabled,cancelButton:this.props.cancelButton,hasCancel:this.props.hasCancelButton&&!this.props.quitOnly,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:this.onCancel},this.props.extraButtons))}}a()(u,"propTypes",{title:l.a.string,description:l.a.node,extraButtons:l.a.node,button:l.a.string,buttonDisabled:l.a.bool,danger:l.a.bool,focus:l.a.bool,onFinished:l.a.func.isRequired,headerImage:l.a.string,quitOnly:l.a.bool,fixedWidth:l.a.bool,className:l.a.string}),a()(u,"defaultProps",{title:"",description:"",extraButtons:null,focus:!0,hasCancelButton:!0,danger:!1,quitOnly:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(349);class d extends o.a.Component{render(){let e=o.a.createElement("span",{className:"mx_SettingsFlag_label"},this.props.label),t=o.a.createElement(c.a,{checked:this.props.value,disabled:this.props.disabled,onChange:this.props.onChange,"aria-label":this.props.label});if(this.props.toggleInFront){const s=e;e=t,t=s}const s="mx_SettingsFlag "+(this.props.className||"");return o.a.createElement("div",{className:s},e,t)}}a()(d,"propTypes",{value:l.a.bool.isRequired,onChange:l.a.func.isRequired,label:l.a.string.isRequired,disabled:l.a.bool,toggleInFront:l.a.bool,className:l.a.string})},,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(82),l=s.n(r),c=s(81),d=s.n(c),m=s(179);class h extends d.a.PureComponent{constructor(e){super(e),l()(this,"id",void 0),this.id="checkbox_"+Object(m.a)(10)}render(){const e=this.props,{children:t,className:n}=e,i=o()(e,["children","className"]);return d.a.createElement("span",{className:"mx_Checkbox "+n},d.a.createElement("input",a()({id:this.id},i,{type:"checkbox"})),d.a.createElement("label",{htmlFor:this.id},d.a.createElement("div",{className:"mx_Checkbox_background"},d.a.createElement("img",{src:s(790)})),d.a.createElement("div",null,this.props.children)))}}l()(h,"defaultProps",{className:""})},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(81);const a=(e,t,s)=>{const a=Object(n.useRef)(s);Object(n.useEffect)(()=>{a.current=s},[s]),Object(n.useEffect)(()=>{if(!e)return;const s=(...e)=>a.current(...e);return e.on(t,s),()=>{e.removeListener(t,s)}},[t,e])}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(113),o=s(506);class r extends i.a{constructor(e,t={}){super(e,t),a()(this,"readyStore",void 0);const s=this;this.readyStore=new class extends o.a{get mxClient(){return this.matrixClient}async onReady(){return s.onReady()}async onNotReady(){return s.onNotReady()}}(e)}get matrixClient(){return this.readyStore.mxClient}async onReady(){}async onNotReady(){}async onDispatch(e){await this.onAction(e)}}},function(e,t,s){"use strict";(function(e){var n=s(6),a=s.n(n);let i=!0;class o extends a.a{constructor(e){super(),this._matrixClient=e,this._userGroups={},this._groupProfiles={},this._groupProfilesPromise={},this._usersPending={},this._usersInFlight={},this._debounceTimeoutID=null}groupSupport(){return i}invalidatePublicisedGroups(e){delete this._userGroups[e]}getPublicisedGroupsCached(e,t){return this._userGroups[t]?Promise.resolve(this._userGroups[t]):this._usersPending[t]?this._usersPending[t].prom:this._usersInFlight[t]?this._usersInFlight[t].prom:(this._usersPending[t]={},this._usersPending[t].prom=new Promise((e,s)=>{this._usersPending[t].resolve=e,this._usersPending[t].reject=s}).then(e=>(this._userGroups[t]=e,setTimeout(()=>{delete this._userGroups[t]},18e5),this._userGroups[t])).catch(e=>{if("M_UNRECOGNIZED"===e.errcode)return console.warn("Cannot display flair, server does not support groups"),void(i=!1);throw console.error("Could not get groups for user",t,e),e}).finally(()=>{delete this._usersInFlight[t]}),this._debounceTimeoutID&&clearTimeout(this._debounceTimeoutID),this._debounceTimeoutID=setTimeout(()=>{this._batchedGetPublicGroups(e)},200),this._usersPending[t].prom)}async _batchedGetPublicGroups(e){this._usersInFlight=this._usersPending,this._usersPending={};let t={users:[]};try{t=await e.getPublicisedGroups(Object.keys(this._usersInFlight))}catch(e){return void Object.keys(this._usersInFlight).forEach(t=>{this._usersInFlight[t]&&this._usersInFlight[t].reject(e)})}const s=t.users;Object.keys(this._usersInFlight).forEach(e=>{this._usersInFlight[e]&&this._usersInFlight[e].resolve(s[e]||[])})}getGroupProfileCachedFast(e,t){return e&&t?this._groupProfiles[t]?this._groupProfiles[t]:(this.getGroupProfileCached(e,t),null):null}async getGroupProfileCached(e,t){if(this._groupProfiles[t])return this._groupProfiles[t];if(this._groupProfilesPromise[t]){try{await this._groupProfilesPromise[t]}catch(e){return null}return this._groupProfiles[t]}let s;console.log("FlairStore: Request group profile of "+t),this._groupProfilesPromise[t]=e.getGroupProfile(t);try{s=await this._groupProfilesPromise[t]}catch(e){return console.log("FlairStore: Failed to get group profile for "+t,e),delete this._groupProfilesPromise[t],null}return this._groupProfiles[t]={groupId:t,avatarUrl:s.avatar_url,name:s.name,shortDescription:s.short_description},delete this._groupProfilesPromise[t],console.log("FlairStore: Emit updateGroupProfile for "+t),this.emit("updateGroupProfile"),setTimeout(()=>{this.refreshGroupProfile(e,t)},18e5),this._groupProfiles[t]}refreshGroupProfile(e,t){return delete this._groupProfiles[t],this.getGroupProfileCached(e,t)}}void 0===e.singletonFlairStore&&(e.singletonFlairStore=new o),t.a=e.singletonFlairStore}).call(this,s(5))},,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return C})),s.d(t,"b",(function(){return S}));var n=s(82),a=s.n(n),i=s(88),o=s(125),r=s(237),l=s(87),c=s(553),d=s(314),m=s(1502),h=s(128),u=s(1497),p=s(171),g=s(1),f=s(768),b=s(1128),v=s(147),_=s(640),y=s(176),E=s(770);const C="lists_update";class w extends v.a{constructor(){super(l.a),a()(this,"initialListsGenerated",!1),a()(this,"algorithm",new u.a),a()(this,"filterConditions",[]),a()(this,"tagWatcher",new m.a(this)),a()(this,"updateFn",new b.a(()=>{for(const e of Object.keys(this.unfilteredLists))y.a.instance.getListState(e).setRooms(this.unfilteredLists[e]);this.emit(C)})),a()(this,"watchedSettings",["feature_custom_tags","advancedRoomListLogging"]),a()(this,"onAlgorithmListUpdated",()=>{i.a.getValue("advancedRoomListLogging")&&console.log("Underlying algorithm has triggered a list update - marking"),this.updateFn.mark()}),a()(this,"onAlgorithmFilterUpdated",()=>{this.updateFn.trigger()}),this.checkLoggingEnabled();for(const e of this.watchedSettings)i.a.monitorSetting(e,null);h.a.addListener(()=>this.handleRVSUpdate({})),this.algorithm.on(u.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmFilterUpdated)}get unfilteredLists(){return this.algorithm?this.algorithm.getUnfilteredRooms():{}}get orderedLists(){return this.algorithm?this.algorithm.getOrderedRooms():{}}async resetStore(){await this.reset(),this.tagWatcher=new m.a(this),this.filterConditions=[],this.initialListsGenerated=!1,this.algorithm.off(u.b,this.onAlgorithmListUpdated),this.algorithm.off(d.a,this.onAlgorithmListUpdated),this.algorithm=new u.a,this.algorithm.on(u.b,this.onAlgorithmListUpdated),this.algorithm.on(d.a,this.onAlgorithmListUpdated),await this.reset(null,!0)}async makeReady(e){e&&this.readyStore.useUnitTestClient(e),this.checkLoggingEnabled(),console.log("Regenerating room lists: Startup"),await this.readAndCacheSettingsFromStore(),await this.regenerateAllLists({trigger:!1}),await this.handleRVSUpdate({trigger:!1}),this.updateFn.mark(),this.updateFn.trigger()}checkLoggingEnabled(){i.a.getValue("advancedRoomListLogging")&&console.warn("Advanced room list logging is enabled")}async readAndCacheSettingsFromStore(){const e=i.a.getValue("feature_custom_tags");await this.updateState({tagsEnabled:e}),await this.updateAlgorithmInstances()}async handleRVSUpdate({trigger:e=!0}){if(!this.matrixClient)return;const t=h.a.getRoomId();if(!t&&this.algorithm.stickyRoom)await this.algorithm.setStickyRoom(null);else if(t){const e=this.matrixClient.getRoom(t);e?e!==this.algorithm.stickyRoom&&(i.a.getValue("advancedRoomListLogging")&&console.log("Changing sticky room to "+t),await this.algorithm.setStickyRoom(e)):(console.warn(t+" is current in RVS but missing from client - clearing sticky room"),await this.algorithm.setStickyRoom(null))}e&&this.updateFn.trigger()}async onReady(){await this.makeReady()}async onNotReady(){await this.resetStore()}async onAction(t){this.matrixClient&&this.initialListsGenerated&&(w.TEST_MODE?await this.onDispatchAsync(t):e(()=>this.onDispatchAsync(t)))}async onDispatchAsync(e){if(this.matrixClient&&this.initialListsGenerated){if("setting_updated"===e.action&&this.watchedSettings.includes(e.settingName)){if("advancedRoomListLogging"===e.settingName){const e=i.a.getValue("advancedRoomListLogging");return void console.warn("Advanced room list logging is enabled? "+e)}console.log("Regenerating room lists: Settings changed"),await this.readAndCacheSettingsFromStore(),await this.regenerateAllLists({trigger:!1}),this.updateFn.trigger()}if(!this.algorithm)throw new Error("Room list store has no algorithm to process dispatcher update with");if("MatrixActions.Room.receipt"===e.action){if(Object(c.a)(e.event,this.matrixClient)){const t=e.room;return t?(i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got own read receipt in "+t.roomId),await this.handleRoomUpdate(t,o.c.ReadReceipt),void this.updateFn.trigger()):void console.warn("Own read receipt was in unknown room "+t.roomId)}}else if("MatrixActions.Room.tags"===e.action){const t=e;i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got tag change in "+t.room.roomId),await this.handleRoomUpdate(t.room,o.c.PossibleTagChange),this.updateFn.trigger()}else if("MatrixActions.Room.timeline"===e.action){const t=e;if(!t.isLiveEvent||!e.isLiveUnfilteredRoomTimelineEvent)return;const s=t.event.getRoomId(),n=this.matrixClient.getRoom(s),a=async e=>{if(i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Live timeline event "+t.event.getId()+" in "+e.roomId),"m.room.tombstone"===t.event.getType()&&""===t.event.getStateKey()){i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Got tombstone event - trying to remove now-dead room");if(this.matrixClient.getRoom(t.event.getContent().replacement_room))return}await this.handleRoomUpdate(e,o.c.Timeline),this.updateFn.trigger()};if(!n)return console.warn(`Live timeline event ${t.event.getId()} received without associated room`),console.warn("Queuing failed room update for retry as a result."),void setTimeout(async()=>{const e=this.matrixClient.getRoom(s);await a(e)},100);await a(n)}else if("MatrixActions.Event.decrypted"===e.action){const t=e,s=t.event.getRoomId(),n=this.matrixClient.getRoom(s);if(!n)return void console.warn(`Event ${t.event.getId()} was decrypted in an unknown room ${s}`);i.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Decrypted timeline event ${t.event.getId()} in ${s}`),await this.handleRoomUpdate(n,o.c.Timeline),this.updateFn.trigger()}else if("MatrixActions.accountData"===e.action&&"m.direct"===e.event_type){const t=e;i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Received updated DM map");const s=t.event.getContent();for(const e of Object.keys(s)){const t=s[e];for(const e of t){const t=this.matrixClient.getRoom(e);t?await this.handleRoomUpdate(t,o.c.PossibleTagChange):console.warn(e+" was found in DMs but the room is not in the store")}}this.updateFn.trigger()}else if("MatrixActions.Room.myMembership"===e.action){const t=e,s=Object(p.b)(t.oldMembership),n=Object(p.b)(t.membership);if(s!==p.a.Join&&n===p.a.Join){i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling new room "+t.room.roomId);const e=t.room.currentState.getStateEvents("m.room.create","");if(e&&e.getContent().predecessor){i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Room has a predecessor");const t=this.matrixClient.getRoom(e.getContent().predecessor.room_id);if(t){this.algorithm.stickyRoom===t&&(i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Clearing sticky room due to room upgrade"),await this.algorithm.setStickyRoom(null)),i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Removing previous room from room list"),await this.algorithm.handleRoomUpdate(t,o.c.RoomRemoved)}}return i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Adding new room to room list"),await this.handleRoomUpdate(t.room,o.c.NewRoom),void this.updateFn.trigger()}if(s!==p.a.Invite&&n===p.a.Invite)return i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling invite to "+t.room.roomId),await this.handleRoomUpdate(t.room,o.c.NewRoom),void this.updateFn.trigger();if(s!==n)return i.a.getValue("advancedRoomListLogging")&&console.log("[RoomListDebug] Handling membership change in "+t.room.roomId),await this.handleRoomUpdate(t.room,o.c.PossibleTagChange),void this.updateFn.trigger()}}}async handleRoomUpdate(e,t){if(!E.a.instance.isRoomVisible(e))return;await this.algorithm.handleRoomUpdate(e,t)&&(i.a.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] Room "${e.name}" (${e.roomId}) triggered by ${t} requires list update`),this.updateFn.mark())}async setTagSorting(e,t){await this.setAndPersistTagSorting(e,t),this.updateFn.trigger()}async setAndPersistTagSorting(e,t){await this.algorithm.setTagSorting(e,t),localStorage.setItem("mx_tagSort_"+e,t)}getTagSorting(e){return this.algorithm.getTagSorting(e)}getStoredTagSorting(e){return localStorage.getItem("mx_tagSort_"+e)}calculateTagSorting(e){const t=e===o.a.Invite||e===o.a.DM?r.b.Recent:r.b.Alphabetic,s=i.a.getValue("RoomList.orderAlphabetically",null,!0),n=this.getTagSorting(e),a=this.getStoredTagSorting(e);let l=t;return a?l=a:Object(g.r)(s)?n&&(l=n):l=s?r.b.Alphabetic:r.b.Recent,l}async setListOrder(e,t){await this.setAndPersistListOrder(e,t),this.updateFn.trigger()}async setAndPersistListOrder(e,t){await this.algorithm.setListOrdering(e,t),localStorage.setItem("mx_listOrder_"+e,t)}getListOrder(e){return this.algorithm.getListOrdering(e)}getStoredListOrder(e){return localStorage.getItem("mx_listOrder_"+e)}calculateListOrder(e){const t=r.a.Natural,s=i.a.getValue("RoomList.orderByImportance",null,!0),n=this.getListOrder(e),a=this.getStoredListOrder(e);let o=t;return a?o=a:Object(g.r)(s)?n&&(o=n):o=s?r.a.Importance:r.a.Natural,o}async updateAlgorithmInstances(){this.updateFn.mark();for(const e of Object.keys(this.orderedLists)){const t=this.getTagSorting(e),s=this.getListOrder(e),n=this.calculateTagSorting(e),a=this.calculateListOrder(e);n!==t&&await this.setAndPersistTagSorting(e,n),a!==s&&await this.setAndPersistListOrder(e,a)}}async regenerateAllLists({trigger:e=!0}){console.warn("Regenerating all room lists");const t=this.matrixClient.getVisibleRooms().filter(e=>E.a.instance.isRoomVisible(e)),s=new Set;if(this.state.tagsEnabled)for(const e of t){if(!e.tags)continue;Object.keys(e.tags).filter(e=>Object(o.d)(e)).forEach(e=>s.add(e))}const n={},a={},i=[...o.b,...Array.from(s)];for(const e of i)n[e]=this.calculateTagSorting(e),a[e]=this.calculateListOrder(e),f.a.instance.ensureLayoutExists(e);await this.algorithm.populateTags(n,a),await this.algorithm.setKnownRooms(t),this.initialListsGenerated=!0,e&&this.updateFn.trigger()}addFilter(e){i.a.getValue("advancedRoomListLogging")&&console.log("Adding filter condition:",e),this.filterConditions.push(e),this.algorithm&&this.algorithm.addFilterCondition(e),this.updateFn.trigger()}removeFilter(e){i.a.getValue("advancedRoomListLogging")&&console.log("Removing filter condition:",e);const t=this.filterConditions.indexOf(e);t>=0&&(this.filterConditions.splice(t,1),this.algorithm&&this.algorithm.removeFilterCondition(e)),this.updateFn.trigger()}getFirstNameFilterCondition(){for(const e of this.filterConditions)if(e instanceof _.a)return e;return null}getTagsForRoom(e){const t=this.algorithm.getTagsForRoom(e);return t||[o.a.Untagged]}}a()(w,"TEST_MODE",!1);class S{static get instance(){return S.internalInstance||(S.internalInstance=new w),S.internalInstance}}a()(S,"internalInstance",void 0),window.mxRoomListStore=S.instance}).call(this,s(167).setImmediate)},function(e,t,s){"use strict";s.d(t,"b",(function(){return v})),s.d(t,"d",(function(){return _})),s.d(t,"a",(function(){return y})),s.d(t,"c",(function(){return E})),s.d(t,"e",(function(){return C}));var n,a,i=s(86),o=s(89),r=s(85),l=s(83),c=s(87),d=s(282),m=s(109),h=s(242),u=s(283),p=s(114),g=s(105),f=s(171),b=s(369);function v(e){void 0===(e=e||{}).spinner&&(e.spinner=!0),void 0===e.guestAccess&&(e.guestAccess=!0),void 0===e.encryption&&(e.encryption=!1);const t=g.a.getTimestamp(),s=r.getComponent("dialogs.ErrorDialog"),m=r.getComponent("elements.Spinner"),u=i.a.get();if(u.isGuest())return c.a.dispatch({action:"require_registration"}),Promise.resolve(null);const f=e.dmUserId?a.TrustedPrivateChat:a.PrivateChat,v=e.createOpts||{};if(v.preset=v.preset||f,v.visibility=v.visibility||n.Private,e.dmUserId&&void 0===v.invite)switch(Object(h.c)(e.dmUserId)){case"mx-user-id":v.invite=[e.dmUserId];break;case"email":v.invite_3pid=[{id_server:i.a.get().getIdentityServerUrl(!0),medium:"email",address:e.dmUserId}]}let _,y,E;if(e.dmUserId&&void 0===v.is_direct&&(v.is_direct=!0),void 0===e.andView&&(e.andView=!0),e.access_rules&&(v.access_rules=e.access_rules),v.name){_=v.name.replace(/[^a-z0-9]/gi,"")+Object(b.b)(11)}else _=Object(b.b)(11);return"private"!==v.visibility&&(v.room_alias_name=_),v.initial_state=v.initial_state||[{content:{guest_access:"forbidden"},type:"m.room.guest_access",state_key:""},{content:{history_visibility:"private"===v.visibility?"invited":"world_readable"},type:"m.room.history_visibility",state_key:""},{content:{rule:v.access_rules?v.access_rules:"restricted"},type:"im.vector.room.access_rules",state_key:""}],e.encryption&&v.initial_state.push({type:"m.room.encryption",state_key:"",content:{algorithm:"m.megolm.v1.aes-sha2"}}),e.spinner&&(y=o.a.createDialog(m,null,"mx_Dialog_spinner")),u.createRoom(v).finally((function(){y&&y.close()})).then((function(t){return E=t.room_id,e.dmUserId?d.c(E,e.dmUserId):Promise.resolve()})).then(()=>{if(e.associatedWithCommunity)return p.a.addRoomToGroup(e.associatedWithCommunity,E,!1)}).then((function(){return e.andView&&c.a.dispatch({action:"view_room",room_id:E,should_peek:!1,joining:!0}),g.a.instance.trackRoomCreate(t,E),E}),(function(t){if(e.inlineErrors)throw t;c.a.dispatch({action:"join_room_error"}),console.error("Failed to create room "+E+" "+t);let n=Object(l.a)("Server may be unavailable, overloaded, or you hit a bug.");return"M_UNSUPPORTED_ROOM_VERSION"===t.errcode&&(n=Object(l.a)("The server does not support the room version specified.")),o.a.createTrackedDialog("Failure to create room","",s,{title:Object(l.a)("Failure to create room"),description:n}),null}))}function _(e,t){const s=m.a.shared().getDMRoomsForUserId(t).map(t=>e.getRoom(t)).filter(e=>{if(e&&"join"===e.getMyMembership()){const s=e.currentState.getMembers().filter(e=>Object(f.c)(e.membership));return s.find(e=>e.userId===t)&&2===s.length}return!1}).sort((e,t)=>t.getLastActiveTimestamp()-e.getLastActiveTimestamp());if(s.length)return s[0]}async function y(e,t){try{const s=await e.downloadKeys(t);return Object.values(s).every(e=>Object.keys(e).length>0)}catch(e){return console.error("Error determining if it's possible to encrypt to all users: ",e),!1}}async function E(e,t){const s=_(e,t);let n;if(s)n=s.roomId;else{let s=void 0;C()&&(s=await y(e,[t])),n=await v({encryption:s,dmUserId:t,spinner:!1,andView:!1}),await async function(e,t,s,n={timeout:1500}){const{timeout:a}=n;let i;return new Promise(n=>{i=function(e,a,i){i.userId===s&&i.roomId===t&&n(!0)},e.on("RoomState.newMember",i),setTimeout(n,a,!1)}).finally(()=>{e.removeListener("RoomState.newMember",i)})}(e,n,t)}return n}function C(){const e=Object(u.b)();if(e){return!(!1===e.default)}return!0}!function(e){e.Public="public",e.Private="private"}(n||(n={})),function(e){e.PrivateChat="private_chat",e.TrustedPrivateChat="trusted_private_chat",e.PublicChat="public_chat"}(a||(a={}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"f",(function(){return i})),s.d(t,"e",(function(){return o})),s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return l})),s.d(t,"a",(function(){return c}));var n=s(120);function a(e,t){const s=new Map(Object.entries(e));for(const e of t)s.delete(e);return Array.from(s.entries()).reduce((e,[t,s])=>(e[t]=s,e),{})}function i(e,t){const s=Object.keys(e),i=Object(n.b)(s,t);return 0===i.removed.length?o(e):a(e,i.removed)}function o(e,t){const s={};for(const[n,a]of Object.entries(e))s[n]=a,t&&(s[n]=t(n,a));return s}function r(e,t){const s=Object.keys(e),a=Object.keys(t);if(Object(n.d)(s,a))return!0;return Object(n.g)(s,a).some(s=>e[s]!==t[s])}function l(e,t){const s=function(e,t){const s=Object.keys(e),a=Object.keys(t),i=Object(n.b)(s,a);return{changed:Object(n.g)(s,a).filter(s=>e[s]!==t[s]),added:i.added,removed:i.removed}}(e,t);return Object(n.f)(s.removed,s.added,s.changed)}function c(e){return JSON.parse(JSON.stringify(e))}},function(e,t,s){"use strict";s.d(t,"c",(function(){return a})),s.d(t,"d",(function(){return i})),s.d(t,"a",(function(){return o})),s.d(t,"e",(function(){return r})),s.d(t,"f",(function(){return l})),s.d(t,"b",(function(){return c}));var n=s(83);function a(e){return e<1e3?e.toString():e<1e4?(e/1e3).toFixed(1)+"K":e<1e5?(e/1e3).toFixed(0)+"K":e<1e7?(e/1e6).toFixed(1)+"M":e<1e8?(e/1e6).toFixed(0)+"M":(e/1e9).toFixed(1)+"B"}function i(e){return(new Intl.NumberFormat).format(e)}function o(e,t=2){if(0===e)return"0 Bytes";const s=t<0?0:t,n=Math.floor(Math.log(e)/Math.log(1024));return parseFloat((e/Math.pow(1024,n)).toFixed(s))+" "+["Bytes","KB","MB","GB","TB","PB","EB","ZB","YB"][n]}function r(e){return e.match(/.{1,4}/g).join(" ")}function l(e){return"mx_Username_color"+(function(e){let t,s,n=0;if(0===e.length)return n;for(t=0;t<e.length;t++)s=e.charCodeAt(t),n=(n<<5)-n+s,n|=0;return Math.abs(n)}(e)%8+1)}function c(e,t){e=e.map(e=>e&&e.includes("] (@")?e.split(" (@")[0]:e);const s=void 0===t?0:Math.max(e.length-t,0);if(0===e.length)return"";if(1===e.length)return e[0];if(s>0)return e=e.slice(0,t),Object(n.a)("%(items)s and %(count)s others",{items:e.join(", "),count:s});{const t=e.pop();return Object(n.a)("%(items)s and %(lastItem)s",{items:e.join(", "),lastItem:t})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y})),s.d(t,"i",(function(){return E})),s.d(t,"g",(function(){return C})),s.d(t,"f",(function(){return w})),s.d(t,"e",(function(){return S})),s.d(t,"h",(function(){return x})),s.d(t,"c",(function(){return R})),s.d(t,"b",(function(){return O})),s.d(t,"d",(function(){return k}));var n=s(81),a=s.n(n),i=s(86),o=s(335),r=s(89),l=s(85),c=s(83),d=s(336),m=s(615),h=s(157),u=s(82),p=s.n(u),g=s(84),f=s.n(g),b=s(98),v=s(195);class _ extends a.a.Component{constructor(e){super(e),p()(this,"onCancel",()=>{this.props.onFinished(!1)}),p()(this,"onInvite",()=>{console.error("INVITED")}),this._handleFileRead=this._handleFileRead.bind(this),this._parseFile=this._parseFile.bind(this),this.state={error:null,errorRestricted:!1,list:[],listSize:0,fileReader:new FileReader,processingIndex:0,fileType:null,type:"",authorizedTypeTxt:["text/plain"],authorizedTypeCsv:["text/csv","text/x-csv","application/vnd.ms-excel","application/csv","application/x-csv"],authorizedTypeString:".txt, .csv"}}_handleFileRead(){const e=this.state.fileReader,t=this.state.fileType,s=this.state.authorizedTypeTxt,n=this.state.authorizedTypeCsv,o=i.a.get().getRoom(this.props.roomId),r=b.a.getAccessRules(this.props.roomId);let l=e.result,d=null;if(console.error("list"),console.error(l),s.includes(t))if(l.includes("<")&&l.includes(">")){this.setState({type:"Outlook"});let e=null;l=l.replace(/(\r\n|\n|\r)/gm,""),l=l.replaceAll("<"," "),l=l.replaceAll(">"," "),l=l.replaceAll(";"," "),e=l.split(" ").filter(Boolean),d=e.filter(e=>v.a(e))}else this.setState({type:"Txt"}),l=l.replace(/(\r\n|\n|\r)/gm,""),l=l.replace(/\s/gm,""),d=l.split(";").filter(Boolean);else{if(!n.includes(t))return;this.setState({type:"Csv"}),l=l.replace(/(\r)/gm,""),l=l.replace(/(\r\n|\n)/gm,";"),l=l.replace(/\s/gm,""),d=l.split(";").filter(Boolean)}console.error("addresses"),console.error(d),this.setState({listSize:d.length});for(let e of d)if(e){if(!v.a(e)){let t=this.state.processingIndex+1;return void this.setState({error:a.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("This file contains at least one invalid email address : %(address)s.",{address:e})),list:[],processingIndex:t})}"restricted"===r?b.a.getHSInfoFromEmail(e).then(t=>{if(b.a.isUserExternFromServerHostname(t.hs)){let e=this.state.processingIndex+1;this.setState({errorRestricted:!0,processingIndex:e})}else b.a.lookupThreePid("email",e).then(t=>{const s=o.getMember(t.mxid),n=t.mxid?t.mxid:e;let a=this.state.processingIndex+1;if(null===s||!s.membership||"leave"===s.membership){let e=this.state.list;e.push(n),this.setState({list:e})}this.setState({processingIndex:a})})}):b.a.lookupThreePid("email",e).then(t=>{const s=o.getMember(t.mxid),n=t.mxid?t.mxid:e;let a=this.state.processingIndex+1;if(null===s||!s.membership||"leave"===s.membership){let e=this.state.list;e.push(n),this.setState({list:e})}this.setState({processingIndex:a})})}}_parseFile(e){const t=this.state.authorizedTypeTxt.concat(this.state.authorizedTypeCsv);if(this.setState({error:null,errorRestricted:!1,list:[],processingIndex:0,fileType:null}),t.includes(e.type))if(e.size>25e3)this.setState({error:a.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("Error : File too large (max 25 kB)."))});else{const t=this.state.fileReader;this.setState({fileType:e.type}),t.onloadend=this._handleFileRead,t.readAsText(e)}else this.setState({error:a.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(c.a)("Error : Invalid file format."))})}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("views.elements.DialogButtons");let s=null;if(this.props.roomId){const e="unrestricted"!==b.a.getAccessRules(this.props.roomId)?Object(c.a)("Externals aren't allowed to join this room"):Object(c.a)("Externals are allowed to join this room");s=a.a.createElement("label",null,e)}const n=this.state.list?this.state.list.length:0,i=this.state.error,o=this.state.processingIndex,r=this.state.listSize,d=this.state.type,m=this.state.authorizedTypeString;let h=null;return this.state.errorRestricted&&!i&&(h=a.a.createElement("div",{className:"mx_AddressPickerDialog_warning"},Object(c.a)("Some users are extern. This room is restricted. They will not be invited."))),a.a.createElement(e,{className:"mx_AddressPickerDialog",onFinished:this.props.onFinished,title:this.props.title},a.a.createElement("div",{className:"mx_AddressPickerDialog_label"},a.a.createElement("label",{htmlFor:"import-file"},Object(c.a)("Supported formats :"),a.a.createElement("ul",null,a.a.createElement("li",null,Object(c.a)('.txt with email addresses separated by " ; "')),a.a.createElement("li",null,Object(c.a)('.txt with outlook format email (i.e. "Firstname Name <firstname.name@email.com>;")')),a.a.createElement("li",null,Object(c.a)(".csv with email addresses separated by lines break")))),a.a.createElement("br",null),s),a.a.createElement("div",{className:"mx_Dialog_content"},i,h,a.a.createElement("br",null),a.a.createElement("input",{type:"file",id:"import-file",accept:m,onChange:e=>this._parseFile(e.target.files[0])}),a.a.createElement("span",{className:"tc_InviteDialog_InviteFromFile_type"},"Type : ",d)),a.a.createElement(t,{primaryButton:Object(c.a)("Send %(number)s invites",{number:n}),onPrimaryButtonClick:this.onInvite,primaryDisabled:!!i||0===o||o!==r,onCancel:this.onCancel}))}}function y(e,t){const s=new o.a(e);return s.invite(t).then(e=>Promise.resolve({states:e,inviter:s}))}function E(e){const t=l.getComponent("dialogs.InviteDialog");r.a.createTrackedDialog("Start DM","",t,{kind:d.b,initialText:e},null,!1,!0)}function C(e){const t=l.getComponent("dialogs.InviteDialog");r.a.createTrackedDialog("Invite Users","",t,{kind:d.c,roomId:e},null,!1,!0)}function w(e,t){r.a.createTrackedDialog("Invite Users to Community","",m.a,{communityName:t,roomId:e},null,!1,!0)}function S(e){const t=h.a.instance.getGeneralChat(e);if(!t)throw new Error("Failed to locate appropriate room to start an invite in");{const s=h.a.instance.getCommunityName(e);w(t.roomId,s)}}function x(e){r.a.createTrackedDialog("Room Invite From File","",_,{title:Object(c.a)("Invite new room members from a file"),roomId:e,onFinished:(t,s)=>{if(t)if(!s||s.length<=0){const e=l.getComponent("dialogs.ErrorDialog");r.a.createTrackedDialog("Failed to invite users to the room","",e,{title:Object(c.a)("Failed to invite users to the room:",{roomName:""}),description:Object(c.a)("Invalid Email Address")})}else O(e,s).then().catch(e=>{console.error("Failed to invite user to the room"),console.error(e)})}})}function R(e){if(!e||"m.room.third_party_invite"!==e.getType())return!1;const t=["key_validity_url","public_key","display_name"];for(let s=0;s<t.length;++s)if(!e.getContent()[t[s]])return!1;return!0}function O(e,t){return y(e,t).then(t=>{const s=i.a.get().getRoom(e);k(t.states,s,t.inviter)}).catch(e=>{console.error(e.stack);const t=l.getComponent("dialogs.ErrorDialog");r.a.createTrackedDialog("Failed to invite","",t,{title:Object(c.a)("Failed to invite"),description:e&&e.message?e.message:Object(c.a)("Operation failed")})})}function k(e,t,s){const n=Object.keys(e).filter(t=>"error"===e[t]);if(1===n.length&&s.fatal){const e=l.getComponent("dialogs.ErrorDialog");return r.a.createTrackedDialog("Failed to invite users to the room","",e,{title:Object(c.a)("Failed to invite users to the room:",{roomName:t.name}),description:s.getErrorText(n[0])}),!1}{const i=[];for(const t of n)if("error"===e[t]){const e=s.getErrorText(t);i.push(t+": "+e)}if(i.length>0){const e=a.a.createElement("div",null,i.map(e=>a.a.createElement("div",{key:e},e))),s=l.getComponent("dialogs.ErrorDialog");return r.a.createTrackedDialog("Failed to invite the following users to the room","",s,{title:Object(c.a)("Failed to invite the following users to the %(roomName)s room:",{roomName:t.name}),description:e}),!1}}return!0}p()(_,"propTypes",{title:f.a.string.isRequired,roomId:f.a.string,button:f.a.string,onFinished:f.a.func.isRequired})},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(147),o=s(87),r=s(171),l=s(88),c=s(1),d=s(113),m=s(148),h=s(181),u=s(114);class p extends i.a{constructor(){super(o.a,{})}static get instance(){return p.internalInstance}static getUpdateEventName(e){return`${d.b}:${e}`}getSelectedCommunityId(){return l.a.getValue("feature_communities_v2_prototypes")?h.a.getSelectedTags()[0]:null}getSelectedCommunityName(){return p.instance.getCommunityName(this.getSelectedCommunityId())}getSelectedCommunityGeneralChat(){const e=this.getSelectedCommunityId();if(e)return this.getGeneralChat(e)}getCommunityName(e){const t=m.a.getGroupProfileCachedFast(this.matrixClient,e);return(null==t?void 0:t.name)||e}getCommunityProfile(e){return m.a.getGroupProfileCachedFast(this.matrixClient,e)}getGeneralChat(e){const t=u.a.getGroupRooms(e).map(e=>this.matrixClient.getRoom(e.roomId)).filter(e=>!!e);let s=t.find(t=>{const s=t.currentState.getStateEvents("im.vector.general_chat","");return!(!s||s.getContent().groupId!==e)});return s||(s=t[0]),s}isAdminOf(e){const t=u.a.getGroupMembers(e).find(e=>e.userId===this.matrixClient.getUserId());return null==t?void 0:t.isPrivileged}canInviteTo(e){const t=this.getGeneralChat(e);if(!t)return this.isAdminOf(e);const s=t.getMember(this.matrixClient.getUserId());if(!s)return this.isAdminOf(e);const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return this.isAdminOf(e);return(Object(c.r)(n.invite)?50:Number(n.invite))<=s.powerLevel}async onAction(e){if(this.matrixClient&&l.a.getValue("feature_communities_v2_prototypes"))if("MatrixActions.Room.myMembership"===e.action){const t=e.room,s=Object(r.b)(e.membership);if(s===Object(r.b)(e.oldMembership))return;if(s===r.a.Invite)try{const e=c.j("/rooms/$roomId/group_info",{$roomId:t.roomId}),s=await this.matrixClient._http.authedRequest(void 0,"GET",e,void 0,void 0,{prefix:"/_matrix/client/unstable/im.vector.custom"});await this.matrixClient.setAccountData("im.vector.group_info."+t.roomId,s)}catch(e){console.warn("Non-fatal error getting group information for invite:",e)}}else if("MatrixActions.accountData"===e.action){if(e.event_type.startsWith("im.vector.group_info.")){const t=e.event_type.substring("im.vector.group_info.".length);this.emit(p.getUpdateEventName(t),t)}}else if("select_tag"===e.action){const t=this.getGeneralChat(e.tag);t&&o.a.dispatch({action:"view_room",room_id:t.roomId})}}getInviteProfile(e){if(!this.matrixClient)return{displayName:null,avatarMxc:null};const t=this.matrixClient.getRoom(e);if(l.a.getValue("feature_communities_v2_prototypes")){const t=this.matrixClient.getAccountData("im.vector.group_info."+e);if(t&&t.getContent())return{displayName:t.getContent().name,avatarMxc:t.getContent().avatar_url}}return{displayName:t.name,avatarMxc:t.avatar_url}}async onReady(){for(const e of this.matrixClient.getRooms()){const t=e.currentState.getMembers().find(e=>e.userId===this.matrixClient.getUserId());t&&(Object(r.b)(t.membership)===r.a.Invite&&this.emit(p.getUpdateEventName(e.roomId),e.roomId))}}}a()(p,"internalInstance",new p)},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(450);t.a=({description:e,acceptLabel:t,rejectLabel:s,onAccept:n,onReject:o})=>a.a.createElement("div",null,a.a.createElement("div",{className:"mx_Toast_description"},e),a.a.createElement("div",{className:"mx_Toast_buttons","aria-live":"off"},o&&s&&a.a.createElement(i.a,{label:s,kind:"danger",onClick:o}),a.a.createElement(i.a,{label:t,onClick:n})))},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{getValueOverride(e,t,s,n){return null}onChange(e,t,s){}get settingDisabled(){return!1}}},function(e,t){e.exports="img/warning.05cc423.svg"},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(81),a=s.n(n),i=s(90),o=s.n(i);function r({description:e,hideDescriptionIfValid:t,deriveData:s,rules:n}){return async function({value:i,focused:r,allowEmpty:l=!0}){if(!i&&l)return{valid:null,feedback:null};const c={value:i,allowEmpty:l},d=s?await s(c):void 0,m=[];let h,u,p,g=!0;if(n&&n.length)for(const e of n){if(!e.key||!e.test)continue;if(!g&&e.final)continue;if(e.skip&&e.skip.call(this,c,d))continue;const t=await e.test.call(this,c,d);if(g=g&&t,t&&e.valid){const t=e.valid.call(this,d);if(!t)continue;m.push({key:e.key,valid:!0,text:t})}else if(!t&&e.invalid){const t=e.invalid.call(this,d);if(!t)continue;m.push({key:e.key,valid:!1,text:t})}}if(!r)return{valid:g,feedback:null};if(m&&m.length&&(h=a.a.createElement("ul",{className:"mx_Validation_details"},m.map(e=>{const t=o()({mx_Validation_detail:!0,mx_Validation_valid:e.valid,mx_Validation_invalid:!e.valid});return a.a.createElement("li",{key:e.key,className:t},e.text)}))),e&&(h||!t)){const t=e.call(this,d);u=a.a.createElement("div",{className:"mx_Validation_description"},t)}return(u||h)&&(p=a.a.createElement("div",{className:"mx_Validation"},u,h)),{valid:g,feedback:p}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(82),a=s.n(n),i=s(92),o=s(89),r=s(112),l=s.n(r),c=s(88),d=s(285),m=s(86),h=s(261),u=s.n(h),p=s(95);s(132);class g{constructor(e,t){this.apiUrl=e,this.uiUrl=t,this.scalarToken=null,this.termsInteractionCallback=void 0;const s=i.a.get().integrations_rest_url,n=i.a.get().integrations_ui_url;this.isDefaultManager=e===s&&n===t}_writeTokenToStore(){window.localStorage.setItem("mx_scalar_token_at_"+this.apiUrl,this.scalarToken),this.isDefaultManager&&window.localStorage.removeItem("mx_scalar_token")}_readTokenFromStore(){let e=window.localStorage.getItem("mx_scalar_token_at_"+this.apiUrl);return!e&&this.isDefaultManager&&(e=window.localStorage.getItem("mx_scalar_token")),e}_readToken(){return this.scalarToken?this.scalarToken:this._readTokenFromStore()}setTermsInteractionCallback(e){this.termsInteractionCallback=e}connect(){return this.getScalarToken().then(e=>{this.scalarToken=e})}hasCredentials(){return null!=this.scalarToken}getScalarToken(){const e=this._readToken();return e?this._checkToken(e).catch(e=>{if(e instanceof d.b)throw e;return this.registerForToken()}):this.registerForToken()}_getAccountName(e){const t=this.apiUrl+"/account";return new Promise((function(s,n){u()({method:"GET",uri:t,qs:{scalar_token:e,v:"1.1"},json:!0},(e,t,a)=>{e?n(e):a&&"M_TERMS_NOT_SIGNED"===a.errcode?n(new d.b):t.statusCode/100!=2?n(a):a&&a.user_id?s(a.user_id):n(new Error("Missing user_id in response"))})}))}_checkToken(e){return this._getAccountName(e).then(t=>{const s=m.a.get().getUserId();if(t!==s)throw new Error("Scalar token is owned by someone else: "+s);return e}).catch(t=>{if(t instanceof d.b){console.log("Integration manager requires new terms to be agreed to");const t=l.a.parse(this.apiUrl);return t.path="",t.pathname="",Object(d.d)([new d.a(p.m.IM,t.format(),e)],this.termsInteractionCallback).then(()=>e)}throw t})}registerForToken(){return m.a.get().getOpenIdToken().then(e=>this.exchangeForScalarToken(e)).then(e=>this._checkToken(e)).then(e=>(this.scalarToken=e,this._writeTokenToStore(),e))}exchangeForScalarToken(e){const t=this.apiUrl;return new Promise((function(s,n){u()({method:"POST",uri:t+"/register",qs:{v:"1.1"},body:e,json:!0},(e,t,a)=>{e?n(e):t.statusCode/100!=2?n({statusCode:t.statusCode}):a&&a.scalar_token?s(a.scalar_token):n(new Error("Missing scalar_token in response"))})}))}getScalarPageTitle(e){let t=this.apiUrl+"/widgets/title_lookup";return t=this.getStarterLink(t),t+="&curl="+encodeURIComponent(e),new Promise((function(e,s){u()({method:"GET",uri:t,json:!0},(t,n,a)=>{if(t)s(t);else if(n.statusCode/100!=2)s({statusCode:n.statusCode});else if(a){let t="";a.page_title_cache_item&&a.page_title_cache_item.cached_title&&(t=a.page_title_cache_item.cached_title),e(t)}else s(new Error("Missing page title in response"))})}))}disableWidgetAssets(e,t){let s=this.apiUrl+"/widgets/set_assets_state";return s=this.getStarterLink(s),new Promise((n,a)=>{u()({method:"GET",uri:s,json:!0,qs:{widget_type:e.preferred,widget_id:t,state:"disable"}},(e,t,s)=>{e?a(e):t.statusCode/100!=2?a({statusCode:t.statusCode}):s?n():a(new Error("Failed to set widget assets state"))})})}getScalarInterfaceUrlForRoom(e,t,s){const n=e.roomId,a=e.name;let i=this.uiUrl;return i+="?scalar_token="+encodeURIComponent(this.scalarToken),i+="&room_id="+encodeURIComponent(n),i+="&room_name="+encodeURIComponent(a),i+="&theme="+encodeURIComponent(c.a.getValue("theme")),s&&(i+="&integ_id="+encodeURIComponent(s)),t&&(i+="&screen="+encodeURIComponent(t)),i}getStarterLink(e){return e+"?scalar_token="+encodeURIComponent(this.scalarToken)}}var f=s(626);let b;!function(e){e.Account="account",e.Config="config",e.Homeserver="homeserver"}(b||(b={}));class v{constructor(e,t,s=t,n){a()(this,"apiUrl",void 0),a()(this,"uiUrl",void 0),a()(this,"kind",void 0),a()(this,"id",void 0),this.kind=e,this.apiUrl=t,this.uiUrl=s,this.id=n}get name(){return l.a.parse(this.uiUrl).host}get trimmedApiUrl(){const e=l.a.parse(this.apiUrl);return e.pathname="",e.path="",l.a.format(e)}getScalarClient(){return new g(this.apiUrl,this.uiUrl)}async open(e=null,t=null,s=null){if(!c.a.getValue("integrationProvisioning"))return S.sharedInstance().showDisabledDialog();const n=o.a.createTrackedDialog("Integration Manager","",f.a,{loading:!0},"mx_IntegrationManager"),a=this.getScalarClient();a.setTermsInteractionCallback((e,t)=>Object(d.c)(e,t,"mx_TermsDialog_forIntegrationManager"));const i={};try{await a.connect(),a.hasCredentials()?i.url=a.getScalarInterfaceUrlForRoom(e,t,s):i.connected=!1}catch(e){if(e instanceof d.b)return void n.close();console.error(e),i.connected=!1}n.close(),o.a.createTrackedDialog("Integration Manager","",f.a,i,"mx_IntegrationManager")}}var _=s(627),y=s(628),E=s(630),C=s(122);const w=[b.Account,b.Homeserver,b.Config];class S{static sharedInstance(){return S.instance||(S.instance=new S),S.instance}constructor(){a()(this,"managers",[]),a()(this,"client",void 0),a()(this,"primaryManager",void 0),a()(this,"setupHomeserverManagers",async e=>{if(console.log("Updating homeserver-configured integration managers..."),e&&e["m.integrations"]){let t=e["m.integrations"].managers;Array.isArray(t)||(t=[]),console.log(`Homeserver has ${t.length} integration managers`),this.managers=this.managers.filter(e=>e.kind!==b.Homeserver);for(const e of t)e.api_url&&this.managers.push(new v(b.Homeserver,e.api_url,e.ui_url));this.primaryManager=null}else console.log("Homeserver has no integration managers")}),a()(this,"onAccountData",e=>{"m.widgets"===e.getType()&&this.compileManagers()}),this.compileManagers()}startWatching(){this.stopWatching(),this.client=m.a.get(),this.client.on("accountData",this.onAccountData),this.client.on("WellKnown.client",this.setupHomeserverManagers),this.compileManagers()}stopWatching(){this.client&&(this.client.removeListener("accountData",this.onAccountData),this.client.removeListener("WellKnown.client",this.setupHomeserverManagers))}compileManagers(){this.managers=[],this.setupConfiguredManager(),this.setupAccountManagers()}setupConfiguredManager(){const e=i.a.get().integrations_rest_url,t=i.a.get().integrations_ui_url;e&&t&&(this.managers.push(new v(b.Config,e,t)),this.primaryManager=null)}setupAccountManagers(){if(!this.client||!this.client.getUserId())return;C.a.getIntegrationManagerWidgets().forEach(e=>{const t=e.content.data;if(!t)return;const s=e.content.url,n=t.api_url;if(!n||!s)return;const a=new v(b.Account,n,s,e.id||e.state_key||"");this.managers.push(a)}),this.primaryManager=null}hasManager(){return this.managers.length>0}getOrderedManagers(){const e=[];for(const t of w){const s=this.managers.filter(e=>e.kind===t);s&&s.length&&(t===b.Account&&s.sort((e,t)=>e.id.localeCompare(t.id)),e.push(...s))}return e}getPrimaryManager(){return this.hasManager()?(this.primaryManager||(this.primaryManager=this.getOrderedManagers()[0]),this.primaryManager):null}openNoManagerDialog(){o.a.createTrackedDialog("Integrations impossible","",_.a)}openAll(e=null,t=null,s=null){return c.a.getValue("integrationProvisioning")?0===this.managers.length?this.openNoManagerDialog():void o.a.createTrackedDialog("Tabbed Integration Manager","",y.a,{room:e,screen:t,integrationId:s},"mx_TabbedIntegrationManagerDialog"):this.showDisabledDialog()}showDisabledDialog(){o.a.createTrackedDialog("Integrations disabled","",E.a)}async overwriteManagerOnAccount(e){await C.a.removeIntegrationManagerWidgets(),await C.a.addIntegrationManagerWidget(e.name,e.uiUrl,e.apiUrl)}async tryDiscoverManager(e){let t;console.log("Looking up integration manager via .well-known"),(e.startsWith("http:")||e.startsWith("https:"))&&(e=l.a.parse(e).host);try{const s=await fetch(`https://${e}/.well-known/matrix/integrations`);t=await s.json()}catch(e){return console.error(e),console.warn("Failed to locate integration manager"),null}if(!t||!t["m.integrations_widget"])return console.warn("Missing integrations widget on .well-known response"),null;const s=t["m.integrations_widget"];if(!s.url||!s.data||!s.data.api_url)return console.warn("Malformed .well-known response for integrations widget"),null;const n=new v(b.Account,s.data.api_url,s.url);return console.log("Got an integration manager (untested)"),n}}a()(S,"instance",void 0),window.mxIntegrationManagers=S},,,,function(e,t,s){"use strict";var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(90),d=s.n(c),m=s(226),h=s(88),u=s(91),p=s(97),g=s(146),f=s(300),b=s(98),v=s(169);const _=(e,t)=>{let s=[];return h.a.getValue("lowBandwidth")||(s=t||[],e&&(s=[e,...s])),Array.from(new Set(s))};t.a=e=>{const{name:t,idName:s,title:n,url:i,urls:c,width:h=48,height:y=48,resizeMethod:E="crop",defaultToInitialLetter:C=!0,onClick:w,inputRef:S,className:x}=e,R=o()(e,["name","idName","title","url","urls","width","height","resizeMethod","defaultToInitialLetter","onClick","inputRef","className"]),[O,k]=(({url:e,urls:t})=>{const[s,n]=Object(r.useState)(_(e,t)),[a,i]=Object(r.useState)(0),o=Object(r.useCallback)(()=>{i(e=>e+1)},[]);Object(r.useEffect)(()=>{n(_(e,t)),i(0)},[e,JSON.stringify(t)]);const l=Object(r.useContext)(p.a),c=Object(r.useCallback)((e,t)=>{"ERROR"!==e&&t!==e&&i(0)},[]);Object(g.a)(l,"sync",c);return[s[a],o]})({url:i,urls:c});let I="mx_BaseAvatar_initial";if(s&&s.startsWith("!")&&(I+=" tc_RoomTile_avatar_hexa"),!O&&C){const e=m.e(t),i=l.a.createElement("span",{className:I,"aria-hidden":"true",style:{fontSize:Object(f.a)(.65*h),width:Object(f.a)(h),lineHeight:Object(f.a)(y)}},e),o=l.a.createElement("img",{className:"mx_BaseAvatar_image",src:m.d(s||t),alt:"",title:n,onError:k,style:{width:Object(f.a)(h),height:Object(f.a)(y)},"aria-hidden":"true"});return w?l.a.createElement(u.a,a()({},R,{element:"span",className:d()("mx_BaseAvatar",x),onClick:w,inputRef:S}),i,o):l.a.createElement("span",a()({className:d()("mx_BaseAvatar",x),ref:S},R,{role:"presentation"}),i,o)}const T=v.a.getUnencryptedContentUrl({url:b.a.imgUrlToUri(O)},!0);return w?l.a.createElement(u.a,a()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",x),element:"img",src:T,onClick:w,onError:k,style:{width:Object(f.a)(h),height:Object(f.a)(y)},title:n,alt:"",inputRef:S},R)):l.a.createElement("img",a()({className:d()("mx_BaseAvatar mx_BaseAvatar_image",x),src:T,onError:k,style:{width:Object(f.a)(h),height:Object(f.a)(y)},title:n,alt:"",ref:S},R))}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return o}));var n=s(86),a=s(503),i=s(368);class o{static generateError(e,t){return{clean:e,error:t}}static async scanContent(t){const s=n.a.get().baseUrl;if(void 0!==t.file){let n,a;try{const e=await fetch(s+i.a.publicKeyUrl);n=(await e.json()).public_key}catch(e){console.warn("Unable to retrieve the publicKey : "+e)}if(n){const s=new e.Olm.PkEncryption;s.set_recipient_key(n),a={encrypted_body:s.encrypt(JSON.stringify({file:t.file}))}}else a={file:t.file};return Promise.resolve(fetch(s+i.a.scanEncryptedUrl,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(a)}).then(e=>e.json()).then(e=>e).catch(e=>{throw console.error(e),this.generateError(!1,"Error: Unable to join the MCS server")}))}if(void 0!==t.url){const e=t.url.split("//")[1];return Promise.resolve(fetch(`${s+i.a.scanUnencryptedUrl}${e}`).then(e=>e.json()).then(e=>e).catch(e=>{throw console.error(e),this.generateError(!1,"Error: Cannot fetch the file")}))}throw this.generateError(!1,"Error: This is not a matrix content")}static getUnencryptedContentUrl(e,t=!1){const s=n.a.get().baseUrl;let a;if(void 0!==e.url){if(t)if(e.info&&e.info.thumbnail_url){const t=e.info.thumbnail_url.split("//")[1];a=`${s+i.a.downloadUnencryptedUrl}${t}`}else{const t=e.url.split("//")[1];a=`${s+i.a.downloadUnencryptedThumbnailUrl}${t}`}else{const t=e.url.split("//")[1];a=`${s+i.a.downloadUnencryptedUrl}${t}`}return a}throw this.generateError(!1,"Error: This is not a matrix content")}static async downloadEncryptedContent(e,t=!1){let s;if(t&&void 0!==e.info.thumbnail_file)s=e.info.thumbnail_file;else{if(void 0===e.file)throw this.generateError(!1,"Error: This is not a matrix content");s=e.file}if(s){const e=await Object(a.a)(s);return e||new Blob([],{type:"application/octet-stream"})}throw this.generateError(!1,"Error: This is not a matrix content")}}}).call(this,s(5))},,function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"e",(function(){return h})),s.d(t,"b",(function(){return u})),s.d(t,"c",(function(){return p})),s.d(t,"d",(function(){return g}));var n=s(86),a=s(83),i=s(89),o=s(140),r=s(81),l=s.n(r),c=s(87),d=s(128);let m;function h(e){const t={[m.Invite]:[],[m.Join]:[],[m.Leave]:[]};for(const s of e)t[u(s.getMyMembership())].push(s);return t}function u(e){return"invite"===e?m.Invite:"join"===e?m.Join:m.Leave}function p(e){const t=u(e);return t===m.Join||t===m.Invite}async function g(e){let t=!0;const s=await n.a.get().getRoomUpgradeHistory(e);if(s&&s.length>0){s[s.length-1].roomId!==e&&(t=!1)}let r={};if(t)r=await n.a.get().leaveRoomChain(e);else try{await n.a.get().leave(e)}catch(t){if(t&&t.data&&t.data.errcode){const s=t.data.error||Object(a.a)("Unexpected server error trying to leave the room");r[e]=Object.assign(new Error(s),{errcode:t.data.errcode})}else r[e]=t||new Error("Failed to leave room for unknown causes")}const m=Object.entries(r).filter(e=>!!e[1]);if(m.length>0){const t=[];for(const s of m){const n=s[1];let c=Object(a.a)("Unexpected server error trying to leave the room");if(n.errcode&&n.message){if("M_CANNOT_LEAVE_SERVER_NOTICE_ROOM"===n.errcode)return void i.a.createTrackedDialog("Error Leaving Room","",o.a,{title:Object(a.a)("Can't leave Server Notices room"),description:Object(a.a)("This room is used for important messages from the Homeserver, so you cannot leave it.")});c=r[e].message}t.push(c,l.a.createElement("BR"))}i.a.createTrackedDialog("Error Leaving Room","",o.a,{title:Object(a.a)("Error leaving room"),description:t})}else d.a.getRoomId()===e&&c.a.dispatch({action:"view_home_page"})}!function(e){e.Join="JOIN",e.Invite="INVITE",e.Leave="LEAVE"}(m||(m={}))},,function(e,t,s){"use strict";s.d(t,"c",(function(){return f})),s.d(t,"a",(function(){return b})),s.d(t,"b",(function(){return v})),s.d(t,"d",(function(){return _}));var n=s(82),a=s.n(n),i=s(88),o=s(197),r=s(132),l=s(638),c=s(87),d=s(506),m=s(96),h=s(120),u=s(113);function p(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function g(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?p(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):p(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const f="io.element.widgets.layout";let b;!function(e){e.Top="top",e.Right="right"}(b||(b={}));const v=3;class _ extends d.a{constructor(){super(c.a),a()(this,"byRoom",{}),a()(this,"pinnedRef",void 0),a()(this,"layoutRef",void 0),a()(this,"updateAllRooms",()=>{this.byRoom={};for(const e of this.matrixClient.getVisibleRooms())this.recalculateRoom(e)}),a()(this,"updateFromWidgetStore",e=>{if(e){const t=this.matrixClient.getRoom(e);t&&this.recalculateRoom(t)}else this.updateAllRooms()}),a()(this,"updateRoomFromState",e=>{if(e.getType()!==f)return;const t=this.matrixClient.getRoom(e.getRoomId());t&&this.recalculateRoom(t)}),a()(this,"updateFromSettings",(e,t)=>{if(t){const e=this.matrixClient.getRoom(t);e&&this.recalculateRoom(e)}else this.updateAllRooms()})}static get instance(){return _.internalInstance||(_.internalInstance=new _),_.internalInstance}static emissionForRoom(e){return"update_"+e.roomId}emitFor(e){this.emit(_.emissionForRoom(e))}async onReady(){this.updateAllRooms(),this.matrixClient.on("RoomState.events",this.updateRoomFromState),this.pinnedRef=i.a.watchSetting("Widgets.pinned",null,this.updateFromSettings),this.layoutRef=i.a.watchSetting("Widgets.layout",null,this.updateFromSettings),o.a.instance.on(u.b,this.updateFromWidgetStore)}async onNotReady(){this.byRoom={},i.a.unwatchSetting(this.pinnedRef),i.a.unwatchSetting(this.layoutRef),o.a.instance.off(u.b,this.updateFromWidgetStore)}recalculateRoom(e){const t=o.a.instance.getApps(e.roomId);if(null==t||!t.length)return this.byRoom[e.roomId]={},void this.emitFor(e);const s=JSON.stringify(this.byRoom[e.roomId]),n=e.currentState.getStateEvents(f,""),a=i.a.getValue("Widgets.pinned",e.roomId);let c=i.a.getValue("Widgets.layout",e.roomId);n&&c&&c.overrides!==n.getId()&&(c=null);const d=n?n.getContent():null,m=[],h=[];for(const e of t){var u,p,g,_,y;const t=null==d||null===(u=d.widgets)||void 0===u||null===(p=u[e.id])||void 0===p?void 0:p.container,s=null===(g=c)||void 0===g||null===(_=g.widgets)||void 0===_||null===(y=_[e.id])||void 0===y?void 0:y.container,n=!(null==a||!a[e.id]),i=r.a.JITSI.matches(e.type)?b.Top:b.Right;s===b.Right?h.push(e):s===b.Top||t===b.Top||n&&!t?m.push(e):(i===b.Top?m:h).push(e)}const E=m.slice(v);h.push(...E),m.sort((e,t)=>{var s,n,a,i,o,m;const h=null==d||null===(s=d.widgets)||void 0===s?void 0:s[e.id],u=null==d||null===(n=d.widgets)||void 0===n?void 0:n[t.id],p=null===(a=c)||void 0===a||null===(i=a.widgets)||void 0===i?void 0:i[e.id],g=null===(o=c)||void 0===o||null===(m=o.widgets)||void 0===m?void 0:m[t.id],f=r.a.JITSI.matches(e.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,b=r.a.JITSI.matches(t.type)?Number.MIN_SAFE_INTEGER:Number.MAX_SAFE_INTEGER,v=Object(l.b)(null==p?void 0:p.index,Object(l.b)(null==h?void 0:h.index,f)),_=Object(l.b)(null==g?void 0:g.index,Object(l.b)(null==u?void 0:u.index,b));return v===_?e.id.localeCompare(t.id):v-_});const C=[];let w=null,S=!0;for(let e=0;e<m.length;e++){var x,R,O;const t=m[e],s=null==d||null===(x=d.widgets)||void 0===x?void 0:x[t.id],n=null===(R=c)||void 0===R||null===(O=R.widgets)||void 0===O?void 0:O[t.id];if(Number.isFinite(null==n?void 0:n.width)||Number.isFinite(null==s?void 0:s.width)){const e=(null==n?void 0:n.width)||(null==s?void 0:s.width),t=Object(l.a)(e,10,100);C.push(t),S=!1}else C.push(100);if(null!=s&&s.height||null!=n&&n.height){const e=Object(l.b)(null==s?void 0:s.height,2),t=Object(l.b)(null==n?void 0:n.height,e);w=Math.max(w,Object(l.a)(t,2,100))}}if(S)for(let e=0;e<C.length;e++)C[e]=100/C.length;else{const e=Object(l.e)(...C)-100;if(e<0)for(let t=0;t<C.length;t++)C[t]+=Math.abs(e)/C.length;else if(e>0){for(let t=0;t<C.length;t++)C[t]=Object(l.a)(C[t]-e/C.length,10,100);const t=Object(l.e)(...C)-100;if(t>0){const e=C.map((e,t)=>[t,e]).filter(e=>e[1]>10).map(e=>e[0]);for(const s of e)C[s]-=t/e.length}}}this.byRoom[e.roomId]={},m.length&&(this.byRoom[e.roomId][b.Top]={ordered:m,distributions:C,height:w}),h.length&&(this.byRoom[e.roomId][b.Right]={ordered:h});JSON.stringify(this.byRoom[e.roomId])!==s&&this.emitFor(e)}getContainerWidgets(e,t){var s,n;return(null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.ordered)||[]}isInContainer(e,t,s){return this.getContainerWidgets(e,s).some(e=>e.id===t.id)}canAddToContainer(e,t){return this.getContainerWidgets(e,t).length<v}getResizerDistributions(e,t){var s,n;let a=null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.distributions;return!a||a.length<2?[]:(2===a.length&&(a=[a[0]]),3===a.length&&(a=[a[0],a[2]]),a.map(e=>e.toFixed(1)+"%"))}setResizerDistributions(e,t,s){if(t!==b.Top)return;const n=s.map(e=>Number(Number(e.substring(0,e.length-1)).toFixed(1))),a=this.getContainerWidgets(e,t),i=100-Object(l.e)(...n);2===n.length&&n.splice(1,0,i),1===n.length&&n.push(i);const o={};a.forEach((s,a)=>{var i,r;o[s.id]={container:t,width:n[a],index:a,height:(null===(i=this.byRoom[e.roomId])||void 0===i||null===(r=i[t])||void 0===r?void 0:r.height)||2}}),this.updateUserLayout(e,o)}getContainerHeight(e,t){var s,n;return null===(s=this.byRoom[e.roomId])||void 0===s||null===(n=s[t])||void 0===n?void 0:n.height}setContainerHeight(e,t,s){var n,a;const i=this.getContainerWidgets(e,t),o=null===(n=this.byRoom[e.roomId])||void 0===n||null===(a=n[t])||void 0===a?void 0:a.distributions,r={};i.forEach((e,n)=>{r[e.id]={container:t,width:o[n],index:n,height:s}}),this.updateUserLayout(e,r)}moveWithinContainer(e,t,s,n){var a,i,o,r;const c=Object(h.c)(this.getContainerWidgets(e,t)),d=c.findIndex(e=>e.id===s.id);if(d<0)return;c.splice(d,1);const m=Object(l.a)(d+n,0,c.length);c.splice(m,0,s);const u=null===(a=this.byRoom[e.roomId])||void 0===a||null===(i=a[t])||void 0===i?void 0:i.distributions,p=null===(o=this.byRoom[e.roomId])||void 0===o||null===(r=o[t])||void 0===r?void 0:r.height,g={};c.forEach((e,s)=>{g[e.id]={container:t,width:u[s],index:s,height:p}}),this.updateUserLayout(e,g)}moveToContainer(e,t,s){this.getAllWidgets(e).some(([e])=>e.id===t.id)&&this.updateUserLayout(e,{[t.id]:{container:s}})}canCopyLayoutToRoom(e){return!!this.matrixClient&&e.currentState.maySendStateEvent(f,this.matrixClient.getUserId())}copyLayoutToRoom(e){const t=this.getAllWidgets(e),s={widgets:{}};for(const[r,l]of t)if(s.widgets[r.id]={container:l},l===b.Top){var n,a,i,o;const t=this.getContainerWidgets(e,l).findIndex(e=>e.id===r.id),c=null===(n=this.byRoom[e.roomId])||void 0===n||null===(a=n[l])||void 0===a?void 0:a.distributions,d=null===(i=this.byRoom[e.roomId])||void 0===i||null===(o=i[l])||void 0===o?void 0:o.height;s.widgets[r.id]=g(g({},s.widgets[r.id]),{},{height:d?Math.round(d):null,width:c[t]?Math.round(c[t]):null,index:t})}this.matrixClient.sendStateEvent(e.roomId,f,s,"")}getAllWidgets(e){const t=this.byRoom[e.roomId];if(!t)return[];const s=[];for(const e of Object.keys(t)){const n=t[e].ordered;for(const t of n)s.push([t,e])}return s}updateUserLayout(e,t){const s=this.getAllWidgets(e);for(const[i,l]of s){var n,a;const s=this.getContainerWidgets(e,l).findIndex(e=>e.id===i.id),c=null===(n=this.byRoom[e.roomId])||void 0===n||null===(a=n[l])||void 0===a?void 0:a.distributions;var o,r;if(!t[i.id])t[i.id]={container:l,index:s,height:null===(o=this.byRoom[e.roomId])||void 0===o||null===(r=o[l])||void 0===r?void 0:r.height,width:null==c?void 0:c[s]}}const l=e.currentState.getStateEvents(f,"");i.a.setValue("Widgets.layout",e.roomId,m.a.ROOM_ACCOUNT,{overrides:null==l?void 0:l.getId(),widgets:t}).catch(()=>this.recalculateRoom(e)),this.recalculateRoom(e)}}a()(_,"internalInstance",void 0),window.mxWidgetLayoutStore=_.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85);class d extends o.a.Component{constructor(){super(),a()(this,"onMouseOver",()=>{this.setState({hover:!0})}),a()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=c.getComponent("elements.Tooltip");return o.a.createElement("span",{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:this.props.class},this.props.children,this.state.hover&&o.a.createElement(e,{label:this.props.tooltip,tooltipClassName:this.props.tooltipClass,className:"mx_TextWithTooltip_tooltip"}))}}a()(d,"propTypes",{class:l.a.string,tooltipClass:l.a.string,tooltip:l.a.node.isRequired})},function(e,t,s){"use strict";s.d(t,"d",(function(){return E})),s.d(t,"a",(function(){return C})),s.d(t,"c",(function(){return R})),s.d(t,"e",(function(){return O})),s.d(t,"b",(function(){return k})),s.d(t,"f",(function(){return I}));var n=s(89),a=s(85),i=s(86),o=s(322),r=s(323),l=s(83),c=s(126),d=s(283),m=s(662),h=s(251),u=s(88),p=s(248);let g={},f={},b=!1,v=!1,_={};function y(){return b}function E(){return b}class C extends Error{constructor(){super("Secret storage access canceled")}}async function w(){const e=a.getComponent("dialogs.QuestionDialog"),[t]=await n.a.createDialog(e,{title:Object(l.a)("Cancel entering passphrase?"),description:Object(l.a)("Are you sure you want to cancel entering passphrase?"),danger:!1,button:Object(l.a)("Go Back"),cancelButton:Object(l.a)("Cancel")}).finished;return!t}function S(e){return async({passphrase:t,recoveryKey:s})=>t?Object(o.a)(t,e.passphrase.salt,e.passphrase.iterations):Object(r.a)(s)}function x(e,t,s){y()&&(g[e]=s,f[e]=t)}const R={getSecretStorageKey:async function({keys:e},t){var s;const a=Object.entries(e);if(a.length>1)throw new Error("Multiple storage key requests not implemented");const[o,r]=a[0];if(y()&&g[o])return[o,g[o]];if(_.key&&await i.a.get().checkSecretStorageKey(_.key,r))return x(o,r,_.key),[o,_.key];const l=null===(s=p.a.getSecretStorageKey)||void 0===s?void 0:s.call(p.a);if(l)return console.log("Using key from security customisations (secret storage)"),x(o,r,l),[o,l];if(v)throw new Error("Could not unlock non-interactively");const c=S(r),{finished:d}=n.a.createTrackedDialog("Access Secret Storage dialog","",m.a,{keyInfo:r,checkPrivateKey:async e=>{const t=await c(e);return await i.a.get().checkSecretStorageKey(t,r)}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||w()}),[h]=await d;if(!h)throw new C;const u=await c(h);return x(o,r,u),[o,u]},cacheSecretStorageKey:x,onSecretRequested:async function(e,t,s,n,a){console.log("onSecretRequested",e,t,s,n,a);const o=i.a.get();if(e===o.getUserId())if(a&&a.isVerified()){if("m.cross_signing.master"===n||"m.cross_signing.self_signing"===n||"m.cross_signing.user_signing"===n){const e=o.getCrossSigningCacheCallbacks();if(!e.getCrossSigningKeyCache)return;const s=n.replace("m.cross_signing.",""),a=await e.getCrossSigningKeyCache(s);return a||console.log(`${s} requested by ${t}, but not found in cache`),a&&Object(c.encodeBase64)(a)}if("m.megolm_backup.v1"===n){const e=await o._crypto.getSessionBackupPrivateKey();return e||console.log(`session backup key requested by ${t}, but not found in cache`),e&&Object(c.encodeBase64)(e)}console.warn("onSecretRequested didn't recognise the secret named ",n)}else console.log("Ignoring secret request from untrusted device "+t)},getDehydrationKey:async function(e,t){var s;const a=null===(s=p.a.getSecretStorageKey)||void 0===s?void 0:s.call(p.a);if(a)return console.log("Using key from security customisations (dehydration)"),a;const i=S(e),{finished:o}=n.a.createTrackedDialog("Access Secret Storage dialog","",m.a,{keyInfo:e,checkPrivateKey:async e=>{const s=await i(e);try{return t(s),!0}catch(e){return!1}}},null,!1,!1,{onBeforeClose:async e=>"backgroundClick"!==e||w()}),[r]=await o;if(!r)throw new C;const l=await i(r);return _={key:new Uint8Array(l),keyInfo:e},l}};async function O(){let e;const{finished:t}=n.a.createTrackedDialog("Restore Backup","",h.a,{showSummary:!1,keyCallback:t=>e=t},null,!1,!0);if(!await t)throw new Error("Key backup prompt cancelled");return e}async function k(e=(async()=>{}),t=!1){const o=i.a.get();b=!0;try{if(!await o.hasSecretStorageKey()||t){const{finished:e}=n.a.createTrackedDialogAsync("Create Secret Storage dialog","",s.e(19).then(s.bind(null,1487)),{forceReset:t},null,!1,!0,{onBeforeClose:async e=>"backgroundClick"!==e||!Object(d.d)()}),[a]=await e;if(!a)throw new Error("Secret storage creation canceled")}else{const e=a.getComponent("dialogs.InteractiveAuthDialog");await o.bootstrapCrossSigning({authUploadDeviceSigningKeys:async t=>{const{finished:s}=n.a.createTrackedDialog("Cross-signing keys dialog","",e,{title:Object(l.a)("Setting up keys"),matrixClient:o,makeRequest:t}),[a]=await s;if(!a)throw new Error("Cross-signing key upload auth canceled")}}),await o.bootstrapSecretStorage({getKeyBackupPassphrase:O});const t=Object.keys(g)[0];if(t&&u.a.getValue("feature_dehydration")){let e={};f[t]&&f[t].passphrase&&(e={passphrase:f[t].passphrase}),console.log("Setting dehydration key"),await o.setDehydrationKey(g[t],e,"Backup device")}else t?console.log("Not setting dehydration key: feature disabled"):console.warn("Not setting dehydration key: no SSSS key found")}return await e()}catch(e){var r;null===(r=p.a.catchAccessSecretStorageError)||void 0===r||r.call(p.a,e),console.error(e)}finally{b=!1,y()||(g={},f={})}}async function I(e){const t=_.key;let s=!1;if(t&&await e.isSecretStorageReady()){console.log("Trying to set up cross-signing using dehydration key"),b=!0,v=!0;try{await e.checkOwnCrossSigningTrust();let n={};_.keyInfo&&_.keyInfo.passphrase&&(n={passphrase:_.keyInfo.passphrase}),await e.setDehydrationKey(t,n,"Backup device");const a=await e.getKeyBackupVersion();a&&(s=!0,e.restoreKeyBackupWithSecretStorage(a).finally(()=>{b=!1,v=!1,y()||(g={},f={})}))}finally{_={},s||(b=!1,v=!1,y()||(g={},f={}))}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return _}));var n=s(82),a=s.n(n),i=s(147),o=s(87),r=s(125),l=s(245),c=s(120),d=s(246);class m extends d.b{constructor(e=!1,t,s){super(),this.byTileCount=e,this.tagId=t,this.getRoomFn=s,a()(this,"rooms",[]),a()(this,"states",{}),a()(this,"onRoomNotificationStateUpdate",()=>{this.calculateTotalState()})}get symbol(){return null}setRooms(e){if(this.byTileCount)return this.rooms=e,void this.calculateTotalState();const t=this.rooms,s=Object(c.b)(t,e);this.rooms=e;for(const e of s.removed){const t=this.states[e.roomId];t&&(delete this.states[e.roomId],t.off(d.a,this.onRoomNotificationStateUpdate))}for(const e of s.added){const t=this.getRoomFn(e);t.on(d.a,this.onRoomNotificationStateUpdate),this.states[e.roomId]=t}this.calculateTotalState()}getForRoom(e){const t=this.states[e.roomId];if(!t)throw new Error("Unknown room for notification state");return t}destroy(){super.destroy();for(const e of Object.values(this.states))e.off(d.a,this.onRoomNotificationStateUpdate);this.states={}}calculateTotalState(){const e=this.snapshot();if(this.byTileCount)this._color=l.a.Red,this._count=this.rooms.length;else{this._count=0,this._color=l.a.None;for(const e of Object.values(this.states))this._count+=e.count,this._color=Math.max(this.color,e.color)}this.emitIfUpdated(e)}}var h=s(86),u=s(171),p=s(553),g=s(304),f=s(554);class b extends d.b{constructor(e){super(),this.room=e,a()(this,"handleReadReceipt",(e,t)=>{Object(p.a)(e,h.a.get())&&t.roomId===this.room.roomId&&this.updateNotificationState()}),a()(this,"handleMembershipUpdate",()=>{this.updateNotificationState()}),a()(this,"handleRoomEventUpdate",e=>{e.getRoomId()===this.room.roomId&&this.updateNotificationState()}),a()(this,"handleAccountDataUpdate",e=>{"m.push_rules"===e.getType()&&this.updateNotificationState()}),this.room.on("Room.receipt",this.handleReadReceipt),this.room.on("Room.timeline",this.handleRoomEventUpdate),this.room.on("Room.redaction",this.handleRoomEventUpdate),this.room.on("Room.myMembership",this.handleMembershipUpdate),h.a.get().on("Event.decrypted",this.handleRoomEventUpdate),h.a.get().on("accountData",this.handleAccountDataUpdate),this.updateNotificationState()}get roomIsInvite(){return Object(u.b)(this.room.getMyMembership())===u.a.Invite}destroy(){super.destroy(),this.room.removeListener("Room.receipt",this.handleReadReceipt),this.room.removeListener("Room.timeline",this.handleRoomEventUpdate),this.room.removeListener("Room.redaction",this.handleRoomEventUpdate),this.room.removeListener("Room.myMembership",this.handleMembershipUpdate),h.a.get()&&(h.a.get().removeListener("Event.decrypted",this.handleRoomEventUpdate),h.a.get().removeListener("accountData",this.handleAccountDataUpdate))}updateNotificationState(){const e=this.snapshot();if(g.f(this.room.roomId)===g.d)this._color=l.a.None,this._symbol=null,this._count=0;else if(this.roomIsInvite)this._color=l.a.Red,this._symbol="!",this._count=1;else{const e=g.g(this.room,"highlight"),t=g.g(this.room,"total"),s=t||(e||0);if(e>0)this._color=l.a.Red,this._count=s,this._symbol=null;else if(t>0)this._color=l.a.Grey,this._count=s,this._symbol=null;else{const e=f.a(this.room);this._color=e?l.a.Bold:l.a.None,this._count=0,this._symbol=null}}this.emitIfUpdated(e)}}class v extends d.b{constructor(){super(),a()(this,"totalStatesWithUnread",0),this._symbol=null,this._count=0,this._color=l.a.None}get numUnreadStates(){return this.totalStatesWithUnread}add(e,t=!1){e.symbol&&t&&(this._symbol=e.symbol),e.count&&(this._count+=e.count),e.color>this.color&&(this._color=e.color),e.hasUnreadCount&&this.totalStatesWithUnread++}}class _ extends i.a{constructor(){super(o.a,{}),a()(this,"roomMap",new Map),a()(this,"listMap",new Map)}get globalState(){if(!this.matrixClient)return new v;const e=new v;for(const t of this.matrixClient.getVisibleRooms())e.add(this.getRoomState(t));return e}getListState(e){if(this.listMap.has(e))return this.listMap.get(e);const t=e===r.a.Invite,s=new m(t,e,e=>this.getRoomState(e));return this.listMap.set(e,s),s}getRoomState(e){return this.roomMap.has(e)||this.roomMap.set(e,new b(e)),this.roomMap.get(e)}static get instance(){return _.internalInstance}async onNotReady(){for(const e of this.roomMap.values())e.destroy()}async onAction(e){return Promise.resolve()}}a()(_,"internalInstance",new _)},function(e,t,s){"use strict";s.d(t,"c",(function(){return C})),s.d(t,"e",(function(){return w})),s.d(t,"d",(function(){return l})),s.d(t,"a",(function(){return p})),s.d(t,"b",(function(){return f}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(99);const l=({children:e,inputRef:t})=>{const[s,n,a]=w(t);return e({onFocus:s,isActive:n,ref:a})};var c=s(93),d=s.n(c),m=s(101),h=s.n(m),u=s(91);const p=e=>{let{inputRef:t}=e,s=h()(e,["inputRef"]);const[n,a,i]=w(t);return o.a.createElement(u.a,d()({},s,{onFocus:n,inputRef:i,tabIndex:a?0:-1}))};var g=s(115);const f=e=>{let{inputRef:t}=e,s=h()(e,["inputRef"]);const[n,a,i]=w(t);return o.a.createElement(g.a,d()({},s,{onFocus:n,inputRef:i,tabIndex:a?0:-1}))};function b(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function v(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?b(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):b(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const _=Object(i.createContext)({state:{activeRef:null,refs:[]},dispatch:()=>{}});var y;_.displayName="RovingTabIndexContext",function(e){e.Register="REGISTER",e.Unregister="UNREGISTER",e.SetFocus="SET_FOCUS"}(y||(y={}));const E=(e,t)=>{switch(t.type){case y.Register:{if(0===e.refs.length)return v(v({},e),{},{activeRef:t.payload.ref,refs:[t.payload.ref]});if(e.refs.includes(t.payload.ref))return e;let s=e.refs.findIndex(e=>2&e.current.compareDocumentPosition(t.payload.ref.current));return s<0&&(s=e.refs.length),v(v({},e),{},{refs:[...e.refs.slice(0,s),t.payload.ref,...e.refs.slice(s)]})}case y.Unregister:{const s=e.refs.filter(e=>e!==t.payload.ref);if(s.length===e.refs.length)return e;if(e.activeRef===t.payload.ref){const n=e.refs.findIndex(e=>e===t.payload.ref);return v(v({},e),{},{activeRef:n>=s.length?s[s.length-1]:s[n],refs:s})}return v(v({},e),{},{refs:s})}case y.SetFocus:return v(v({},e),{},{activeRef:t.payload.ref});default:return e}},C=({children:e,handleHomeEnd:t,onKeyDown:s})=>{const[n,a]=Object(i.useReducer)(E,{activeRef:null,refs:[]}),l=Object(i.useMemo)(()=>({state:n,dispatch:a}),[n]),c=Object(i.useCallback)(e=>{let n=!1;if(t&&"INPUT"!==e.target.tagName)switch(e.key){case r.a.HOME:n=!0,l.state.refs.length>0&&l.state.refs[0].current.focus();break;case r.a.END:n=!0,l.state.refs.length>0&&l.state.refs[l.state.refs.length-1].current.focus()}if(n)e.preventDefault(),e.stopPropagation();else if(s)return s(e,l.state)},[l.state,s,t]);return o.a.createElement(_.Provider,{value:l},e({onKeyDownHandler:c}))},w=e=>{const t=Object(i.useContext)(_);let s=Object(i.useRef)(null);e&&(s=e),Object(i.useLayoutEffect)(()=>(t.dispatch({type:y.Register,payload:{ref:s}}),()=>{t.dispatch({type:y.Unregister,payload:{ref:s}})}),[]);return[Object(i.useCallback)(()=>{t.dispatch({type:y.SetFocus,payload:{ref:s}})},[s,t]),t.state.activeRef===s,s]}},,,,function(e,t,s){"use strict";(function(e){var n=s(301),a=s(87),i=s(114),o=s(116),r=s(304),l=s(86),c=s(88);const d={orderedTags:null,orderedTagsAccountData:null,hasSynced:!1,joinedGroupIds:null,selectedTags:[],anchorTag:null};class m extends n.Store{constructor(){super(a.a),this._state=Object.assign({},d),c.a.monitorSetting("TagPanel.enableTagPanel",null)}_setState(e){this._state=Object.assign(this._state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"view_room":{const t=i.a.getGroupIdsForRoomId(e.room_id);this._updateBadges(t);break}case"MatrixActions.sync":{if("SYNCING"!==e.state&&"PREPARED"!==e.state||this._updateBadges(),"PREPARED"===e.prevState||"PREPARED"!==e.state)break;const t=e.matrixClient.getAccountData("im.vector.web.tag_ordering"),s=t?t.getContent():{};this._setState({orderedTagsAccountData:s.tags||null,removedTagsAccountData:s.removedTags||null,hasSynced:!0}),this._updateOrderedTags();break}case"MatrixActions.accountData":if("im.vector.web.tag_ordering"!==e.event_type)break;if(e.event_content._storeId===this.getStoreId())break;this._setState({orderedTagsAccountData:e.event_content?e.event_content.tags:null,removedTagsAccountData:e.event_content?e.event_content.removedTags:null}),this._updateOrderedTags();break;case"GroupActions.fetchJoinedGroups.success":this._setState({joinedGroupIds:e.result.groups.sort(),hasFetchedJoinedGroups:!0}),this._updateOrderedTags();break;case"TagOrderActions.moveTag.pending":this._setState({orderedTags:e.request.tags,removedTagsAccountData:e.request.removedTags});break;case"TagOrderActions.removeTag.pending":this._setState({removedTagsAccountData:e.request.removedTags}),this._updateOrderedTags();break;case"select_tag":{const t=!c.a.getValue("feature_communities_v2_prototypes");let s=[];if(e.shiftKey&&t){let t=this._state.orderedTags.indexOf(this._state.anchorTag),n=this._state.orderedTags.indexOf(e.tag);if(-1===t&&(t=n),t>n){const e=t;t=n,n=e}s=e.ctrlOrCmdKey?this._state.selectedTags:[],s=[...new Set(this._state.orderedTags.slice(t,n+1).concat(s))]}else s=e.ctrlOrCmdKey&&t?this._state.selectedTags.includes(e.tag)?this._state.selectedTags.filter(t=>t!==e.tag):[...this._state.selectedTags,e.tag]:1===this._state.selectedTags.length&&this._state.selectedTags.includes(e.tag)?[]:[e.tag],this._state.selectedTags.includes(e.tag)||this._setState({anchorTag:e.tag});this._setState({selectedTags:s}),o.a.trackEvent("FilterStore","select_tag")}break;case"deselect_tags":e.tag?this._setState({selectedTags:this._state.selectedTags.filter(t=>t!==e.tag)}):this._setState({selectedTags:[]}),o.a.trackEvent("FilterStore","deselect_tags");break;case"on_client_not_viable":case"on_logged_out":this._state=Object.assign({},d);break;case"setting_updated":"TagPanel.enableTagPanel"!==e.settingName||e.newValue||(this._setState({selectedTags:[]}),o.a.trackEvent("FilterStore","disable_tags"))}}_updateBadges(e=this._state.joinedGroupIds){if(e&&e.length){const t=l.a.get(),s={};e.forEach(e=>{const n=i.a.getGroupRooms(e).map(e=>t.getRoom(e.roomId)).filter(e=>null!=e),a=n&&r.e(n);s[e]=a&&0!==a.count?a:void 0});const n=Object.assign({},this._state.badges,s);this._setState({badges:n})}}_updateOrderedTags(){this._setState({orderedTags:this._state.hasSynced&&this._state.hasFetchedJoinedGroups?this._mergeGroupsAndTags():null})}_mergeGroupsAndTags(){const e=this._state.joinedGroupIds||[],t=this._state.orderedTagsAccountData||[],s=new Set(this._state.removedTagsAccountData||[]),n=t.filter(t=>("+"!==t[0]||e.includes(t))&&!s.has(t)),a=e.filter(e=>!t.includes(e)&&!s.has(e));return n.concat(a)}getGroupBadge(e){const t=this._state.badges;return t&&t[e]}getOrderedTags(){return this._state.orderedTags}getRemovedTagsAccountData(){return this._state.removedTagsAccountData}getStoreId(){return this._id||(this._id=Math.random().toString(16).slice(2,10)),this._id}getSelectedTags(){return this._state.selectedTags}}void 0===e.singletonGroupFilterOrderStore&&(e.singletonGroupFilterOrderStore=new m),t.a=e.singletonGroupFilterOrderStore}).call(this,s(5))},,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));const n=/^[A-Z0-9._%+-]+@[A-Z0-9.-]+\.[A-Z]{2,}$/i;function a(e){return n.test(e)}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(147),o=s(87),r=s(243),l=s(244),c=s(122),d=s(132),m=s(113),h=s(86);function u(e){var t;return`${null!==(t=e.roomId)&&void 0!==t?t:h.a.get().getUserId()}::${e.id}`}class p extends i.a{constructor(){super(o.a,{}),a()(this,"widgetMap",new Map),a()(this,"roomMap",new Map),a()(this,"onWidgetEchoStoreUpdate",(e,t)=>{this.initRoom(e),this.loadRoomWidgets(this.matrixClient.getRoom(e)),this.emit(m.b,e)}),a()(this,"onRoom",e=>{this.initRoom(e.roomId),this.loadRoomWidgets(e),this.emit(m.b,e.roomId)}),a()(this,"onRoomStateEvents",e=>{if("im.vector.modular.widgets"!==e.getType())return;const t=e.getRoomId();this.initRoom(t),this.loadRoomWidgets(this.matrixClient.getRoom(t)),this.emit(m.b,t)}),a()(this,"getRoom",(e,t=!1)=>(t&&this.initRoom(e),this.roomMap.get(e))),r.a.on("update",this.onWidgetEchoStoreUpdate)}static get instance(){return p.internalInstance}initRoom(e){this.roomMap.has(e)||this.roomMap.set(e,{widgets:[]})}async onReady(){this.matrixClient.on("Room",this.onRoom),this.matrixClient.on("RoomState.events",this.onRoomStateEvents),this.matrixClient.getRooms().forEach(e=>{this.loadRoomWidgets(e)}),this.emit(m.b,null)}async onNotReady(){this.matrixClient.off("Room",this.onRoom),this.matrixClient.off("RoomState.events",this.onRoomStateEvents),this.widgetMap=new Map,this.roomMap=new Map,await this.reset({})}async onAction(e){}generateApps(e){return r.a.getEchoedRoomWidgets(e.roomId,c.a.getRoomWidgets(e)).map(e=>c.a.makeAppConfig(e.getStateKey(),e.getContent(),e.getSender(),e.getRoomId(),e.getId()))}loadRoomWidgets(e){if(!e)return;const t=this.roomMap.get(e.roomId)||{};t.widgets=[],Array.from(this.widgetMap.values()).forEach(t=>{t.roomId===e.roomId&&this.widgetMap.delete(u(t))});let s=!1;this.generateApps(e).forEach(e=>{const n=this.widgetMap.get(u(e));n&&console.warn(`Possible widget ID conflict for ${e.id} - wants to store in room ${e.roomId} but is currently stored as ${n.roomId} - letting the want win`),this.widgetMap.set(u(e),e),t.widgets.push(e),s=!0}),s&&!this.roomMap.has(e.roomId)&&this.roomMap.set(e.roomId,t),this.emit(e.roomId)}getApps(e){const t=this.getRoom(e);return(null==t?void 0:t.widgets)||[]}doesRoomHaveConference(e){const t=this.getRoom(e.roomId);if(!t)return!1;const s=t.widgets.filter(e=>d.a.JITSI.matches(e.type)),n=r.a.roomHasPendingWidgetsOfType(e.roomId,[],d.a.JITSI);return s.length>0||n}isJoinedToConferenceIn(e){const t=this.getRoom(e.roomId);if(!t)return!1;return t.widgets.filter(e=>d.a.JITSI.matches(e.type)).some(e=>l.a.getWidgetPersistence(e.id))}}a()(p,"internalInstance",new p),window.mxWidgetStore=p.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(81),a=s.n(n),i=s(84),o=s.n(i),r=s(90),l=s.n(r),c=s(83),d=s(91),m=s(298);const h={VERIFIED:"verified",WARNING:"warning",UNKNOWN:"unknown",NORMAL:"normal",UNAUTHENTICATED:"unauthenticated"},u={[h.WARNING]:Object(c.b)("This user has not verified all of their sessions."),[h.NORMAL]:Object(c.b)("You have not verified this user."),[h.VERIFIED]:Object(c.b)("You have verified this user. This user has verified all of their sessions.")},p={[h.WARNING]:Object(c.b)("Someone is using an unknown session"),[h.NORMAL]:Object(c.b)("This room is end-to-end encrypted"),[h.VERIFIED]:Object(c.b)("Everyone in this room is verified")},g=({isUser:e,status:t,className:s,size:i,onClick:o,hideTooltip:r,bordered:g})=>{const[f,b]=Object(n.useState)(!1),v=l()({mx_E2EIcon:!0,mx_E2EIcon_bordered:g,mx_E2EIcon_warning:t===h.WARNING,mx_E2EIcon_normal:t===h.NORMAL,mx_E2EIcon_verified:t===h.VERIFIED},s);let _,y;_=e?u[t]:p[t],i&&(y={width:i+"px",height:i+"px"});const E=()=>b(!0),C=()=>b(!1);let w;return f&&!r&&(w=a.a.createElement(m.a,{label:_?Object(c.a)(_):""})),o?a.a.createElement(d.a,{onClick:o,onMouseOver:E,onMouseLeave:C,className:v,style:y},w):a.a.createElement("div",{onMouseOver:E,onMouseLeave:C,className:v,style:y},w)};g.propTypes={isUser:o.a.bool,status:o.a.oneOf(Object.values(h)),className:o.a.string,size:o.a.number,onClick:o.a.func},t.b=g},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(82),l=s.n(r),c=s(81),d=s.n(c),m=s(133),h=s(168),u=s(444),p=s(86),g=s(89),f=s(226);class b extends d.a.Component{constructor(e){super(e),l()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&"m.room.avatar"===e.getType()&&this.setState({urls:b.getImageUrls(this.props)})}),l()(this,"onRoomAvatarClick",()=>{const e={src:f.b(this.props.room,null,null,null),name:this.props.room.name};g.a.createDialog(u.a,e,"mx_Dialog_lightbox")}),this.state={urls:b.getImageUrls(this.props)}}componentDidMount(){p.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=p.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}static getDerivedStateFromProps(e){return{urls:b.getImageUrls(e)}}static getImageUrls(e){return[Object(m.a)(p.a.get().getHomeserverUrl(),e.oobData.avatarUrl,Math.floor(e.width*window.devicePixelRatio),Math.floor(e.height*window.devicePixelRatio),e.resizeMethod),b.getRoomAvatarUrl(e)].filter((function(e){return null!==e&&""!==e}))}static getRoomAvatarUrl(e){return e.room?f.b(e.room,Math.floor(e.width*window.devicePixelRatio),Math.floor(e.height*window.devicePixelRatio),e.resizeMethod):null}render(){const e=this.props,{room:t,oobData:s,viewAvatarOnClick:n,onClick:i}=e,r=o()(e,["room","oobData","viewAvatarOnClick","onClick"]),l=t?t.name:s.name;return d.a.createElement(h.a,a()({},r,{name:l,idName:t?t.roomId:null,urls:this.state.urls,onClick:n&&this.state.urls[0]?this.onRoomAvatarClick:i}))}}l()(b,"defaultProps",{width:36,height:36,resizeMethod:"crop",oobData:{}})},function(e,t,s){"use strict";s.d(t,"a",(function(){return b})),s.d(t,"b",(function(){return v})),s.d(t,"c",(function(){return w})),s.d(t,"d",(function(){return R}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(90),d=s.n(c),m=s(85),h=s(83),u=s(88),p=s(91),g=s(117),f=s(105);const b=0;class v extends o.a.Component{constructor(...e){super(...e),a()(this,"state",{password:""}),a()(this,"_onSubmit",e=>{e.preventDefault(),this.props.busy||this.props.submitAuthDict({type:v.LOGIN_TYPE,user:this.props.matrixClient.credentials.userId,identifier:{type:"m.id.user",user:this.props.matrixClient.credentials.userId},password:this.state.password})}),a()(this,"_onPasswordFieldChange",e=>{this.setState({password:e.target.value})})}componentDidMount(){this.props.onPhaseChange(b)}render(){const e=d()({error:this.props.errorText});let t,s;if(this.props.busy){const e=m.getComponent("elements.Spinner");t=o.a.createElement(e,null)}else t=o.a.createElement("input",{type:"submit",className:"mx_Dialog_primary",disabled:!this.state.password,value:Object(h.a)("Continue")});this.props.errorText&&(s=o.a.createElement("div",{className:"error",role:"alert"},this.props.errorText));const n=m.getComponent("elements.Field");return o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("Confirm your identity by entering your account password below.")),o.a.createElement("form",{onSubmit:this._onSubmit,className:"mx_InteractiveAuthEntryComponents_passwordSection"},o.a.createElement(n,{className:e,type:"password",name:"passwordField",label:Object(h.a)("Password"),autoFocus:!0,value:this.state.password,onChange:this._onPasswordFieldChange}),o.a.createElement("div",{className:"mx_button_row"},t)),s)}}a()(v,"LOGIN_TYPE","m.login.password"),a()(v,"propTypes",{matrixClient:l.a.object.isRequired,submitAuthDict:l.a.func.isRequired,errorText:l.a.string,busy:l.a.bool,onPhaseChange:l.a.func.isRequired});class _ extends o.a.Component{constructor(...e){super(...e),a()(this,"_onCaptchaResponse",e=>{f.a.instance.track("onboarding_grecaptcha_submit"),this.props.submitAuthDict({type:_.LOGIN_TYPE,response:e})})}componentDidMount(){this.props.onPhaseChange(b)}render(){if(this.props.busy){const e=m.getComponent("elements.Spinner");return o.a.createElement(e,null)}let e=this.props.errorText;const t=m.getComponent("views.auth.CaptchaForm");let s,n;return this.props.stageParams&&this.props.stageParams.public_key?s=this.props.stageParams.public_key:e=Object(h.a)("Missing captcha public key in homeserver configuration. Please report this to your homeserver administrator."),e&&(n=o.a.createElement("div",{className:"error",role:"alert"},e)),o.a.createElement("div",null,o.a.createElement(t,{sitePublicKey:s,onCaptchaResponse:this._onCaptchaResponse}),n)}}a()(_,"LOGIN_TYPE","m.login.recaptcha"),a()(_,"propTypes",{submitAuthDict:l.a.func.isRequired,stageParams:l.a.object.isRequired,errorText:l.a.string,busy:l.a.bool,onPhaseChange:l.a.func.isRequired});class y extends o.a.Component{constructor(e){super(e),a()(this,"tryContinue",()=>{this._trySubmit()}),a()(this,"_trySubmit",()=>{let e=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];e=e&&s}e?(this.props.submitAuthDict({type:y.LOGIN_TYPE}),f.a.instance.track("onboarding_terms_complete")):this.setState({errorText:Object(h.a)("Please review and accept all of the homeserver's policies")})});const t=this.props.stageParams.policies||{},s=u.a.getValue("language"),n={},i=[];for(const e of Object.keys(t)){const a=t[e];let o=a[s];if(o||(o=a.en),!o){o=a[Object.keys(a).find(e=>"version"!==e)]}if(!o)throw new Error("Failed to find a policy to show the user");n[e]=!1,o.id=e,i.push(o)}this.state={toggledPolicies:n,policies:i},f.a.instance.track("onboarding_terms_begin")}componentDidMount(){this.props.onPhaseChange(b)}_togglePolicy(e){const t={};for(const s of this.state.policies){let n=this.state.toggledPolicies[s.id];s.id===e&&(n=!n),t[s.id]=n}this.setState({toggledPolicies:t})}render(){if(this.props.busy){const e=m.getComponent("elements.Spinner");return o.a.createElement(e,null)}const e=[];let t,s,n=!0;for(const t of this.state.policies){const s=this.state.toggledPolicies[t.id];n=n&&s,e.push(o.a.createElement("label",{key:"policy_checkbox_"+t.id,className:"mx_InteractiveAuthEntryComponents_termsPolicy"},o.a.createElement("input",{type:"checkbox",onChange:()=>this._togglePolicy(t.id),checked:s}),o.a.createElement("a",{href:t.url,target:"_blank",rel:"noreferrer noopener"},t.name)))}return(this.props.errorText||this.state.errorText)&&(t=o.a.createElement("div",{className:"error",role:"alert"},this.props.errorText||this.state.errorText)),!1!==this.props.showContinue&&(s=o.a.createElement("button",{className:"mx_InteractiveAuthEntryComponents_termsSubmit mx_GeneralButton",onClick:this._trySubmit,disabled:!n},Object(h.a)("Accept"))),o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("Please review and accept the policies of this homeserver:")),e,t,s)}}a()(y,"LOGIN_TYPE","m.login.terms"),a()(y,"propTypes",{submitAuthDict:l.a.func.isRequired,stageParams:l.a.object.isRequired,errorText:l.a.string,busy:l.a.bool,showContinue:l.a.bool,onPhaseChange:l.a.func.isRequired});class E extends o.a.Component{componentDidMount(){this.props.onPhaseChange(b)}render(){var e;return void 0===this.props.inputs.emailAddress||null!==(e=this.props.stageState)&&void 0!==e&&e.emailSid?o.a.createElement(g.a,null):o.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_emailWrapper"},o.a.createElement("p",null,Object(h.a)("An email has been sent to %(emailAddress)s, unless a Tchap account is already associated with it.",{emailAddress:e=>o.a.createElement("b",null,this.props.inputs.emailAddress)})),o.a.createElement("p",null,Object(h.a)("Please check your email to continue registration.")))}}a()(E,"LOGIN_TYPE","m.login.email.identity"),a()(E,"propTypes",{matrixClient:l.a.object.isRequired,submitAuthDict:l.a.func.isRequired,authSessionId:l.a.string.isRequired,clientSecret:l.a.string.isRequired,inputs:l.a.object.isRequired,stageState:l.a.object.isRequired,fail:l.a.func.isRequired,setEmailSid:l.a.func.isRequired,onPhaseChange:l.a.func.isRequired});class C extends o.a.Component{constructor(...e){super(...e),a()(this,"state",{token:"",requestingToken:!1}),a()(this,"_onTokenChange",e=>{this.setState({token:e.target.value})}),a()(this,"_onFormSubmit",async e=>{if(e.preventDefault(),""!=this.state.token){this.setState({errorText:null});try{let e;if(!this._submitUrl)throw new Error("The registration with MSISDN flow is misconfigured");if(e=await this.props.matrixClient.submitMsisdnTokenOtherUrl(this._submitUrl,this._sid,this.props.clientSecret,this.state.token),e.success){const e={sid:this._sid,client_secret:this.props.clientSecret};this.props.submitAuthDict({type:C.LOGIN_TYPE,threepid_creds:e,threepidCreds:e})}else this.setState({errorText:Object(h.a)("Token incorrect")})}catch(e){this.props.fail(e),console.log("Failed to submit msisdn token")}}})}componentDidMount(){this.props.onPhaseChange(b),this._submitUrl=null,this._sid=null,this._msisdn=null,this._tokenBox=null,this.setState({requestingToken:!0}),this._requestMsisdnToken().catch(e=>{this.props.fail(e)}).finally(()=>{this.setState({requestingToken:!1})})}_requestMsisdnToken(){return this.props.matrixClient.requestRegisterMsisdnToken(this.props.inputs.phoneCountry,this.props.inputs.phoneNumber,this.props.clientSecret,1).then(e=>{this._submitUrl=e.submit_url,this._sid=e.sid,this._msisdn=e.msisdn})}render(){if(this.state.requestingToken){const e=m.getComponent("elements.Spinner");return o.a.createElement(e,null)}{const e=Boolean(this.state.token),t=d()({mx_InteractiveAuthEntryComponents_msisdnSubmit:!0,mx_GeneralButton:!0});let s;return this.state.errorText&&(s=o.a.createElement("div",{className:"error",role:"alert"},this.state.errorText)),o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("A text message has been sent to %(msisdn)s",{msisdn:o.a.createElement("i",null,this._msisdn)})),o.a.createElement("p",null,Object(h.a)("Please enter the code it contains:")),o.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_msisdnWrapper"},o.a.createElement("form",{onSubmit:this._onFormSubmit},o.a.createElement("input",{type:"text",className:"mx_InteractiveAuthEntryComponents_msisdnEntry",value:this.state.token,onChange:this._onTokenChange,"aria-label":Object(h.a)("Code")}),o.a.createElement("br",null),o.a.createElement("input",{type:"submit",value:Object(h.a)("Submit"),className:t,disabled:!e})),s))}}}a()(C,"LOGIN_TYPE","m.login.msisdn"),a()(C,"propTypes",{inputs:l.a.shape({phoneCountry:l.a.string,phoneNumber:l.a.string}),fail:l.a.func,clientSecret:l.a.func,submitAuthDict:l.a.func.isRequired,matrixClient:l.a.object,onPhaseChange:l.a.func.isRequired});class w extends o.a.Component{constructor(e){super(e),a()(this,"_ssoUrl",void 0),a()(this,"attemptFailed",()=>{this.setState({attemptFailed:!0})}),a()(this,"_onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this._popupWindow&&(this._popupWindow.close(),this._popupWindow=null)}),a()(this,"onStartAuthClick",()=>{this._popupWindow=window.open(this._ssoUrl,"_blank"),this.setState({phase:w.PHASE_POSTAUTH}),this.props.onPhaseChange(w.PHASE_POSTAUTH)}),a()(this,"onConfirmClick",()=>{this.props.submitAuthDict({})}),this._ssoUrl=e.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId),this._popupWindow=null,window.addEventListener("message",this._onReceiveMessage),this.state={phase:w.PHASE_PREAUTH,attemptFailed:!1}}componentDidMount(){this.props.onPhaseChange(w.PHASE_PREAUTH)}componentWillUnmount(){window.removeEventListener("message",this._onReceiveMessage),this._popupWindow&&(this._popupWindow.close(),this._popupWindow=null)}render(){let e=null;const t=o.a.createElement(p.a,{onClick:this.props.onCancel,kind:this.props.continueKind?this.props.continueKind+"_outline":"primary_outline"},Object(h.a)("Cancel"));let s;return e=this.state.phase===w.PHASE_PREAUTH?o.a.createElement(p.a,{onClick:this.onStartAuthClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(h.a)("Single Sign On")):o.a.createElement(p.a,{onClick:this.onConfirmClick,kind:this.props.continueKind||"primary"},this.props.continueText||Object(h.a)("Confirm")),this.props.errorText?s=o.a.createElement("div",{className:"error",role:"alert"},this.props.errorText):this.state.attemptFailed&&(s=o.a.createElement("div",{className:"error",role:"alert"},Object(h.a)("Something went wrong in confirming your identity. Cancel and try again."))),o.a.createElement(o.a.Fragment,null,s,o.a.createElement("div",{className:"mx_InteractiveAuthEntryComponents_sso_buttons"},t,e))}}a()(w,"propTypes",{matrixClient:l.a.object.isRequired,authSessionId:l.a.string.isRequired,loginType:l.a.string.isRequired,submitAuthDict:l.a.func.isRequired,errorText:l.a.string,onPhaseChange:l.a.func.isRequired,continueText:l.a.string,continueKind:l.a.string,onCancel:l.a.func}),a()(w,"LOGIN_TYPE","m.login.sso"),a()(w,"UNSTABLE_LOGIN_TYPE","org.matrix.login.sso"),a()(w,"PHASE_PREAUTH",1),a()(w,"PHASE_POSTAUTH",2);class S extends o.a.Component{constructor(e){super(e),a()(this,"focus",()=>{this._fallbackButton.current&&this._fallbackButton.current.focus()}),a()(this,"_onShowFallbackClick",e=>{e.preventDefault(),e.stopPropagation();const t=this.props.matrixClient.getFallbackAuthUrl(this.props.loginType,this.props.authSessionId);this._popupWindow=window.open(t,"_blank")}),a()(this,"_onReceiveMessage",e=>{"authDone"===e.data&&e.origin===this.props.matrixClient.getHomeserverUrl()&&this.props.submitAuthDict({})}),this._popupWindow=null,window.addEventListener("message",this._onReceiveMessage),this._fallbackButton=Object(i.createRef)()}componentDidMount(){this.props.onPhaseChange(b)}componentWillUnmount(){window.removeEventListener("message",this._onReceiveMessage),this._popupWindow&&this._popupWindow.close()}render(){let e;return this.props.errorText&&(e=o.a.createElement("div",{className:"error",role:"alert"},this.props.errorText)),o.a.createElement("div",null,o.a.createElement("a",{href:"",ref:this._fallbackButton,onClick:this._onShowFallbackClick},Object(h.a)("Start authentication")),e)}}a()(S,"propTypes",{matrixClient:l.a.object.isRequired,authSessionId:l.a.string.isRequired,loginType:l.a.string.isRequired,submitAuthDict:l.a.func.isRequired,errorText:l.a.string,onPhaseChange:l.a.func.isRequired});const x=[v,_,E,C,y,w];function R(e){for(const t of x)if(t.LOGIN_TYPE===e||t.UNSTABLE_LOGIN_TYPE===e)return t;return S}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83);class d extends o.a.Component{constructor(...e){super(...e),a()(this,"_onCancelClick",()=>{this.props.onCancel()})}render(){let e,t="mx_Dialog_primary";this.props.primaryButtonClass&&(t+=" "+this.props.primaryButtonClass),(this.props.cancelButton||this.props.hasCancel)&&(e=o.a.createElement("button",{type:"button",onClick:this._onCancelClick,className:this.props.cancelButtonClass,disabled:this.props.disabled},this.props.cancelButton||Object(c.a)("Cancel")));let s=null;return this.props.additive&&(s=o.a.createElement("div",{className:"mx_Dialog_buttons_additive"},this.props.additive)),o.a.createElement("div",{className:"mx_Dialog_buttons"},s,e,this.props.children,o.a.createElement("button",{type:this.props.primaryIsSubmit?"submit":"button",className:t,onClick:this.props.onPrimaryButtonClick,autoFocus:this.props.focus,disabled:this.props.disabled||this.props.primaryDisabled},this.props.primaryButton))}}a()(d,"propTypes",{primaryButton:l.a.node.isRequired,cancelButton:l.a.node,primaryIsSubmit:l.a.bool,onPrimaryButtonClick:l.a.func,hasCancel:l.a.bool,cancelButtonClass:l.a.node,onCancel:l.a.func,focus:l.a.bool,disabled:l.a.bool,primaryDisabled:l.a.bool,additive:l.a.element}),a()(d,"defaultProps",{hasCancel:!0,disabled:!1})},function(e,t,s){"use strict";s.r(t),s.d(t,"CHAT_EFFECTS",(function(){return a}));var n=s(83);const a=[{emojis:["🎊","🎉"],msgType:"nic.custom.confetti",command:"confetti",description:()=>Object(n.b)("Sends the given message with confetti"),fallbackMessage:()=>Object(n.a)("sends confetti")+" 🎉",options:{maxCount:150,speed:3,frameInterval:15,alpha:1,gradient:!1}},{emojis:["🎆"],msgType:"nic.custom.fireworks",command:"fireworks",description:()=>Object(n.b)("Sends the given message with fireworks"),fallbackMessage:()=>Object(n.a)("sends fireworks")+" 🎆",options:{maxCount:500,gravity:.05}},{emojis:["❄","🌨"],msgType:"io.element.effect.snowfall",command:"snowfall",description:()=>Object(n.b)("Sends the given message with snowfall"),fallbackMessage:()=>Object(n.a)("sends snowfall")+" ❄",options:{maxCount:200,gravity:.05,maxDrift:5}}]},,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),a=s.n(n),i=s(147),o=s(87),r=s(106),l=s(86),c=s(83);class d extends i.a{constructor(){super(o.a,{}),a()(this,"monitoredUser",void 0),a()(this,"onProfileUpdate",async()=>{const e=await this.matrixClient.getProfileInfo(this.matrixClient.getUserId());await this.updateState({displayName:e.displayname,avatarUrl:e.avatar_url})}),a()(this,"onStateEvents",Object(r.throttle)(async e=>{const t=l.a.get().getUserId();"m.room.member"===e.getType()&&e.getSender()===t&&e.getStateKey()===t&&await this.onProfileUpdate()},200,{trailing:!0,leading:!0}))}static get instance(){return d.internalInstance}get displayName(){return this.matrixClient?this.matrixClient.isGuest()?Object(c.a)("Guest"):this.state.displayName?this.state.displayName:this.matrixClient.getUserId():this.state.displayName||null}get avatarMxc(){return this.state.avatarUrl||null}getHttpAvatarUrl(e=0){if(!this.avatarMxc)return null;const t=e>1?e:void 0;return this.matrixClient.mxcUrlToHttp(this.avatarMxc,t,t)}async onNotReady(){this.monitoredUser&&(this.monitoredUser.removeListener("User.displayName",this.onProfileUpdate),this.monitoredUser.removeListener("User.avatarUrl",this.onProfileUpdate)),this.matrixClient&&this.matrixClient.removeListener("RoomState.events",this.onStateEvents),await this.reset({})}async onReady(){const e=this.matrixClient.getUserId();this.monitoredUser=this.matrixClient.getUser(e),this.monitoredUser&&(this.monitoredUser.on("User.displayName",this.onProfileUpdate),this.monitoredUser.on("User.avatarUrl",this.onProfileUpdate)),this.matrixClient.on("RoomState.events",this.onStateEvents),await this.onProfileUpdate()}async onAction(e){}}a()(d,"internalInstance",new d)},function(e,t,s){"use strict";s.d(t,"d",(function(){return h})),s.d(t,"a",(function(){return u})),s.d(t,"b",(function(){return p})),s.d(t,"c",(function(){return g}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(90),d=s.n(c),m=s(102);const h=e=>{let{label:t,iconClassName:s,active:n,className:i}=e,r=o()(e,["label","iconClassName","active","className"]);return l.a.createElement(m.h,a()({},r,{className:d()(i,{mx_IconizedContextMenu_active:n}),active:n,label:t}),l.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),l.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&l.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},u=e=>{let{label:t,iconClassName:s,active:n,className:i}=e,r=o()(e,["label","iconClassName","active","className"]);return l.a.createElement(m.g,a()({},r,{className:d()(i,{mx_IconizedContextMenu_active:n}),active:n,label:t}),l.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),l.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t),n&&l.a.createElement("span",{className:"mx_IconizedContextMenu_icon mx_IconizedContextMenu_checked"}))},p=e=>{let{label:t,iconClassName:s}=e,n=o()(e,["label","iconClassName"]);return l.a.createElement(m.f,a()({},n,{label:t}),s&&l.a.createElement("span",{className:d()("mx_IconizedContextMenu_icon",s)}),l.a.createElement("span",{className:"mx_IconizedContextMenu_label"},t))},g=({first:e,red:t,className:s,children:n})=>{const a=d()("mx_IconizedContextMenu_optionList",s,{mx_IconizedContextMenu_optionList_notFirst:!e,mx_IconizedContextMenu_optionList_red:t});return l.a.createElement("div",{className:a},n)};t.e=e=>{let{className:t,children:s,compact:n}=e,i=o()(e,["className","children","compact"]);const r=d()("mx_IconizedContextMenu",t,{mx_IconizedContextMenu_compact:n});return l.a.createElement(m.b,a()({chevronFace:m.a.None},i),l.a.createElement("div",{className:r},s))}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return D})),s.d(t,"b",(function(){return M}));var n=s(93),a=s.n(n),i=s(82),o=s.n(i),r=s(238),l=s(81),c=s.n(l),d=s(84),m=s.n(d),h=s(90),u=s.n(h),p=s(124),g=s(83),f=s(334),b=s(85),v=s(87),_=s(88),y=s(95),E=s(130),C=s(86),w=s(342),S=s(343),x=s(97),R=s(198),O=s(300),k=s(132),I=s(199),T=s(173);const j={"m.room.message":"messages.MessageEvent","m.sticker":"messages.MessageEvent","m.key.verification.cancel":"messages.MKeyVerificationConclusion","m.key.verification.done":"messages.MKeyVerificationConclusion","m.room.encryption":"messages.EncryptionEvent","im.vector.room.access_rules":"messages.AccessRulesEvent","m.call.invite":"messages.TextualEvent","m.call.answer":"messages.TextualEvent","m.call.hangup":"messages.TextualEvent","m.call.reject":"messages.TextualEvent"},N={"m.room.encryption":"messages.EncryptionEvent","m.room.canonical_alias":"messages.TextualEvent","m.room.create":"messages.RoomCreate","m.room.member":"messages.TextualEvent","m.room.name":"messages.TextualEvent","m.room.avatar":"messages.RoomAvatarEvent","m.room.third_party_invite":"messages.TextualEvent","m.room.history_visibility":"messages.TextualEvent","m.room.topic":"messages.TextualEvent","m.room.power_levels":"messages.TextualEvent","m.room.pinned_events":"messages.TextualEvent","m.room.server_acl":"messages.TextualEvent","im.vector.modular.widgets":"messages.TextualEvent",[T.c]:"messages.TextualEvent","m.room.tombstone":"messages.TextualEvent","m.room.join_rules":"messages.TextualEvent","m.room.guest_access":"messages.TextualEvent","m.room.related_groups":"messages.TextualEvent","im.vector.room.access_rules":"messages.AccessRulesEvent"};for(const e of w.a)N[e]="messages.TextualEvent";function P(e){const t=e.getType();if("m.room.message"===t){const t=e.getContent();if(t&&"m.key.verification.request"===t.msgtype){const s=C.a.get(),n=s&&s.getUserId();return e.getSender()!==n&&t.to!==n?void 0:"messages.MKeyVerificationRequest"}}if("m.key.verification.done"===t){const t=C.a.get(),s=t&&t.getUserId();if(e.getSender()!==s)return}if("m.key.verification.cancel"===t||"m.key.verification.done"===t){if(!b.getComponent("messages.MKeyVerificationConclusion").prototype._shouldRender.call(null,e,e.request))return}if("im.vector.modular.widgets"===t){let t=e.getContent().type;if(t||(t=e.getPrevContent().type),k.a.JITSI.matches(t))return"messages.MJitsiWidgetEvent"}return e.isState()?N[t]:j[t]}class D extends c.a.Component{constructor(e,t){super(e,t),o()(this,"_onDecrypted",()=>{this._verifyEvent(this.props.mxEvent),this.forceUpdate()}),o()(this,"onDeviceVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this._verifyEvent(this.props.mxEvent)}),o()(this,"onUserVerificationChanged",(e,t)=>{e===this.props.mxEvent.getSender()&&this._verifyEvent(this.props.mxEvent)}),o()(this,"toggleAllReadAvatars",()=>{this.setState({allReadAvatars:!this.state.allReadAvatars})}),o()(this,"onSenderProfileClick",e=>{const t=this.props.mxEvent;v.a.dispatch({action:"insert_mention",user_id:t.getSender()})}),o()(this,"onRequestKeysClick",()=>{this.setState({previouslyRequestedKeys:!0}),this.context.cancelAndResendEventRoomKeyRequest(this.props.mxEvent)}),o()(this,"onPermalinkClicked",e=>{e.preventDefault(),v.a.dispatch({action:"view_room",event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()})}),o()(this,"onActionBarFocusChange",e=>{this.setState({actionBarFocused:e})}),o()(this,"getTile",()=>this._tile.current),o()(this,"getReplyThread",()=>this._replyThread.current),o()(this,"getReactions",()=>{if(!this.props.showReactions||!this.props.getRelationsForEvent)return null;const e=this.props.mxEvent.getId();return e||(console.error("EventTile attempted to get relations for an event without an ID"),console.log(JSON.stringify(this.props.mxEvent,null,4)),console.trace("Stacktrace for https://github.com/vector-im/element-web/issues/11120")),this.props.getRelationsForEvent(e,"m.annotation","m.reaction")}),o()(this,"_onReactionsCreated",(e,t)=>{"m.annotation"===e&&"m.reaction"===t&&(this.props.mxEvent.removeListener("Event.relationsCreated",this._onReactionsCreated),this.setState({reactions:this.getReactions()}))}),this.state={actionBarFocused:!1,allReadAvatars:!1,verified:null,previouslyRequestedKeys:!1,reactions:this.getReactions()},this._suppressReadReceiptAnimation=!0,this._tile=Object(l.createRef)(),this._replyThread=Object(l.createRef)()}UNSAFE_componentWillMount(){this._verifyEvent(this.props.mxEvent)}componentDidMount(){this._suppressReadReceiptAnimation=!1;const e=this.context;e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),e.on("userTrustStatusChanged",this.onUserVerificationChanged),this.props.mxEvent.on("Event.decrypted",this._onDecrypted),this.props.showReactions&&this.props.mxEvent.on("Event.relationsCreated",this._onReactionsCreated)}UNSAFE_componentWillReceiveProps(e){e.eventSendStatus!==this.props.eventSendStatus&&this._verifyEvent(e.mxEvent)}shouldComponentUpdate(e,t){return!S.a(this.state,t)||!this._propsEqual(this.props,e)}componentWillUnmount(){const e=this.context;e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),e.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),this.props.mxEvent.removeListener("Event.decrypted",this._onDecrypted),this.props.showReactions&&this.props.mxEvent.removeListener("Event.relationsCreated",this._onReactionsCreated)}async _verifyEvent(e){if(!e.isEncrypted())return;const t=this.context.getEventEncryptionInfo(e),s=e.getSender(),n=this.context.checkUserTrust(s);if(t.mismatchedSender)return void this.setState({verified:R.a.WARNING},this.props.onHeightChanged);if(!n.isCrossSigningVerified())return void this.setState({verified:R.a.NORMAL},this.props.onHeightChanged);const a=t.sender&&this.context.checkDeviceTrust(s,t.sender.deviceId);a?a.isVerified()?t.authenticated?this.setState({verified:R.a.VERIFIED},this.props.onHeightChanged):this.setState({verified:R.a.UNAUTHENTICATED},this.props.onHeightChanged):this.setState({verified:R.a.WARNING},this.props.onHeightChanged):this.setState({verified:R.a.UNKNOWN},this.props.onHeightChanged)}_propsEqual(e,t){const s=Object.keys(e),n=Object.keys(t);if(s.length!==n.length)return!1;for(let n=0;n<s.length;n++){const a=s[n];if(!t.hasOwnProperty(a))return!1;if("readReceipts"===a){const s=e[a],n=t[a];if(s===n)continue;if(!s||!n)return!1;if(s.length!==n.length)return!1;for(let e=0;e<s.length;e++){if(s[e].userId!==n[e].userId)return!1;if(s[e].roomMember!==n[e].roomMember)return!1}}else if(e[a]!==t[a])return!1}return!0}shouldHighlight(){const e=this.context.getPushActionsForEvent(this.props.mxEvent.replacingEvent()||this.props.mxEvent);return!(!e||!e.tweaks)&&(this.props.mxEvent.getSender()!==this.context.credentials.userId&&e.tweaks.highlight)}getReadAvatars(){if(!this.props.readReceipts||0===this.props.readReceipts.length)return c.a.createElement("span",{className:"mx_EventTile_readAvatars"});const e=b.getComponent("rooms.ReadReceiptMarker"),t=[];let s=0;const n=this.props.readReceipts||[];for(let a=0;a<n.length;++a){const i=n[a];let o=!0;(a<5||this.state.allReadAvatars)&&(o=!1),s=-15*(o?4:a);const r=i.userId;let l;this.props.readReceiptMap&&(l=this.props.readReceiptMap[r],l||(l={},this.props.readReceiptMap[r]=l)),t.unshift(c.a.createElement(e,{key:r,member:i.roomMember,fallbackUserId:r,leftOffset:s,hidden:o,readReceiptInfo:l,checkUnmounting:this.props.checkUnmounting,suppressAnimation:this._suppressReadReceiptAnimation,onClick:this.toggleAllReadAvatars,timestamp:i.ts,showTwelveHour:this.props.isTwelveHour}))}let a;if(!this.state.allReadAvatars){const e=n.length-5;e>0&&(a=c.a.createElement("span",{className:"mx_EventTile_readAvatarRemainder",onClick:this.toggleAllReadAvatars,style:{right:"calc("+Object(O.b)(-s)+" + 15px)"}},e,"+"))}return c.a.createElement("span",{className:"mx_EventTile_readAvatars"},a,t)}_renderE2EPadlock(){const e=this.props.mxEvent;if("m.bad.encrypted"===e.getContent().msgtype)return c.a.createElement(L,null);if(e.isEncrypted())return this.state.verified===R.a.NORMAL||this.state.verified===R.a.VERIFIED?void 0:this.state.verified===R.a.UNAUTHENTICATED?c.a.createElement(W,null):this.state.verified===R.a.UNKNOWN?c.a.createElement(V,null):c.a.createElement(F,null);if(this.context.isRoomEncrypted(e.getRoomId())){if(e.status===y.b.ENCRYPTING)return;if(e.status===y.b.NOT_SENT)return;if(e.isState())return;return c.a.createElement(B,null)}return null}render(){const e=b.getComponent("messages.MessageTimestamp"),t=b.getComponent("messages.SenderProfile"),s=b.getComponent("avatars.MemberAvatar"),n=this.props.mxEvent.getContent().msgtype,a=this.props.mxEvent.getType();let i=P(this.props.mxEvent);const o=a.startsWith("m.key.verification")||a===p.a.RoomMessage&&n&&n.startsWith("m.key.verification")||a===p.a.RoomCreate||a===p.a.RoomEncryption||"messages.MJitsiWidgetEvent"===i||"im.vector.room.access_rules"===this.props.mxEvent.getType()&&"unrestricted"===this.props.mxEvent.getContent().rule;let l=!o&&a!==p.a.RoomMessage&&a!==p.a.Sticker&&a!==p.a.RoomCreate;if(_.a.getValue("showHiddenEventsInTimeline")&&!M(this.props.mxEvent)&&(i="messages.ViewSourceEvent",l=!0),!i){const{mxEvent:e}=this.props;return console.warn(`Event type not supported: type:${e.getType()} isState:${e.isState()}`),c.a.createElement("div",{className:"mx_EventTile mx_EventTile_info mx_MNoticeBody"},c.a.createElement("div",{className:"mx_EventTile_line"},Object(g.a)("This event could not be displayed")))}const d=b.getComponent(i),m=-1!==["sending","queued","encrypting"].indexOf(this.props.eventSendStatus),h=U(this.props.mxEvent)&&this.props.isRedacted,f=this.props.mxEvent.isDecryptionFailure(),v=!!this.props.editState,y=u()({mx_EventTile_bubbleContainer:o,mx_EventTile:!0,mx_EventTile_isEditing:v,mx_EventTile_info:l,mx_EventTile_12hr:this.props.isTwelveHour,mx_EventTile_encrypting:"encrypting"===this.props.eventSendStatus,mx_EventTile_sending:!v&&m,mx_EventTile_notSent:"not_sent"===this.props.eventSendStatus,mx_EventTile_highlight:"notif"!==this.props.tileShape&&this.shouldHighlight(),mx_EventTile_selected:this.props.isSelectedEvent,mx_EventTile_continuation:this.props.tileShape?"":this.props.continuation,mx_EventTile_last:this.props.last,mx_EventTile_lastInSection:this.props.lastInSection,mx_EventTile_contextual:this.props.contextual,mx_EventTile_actionBarFocused:this.state.actionBarFocused,mx_EventTile_verified:!o&&this.state.verified===R.a.VERIFIED,mx_EventTile_unverified:!o&&this.state.verified===R.a.WARNING,mx_EventTile_unknown:!o&&this.state.verified===R.a.UNKNOWN,mx_EventTile_bad:f,mx_EventTile_emote:"m.emote"===n}),C=null!==this.props.eventSendStatus?"off":void 0;let w="#";this.props.permalinkCreator&&(w=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const S=this.getReadAvatars();let x,O,k,T;if("notif"===this.props.tileShape?(k=24,T=!0):"messages.RoomCreate"===i||o?(k=0,T=!1):l?(k=14,T=!1):this.props.useIRCLayout?(k=14,T=!0):this.props.continuation&&"file_grid"!==this.props.tileShape?(k=0,T=!1):(k=30,T=!0),this.props.mxEvent.sender&&k){let e;e=this.props.mxEvent.getContent().third_party_invite?this.props.mxEvent.target:this.props.mxEvent.sender,x=c.a.createElement("div",{className:"mx_EventTile_avatar"},c.a.createElement(s,{member:e,width:k,height:k,viewUserOnClick:!0}))}if(T){let e=null;this.props.tileShape&&"reply"!==this.props.tileShape&&"reply_preview"!==this.props.tileShape?O=c.a.createElement(t,{mxEvent:this.props.mxEvent,enableFlair:this.props.enableFlair}):("m.image"===n?e=Object(g.b)("%(senderName)s sent an image"):"m.video"===n?e=Object(g.b)("%(senderName)s sent a video"):"m.file"===n&&(e=Object(g.b)("%(senderName)s uploaded a file")),O=c.a.createElement(t,{onClick:this.onSenderProfileClick,mxEvent:this.props.mxEvent,enableFlair:this.props.enableFlair&&!e,text:e}))}const j=b.getComponent("messages.MessageActionBar");let N;this.props.mxEvent.isState()||v||(N=c.a.createElement(j,{mxEvent:this.props.mxEvent,reactions:this.state.reactions,permalinkCreator:this.props.permalinkCreator,getTile:this.getTile,getReplyThread:this.getReplyThread,onFocusChange:this.onActionBarFocusChange}));const D=this.props.mxEvent.getTs()?c.a.createElement(e,{showTwelveHour:this.props.isTwelveHour,ts:this.props.mxEvent.getTs()}):null,A=c.a.createElement("div",{className:"mx_EventTile_keyRequestInfo_tooltip_contents"},c.a.createElement("p",null,this.state.previouslyRequestedKeys?Object(g.a)("Your key share request has been sent - please check your other devices for key share requests."):Object(g.a)("Key share requests are sent to your other devices automatically. If you rejected or dismissed the key share request on your other devices, click here to request the keys for this device again.")),c.a.createElement("p",null,Object(g.a)("If your other devices do not have the key for this message you will not be able to decrypt them."))),L=this.state.previouslyRequestedKeys?Object(g.a)("Request in progress…"):Object(g.a)("Request sent. <requestLink>Resend</requestLink>.",{},{requestLink:e=>c.a.createElement("a",{onClick:this.onRequestKeysClick},e)}),F=b.getComponent("elements.TooltipButton"),B=f?c.a.createElement("div",{className:"mx_EventTile_keyRequestInfo"},c.a.createElement("span",{className:"mx_EventTile_keyRequestInfo_text"},L),c.a.createElement(F,{helpText:A})):null;let V;if(!h){const e=b.getComponent("messages.ReactionsRow");V=c.a.createElement(e,{mxEvent:this.props.mxEvent,reactions:this.state.reactions})}const W=c.a.createElement("a",{href:w,onClick:this.onPermalinkClicked,"aria-label":Object(E.d)(new Date(this.props.mxEvent.getTs()),this.props.isTwelveHour)},D),H=this.props.useIRCLayout?null:W,G=this.props.useIRCLayout?W:null;!this.props.useIRCLayout&&!o&&this._renderE2EPadlock(),this.props.useIRCLayout&&!o&&this._renderE2EPadlock();switch(this.props.tileShape){case"notif":{const e=this.context.getRoom(this.props.mxEvent.getRoomId());return c.a.createElement("div",{className:y,"aria-live":C,"aria-atomic":"true"},c.a.createElement("div",{className:"mx_EventTile_roomName"},c.a.createElement(I.a,{room:e,width:28,height:28}),c.a.createElement("a",{href:w,onClick:this.onPermalinkClicked},e?e.name:"")),c.a.createElement("div",{className:"mx_EventTile_senderDetails"},x,c.a.createElement("a",{href:w,onClick:this.onPermalinkClicked},O,D)),c.a.createElement("div",{className:"mx_EventTile_line"},c.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged})))}case"file_grid":return c.a.createElement("div",{className:y,"aria-live":C,"aria-atomic":"true"},c.a.createElement("div",{className:"mx_EventTile_line"},c.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,onHeightChanged:this.props.onHeightChanged})),c.a.createElement("a",{className:"mx_EventTile_senderDetailsLink",href:w,onClick:this.onPermalinkClicked},c.a.createElement("div",{className:"mx_EventTile_senderDetails"},O,D)));case"reply":case"reply_preview":{let e;return"reply_preview"===this.props.tileShape&&(e=r.a.makeThread(this.props.mxEvent,this.props.onHeightChanged,this.props.permalinkCreator,this._replyThread)),c.a.createElement("div",{className:y,"aria-live":C,"aria-atomic":"true"},G,x,O,c.a.createElement("div",{className:"mx_EventTile_reply"},H,e,c.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,onHeightChanged:this.props.onHeightChanged,replacingEventId:this.props.replacingEventId,showUrlPreview:!1})))}default:{const e=r.a.makeThread(this.props.mxEvent,this.props.onHeightChanged,this.props.permalinkCreator,this._replyThread,this.props.useIRCLayout);return c.a.createElement("div",{className:y,tabIndex:-1,"aria-live":C,"aria-atomic":"true"},G,c.a.createElement("div",{className:"mx_EventTile_msgOption"},S),O,c.a.createElement("div",{className:"mx_EventTile_line"},H,e,c.a.createElement(d,{ref:this._tile,mxEvent:this.props.mxEvent,replacingEventId:this.props.replacingEventId,editState:this.props.editState,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,onHeightChanged:this.props.onHeightChanged}),B,V,N),x)}}}}o()(D,"propTypes",{mxEvent:m.a.object.isRequired,isRedacted:m.a.bool,continuation:m.a.bool,last:m.a.bool,lastInSection:m.a.bool,contextual:m.a.bool,highlights:m.a.array,highlightLink:m.a.string,showUrlPreview:m.a.bool,isSelectedEvent:m.a.bool,onHeightChanged:m.a.func,readReceipts:m.a.arrayOf(m.a.object),readReceiptMap:m.a.object,checkUnmounting:m.a.func,eventSendStatus:m.a.string,tileShape:m.a.string,isTwelveHour:m.a.bool,getRelationsForEvent:m.a.func,showReactions:m.a.bool,useIRCLayout:m.a.bool,enableFlair:m.a.bool}),o()(D,"defaultProps",{onHeightChanged:function(){}}),o()(D,"contextType",x.a);const A=["m.room.message","m.sticker"];function U(e){return A.includes(e.getType())}function M(e){if(e.isRedacted()&&!U(e))return!1;if(e.isRelation("m.replace"))return!1;if("im.vector.room.access_rules"===e.getType()&&"restricted"===e.event.content.rule)return!1;const t=P(e);return void 0!==t&&("messages.TextualEvent"===t?""!==f.a(e):"messages.RoomCreate"!==t||Boolean(e.getContent().predecessor))}function L(e){return c.a.createElement(H,a()({title:Object(g.a)("This message cannot be decrypted"),icon:"undecryptable"},e))}function F(e){return c.a.createElement(H,a()({title:Object(g.a)("Encrypted by an unverified session"),icon:"unverified"},e))}function B(e){return c.a.createElement(H,a()({title:Object(g.a)("Unencrypted"),icon:"unencrypted"},e))}function V(e){return c.a.createElement(H,a()({title:Object(g.a)("Encrypted by a deleted session"),icon:"unknown"},e))}function W(e){return c.a.createElement(H,a()({title:Object(g.a)("The authenticity of this encrypted message can't be guaranteed on this device."),icon:"unauthenticated"},e))}class H extends c.a.Component{constructor(){super(),o()(this,"onHoverStart",()=>{this.setState({hover:!0})}),o()(this,"onHoverEnd",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){let e=null;if(this.state.hover){const t=b.getComponent("elements.Tooltip");e=c.a.createElement(t,{className:"mx_EventTile_e2eIcon_tooltip",label:this.props.title,dir:"auto"})}const t="mx_EventTile_e2eIcon mx_EventTile_e2eIcon_"+this.props.icon;return c.a.createElement("div",{className:t,onClick:this.onClick,onMouseEnter:this.onHoverStart,onMouseLeave:this.onHoverEnd},e)}}o()(H,"propTypes",{icon:m.a.string.isRequired,title:m.a.string.isRequired})},,,,,,function(e,t,s){"use strict";(function(e){var n=s(107),a=s(1140),i=s(86),o=s(88),r=s(96);class l{constructor(){this.index=null,this._supportIsInstalled=!1}async init(){const e=n.a.get().getEventIndexingManager();return e?(this._supportIsInstalled=await e.supportsEventIndexing(),this.supportIsInstalled()?o.a.getValueAt(r.a.DEVICE,"enableEventIndexing")?this.initEventIndex():(console.log("EventIndex: Event indexing is disabled, not initializing"),!1):(console.log("EventIndex: Event indexing isn't installed for the platform, not initializing."),!1)):(console.log("EventIndex: Platform doesn't support event indexing, not initializing."),!1)}async initEventIndex(){const e=new a.a,t=n.a.get().getEventIndexingManager(),s=i.a.get(),o=s.getUserId(),r=s.getDeviceId();try{await t.initEventIndex(o,r);const s=await t.getUserVersion(),n=await t.isEventIndexEmpty();n?await t.setUserVersion(1):0!==s||n||(await t.closeEventIndex(),await this.deleteEventIndex(),await t.initEventIndex(o,r),await t.setUserVersion(1)),console.log("EventIndex: Successfully initialized the event index"),await e.init()}catch(e){return console.log("EventIndex: Error initializing the event index",e),!1}return this.index=e,!0}platformHasSupport(){return null!==n.a.get().getEventIndexingManager()}supportIsInstalled(){return this._supportIsInstalled}get(){return this.index}start(){null!==this.index&&this.index.startCrawler()}stop(){null!==this.index&&this.index.stopCrawler()}async unset(){null!==this.index&&(await this.index.close(),this.index=null)}async deleteEventIndex(){const e=n.a.get().getEventIndexingManager();null!==e&&(await this.unset(),console.log("EventIndex: Deleting event index."),await e.deleteEventIndex())}}e.mxEventIndexPeg||(e.mxEventIndexPeg=new l),t.a=e.mxEventIndexPeg}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(95),a=s(86),i=(s(89),s(85),s(83),s(285)),o=s(281);s(288);class r extends Error{}class l{constructor(e=null){this.accessToken=null,this.authEnabled=!0,this.tempClient=e?Object(n.p)({baseUrl:"",idBaseUrl:e}):null}get _matrixClient(){return this.tempClient?this.tempClient:a.a.get()}_writeToken(){this.tempClient||window.localStorage.setItem("mx_is_access_token",this.accessToken)}_readToken(){return this.tempClient?null:window.localStorage.getItem("mx_is_access_token")}hasCredentials(){return null!=this.accessToken}async getAccessToken({check:e=!1}={}){if(!this.authEnabled)return null;let t=this.accessToken;if(t||(t=this._readToken()),!t)return t=await this.registerForToken(e),t&&(this.accessToken=t,this._writeToken()),t;if(e)try{await this._checkToken(t)}catch(e){if(e instanceof i.b||e instanceof r)throw e;t=await this.registerForToken(),t&&(this.accessToken=t,this._writeToken())}return t}async _checkToken(e){const t=this._matrixClient.getIdentityServerUrl();try{await this._matrixClient.getIdentityAccount(e)}catch(s){if("M_TERMS_NOT_SIGNED"===s.errcode)return console.log("Identity Server requires new terms to be agreed to"),void await Object(i.d)([new i.a(n.m.IS,t,e)]);throw s}this.tempClient||Object(o.a)()||await Object(o.b)(t)||Object(o.d)()}async registerForToken(e=!0){const t=await a.a.get().getOpenIdToken(),{access_token:s,token:n}=await this._matrixClient.registerWithIdentityServer(t),i=n||s;return e&&await this._checkToken(i),i}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(81),a=s.n(n),i=s(83),o=s(88);class r extends a.a.Component{render(){const e=this.props.w||16,t=this.props.h||16,n=this.props.imgClassName||"";let r;return r=o.a.getValue("feature_new_spinner")?s(653):s(247),a.a.createElement("div",{className:"mx_InlineSpinner"},a.a.createElement("img",{src:r,width:e,height:t,className:n,"aria-label":Object(i.a)("Loading...")}))}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(81),a=s.n(n),i=s(90),o=s.n(i),r=s(119),l=s(83),c=s(91),d=s(87),m=s(94);const h=({className:e,title:t,children:s})=>a.a.createElement("div",{className:o()("mx_BaseCard_Group",e)},a.a.createElement("h1",null,t),s);t.b=({closeLabel:e,onClose:t,className:s,header:n,footer:i,withoutScrollContainer:h,previousPhase:u,children:p,refireParams:g})=>{let f,b;if(u){const e=()=>{d.a.dispatch({action:m.a.SetRightPanelPhase,phase:u,refireParams:g})};f=a.a.createElement(c.a,{className:"mx_BaseCard_back",onClick:e,title:Object(l.a)("Back")})}return t&&(b=a.a.createElement(c.a,{className:"mx_BaseCard_close",onClick:t,title:e||Object(l.a)("Close")})),h||(p=a.a.createElement(r.a,null,p)),a.a.createElement("div",{className:o()("mx_BaseCard",s)},a.a.createElement("div",{className:"mx_BaseCard_header"},f,b,n),p,i&&a.a.createElement("div",{className:"mx_BaseCard_footer"},i))}},,,,function(e,t){e.exports="img/cancel.4b9715b.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(82),l=s.n(r),c=s(81),d=s.n(c),m=s(90),h=s.n(m);class u extends d.a.PureComponent{render(){const e=this.props,{children:t,className:s,disabled:n,outlined:i}=e,r=o()(e,["children","className","disabled","outlined"]),l=h()("mx_RadioButton",s,{mx_RadioButton_disabled:n,mx_RadioButton_enabled:!n,mx_RadioButton_checked:this.props.checked,mx_RadioButton_outlined:i});return d.a.createElement("label",{className:l},d.a.createElement("input",a()({type:"radio",disabled:n},r)),d.a.createElement("div",null,d.a.createElement("div",null)),d.a.createElement("div",{className:"mx_RadioButton_content"},t),d.a.createElement("div",{className:"mx_RadioButton_spacer"}))}}l()(u,"defaultProps",{className:""})},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"c",(function(){return c})),s.d(t,"d",(function(){return m})),s.d(t,"e",(function(){return h})),s.d(t,"b",(function(){return u}));var n=s(133),a=s(86),i=s(109),o=s(98),r=s(169);function l(e,t,s,n){let i;return e&&e.getAvatarUrl&&(i=e.getAvatarUrl(a.a.get().getHomeserverUrl(),Math.floor(t*window.devicePixelRatio),Math.floor(s*window.devicePixelRatio),n,!1,!1)),i||(i=m(e?e.userId:"")),r.a.getUnencryptedContentUrl({url:o.a.imgUrlToUri(i)},!0)}function c(e,t,s,i){const l=Object(n.a)(a.a.get().getHomeserverUrl(),e.avatarUrl,Math.floor(t*window.devicePixelRatio),Math.floor(s*window.devicePixelRatio),i);return l&&0!==l.length?r.a.getUnencryptedContentUrl({url:o.a.imgUrlToUri(l)},!0):null}const d=new Map;function m(e){if(!e)return"";const t=["#8B8999"];let s=0;for(let t=0;t<e.length;++t)s+=e.charCodeAt(t);const n=s%t.length,a="--avatar-background-colors_"+n,i=document.body.style.getPropertyValue(a)||t[n];let o=d.get(i);return o||(!function(e){return"string"==typeof e&&(7===e.length||9===e.length)&&"#"===e.charAt(0)&&!e.substr(1).split("").some(e=>isNaN(parseInt(e,16)))}(i)?o="":(o=function(e){const t=document.createElement("canvas");t.width=40,t.height=40;const s=t.getContext("2d");return s?(s.fillStyle=e,s.fillRect(0,0,40,40),t.toDataURL()):""}(i),d.set(i,o))),o}function h(e){if(!e)return void console.trace("`name` argument to `getInitialLetter` not supplied");if(e.length<1)return;let t=0;const s=e[0];"@"!==s&&"#"!==s&&"+"!==s||!e[1]||t++;let n=1;const a=e.charCodeAt(t);if(a>=55296&&a<=56319&&e[t+1]){const s=e.charCodeAt(t+1);s>=56320&&s<=57343&&n++}return e.substring(t,t+n).toUpperCase()}function u(e,t,s,n){if(!e)return null;const l=e.getAvatarUrl(a.a.get().getHomeserverUrl(),t,s,n,!1);if(l)return r.a.getUnencryptedContentUrl({url:o.a.imgUrlToUri(l)},!0);let c=null;const d=i.a.shared().getUserIdForRoomId(e.roomId);if(c=d?e.getMember(d):e.getAvatarFallbackMember(),c){const e=c.getAvatarUrl(a.a.get().getHomeserverUrl(),t,s,n,!1);return e?r.a.getUnencryptedContentUrl({url:o.a.imgUrlToUri(e)},!0):null}return null}},function(e,t,s){"use strict";var n=s(81);const a=Object(n.createContext)({roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!1,numUnreadMessages:0,draggingFile:!1,searching:!1,guestsCanJoin:!1,canPeek:!1,showApps:!1,isPeeking:!1,showingPinned:!1,showReadReceipts:!0,showRightPanel:!0,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,useIRCLayout:!1,matrixClientIsReady:!1});a.displayName="RoomContext",t.a=a},,,,,,,,,,function(e,t,s){"use strict";let n,a;s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a})),function(e){e.Manual="MANUAL",e.Alphabetic="ALPHABETIC",e.Recent="RECENT"}(n||(n={})),function(e){e.Importance="IMPORTANCE",e.Natural="NATURAL"}(a||(a={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return S}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(85),l=s(83),c=s(84),d=s.n(c),m=s(87),h=s(130),u=s(95),p=s(110),g=s(88),f=s(968),b=s.n(f),v=s(97),_=s(94),y=s(330),E=s.n(y),C=s(108),w=s(121);class S extends o.a.Component{constructor(e,t){super(e,t),a()(this,"updateForEventId",e=>{this.state.events.some(t=>t.getId()===e)&&this.forceUpdate()}),a()(this,"onEventReplaced",e=>{this.unmounted||this.updateForEventId(e.getId())}),a()(this,"onRoomRedaction",e=>{if(this.unmounted)return;const t=e.getAssociatedId();t&&this.updateForEventId(t)}),this.state={events:[],loadedEv:null,loading:!0,err:!1},this.unmounted=!1,this.context.on("Event.replaced",this.onEventReplaced),this.room=this.context.getRoom(this.props.parentEv.getRoomId()),this.room.on("Room.redaction",this.onRoomRedaction),this.room.on("Room.redactionCancelled",this.onRoomRedaction),this.onQuoteClick=this.onQuoteClick.bind(this),this.canCollapse=this.canCollapse.bind(this),this.collapse=this.collapse.bind(this)}static getParentEventId(e){if(!e||e.isRedacted())return;const t=e.getWireContent()["m.relates_to"];if(t&&t["m.in_reply_to"]){const e=t["m.in_reply_to"];if(e&&e.event_id)return e.event_id}}static stripPlainReply(e){if(!e)return;const t=e.split("\n");for(;t.length&&t[0].startsWith("> ");)t.shift();return""===t[0]&&t.shift(),t.join("\n")}static stripHTMLReply(e){return E()(e,{allowedTags:!1,allowedAttributes:!1,allowedSchemes:[...w.a,"mxc"],exclusiveFilter:e=>"mx-reply"===e.tag})}static getNestedReplyText(e,t){if(!e)return null;let{body:s,formatted_body:n}=e.getContent();this.getParentEventId(e)&&s&&(s=this.stripPlainReply(s)),s||(s=""),n=n?this.stripHTMLReply(n):b()(s).replace(/\n/g,"<br/>");const a=t.forEvent(e.getId()),i=Object(p.g)(e.getSender()),o=e.getSender();switch(e.getContent().msgtype){case"m.text":case"m.notice":{n=`<mx-reply><blockquote><a href="${a}">In reply to</a> <a href="${i}">${o}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`<${o}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}case"m.image":n=`<mx-reply><blockquote><a href="${a}">In reply to</a> <a href="${i}">${o}</a><br>sent an image.</blockquote></mx-reply>`,s=`> <${o}> sent an image.\n\n`;break;case"m.video":n=`<mx-reply><blockquote><a href="${a}">In reply to</a> <a href="${i}">${o}</a><br>sent a video.</blockquote></mx-reply>`,s=`> <${o}> sent a video.\n\n`;break;case"m.audio":n=`<mx-reply><blockquote><a href="${a}">In reply to</a> <a href="${i}">${o}</a><br>sent an audio file.</blockquote></mx-reply>`,s=`> <${o}> sent an audio file.\n\n`;break;case"m.file":n=`<mx-reply><blockquote><a href="${a}">In reply to</a> <a href="${i}">${o}</a><br>sent a file.</blockquote></mx-reply>`,s=`> <${o}> sent a file.\n\n`;break;case"m.emote":{n=`<mx-reply><blockquote><a href="${a}">In reply to</a> * <a href="${i}">${o}</a><br>${n}</blockquote></mx-reply>`;const e=s.trim().split("\n");e.length>0&&(e[0]=`* <${o}> ${e[0]}`,s=e.map(e=>"> "+e).join("\n")+"\n\n");break}default:return null}return{body:s,html:n}}static makeReplyMixIn(e){return e?{"m.relates_to":{"m.in_reply_to":{event_id:e.getId()}}}:{}}static makeThread(e,t,s,n,a){return S.getParentEventId(e)?o.a.createElement(S,{parentEv:e,onHeightChanged:t,ref:n,permalinkCreator:s,useIRCLayout:a}):o.a.createElement("div",{className:"mx_ReplyThread_wrapper_empty"})}componentDidMount(){this.initialize()}componentDidUpdate(){this.props.onHeightChanged()}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("Event.replaced",this.onEventReplaced),this.room&&(this.room.removeListener("Room.redaction",this.onRoomRedaction),this.room.removeListener("Room.redactionCancelled",this.onRoomRedaction))}async initialize(){const{parentEv:e}=this.props,t=await this.getEvent(S.getParentEventId(e));this.unmounted||(t?this.setState({events:[t]},this.loadNextEvent):this.setState({err:!0}))}async loadNextEvent(){if(this.unmounted)return;const e=this.state.events[0],t=S.getParentEventId(e);if(!t)return void this.setState({loading:!1});const s=await this.getEvent(t);this.unmounted||(s?this.setState({loadedEv:s}):this.setState({err:!0}))}async getEvent(e){const t=this.room.findEventById(e);if(t)return t;try{await this.context.getEventTimeline(this.room.getUnfilteredTimelineSet(),e)}catch(e){return null}return this.room.findEventById(e)}canCollapse(){return this.state.events.length>1}collapse(){this.initialize()}onQuoteClick(){const e=[this.state.loadedEv,...this.state.events];this.setState({loadedEv:null,events:e},this.loadNextEvent),m.a.fire(_.a.FocusComposer)}render(){let e=null;if(this.state.err)e=o.a.createElement("blockquote",{className:"mx_ReplyThread mx_ReplyThread_error"},Object(l.a)("Unable to load event that was replied to, it either does not exist or you do not have permission to view it."));else if(this.state.loadedEv){const t=this.state.loadedEv,s=r.getComponent("elements.Pill"),n=this.context.getRoom(t.getRoomId());e=o.a.createElement("blockquote",{className:"mx_ReplyThread"},Object(l.a)("<a>In reply to</a> <pill>",{},{a:e=>o.a.createElement("a",{onClick:this.onQuoteClick,className:"mx_ReplyThread_show"},e),pill:o.a.createElement(s,{type:s.TYPE_USER_MENTION,room:n,url:Object(p.g)(t.getSender()),shouldShowPillAvatar:g.a.getValue("Pill.shouldShowPillAvatar")})}))}else if(this.state.loading){const t=r.getComponent("elements.Spinner");e=o.a.createElement(t,{w:16,h:16})}const t=r.getComponent("views.rooms.EventTile"),s=r.getComponent("messages.DateSeparator"),n=this.state.events.map(e=>{let n=null;return Object(h.e)(this.props.parentEv.getDate(),e.getDate())&&(n=o.a.createElement("a",{href:this.props.url},o.a.createElement(s,{ts:e.getTs()}))),o.a.createElement("blockquote",{className:"mx_ReplyThread",key:e.getId()},n,o.a.createElement(t,{mxEvent:e,tileShape:"reply",onHeightChanged:this.props.onHeightChanged,permalinkCreator:this.props.permalinkCreator,isRedacted:e.isRedacted(),isTwelveHour:g.a.getValue("showTwelveHourTimestamps"),useIRCLayout:this.props.useIRCLayout,enableFlair:g.a.getValue(C.a.Flair),replacingEventId:e.replacingEventId()}))});return o.a.createElement("div",{className:"mx_ReplyThread_wrapper"},o.a.createElement("div",null,e),o.a.createElement("div",null,n))}}a()(S,"propTypes",{parentEv:d.a.instanceOf(u.j),onHeightChanged:d.a.func.isRequired,permalinkCreator:d.a.instanceOf(p.a).isRequired,useIRCLayout:d.a.bool}),a()(S,"contextType",v.a)},,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c})),s.d(t,"c",(function(){return d}));var n=s(84),a=s.n(n);const i=/^\S+@\S+\.\S+$/,o=/^@\S+:\S+$/,r=/^!\S+:\S+$/,l=["mx-user-id","mx-room-id","email"],c=a.a.shape({addressType:a.a.oneOf(l).isRequired,address:a.a.string.isRequired,displayName:a.a.string,avatarMxc:a.a.string,isKnown:a.a.bool});function d(e){const t=i.test(e),s=o.test(e),n=r.test(e);return t?"email":s?"mx-user-id":n?"mx-room-id":null}},function(e,t,s){"use strict";var n=s(6),a=s.n(n);s(132);class i extends a.a{constructor(){super(),this._roomWidgetEcho={}}getEchoedRoomWidgets(e,t){const s=[],n=Object.assign({},this._roomWidgetEcho[e]);for(const e of t){const t=e.getStateKey();n[t]&&0===Object.keys(n[t]).length||s.push(e),delete n[t]}return s}roomHasPendingWidgetsOfType(e,t,s){const n=Object.assign({},this._roomWidgetEcho[e]);for(const e of t){delete n[e.getStateKey()]}return void 0===s?Object.keys(n).length>0:Object.values(n).some(e=>s.matches(e.type))}roomHasPendingWidgets(e,t){return this.roomHasPendingWidgetsOfType(e,t)}setRoomWidgetEcho(e,t,s){void 0===this._roomWidgetEcho[e]&&(this._roomWidgetEcho[e]={}),this._roomWidgetEcho[e][t]=s,this.emit("update",e,t)}removeRoomWidgetEcho(e,t){delete this._roomWidgetEcho[e][t],0===Object.keys(this._roomWidgetEcho[e]).length&&delete this._roomWidgetEcho[e],this.emit("update",e,t)}}let o=null;o||(o=new i),t.a=o},function(e,t,s){"use strict";(function(e){var n=s(6),a=s.n(n),i=s(86),o=s(260);class r extends a.a{constructor(){super(),this._persistentWidgetId=null,this._roomIdByWidgetId={},this.onRoomStateEvents=this.onRoomStateEvents.bind(this),this.dispatcherRef=null}start(){i.a.get().on("RoomState.events",this.onRoomStateEvents)}stop(){i.a.get()&&i.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this._roomIdByWidgetId={}}onRoomStateEvents(e,t){"im.vector.modular.widgets"===e.getType()&&e.getStateKey()===this._persistentWidgetId&&this.destroyPersistentWidget(this._persistentWidgetId)}destroyPersistentWidget(e){if(e!==this._persistentWidgetId)return;const t=this._persistentWidgetId;o.a.instance.stopMessagingById(e),this.setWidgetPersistence(t,!1),this.delRoomId(t)}setWidgetPersistence(e,t){this._persistentWidgetId!==e||t?this._persistentWidgetId!==e&&t&&(this._persistentWidgetId=e):this._persistentWidgetId=null,this.emit("update")}getWidgetPersistence(e){return this._persistentWidgetId===e}getPersistentWidgetId(){return this._persistentWidgetId}getRoomId(e){return this._roomIdByWidgetId[e]}setRoomId(e,t){this._roomIdByWidgetId[e]=t,this.emit("update")}delRoomId(e){delete this._roomIdByWidgetId[e],this.emit("update")}}void 0===e.singletonActiveWidgetStore&&(e.singletonActiveWidgetStore=new r),t.a=e.singletonActiveWidgetStore}).call(this,s(5))},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e[e.None=0]="None",e[e.Bold=1]="Bold",e[e.Grey=2]="Grey",e[e.Red=3]="Red"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return l}));var n=s(82),a=s.n(n),i=s(6),o=s(245);const r="update";class l extends i.EventEmitter{constructor(...e){super(...e),a()(this,"_symbol",void 0),a()(this,"_count",void 0),a()(this,"_color",void 0)}get symbol(){return this._symbol}get count(){return this._count}get color(){return this._color}get isIdle(){return this.color<=o.a.None}get isUnread(){return this.color>=o.a.Bold}get hasUnreadCount(){return this.color>=o.a.Grey&&(!!this.count||!!this.symbol)}get hasMentions(){return this.color>=o.a.Red}emitIfUpdated(e){e.isDifferentFrom(this)&&this.emit(r)}snapshot(){return new c(this)}destroy(){this.removeAllListeners(r)}}class c{constructor(e){a()(this,"symbol",void 0),a()(this,"count",void 0),a()(this,"color",void 0),this.symbol=e.symbol,this.count=e.count,this.color=e.color}isDifferentFrom(e){const t={count:this.count,symbol:this.symbol,color:this.color},s={count:e.count,symbol:e.symbol,color:e.color};return JSON.stringify(t)!==JSON.stringify(s)}}},function(e,t){e.exports="img/spinner.0b29ec9.gif"},function(e,t,s){"use strict";t.a={}},function(e,t,s){"use strict";s.r(t),function(e){s.d(t,"Notifier",(function(){return y}));var n=s(86),a=s(92),i=s(107),o=s(334),r=s(116),l=s(226),c=s(87),d=s(85),m=s(83),h=s(89),u=s(88),p=s(449),g=s(96),f=s(659),b=s(128),v=s(451);const _={"m.key.verification.request":e=>{const t=(e.sender||{}).name;return Object(m.a)("%(name)s is requesting verification",{name:t})}},y={notifsByRoom:{},pendingEncryptedEventIds:[],notificationMessageForEvent:function(e){return _.hasOwnProperty(e.getContent().msgtype)?_[e.getContent().msgtype](e):o.a(e)},_displayPopupNotification:function(t,s){const n=i.a.get();if(!n)return;if(!n.supportsNotifications()||!n.maySendNotifications())return;if(e.document.hasFocus())return;let a,o=this.notificationMessageForEvent(t);if(!o)return;t.sender&&s.name!==t.sender.name?"m.room.member"===t.getType()?a=s.name:t.sender&&(a=t.sender.name+" ("+s.name+")",t.getContent().body&&!_.hasOwnProperty(t.getContent().msgtype)&&(o=t.getContent().body)):(a=s.name,t.getContent().body&&!_.hasOwnProperty(t.getContent().msgtype)&&(o=t.getContent().body)),this.isBodyEnabled()||(o="");let r=null;t.sender&&!u.a.getValue("lowBandwidth")&&(r=l.a(t.sender,40,40,"crop"));const c=n.displayNotification(a,o,r,s);c&&(void 0===this.notifsByRoom[t.getRoomId()]&&(this.notifsByRoom[t.getRoomId()]=[]),this.notifsByRoom[t.getRoomId()].push(c))},getSoundForRoom:function(e){const t=u.a.getValue("notificationSound",e);return t?t.url?t.url.startsWith("mxc://")?{url:n.a.get().mxcUrlToHttp(t.url),name:t.name,type:t.type,size:t.size}:(console.warn(e+" has custom notification sound event, but url is not a mxc url"),null):(console.warn(e+" has custom notification sound event, but no url key"),null):null},_playAudioNotification:async function(e,t){const s=this.getSoundForRoom(t.roomId);console.log(`Got sound ${s&&s.name||"default"} for ${t.roomId}`);try{const e=document.querySelector(s?`audio[src='${s.url}']`:"#messageAudio");let t=e;if(!e){if(!s)return void console.error("No audio element or sound to play for notification");t=new Audio(s.url),s.type&&(t.type=s.type),document.body.appendChild(t)}await t.play()}catch(e){console.warn("Caught error when trying to fetch room notification sound:",e)}},start:function(){this.boundOnEvent=this.boundOnEvent||this.onEvent.bind(this),this.boundOnSyncStateChange=this.boundOnSyncStateChange||this.onSyncStateChange.bind(this),this.boundOnRoomReceipt=this.boundOnRoomReceipt||this.onRoomReceipt.bind(this),this.boundOnEventDecrypted=this.boundOnEventDecrypted||this.onEventDecrypted.bind(this),n.a.get().on("event",this.boundOnEvent),n.a.get().on("Room.receipt",this.boundOnRoomReceipt),n.a.get().on("Event.decrypted",this.boundOnEventDecrypted),n.a.get().on("sync",this.boundOnSyncStateChange),this.toolbarHidden=!1,this.isSyncing=!1},stop:function(){n.a.get()&&(n.a.get().removeListener("Event",this.boundOnEvent),n.a.get().removeListener("Room.receipt",this.boundOnRoomReceipt),n.a.get().removeListener("Event.decrypted",this.boundOnEventDecrypted),n.a.get().removeListener("sync",this.boundOnSyncStateChange)),this.isSyncing=!1},supportsDesktopNotifications:function(){const e=i.a.get();return e&&e.supportsNotifications()},setEnabled:function(e,t){const s=i.a.get();s&&(r.a.trackEvent("Notifier","Set Enabled",String(e)),u.a.isLevelSupported(g.a.DEVICE)&&u.a.setValue("audioNotificationsEnabled",null,g.a.DEVICE,this.isEnabled()),e?s.requestNotificationPermission().then(e=>{if("granted"===e)t&&t(),c.a.dispatch({action:"notifier_enabled",value:!0});else{const t=a.a.get().brand,s="denied"===e?Object(m.a)("%(brand)s does not have permission to send you notifications - please check your browser settings",{brand:t}):Object(m.a)("%(brand)s was not given permission to send notifications - please try again",{brand:t}),n=d.getComponent("dialogs.ErrorDialog");h.a.createTrackedDialog("Unable to enable Notifications",e,n,{title:Object(m.a)("Unable to enable Notifications"),description:s})}}):c.a.dispatch({action:"notifier_enabled",value:!1}),this.setPromptHidden(!0))},isEnabled:function(){return this.isPossible()&&u.a.getValue("notificationsEnabled")},isPossible:function(){const e=i.a.get();return!!e&&(!!e.supportsNotifications()&&!!e.maySendNotifications())},isBodyEnabled:function(){return this.isEnabled()&&u.a.getValue("notificationBodyEnabled")},isAudioEnabled:function(){return u.a.getValue("audioNotificationsEnabled")},setPromptHidden:function(t,s=!0){this.toolbarHidden=t,r.a.trackEvent("Notifier","Set Toolbar Hidden",String(t)),Object(p.a)(),s&&e.localStorage&&e.localStorage.setItem("notifications_hidden",String(t))},shouldShowPrompt:function(){const e=n.a.get();if(!e)return!1;return!e.isGuest()&&this.supportsDesktopNotifications()&&!Object(f.c)()&&!this.isEnabled()&&!this._isPromptHidden()},_isPromptHidden:function(){return e.localStorage?"true"===e.localStorage.getItem("notifications_hidden"):this.toolbarHidden},onSyncStateChange:function(e){"SYNCING"===e?this.isSyncing=!0:"STOPPED"!==e&&"ERROR"!==e||(this.isSyncing=!1)},onEvent:function(e){if(this.isSyncing&&(!e.sender||e.sender.userId!==n.a.get().credentials.userId))if(e.isBeingDecrypted()||e.isDecryptionFailure())for(this.pendingEncryptedEventIds.push(e.getId());this.pendingEncryptedEventIds.length>20;)this.pendingEncryptedEventIds.shift();else this._evaluateEvent(e)},onEventDecrypted:function(e){if(e.isDecryptionFailure())return;const t=this.pendingEncryptedEventIds.indexOf(e.getId());-1!==t&&(this.pendingEncryptedEventIds.splice(t,1),this._evaluateEvent(e))},onRoomReceipt:function(e,t){if(0===t.getUnreadNotificationCount()){const e=i.a.get();if(!e)return;if(void 0===this.notifsByRoom[t.roomId])return;for(const s of this.notifsByRoom[t.roomId])e.clearNotification(s);delete this.notifsByRoom[t.roomId]}},_evaluateEvent:function(e){const t=n.a.get().getRoom(e.getRoomId()),s=n.a.get().getPushActionsForEvent(e);if(s&&s.notify){if(b.a.getRoomId()===t.roomId&&v.a.sharedInstance().userActiveRecently())return;this.isEnabled()&&this._displayPopupNotification(e,t),s.tweaks.sound&&this.isAudioEnabled()&&(i.a.get().loudNotification(e,t),this._playAudioNotification(e,t))}}};window.mxNotifier||(window.mxNotifier=y),t.default=window.mxNotifier}.call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e){this._timeout=e,this._onTimeout=this._onTimeout.bind(this),this._setNotStarted()}_setNotStarted(){this._timerHandle=null,this._startTs=null,this._promise=new Promise((e,t)=>{this._resolve=e,this._reject=t}).finally(()=>{this._timerHandle=null})}_onTimeout(){const e=Date.now()-this._startTs;if(e>=this._timeout)this._resolve(),this._setNotStarted();else{const t=this._timeout-e;this._timerHandle=setTimeout(this._onTimeout,t)}}changeTimeout(e){if(e===this._timeout)return;const t=e<this._timeout;this._timeout=e,this.isRunning()&&t&&(clearTimeout(this._timerHandle),this._onTimeout())}start(){return this.isRunning()||(this._startTs=Date.now(),this._timerHandle=setTimeout(this._onTimeout,this._timeout)),this}restart(){return this.isRunning()?(this._startTs=Date.now(),this):this.start()}abort(){return this.isRunning()&&(clearTimeout(this._timerHandle),this._reject(new Error("Timer was aborted.")),this._setNotStarted()),this}finished(){return this._promise}isRunning(){return null!==this._timerHandle}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(86),m=s(95),h=s(83),u=s(175);class p extends o.a.PureComponent{constructor(e){super(e),a()(this,"_onCancel",()=>{this.props.onFinished(!1)}),a()(this,"_onDone",()=>{this.props.onFinished(!0)}),a()(this,"_onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),a()(this,"_progressCallback",e=>{this.setState({progress:e})}),a()(this,"_onResetRecoveryClick",()=>{this.props.onFinished(!1),Object(u.b)(()=>{},!0)}),a()(this,"_onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyValid:d.a.get().isValidRecoveryKey(e.target.value)})}),a()(this,"_onPassPhraseNext",async()=>{this.setState({loading:!0,restoreError:null,restoreType:0});try{const e=await d.a.get().restoreKeyBackupWithPassword(this.state.passPhrase,void 0,void 0,this.state.backupInfo,{progressCallback:this._progressCallback});if(this.props.keyCallback){const e=await d.a.get().keyBackupKeyFromPassword(this.state.passPhrase,this.state.backupInfo);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}),a()(this,"_onRecoveryKeyNext",async()=>{if(this.state.recoveryKeyValid){this.setState({loading:!0,restoreError:null,restoreType:1});try{const e=await d.a.get().restoreKeyBackupWithRecoveryKey(this.state.recoveryKey,void 0,void 0,this.state.backupInfo,{progressCallback:this._progressCallback});if(this.props.keyCallback){const e=d.a.get().keyBackupKeyFromRecoveryKey(this.state.recoveryKey);this.props.keyCallback(e)}if(!this.props.showSummary)return void this.props.onFinished(!0);this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({loading:!1,restoreError:e})}}}),a()(this,"_onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value})}),this.state={backupInfo:null,backupKeyStored:null,loading:!1,loadError:null,restoreError:null,recoveryKey:"",recoverInfo:null,recoveryKeyValid:!1,forceRecoveryKey:!1,passPhrase:"",restoreType:null,progress:{stage:"prefetch"}}}componentDidMount(){this._loadBackupStatus()}async _restoreWithSecretStorage(){this.setState({loading:!0,restoreError:null,restoreType:2});try{const e=await Object(u.b)(async()=>d.a.get().restoreKeyBackupWithSecretStorage(this.state.backupInfo,void 0,void 0,{progressCallback:this._progressCallback}));this.setState({loading:!1,recoverInfo:e})}catch(e){console.log("Error restoring backup",e),this.setState({restoreError:e,loading:!1})}}async _restoreWithCachedKey(e){if(!e)return!1;try{const t=await d.a.get().restoreKeyBackupWithCache(void 0,void 0,e,{progressCallback:this._progressCallback});return this.setState({recoverInfo:t}),!0}catch(e){return console.log("restoreWithCachedKey failed:",e),!1}}async _loadBackupStatus(){this.setState({loading:!0,loadError:null});try{const e=d.a.get(),t=await e.getKeyBackupVersion(),s=await e.hasSecretStorageKey()&&await e.isKeyBackupKeyStored();this.setState({backupInfo:t,backupKeyStored:s});if(await this._restoreWithCachedKey(t))return console.log("RestoreKeyBackupDialog: found cached backup key"),void this.setState({loading:!1});if(s)return this._restoreWithSecretStorage();this.setState({loadError:null,loading:!1})}catch(e){console.log("Error loading backup status",e),this.setState({loadError:e,loading:!1})}}render(){const e=c.getComponent("views.dialogs.BaseDialog"),t=c.getComponent("elements.Spinner"),s=this.state.backupInfo&&this.state.backupInfo.auth_data&&this.state.backupInfo.auth_data.private_key_salt&&this.state.backupInfo.auth_data.private_key_iterations;let n,a;if(this.state.loading){let e;if(a=Object(h.a)("Restoring keys from backup"),"fetch"===this.state.progress.stage)e=Object(h.a)("Fetching keys from server...");else if("load_keys"===this.state.progress.stage){const{total:t,successes:s,failures:n}=this.state.progress;e=Object(h.a)("%(completed)s of %(total)s keys restored",{total:t,completed:s+n})}else"prefetch"===this.state.progress.stage&&(e=Object(h.a)("Fetching keys from server..."));n=o.a.createElement("div",null,o.a.createElement("div",null,e),o.a.createElement(t,null))}else if(this.state.loadError)a=Object(h.a)("Error"),n=Object(h.a)("Unable to load backup status");else if(this.state.restoreError)this.state.restoreError.errcode===m.i.RESTORE_BACKUP_ERROR_BAD_KEY?1===this.state.restoreType?(a=Object(h.a)("Security Key mismatch"),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Key: please verify that you entered the correct Security Key.")))):(a=Object(h.a)("Incorrect Security Phrase"),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("Backup could not be decrypted with this Security Phrase: please verify that you entered the correct Security Phrase.")))):(a=Object(h.a)("Error"),n=Object(h.a)("Unable to restore backup"));else if(null===this.state.backupInfo)a=Object(h.a)("Error"),n=Object(h.a)("No backup found!");else if(this.state.recoverInfo){const e=c.getComponent("views.elements.DialogButtons");let t;a=Object(h.a)("Keys restored"),this.state.recoverInfo.total>this.state.recoverInfo.imported&&(t=o.a.createElement("p",null,Object(h.a)("Failed to decrypt %(failedCount)s sessions!",{failedCount:this.state.recoverInfo.total-this.state.recoverInfo.imported}))),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("Successfully restored %(sessionCount)s keys",{sessionCount:this.state.recoverInfo.imported})),t,o.a.createElement(e,{primaryButton:Object(h.a)("OK"),onPrimaryButtonClick:this._onDone,hasCancel:!1,focus:!0}))}else if(s&&!this.state.forceRecoveryKey){const e=c.getComponent("views.elements.DialogButtons"),t=c.getComponent("elements.AccessibleButton");a=Object(h.a)("Enter Security Phrase"),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("<b>Warning</b>: you should only set up key backup from a trusted computer.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Phrase.")),o.a.createElement("form",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},o.a.createElement("input",{type:"password",className:"mx_RestoreKeyBackupDialog_passPhraseInput",onChange:this._onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0}),o.a.createElement(e,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this._onPassPhraseNext,primaryIsSubmit:!0,hasCancel:!0,onCancel:this._onCancel,focus:!1})),Object(h.a)("If you've forgotten your Security Phrase you can <button1>use your Security Key</button1> or <button2>set up new recovery options</button2>",{},{button1:e=>o.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onUseRecoveryKeyClick},e),button2:e=>o.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onResetRecoveryClick},e)}))}else{a=Object(h.a)("Enter Security Key");const e=c.getComponent("views.elements.DialogButtons"),t=c.getComponent("elements.AccessibleButton");let s;s=0===this.state.recoveryKey.length?o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"}):this.state.recoveryKeyValid?o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👍 ",Object(h.a)("This looks like a valid Security Key!")):o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_keyStatus"},"👎 ",Object(h.a)("Not a valid Security Key")),n=o.a.createElement("div",null,o.a.createElement("p",null,Object(h.a)("<b>Warning</b>: You should only set up key backup from a trusted computer.",{},{b:e=>o.a.createElement("b",null,e)})),o.a.createElement("p",null,Object(h.a)("Access your secure message history and set up secure messaging by entering your Security Key.")),o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_primaryContainer"},o.a.createElement("input",{className:"mx_RestoreKeyBackupDialog_recoveryKeyInput",onChange:this._onRecoveryKeyChange,value:this.state.recoveryKey,autoFocus:!0}),s,o.a.createElement(e,{primaryButton:Object(h.a)("Next"),onPrimaryButtonClick:this._onRecoveryKeyNext,hasCancel:!0,onCancel:this._onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})),Object(h.a)("If you've forgotten your Security Key you can <button>set up new recovery options</button>",{},{button:e=>o.a.createElement(t,{className:"mx_linkButton",element:"span",onClick:this._onResetRecoveryClick},e)}))}return o.a.createElement(e,{className:"mx_RestoreKeyBackupDialog",onFinished:this.props.onFinished,title:a},o.a.createElement("div",{className:"mx_RestoreKeyBackupDialog_content"},n))}}a()(p,"propTypes",{showSummary:l.a.bool,keyCallback:l.a.func}),a()(p,"defaultProps",{showSummary:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return m})),s.d(t,"c",(function(){return h})),s.d(t,"b",(function(){return u})),s.d(t,"d",(function(){return p})),s.d(t,"e",(function(){return g}));var n=s(82),a=s.n(n),i=s(126),o=s(87),r=s(94),l=s(456),c=s(86),d=s(347);const m="mx_sso_hs_url",h="mx_sso_is_url",u="mx_sso_idp_id";let p;!function(e){e.Checking="CHECKING",e.Error="ERROR",e.NotAvailable="NOTAVAILABLE",e.Downloading="DOWNLOADING",e.Ready="READY"}(p||(p={}));class g{constructor(){a()(this,"notificationCount",0),a()(this,"errorDidOccur",!1),a()(this,"onAction",e=>{switch(e.action){case"on_client_not_viable":case"on_logged_out":this.setNotificationCount(0)}}),o.a.register(this.onAction),this.startUpdateCheck=this.startUpdateCheck.bind(this)}setNotificationCount(e){this.notificationCount=e}setErrorStatus(e){this.errorDidOccur=e}async canSelfUpdate(){return!1}startUpdateCheck(){Object(l.a)(),localStorage.removeItem("mx_defer_update"),o.a.dispatch({action:r.a.CheckUpdates,status:p.Checking})}installUpdate(){}shouldShowUpdate(e){if(c.a.userRegisteredWithinLastHours(24))return!1;try{const[t,s]=JSON.parse(localStorage.getItem("mx_defer_update"));return e!==t||Date.now()>s}catch(e){return!0}}deferUpdate(e){const t=new Date(Date.now()+864e5);t.setHours(8,0,0,0),localStorage.setItem("mx_defer_update",JSON.stringify([e,t.getTime()])),Object(l.a)()}supportsNotifications(){return!1}maySendNotifications(){return!1}loudNotification(e,t){}clearNotification(e){e.close&&e.close()}screenCaptureErrorString(){return"Not implemented"}supportsAutoLaunch(){return!1}async getAutoLaunchEnabled(){return!1}async setAutoLaunchEnabled(e){throw new Error("Unimplemented")}supportsAutoHideMenuBar(){return!1}async getAutoHideMenuBarEnabled(){return!1}async setAutoHideMenuBarEnabled(e){throw new Error("Unimplemented")}supportsMinimizeToTray(){return!1}async getMinimizeToTrayEnabled(){return!1}async setMinimizeToTrayEnabled(e){throw new Error("Unimplemented")}getEventIndexingManager(){return null}setLanguage(e){}getSSOCallbackUrl(e){const t=new URL(window.location.href);return t.hash=e||"",t}startSingleSignOn(e,t,s,n){localStorage.setItem(m,e.getHomeserverUrl()),e.getIdentityServerUrl()&&localStorage.setItem(h,e.getIdentityServerUrl()),n&&localStorage.setItem(u,n);const a=this.getSSOCallbackUrl(s);window.location.href=e.getSsoLoginUrl(a.toString(),t,n)}onKeyDown(e){return!1}async getPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;let s;try{s=await Object(d.c)("pickleKey",[e,t])}catch(e){}if(!s)return null;if(!s.encrypted||!s.iv||!s.cryptoKey)return console.error("Badly formatted pickle key"),null;const n=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)n[t]=e.charCodeAt(t);n[e.length]=124;for(let s=0;s<t.length;s++)n[e.length+1+s]=t.charCodeAt(s);try{const e=await crypto.subtle.decrypt({name:"AES-GCM",iv:s.iv,additionalData:n},s.cryptoKey,s.encrypted);return Object(i.encodeUnpaddedBase64)(e)}catch(e){return console.error("Error decrypting pickle key"),null}}async createPickleKey(e,t){if(!window.crypto||!window.crypto.subtle)return null;const s=window.crypto,n=new Uint8Array(32);s.getRandomValues(n);const a=await s.subtle.generateKey({name:"AES-GCM",length:256},!1,["encrypt","decrypt"]),o=new Uint8Array(32);s.getRandomValues(o);const r=new Uint8Array(e.length+t.length+1);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);r[e.length]=124;for(let s=0;s<t.length;s++)r[e.length+1+s]=t.charCodeAt(s);const l=await s.subtle.encrypt({name:"AES-GCM",iv:o,additionalData:r},a,n);try{await Object(d.d)("pickleKey",[e,t],{encrypted:l,iv:o,cryptoKey:a})}catch(e){return null}return Object(i.encodeUnpaddedBase64)(n)}async destroyPickleKey(e,t){try{await Object(d.b)("pickleKey",[e,t])}catch(e){}}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return m})),s.d(t,"d",(function(){return h}));var n=s(83),a=s(289),i=s(88),o=s(351);const r="tchap";function l(){const e={tchap:Object(n.a)("Tchap")},t=i.a.getValue("custom_themes"),s={};for(const{name:e}of t)s["custom-"+e]=e;return Object.assign({},s,e)}const c=["font-display","font-family","font-stretch","font-style","font-weight","font-variant","font-feature-settings","font-variation-settings","src","unicode-range"];function d(e){const{style:t}=document.body;function s(e,s,n=!0){t.setProperty("--"+e,s),n&&(t.setProperty(`--${e}-0pct`,s+"00"),t.setProperty(`--${e}-15pct`,s+"26"),t.setProperty(`--${e}-50pct`,s+"7F"))}if(e.colors)for(const[t,n]of Object.entries(e.colors))if(Array.isArray(n))for(let e=0;e<n.length;e+=1)s(`${t}_${e}`,n[e],!1);else s(t,n);if(e.fonts){const{fonts:s}=e;if(s.faces){const e=s.faces.map(e=>{const t=e.src&&e.src.map(e=>{let t;return e.format&&(t=`format("${e.format}")`),e.url?`url("${e.url}") ${t}`:e.local?`local("${e.local}") ${t}`:""}).join(", ");return`@font-face {${Object.keys(e).filter(e=>c.includes(e)).map(s=>{let n;return n="src"===s?t:"font-family"===s?`"${e[s]}"`:e[s],`${s}: ${n}`}).join(";")}}`}).join("\n"),t=document.createElement("style");t.setAttribute("title","custom-theme-font-faces"),t.setAttribute("type","text/css"),t.appendChild(document.createTextNode(e)),document.head.appendChild(t)}s.general&&t.setProperty("--font-family",s.general),s.monospace&&t.setProperty("--font-family-monospace",s.monospace)}}function m(e){const t=i.a.getValue("custom_themes");if(!t)throw new Error(`No custom themes set, can't set custom theme "${e}"`);const s=t.find(t=>t.name===e);if(!s){const s=t.map(e=>e.name).join(", ");throw new Error(`Can't find custom theme "${e}", only know ${s}`)}return s}async function h(t){if(!t){const e=new o.a;t=e.getEffectiveTheme()}!function(){const e=Object.values(document.body.style);for(const t of e)t.startsWith("--")&&document.body.style.removeProperty(t);const t=document.querySelector("head > style[title='custom-theme-font-faces']");t&&t.remove()}();let s=t;if(t.startsWith("custom-")){const e=m(t.substr(7));s=e.is_dark?"dark-custom":"light-custom",d(e)}const n=Object.create(null);let i;for(let e=0;i=document.getElementsByTagName("link")[e];e++){const e=i.getAttribute("href").match(/^bundles\/.*\/theme-(.*)\.css$/);e&&(n[e[1]]=i)}if(!(s in n))throw new Error("Unknown theme "+s);return n[s].disabled=!1,new Promise(i=>{const o=function(){n[s].disabled=!1,Object.values(n).forEach(e=>{e!=n[s]&&(e.disabled=!0)});const o=e.getComputedStyle(document.body);o.backgroundColor&&(document.querySelector('meta[name="theme-color"]').content=o.backgroundColor),a.a.setTheme(t),i()};let r=!1;n[s].onload=()=>{o()};for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];if(t&&t.href===n[s].href){r=!0;break}}r&&(n[s].onload=void 0,o())})}}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(106);function a(e,t){const s=Object(n.throttle)(e,t,{leading:!0,trailing:!0}),a=s.bind;return s.bind=function(){const e=a.apply(s,arguments);return e.cancelPendingCall=s.cancelPendingCall,e},s.cancelPendingCall=function(){s.cancel()},s}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return g}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(82),l=s.n(r),c=s(81),d=s.n(c),m=s(87),h=s(94),u=s(86),p=s(168);class g extends d.a.Component{constructor(e){super(e),this.state=g.getState(e)}static getDerivedStateFromProps(e){return g.getState(e)}static getState(e){return e.member&&e.member.name?{name:e.member.name,title:e.title||e.member.name||"",imageUrl:e.member.getAvatarUrl(u.a.get().getHomeserverUrl(),Math.floor(e.width*window.devicePixelRatio),Math.floor(e.height*window.devicePixelRatio),e.resizeMethod,!1,!1)}:e.fallbackUserId?{name:e.fallbackUserId,title:e.fallbackUserId}:void console.error("MemberAvatar called somehow with null member or fallbackUserId")}render(){let e=this.props,{member:t,fallbackUserId:s,onClick:n,viewUserOnClick:i}=e,r=o()(e,["member","fallbackUserId","onClick","viewUserOnClick"]);const l=t?t.userId:s;return i&&(n=()=>{m.a.dispatch({action:h.a.ViewUser,member:this.props.member})}),d.a.createElement(p.a,a()({},r,{name:this.state.name,title:this.state.title,idName:l,url:this.state.imageUrl,onClick:n}))}}l()(g,"defaultProps",{width:40,height:40,resizeMethod:"crop",viewUserOnClick:!1})},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(90),l=s.n(r),c=s(163),d=s(83),m=s(104),h=s(358);class u extends i.PureComponent{constructor(...e){super(...e),a()(this,"validate",Object(c.a)({description:function(e){const t=4-u.errorArray.length;return o.a.createElement("progress",{className:"mx_PassphraseField_progress",max:4,value:t})},deriveData:async({value:e})=>{if(!e)return null;const{scorePassword:t}=await Promise.all([s.e(18),s.e(25)]).then(s.bind(null,1489));return t(e)},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(d.a)(this.props.labelEnterPassword)},{key:"match",test({value:e}){if(!e)return!1;const t=h.a.isPasswordValid(e);return u.errorArray=t.errorList,t.isValid},invalid:e=>this.buildErrors(),valid:()=>Object(d.a)(this.props.labelStrongPassword)}]})),a()(this,"onValidate",async e=>{const t=await this.validate(e);return this.props.onValidate(t),t})}buildErrors(){const e=u.errorArray;let t=[];t.push(Object(d.a)("Password too weak !")),t.push(o.a.createElement("br",null));for(let s=0;s<e.length;s++)t.push(Object(d.a)(e[s])),s!==e.length&&t.push(o.a.createElement("br",null));return t}render(){return o.a.createElement(m.a,{id:this.props.id,autoFocus:this.props.autoFocus,className:l()("mx_PassphraseField",this.props.className),ref:this.props.fieldRef,type:"password",autoComplete:"new-password",label:Object(d.a)(this.props.label),value:this.props.value,onChange:this.props.onChange,onValidate:this.onValidate})}}a()(u,"defaultProps",{label:Object(d.b)("Password"),labelEnterPassword:Object(d.b)("Enter password"),labelStrongPassword:Object(d.b)("Nice, strong password!"),labelAllowedButUnsafe:Object(d.b)("Password is allowed, but unsafe")}),a()(u,"errorArray",[]),t.a=u},,function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(82),a=s.n(n),i=s(147),o=s(87);s(120);class r extends Map{constructor(e){super(e)}getOrCreate(e,t){return this.has(e)?this.get(e):(this.set(e,t),t)}remove(e){const t=this.get(e);return this.delete(e),t}}class l extends i.a{constructor(){super(o.a),a()(this,"widgetMap",new r)}static get instance(){return l.internalInstance}async onAction(e){}async onReady(){this.widgetMap.clear()}storeMessaging(e,t){this.stopMessaging(e),this.widgetMap.set(e.id,t)}stopMessaging(e){var t;null===(t=this.widgetMap.remove(e.id))||void 0===t||t.stop()}getMessaging(e){return this.widgetMap.get(e.id)}stopMessagingById(e){var t;null===(t=this.widgetMap.remove(e))||void 0===t||t.stop()}getMessagingForId(e){return this.widgetMap.get(e)}}a()(l,"internalInstance",new l)},,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(88);function a(e){const t=t=>n.a.getValue(t,e.getRoomId());if(e.isRedacted()&&!t("showRedactions"))return!0;if(e.isRelation("m.replace"))return!0;const s=function(e){const t={isMemberEvent:"m.room.member"===e.getType()};if(!t.isMemberEvent)return t;const s=e.getContent(),n=e.getPrevContent(),a=s.membership!==n.membership;t.isJoin=a&&"join"===s.membership,t.isPart=a&&"leave"===s.membership&&e.getStateKey()===e.getSender();const i=!a&&"join"===s.membership;return t.isDisplaynameChange=i&&s.displayname!==n.displayname,t.isAvatarChange=i&&s.avatar_url!==n.avatar_url,t}(e);if(s.isMemberEvent){if((s.isJoin||s.isPart)&&!t("showJoinLeaves"))return!0;if(s.isAvatarChange&&!t("showAvatarChanges"))return!0;if(s.isDisplaynameChange&&!t("showDisplaynameChanges"))return!0}return!1}},,,,,,,,function(e,t,s){"use strict";s.d(t,"c",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"e",(function(){return r})),s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return m}));var n=s(1019);const a=new Map,i=new Map,o=new Map,r=e=>a.get(d(e)),l=["people","people","control","nature","foods","places","activity","objects","symbols","flags"],c={people:[],nature:[],foods:[],places:[],activity:[],objects:[],symbols:[],flags:[]};function d(e){return e.replace(/[\uFE00-\uFE0F]$/,"")}n.forEach(e=>{const t=l[e.group];c.hasOwnProperty(t)&&c[t].push(e),e.filterString=(`${e.annotation}\n${e.shortcodes.join("\n")}}\n${e.emoticon||""}\n`+e.unicode.split("‍").join("\n")).toLowerCase(),a.set(d(e.unicode),e),e.emoticon&&i.set(e.emoticon,e),e.shortcodes&&e.shortcodes.forEach(t=>{o.set(t,e)})});const m=n},,,,function(e,t,s){"use strict";s.d(t,"c",(function(){return o})),s.d(t,"d",(function(){return r})),s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c}));var n=s(95),a=s(92),i=s(86);function o(){return a.a.get().validated_server_config.isUrl}function r(){i.a.get().setAccountData("m.identity_server",{base_url:i.a.get().getIdentityServerUrl()})}async function l(e){let t;try{t=await i.a.get().getTerms(n.m.IS,e)}catch(e){if(console.error(e),"rejected"!==e.cors&&404!==e.httpStatus)throw e;t=null}return t&&t.policies&&Object.keys(t.policies).length>0}function c(){const e=i.a.get().getAccountData("m.identity_server");return e&&e.getContent()&&e.getContent().base_url}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i})),s.d(t,"c",(function(){return o}));var n=s(86);function a(e){return e.getCanonicalAlias()||e.getAltAliases()[0]}function i(e,t){let s;if(t){s=function(e,t){let s,n;for(const a of e.getJoinedMembers())a.userId!=t&&(void 0===s||a.events.member&&a.events.member.getTs()<s)&&(n=a,s=a.events.member.getTs());if(n)return n.userId;for(const a of e.currentState.getMembers())a.userId!=t&&(void 0===s||a.events.member&&a.events.member.getTs()<s)&&(n=a,s=a.events.member.getTs());return void 0===n?t:n.userId}(e,n.a.get().getUserId())}else s=null;return o(e.roomId,s)}function o(e,t){if(n.a.get().isGuest())return Promise.resolve();const s=n.a.get().getAccountData("m.direct");let a={};void 0!==s&&(a=s.getContent());for(const s of Object.keys(a)){const n=a[s];if(s!=t){const t=n.indexOf(e);t>-1&&n.splice(t,1)}}if(t){const s=a[t]||[];-1==s.indexOf(e)&&s.push(e),a[t]=s}return n.a.get().setAccountData("m.direct",a)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return l}));var n=s(86);function a(){const e=n.a.get().getClientWellKnown();return null==e?void 0:e["io.element.call_behaviour"]}function i(){const e=n.a.get().getClientWellKnown();return e&&e["io.element.e2ee"]?e["io.element.e2ee"]:e&&e["im.vector.riot.e2ee"]?e["im.vector.riot.e2ee"]:null}function o(){const e=i();return e&&!0===e.secure_backup_required}let r;function l(){const e=i();return e&&e.secure_backup_setup_methods&&e.secure_backup_setup_methods.length&&(e.secure_backup_setup_methods.includes(r.Key)||e.secure_backup_setup_methods.includes(r.Passphrase))?e.secure_backup_setup_methods:[r.Key,r.Passphrase]}!function(e){e.Key="key",e.Passphrase="passphrase"}(r||(r={}))},,function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c})),s.d(t,"d",(function(){return d})),s.d(t,"c",(function(){return m}));var n=s(90),a=s.n(n),i=s(86),o=s(85),r=s(89);class l extends Error{}class c{constructor(e,t,s){this.serviceType=e,this.baseUrl=t,this.accessToken=s}}async function d(e,t=m){const s=e.map(e=>i.a.get().getTerms(e.serviceType,e.baseUrl)),n=(await Promise.all(s)).map((t,s)=>({service:e[s],policies:t.policies})),a=await i.a.get().getAccountData("m.accepted_terms");let o;o=a&&a.getContent()&&a.getContent().accepted?new Set(a.getContent().accepted):new Set;const r=[];for(const{service:e,policies:t}of n){const s={};for(const[e,n]of Object.entries(t)){let t=!1;for(const e of Object.keys(n))if("version"!==e&&o.has(n[e].url)){t=!0;break}t||(s[e]=n)}Object.keys(s).length>0&&r.push({service:e,policies:s})}const l=o.size;if(r.length>0){const e=await t(r,[...o]);console.log("User has agreed to URLs",e),e.forEach(e=>o.add(e))}else console.log("User has already agreed to all required policies");if(o.size!==l){const e={accepted:Array.from(o)};await i.a.get().setAccountData("m.accepted_terms",e)}const c=n.map(e=>{const t=Array.from(o).filter(t=>{for(const s of Object.values(e.policies))for(const e of Object.keys(s))if("version"!==e&&s[e].url===t)return!0;return!1});return 0===t.length?Promise.resolve():i.a.get().agreeToTerms(e.service.serviceType,e.service.baseUrl,e.service.accessToken,t)});return Promise.all(c)}function m(e,t,s){return new Promise((n,i)=>{console.log("Terms that need agreement",e);const c=o.getComponent("views.dialogs.TermsDialog");r.a.createTrackedDialog("Terms of Service","",c,{policiesAndServicePairs:e,agreedUrls:t,onFinished:(e,t)=>{e?n(t):i(new l)}},a()("mx_TermsDialog",s))})}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(82),l=s.n(r),c=s(81),d=s.n(c),m=s(90),h=s.n(m),u=s(153),p=s(88),g=s(91),f=s(246);class b extends d.a.PureComponent{constructor(e){super(e),l()(this,"countWatcherRef",void 0),l()(this,"countPreferenceChanged",()=>{this.setState({showCounts:p.a.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)})}),l()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),this.props.notification.on(f.a,this.onNotificationUpdate),this.state={showCounts:p.a.getValue("Notifications.alwaysShowBadgeCounts",this.roomId)},this.countWatcherRef=p.a.watchSetting("Notifications.alwaysShowBadgeCounts",this.roomId,this.countPreferenceChanged)}get roomId(){return this.props.roomId||null}componentWillUnmount(){p.a.unwatchSetting(this.countWatcherRef),this.props.notification.off(f.a,this.onNotificationUpdate)}componentDidUpdate(e){e.notification&&e.notification.off(f.a,this.onNotificationUpdate),this.props.notification.on(f.a,this.onNotificationUpdate)}render(){const e=this.props,{notification:t,forceCount:s,roomId:n,onClick:i}=e,r=o()(e,["notification","forceCount","roomId","onClick"]);if(t.isIdle)return null;let l=!(t.symbol||t.count>0)||!t.hasUnreadCount;if(s&&(l=!1,!t.hasUnreadCount))return null;let c=t.symbol||Object(u.c)(t.count);l&&(c="");const m=h()({mx_NotificationBadge:!0,mx_NotificationBadge_visible:!!l||t.hasUnreadCount,mx_NotificationBadge_highlighted:t.hasMentions,mx_NotificationBadge_dot:l,mx_NotificationBadge_2char:c.length>0&&c.length<3,mx_NotificationBadge_3char:c.length>2});return i?d.a.createElement(g.a,a()({},r,{className:m,onClick:i}),d.a.createElement("span",{className:"mx_NotificationBadge_count"},c)):d.a.createElement("div",{className:m},d.a.createElement("span",{className:"mx_NotificationBadge_count"},c))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i})),s.d(t,"b",(function(){return o}));var n=s(112),a=s.n(n);function i(e){if(!e)return"";const t=a.a.parse(e);return t&&"/"===t.path?t.host:e}function o(e){if(!e)return"";let t=e;e.startsWith("https://")||(t="https://"+e);return null===a.a.parse(t).hostname?e:t}},function(e,t,s){"use strict";(function(e){class s{constructor(){this.keyRgb=["rgb(118, 207, 166)","rgb(234, 245, 240)","rgb(211, 239, 225)"],this.keyHex=["#76CFA6","#EAF5F0","#D3EFE1","#FFFFFF","#000000"],this.colors=[this.keyHex[0],this.keyHex[1],this.keyHex[2],this.keyHex[3],this.keyHex[4]],this.currentTint=[void 0,void 0,void 0,void 0,void 0],this.cssFixups=[],this.cssAttrs=["color","backgroundColor","borderColor","borderTopColor","borderBottomColor","borderLeftColor"],this.svgAttrs=["fill","stroke"],this.tintables=[],this.theme=void 0,this.forceTint=!1}registerTintable(e){this.tintables.push(e),e()}getKeyRgb(){return this.keyRgb}tint(e,t,s){}tintSvgWhite(e){this.currentTint[3]=e,e||(e=this.colors[3]),this.colors[3]!==e&&(this.colors[3]=e,this.tintables.forEach((function(e){e()})))}tintSvgBlack(e){this.currentTint[4]=e,e||(e=this.colors[4]),this.colors[4]!==e&&(this.colors[4]=e,this.tintables.forEach((function(e){e()})))}setTheme(e){this.theme=e,document.getElementById("mx_theme_accentColor")&&(this.keyRgb[0]=window.getComputedStyle(document.getElementById("mx_theme_accentColor")).color),document.getElementById("mx_theme_secondaryAccentColor")&&(this.keyRgb[1]=window.getComputedStyle(document.getElementById("mx_theme_secondaryAccentColor")).color),document.getElementById("mx_theme_tertiaryAccentColor")&&(this.keyRgb[2]=window.getComputedStyle(document.getElementById("mx_theme_tertiaryAccentColor")).color),this.calcCssFixups(),this.forceTint=!0,this.tint(this.currentTint[0],this.currentTint[1],this.currentTint[2]),"dark"===e?(this.tintSvgWhite("#2d2d2d"),this.tintSvgBlack("#dddddd")):(this.tintSvgWhite("#ffffff"),this.tintSvgBlack("#000000"))}calcCssFixups(){if(!this.cssFixups[this.theme]){0,this.cssFixups[this.theme]=[];for(let e=0;e<document.styleSheets.length;e++){const t=document.styleSheets[e];try{if(!t)continue;if(!t.href||!t.href.match(new RegExp("/theme-"+this.theme+".css$")))continue;if(t.disabled)continue;if(!t.cssRules)continue;0;for(let e=0;e<t.cssRules.length;e++){const s=t.cssRules[e];if(s.style&&(!s.selectorText||!s.selectorText.match(/#mx_theme/)))for(let e=0;e<this.cssAttrs.length;e++){const t=this.cssAttrs[e];for(let e=0;e<this.keyRgb.length;e++)s.style[t]===this.keyRgb[e]&&this.cssFixups[this.theme].push({style:s.style,attr:t,index:e})}}}catch(e){console.log("Failed to calculate CSS fixups for a stylesheet: "+t.href,e)}}0}}applyCssFixups(){for(let e=0;e<this.cssFixups[this.theme].length;e++){const t=this.cssFixups[this.theme][e];try{t.style[t.attr]=this.colors[t.index]}catch(e){console.error("Failed to apply cssFixup in Tinter! ",e.name)}}}calcSvgFixups(e){const t=[];for(let s=0;s<e.length;s++){let n;try{n=e[s].contentDocument}catch(t){let n="Failed to get svg.contentDocument of "+e[s].toString();t.message&&(n+=t.message),t.stack&&(n+=" | stack: "+t.stack),console.error(n)}if(!n)continue;const a=n.getElementsByTagName("*");for(let e=0;e<a.length;e++){const s=a[e];for(let e=0;e<this.svgAttrs.length;e++){const n=this.svgAttrs[e];for(let e=0;e<this.keyHex.length;e++)s.getAttribute(n)&&s.getAttribute(n).toUpperCase()===this.keyHex[e]&&t.push({node:s,attr:n,index:e})}}}return t}applySvgFixups(e){for(let t=0;t<e.length;t++){const s=e[t];s.node.setAttribute(s.attr,this.colors[s.index])}}}void 0===e.singletonTinter&&(e.singletonTinter=new s),t.a=e.singletonTinter}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(83),m=s(90),h=s.n(m);class u extends o.a.Component{constructor(...e){super(...e),a()(this,"onFinished",()=>{this.props.onFinished()})}render(){const e=c.getComponent("views.dialogs.BaseDialog"),t=c.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content",hasCancel:this.props.hasCloseButton,onKeyDown:this.props.onKeyDown,fixedWidth:this.props.fixedWidth},o.a.createElement("div",{className:h()("mx_Dialog_content",this.props.className),id:"mx_Dialog_content"},this.props.description),o.a.createElement(t,{primaryButton:this.props.button||Object(d.a)("OK"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}a()(u,"propTypes",{className:l.a.string,title:l.a.string,description:l.a.node,button:l.a.string,onFinished:l.a.func,hasCloseButton:l.a.bool,onKeyDown:l.a.func,fixedWidth:l.a.bool}),a()(u,"defaultProps",{title:"",description:"",hasCloseButton:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return N}));var n=s(93),a=s.n(n),i=s(82),o=s.n(i),r=s(112),l=s.n(r),c=s(81),d=s.n(c),m=s(84),h=s.n(m),u=s(86),p=s(91),g=s(83),f=s(678),b=s(679),v=s(117),_=s(87),y=s(244),E=s(90),C=s.n(E),w=s(88),S=s(102),x=s(352),R=s(132),O=s(769),k=s(7),I=s(137),T=s(353),j=s(464);class N extends d.a.Component{constructor(e){super(e),o()(this,"hasPermissionToLoad",e=>{if(this._usingLocalWidget())return!0;if(!e.room)return!0;const t=w.a.getValue("allowedWidgets",e.room.roomId);return void 0===t[e.app.eventId]?e.userId===e.creatorUserId:!!t[e.app.eventId]}),o()(this,"onAllowedWidgetsChange",()=>{const e=this.hasPermissionToLoad(this.props);this.state.hasPermissionToLoad&&!e&&(y.a.destroyPersistentWidget(this.props.app.id),x.a.destroyElement(this._persistKey),this._sgWidget.stop()),this.setState({hasPermissionToLoad:e})}),o()(this,"_iframeRefChange",e=>{this.iframe=e,e?this._sgWidget.start(e):this._resetWidget(this.props)}),o()(this,"_onWidgetPrepared",()=>{this.setState({loading:!1})}),o()(this,"_onWidgetReady",()=>{R.a.JITSI.matches(this.props.app.type)&&this._sgWidget.widgetApi.transport.send(k.a.ClientReady,{})}),o()(this,"_onAction",e=>{if(e.widgetId===this.props.app.id)switch(e.action){case"m.sticker":this._sgWidget.widgetApi.hasCapability(I.MatrixCapabilities.StickerSending)?_.a.dispatch({action:"post_sticker_message",data:e.data}):console.warn("Ignoring sticker message. Invalid capability")}}),o()(this,"_grantWidgetPermission",()=>{const e=this.props.room.roomId;console.info("Granting permission for widget to load: "+this.props.app.eventId);const t=w.a.getValue("allowedWidgets",e);t[this.props.app.eventId]=!0;const s=w.a.firstSupportedLevel("allowedWidgets");w.a.setValue("allowedWidgets",e,s,t).then(()=>{this.setState({hasPermissionToLoad:!0}),this._startWidget()}).catch(e=>{console.error(e)})}),o()(this,"_onPopoutWidgetClick",()=>{R.a.JITSI.matches(this.props.app.type)&&this._endWidgetActions().then(()=>{this.iframe&&(this.iframe.src=this._sgWidget.embedUrl,this.setState({}))}),Object.assign(document.createElement("a"),{target:"_blank",href:this._sgWidget.popoutUrl,rel:"noreferrer noopener"}).click()}),o()(this,"_onContextMenuClick",()=>{this.setState({menuDisplayed:!0})}),o()(this,"_closeContextMenu",()=>{this.setState({menuDisplayed:!1})}),this._persistKey=Object(x.b)(this.props.app.id),this._sgWidget=new O.b(this.props),this._sgWidget.on("preparing",this._onWidgetPrepared),this._sgWidget.on("ready",this._onWidgetReady),this.iframe=null,this.state=this._getNewState(e),this._contextMenuButton=Object(c.createRef)(),this._allowedWidgetsWatchRef=w.a.watchSetting("allowedWidgets",null,this.onAllowedWidgetsChange)}_getNewState(e){return{initialising:!0,loading:this.props.waitForIframeLoad&&!x.a.isMounted(this._persistKey),hasPermissionToLoad:this.hasPermissionToLoad(e),error:null,widgetPageTitle:e.widgetPageTitle,menuDisplayed:!1}}isMixedContent(){const e=window.location.protocol,t=l.a.parse(this.props.app.url).protocol;return"https:"===e&&"https:"!==t&&(console.warn("Refusing to load mixed-content app:",e,t,window.location,this.props.app.url),!0)}componentDidMount(){this.state.hasPermissionToLoad&&this._startWidget(),this.dispatcherRef=_.a.register(this._onAction)}componentWillUnmount(){this.dispatcherRef&&_.a.unregister(this.dispatcherRef),y.a.getWidgetPersistence(this.props.app.id)||(y.a.destroyPersistentWidget(this.props.app.id),x.a.destroyElement(this._persistKey)),this._sgWidget&&this._sgWidget.stop(),w.a.unwatchSetting(this._allowedWidgetsWatchRef)}_resetWidget(e){this._sgWidget&&this._sgWidget.stop(),this._sgWidget=new O.b(e),this._sgWidget.on("preparing",this._onWidgetPrepared),this._sgWidget.on("ready",this._onWidgetReady),this._startWidget()}_startWidget(){this._sgWidget.prepare().then(()=>{this.setState({initialising:!1})})}UNSAFE_componentWillReceiveProps(e){e.app.url!==this.props.app.url&&(this._getNewState(e),this.state.hasPermissionToLoad&&this._resetWidget(e)),e.widgetPageTitle!==this.props.widgetPageTitle&&this.setState({widgetPageTitle:e.widgetPageTitle})}async _endWidgetActions(){this.iframe&&(this.iframe.src="about:blank"),R.a.JITSI.matches(this.props.app.type)&&_.a.dispatch({action:"hangup_conference"}),x.a.destroyElement(this._persistKey),this._sgWidget.stop({forceDestroy:!0})}formatAppTileName(){let e="No name";return this.props.app.name&&this.props.app.name.trim()&&(e=this.props.app.name.trim()),e}_usingLocalWidget(){return R.a.JITSI.matches(this.props.app.type)}_getTileTitle(){const e=this.formatAppTileName(),t=d.a.createElement("span",null," - ");let s="";return this.state.widgetPageTitle&&this.state.widgetPageTitle!==this.formatAppTileName()&&(s=this.state.widgetPageTitle),d.a.createElement("span",null,d.a.createElement(j.a,{app:this.props.app}),d.a.createElement("b",null,e),d.a.createElement("span",null,s?t:"",s))}render(){let e;const t="mx_AppTileBody"+(this.props.miniMode?"_mini  ":" "),s=d.a.createElement("div",{className:"mx_AppLoading_spinner_fadeIn"},d.a.createElement(v.a,{message:Object(g.a)("Loading...")}));if(this.state.hasPermissionToLoad)this.state.initialising?e=d.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":"")},s):this.isMixedContent()?e=d.a.createElement("div",{className:t},d.a.createElement(b.a,{errorMsg:"Error - Mixed content"})):(e=d.a.createElement("div",{className:t+(this.state.loading?"mx_AppLoading":"")},this.state.loading&&s,d.a.createElement("iframe",{allow:"microphone; camera; encrypted-media; autoplay; display-capture;",ref:this._iframeRefChange,src:this._sgWidget.embedUrl,allowFullScreen:!0,sandbox:"allow-forms allow-popups allow-popups-to-escape-sandbox allow-same-origin allow-scripts allow-presentation"})),this.props.userWidget||(e=d.a.createElement("div",{className:"mx_AppTile_persistedWrapper"},d.a.createElement(x.a,{persistKey:this._persistKey},e))));else{const s=u.a.get().isRoomEncrypted(this.props.room.roomId);e=d.a.createElement("div",{className:t},d.a.createElement(f.a,{roomId:this.props.room.roomId,creatorUserId:this.props.creatorUserId,url:this._sgWidget.embedUrl,isRoomEncrypted:s,onPermissionGranted:this._grantWidgetPermission}))}let n,i;return n=this.props.miniMode?{mx_AppTile_mini:!0}:this.props.fullWidth?{mx_AppTileFullWidth:!0}:{mx_AppTile:!0},n=C()(n),this.state.menuDisplayed&&(i=d.a.createElement(T.a,a()({},Object(S.k)(this._contextMenuButton.current.getBoundingClientRect(),null),{app:this.props.app,onFinished:this._closeContextMenu,showUnpin:!this.props.userWidget,userWidget:this.props.userWidget}))),d.a.createElement(d.a.Fragment,null,d.a.createElement("div",{className:n,id:this.props.app.id},this.props.showMenubar&&d.a.createElement("div",{className:"mx_AppTileMenuBar"},d.a.createElement("span",{className:"mx_AppTileMenuBarTitle",style:{pointerEvents:!!this.props.handleMinimisePointerEvents&&"all"}},this.props.showTitle&&this._getTileTitle()),d.a.createElement("span",{className:"mx_AppTileMenuBarWidgets"},this.props.showPopout&&d.a.createElement(p.a,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_popout",title:Object(g.a)("Popout widget"),onClick:this._onPopoutWidgetClick}),d.a.createElement(S.c,{className:"mx_AppTileMenuBar_iconButton mx_AppTileMenuBar_iconButton_menu",label:Object(g.a)("Options"),isExpanded:this.state.menuDisplayed,inputRef:this._contextMenuButton,onClick:this._onContextMenuClick}))),e),i)}}N.displayName="AppTile",N.propTypes={app:h.a.object.isRequired,room:h.a.object,fullWidth:h.a.bool,miniMode:h.a.bool,userId:h.a.string.isRequired,creatorUserId:h.a.string,waitForIframeLoad:h.a.bool,showMenubar:h.a.bool,onEditClick:h.a.func,onDeleteClick:h.a.func,onMinimiseClick:h.a.func,showTitle:h.a.bool,handleMinimisePointerEvents:h.a.bool,showPopout:h.a.bool,userWidget:h.a.bool},N.defaultProps={waitForIframeLoad:!0,showMenubar:!0,showTitle:!0,showPopout:!0,handleMinimisePointerEvents:!1,userWidget:!1,miniMode:!1}},function(e,t,s){"use strict";s.r(t),s.d(t,"containsEmoji",(function(){return n}));const n=(e,t)=>t.some(t=>e.body&&e.body.includes(t))},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(87),l=s(86),c=s(85),d=s(83),m=s(89),h=s(128),u=s(504),p=s.n(u),g=s(1177),f=s.n(g),b=s(117),v=(s(1179),s(94)),_=s(105);const y=[0,0,22,37,0,0,22,37,1];class E extends Error{}function C(e,t,s,n){return new Promise(a=>{let i=t,o=s;o>600&&(i=Math.floor(i*(600/o)),o=600),i>800&&(o=Math.floor(o*(800/i)),i=800);const r=document.createElement("canvas");r.width=i,r.height=o,r.getContext("2d").drawImage(e,0,0,i,o),r.toBlob((function(e){let n=null===e?null:e.type,r=null===e?null:e.size;a({info:{thumbnail_info:{w:i,h:o,mimetype:n,size:r},w:t,h:s},thumbnail:e})}),n)})}function w(e,t,s){let n,a="image/png";return"image/jpeg"===s.type&&(a="image/jpeg"),async function(e){const t=document.createElement("img"),s=URL.createObjectURL(e),n=new Promise((e,n)=>{t.onload=function(){URL.revokeObjectURL(s),e(t)},t.onerror=function(e){n(e)}});let a;if(t.src=s,"image/png"===e.type){a=x(e).then(e=>{const t=new Uint8Array(e),s=f()(t);for(const e of s)if("pHYs"===e.name){if(e.data.byteLength!==y.length)return;return e.data.every((e,t)=>e===y[t])}return!1})}const[i]=await Promise.all([a,n]);return{width:i?t.width>>1:t.width,height:i?t.height>>1:t.height,img:t}}(s).then((function(e){return C(e.img,e.width,e.height,a)})).then((function(s){return n=s.info,R(e,t,s.thumbnail)})).then((function(e){return n.thumbnail_url=e.url,n.thumbnail_file=e.file,n}))}function S(e,t,s){let n;return function(e){return new Promise((t,s)=>{const n=document.createElement("video"),a=new FileReader;a.onload=function(e){n.src=e.target.result,n.onloadeddata=function(){t(n)},n.onerror=function(e){s(e)}},a.onerror=function(e){s(e)},a.readAsDataURL(e)})}(s).then((function(e){return C(e,e.videoWidth,e.videoHeight,"image/jpeg")})).then((function(s){return n=s.info,R(e,t,s.thumbnail)})).then((function(e){return n.thumbnail_url=e.url,n.thumbnail_file=e.file,n}))}function x(e){return new Promise((t,s)=>{const n=new FileReader;n.onload=function(e){t(e.target.result)},n.onerror=function(e){s(e)},n.readAsArrayBuffer(e)})}function R(e,t,s,n){let a=!1;if(e.isRoomEncrypted(t)){let t,i;const o=x(s).then((function(e){if(a)throw new E;return p.a.encryptAttachment(e)})).then((function(s){if(a)throw new E;i=s.info;const o=new Blob([s.data]);return t=e.uploadContent(o,{progressHandler:n,includeFilename:!1}),t})).then((function(e){if(a)throw new E;return i.url=e,s.type&&(i.mimetype=s.type),{file:i}}));return o.abort=()=>{a=!0,t&&l.a.get().cancelUpload(t)},o}{const t=e.uploadContent(s,{progressHandler:n}),i=t.then((function(e){if(a)throw new E;return{url:e}}));return i.abort=()=>{a=!0,l.a.get().cancelUpload(t)},i}}class O{constructor(){a()(this,"inprogress",[]),a()(this,"mediaConfig",null)}sendStickerContentToRoom(e,t,s,n,a){const i=_.a.getTimestamp(),o=l.a.get().sendStickerMessage(t,e,s,n).catch(s=>{throw console.warn(`Failed to send content with URL ${e} to room ${t}`,s),s});return _.a.instance.trackSendMessage(i,o,t,!1,!1,{msgtype:"m.sticker"}),o}getUploadLimit(){return null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]?this.mediaConfig["m.upload.size"]:null}async sendContentListToRoom(e,t,s){if(s.isGuest())return void r.a.dispatch({action:"require_registration"});if(Boolean(h.a.getQuotingEvent())){const e=c.getComponent("dialogs.QuestionDialog"),{finished:t}=m.a.createTrackedDialog("Upload Reply Warning","",e,{title:Object(d.a)("Replying With Files"),description:o.a.createElement("div",null,Object(d.a)("At this time it is not possible to reply with a file. Would you like to upload this file without replying?")),hasCancelButton:!0,button:Object(d.a)("Continue")}),[s]=await t;if(!s)return}if(!this.mediaConfig){const e=m.a.createDialog(b.a,null,"mx_Dialog_spinner");await this.ensureMediaConfigFetched(),e.close()}const n=[],a=[];for(let t=0;t<e.length;++t)this.isFileSizeAcceptable(e[t])?a.push(e[t]):n.push(e[t]);if(n.length>0){const t=c.getComponent("dialogs.UploadFailureDialog"),{finished:s}=m.a.createTrackedDialog("Upload Failure","",t,{badFiles:n,totalFiles:e.length,contentMessages:this}),[a]=await s;if(!a)return}const i=c.getComponent("dialogs.UploadConfirmDialog");let l=!1,u=Promise.resolve();for(let e=0;e<a.length;++e){const n=a[e];if(!l){const{finished:t}=m.a.createTrackedDialog("Upload Files confirmation","",i,{file:n,currentIndex:e,totalFiles:a.length}),[s,o]=await t;if(!s)break;o&&(l=!0)}u=this.sendContentToRoom(n,t,s,u)}}getCurrentUploads(){return this.inprogress.filter(e=>!e.canceled)}cancelUpload(e){let t;for(let s=0;s<this.inprogress.length;++s)if(this.inprogress[s].promise===e){t=this.inprogress[s];break}t&&(t.canceled=!0,l.a.get().cancelUpload(t.promise),r.a.dispatch({action:"upload_canceled",upload:t}))}sendContentToRoom(e,t,s,n){const a=_.a.getTimestamp(),i={body:e.name||"Attachment",info:{size:e.size},msgtype:""};e.type&&(i.info.mimetype=e.type);const o=new Promise(n=>{0===e.type.indexOf("image/")?(i.msgtype="m.image",w(s,t,e).then(e=>{Object.assign(i.info,e),n()},e=>{console.error(e),i.msgtype="m.file",n()})):0===e.type.indexOf("audio/")?(i.msgtype="m.audio",n()):0===e.type.indexOf("video/")?(i.msgtype="m.video",S(s,t,e).then(e=>{Object.assign(i.info,e),n()},e=>{i.msgtype="m.file",n()})):(i.msgtype="m.file",n())});o.abort=()=>{l.canceled=!0};const l={fileName:e.name||"Attachment",roomId:t,total:e.size,loaded:0,promise:o};function h(e){l.total=e.total,l.loaded=e.loaded,r.a.dispatch({action:"upload_progress",upload:l})}let u;return this.inprogress.push(l),r.a.dispatch({action:"upload_started"}),r.a.fire(v.a.FocusComposer),o.then((function(){if(l.canceled)throw new E;return l.promise=R(s,t,e,h),l.promise.then((function(e){i.file=e.file,i.url=e.url}))})).then(()=>n).then((function(){if(l.canceled)throw new E;const e=s.sendMessage(t,i);return _.a.instance.trackSendMessage(a,e,t,!1,!1,i),e}),(function(e){if(u=e,!l.canceled){let t=Object(d.a)("The file '%(fileName)s' failed to upload.",{fileName:l.fileName});413===e.http_status&&(t=Object(d.a)("The file '%(fileName)s' exceeds this homeserver's size limit for uploads",{fileName:l.fileName}));const s=c.getComponent("dialogs.ErrorDialog");m.a.createTrackedDialog("Upload failed","",s,{title:Object(d.a)("Upload Failed"),description:t})}})).finally(()=>{for(let e=0;e<this.inprogress.length;++e)if(this.inprogress[e].promise===l.promise){this.inprogress.splice(e,1);break}u?(u&&413===u.http_status&&(this.mediaConfig=null),r.a.dispatch({action:"upload_failed",upload:l,error:u})):(r.a.dispatch({action:"upload_finished",upload:l}),r.a.dispatch({action:"message_sent"}))})}isFileSizeAcceptable(e){return!(null!==this.mediaConfig&&void 0!==this.mediaConfig["m.upload.size"]&&e.size>this.mediaConfig["m.upload.size"])}ensureMediaConfigFetched(){if(null===this.mediaConfig)return console.log("[Media Config] Fetching"),l.a.get().getMediaConfig().then(e=>(console.log("[Media Config] Fetched config:",e),e)).catch(()=>(console.log("[Media Config] Could not fetch config, so not limiting uploads."),{})).then(e=>{this.mediaConfig=e})}static sharedInstance(){return void 0===window.mxContentMessages&&(window.mxContentMessages=new O),window.mxContentMessages}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(82),a=s.n(n),i=s(87),o=s(691),r=s(301),l=s(88),c=s(123),d=s(94),m=s(96);function h(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}const u={showRoomPanel:l.a.getValue("showRightPanelInRoom"),showGroupPanel:l.a.getValue("showRightPanelInGroup"),lastRoomPhase:l.a.getValue("lastRightPanelPhaseForRoom"),lastGroupPhase:l.a.getValue("lastRightPanelPhaseForGroup"),lastRoomPhaseParams:{}},p=[c.b.GroupMemberList,c.b.GroupRoomList,c.b.GroupRoomInfo,c.b.GroupMemberInfo],g=[c.b.RoomMemberInfo,c.b.Room3pidMemberInfo,c.b.EncryptionPanel];class f extends r.Store{constructor(){super(i.a),a()(this,"state",void 0),this.state=u}get isOpenForRoom(){return this.state.showRoomPanel}get isOpenForGroup(){return this.state.showGroupPanel}get roomPanelPhase(){return this.state.lastRoomPhase}get groupPanelPhase(){return this.state.lastGroupPhase}get previousPhase(){return c.a.includes(this.state.previousPhase)?this.state.previousPhase:null}get visibleRoomPanelPhase(){return this.isOpenForRoom?this.roomPanelPhase:null}get visibleGroupPanelPhase(){return this.isOpenForGroup?this.groupPanelPhase:null}get roomPanelPhaseParams(){return this.state.lastRoomPhaseParams||{}}setState(e){this.state=Object.assign(this.state,e),l.a.setValue("showRightPanelInRoom",null,m.a.DEVICE,this.state.showRoomPanel),l.a.setValue("showRightPanelInGroup",null,m.a.DEVICE,this.state.showGroupPanel),c.a.includes(this.state.lastRoomPhase)&&l.a.setValue("lastRightPanelPhaseForRoom",null,m.a.DEVICE,this.state.lastRoomPhase),c.a.includes(this.state.lastGroupPhase)&&l.a.setValue("lastRightPanelPhaseForGroup",null,m.a.DEVICE,this.state.lastGroupPhase),this.__emitChange()}__onDispatch(e){switch(e.action){case"view_room":case"view_group":g.includes(this.state.lastRoomPhase)&&this.setState({lastRoomPhase:c.b.RoomMemberList,lastRoomPhaseParams:{}}),this.state.lastGroupPhase===c.b.GroupMemberInfo&&this.setState({lastGroupPhase:c.b.GroupMemberList});break;case d.a.SetRightPanelPhase:{let t=e.phase,s=e.refireParams;if(t===c.b.RoomMemberInfo&&e.refireParams){const{member:n}=e.refireParams,a=Object(o.b)(n);a&&(t=c.b.EncryptionPanel,s={verificationRequest:a,member:n})}if(!c.b[t])return void console.warn("Tried to switch right panel to unknown phase: "+t);p.includes(t)?t===this.state.lastGroupPhase?this.setState({showGroupPanel:!this.state.showGroupPanel,previousPhase:null}):this.setState({lastGroupPhase:t,showGroupPanel:!0,previousPhase:this.state.lastGroupPhase}):t!==this.state.lastRoomPhase||s?this.setState({lastRoomPhase:t,showRoomPanel:!0,lastRoomPhaseParams:s||{},previousPhase:this.state.lastRoomPhase}):this.setState({showRoomPanel:!this.state.showRoomPanel,previousPhase:null}),i.a.dispatch(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?h(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):h(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({action:d.a.AfterRightPanelPhaseChange,phase:t},s||{}));break}case d.a.ToggleRightPanel:"room"===e.type?this.setState({showRoomPanel:!this.state.showRoomPanel}):this.setState({showGroupPanel:!this.state.showGroupPanel})}}static getSharedInstance(){return f.instance||(f.instance=new f),f.instance}}a()(f,"instance",void 0),window.mxRightPanelStore=f.getSharedInstance()},function(e,t,s){"use strict";async function n(e){try{if(navigator&&navigator.clipboard&&navigator.clipboard.writeText)return await navigator.clipboard.writeText(e),!0;{const t=document.createElement("textarea");t.value=e,t.style.top="0",t.style.left="0",t.style.position="fixed",document.body.appendChild(t);const s=document.getSelection(),n=document.createRange();n.selectNode(t),s.removeAllRanges(),s.addRange(n);const a=document.execCommand("copy");return s.removeAllRanges(),document.body.removeChild(t),a}}catch(e){console.error("copyPlaintext failed",e)}return!1}function a(e){const t=document.createRange();t.selectNodeContents(e);const s=window.getSelection();s.removeAllRanges(),s.addRange(t)}function i(e){return a(e),document.execCommand("copy")}s.d(t,"b",(function(){return n})),s.d(t,"c",(function(){return a})),s.d(t,"a",(function(){return i}))},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(139),l=s.n(r),c=s(90),d=s.n(c);class m extends o.a.Component{constructor(...e){super(...e),a()(this,"tooltipContainer",void 0),a()(this,"tooltip",void 0),a()(this,"parent",void 0),a()(this,"renderTooltip",()=>{const e=this.updatePosition({});e.display=this.props.visible?"block":"none";const t=d()("mx_Tooltip",this.props.tooltipClassName,{mx_Tooltip_visible:this.props.visible,mx_Tooltip_invisible:!this.props.visible}),s=o.a.createElement("div",{className:t,style:e},o.a.createElement("div",{className:"mx_Tooltip_chevron"}),this.props.label);this.tooltip=l.a.render(s,this.tooltipContainer)})}componentDidMount(){this.tooltipContainer=document.createElement("div"),this.tooltipContainer.className="mx_Tooltip_wrapper",document.body.appendChild(this.tooltipContainer),window.addEventListener("scroll",this.renderTooltip,!0),this.parent=l.a.findDOMNode(this).parentNode,this.renderTooltip()}componentDidUpdate(){this.renderTooltip()}componentWillUnmount(){l.a.unmountComponentAtNode(this.tooltipContainer),document.body.removeChild(this.tooltipContainer),window.removeEventListener("scroll",this.renderTooltip,!0)}updatePosition(e){const t=this.parent.getBoundingClientRect();let s=0;return s=t.height>25?Math.floor((t.height-25)/2):Math.floor(t.height-25),e.top=t.top-2+this.props.yOffset+window.pageYOffset+s,!this.props.forceOnRight&&t.right>window.innerWidth/2?e.right=window.innerWidth-t.right-window.pageXOffset-16:e.left=t.right+window.pageXOffset+6,e}render(){return o.a.createElement("div",{className:this.props.className})}}a()(m,"defaultProps",{visible:!0,yOffset:0})},,function(e,t,s){"use strict";function n(e){return e/10+"rem"}function a(e){return e+"px"}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a}))},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return o})),s.d(t,"b",(function(){return r})),s.d(t,"c",(function(){return l})),s.d(t,"d",(function(){return c}));var n=s(84),a=s.n(n),i=s(83);const o=a.a.shape({userId:a.a.string.isRequired,displayname:a.a.string,avatarUrl:a.a.string}),r=a.a.shape({displayname:a.a.string,name:a.a.string,roomId:a.a.string.isRequired,canonicalAlias:a.a.string,avatarUrl:a.a.string});function l(e){return{userId:e.user_id,displayname:e.displayname,avatarUrl:e.avatar_url,isPrivileged:e.is_privileged}}function c(e){return{displayname:e.name||e.canonical_alias||Object(i.a)("Unnamed Room"),name:e.name,roomId:e.room_id,canonicalAlias:e.canonical_alias,avatarUrl:e.avatar_url,topic:e.topic,numJoinedMembers:e.num_joined_members,worldReadable:e.world_readable,guestCanJoin:e.guest_can_join,isPublic:!1!==e.is_public}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o})),s.d(t,"c",(function(){return r})),s.d(t,"d",(function(){return l})),s.d(t,"e",(function(){return u})),s.d(t,"f",(function(){return p})),s.d(t,"h",(function(){return g})),s.d(t,"g",(function(){return f}));var n=s(86),a=s(263);const i="all_messages_loud",o="all_messages",r="mentions_only",l="mute",c=[o,i],d=[...c,r];function m(e){return c.includes(e)}function h(e){return d.includes(e)}function u(e){return e.reduce((e,t)=>{const s=p(t.roomId),n=t.getUnreadNotificationCount("highlight")>0,a=f(t),i=a>0&&m(s),o=n&&h(s);return(i||o)&&(e.count+=a,n&&(e.highlight=!0)),e},{count:0,highlight:!1})}function p(e){if(n.a.get().isGuest())return o;if(b(e))return l;let t=null;try{t=n.a.get().getRoomPushRule("global",e)}catch(e){return null}if(!t||!t.enabled)return o;if(_(t))return r;return a.a.actionListToActionsObject(t.actions).tweaks.sound?i:null}function g(e,t){return t===l?function(e){const t=n.a.get(),s=[],a=t.getRoomPushRule("global",e);a&&s.push(t.deletePushRule("global","room",a.rule_id));return s.push(t.addPushRule("global","override",e,{conditions:[{kind:"event_match",key:"room_id",pattern:e}],actions:["dont_notify"]})),Promise.all(s)}(e):function(e,t){const s=n.a.get(),a=[],i=b(e);i&&a.push(s.deletePushRule("global","override",i.rule_id));if("all_messages"===t){const t=s.getRoomPushRule("global",e);t&&a.push(s.deletePushRule("global","room",t.rule_id))}else"mentions_only"===t?(a.push(s.addPushRule("global","room",e,{actions:["dont_notify"]})),a.push(s.setPushRuleEnabled("global","room",e,!0))):(a.push(s.addPushRule("global","room",e,{actions:["notify",{set_tweak:"sound",value:"default"}]})),a.push(s.setPushRuleEnabled("global","room",e,!0)));return Promise.all(a)}(e,t)}function f(e,t=null){let s=e.getUnreadNotificationCount(t);const a=e.currentState.getStateEvents("m.room.create","");if(a&&a.getContent().predecessor){const e=a.getContent().predecessor.room_id,t=n.a.get().getRoom(e);t&&(s+=t.getUnreadNotificationCount("highlight"))}return s}function b(e){const t=n.a.get();if(!t.pushRules||!t.pushRules.global||!t.pushRules.global.override)return null;for(const s of t.pushRules.global.override)if(v(e,s)&&_(s)&&s.enabled)return s;return null}function v(e,t){if(1!==t.conditions.length)return!1;const s=t.conditions[0];return"event_match"===s.kind&&"room_id"===s.key&&s.pattern===e}function _(e){return 1===e.actions.length&&"dont_notify"===e.actions[0]}},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return a}));const n="filter_changed";let a;!function(e){e[e.Lowest=0]="Lowest",e[e.Highest=1]="Highest"}(a||(a={}))},,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(86),a=s(83),i=s(434),o=s(154),r=s(88),l=s(342),c=s(173),d=s(98);function m(e){const t=e.getSender(),{entity:s}=e.getPrevContent(),{entity:n,recommendation:i,reason:o}=e.getContent();return n?i&&o?n===s?l.g.includes(e.getType())?Object(a.a)("%(senderName)s updated the rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.c.includes(e.getType())?Object(a.a)("%(senderName)s updated the rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.f.includes(e.getType())?Object(a.a)("%(senderName)s updated the rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):Object(a.a)("%(senderName)s updated a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):s?l.g.includes(e.getType())?Object(a.a)("%(senderName)s changed a rule that was banning users matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):l.c.includes(e.getType())?Object(a.a)("%(senderName)s changed a rule that was banning rooms matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):l.f.includes(e.getType())?Object(a.a)("%(senderName)s changed a rule that was banning servers matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):Object(a.a)("%(senderName)s updated a ban rule that was matching %(oldGlob)s to matching %(newGlob)s for %(reason)s",{senderName:t,oldGlob:s,newGlob:n,reason:o}):l.g.includes(e.getType())?Object(a.a)("%(senderName)s created a rule banning users matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.c.includes(e.getType())?Object(a.a)("%(senderName)s created a rule banning rooms matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):l.f.includes(e.getType())?Object(a.a)("%(senderName)s created a rule banning servers matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):Object(a.a)("%(senderName)s created a ban rule matching %(glob)s for %(reason)s",{senderName:t,glob:n,reason:o}):Object(a.a)("%(senderName)s updated an invalid ban rule",{senderName:t}):l.g.includes(e.getType())?Object(a.a)("%(senderName)s removed the rule banning users matching %(glob)s",{senderName:t,glob:s}):l.c.includes(e.getType())?Object(a.a)("%(senderName)s removed the rule banning rooms matching %(glob)s",{senderName:t,glob:s}):l.f.includes(e.getType())?Object(a.a)("%(senderName)s removed the rule banning servers matching %(glob)s",{senderName:t,glob:s}):Object(a.a)("%(senderName)s removed a ban rule matching %(glob)s",{senderName:t,glob:s})}const h={"m.room.message":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();let s=t+": "+e.getContent().body;return"m.emote"===e.getContent().msgtype?s="* "+t+" "+s:"m.image"===e.getContent().msgtype&&(s=Object(a.a)("%(senderDisplayName)s sent an image.",{senderDisplayName:t})),s},"m.call.invite":function(e){const t=e.sender?e.sender.name:Object(a.a)("Someone");let s=!0;e.getContent().offer&&e.getContent().offer.sdp&&-1!==e.getContent().offer.sdp.indexOf("m=video")&&(s=!1);const i=n.a.get().supportsVoip();return s&&i?Object(a.a)("%(senderName)s placed a voice call.",{senderName:t}):s&&!i?Object(a.a)("%(senderName)s placed a voice call. (not supported by this browser)",{senderName:t}):!s&&i?Object(a.a)("%(senderName)s placed a video call.",{senderName:t}):s||i?void 0:Object(a.a)("%(senderName)s placed a video call. (not supported by this browser)",{senderName:t})},"m.call.answer":function(e){const t=e.sender?e.sender.name:Object(a.a)("Someone"),s=n.a.get().supportsVoip()?"":Object(a.a)("(not supported by this browser)");return Object(a.a)("%(senderName)s answered the call.",{senderName:t})+" "+s},"m.call.hangup":function(e){const t=e.sender?e.sender.name:Object(a.a)("Someone"),s=e.getContent();let i="";return n.a.get().supportsVoip()?s.reason&&(i="ice_failed"===s.reason?Object(a.a)("(could not connect media)"):"ice_timeout"===s.reason?Object(a.a)("(connection failed)"):"user_media_failed"===s.reason?Object(a.a)("(their device couldn't start the camera / microphone)"):"unknown_error"===s.reason?Object(a.a)("(an error occurred)"):"invite_timeout"===s.reason?Object(a.a)("(no answer)"):"user hangup"===s.reason||"user_hangup"===s.reason?"":Object(a.a)("(unknown failure: %(reason)s)",{reason:s.reason})):i=Object(a.a)("(not supported by this browser)"),Object(a.a)("%(senderName)s ended the call.",{senderName:t})+" "+i},"m.call.reject":function(e){const t=e.sender?e.sender.name:Object(a.a)("Someone");return Object(a.a)("%(senderName)s declined the call.",{senderName:t})}},u={"m.room.name":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return e.getContent().name&&0!==e.getContent().name.trim().length?e.getPrevContent().name?Object(a.a)("%(senderDisplayName)s changed the room name from %(oldRoomName)s to %(newRoomName)s.",{senderDisplayName:t,oldRoomName:e.getPrevContent().name,newRoomName:e.getContent().name}):Object(a.a)("%(senderDisplayName)s changed the room name to %(roomName)s.",{senderDisplayName:t,roomName:e.getContent().name}):Object(a.a)("%(senderDisplayName)s removed the room name.",{senderDisplayName:t})},"m.room.topic":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();return Object(a.a)('%(senderDisplayName)s changed the topic to "%(topic)s".',{senderDisplayName:t,topic:e.getContent().topic})},"m.room.member":function(e){const t=e.sender?e.sender.name:e.getSender();let s=e.target?e.target.name:e.getStateKey();const n=e.getPrevContent(),i=e.getContent();d.a.looksLikeMxId(s)&&(s=d.a.computeDisplayNameFromUserId(s));const o=i.reason?Object(a.a)("Reason")+": "+i.reason:"";switch(i.membership){case"invite":{const e=i.third_party_invite;return e?e.display_name?Object(a.a)("%(targetName)s accepted the invitation for %(displayName)s.",{targetName:s,displayName:e.display_name}):Object(a.a)("%(targetName)s accepted an invitation.",{targetName:s}):Object(a.a)("%(senderName)s invited %(targetName)s.",{senderName:t,targetName:s})}case"ban":return Object(a.a)("%(senderName)s banned %(targetName)s.",{senderName:t,targetName:s})+" "+o;case"join":return n&&"join"===n.membership?n.displayname&&i.displayname&&n.displayname!==i.displayname?Object(a.a)("%(oldDisplayName)s changed their display name to %(displayName)s.",{oldDisplayName:n.displayname,displayName:i.displayname}):!n.displayname&&i.displayname?Object(a.a)("%(senderName)s set their display name to %(displayName)s.",{senderName:e.getSender(),displayName:i.displayname}):n.displayname&&!i.displayname?Object(a.a)("%(senderName)s removed their display name (%(oldDisplayName)s).",{senderName:t,oldDisplayName:n.displayname}):n.avatar_url&&!i.avatar_url?Object(a.a)("%(senderName)s removed their profile picture.",{senderName:t}):n.avatar_url&&i.avatar_url&&n.avatar_url!==i.avatar_url?Object(a.a)("%(senderName)s changed their profile picture.",{senderName:t}):!n.avatar_url&&i.avatar_url?Object(a.a)("%(senderName)s set a profile picture.",{senderName:t}):r.a.getValue("showHiddenEventsInTimeline")?Object(a.a)("%(senderName)s made no change.",{senderName:t}):"":(e.target||console.warn("Join message has no target! -- "+e.getContent().state_key),Object(a.a)("%(targetName)s joined the room.",{targetName:s}));case"leave":return e.getSender()===e.getStateKey()?"invite"===n.membership?Object(a.a)("%(targetName)s rejected the invitation.",{targetName:s}):Object(a.a)("%(targetName)s left the room.",{targetName:s}):"ban"===n.membership?Object(a.a)("%(senderName)s unbanned %(targetName)s.",{senderName:t,targetName:s}):"invite"===n.membership?Object(a.a)("%(senderName)s withdrew %(targetName)s's invitation.",{senderName:t,targetName:s})+" "+o:Object(a.a)("%(senderName)s kicked %(targetName)s.",{senderName:t,targetName:s})+" "+o}},"m.room.third_party_invite":function(e){const t=e.sender?e.sender.name:e.getSender();if(!Object(o.c)(e)){const s=e.getPrevContent().display_name||Object(a.a)("Someone");return Object(a.a)("%(senderName)s revoked the invitation for %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:s})}return Object(a.a)("%(senderName)s sent an invitation to %(targetDisplayName)s to join the room.",{senderName:t,targetDisplayName:e.getContent().display_name})},"m.room.power_levels":function(e){const t=e.sender?e.sender.name:e.getSender();if(!(e.getPrevContent()&&e.getPrevContent().users&&e.getContent()&&e.getContent().users))return"";const s=e.getContent().users_default||0,o=[];Object.keys(e.getContent().users).forEach(e=>{-1===o.indexOf(e)&&o.push(e)}),Object.keys(e.getPrevContent().users).forEach(e=>{-1===o.indexOf(e)&&o.push(e)});const r=[];return o.forEach(t=>{const o=n.a.get().getUser(t).rawDisplayName,l=e.getPrevContent().users[t],c=e.getContent().users[t];c!==l&&r.push(Object(a.a)("%(userId)s from %(fromPowerLevel)s to %(toPowerLevel)s",{userId:o,fromPowerLevel:i.b(l,s),toPowerLevel:i.b(c,s)}))}),r.length?Object(a.a)("%(senderName)s changed the power level of %(powerLevelDiffText)s.",{senderName:t,powerLevelDiffText:r.join(", ")}):""},"m.room.join_rules":function(e){const t=e.sender&&e.sender.name?e.sender.name:e.getSender();switch(e.getContent().join_rule){case"public":return Object(a.a)("%(senderDisplayName)s made the room accessible to whoever knows the link.",{senderDisplayName:t});case"invite":return Object(a.a)("%(senderDisplayName)s made the room invite only.",{senderDisplayName:t});default:return Object(a.a)("%(senderDisplayName)s changed the join rule to %(rule)s",{senderDisplayName:t,rule:e.getContent().join_rule})}},"im.vector.modular.widgets":function(e){const t=e.sender?e.sender.rawDisplayName:e.getSender(),{name:s,type:n,url:i}=e.getPrevContent(),{name:o,type:r,url:l}=e.getContent()||{};let c=o||s||r||n||"";return c&&c.length>0&&(c=c[0].toUpperCase()+c.slice(1)),l?i?Object(a.a)("%(widgetName)s widget modified by %(senderName)s",{widgetName:c,senderName:t}):Object(a.a)("%(widgetName)s widget added by %(senderName)s",{widgetName:c,senderName:t}):Object(a.a)("%(widgetName)s widget removed by %(senderName)s",{widgetName:c,senderName:t})},[c.c]:function(e){var t;const s=(null===(t=e.sender)||void 0===t?void 0:t.name)||e.getSender();return Object(a.a)("%(senderName)s has updated the widget layout",{senderName:s})}};for(const e of l.a)u[e]=m;function p(e){const t=(e.isState()?u:h)[e.getType()];return t?t(e):""}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(86),a=s(242),i=s(114),o=s(83),r=(s(85),s(89),s(88),s(134)),l=s(98);class c{constructor(e){"+"===e[0]?(this.roomId=null,this.groupId=e):(this.roomId=e,this.groupId=null),this.canceled=!1,this.addrs=[],this.busy=!1,this.completionStates={},this.errors={},this.deferred=null}invite(e){if(this.addrs.length>0)throw new Error("Already inviting/invited");this.addrs.push(...e);for(const e of this.addrs)null===Object(a.c)(e)&&(this.completionStates[e]="error",this.errors[e]={errcode:"M_INVALID",errorText:Object(o.a)("Unrecognised address")});return this.deferred=Object(r.b)(),this._inviteMore(0),this.deferred.promise}cancel(){this.busy&&(this._canceled=!0,this.deferred.reject(new Error("canceled")))}getCompletionState(e){return this.completionStates[e]}getErrorText(e){return this.errors[e]?this.errors[e].errorText:null}async _inviteToRoom(e,t,s){const i=Object(a.c)(t),o=l.a.getAccessRules(e);if("email"===i)return l.a.getHSInfoFromEmail(t).then(s=>{const a=l.a.isUserExternFromServerHostname(s.hs);if("restricted"===o&&a)throw{errcode:"TCHAP.EXTERN_NOT_ALLOWED",error:"Externals are allowed to join this room"};return n.a.get().inviteByEmail(e,t)});if("mx-user-id"===i){const a=n.a.get().getRoom(e);if(!a)throw new Error("Room not found");if("restricted"===o&&!0===l.a.isUserExtern(t))throw{errcode:"TCHAP.EXTERN_NOT_ALLOWED",error:"Externals are allowed to join this room"};const i=a.getMember(t);if(i&&["join","invite"].includes(i.membership))throw{errcode:"RIOT.ALREADY_IN_ROOM",error:"Member already invited"};if(!s)try{if(!await n.a.get().getProfileInfo(t))throw new Error("User has no profile")}catch(e){throw{errcode:"RIOT.USER_NOT_FOUND",error:"User does not have a profile or does not exist."}}return n.a.get().invite(e,t)}throw new Error("Unsupported address")}_doInvite(e,t){return new Promise((s,n)=>{let a;console.log("Inviting "+e),a=null!==this.groupId?i.a.inviteUserToGroup(this.groupId,e):this._inviteToRoom(this.roomId,e,t),a.then(()=>{this._canceled||(this.completionStates[e]="invited",delete this.errors[e],s())}).catch(a=>{if(this._canceled)return;let i;console.error(a);let r=!1;if("M_FORBIDDEN"===a.errcode)r=!0,i=Object(o.a)("You do not have permission to invite people to this room.");else if("TCHAP.EXTERN_NOT_ALLOWED"===a.errcode)i=Object(o.a)("The user %(user)s is external",{user:e});else if("RIOT.ALREADY_IN_ROOM"===a.errcode)i=Object(o.a)("User %(userId)s is already in the room",{userId:e});else{if("M_LIMIT_EXCEEDED"===a.errcode)return void setTimeout(()=>{this._doInvite(e,t).then(s,n)},5e3);["M_NOT_FOUND","M_USER_NOT_FOUND","RIOT.USER_NOT_FOUND"].includes(a.errcode)?i=Object(o.a)("User %(user_id)s does not exist",{user_id:e}):"M_PROFILE_UNDISCLOSED"===a.errcode?i=Object(o.a)("User %(user_id)s may or may not exist",{user_id:e}):"M_PROFILE_NOT_FOUND"!==a.errcode||t?i="M_BAD_STATE"===a.errcode?Object(o.a)("The user must be unbanned before they can be invited."):"M_UNSUPPORTED_ROOM_VERSION"===a.errcode?Object(o.a)("The user's homeserver does not support the version of the room."):Object(o.a)("Unknown server error"):(console.warn(`User ${e} does not have a profile - inviting anyways automatically`),this._doInvite(e,!0).then(s,n))}this.completionStates[e]="error",this.errors[e]={errorText:i,errcode:a.errcode},this.busy=!r,this.fatal=r,r?n():s()})})}_inviteMore(e,t){if(this._canceled)return;if(e===this.addrs.length){if(this.busy=!1,Object.keys(this.errors).length>0&&!this.groupId){const e=["M_NOT_FOUND","M_USER_NOT_FOUND","M_PROFILE_UNDISCLOSED","M_PROFILE_NOT_FOUND","RIOT.USER_NOT_FOUND"],t=Object.keys(this.errors).filter(t=>e.includes(this.errors[t].errcode));if(t.length>0){return void(()=>{const e=t.map(e=>this._doInvite(e,!0));Promise.all(e).then(()=>this.deferred.resolve(this.completionStates))})()}}return void this.deferred.resolve(this.completionStates)}const s=this.addrs[e];null!==Object(a.c)(s)&&"invited"!==this.completionStates[s]?this._doInvite(s,t).then(()=>{this._inviteMore(e+1,t)}).catch(()=>this.deferred.resolve(this.completionStates)):this._inviteMore(e+1)}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return R})),s.d(t,"c",(function(){return O})),s.d(t,"a",(function(){return k})),s.d(t,"d",(function(){return D}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(83),l=s(85),c=s(86),d=s(109),m=(s(166),s(92)),h=s(133),u=s(195),p=s(281),g=s(87),f=s(89),b=s(151),v=s(154),_=s(99),y=s(94),E=s(125),C=s(150),w=s(157),S=s(105),x=s(98);const R="dm",O="invite",k="call_transfer";class I{get name(){throw new Error("Member class not implemented")}get userId(){throw new Error("Member class not implemented")}getMxcAvatarUrl(){throw new Error("Member class not implemented")}}class T extends I{constructor(e){super(),a()(this,"_userId",void 0),a()(this,"_displayName",void 0),a()(this,"_avatarUrl",void 0),this._userId=e.user_id,this._displayName=e.display_name,this._avatarUrl=e.avatar_url}get name(){return this._displayName||this._userId}get userId(){return this._userId}getMxcAvatarUrl(){return this._avatarUrl}}class j extends I{constructor(e){super(),a()(this,"_id",void 0),this._id=e}get isEmail(){return this._id.includes("@")}get name(){return this._id}get userId(){return this._id}getMxcAvatarUrl(){return null}}class N extends o.a.PureComponent{constructor(...e){super(...e),a()(this,"_onRemove",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRemove(this.props.member)})}render(){const e=l.getComponent("views.avatars.BaseAvatar"),t=l.getComponent("elements.AccessibleButton"),n=this.props.member.isEmail?o.a.createElement("img",{className:"mx_InviteDialog_userTile_avatar mx_InviteDialog_userTile_threepidAvatar",src:s(614),width:20,height:20}):o.a.createElement(e,{className:"mx_InviteDialog_userTile_avatar",url:Object(h.a)(c.a.get().getHomeserverUrl(),this.props.member.getMxcAvatarUrl(),20,20,"crop"),name:this.props.member.name,idName:this.props.member.userId,width:20,height:20});let a;return this.props.onRemove&&(a=o.a.createElement(t,{className:"mx_InviteDialog_userTile_remove",onClick:this._onRemove},o.a.createElement("img",{src:s(1054),alt:Object(r.a)("Remove"),width:8,height:8}))),o.a.createElement("span",{className:"mx_InviteDialog_userTile"},o.a.createElement("span",{className:"mx_InviteDialog_userTile_pill"},n,o.a.createElement("span",{className:"mx_InviteDialog_userTile_name"},this.props.member.name)),a)}}class P extends o.a.PureComponent{constructor(...e){super(...e),a()(this,"_onClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onToggle(this.props.member)})}_highlightName(e){if(!this.props.highlightWord)return e;const t=e.toLowerCase(),s=this.props.highlightWord.toLowerCase(),n=[];let a,i=0;for(;(a=t.indexOf(s,i))>=0;){a>i&&n.push(o.a.createElement("span",{key:i+"begin"},e.substring(i,a))),i=a;const t=e.substring(i,s.length+i);n.push(o.a.createElement("span",{className:"mx_InviteDialog_roomTile_highlight",key:i+"bold"},t)),i+=t.length}return i<e.length&&n.push(o.a.createElement("span",{key:i+"end"},e.substring(i))),n}render(){const e=l.getComponent("views.avatars.BaseAvatar"),t=this.props.member.isEmail?o.a.createElement("img",{src:s(614),width:36,height:36}):o.a.createElement(e,{url:Object(h.a)(c.a.get().getHomeserverUrl(),this.props.member.getMxcAvatarUrl(),36,36,"crop"),name:this.props.member.name,idName:this.props.member.userId,width:36,height:36});let n=null;this.props.isSelected&&(n=o.a.createElement("div",{className:"mx_InviteDialog_roomTile_selected"}));const a=o.a.createElement("span",{className:"mx_InviteDialog_roomTile_avatarStack"},t,n);let i=this._onClick;this.props.isDisabled&&(i=null);const d=this.props.member.isEmail?Object(r.a)("Invite by email"):null;return o.a.createElement("div",{className:"mx_InviteDialog_roomTile",onClick:i},a,o.a.createElement("span",{className:"mx_InviteDialog_roomTile_nameStack"},o.a.createElement("div",{className:"mx_InviteDialog_roomTile_name"},this._highlightName(this.props.member.name)),o.a.createElement("div",{className:"mx_InviteDialog_roomTile_userId"},d)))}}class D extends o.a.PureComponent{constructor(e){if(super(e),a()(this,"_debounceTimer",null),a()(this,"_editorRef",null),a()(this,"_startDm",async()=>{this.setState({busy:!0});const e=this._convertFilter();let t=e.map(e=>e.userId)[0];if(u.a(t)){const e=await x.a.lookupThreePid("email",t);t=e.mxid?e.mxid:t}const s=[t],n=d.a.shared().getDMRoomForIdentifiers(s);if(n&&"leave"!==n.currentState.members[t].membership)return g.a.dispatch({action:"view_room",room_id:n.roomId,should_peek:!1,joining:!1}),void this.props.onFinished();let a=x.a.getExistingRoom(c.a.get().getUserId(),t);if(a){switch(a.state){case"invite":c.a.get().joinRoom(a.roomId,null).then(()=>{g.a.dispatch({action:"view_room",room_id:a.roomId,should_peek:!1,joining:!0})});break;case"leave":Object(v.a)(a.roomId,s).then(e=>{g.a.dispatch({action:"view_room",room_id:a.roomId,should_peek:!1,joining:!1}),this._shouldAbortAfterInviteError(e)||this.props.onFinished()}).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(r.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})})}return void this.props.onFinished()}const i={inlineErrors:!0,access_rules:"direct"};if(Object(b.e)()){if(!e.some(e=>e instanceof j)){const e=c.a.get();await Object(b.a)(e,s)&&(i.encryption=!0)}}let o=Promise.resolve();const l=1===s.length&&s[0]===c.a.get().getUserId();1!==s.length||l?o=l?Object(b.b)(i):Object(b.b)(i).then(e=>Object(v.a)(e,s)).then(e=>{if(this._shouldAbortAfterInviteError(e))return!0}):(i.dmUserId=s[0],o=Object(b.b)(i)),o.then(e=>{!0!==e&&this.props.onFinished()}).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(r.a)("We couldn't create your DM. Please check the users you want to invite and try again.")})})}),a()(this,"_inviteUsers",async()=>{S.a.getTimestamp();this.setState({busy:!0}),this._convertFilter();const e=this._convertFilter().map(e=>e.userId);if(!c.a.get().getRoom(this.props.roomId))return console.error("Failed to find the room to invite users to"),void this.setState({busy:!1,errorText:Object(r.a)("Something went wrong trying to invite the users.")});const t=await Promise.all(e.map(async e=>{let t=e;if(u.a(e)){const s=await x.a.lookupThreePid("email",e);t=s.mxid?s.mxid:t}return t}));Object(v.a)(this.props.roomId,t).then(e=>{this._shouldAbortAfterInviteError(e)||e.inviter.busy||this.props.onFinished()}).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(r.a)("We couldn't invite those users. Please check the users you want to invite and try again.")})})}),a()(this,"_transferCall",async()=>{this._convertFilter();const e=this._convertFilter().map(e=>e.userId);e.length>1&&this.setState({errorText:Object(r.a)("A call can only be transferred to a single user.")}),this.setState({busy:!0});try{await this.props.call.transfer(e[0]),this.setState({busy:!1}),this.props.onFinished()}catch(e){this.setState({busy:!1,errorText:Object(r.a)("Failed to transfer call")})}}),a()(this,"_onKeyDown",e=>{if(this.state.busy)return;const t=e.target.value.trim(),s=e.ctrlKey||e.shiftKey||e.metaKey;!t&&this.state.targets.length>0&&e.key===_.a.BACKSPACE&&!s?(e.preventDefault(),this._removeMember(this.state.targets[this.state.targets.length-1])):(t&&e.key===_.a.ENTER&&!s||t&&e.key===_.a.SPACE&&!s&&t.includes("@")&&!t.includes(" "))&&(e.preventDefault(),this._convertFilter())}),a()(this,"_updateSuggestions",async e=>{if(c.a.get().searchUserDirectory({term:e}).then(async t=>{if(e===this.state.filterText){if(t.results||(t.results=[]),"@"===e[0]&&e.indexOf(":")>1)try{const s=await c.a.get().getProfileInfo(e);s&&t.results.splice(0,0,{user_id:e,display_name:s.displayname,avatar_url:s.avatar_url})}catch(s){console.warn("Non-fatal error trying to make an invite for a user ID"),console.warn(s),t.results.splice(0,0,{user_id:e,display_name:e,avatar_url:null})}this.setState({serverResultsMixin:t.results.map(e=>({userId:e.user_id,user:new T(e)}))})}}).catch(e=>{console.error("Error searching user directory:"),console.error(e),this.setState({serverResultsMixin:[]})}),this.state.canUseIdentityServer){if(e.indexOf("@")>0&&u.a(e)){this.setState({threepidResultsMixin:[{user:new j(e),userId:e}]});try{if(e!==this.state.filterText)return;const t=await x.a.lookupThreePid("email",e);if(e!==this.state.filterText)return;if(!t||!t.mxid)return;const s=await c.a.get().getProfileInfo(t.mxid);if(e!==this.state.filterText||!s)return;this.setState({threepidResultsMixin:[...this.state.threepidResultsMixin,{user:new T({user_id:t.mxid,display_name:s.displayname,avatar_url:s.avatar_url}),userId:t.mxid}]})}catch(e){console.error("Error searching identity server:"),console.error(e),this.setState({threepidResultsMixin:[]})}}}else this.setState({tryingIdentityServer:!0})}),a()(this,"_updateFilter",e=>{const t=e.target.value;this.setState({filterText:t}),this._debounceTimer&&clearTimeout(this._debounceTimer),this._debounceTimer=setTimeout(()=>{this._updateSuggestions(t)},150)}),a()(this,"_showMoreRecents",()=>{this.setState({numRecentsShown:this.state.numRecentsShown+5})}),a()(this,"_showMoreSuggestions",()=>{this.setState({numSuggestionsShown:this.state.numSuggestionsShown+5})}),a()(this,"_toggleMember",e=>{let t=this.state.filterText;const s=this.state.targets.map(e=>e),n=s.indexOf(e);n>=0?s.splice(n,1):(s.push(e),t=""),this.setState({targets:s,filterText:t}),this._editorRef&&this._editorRef.current&&this._editorRef.current.focus()}),a()(this,"_removeMember",e=>{const t=this.state.targets.map(e=>e),s=t.indexOf(e);s>=0&&(t.splice(s,1),this.setState({targets:t})),this._editorRef&&this._editorRef.current&&this._editorRef.current.focus()}),a()(this,"_onPaste",async e=>{if(this.state.filterText)return;e.preventDefault();const t=e.clipboardData.getData("text"),s=[...this.state.recents,...this.state.suggestions,...this.state.serverResultsMixin,...this.state.threepidResultsMixin],n=[],a=[],i=t.split(/[\s,]+/).map(e=>e.trim()).filter(e=>!!e);for(const t of i){const i=s.find(e=>e.userId===t);if(i)n.push(i.user);else if(t.indexOf("@")>0&&u.a(t))n.push(new j(t));else if("@"===t[0])try{const e=await c.a.get().getProfileInfo(t),s=e?e.displayname:null,a=e?e.avatar_url:null;n.push(new T({user_id:t,display_name:s,avatar_url:a}))}catch(e){console.error("Error looking up profile for "+t),console.error(e),a.push(t)}else a.push(t)}if(a.length>0){const e=l.getComponent("dialogs.QuestionDialog");f.a.createTrackedDialog("Invite Paste Fail","",e,{title:Object(r.a)("Failed to find the following users"),description:Object(r.a)("The following users might not exist or are invalid, and cannot be invited: %(csvNames)s",{csvNames:a.join(", ")}),button:Object(r.a)("OK")})}this.setState({targets:[...this.state.targets,...n]})}),a()(this,"_onClickInputArea",e=>{e.preventDefault(),e.stopPropagation(),this._editorRef&&this._editorRef.current&&this._editorRef.current.focus()}),a()(this,"_onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(p.d)(),this.setState({canUseIdentityServer:!0,tryingIdentityServer:!1})}),a()(this,"_onManageSettingsClick",e=>{e.preventDefault(),g.a.fire(y.a.ViewUserSettings),this.props.onFinished()}),a()(this,"_onCommunityInviteClick",e=>{this.props.onFinished(),Object(v.e)(w.a.instance.getSelectedCommunityId())}),e.kind===O&&!e.roomId)throw new Error("When using KIND_INVITE a roomId is required for an InviteDialog");if(e.kind===k&&!e.call)throw new Error("When using KIND_CALL_TRANSFER a call is required for an InviteDialog");const t=new Set([c.a.get().getUserId(),m.a.get().welcomeUserId]);if(e.roomId){const s=c.a.get().getRoom(e.roomId);if(!s)throw new Error("Room ID given to InviteDialog does not look like a room");s.getMembersWithMembership("invite").forEach(e=>t.add(e.userId)),s.getMembersWithMembership("join").forEach(e=>t.add(e.userId)),s.getMembersWithMembership("ban").forEach(e=>t.add(e.userId)),this._onInviteFromFileClick=this._onInviteFromFileClick.bind(this),S.a.instance.trackBeginInvite(e.roomId)}this.state={targets:[],filterText:this.props.initialText,recents:D.buildRecents(t),numRecentsShown:3,suggestions:this._buildSuggestions(t),numSuggestionsShown:3,serverResultsMixin:[],threepidResultsMixin:[],canUseIdentityServer:!!c.a.get().getIdentityServerUrl(),tryingIdentityServer:!1,busy:!1,errorText:null},this._editorRef=Object(i.createRef)()}componentDidMount(){this.props.initialText&&this._updateSuggestions(this.props.initialText)}static buildRecents(e){const t=d.a.shared().getUniqueRoomsWithIndividuals(),s=C.b.instance.orderedLists[E.a.DM]||[],n=c.a.get().getUserId();for(const e of s){const s=e.getJoinedMembers().filter(e=>e.userId!==n);for(const n of s)t[n.userId]||(console.warn(`Adding DM room for ${n.userId} as ${e.roomId} from tag, not DM map`),t[n.userId]=e)}const a=[];for(const s in t){if(e.has(s)){console.warn(`[Invite:Recents] Excluding ${s} from recents`);continue}const n=t[s],i=n.getMember(s);if(!i){console.warn(`[Invite:Recents] ${s} is missing a member object in their own DM (${n.roomId})`);continue}const o=["m.room.message","m.room.encrypted","m.sticker"],r=20;let l=0;if(n.timeline&&n.timeline.length)for(let e=n.timeline.length-1;e>=0;e--){const t=n.timeline[e];if(o.includes(t.getType())){l=t.getTs();break}if(n.timeline.length-e>r)break}l?a.push({userId:s,user:i,lastActive:l}):console.warn(`[Invite:Recents] ${s} (${n.roomId}) has a weird last timestamp: ${l}`)}return a||console.warn("[Invite:Recents] No recents to suggest!"),a.sort((e,t)=>t.lastActive-e.lastActive),a}_buildSuggestions(e){const t=c.a.get().getRooms().filter(e=>"join"===e.getMyMembership()&&e.getJoinedMemberCount()<=200).reduce((t,s)=>{if(d.a.shared().getUserIdForRoomId(s.roomId))return t;const n=s.getJoinedMembers().filter(t=>!e.has(t.userId));for(const a of n)e.has(a.userId)||(t[a.userId]||(t[a.userId]={member:a,pickedMemberRoomSize:s.getJoinedMemberCount(),rooms:[]}),t[a.userId].rooms.push(s),s.getJoinedMemberCount()<t[a.userId].pickedMemberRoomSize&&(t[a.userId].member=a,t[a.userId].pickedMemberRoomSize=s.getJoinedMemberCount()));return t},{}),s=Object.values(t).reduce((e,t)=>{const s=t.rooms.reduce((e,t)=>e+t.getJoinedMemberCount(),0),n=200*t.rooms.length;return e[t.member.userId]={member:t.member,numRooms:t.rooms.length,score:Math.max(0,Math.pow(1-s/n,5))},e},{}),n=c.a.get().getRooms().filter(e=>"join"===e.getMyMembership()),a=(new Date).getTime(),i=a-36e5,o={},r={};for(const t of n){const s=d.a.shared().getUserIdForRoomId(t.roomId);if(Object.keys(t.tags).includes("m.lowpriority")||s)continue;const n=t.getLiveTimeline().getEvents();for(let s=n.length-1;s>=Math.max(0,n.length-50);s--){const a=n[s];if(!e.has(a.getSender())){if(a.getTs()<=i)break;(!o[a.getSender()]||o[a.getSender()]<a.getTs())&&(o[a.getSender()]=a.getTs(),r[a.getSender()]=t.getMember(a.getSender()))}}}for(const e in o){const t=o[e],n=r[e];if(!n)continue;const l=a-i-Math.abs(a-t),c=Math.max(1,l/9e5);let d=s[e];d||(d=s[e]={score:0}),d.member=n,d.score+=c}const l=Object.values(s);return l.sort((e,t)=>e.score===t.score?e.numRooms===t.numRooms?e.member.userId.localeCompare(t.member.userId):t.numRooms-e.numRooms:t.score-e.score),l.map(e=>({userId:e.member.userId,user:e.member}))}_shouldAbortAfterInviteError(e){const t=Object.keys(e.states).filter(t=>"error"===e.states[t]);if(t.length>0){if(console.log("Failed to invite users: ",e),"TCHAP.EXTERN_NOT_ALLOWED"===e.inviter.errors[Object.keys(e.inviter.errors)[0]].errcode){let t;t=u.a(e.inviter.addrs[0])?e.inviter.addrs[0]:c.a.get().getUser(e.inviter.addrs[0]).rawDisplayName,this.setState({busy:!1,errorText:Object(r.a)("The user %(user)s is external",{user:t})})}else if("M_BAD_STATE"===e.inviter.errors[Object.keys(e.inviter.errors)[0]].errcode){const t=c.a.get().getUser(e.inviter.addrs[0]).rawDisplayName,s=`${Object(r.a)("Failed to invite the following users to chat: %(csvUsers)s",{csvUsers:t})}\n                    : ${e.inviter.errors[Object.keys(e.inviter.errors)[0]].errorText}`;this.setState({busy:!1,errorText:s})}else this.setState({busy:!1,errorText:Object(r.a)("Failed to invite the following users to chat: %(csvUsers)s",{csvUsers:t.join(", ")})});return!0}return!1}_convertFilter(){if(!this.state.filterText||!this.state.filterText.includes("@"))return this.state.targets||[];let e;this.state.filterText.startsWith("@")&&(e=new T({user_id:this.state.filterText,display_name:null,avatar_url:null}));const t=[...this.state.targets||[],e];return this.setState({targets:t,filterText:""}),t}_renderSection(e){let t="recents"===e?this.state.recents:this.state.suggestions,s="recents"===e?this.state.numRecentsShown:this.state.numSuggestionsShown;const n="recents"===e?this._showMoreRecents.bind(this):this._showMoreSuggestions.bind(this);let a="recents"===e?Object(r.a)("Recent Conversations"):Object(r.a)("Suggestions"),i=null;if("suggestions"===e&&w.a.instance.getSelectedCommunityId()){const e=w.a.instance.getSelectedCommunityName();i=Object(r.a)("May include members not in %(communityName)s",{communityName:e})}this.props.kind===O&&(a="recents"===e?Object(r.a)("Recently Direct Messaged"):Object(r.a)("Suggestions"));let d=[],m=[];const h=this.state.serverResultsMixin||this.state.threepidResultsMixin;if(this.state.filterText&&h&&"suggestions"===e){const e=e=>!t.some(t=>t.userId===e.userId)&&!d.some(t=>t.userId===e.userId)&&!m.some(t=>t.userId===e.userId);m=this.state.serverResultsMixin.filter(e),d=this.state.threepidResultsMixin.filter(e)}const u=d.length>0||m.length>0;if(0===t.length&&!u)return null;if(this.state.filterText){const e=this.state.filterText.toLowerCase();if(t=t.filter(t=>t.user.name.toLowerCase().includes(e)||t.userId.toLowerCase().includes(e)),0===t.length&&!u)return o.a.createElement("div",{className:"mx_InviteDialog_section"},o.a.createElement("h3",null,a),o.a.createElement("p",null,Object(r.a)("No results")))}if(t=[...d,...t,...m],s===t.length-1&&s++,this.props.kind!==R){"restricted"===x.a.getAccessRules(this.props.roomId)&&(t=t.filter(e=>!x.a.isUserExtern(e.userId)));const e=c.a.get().getRoom(this.props.roomId).currentState.getStateEvents("m.room.create","");if(e&&!1===e.getContent()["m.federate"]){const e=c.a.get().getDomain();t=t.filter(t=>e===x.a.getLongDomainFromId(t.userId))}}if(t.length<1)return null;const p=t.slice(0,s),g=p.length<t.length,f=l.getComponent("elements.AccessibleButton");let b=null;g&&(b=o.a.createElement(f,{onClick:n,kind:"link"},Object(r.a)("Show more")));let v=!1;this.props.roomId||(v=Boolean(this.state.targets.length));const _=p.map(t=>{return o.a.createElement(P,{member:t.user,lastActiveTs:(s=t,"recents"===e?s.lastActive:null),key:t.userId,onToggle:this._toggleMember,highlightWord:this.state.filterText,isSelected:this.state.targets.some(e=>e.userId===t.userId),isDisabled:v});var s});return o.a.createElement("div",{className:"mx_InviteDialog_section"},o.a.createElement("h3",null,a),i?o.a.createElement("p",{className:"mx_InviteDialog_subname"},i):null,_,b)}_renderEditor(){const e=this.state.targets.map(e=>o.a.createElement(N,{member:e,onRemove:!this.state.busy&&this._removeMember,key:e.userId}));let t=!1;this.props.roomId||(t=Boolean(e.length)||this.state.busy);const s=o.a.createElement("input",{type:"text",onKeyDown:this._onKeyDown,onChange:this._updateFilter,value:this.state.filterText,ref:this._editorRef,onPaste:this._onPaste,autoFocus:!0,disabled:t,autoComplete:"off"});return o.a.createElement("div",{className:"mx_InviteDialog_editor",onClick:this._onClickInputArea},e,s)}_renderRestriction(){let e=null;return this.props.kind!==R&&"unrestricted"===x.a.getAccessRules(this.props.roomId)&&(e=o.a.createElement("p",{className:"mx_InviteDialog_warningText"},Object(r.a)("Externals are allowed to join this room"))),e}_onInviteFromFileClick(){this.props.onFinished(),g.a.dispatch({action:"view_invite_file",roomId:this.props.roomId})}render(){const e=l.getComponent("views.dialogs.BaseDialog"),t=l.getComponent("elements.AccessibleButton"),s=l.getComponent("elements.Spinner");let n,a,i,c,d=null;this.state.busy&&(d=o.a.createElement(s,{w:20,h:20})),this.props.kind===R?(n=Object(r.a)("Direct Messages"),a=Object(r.a)("Start a conversation with someone using their name or email address."),i=Object(r.a)("Go"),c=this._startDm):this.props.kind===O?(n=Object(r.a)("Invite to this room"),a=Object(r.a)("Invite someone using their name or email address."),i=Object(r.a)("Invite"),c=this._inviteUsers):this.props.kind===k?(n=Object(r.a)("Transfer"),i=Object(r.a)("Transfer"),c=this._transferCall):console.error("Unknown kind of InviteDialog: "+this.props.kind);let m=null;this.props.kind!==R&&(m=o.a.createElement("details",null,o.a.createElement("summary",null,Object(r.a)("Advanced")),o.a.createElement("p",null,o.a.createElement("button",{onClick:this._onInviteFromFileClick},Object(r.a)("Invite users from a file")))));const h=this.state.targets.length>0;return o.a.createElement(e,{className:"mx_InviteDialog",hasCancel:!0,onFinished:this.props.onFinished,title:n},o.a.createElement("div",{className:"mx_InviteDialog_content"},o.a.createElement("p",{className:"mx_InviteDialog_helpText"},a),this._renderRestriction(),o.a.createElement("div",{className:"mx_InviteDialog_addressBar"},this._renderEditor(),o.a.createElement("div",{className:"mx_InviteDialog_buttonAndSpinner"},o.a.createElement(t,{kind:"primary",onClick:c,className:"mx_InviteDialog_goButton",disabled:this.state.busy||!h},i),d)),o.a.createElement("div",{className:"error"},this.state.errorText),o.a.createElement("div",{className:"mx_InviteDialog_userSections"},this._renderSection("recents"),this._renderSection("suggestions"),m)))}}a()(D,"defaultProps",{kind:R,initialText:""})},,,,,,function(e,t,s){"use strict";s.d(t,"e",(function(){return r})),s.d(t,"d",(function(){return l})),s.d(t,"g",(function(){return c})),s.d(t,"c",(function(){return d})),s.d(t,"f",(function(){return m})),s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return p}));var n=s(82),a=s.n(n),i=s(767),o=s(86);const r="m.room.rule.user",l="m.room.rule.server",c=[r,"org.matrix.mjolnir.rule.user"],d=["m.room.rule.room","org.matrix.mjolnir.rule.room"],m=[l,"org.matrix.mjolnir.rule.server"],h=[...c,...d,...m];function u(e,t=!0){return c.includes(e)?t?c[c.length-1]:r:d.includes(e)?t?d[d.length-1]:"m.room.rule.room":m.includes(e)?t?m[m.length-1]:l:null}class p{constructor(e){a()(this,"_rules",[]),a()(this,"_roomId",void 0),this._roomId=e,this.updateList()}get roomId(){return this._roomId}get serverRules(){return this._rules.filter(e=>e.kind===l)}get userRules(){return this._rules.filter(e=>e.kind===r)}get roomRules(){return this._rules.filter(e=>"m.room.rule.room"===e.kind)}async banEntity(e,t,s){await o.a.get().sendStateEvent(this._roomId,u(e,!0),{entity:t,reason:s,recommendation:Object(i.c)(i.b,!0)},"rule:"+t),this._rules.push(new i.a(t,i.b,s,u(e,!1)))}async unbanEntity(e,t){await o.a.get().sendStateEvent(this._roomId,u(e,!0),{},"rule:"+t),this._rules=this._rules.filter(s=>s.kind!==u(e,!1)||s.entity!==t)}updateList(){this._rules=[];const e=o.a.get().getRoom(this._roomId);if(e)for(const t of h){const s=e.currentState.getStateEvents(t,void 0);for(const e of s){if(!e.getStateKey())continue;const s=u(t,!1),n=e.getContent().entity,a=e.getContent().recommendation,o=e.getContent().reason;n&&a&&o&&this._rules.push(new i.a(n,a,o,s))}}}}},function(e,t,s){"use strict";function n(e,t){if(e===t)return!0;if("object"!=typeof e||null===e||"object"!=typeof t||null===t)return!1;const s=Object.keys(e),n=Object.keys(t);if(s.length!==n.length)return!1;for(let n=0;n<s.length;n++){const a=s[n];if(!t.hasOwnProperty(a)||e[a]!==t[a])return!1}return!0}s.d(t,"a",(function(){return n}))},,function(e,t,s){"use strict";(function(e){s.d(t,"g",(function(){return U})),s.d(t,"b",(function(){return M})),s.d(t,"a",(function(){return L})),s.d(t,"c",(function(){return F})),s.d(t,"j",(function(){return H})),s.d(t,"k",(function(){return G})),s.d(t,"d",(function(){return q})),s.d(t,"h",(function(){return J})),s.d(t,"l",(function(){return Q})),s.d(t,"f",(function(){return X})),s.d(t,"e",(function(){return Z})),s.d(t,"i",(function(){return te})),s.d(t,"m",(function(){return ne}));var n=s(95),a=s(210),i=s(273),o=s(86),r=s(248),l=s(214),c=s(658),d=s(116),m=s(249),h=s(451),u=s(1141),p=s(87),g=s(109),f=s(89),b=s(85),v=s(244),_=s(107),y=s(346),E=s(347),C=s(88),w=s(660),S=s(138),x=s(164),R=s(452),O=s(1499),k=s(447),I=s(252),T=s(664),j=s(105),N=s(141),P=s(1143),D=s(140),A=s(83);async function U(e={}){try{let t=e.enableGuest||!1;const s=e.guestHsUrl,a=e.guestIsUrl,i=e.fragmentQueryParams||{},o=e.defaultDeviceDisplayName;if(t&&!s&&(console.warn("Cannot enable guest access: can't determine HS URL to use"),t=!1),t&&i.guest_user_id&&i.guest_access_token)return console.log("Using guest access credentials"),K({userId:i.guest_user_id,accessToken:i.guest_access_token,homeserverUrl:s,identityServerUrl:a,guest:!0},!0).then(()=>!0);return!!await H({ignoreGuest:Boolean(e.ignoreGuest)})||!!t&&function(e,t,s){console.log("Doing guest login on "+e);return n.q.createClient({baseUrl:e}).registerGuest({body:{initial_device_display_name:s}}).then(s=>(console.log("Registered as guest: "+s.user_id),K({userId:s.user_id,deviceId:s.device_id,accessToken:s.access_token,homeserverUrl:e,identityServerUrl:t,guest:!0},!0).then(()=>!0)),e=>(console.error("Failed to register as guest",e),!1))}(s,a,o)}catch(e){return!(e instanceof z)&&async function(e){console.error("Unable to load session",e);const t=b.getComponent("views.dialogs.SessionRestoreErrorDialog"),s=f.a.createTrackedDialog("Session Restore Error","",t,{error:e.message}),[n]=await s.finished;if(n)return await se(),!1;return U()}(e)}}async function M(){const{hsUrl:e,userId:t,hasAccessToken:s,isGuest:n}=await B();return e&&t&&s?[t,n]:[null,null]}function L(e,t,s){if(!e.loginToken)return Promise.resolve(!1);const a=localStorage.getItem(I.a),i=localStorage.getItem(I.c);return a?Object(y.c)(a,i,"m.login.token",{token:e.loginToken,initial_device_display_name:t}).then((function(e){return console.log("Logged in with token"),se().then(async()=>(await $(e),sessionStorage.setItem("mx_fresh_login",String(!0)),!0))})).catch(e=>(f.a.createTrackedDialog("SSO","Token Rejected",D.a,{title:Object(A.a)("We couldn't log you in"),description:"ConnectionError"===e.name?Object(A.a)("Your homeserver was unreachable and was not able to log you in. Please try again. If this continues, please contact your homeserver administrator."):Object(A.a)("Your homeserver rejected your log in attempt. This could be due to things just taking too long. Please try again. If this continues, please contact your homeserver administrator."),button:Object(A.a)("Try again"),onFinished:e=>{if(e){const e=n.q.createClient({baseUrl:a,idBaseUrl:i}),t=localStorage.getItem(I.b)||void 0;_.a.get().startSingleSignOn(e,"sso",s,t)}}}),console.error("Failed to log in with login token:"),console.error(e),!1)):(console.warn("Cannot log in with token: can't determine HS URL to use"),f.a.createTrackedDialog("SSO","Unknown HS",D.a,{title:Object(A.a)("We couldn't log you in"),description:Object(A.a)("We asked the browser to remember which homeserver you use to let you sign in, but unfortunately your browser has forgotten it. Go to the sign in page and try again."),button:Object(A.a)("Try again")}),Promise.resolve(!1))}function F(e){if(e.reason===a.b.TOGGLED_LAZY_LOADING)return Promise.resolve().then(()=>{if(e.value){const e=b.getComponent("views.dialogs.LazyLoadingResyncDialog");return new Promise(t=>{f.a.createDialog(e,{onFinished:t})})}{const e=b.getComponent("views.dialogs.LazyLoadingDisabledDialog");return new Promise(t=>{f.a.createDialog(e,{onFinished:t,host:window.location.host})})}}).then(()=>o.a.get().store.deleteAllData()).then(()=>{_.a.get().reload()})}async function B(){const e=localStorage.getItem("mx_hs_url"),t=localStorage.getItem("mx_is_url");let s;try{s=await E.c("account","mx_access_token")}catch(e){}if(!s&&(s=localStorage.getItem("mx_access_token"),s))try{await E.d("account","mx_access_token",s),localStorage.removeItem("mx_access_token")}catch(e){}const n="true"===localStorage.getItem("mx_has_access_token")||!!s,a=localStorage.getItem("mx_user_id"),i=localStorage.getItem("mx_device_id");let o;return o=null!==localStorage.getItem("mx_is_guest")?"true"===localStorage.getItem("mx_is_guest"):"true"===localStorage.getItem("matrix-is-guest"),{hsUrl:e,isUrl:t,hasAccessToken:n,accessToken:s,userId:a,deviceId:i,isGuest:o}}async function V(e){const t=new Uint8Array(e.length);for(let s=0;s<e.length;s++)t[s]=e.charCodeAt(s);const s=await window.crypto.subtle.importKey("raw",t,"HKDF",!1,["deriveBits"]);return t.fill(0),new Uint8Array(await window.crypto.subtle.deriveBits({name:"HKDF",hash:"SHA-256",salt:new Uint8Array(32),info:new Uint8Array(0)},s,256))}async function W(){if(await function(){const e=b.getComponent("views.dialogs.StorageEvictedDialog");return new Promise(t=>{f.a.createTrackedDialog("Storage evicted","",e,{onFinished:t})})}())throw await se(),new z("Aborting login in progress because of storage inconsistency")}async function H(e){const t=null==e?void 0:e.ignoreGuest;if(!localStorage)return!1;const{hsUrl:s,isUrl:n,hasAccessToken:a,accessToken:o,userId:r,deviceId:l,isGuest:c}=await B();if(a&&!o&&W(),o&&r&&s){if(t&&c)return console.log("Ignoring stored guest account: "+r),!1;let e=o;const a=await _.a.get().getPickleKey(r,l);if(a){if(console.log("Got pickle key"),"string"!=typeof o){const t=await V(a);e=await Object(i.a)(o,t,"access_token"),t.fill(0)}}else console.log("No pickle key available");const d="true"===sessionStorage.getItem("mx_fresh_login");return sessionStorage.removeItem("mx_fresh_login"),console.log("Restoring session for "+r),await K({userId:r,deviceId:l,accessToken:e,homeserverUrl:s,identityServerUrl:n,guest:c,pickleKey:a,freshLogin:d},!1),!0}return console.log("No previous session found."),!1}async function G(e){e.freshLogin=!0,ne();const t=e.userId&&e.deviceId?await _.a.get().createPickleKey(e.userId,e.deviceId):null;return t?console.log("Created pickle key"):console.log("Pickle key not created"),K(Object.assign({},e,{pickleKey:t}),!0)}function q(e){const t=o.a.get().getUserId(),s=o.a.get().getDeviceId();ne(),localStorage.removeItem("mx_soft_logout"),Y=!1;const n=e.userId!==t||e.deviceId!==s;return n&&console.warn("Clearing all data: Old session belongs to a different user/session"),K(e,n)}async function K(e,t){e.guest=Boolean(e.guest);const s=X();console.log("setLoggedIn: mxid: "+e.userId+" deviceId: "+e.deviceId+" guest: "+e.guest+" hs: "+e.homeserverUrl+" softLogout: "+s," freshLogin: "+e.freshLogin),p.a.dispatch({action:"on_logging_in"},!0),t&&await se();const n=await E.a();n.dataInLocalStorage&&n.cryptoInited&&!n.dataInCryptoStore&&await W(),d.a.setLoggedIn(e.guest,e.homeserverUrl),o.a.replaceUsingCreds(e);const a=o.a.get();if(e.freshLogin&&C.a.getValue("feature_dehydration")){const t=await a.rehydrateDevice();t&&(e.deviceId=t),delete e.freshLogin}if(localStorage)try{await $(e),sessionStorage.removeItem("mx_fresh_login")}catch(e){console.warn("Error using local storage: can't persist session!",e)}else console.warn("No local storage available: can't persist session!");return p.a.dispatch({action:"on_logged_in"}),await ee(!s),a}class z extends Error{}async function $(e){var t;if(localStorage.setItem("mx_hs_url",e.homeserverUrl),e.identityServerUrl&&localStorage.setItem("mx_is_url",e.identityServerUrl),localStorage.setItem("mx_user_id",e.userId),localStorage.setItem("mx_is_guest",JSON.stringify(e.guest)),e.accessToken?localStorage.setItem("mx_has_access_token","true"):localStorage.deleteItem("mx_has_access_token"),e.pickleKey){let t;try{const s=await V(e.pickleKey);t=await Object(i.b)(e.accessToken,s,"access_token"),s.fill(0)}catch(e){console.warn("Could not encrypt access token",e)}try{await E.d("account","mx_access_token",t||e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.setItem("mx_has_pickle_key",String(!0))}else{try{await E.d("account","mx_access_token",e.accessToken)}catch(t){localStorage.setItem("mx_access_token",e.accessToken)}localStorage.getItem("mx_has_pickle_key")&&console.error("Expected a pickle key, but none provided.  Encryption may not work.")}e.deviceId&&localStorage.setItem("mx_device_id",e.deviceId),null===(t=r.a.persistCredentials)||void 0===t||t.call(r.a,e),console.log("Session persisted for "+e.userId)}let Y=!1;function J(){if(!o.a.get())return;if(j.a.instance.disabled||j.a.instance.enable(!0),o.a.get().isGuest())return void e(()=>te());Y=!0;const t=o.a.get();_.a.get().destroyPickleKey(t.getUserId(),t.getDeviceId()),t.logout().then(te,e=>{console.log("Failed to call logout API: token will not be invalidated"),te()})}function Q(){o.a.get()&&(localStorage.setItem("mx_soft_logout","true"),console.log("Soft logout initiated"),Y=!0,p.a.dispatch({action:"on_client_not_viable"}),ne(!1))}function X(){return"true"===localStorage.getItem("mx_soft_logout")}function Z(){return Y}async function ee(e=!0){console.log("Lifecycle: Starting MatrixClient"),p.a.dispatch({action:"will_start_client"},!0),w.a.sharedInstance().reset(),S.a.sharedInstance().reset(),m.default.start(),h.a.sharedInstance().start(),g.a.makeShared().start(),x.a.sharedInstance().startWatching(),v.a.start(),N.b.sharedInstance().start(),R.a.sharedInstance().start(),e?(await l.a.init(),await o.a.start()):(console.warn("Caller requested only auxiliary services be started"),await o.a.assign()),O.a.sharedInstance().start(),C.a.getValue("lowBandwidth")||u.a.start(),await k.a.getInstance().start(),p.a.dispatch({action:"client_started"}),X()&&Q()}async function te(){var e;Y=!1,p.a.dispatch({action:"on_logged_out"},!0),ne(),await se({deleteEverything:!0}),null===(e=P.a.onLoggedOutAndStorageCleared)||void 0===e||e.call(P.a)}async function se(e){if(d.a.disable(),window.localStorage){const t=T.a.instance.getWireInvites();window.localStorage.clear();try{await E.b("account","mx_access_token")}catch(e){}null!=e&&e.deleteEverything||t.forEach(e=>{const t=e.roomId;delete e.roomId,T.a.instance.storeInvite(t,e)})}window.sessionStorage&&window.sessionStorage.clear();const t=Object(c.a)({baseUrl:""});await l.a.deleteEventIndex(),await t.clearStores()}function ne(e=!0){m.default.stop(),N.b.sharedInstance().stop(),h.a.sharedInstance().stop(),w.a.sharedInstance().reset(),u.a.stop(),v.a.stop(),x.a.sharedInstance().stopWatching(),R.a.sharedInstance().stop(),O.a.sharedInstance().stop(),g.a.shared()&&g.a.shared().stop(),l.a.stop();const t=o.a.get();t&&(t.stopClient(),t.removeAllListeners(),e&&(o.a.unset(),l.a.unset()))}}).call(this,s(167).setImmediate)},function(e,t,s){"use strict";s.d(t,"a",(function(){return r})),s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return c}));var n=s(82),a=s.n(n),i=s(95),o=s(248);let r;!function(e){e.Gitlab="org.matrix.gitlab",e.Github="org.matrix.github",e.Apple="org.matrix.apple",e.Google="org.matrix.google",e.Facebook="org.matrix.facebook",e.Twitter="org.matrix.twitter"}(r||(r={}));class l{constructor(e,t,s,n){a()(this,"hsUrl",void 0),a()(this,"isUrl",void 0),a()(this,"fallbackHsUrl",void 0),a()(this,"flows",void 0),a()(this,"defaultDeviceDisplayName",void 0),a()(this,"tempClient",void 0),this.hsUrl=e,this.isUrl=t,this.fallbackHsUrl=s,this.flows=[],this.defaultDeviceDisplayName=n.defaultDeviceDisplayName,this.tempClient=null}getHomeserverUrl(){return this.hsUrl}getIdentityServerUrl(){return this.isUrl}setHomeserverUrl(e){this.tempClient=null,this.hsUrl=e}setIdentityServerUrl(e){this.tempClient=null,this.isUrl=e}createTemporaryClient(){return this.tempClient?this.tempClient:this.tempClient=i.q.createClient({baseUrl:this.hsUrl,idBaseUrl:this.isUrl})}async getFlows(){const e=this.createTemporaryClient(),{flows:t}=await e.loginFlows();return this.flows=t,this.flows}loginViaPassword(e,t,s,n){const a=e.indexOf("@")>0;let i;i=t&&s?{type:"m.id.phone",country:t,phone:s,number:s}:a?{type:"m.id.thirdparty",medium:"email",address:e}:{type:"m.id.user",user:e};const o={password:n,identifier:i,initial_device_display_name:this.defaultDeviceDisplayName};let r=null;return c(this.hsUrl,this.isUrl,"m.login.password",o).catch(e=>{throw r=e,r}).catch(e=>{throw console.log("Login failed",e),e})}}async function c(e,t,s,n){var a;const r=i.q.createClient({baseUrl:e,idBaseUrl:t}),l=await r.login(s,n),c=l.well_known;c&&(c["m.homeserver"]&&c["m.homeserver"].base_url&&(e=c["m.homeserver"].base_url,console.log(`Overrode homeserver setting with ${e} from login response`)),c["m.identity_server"]&&c["m.identity_server"].base_url&&(t=c["m.identity_server"].base_url,console.log(`Overrode IS setting with ${t} from login response`)));const d={homeserverUrl:e,identityServerUrl:t,userId:l.user_id,deviceId:l.device_id,accessToken:l.access_token};return null===(a=o.a.examineLoginResponse)||void 0===a||a.call(o.a,l,d),d}},function(e,t,s){"use strict";s.d(t,"g",(function(){return m})),s.d(t,"a",(function(){return h})),s.d(t,"f",(function(){return u})),s.d(t,"e",(function(){return p})),s.d(t,"c",(function(){return b})),s.d(t,"d",(function(){return v})),s.d(t,"b",(function(){return _}));var n=s(95),a=s(555),i=s(116);const o=window.localStorage;let r;try{r=window.indexedDB}catch(e){}function l(e){console.log("StorageManager: "+e)}function c(e){console.error("StorageManager: "+e)}function d(e){i.a.trackEvent("StorageManager",e)}function m(){navigator.storage&&navigator.storage.persist?navigator.storage.persist().then(e=>{console.log("StorageManager: Persistent?",e)}):document.requestStorageAccess?document.requestStorageAccess().then(()=>console.log("StorageManager: Persistent?",!0),()=>console.log("StorageManager: Persistent?",!1)):console.log("StorageManager: Persistence unsupported")}async function h(){l("Checking storage consistency"),l("Local storage supported? "+!!o),l("IndexedDB supported? "+!!r);let e=!1,t=!1,s=!1,i=!0;if(o?(e=o.length>0,l("Local storage contains data? "+e),s=o.getItem("mx_crypto_initialised"),l("Crypto initialised? "+s)):(i=!1,c("Local storage cannot be used on this browser"),d("Local storage disabled")),r&&o){(await async function(){let e=!1;try{return e=await n.q.IndexedDBStore.exists(r,"riot-web-sync"),l("Sync store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){c("Sync store using IndexedDB inaccessible"),d("Sync store using IndexedDB inaccessible")}return l("Sync store using memory only"),{exists:e,healthy:!1}}()).healthy||(i=!1)}else i=!1,c("Sync store cannot be used on this browser"),d("Sync store disabled");if(r){const e=await async function(){let e=!1;try{return e=await n.q.IndexedDBCryptoStore.exists(r,"matrix-js-sdk:crypto"),l("Crypto store using IndexedDB contains data? "+e),{exists:e,healthy:!0}}catch(e){c("Crypto store using IndexedDB inaccessible"),d("Crypto store using IndexedDB inaccessible")}try{return e=await a.a.exists(o),l("Crypto store using local storage contains data? "+e),{exists:e,healthy:!0}}catch(e){c("Crypto store using local storage inaccessible"),d("Crypto store using local storage inaccessible")}return l("Crypto store using memory only"),{exists:e,healthy:!1}}();t=e.exists,e.healthy||(i=!1)}else i=!1,c("Crypto store cannot be used on this browser"),d("Crypto store disabled");return e&&s&&!t&&(i=!1,c("Data exists in local storage and crypto is marked as initialised  but no data found in crypto store. IndexedDB storage has likely been evicted by the browser!"),d("Crypto store evicted")),i?(l("Storage consistency checks passed"),d("Consistency checks passed")):(c("Storage consistency checks failed"),d("Consistency checks failed")),{dataInLocalStorage:e,dataInCryptoStore:t,cryptoInited:s,healthy:i}}function u(e){e.store&&e.store.on&&e.store.on("degraded",()=>{d("Sync store using IndexedDB degraded to memory")})}function p(e){o.setItem("mx_crypto_initialised",e)}let g=null;async function f(){if(!r)throw new Error("IndexedDB not available");g=await new Promise((e,t)=>{const s=r.open("matrix-react-sdk",1);s.onerror=t,s.onsuccess=t=>{e(s.result)},s.onupgradeneeded=e=>{const t=s.result;t.createObjectStore("pickleKey"),t.createObjectStore("account")}})}async function b(e,t){return g||await f(),new Promise((s,n)=>{const a=g.transaction([e],"readonly");a.onerror=n;const i=a.objectStore(e).get(t);i.onerror=n,i.onsuccess=e=>{s(i.result)}})}async function v(e,t,s){return g||await f(),new Promise((n,a)=>{const i=g.transaction([e],"readwrite");i.onerror=a;const o=i.objectStore(e).put(s,t);o.onerror=a,o.onsuccess=e=>{n()}})}async function _(e,t){return g||await f(),new Promise((s,n)=>{const a=g.transaction([e],"readwrite");a.onerror=n;const i=a.objectStore(e).delete(t);i.onerror=n,i.onsuccess=e=>{s()}})}},function(e,t){e.exports="img/e2e/warning.78bb264.svg"},function(e,t,s){"use strict";var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(90),d=s.n(c),m=s(85);t.a=e=>{let{checked:t,disabled:s=!1,onChange:n}=e,i=o()(e,["checked","disabled","onChange"]);const r=d()({mx_ToggleSwitch:!0,mx_ToggleSwitch_on:t,mx_ToggleSwitch_enabled:!s}),c=m.getComponent("elements.AccessibleButton");return l.a.createElement(c,a()({},i,{className:r,onClick:()=>{s||n(!t)},role:"switch","aria-checked":t,"aria-disabled":s}),l.a.createElement("div",{className:"mx_ToggleSwitch_ball"}))}},function(e,t){e.exports="img/tchap/question_mark.bed8888.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(88),o=s(87),r=s(94),l=s(458),c=s(253),d=s(96);class m{constructor(){a()(this,"themeWatchRef",void 0),a()(this,"systemThemeWatchRef",void 0),a()(this,"dispatcherRef",void 0),a()(this,"preferDark",void 0),a()(this,"preferLight",void 0),a()(this,"currentTheme",void 0),a()(this,"onChange",()=>{this.recheck()}),a()(this,"onAction",e=>{e.action===r.a.RecheckTheme&&this.recheck(e.forceTheme)}),this.themeWatchRef=null,this.systemThemeWatchRef=null,this.dispatcherRef=null,this.preferDark=e.matchMedia("(prefers-color-scheme: dark)"),this.preferLight=e.matchMedia("(prefers-color-scheme: light)"),this.currentTheme=this.getEffectiveTheme()}start(){this.themeWatchRef=i.a.watchSetting("theme",null,this.onChange),this.systemThemeWatchRef=i.a.watchSetting("use_system_theme",null,this.onChange),this.preferDark.addEventListener&&(this.preferDark.addEventListener("change",this.onChange),this.preferLight.addEventListener("change",this.onChange)),this.dispatcherRef=o.a.register(this.onAction)}stop(){this.preferDark.addEventListener&&(this.preferDark.removeEventListener("change",this.onChange),this.preferLight.removeEventListener("change",this.onChange)),i.a.unwatchSetting(this.systemThemeWatchRef),i.a.unwatchSetting(this.themeWatchRef),o.a.unregister(this.dispatcherRef)}recheck(e){const t=this.currentTheme;this.currentTheme=void 0===e?this.getEffectiveTheme():e,t!==this.currentTheme&&Object(c.d)(this.currentTheme)}getEffectiveTheme(){if(l.a.isLogin)return"tchap";const e=i.a.getValueAt(d.a.DEVICE,"theme",null,!1,!0);return e?(console.log("returning explicit theme: "+e),e):(console.log("returning theme value"),i.a.getValue("theme"))}isSystemThemeSupported(){return this.preferDark.matches||this.preferLight.matches}}}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return _})),s.d(t,"b",(function(){return y}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(139),l=s.n(r),c=s(84),d=s.n(c),m=s(106),h=s(1164),u=s.n(h),p=s(87),g=s(97),f=s(86),b=s(1);function v(e){return document.getElementById(e)}class _ extends o.a.Component{constructor(){super(),a()(this,"updateChildPosition",Object(m.throttle)((e,t)=>{if(!e||!t)return;const s=t.getBoundingClientRect();Object.assign(e.style,{zIndex:Object(b.r)(this.props.zIndex)?9:this.props.zIndex,position:"absolute",top:s.top+"px",left:s.left+"px",width:s.width+"px",height:s.height+"px"})},100,{trailing:!0,leading:!0})),this.collectChildContainer=this.collectChildContainer.bind(this),this.collectChild=this.collectChild.bind(this),this._repositionChild=this._repositionChild.bind(this),this._onAction=this._onAction.bind(this),this.resizeObserver=new u.a(this._repositionChild),window.addEventListener("resize",this._repositionChild),this._dispatcherRef=p.a.register(this._onAction)}static destroyElement(e){const t=v("mx_persistedElement_"+e);t&&t.remove()}static isMounted(e){return Boolean(v("mx_persistedElement_"+e))}collectChildContainer(e){this.childContainer&&this.resizeObserver.unobserve(this.childContainer),this.childContainer=e,e&&this.resizeObserver.observe(e)}collectChild(e){this.child=e,this.updateChild()}componentDidMount(){this.updateChild(),this.renderApp()}componentDidUpdate(){this.updateChild(),this.renderApp()}componentWillUnmount(){this.updateChildVisibility(this.child,!1),this.resizeObserver.disconnect(),window.removeEventListener("resize",this._repositionChild),p.a.unregister(this._dispatcherRef)}_onAction(e){"timeline_resize"===e.action&&this._repositionChild()}_repositionChild(){this.updateChildPosition(this.child,this.childContainer)}updateChild(){this.updateChildPosition(this.child,this.childContainer),this.updateChildVisibility(this.child,!0)}renderApp(){const e=o.a.createElement(g.a.Provider,{value:f.a.get()},o.a.createElement("div",{ref:this.collectChild,style:this.props.style},this.props.children));l.a.render(e,function(e){let t=v(e);return t||(t=document.createElement("div"),t.id=e,document.body.appendChild(t)),t}("mx_persistedElement_"+this.props.persistKey))}updateChildVisibility(e,t){e&&(e.style.display=t?"block":"none")}render(){return o.a.createElement("div",{ref:this.collectChildContainer})}}a()(_,"propTypes",{persistKey:d.a.string.isRequired,zIndex:d.a.number});const y=e=>"widget_"+e},function(e,t,s){"use strict";var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(137),d=s(205),m=s(102),h=s(83),u=s(122),p=s(260),g=s(227),f=s(87),b=s(88),v=s(89),_=s(142),y=s(132),E=s(97),C=s(173);t.a=e=>{let{onFinished:t,app:s,userWidget:n,onDeleteClick:i,showUnpin:w}=e,S=o()(e,["onFinished","app","userWidget","onDeleteClick","showUnpin"]);const x=Object(r.useContext)(E.a),{room:R,roomId:O}=Object(r.useContext)(g.a),k=p.a.instance.getMessagingForId(s.id),I=n||u.a.canUserModifyWidgets(O);let T,j,N,P;if(w){const e=()=>{C.d.instance.moveToContainer(R,s,C.a.Right),t()};T=l.a.createElement(d.b,{onClick:e,label:Object(h.a)("Unpin")})}if(I&&u.a.isManagedByManager(s)){const e=()=>{u.a.editWidget(R,s),t()};j=l.a.createElement(d.b,{onClick:e,label:Object(h.a)("Edit")})}if(null!=k&&k.hasCapability(c.MatrixCapabilities.Screenshots)){const e=()=>{null==k||k.takeScreenshot().then(e=>{f.a.dispatch({action:"picture_snapshot",file:e.screenshot})}).catch(e=>{console.error("Failed to take screenshot: ",e)}),t()};N=l.a.createElement(d.b,{onClick:e,label:Object(h.a)("Take a picture")})}if(i||I){const e=()=>{v.a.createTrackedDialog("Delete Widget","",_.a,{title:Object(h.a)("Delete Widget"),description:Object(h.a)("Deleting a widget removes it for all users in this room. Are you sure you want to delete this widget?"),button:Object(h.a)("Delete widget"),onFinished:e=>{e&&u.a.setRoomWidget(O,s.id)}}),t()};P=l.a.createElement(d.b,{onClick:i||e,label:n?Object(h.a)("Remove"):Object(h.a)("Remove for everyone")})}let D=b.a.getValue("allowedWidgets",O)[s.eventId];void 0===D&&(D=s.creatorUserId===x.getUserId());const A=y.a.JITSI.matches(s.type);let U;if(!n&&!A&&D){const e=()=>{console.info("Revoking permission for widget to load: "+s.eventId);const e=b.a.getValue("allowedWidgets",O);e[s.eventId]=!1;const n=b.a.firstSupportedLevel("allowedWidgets");b.a.setValue("allowedWidgets",O,n,e).catch(e=>{console.error(e)}),t()};U=l.a.createElement(d.b,{onClick:e,label:Object(h.a)("Revoke permissions")})}const M=C.d.instance.getContainerWidgets(R,C.a.Top),L=M.findIndex(e=>e.id===s.id);let F,B;if(w&&L>0){const e=()=>{C.d.instance.moveWithinContainer(R,C.a.Top,s,-1),t()};F=l.a.createElement(d.b,{onClick:e,label:Object(h.a)("Move left")})}if(w&&L<M.length-1){const e=()=>{C.d.instance.moveWithinContainer(R,C.a.Top,s,1),t()};B=l.a.createElement(d.b,{onClick:e,label:Object(h.a)("Move right")})}return l.a.createElement(d.e,a()({},S,{chevronFace:m.a.None,onFinished:t}),l.a.createElement(d.c,null,j,U,P,N,F,B,T))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(685),o=s(686);class r{static createItem(e,t,s){return new i.a(e,t,s)}static createSizer(e,t,s){return new o.a(e,t,s)}constructor(e){this.item=e,a()(this,"beforeOffset",void 0),this.beforeOffset=e.offset()}get size(){return this.item.getSize()}set size(e){this.item.setRawSize(e)}resize(e){this.item.setSize(e)}resizeFromContainerOffset(e){this.resize(e-this.beforeOffset)}start(){this.item.start()}finish(){this.item.finish()}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return u})),s.d(t,"a",(function(){return p}));var n=s(81),a=s.n(n),i=s(89),o=s(85),r=s(335),l=s(83),c=s(86),d=s(114),m=s(134),h=s(145);function u(e){return new Promise((t,s)=>{const n=a.a.createElement("div",null,a.a.createElement("div",null,Object(l.a)("Who would you like to add to this community?")),a.a.createElement("div",{className:"warning"},Object(l.a)("Warning: any person you add to a community will be publicly visible to anyone who knows the community ID"))),c=o.getComponent("dialogs.AddressPickerDialog");i.a.createTrackedDialog("Group Invite","",c,{title:Object(l.a)("Invite new community members"),description:n,placeholder:Object(l.a)("Name or Matrix ID"),button:Object(l.a)("Invite to Community"),validAddressTypes:["mx-user-id"],onFinished:(n,a)=>{n&&function(e,t){const s=new r.a(e),n=t.map(e=>e.address);return s.invite(n).then(s=>{const n=[];for(const e of Object.keys(s))"error"===t[e]&&n.push(e);if(n.length>0){const t=o.getComponent("dialogs.ErrorDialog");i.a.createTrackedDialog("Failed to invite the following users to the group","",t,{title:Object(l.a)("Failed to invite the following users to %(groupId)s:",{groupId:e}),description:n.join(", ")})}}).catch(t=>{const s=o.getComponent("dialogs.ErrorDialog");i.a.createTrackedDialog("Failed to invite users to group","",s,{title:Object(l.a)("Failed to invite users to community"),description:Object(l.a)("Failed to invite users to %(groupId)s",{groupId:e})})})}(e,a).then(t,s)}},null,!1,!0)})}function p(e){return new Promise((t,s)=>{let n=!1;const r=a.a.createElement("div",null,a.a.createElement("div",null,Object(l.a)("Which rooms would you like to add to this community?"))),u=a.a.createElement(h.a,{className:"mx_GroupAddressPicker_checkboxContainer",onChange:e=>{n=e.target.checked}},Object(l.a)("Show these rooms to non-members on the community page and room list?")),p=o.getComponent("dialogs.AddressPickerDialog");i.a.createTrackedDialog("Add Rooms to Group","",p,{title:Object(l.a)("Add rooms to the community"),description:r,extraNode:u,placeholder:Object(l.a)("Room name or address"),button:Object(l.a)("Add to community"),pickerType:"room",validAddressTypes:["mx-room-id"],onFinished:(a,r)=>{a&&function(e,t,s){const n=c.a.get(),a=[];return Object(m.a)(t.map(t=>d.a.addRoomToGroup(e,t.address,s).catch(()=>{a.push(t.address)}).then(()=>{const s=t.address,a=n.getRoom(s);if(!a||!a.currentState.mayClientSendStateEvent("m.room.related_groups",n))return;const i=a.currentState.getStateEvents("m.room.related_groups",""),o=i&&i.getContent().groups||[];return o.includes(e)?void 0:(o.push(e),c.a.get().sendStateEvent(s,"m.room.related_groups",{groups:o},""))}))).then(()=>{if(0===a.length)return;const t=o.getComponent("dialogs.ErrorDialog");i.a.createTrackedDialog("Failed to add the following room to the group","",t,{title:Object(l.a)("Failed to add the following rooms to %(groupId)s:",{groupId:e}),description:a.join(", ")})})}(e,r,n).then(t,s)}},null,!1,!0)})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return x}));var n=s(82),a=s.n(n),i=s(81),o=s(84),r=s(259),l=s(178),c=s(272),d=s(166),m=s(118),h=s(85),u=s(83),p=s(472),g=s(110),f=s(102),b=s(295),v=s(145),_=s(115),y=s(88),E=s(108);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function w(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const S=[{name:"email",img:s(1202),url:e=>"mailto:?body="+e}];class x extends i.PureComponent{constructor(e){super(e),a()(this,"closeCopiedTooltip",void 0),this.onCopyClick=this.onCopyClick.bind(this),this.onLinkSpecificEventCheckboxClick=this.onLinkSpecificEventCheckboxClick.bind(this);let t=null;e.target instanceof r.b&&(t=new g.a(e.target),t.load()),this.state={linkSpecificEvent:this.props.target instanceof m.b,permalinkCreator:t}}static onLinkClick(e){e.preventDefault(),Object(b.c)(e.target)}async onCopyClick(e){e.preventDefault();const t=e.target,s=await Object(b.b)(this.getUrl()),n=t.getBoundingClientRect(),a=h.getComponent("context_menus.GenericTextContextMenu"),{close:i}=f.n(a,w(w({},Object(f.p)(n,2)),{},{message:s?Object(u.a)("Copied!"):Object(u.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=i}onLinkSpecificEventCheckboxClick(){this.setState({linkSpecificEvent:!this.state.linkSpecificEvent})}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}getUrl(){let e;if(this.props.target instanceof r.b)if(this.state.linkSpecificEvent){const t=this.props.target.getLiveTimeline().getEvents();e=this.state.permalinkCreator.forEvent(t[t.length-1].getId())}else e=this.state.permalinkCreator.forShareableRoom();else this.props.target instanceof l.a||this.props.target instanceof d.a?e=Object(g.g)(this.props.target.userId):this.props.target instanceof c.a?e=Object(g.e)(this.props.target.groupId):this.props.target instanceof m.b&&(e=this.state.linkSpecificEvent?this.props.permalinkCreator.forEvent(this.props.target.getId()):this.props.permalinkCreator.forRoom());return e}render(){let e,t;if(this.props.target instanceof r.b){e=Object(u.a)("Share Room");this.props.target.getLiveTimeline().getEvents().length>0&&(t=i.createElement("div",null,i.createElement(v.a,{checked:this.state.linkSpecificEvent,onChange:this.onLinkSpecificEventCheckboxClick},Object(u.a)("Link to most recent message"))))}else this.props.target instanceof l.a||this.props.target instanceof d.a?e=Object(u.a)("Share User"):this.props.target instanceof c.a?e=Object(u.a)("Share Community"):this.props.target instanceof m.b&&(e=Object(u.a)("Share Room Message"),t=i.createElement("div",null,i.createElement(v.a,{checked:this.state.linkSpecificEvent,onClick:this.onLinkSpecificEventCheckboxClick},Object(u.a)("Link to selected message"))));const n=this.getUrl(),a=encodeURIComponent(n),o=y.a.getValue(E.a.ShareQRCode),g=y.a.getValue(E.a.ShareSocial);let f,b;(o||g)&&(f=i.createElement(i.Fragment,null,i.createElement("br",null),i.createElement("details",null,i.createElement("summary",null,Object(u.a)("Share")),i.createElement("div",{className:"mx_ShareDialog_split"},o&&i.createElement("div",{className:"mx_ShareDialog_qrcode_container"},i.createElement(p.a,{data:n,width:256})),g&&i.createElement("div",{className:"mx_ShareDialog_social_container"},S.map(e=>i.createElement("a",{rel:"noreferrer noopener",target:"_blank",key:e.name,title:e.name,href:e.url(a),className:"mx_ShareDialog_social_icon"},i.createElement("img",{src:e.img,alt:e.name,height:64,width:64})))))))),this.props.isExtShared&&(b=i.createElement("div",{className:"tc_ExternSharing_warning"},i.createElement("img",{src:s(697),width:"16",height:"16",alt:"warning"}),i.createElement("span",null,Object(u.a)("An invitation is still required for externs, although link access is enabled."))));const C=h.getComponent("views.dialogs.BaseDialog");return i.createElement(C,{title:e,className:"mx_ShareDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},b,i.createElement("div",{className:"mx_ShareDialog_content"},i.createElement("div",{className:"mx_ShareDialog_matrixto"},i.createElement("a",{href:n,onClick:x.onLinkClick,className:"mx_ShareDialog_matrixto_link"},n),i.createElement(_.a,{title:Object(u.a)("Copy"),onClick:this.onCopyClick,className:"mx_ShareDialog_matrixto_copy"})),t,f))}}a()(x,"propTypes",{onFinished:o.func.isRequired,target:o.oneOfType([o.instanceOf(r.b),o.instanceOf(l.a),o.instanceOf(c.a),o.instanceOf(d.a),o.instanceOf(m.b)]).isRequired,isExtShared:o.bool})},,function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n;!function(e){e[e._requireMinLength=0]="_requireMinLength",e[e._requireLowercase=1]="_requireLowercase",e[e._requireUppercase=2]="_requireUppercase",e[e._requireDigit=3]="_requireDigit",e[e._requireSymbol=4]="_requireSymbol"}(n||(n={}));class a{static isPasswordValid(e){const t={isValid:!0,errorList:[]};for(const s in n){if(!isNaN(Number(s)))continue;const n=this[s](e);n.isRuleValid||(t.isValid=!1,t.errorList.push(n.errorText))}return t}static _requireMinLength(e){return{isRuleValid:e.length>=8,errorText:"At least 8 characters are required"}}static _requireLowercase(e){return{isRuleValid:/[a-z]/.test(e),errorText:"A lowercase letter is required"}}static _requireUppercase(e){return{isRuleValid:/[A-Z]/.test(e),errorText:"An uppercase letter is required"}}static _requireDigit(e){return{isRuleValid:/[0-9]/.test(e),errorText:"A digit is required"}}static _requireSymbol(e){return{isRuleValid:/[^a-zA-Z0-9]/.test(e),errorText:"A symbol is required"}}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(82),a=s.n(n),i=s(224);class o extends i.a{static set matrixClient(e){const t=o._matrixClient;o._matrixClient=e;for(const s of o.instances)s.initMatrixClient(t,e)}constructor(){super(),o.instances.push(this)}get client(){return o._matrixClient}initMatrixClient(e,t){console.warn("initMatrixClient not overridden")}}a()(o,"_matrixClient",void 0),a()(o,"instances",[])},,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(90),l=s.n(r),c=s(199),d=s(287),m=s(176),h=s(86),u=s(92);var p,g=s(83),f=s(174),b=s(109),v=s(98);function _(e){switch(e){case p.Globe:return Object(g.a)("This room is a forum");case p.PresenceOnline:return Object(g.a)("Online");case p.PresenceAway:return Object(g.a)("Away");case p.PresenceOffline:return Object(g.a)("Offline")}}!function(e){e.None="NONE",e.Globe="GLOBE",e.PresenceOnline="ONLINE",e.PresenceAway="AWAY",e.PresenceOffline="OFFLINE"}(p||(p={}));class y extends o.a.PureComponent{constructor(e){super(e),a()(this,"_dmUser",void 0),a()(this,"isUnmounted",!1),a()(this,"isWatchingTimeline",!1),a()(this,"onRoomTimeline",(e,t)=>{this.isUnmounted||t&&this.props.room.roomId===t.roomId&&("m.room.join_rules"!==e.getType()&&"m.room.member"!==e.getType()||this.setState({icon:this.calculateIcon()}))}),a()(this,"onPresenceUpdate",()=>{if(this.isUnmounted)return;const e=this.getPresenceIcon();e!==this.state.icon&&this.setState({icon:e})}),this.state={notificationState:m.a.instance.getRoomState(this.props.room),icon:this.calculateIcon()}}componentWillUnmount(){this.isUnmounted=!0,this.isWatchingTimeline&&this.props.room.off("Room.timeline",this.onRoomTimeline),this.dmUser=null}get isPublicRoom(){const e=this.props.room.currentState.getStateEvents("m.room.join_rules","");return"public"===(e&&e.getContent().join_rule)}get dmUser(){return this._dmUser}set dmUser(e){const t=this._dmUser;this._dmUser=e,t&&t!==this._dmUser&&(t.off("User.currentlyActive",this.onPresenceUpdate),t.off("User.presence",this.onPresenceUpdate)),this._dmUser&&t!==this._dmUser&&(this._dmUser.on("User.currentlyActive",this.onPresenceUpdate),this._dmUser.on("User.presence",this.onPresenceUpdate))}getRealRoomType(){if("invite"===this.props.room.getMyMembership()){if(b.a.shared().getUserIdForRoomId(this.props.room.roomId))return"direct";if(v.a.isCurrentUserExtern())return"unrestricted"}return v.a.getAccessRules(this.props.room.roomId)}getPresenceIcon(){if(!this.dmUser)return p.None;let e=p.None;return this.dmUser.currentlyActive||"online"===this.dmUser.presence?e=p.PresenceOnline:"offline"===this.dmUser.presence?e=p.PresenceOffline:"unavailable"===this.dmUser.presence&&(e=p.PresenceAway),e}calculateIcon(){let e=p.None;const t=b.a.shared().getUserIdForRoomId(this.props.room.roomId);return t&&2===this.props.room.getJoinedMemberCount()?function(){const e=h.a.get().baseUrl,t=u.a.get().enable_presence_by_hs_url;return!!t&&!(!t[e]&&void 0!==t[e])}()&&t&&(this.dmUser=h.a.get().getUser(t),e=this.getPresenceIcon()):(e=this.isPublicRoom?p.Globe:p.None,this.isWatchingTimeline||(this.props.room.on("Room.timeline",this.onRoomTimeline),this.isWatchingTimeline=!0)),e}render(){let e,t;this.props.displayBadge&&(e=o.a.createElement(d.a,{notification:this.state.notificationState,forceCount:this.props.forceCount,roomId:this.props.room.roomId})),this.state.icon!==p.None&&(t=o.a.createElement(f.a,{tooltip:_(this.state.icon),class:"mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_"+this.state.icon.toLowerCase()}));const s=this.getRealRoomType(),n=v.a.isRoomNotice(this.props.room);let a=this.props.avatarSize;"unrestricted"===s&&(a-=4);const i=l()("mx_DecoratedRoomAvatar",{mx_DecoratedRoomAvatar_cutout:t,tc_RoomTile_avatar_hexa:"direct"!==s&&!n,tc_RoomTile_avatar_unrestricted:"unrestricted"===s});return o.a.createElement("div",{className:i},o.a.createElement(c.a,{room:this.props.room,width:a,height:a,oobData:this.props.oobData,viewAvatarOnClick:this.props.viewAvatarOnClick}),e)}}},,function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82),a=s.n(n);class i{get action(){return"NOT_USED"}constructor(e){a()(this,"fn",void 0),this.fn=e}}},function(e,t,s){"use strict";t.a={hostBase:"https://matrix.",infoFromEmailUrl:"/_matrix/identity/api/v1/info?medium=email&address=",publicKeyUrl:"/_matrix/media_proxy/unstable/public_key",scanEncryptedUrl:"/_matrix/media_proxy/unstable/scan_encrypted",scanUnencryptedUrl:"/_matrix/media_proxy/unstable/scan/",downloadUnencryptedUrl:"/_matrix/media_proxy/unstable/download/",downloadEncryptedUrl:"/_matrix/media_proxy/unstable/download_encrypted",downloadUnencryptedThumbnailUrl:"/_matrix/media_proxy/unstable/thumbnail/",lookupUrl:"/_matrix/client/unstable/account/3pid/lookup",accountValidityResendEmailUrl:"/_matrix/client/unstable/account_validity/send_mail",passwordRulesUrl:"/_matrix/client/r0/password_policy",expiredInfoUrl:"/_matrix/client/r0/user/"}},function(e,t,s){"use strict";function n(e){const t="abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";let s="";for(let n=0;n<e;n++){let e=Math.floor(Math.random()*t.length);s+=t.substring(e,e+1)}return s}function a(e){for(let t=0;t<e.length;t++){const s=Math.floor(Math.random()*e.length),n=e[t];e[t]=e[s],e[s]=n}return e.slice(0,e.length)}function i(e){return e.charAt(0).toUpperCase()+e.slice(1)}function o(e,t,s){var n,a,i;const o=null==e||null===(n=e.currentState)||void 0===n?void 0:n.events,r=null==o||null===(a=o.get(t))||void 0===a?void 0:a.get("");return null==r||null===(i=r.event)||void 0===i?void 0:i.content[s]}s.d(t,"b",(function(){return n})),s.d(t,"d",(function(){return a})),s.d(t,"a",(function(){return i})),s.d(t,"c",(function(){return o}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(81),a=s.n(n),i=s(124),o=s(90),r=s.n(o),l=s(91),c=s(97),d=s(507),m=s(116),h=s(105),u=s(227);const p=52;t.b=({hasAvatar:e,hasAvatarLabel:t,noAvatarLabel:s,setAvatarUrl:o,isDirect:p,children:g})=>{const f=Object(n.useContext)(c.a),[b,v]=Object(n.useState)(!1),[_,y]=Object(n.useState)(!1),[E,C]=Object(n.useState)(!1);Object(d.b)(()=>{C(!0)},3e3),Object(d.b)(()=>{C(!1)},13e3);const w=Object(n.useRef)(),S=e||b?t:s,{room:x}=Object(n.useContext)(u.a);if(!(null==x?void 0:x.currentState.maySendStateEvent(i.a.RoomAvatar,f.getUserId())))return a.a.createElement(a.a.Fragment,null,g);const R=!!S&&(_||E);return a.a.createElement(a.a.Fragment,null,a.a.createElement("input",{type:"file",ref:w,className:"mx_MiniAvatarUploader_input",onChange:async e=>{var t;if(null===(t=e.target.files)||void 0===t||!t.length)return;v(!0),m.a.trackEvent("mini_avatar","upload"),h.a.instance.track("mini_avatar_upload");const s=e.target.files[0],n=await f.uploadContent(s);await o(n),v(!1)},accept:"image/*"}),a.a.createElement(l.a,{className:r()("mx_MiniAvatarUploader",{mx_MiniAvatarUploader_busy:b,mx_MiniAvatarUploader_hasAvatar:e,mx_MiniAvatarUploader_room:!p}),disabled:b,onClick:()=>{w.current.click()},onMouseOver:()=>y(!0),onMouseLeave:()=>y(!1)},g,a.a.createElement("div",{className:r()("mx_Tooltip",{mx_Tooltip_visible:R,mx_Tooltip_invisible:!R})},a.a.createElement("div",{className:"mx_Tooltip_chevron"}),S)))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(367);function a(e,t,s){return new n.a(n=>{n({action:e+".pending",request:"function"==typeof s?s():void 0}),t().then(t=>{n({action:e+".success",result:t})}).catch(t=>{n({action:e+".failure",err:t})})})}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return i})),s.d(t,"a",(function(){return o}));var n=s(82),a=s.n(n);class i{forEvent(e,t,s){throw new Error("Not implemented")}forRoom(e,t){throw new Error("Not implemented")}forGroup(e){throw new Error("Not implemented")}forUser(e){throw new Error("Not implemented")}forEntity(e){throw new Error("Not implemented")}isPermalinkHost(e){throw new Error("Not implemented")}parsePermalink(e){throw new Error("Not implemented")}}class o{constructor(e,t,s,n,i){a()(this,"roomIdOrAlias",void 0),a()(this,"eventId",void 0),a()(this,"userId",void 0),a()(this,"groupId",void 0),a()(this,"viaServers",void 0),this.roomIdOrAlias=e,this.eventId=t,this.groupId=n,this.userId=s,this.viaServers=i}static forUser(e){return new o(null,null,e,null,null)}static forGroup(e){return new o(null,null,null,e,null)}static forRoom(e,t){return new o(e,null,null,null,t||[])}static forEvent(e,t,s){return new o(e,t,null,null,s||[])}get primaryEntityId(){return this.roomIdOrAlias||this.userId||this.groupId}get sigil(){return this.primaryEntityId[0]}}},function(e,t,s){"use strict";var n=s(565),a=s(110);function i(e){const t=e.scanner.TOKENS,s=e.parser.TOKENS.Base,n=e.parser.start;if(void 0===t.UNDERSCORE)throw new Error("linkify-matrix requires linkifyjs 2.1.1: this version is too old.");const a=function(e){s.call(this,e),this.type="roomalias",this.isLink=!0};a.prototype=new s;const i=n.jump(t.POUND),o=new e.parser.State,r=new e.parser.State,l=new e.parser.State(a),c=new e.parser.State,d=new e.parser.State(a),m=new e.parser.State,h=new e.parser.State(a),u=[t.DOT,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.UNDERSCORE,t.POUND,t.LOCALHOST];i.on(u,o),o.on(u,o),o.on(t.DOMAIN,o),o.on(t.COLON,r),r.on(t.DOMAIN,l),r.on(t.LOCALHOST,d),r.on(t.TLD,d),l.on(t.DOT,c),c.on(t.DOMAIN,l),c.on(t.TLD,d),d.on(t.DOT,c),d.on(t.COLON,m),m.on(t.NUM,h);const p=function(e){s.call(this,e),this.type="userid",this.isLink=!0};p.prototype=new s;const g=n.jump(t.AT),f=new e.parser.State,b=new e.parser.State,v=new e.parser.State(p),_=new e.parser.State,y=new e.parser.State(p),E=new e.parser.State,C=new e.parser.State(p),w=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];g.on(w,f),f.on(w,f),f.on(t.DOMAIN,f),f.on(t.COLON,b),b.on(t.DOMAIN,v),b.on(t.LOCALHOST,y),b.on(t.TLD,y),v.on(t.DOT,_),_.on(t.DOMAIN,v),_.on(t.TLD,y),y.on(t.DOT,_),y.on(t.COLON,E),E.on(t.NUM,C);const S=function(e){s.call(this,e),this.type="groupid",this.isLink=!0};S.prototype=new s;const x=n.jump(t.PLUS),R=new e.parser.State,O=new e.parser.State,k=new e.parser.State(S),I=new e.parser.State,T=new e.parser.State(S),j=new e.parser.State,N=new e.parser.State(S),P=[t.DOT,t.UNDERSCORE,t.PLUS,t.NUM,t.DOMAIN,t.TLD,t.LOCALHOST];x.on(P,R),R.on(P,R),R.on(t.DOMAIN,R),R.on(t.COLON,O),O.on(t.DOMAIN,k),O.on(t.LOCALHOST,T),O.on(t.TLD,T),k.on(t.DOT,I),I.on(t.DOMAIN,k),I.on(t.TLD,T),T.on(t.DOT,I),T.on(t.COLON,j),j.on(t.NUM,N)}i.onUserClick=function(e,t){e.preventDefault()},i.onAliasClick=function(e,t){e.preventDefault()},i.onGroupClick=function(e,t){e.preventDefault()};i.TCHAP_URL_PATTERN="^(?:https?://)?(?:"+((window.location.host+window.location.pathname).replace(/[.*+?^${}()|[\]\\]/g,"\\$&")+"|(?:www\\.)?tchap\\.gouv\\.fr/)(#/(?:user|room)/(([#@!+]).*))"),i.MATRIXTO_URL_PATTERN="^(?:https?://)?(?:www\\.)?matrix\\.to/#/(([#@!+]).*)",i.MATRIXTO_MD_LINK_PATTERN="\\[([^\\]]*)\\]\\((?:https?://)?(?:www\\.)?matrix\\.to/#/([#@!+][^\\)]*)\\)",i.MATRIXTO_BASE_URL=n.a,i.options={events:function(e,t){switch(t){case"url":try{const t=Object(a.i)(e);if(t&&t.userId)return{click:function(e){i.onUserClick(e,t.userId)}}}catch(e){}break;case"userid":return{click:function(t){i.onUserClick(t,e)}};case"roomalias":return{click:function(t){i.onAliasClick(t,e)}};case"groupid":return{click:function(t){i.onGroupClick(t,e)}}}},formatHref:function(e,t){switch(t){case"roomalias":case"userid":case"groupid":default:return Object(a.j)(e)}},linkAttributes:{rel:"noreferrer noopener"},target:function(e,t){if("url"===t){return Object(a.k)(e)!==e||e.match(i.TCHAP_URL_PATTERN)?null:"_blank"}return null}},t.a=i},,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i}));var n=s(83);function a(e){return{undefined:Object(n.a)("Default"),0:Object(n.a)("Restricted"),[e]:Object(n.a)("Default"),50:Object(n.a)("Moderator"),100:Object(n.a)("Admin")}}function i(e,t){const s=a(t);return s[e]?s[e]:Object(n.a)("Custom (%(level)s)",{level:e})}},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(86),d=s(130),m=s(83),h=s(286),u=s.n(h),p=s(91),g=s(89),f=s(85),b=s(99),v=s(616),_=s.n(v),y=s(169),E=s(98);function C(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class w extends o.a.Component{constructor(e){super(e),a()(this,"onKeyDown",e=>{e.key===b.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),a()(this,"onRedactClick",()=>{const e=f.getComponent("dialogs.ConfirmRedactDialog");g.a.createTrackedDialog("Confirm Redact Dialog","Image View",e,{onFinished:e=>{e&&(this.props.onFinished(),c.a.get().redactEvent(this.props.mxEvent.getRoomId(),this.props.mxEvent.getId()).catch((function(e){const t=f.getComponent("dialogs.ErrorDialog"),s=e.errcode||e.statusCode;g.a.createTrackedDialog("You cannot delete this image.","",t,{title:Object(m.a)("Error"),description:Object(m.a)("You cannot delete this image. (%(code)s)",{code:s})})})))}})}),a()(this,"rotateCounterClockwise",()=>{const e=(this.state.rotationDegrees-90)%360;this.setState({rotationDegrees:e})}),a()(this,"rotateClockwise",()=>{const e=(this.state.rotationDegrees+90)%360;this.setState({rotationDegrees:e})}),this.state={rotationDegrees:0}}getName(){let e=this.props.name;return e&&this.props.link&&(e=o.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e)),e}render(){let e,t,n,i={};this.props.width&&this.props.height&&(i={width:this.props.width,height:this.props.height},e=i.width+"x"+i.height+"px"),this.props.fileSize&&(t=u()(this.props.fileSize)),n=t&&e?t+", "+e:t||e;let r=!1;let l,h;if(!!this.props.mxEvent){let e=this.props.mxEvent.getSender();const t=c.a.get(),s=t.getRoom(this.props.mxEvent.getRoomId());if(s){r=s.currentState.maySendRedactionForEvent(this.props.mxEvent,t.credentials.userId);const n=s.getMember(e);n&&(e=n.name)}l=o.a.createElement("div",{className:"mx_ImageView_metadata"},Object(m.a)("Uploaded on %(date)s by %(user)s",{date:Object(d.a)(new Date(this.props.mxEvent.getTs())),user:e}))}r&&(h=o.a.createElement("div",{className:"mx_ImageView_button",onClick:this.onRedactClick},Object(m.a)("Remove")));const g=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?C(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):C(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({transform:`rotate(${this.state.rotationDegrees}deg)`},i),f=y.a.getUnencryptedContentUrl({url:E.a.imgUrlToUri(this.props.src)});return o.a.createElement(_.a,{returnFocus:!0,lockProps:{onKeyDown:this.onKeyDown,role:"dialog"},className:"mx_ImageView"},o.a.createElement("div",{className:"mx_ImageView_lhs"}),o.a.createElement("div",{className:"mx_ImageView_content"},o.a.createElement("img",{src:f,title:this.props.name,style:g,className:"mainImage"}),o.a.createElement("div",{className:"mx_ImageView_labelWrapper"},o.a.createElement("div",{className:"mx_ImageView_label"},o.a.createElement(p.a,{className:"mx_ImageView_rotateCounterClockwise",title:Object(m.a)("Rotate Left"),onClick:this.rotateCounterClockwise},o.a.createElement("img",{src:s(1125),alt:Object(m.a)("Rotate counter-clockwise"),width:"18",height:"18"})),o.a.createElement(p.a,{className:"mx_ImageView_rotateClockwise",title:Object(m.a)("Rotate Right"),onClick:this.rotateClockwise},o.a.createElement("img",{src:s(1126),alt:Object(m.a)("Rotate clockwise"),width:"18",height:"18"})),o.a.createElement(p.a,{className:"mx_ImageView_cancel",title:Object(m.a)("Close"),onClick:this.props.onFinished},o.a.createElement("img",{src:s(1127),width:"18",height:"18",alt:Object(m.a)("Close")})),o.a.createElement("div",{className:"mx_ImageView_shim"}),o.a.createElement("div",{className:"mx_ImageView_name"},this.getName()),l,o.a.createElement("a",{className:"mx_ImageView_link",href:f,download:this.props.name,target:"_blank",rel:"noopener"},o.a.createElement("div",{className:"mx_ImageView_download"},Object(m.a)("Download this file"),o.a.createElement("br",null),o.a.createElement("span",{className:"mx_ImageView_size"},n))),h,o.a.createElement("div",{className:"mx_ImageView_shim"})))),o.a.createElement("div",{className:"mx_ImageView_rhs"}))}}a()(w,"propTypes",{src:l.a.string.isRequired,name:l.a.string,link:l.a.string,width:l.a.number,height:l.a.number,fileSize:l.a.number,onFinished:l.a.func.isRequired,mxEvent:l.a.object})},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return k})),s.d(t,"b",(function(){return I}));var n=s(82),a=s.n(n),i=s(81),o=s(90),r=s.n(o),l=s(177),c=s(83),d=s(91),m=s(641),h=s(102),u=s(150),p=s(237),g=s(125),f=s(87),b=s(287),v=s(115),_=s(99),y=s(344),E=s(1131),C=s(176),w=s(768),S=s(120),x=s(152),R=s(205),O=s(98);const k=32;Object(E.a)();class I extends i.Component{constructor(t){super(t),a()(this,"headerButton",Object(i.createRef)()),a()(this,"sublistRef",Object(i.createRef)()),a()(this,"dispatcherRef",void 0),a()(this,"layout",void 0),a()(this,"heightAtStart",void 0),a()(this,"isBeingFiltered",void 0),a()(this,"notificationState",void 0),a()(this,"onListsUpdated",()=>{const e={};if(this.props.extraBadTilesThatShouldntExist){const t=u.b.instance.getFirstNameFilterCondition();t?e.filteredExtraTiles=this.props.extraBadTilesThatShouldntExist.filter(e=>t.matches(e.props.displayName||"")):this.state.filteredExtraTiles&&(e.filteredExtraTiles=null)}const t=this.state.rooms,s=Object(S.c)(u.b.instance.orderedLists[this.props.tagId]||[]);Object(S.e)(t,s)&&(e.rooms=s);const n=!!u.b.instance.getFirstNameFilterCondition();n!==this.isBeingFiltered&&(this.isBeingFiltered=n,e.isExpanded=!!n||!this.layout.isCollapsed),Object.keys(e).length>0&&this.setState(e)}),a()(this,"onAction",t=>{"view_room"===t.action&&t.show_room_tile&&this.state.rooms&&e(()=>{const e=this.state.rooms.findIndex(e=>e.roomId===t.room_id);!this.state.isExpanded&&e>-1&&this.toggleCollapsed(),e>=this.numVisibleTiles&&(this.layout.visibleTiles=this.layout.tilesWithPadding(e+1,32),this.forceUpdate())})}),a()(this,"onAddRoom",e=>{e.stopPropagation(),this.props.onAddRoom&&this.props.onAddRoom()}),a()(this,"onResize",(e,t,s,n)=>{const a=this.heightAtStart+n.height;this.applyHeightChange(a),this.setState({height:a})}),a()(this,"onResizeStart",()=>{this.heightAtStart=this.state.height,this.setState({isResizing:!0})}),a()(this,"onResizeStop",(e,t,s,n)=>{const a=this.heightAtStart+n.height;this.applyHeightChange(a),this.setState({isResizing:!1,height:a})}),a()(this,"onShowAllClick",()=>{const e=this.numVisibleTiles,t=this.layout.tilesToPixelsWithPadding(this.numTiles,this.padding);this.applyHeightChange(t),this.setState({height:t},()=>{this.focusRoomTile(e)})}),a()(this,"onShowLessClick",()=>{const e=this.layout.tilesToPixelsWithPadding(this.layout.defaultVisibleTiles,this.padding);this.applyHeightChange(e),this.setState({height:e})}),a()(this,"focusRoomTile",e=>{if(!this.sublistRef.current)return;const t=this.sublistRef.current.querySelectorAll(".mx_RoomTile"),s=t&&t[e];s&&s.focus()}),a()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),a()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,height:0}})}),a()(this,"onAddRoomContextMenu",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({addRoomContextMenuPosition:t.getBoundingClientRect()})}),a()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),a()(this,"onCloseAddRoomMenu",()=>{this.setState({addRoomContextMenuPosition:null})}),a()(this,"onUnreadFirstChanged",async()=>{const e=u.b.instance.getListOrder(this.props.tagId)===p.a.Importance?p.a.Natural:p.a.Importance;await u.b.instance.setListOrder(this.props.tagId,e),this.forceUpdate()}),a()(this,"onTagSortChanged",async e=>{await u.b.instance.setTagSorting(this.props.tagId,e)}),a()(this,"onMessagePreviewChanged",()=>{this.layout.showPreviews=!this.layout.showPreviews,this.forceUpdate()}),a()(this,"onBadgeClick",e=>{let t;e.preventDefault(),e.stopPropagation(),t=this.props.tagId===g.a.Invite?this.state.rooms&&this.state.rooms[0]:u.b.instance.unfilteredLists[this.props.tagId].find(e=>{const t=this.notificationState.getForRoom(e);return t.count>0&&t.color===this.notificationState.color}),t&&f.a.dispatch({action:"view_room",room_id:t.roomId,show_room_tile:!0})}),a()(this,"onHeaderClick",()=>{const t=this.headerButton.current.parentElement,s=t.parentElement.parentElement,n=s.parentElement.parentElement,a=n.scrollTop<=k,i=n.scrollTop>=n.scrollHeight-n.offsetHeight,o=t.classList.contains("mx_RoomSublist_headerContainer_stickyTop"),r=t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom");if(r&&!i||o&&!a)s.scrollIntoView({behavior:"smooth"});else{const t=this.state.isExpanded;this.toggleCollapsed(),!t&&r&&e(()=>{s.scrollIntoView({behavior:"smooth"})})}}),a()(this,"toggleCollapsed",()=>{this.layout.isCollapsed=this.state.isExpanded,this.setState({isExpanded:!this.layout.isCollapsed}),e(()=>this.props.onResize())}),a()(this,"onHeaderKeyDown",e=>{switch(e.key){case _.a.ARROW_LEFT:e.stopPropagation(),this.state.isExpanded&&this.toggleCollapsed();break;case _.a.ARROW_RIGHT:if(e.stopPropagation(),this.state.isExpanded){if(this.sublistRef.current){const e=this.sublistRef.current.querySelector(".mx_RoomTile");e&&e.focus()}}else this.toggleCollapsed()}}),a()(this,"onKeyDown",e=>{switch(e.key){case _.a.ARROW_LEFT:e.stopPropagation(),this.headerButton.current.focus();break;case _.a.ARROW_RIGHT:e.stopPropagation()}}),this.layout=w.a.instance.getLayoutFor(this.props.tagId),this.heightAtStart=0,this.isBeingFiltered=!!u.b.instance.getFirstNameFilterCondition(),this.notificationState=C.a.instance.getListState(this.props.tagId),this.state={contextMenuPosition:null,addRoomContextMenuPosition:null,isResizing:!1,isExpanded:this.isBeingFiltered?this.isBeingFiltered:!this.layout.isCollapsed,height:0,rooms:Object(S.c)(u.b.instance.orderedLists[this.props.tagId]||[])},this.state=Object.assign(this.state,{height:this.calculateInitialHeight()}),this.dispatcherRef=f.a.register(this.onAction),u.b.instance.on(u.a,this.onListsUpdated)}calculateInitialHeight(){const e=Math.max(Math.floor(this.layout.visibleTiles),this.layout.minVisibleTiles),t=Math.min(this.numTiles,e);return this.layout.tilesToPixelsWithPadding(t,this.padding)}get padding(){let e=4;const t=this.numTiles>this.numVisibleTiles,s=this.numTiles>this.layout.defaultVisibleTiles;return(t||s)&&(e+=28),e}get extraTiles(){return this.state.filteredExtraTiles?this.state.filteredExtraTiles:this.props.extraBadTilesThatShouldntExist?this.props.extraBadTilesThatShouldntExist:null}get numTiles(){return I.calcNumTiles(this.state.rooms,this.extraTiles)}static calcNumTiles(e,t){return(e||[]).length+(t||[]).length}get numVisibleTiles(){const e=Math.ceil(this.layout.visibleTiles);return Math.min(e,this.numTiles)}componentDidUpdate(e,t){const s=t.filteredExtraTiles||e.extraBadTilesThatShouldntExist;I.calcNumTiles(t.rooms,s)!==this.numTiles&&this.setState({height:this.calculateInitialHeight()})}shouldComponentUpdate(e,t){if(Object(x.c)(this.props,e))return!0;const s=Object(x.b)(this.state,["rooms"]),n=Object(x.b)(t,["rooms"]);if(Object(x.c)(s,n))return!0;const a=this.props.extraBadTilesThatShouldntExist||[],i=t.filteredExtraTiles||e.extraBadTilesThatShouldntExist||[];if(a.length>0||i.length>0)return!0;if(I.calcNumTiles(t.rooms,i)!==this.numTiles)return!0;if(!t.isExpanded)return!1;if(this.state.rooms.length!==t.rooms.length)return!0;const o=this.state.rooms.slice(0,this.numVisibleTiles),r=t.rooms.slice(0,this.numVisibleTiles);return!!Object(S.e)(o,r)}componentWillUnmount(){f.a.unregister(this.dispatcherRef),u.b.instance.off(u.a,this.onListsUpdated)}applyHeightChange(e){const t=Math.ceil(this.layout.pixelsToTiles(e-this.padding));this.layout.visibleTiles=Math.min(this.numTiles,t)}renderVisibleTiles(){if(!this.state.isExpanded)return[];const e=[];if(this.state.rooms){const t=this.state.rooms.slice(0,this.numVisibleTiles);for(const s of t)e.push(i.createElement(m.a,{room:s,key:"room-"+s.roomId,showMessagePreview:this.layout.showPreviews,isMinimized:this.props.isMinimized,tag:this.props.tagId}))}return this.extraTiles&&e.push(...this.extraTiles),e.length>this.numVisibleTiles?e.slice(0,this.numVisibleTiles):e}renderMenu(){let e=null;if(this.state.contextMenuPosition){const t=u.b.instance.getTagSorting(this.props.tagId)===p.b.Alphabetic,s=u.b.instance.getListOrder(this.props.tagId)===p.a.Importance;let n=null;this.props.tagId!==g.a.Invite&&(n=i.createElement(i.Fragment,null,i.createElement("hr",null),i.createElement("div",null,i.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(c.a)("Appearance")),i.createElement(h.i,{onClose:this.onCloseMenu,onChange:this.onUnreadFirstChanged,checked:s},Object(c.a)("Show rooms with unread messages first")),i.createElement(h.i,{onClose:this.onCloseMenu,onChange:this.onMessagePreviewChanged,checked:this.layout.showPreviews},Object(c.a)("Show previews of messages"))))),e=i.createElement(h.b,{chevronFace:h.a.None,left:this.state.contextMenuPosition.left,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height,onFinished:this.onCloseMenu},i.createElement("div",{className:"mx_RoomSublist_contextMenu"},i.createElement("div",null,i.createElement("div",{className:"mx_RoomSublist_contextMenu_title"},Object(c.a)("Sort by")),i.createElement(h.j,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(p.b.Recent),checked:!t,name:`mx_${this.props.tagId}_sortBy`},Object(c.a)("Activity")),i.createElement(h.j,{onClose:this.onCloseMenu,onChange:()=>this.onTagSortChanged(p.b.Alphabetic),checked:t,name:`mx_${this.props.tagId}_sortBy`},Object(c.a)("A-Z"))),n))}else this.state.addRoomContextMenuPosition&&(e=i.createElement(R.e,{chevronFace:h.a.None,left:this.state.addRoomContextMenuPosition.left-7,top:this.state.addRoomContextMenuPosition.top+this.state.addRoomContextMenuPosition.height,onFinished:this.onCloseAddRoomMenu,compact:!0},this.props.addRoomContextMenu(this.onCloseAddRoomMenu)));return i.createElement(i.Fragment,null,i.createElement(h.d,{className:"mx_RoomSublist_menuButton",onClick:this.onOpenMenuClick,title:Object(c.a)("List options"),isExpanded:!!this.state.contextMenuPosition}),e)}renderHeader(){return i.createElement(l.d,{inputRef:this.headerButton},({onFocus:e,isActive:t,ref:s})=>{const n=t?0:-1;let a=Object(c.a)("Jump to first unread room.");this.props.tagId===g.a.Invite&&(a=Object(c.a)("Jump to first invite."));const o=i.createElement(b.a,{forceCount:!0,notification:this.notificationState,onClick:this.onBadgeClick,tabIndex:n,"aria-label":a});let l=null;O.a.isCurrentUserExtern()||(this.props.onAddRoom?l=i.createElement(v.a,{tabIndex:n,onClick:this.onAddRoom,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(c.a)("Add room"),title:this.props.addRoomLabel}):this.props.addRoomContextMenu&&(l=i.createElement(h.d,{tabIndex:n,onClick:this.onAddRoomContextMenu,className:"mx_RoomSublist_auxButton",tooltipClassName:"mx_RoomSublist_addRoomTooltip","aria-label":this.props.addRoomLabel||Object(c.a)("Add room"),title:this.props.addRoomLabel,isExpanded:!!this.state.addRoomContextMenuPosition})));const m=r()({mx_RoomSublist_collapseBtn:!0,mx_RoomSublist_collapseBtn_collapsed:!this.state.isExpanded}),u=r()({mx_RoomSublist_headerContainer:!0,mx_RoomSublist_headerContainer_withAux:!!l}),p=i.createElement("div",{className:"mx_RoomSublist_badgeContainer"},o);let f=d.a;return this.props.isMinimized&&(f=v.a),i.createElement("div",{className:u,onKeyDown:this.onHeaderKeyDown,onFocus:e,"aria-label":this.props.label},i.createElement("div",{className:"mx_RoomSublist_stickable"},i.createElement(f,{onFocus:e,inputRef:s,tabIndex:n,className:"mx_RoomSublist_headerText",role:"treeitem","aria-expanded":this.state.isExpanded,"aria-level":1,onClick:this.onHeaderClick,onContextMenu:this.onContextMenu,title:this.props.isMinimized?this.props.label:void 0},i.createElement("span",{className:m}),i.createElement("span",null,this.props.label)),this.renderMenu(),this.props.isMinimized?null:p,this.props.isMinimized?null:l),this.props.isMinimized?p:null,this.props.isMinimized?l:null)})}onScrollPrevent(e){e.target.scrollTop=0}render(){const e=this.renderVisibleTiles(),t=r()({mx_RoomSublist:!0,mx_RoomSublist_hasMenuOpen:!!this.state.contextMenuPosition,mx_RoomSublist_minimized:this.props.isMinimized});let s=null;if(e.length>0){const t=this.layout,n=Math.min(t.minVisibleTiles,this.numTiles),a=4+(n<this.numTiles?28:0),o=t.tilesToPixelsWithPadding(n,a),d=t.tilesToPixelsWithPadding(this.numTiles,this.padding),m=r()({mx_RoomSublist_showNButton:!0});let h=null;if(d>this.state.height){const e=this.state.height-4-28,t=Math.floor(e/this.layout.tileHeight),s=this.numTiles-t,n=Object(c.a)("Show %(count)s more",{count:s});let a=i.createElement("span",{className:"mx_RoomSublist_showNButtonText"},n);this.props.isMinimized&&(a=null),h=i.createElement(l.a,{role:"treeitem",onClick:this.onShowAllClick,className:m,"aria-label":n},i.createElement("span",{className:"mx_RoomSublist_showMoreButtonChevron mx_RoomSublist_showNButtonChevron"}),a)}else if(this.numTiles>this.layout.defaultVisibleTiles){const e=Object(c.a)("Show less");let t=i.createElement("span",{className:"mx_RoomSublist_showNButtonText"},e);this.props.isMinimized&&(t=null),h=i.createElement(l.a,{role:"treeitem",onClick:this.onShowLessClick,className:m,"aria-label":e},i.createElement("span",{className:"mx_RoomSublist_showLessButtonChevron mx_RoomSublist_showNButtonChevron"}),t)}const u={bottom:!0,bottomLeft:!1,bottomRight:!1,left:!1,right:!1,top:!1,topLeft:!1,topRight:!1};t.visibleTiles>=this.numTiles&&this.numTiles<=t.minVisibleTiles&&(u.bottom=!1);const p=r()({mx_RoomSublist_resizerHandles:!0,mx_RoomSublist_resizerHandles_showNButton:!!h});s=i.createElement(i.Fragment,null,i.createElement(y.Resizable,{size:{height:this.state.height},minHeight:o,maxHeight:d,onResizeStart:this.onResizeStart,onResizeStop:this.onResizeStop,onResize:this.onResize,handleWrapperClass:p,handleClasses:{bottom:"mx_RoomSublist_resizerHandle"},className:"mx_RoomSublist_resizeBox",enable:u},i.createElement("div",{className:"mx_RoomSublist_tiles",onScroll:this.onScrollPrevent},e),h))}else this.props.showSkeleton&&this.state.isExpanded&&(s=i.createElement("div",{className:"mx_RoomSublist_skeletonUI"}));return i.createElement("div",{ref:this.sublistRef,className:t,role:"group","aria-label":this.props.label,onKeyDown:this.onKeyDown},this.renderHeader(),s)}}}).call(this,s(167).setImmediate)},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(647);let o;!function(e){e[e.Pending=0]="Pending",e[e.Success=1]="Success",e[e.Error=2]="Error"}(o||(o={}));class r extends i.a{constructor(e,t){super(),this.auditName=e,this.runFn=t,a()(this,"_status",o.Pending),a()(this,"didFail",!1),a()(this,"startTime",new Date)}get didPreviouslyFail(){return this.didFail}get status(){return this._status}run(){if(this.status===o.Success)throw new Error("Cannot re-run a successful echo transaction");this.setStatus(o.Pending),this.runFn().then(()=>this.setStatus(o.Success)).catch(()=>this.setStatus(o.Error))}cancel(){this.setStatus(o.Success)}setStatus(e){this._status=e,e===o.Error?this.didFail=!0:e===o.Success&&(this.didFail=!1),this.notifyCondition(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(92),o=s(86);class r{constructor(){a()(this,"domain",void 0),a()(this,"update",async e=>{let t=(i.a.get().jitsi||{}).preferredDomain||"jitsi.riot.im";if(console.log("Attempting to get Jitsi conference information from homeserver"),e&&e["im.vector.riot.jitsi"]){const s=e["im.vector.riot.jitsi"].preferredDomain;s&&(t=s)}this.domain=t,console.log("Jitsi conference domain:",this.preferredDomain)})}get preferredDomain(){return this.domain||"jitsi.riot.im"}async getJitsiAuth(){if(!this.preferredDomain)return null;let e;try{const t=await fetch(`https://${this.preferredDomain}/.well-known/element/jitsi`);e=await t.json()}catch(e){return null}return e.auth?e.auth:null}start(){const e=o.a.get();e.on("WellKnown.client",this.update),this.update(e.getClientWellKnown())}parsePreferredConferenceUrl(e){const t=new URL(e);return t.hostname!==this.preferredDomain?null:{conferenceId:t.pathname,domain:t.hostname,isAudioOnly:!1}}static getInstance(){return r.instance||(r.instance=new r),r.instance}}a()(r,"instance",void 0)},,function(e,t,s){"use strict";s.d(t,"b",(function(){return c})),s.d(t,"a",(function(){return d}));var n=s(83),a=s(249),i=s(158),o=s(138);const r=()=>{a.default.setEnabled(!0)},l=()=>{a.default.setPromptHidden(!0)},c=e=>{o.a.sharedInstance().addOrReplaceToast({key:"desktopnotifications",title:e?Object(n.a)("Don't miss a reply"):Object(n.a)("Notifications"),props:{description:Object(n.a)("Enable desktop notifications"),acceptLabel:Object(n.a)("Enable"),onAccept:r,rejectLabel:Object(n.a)("Dismiss"),onReject:l},component:i.a,priority:30})},d=()=>{o.a.sharedInstance().dismissToast("desktopnotifications")}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(101),a=s.n(n),i=s(81),o=s.n(i),r=s(91);function l(e){const{className:t,label:s,kind:n}=e,i=a()(e,["className","label","kind"]),l=(t||"")+" mx_FormButton",c=Object.assign({},i,{className:l,kind:n||"primary",children:[s]});return o.a.createElement(r.a,c)}l.propTypes=r.a.propTypes},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(87),o=s(250);class r{constructor(e,t){this.window=e,this.document=t,a()(this,"activeNowTimeout",void 0),a()(this,"activeRecentlyTimeout",void 0),a()(this,"attachedActiveNowTimers",[]),a()(this,"attachedActiveRecentlyTimers",[]),a()(this,"lastScreenX",0),a()(this,"lastScreenY",0),a()(this,"onPageVisibilityChanged",e=>{"hidden"===this.document.visibilityState?(this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()):this.onUserActivity(e)}),a()(this,"onWindowBlurred",()=>{this.activeNowTimeout.abort(),this.activeRecentlyTimeout.abort()}),a()(this,"onUserActivity",e=>{if(this.document.hasFocus()){if(e.screenX&&"mousemove"===e.type){if(e.screenX===this.lastScreenX&&e.screenY===this.lastScreenY)return;this.lastScreenX=e.screenX,this.lastScreenY=e.screenY}i.a.dispatch({action:"user_activity"}),this.activeNowTimeout.isRunning()?this.activeNowTimeout.restart():(this.activeNowTimeout.start(),i.a.dispatch({action:"user_activity_start"}),r.runTimersUntilTimeout(this.attachedActiveNowTimers,this.activeNowTimeout)),this.activeRecentlyTimeout.isRunning()?this.activeRecentlyTimeout.restart():(this.activeRecentlyTimeout.start(),r.runTimersUntilTimeout(this.attachedActiveRecentlyTimers,this.activeRecentlyTimeout))}}),this.activeNowTimeout=new o.a(700),this.activeRecentlyTimeout=new o.a(12e4)}static sharedInstance(){return void 0===window.mxUserActivity&&(window.mxUserActivity=new r(window,document)),window.mxUserActivity}timeWhileActiveNow(e){this.timeWhile(e,this.attachedActiveNowTimers),this.userActiveNow()&&e.start()}timeWhileActiveRecently(e){this.timeWhile(e,this.attachedActiveRecentlyTimers),this.userActiveRecently()&&e.start()}timeWhile(e,t){-1===t.indexOf(e)&&(t.push(e),e.finished().finally(()=>{const s=t.indexOf(e);-1!==s&&t.splice(s,1)}).catch(e=>{}))}start(){this.document.addEventListener("mousedown",this.onUserActivity),this.document.addEventListener("mousemove",this.onUserActivity),this.document.addEventListener("keydown",this.onUserActivity),this.document.addEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.addEventListener("blur",this.onWindowBlurred),this.window.addEventListener("focus",this.onUserActivity),this.window.addEventListener("wheel",this.onUserActivity,{passive:!0,capture:!0})}stop(){this.document.removeEventListener("mousedown",this.onUserActivity),this.document.removeEventListener("mousemove",this.onUserActivity),this.document.removeEventListener("keydown",this.onUserActivity),this.window.removeEventListener("wheel",this.onUserActivity,{capture:!0}),this.document.removeEventListener("visibilitychange",this.onPageVisibilityChanged),this.window.removeEventListener("blur",this.onWindowBlurred),this.window.removeEventListener("focus",this.onUserActivity)}userActiveNow(){return this.activeNowTimeout.isRunning()}userActiveRecently(){return this.activeRecentlyTimeout.isRunning()}static async runTimersUntilTimeout(e,t){e.forEach(e=>e.start());try{await t.finished()}catch(e){}e.forEach(e=>e.abort())}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(86),o=s(342),r=s(88),l=s(83),c=s(87),d=s(96);class m{constructor(){a()(this,"_lists",[]),a()(this,"_roomIds",[]),a()(this,"_mjolnirWatchRef",null),a()(this,"_dispatcherRef",null),a()(this,"_onAction",e=>{"setup_mjolnir"===e.action&&(console.log("Setting up Mjolnir: after sync"),this.setup())}),a()(this,"_onEvent",e=>{i.a.get()&&this._roomIds.includes(e.getRoomId())&&o.a.includes(e.getType())&&this._updateLists(this._roomIds)})}get roomIds(){return this._roomIds}get lists(){return this._lists}start(){this._mjolnirWatchRef=r.a.watchSetting("mjolnirRooms",null,this._onListsChanged.bind(this)),this._dispatcherRef=c.a.register(this._onAction),c.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"setup_mjolnir"}})}setup(){i.a.get()&&(this._updateLists(r.a.getValue("mjolnirRooms")),i.a.get().on("RoomState.events",this._onEvent))}stop(){this._mjolnirWatchRef&&(r.a.unwatchSetting(this._mjolnirWatchRef),this._mjolnirWatchRef=null),this._dispatcherRef&&(c.a.unregister(this._dispatcherRef),this._dispatcherRef=null),i.a.get()&&i.a.get().removeListener("RoomState.events",this._onEvent)}async getOrCreatePersonalList(){let e=r.a.getValue("mjolnirPersonalRoom");if(!e){const t=await i.a.get().createRoom({name:Object(l.a)("My Ban List"),topic:Object(l.a)("This is your list of users/servers you have blocked - don't leave the room!"),preset:"private_chat"});e=t.room_id,await r.a.setValue("mjolnirPersonalRoom",null,d.a.ACCOUNT,e),await r.a.setValue("mjolnirRooms",null,d.a.ACCOUNT,[e,...this._roomIds])}if(!e)throw new Error("Error finding a room ID to use");let t=this._lists.find(t=>t.roomId===e);return t||(t=new o.b(e)),t}getPersonalList(){const e=r.a.getValue("mjolnirPersonalRoom");if(!e)return null;let t=this._lists.find(t=>t.roomId===e);return t||(t=new o.b(e)),t}async subscribeToList(e){const t=[...this._roomIds,e];await r.a.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists.push(new o.b(e))}async unsubscribeFromList(e){const t=this._roomIds.filter(t=>t!==e);await r.a.setValue("mjolnirRooms",null,d.a.ACCOUNT,t),this._lists=this._lists.filter(t=>t.roomId!==e)}_onListsChanged(e,t,s,n){this._updateLists(n)}_updateLists(e){if(i.a.get()&&(console.log("Updating Mjolnir ban lists to: "+e),this._lists=[],this._roomIds=e||[],e))for(const t of e)this._lists.push(new o.b(t))}isServerBanned(e){for(const t of this._lists)for(const s of t.serverRules)if(s.isMatch(e))return!0;return!1}isUserBanned(e){for(const t of this._lists)for(const s of t.userRules)if(s.isMatch(e))return!0;return!1}static sharedInstance(){return m._instance||(m._instance=new m),m._instance}}a()(m,"_instance",null)},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(92),m=s(86),h=s(85),u=s(454);class p extends o.a.Component{constructor(){super(),a()(this,"_onStoreUpdate",()=>{const e=u.f.sharedInstance();e.phase!==u.d?this.setState({phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo}):this.props.onFinished()}),a()(this,"_onUsePassphraseClick",async()=>{u.f.sharedInstance().usePassPhrase()}),a()(this,"onSkipClick",()=>{u.f.sharedInstance().skip()}),a()(this,"onSkipConfirmClick",()=>{u.f.sharedInstance().skipConfirm()}),a()(this,"onSkipBackClick",()=>{u.f.sharedInstance().returnAfterSkip()}),a()(this,"onDoneClick",()=>{u.f.sharedInstance().done()});const e=u.f.sharedInstance();e.on("update",this._onStoreUpdate),e.start(),this.state={phase:e.phase,verificationRequest:e.verificationRequest,backupInfo:e.backupInfo}}componentWillUnmount(){const e=u.f.sharedInstance();e.off("update",this._onStoreUpdate),e.stop()}render(){const e=h.getComponent("elements.AccessibleButton"),{phase:t}=this.state;if(this.state.verificationRequest){const e=h.getComponent("views.right_panel.EncryptionPanel");return o.a.createElement(e,{layout:"dialog",verificationRequest:this.state.verificationRequest,onClose:this.props.onFinished,member:m.a.get().getUser(this.state.verificationRequest.otherUserId)})}if(t===u.e){const t=u.f.sharedInstance();let n,a;t.keyInfo&&((s=t.keyInfo).passphrase&&s.passphrase.salt&&s.passphrase.iterations)?n=Object(c.a)("Use Security Key or Phrase"):t.keyInfo&&(n=Object(c.a)("Use Security Key")),n&&(a=o.a.createElement(e,{kind:"link",onClick:this._onUsePassphraseClick},n));const i=d.a.get().brand;return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Confirm your identity by verifying this login from one of your other sessions, granting it access to encrypted messages.")),o.a.createElement("p",null,Object(c.a)("This requires the latest %(brand)s on your other devices:",{brand:i})),o.a.createElement("div",{className:"mx_CompleteSecurity_clients"},o.a.createElement("div",{className:"mx_CompleteSecurity_clients_desktop"},o.a.createElement("div",null,Object(c.a)("%(brand)s Web",{brand:i})),o.a.createElement("div",null,Object(c.a)("%(brand)s Desktop",{brand:i}))),o.a.createElement("div",{className:"mx_CompleteSecurity_clients_mobile"},o.a.createElement("div",null,Object(c.a)("%(brand)s iOS",{brand:i})),o.a.createElement("div",null,Object(c.a)("%(brand)s Android",{brand:i}))),o.a.createElement("p",null,Object(c.a)("or another cross-signing capable Matrix client"))),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},a,o.a.createElement(e,{kind:"danger",onClick:this.onSkipClick},Object(c.a)("Skip"))))}if(t===u.c){let t;return t=this.state.backupInfo?o.a.createElement("p",null,Object(c.a)("Your new session is now verified. It has access to your encrypted messages, and other users will see it as trusted.")):o.a.createElement("p",null,Object(c.a)("Your new session is now verified. Other users will see it as trusted.")),o.a.createElement("div",null,o.a.createElement("div",{className:"mx_CompleteSecurity_heroIcon mx_E2EIcon_verified"}),t,o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(e,{kind:"primary",onClick:this.onDoneClick},Object(c.a)("Done"))))}if(t===u.b)return o.a.createElement("div",null,o.a.createElement("p",null,Object(c.a)("Without completing security on this session, it won’t have access to encrypted messages.")),o.a.createElement("div",{className:"mx_CompleteSecurity_actionRow"},o.a.createElement(e,{className:"warning",kind:"secondary",onClick:this.onSkipConfirmClick},Object(c.a)("Skip")),o.a.createElement(e,{kind:"danger",onClick:this.onSkipBackClick},Object(c.a)("Go Back"))));if(t===u.a){const e=h.getComponent("views.elements.Spinner");return o.a.createElement(e,null)}var s;console.log("SetupEncryptionBody: Unknown phase "+t)}}a()(p,"propTypes",{onFinished:l.a.func.isRequired})},function(e,t,s){"use strict";(function(e){s.d(t,"e",(function(){return d})),s.d(t,"a",(function(){return m})),s.d(t,"c",(function(){return h})),s.d(t,"b",(function(){return u})),s.d(t,"d",(function(){return p})),s.d(t,"f",(function(){return g}));var n=s(82),a=s.n(n),i=s(6),o=s.n(i),r=s(86),l=s(175),c=s(211);const d=0,m=1,h=2,u=3,p=4;class g extends o.a{constructor(...e){super(...e),a()(this,"_onUserTrustStatusChanged",e=>{if(e!==r.a.get().getUserId())return;r.a.get().getCrossSigningId()&&(this.phase=h,this.emit("update"))}),a()(this,"onVerificationRequest",e=>{this._setActiveVerificationRequest(e)}),a()(this,"onVerificationRequestChange",()=>{if(this.verificationRequest.cancelled)this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null,this.emit("update");else if(this.verificationRequest.phase===c.c){this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=null;const e=r.a.get().getCrossSigningId();this.phase=e?h:m,this.emit("update")}})}static sharedInstance(){return e.mx_SetupEncryptionStore||(e.mx_SetupEncryptionStore=new g),e.mx_SetupEncryptionStore}start(){if(this._started)return;this._started=!0,this.phase=m,this.verificationRequest=null,this.backupInfo=null,this.keyId=null,this.keyInfo=null;const e=r.a.get();e.on("crypto.verification.request",this.onVerificationRequest),e.on("userTrustStatusChanged",this._onUserTrustStatusChanged);const t=e.getVerificationRequestsToDeviceInProgress(e.getUserId());t.length&&this._setActiveVerificationRequest(t[t.length-1]),this.fetchKeyInfo()}stop(){this._started&&(this._started=!1,this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),r.a.get()&&(r.a.get().removeListener("crypto.verification.request",this.onVerificationRequest),r.a.get().removeListener("userTrustStatusChanged",this._onUserTrustStatusChanged)))}async fetchKeyInfo(){const e=await r.a.get().isSecretStored("m.cross_signing.master",!1);null===e||0===Object.keys(e).length?(this.keyId=null,this.keyInfo=null):(this.keyId=Object.keys(e)[0],this.keyInfo=e[this.keyId]),this.phase=d,this.emit("update")}async usePassPhrase(){this.phase=m,this.emit("update");const e=r.a.get();try{const t=await e.getKeyBackupVersion();this.backupInfo=t,this.emit("update"),await new Promise((s,n)=>{try{Object(l.b)(async()=>{await e.checkOwnCrossSigningTrust(),s(),t&&await e.restoreKeyBackupWithSecretStorage(t)}).catch(n)}catch(e){console.error(e),n(e)}}),e.getCrossSigningId()&&(this.phase=h,this.emit("update"))}catch(e){e instanceof l.a||console.log(e),this.phase=d,this.emit("update")}}skip(){this.phase=u,this.emit("update")}skipConfirm(){this.phase=p,this.emit("update")}returnAfterSkip(){this.phase=d,this.emit("update")}done(){this.phase=p,this.emit("update"),r.a.get()._crypto.cancelAndResendAllOutgoingKeyRequests()}async _setActiveVerificationRequest(e){e.otherUserId===r.a.get().getUserId()&&(this.verificationRequest&&this.verificationRequest.off("change",this.onVerificationRequestChange),this.verificationRequest=e,await e.accept(),e.on("change",this.onVerificationRequestChange),this.emit("update"))}}}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(86),d=s(85),m=s(83);class h extends o.a.Component{constructor(...e){super(...e),this.onFinished=this.onFinished.bind(this),this.state={},this.props.verificationRequest?this.state.verificationRequest=this.props.verificationRequest:this.props.verificationRequestPromise&&this.props.verificationRequestPromise.then(e=>{this.setState({verificationRequest:e})})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.right_panel.EncryptionPanel"),s=this.state.verificationRequest,n=s&&s.otherUserId,a=this.props.member||n&&c.a.get().getUser(n),i=s&&s.isSelfVerification?Object(m.a)("Verify another device"):Object(m.a)("Verification Request");return o.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.onFinished,contentId:"mx_Dialog_content",title:i,hasCancel:!0},o.a.createElement(t,{layout:"dialog",verificationRequest:this.props.verificationRequest,verificationRequestPromise:this.props.verificationRequestPromise,onClose:this.props.onFinished,member:a}))}async onFinished(){this.props.onFinished();let e=this.props.verificationRequest;!e&&this.props.verificationRequestPromise&&(e=await this.props.verificationRequestPromise),e.cancel()}}a()(h,"propTypes",{verificationRequest:l.a.object,verificationRequestPromise:l.a.object,onFinished:l.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return f}));var n=s(81),a=s.n(n),i=s(83),o=s(92),r=s(158),l=s(138),c=s(142),d=s(663),m=s(107),h=s(89);function u(e){const t=e.split("-");return 5===t.length&&"react"===t[1]&&"js"===t[3]}function p(){m.a.get().installUpdate()}const g=(e,t,s)=>{let n,g=Object(i.a)("What's new?");s?n=()=>{h.a.createTrackedDialog("Display release notes","",c.a,{title:Object(i.a)("What's New"),description:a.a.createElement("pre",null,s),button:Object(i.a)("Update"),onFinished:e=>{e&&m.a.get()&&m.a.get().installUpdate()}})}:u(e)&&u(t)?n=()=>{h.a.createTrackedDialog("Display Changelog","",d.a,{version:e,newVersion:t,onFinished:e=>{e&&m.a.get()&&m.a.get().installUpdate()}})}:(n=p,g=Object(i.a)("Update"));const f=o.a.get().brand;l.a.sharedInstance().addOrReplaceToast({key:"update",title:Object(i.a)("Update %(brand)s",{brand:f}),props:{description:Object(i.a)("New version of %(brand)s is available",{brand:f}),acceptLabel:g,onAccept:n,rejectLabel:Object(i.a)("Dismiss"),onReject:function(){m.a.get().deferUpdate(t)}},component:r.a,priority:20})},f=()=>{l.a.sharedInstance().dismissToast("update")}},function(e,t){e.exports="img/feather-customised/warning-triangle.d050a38.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(159),o=s(253);class r extends i.a{getValueOverride(e,t,s,n){if(!s)return null;if(r.isLogin)return"light";return Object(o.b)()[s]?null:o.a}}a()(r,"isLogin",!1)},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return m})),s.d(t,"d",(function(){return y})),s.d(t,"c",(function(){return E}));var n=s(81),a=s(90),i=s.n(a),o=s(85),r=s(89),l=s(83),c=s(99);let d,m;Object(l.b)("Navigation"),Object(l.b)("Calls"),Object(l.b)("Composer"),Object(l.b)("Room List"),Object(l.b)("Autocomplete"),function(e){e.NAVIGATION="Navigation",e.CALLS="Calls",e.COMPOSER="Composer",e.ROOM_LIST="Room List",e.ROOM="Room",e.AUTOCOMPLETE="Autocomplete"}(d||(d={})),Object(l.b)("Alt"),Object(l.b)("Alt Gr"),Object(l.b)("Shift"),Object(l.b)("Super"),Object(l.b)("Ctrl"),function(e){e.ALT="Alt",e.ALT_GR="Alt Gr",e.SHIFT="Shift",e.SUPER="Super",e.COMMAND="Command",e.CONTROL="Ctrl"}(m||(m={}));const h=c.b?m.COMMAND:m.CONTROL,u={[d.COMPOSER]:[{keybinds:[{modifiers:[h],key:c.a.B}],description:Object(l.b)("Toggle Bold")},{keybinds:[{modifiers:[h],key:c.a.I}],description:Object(l.b)("Toggle Italics")},{keybinds:[{modifiers:[h],key:c.a.GREATER_THAN}],description:Object(l.b)("Toggle Quote")},{keybinds:[{modifiers:[m.SHIFT],key:c.a.ENTER}],description:Object(l.b)("New line")},{keybinds:[{key:c.a.ARROW_UP},{key:c.a.ARROW_DOWN}],description:Object(l.b)("Navigate recent messages to edit")},{keybinds:[{modifiers:[h],key:c.a.HOME},{modifiers:[h],key:c.a.END}],description:Object(l.b)("Jump to start/end of the composer")},{keybinds:[{modifiers:[m.CONTROL,m.ALT],key:c.a.ARROW_UP},{modifiers:[m.CONTROL,m.ALT],key:c.a.ARROW_DOWN}],description:Object(l.b)("Navigate composer history")},{keybinds:[{key:c.a.ESCAPE}],description:Object(l.b)("Cancel replying to a message")}],[d.CALLS]:[{keybinds:[{modifiers:[h],key:c.a.D}],description:Object(l.b)("Toggle microphone mute")},{keybinds:[{modifiers:[h],key:c.a.E}],description:Object(l.b)("Toggle video on/off")}],[d.ROOM]:[{keybinds:[{key:c.a.PAGE_UP},{key:c.a.PAGE_DOWN}],description:Object(l.b)("Scroll up/down in the timeline")},{keybinds:[{key:c.a.ESCAPE}],description:Object(l.b)("Dismiss read marker and jump to bottom")},{keybinds:[{modifiers:[m.SHIFT],key:c.a.PAGE_UP}],description:Object(l.b)("Jump to oldest unread message")},{keybinds:[{modifiers:[h,m.SHIFT],key:c.a.U}],description:Object(l.b)("Upload a file")},{keybinds:[{modifiers:[h],key:c.a.F}],description:Object(l.b)("Search (must be enabled)")}],[d.ROOM_LIST]:[{keybinds:[{modifiers:[h],key:c.a.K}],description:Object(l.b)("Jump to room search")},{keybinds:[{key:c.a.ARROW_UP},{key:c.a.ARROW_DOWN}],description:Object(l.b)("Navigate up/down in the room list")},{keybinds:[{key:c.a.ENTER}],description:Object(l.b)("Select room from the room list")},{keybinds:[{key:c.a.ARROW_LEFT}],description:Object(l.b)("Collapse room list section")},{keybinds:[{key:c.a.ARROW_RIGHT}],description:Object(l.b)("Expand room list section")},{keybinds:[{key:c.a.ESCAPE}],description:Object(l.b)("Clear room list filter field")}],[d.NAVIGATION]:[{keybinds:[{modifiers:[m.ALT,m.SHIFT],key:c.a.ARROW_UP},{modifiers:[m.ALT,m.SHIFT],key:c.a.ARROW_DOWN}],description:Object(l.b)("Previous/next unread room or DM")},{keybinds:[{modifiers:[m.ALT],key:c.a.ARROW_UP},{modifiers:[m.ALT],key:c.a.ARROW_DOWN}],description:Object(l.b)("Previous/next room or DM")},{keybinds:[{modifiers:[h],key:c.a.BACKTICK}],description:Object(l.b)("Toggle the top left menu")},{keybinds:[{key:c.a.ESCAPE}],description:Object(l.b)("Close dialog or context menu")},{keybinds:[{key:c.a.ENTER},{key:c.a.SPACE}],description:Object(l.b)("Activate selected button")},{keybinds:[{modifiers:[h],key:c.a.PERIOD}],description:Object(l.b)("Toggle right panel")},{keybinds:[{modifiers:[h],key:c.a.SLASH}],description:Object(l.b)("Toggle this dialog")},{keybinds:[{modifiers:[h,m.ALT],key:c.a.H}],description:Object(l.b)("Go to Home View")}],[d.AUTOCOMPLETE]:[{keybinds:[{key:c.a.ARROW_UP},{key:c.a.ARROW_DOWN}],description:Object(l.b)("Move autocomplete selection up/down")},{keybinds:[{key:c.a.ESCAPE}],description:Object(l.b)("Cancel autocomplete")}]},p=[d.COMPOSER,d.AUTOCOMPLETE,d.ROOM,d.ROOM_LIST,d.NAVIGATION,d.CALLS],g={[m.COMMAND]:"⌘"};c.b&&(g[m.ALT]="⌥");const f={[c.a.PAGE_UP]:Object(l.b)("Page Up"),[c.a.PAGE_DOWN]:Object(l.b)("Page Down"),[c.a.ESCAPE]:Object(l.b)("Esc"),[c.a.ENTER]:Object(l.b)("Enter"),[c.a.SPACE]:Object(l.b)("Space"),[c.a.HOME]:Object(l.b)("Home"),[c.a.END]:Object(l.b)("End")},b={[c.a.ARROW_UP]:"↑",[c.a.ARROW_DOWN]:"↓",[c.a.ARROW_LEFT]:"←",[c.a.ARROW_RIGHT]:"→"},v=({shortcut:e})=>{const t=i()({mx_KeyboardShortcutsDialog_inline:e.keybinds.every(e=>!e.modifiers||0===e.modifiers.length)});return n.createElement("div",{className:t},n.createElement("h5",null,Object(l.a)(e.description)),e.keybinds.map(e=>{let t=e.key;return f[e.key]?t=Object(l.a)(f[e.key]):b[e.key]&&(t=b[e.key]),n.createElement("div",{key:e.key},e.modifiers&&e.modifiers.map(e=>n.createElement(n.Fragment,{key:e},n.createElement("kbd",null,g[e]||Object(l.a)(e)),"+")),n.createElement("kbd",null,t))}))};let _=null;const y=()=>{if(_)return _.close(),void(_=null);const e=p.map(e=>{const t=u[e];return n.createElement("div",{className:"mx_KeyboardShortcutsDialog_category",key:e},n.createElement("h3",null,Object(l.a)(e)),n.createElement("div",null,t.map(e=>n.createElement(v,{key:e.description,shortcut:e}))))}),t=o.getComponent("dialogs.InfoDialog");_=r.a.createTrackedDialog("Keyboard Shortcuts","",t,{className:"mx_KeyboardShortcutsDialog",title:Object(l.a)("Keyboard Shortcuts"),description:e,hasCloseButton:!0,onKeyDown:e=>{!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==c.a.SLASH||(e.stopPropagation(),_.close())},onFinished:()=>{_=null}})},E=(e,t)=>{u[e].push(t)}},,function(e,t,s){"use strict";(function(e){s.d(t,"d",(function(){return i})),s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r})),s.d(t,"c",(function(){return l}));class n{constructor(){this.logs=""}monkeyPatch(e){const t={log:"I",info:"I",warn:"W",error:"E"};Object.keys(t).forEach(s=>{const n=t[s],a=e[s].bind(e);e[s]=(...e)=>{this.log(n,...e),a(...e)}})}log(e,...t){let s=`${(new Date).toISOString()} ${e} ${(t=t.map(e=>{if(e instanceof Error)return e.message+(e.stack?"\n"+e.stack:"");if("object"!=typeof e)return e;try{return JSON.stringify(e)}catch(t){return JSON.stringify(e,(e,t)=>e&&"object"==typeof t?"<object>":t)}})).join(" ")}\n`;s=s.replace(/token=[a-zA-Z0-9-]+/gm,"token=xxxxx"),this.logs+=s}flush(e){if(e)return this.logs;const t=this.logs;return this.logs="",t}}class a{constructor(e,t){this.indexedDB=e,this.logger=t,this.id="instance-"+Math.random()+Date.now(),this.index=0,this.db=null,this.flushPromise=null,this.flushAgainPromise=null}connect(){const e=this.indexedDB.open("logs");return new Promise((t,s)=>{e.onsuccess=e=>{this.db=e.target.result,setInterval(this.flush.bind(this),3e4),t()},e.onerror=e=>{const t="Failed to open log database: "+e.target.error.name;console.error(t),s(new Error(t))},e.onupgradeneeded=e=>{const t=e.target.result,s=t.createObjectStore("logs",{keyPath:["id","index"]});s.createIndex("id","id",{unique:!1}),s.add(this._generateLogEntry(new Date+" ::: Log database was created."));t.createObjectStore("logslastmod",{keyPath:"id"}).add(this._generateLastModifiedTime())}})}flush(){return this.flushPromise?(this.flushAgainPromise||(this.flushAgainPromise=this.flushPromise.then(()=>this.flush()).then(()=>{this.flushAgainPromise=null})),this.flushAgainPromise):(this.flushPromise=new Promise((e,t)=>{if(!this.db)return void t(new Error("No connected database"));const s=this.logger.flush();if(0===s.length)return void e();const n=this.db.transaction(["logs","logslastmod"],"readwrite"),a=n.objectStore("logs");n.oncomplete=t=>{e()},n.onerror=e=>{console.error("Failed to flush logs : ",e),t(new Error("Failed to write logs: "+e.target.errorCode))},a.add(this._generateLogEntry(s));n.objectStore("logslastmod").put(this._generateLastModifiedTime())}).then(()=>{this.flushPromise=null}),this.flushPromise)}async consume(){const e=this.db;function t(t,s){const n=e.transaction("logs","readonly").objectStore("logs");return new Promise((e,a)=>{const i=n.index("id").openCursor(IDBKeyRange.only(t),"prev");let o="";i.onerror=e=>{a(new Error("Query failed: "+e.target.errorCode))},i.onsuccess=t=>{const n=t.target.result;n?(o=n.value.lines+o,o.length>=s?e(o):n.continue()):e(o)}})}const s=await function(e,t,s){const n=e.openCursor(t);return new Promise((e,t)=>{const a=[];n.onerror=e=>{t(new Error("Query failed: "+e.target.errorCode))},n.onsuccess=t=>{const n=t.target.result;n?(a.push(s(n)),n.continue()):e(a)}})}(e.transaction("logslastmod","readonly").objectStore("logslastmod"),void 0,e=>({id:e.value.id,ts:e.value.ts})).then(e=>e.sort((e,t)=>t.ts-e.ts).map(e=>e.id));let n=[];const a=[];let i=0;for(let e=0;e<s.length;e++){const o=await t(s[e],5242880-i);if(a.push({lines:o,id:s[e]}),i+=o.length,i>=5242880){n=s.slice(e+1);break}}return n.length>0&&(console.log("Removing logs: ",n),Promise.all(n.map(t=>function(t){return new Promise((s,n)=>{const a=e.transaction(["logs","logslastmod"],"readwrite"),i=a.objectStore("logs");i.index("id").openKeyCursor(IDBKeyRange.only(t)).onsuccess=e=>{const t=e.target.result;t&&(i.delete(t.primaryKey),t.continue())},a.oncomplete=()=>{s()},a.onerror=e=>{n(new Error(`Failed to delete logs for '${t}' : ${e.target.errorCode}`))};a.objectStore("logslastmod").delete(t)})}(t))).then(()=>{console.log(`Removed ${n.length} old logs.`)},e=>{console.error(e)})),a}_generateLogEntry(e){return{id:this.id,lines:e,index:this.index++}}_generateLastModifiedTime(){return{id:this.id,ts:Date.now()}}}function i(){if(e.mx_rage_initPromise)return e.mx_rage_initPromise;let t;e.mx_rage_logger=new n,e.mx_rage_logger.monkeyPatch(window.console);try{t=window.indexedDB}catch(e){}return t?(e.mx_rage_store=new a(t,e.mx_rage_logger),e.mx_rage_initPromise=e.mx_rage_store.connect(),e.mx_rage_initPromise):(e.mx_rage_initPromise=Promise.resolve(),e.mx_rage_initPromise)}function o(){e.mx_rage_store&&e.mx_rage_store.flush()}async function r(){e.mx_rage_store&&await e.mx_rage_store.consume()}async function l(){if(!e.mx_rage_logger)throw new Error("No console logger, did you forget to call init()?");return e.mx_rage_store?(await e.mx_rage_store.flush(),await e.mx_rage_store.consume()):[{lines:e.mx_rage_logger.flush(!0),id:"-"}]}}).call(this,s(5))},,,function(e,t,s){"use strict";var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(90),d=s.n(c),m=s(133),h=s(97),u=s(168);t.a=e=>{let{app:t,className:n,width:i=20,height:c=20}=e,p=o()(e,["app","className","width","height"]);const g=Object(r.useContext)(h.a);let f=[s(1166)];return t.type.includes("jitsi")?f=[s(1167)]:t.type.includes("meeting")||t.type.includes("calendar")?f=[s(1168)]:t.type.includes("pad")||t.type.includes("doc")||t.type.includes("calc")?f=[s(1169)]:t.type.includes("clock")&&(f=[s(1170)]),l.a.createElement(u.a,a()({},p,{name:t.id,className:d()("mx_WidgetAvatar",n),url:t.avatar_url?Object(m.a)(g.getHomeserverUrl(),t.avatar_url,20,20,"crop"):void 0,urls:f,width:i,height:c}))}},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(84),o=s.n(i);const r=e=>{const t=["mx_ResizeHandle"];return e.vertical?t.push("mx_ResizeHandle_vertical"):t.push("mx_ResizeHandle_horizontal"),e.reverse&&t.push("mx_ResizeHandle_reverse"),a.a.createElement("div",{className:t.join(" "),"data-id":e.id},a.a.createElement("div",null))};r.propTypes={vertical:o.a.bool,reverse:o.a.bool,id:o.a.string},t.a=r},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(686),a=s(354);class i extends n.a{start(e){this.vertical?e.style.minHeight=null:e.style.minWidth=null}finish(e){const t=e.offsetParent;if(t)if(this.vertical){const s=(e.offsetHeight/t.offsetHeight*100).toFixed(2)+"%";e.style.minHeight=s,e.style.height=s}else{const s=(e.offsetWidth/t.offsetWidth*100).toFixed(2)+"%";e.style.minWidth=s,e.style.width=s}}}class o extends a.a{static createSizer(e,t,s){return new i(e,t,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(82),a=s.n(n),i=s(106);class o{constructor(e,t,s){if(this.container=e,this.distributorCtor=t,this.config=s,a()(this,"classNames",void 0),a()(this,"onMouseDown",e=>{const t=e.target&&e.target.closest("."+this.classNames.handle);if(!t||t.parentElement!==this.container)return;e.preventDefault(),this.classNames.resizing&&this.container.classList.add(this.classNames.resizing),this.config.onResizeStart&&this.config.onResizeStart();const{sizer:s,distributor:n}=this.createSizerAndDistributor(t);n.start();const a=e=>{const t=s.offsetFromEvent(e);n.resizeFromContainerOffset(t)},i=document.body,o=()=>{this.classNames.resizing&&this.container.classList.remove(this.classNames.resizing),this.config.onResizeStop&&this.config.onResizeStop(),n.finish(),this.config.onResizeStop&&this.config.onResizeStop(),i.removeEventListener("mouseup",o,!1),document.removeEventListener("mouseleave",o,!1),i.removeEventListener("mousemove",a,!1)};i.addEventListener("mouseup",o,!1),document.addEventListener("mouseleave",o,!1),i.addEventListener("mousemove",a,!1)}),a()(this,"onResize",Object(i.throttle)(()=>{const e=this.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())},100,{trailing:!0,leading:!0})),a()(this,"getDistributors",()=>this.getResizeHandles().map(e=>{const{distributor:t}=this.createSizerAndDistributor(e);return t})),!e)throw new Error("Resizer requires a non-null `container` arg");this.classNames={handle:"resizer-handle",reverse:"resizer-reverse",vertical:"resizer-vertical",resizing:"resizer-resizing"}}setClassNames(e){this.classNames=e}attach(){this.container.addEventListener("mousedown",this.onMouseDown,!1),window.addEventListener("resize",this.onResize)}detach(){this.container.removeEventListener("mousedown",this.onMouseDown,!1),window.removeEventListener("resize",this.onResize)}forHandleAt(e){const t=this.getResizeHandles()[e];if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}forHandleWithId(e){const t=this.getResizeHandles().find(t=>t.getAttribute("data-id")===e);if(t){const{distributor:e}=this.createSizerAndDistributor(t);return e}}isReverseResizeHandle(e){return e&&e.classList.contains(this.classNames.reverse)}isResizeHandle(e){return e&&e.classList.contains(this.classNames.handle)}createSizerAndDistributor(e){const t=e.classList.contains(this.classNames.vertical),s=this.isReverseResizeHandle(e),n=this.distributorCtor,a=n.createSizer(this.container,t,s),i=n.createItem(e,this,a);return{sizer:a,distributor:new n(i)}}getResizeHandles(){return this.container.children?Array.from(this.container.children).filter(e=>this.isResizeHandle(e)):[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n=s(93),a=s.n(n),i=s(82),o=s.n(i),r=s(81),l=s.n(r),c=s(87),d=s(141),m=s(86),h=s(83),u=s(687),p=s(199),g=s(127),f=s(90),b=s.n(f),v=s(91),_=s(99),y=s(102),E=s(688),C=s(226),w=s(689);function S(){return document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement}function x(){const e=document.exitFullscreen||document.webkitExitFullscreen||document.msExitFullscreen;e&&e.call(document)}class R extends l.a.Component{constructor(e){super(e),o()(this,"dispatcherRef",void 0),o()(this,"contentRef",Object(r.createRef)()),o()(this,"controlsHideTimer",null),o()(this,"dialpadButton",Object(r.createRef)()),o()(this,"contextMenuButton",Object(r.createRef)()),o()(this,"onAction",e=>{switch(e.action){case"video_fullscreen":if(!this.contentRef.current)return;e.fullscreen?function(e){const t=e.requestFullscreen||e.webkitRequestFullScreen||e.msRequestFullscreen;t&&t.call(e)}(this.contentRef.current):S()&&x()}}),o()(this,"onCallState",e=>{this.setState({callState:e})}),o()(this,"onCallLocalHoldUnhold",()=>{this.setState({isLocalOnHold:this.props.call.isLocalOnHold()})}),o()(this,"onCallRemoteHoldUnhold",()=>{this.setState({isRemoteOnHold:this.props.call.isRemoteOnHold(),isLocalOnHold:this.props.call.isLocalOnHold()})}),o()(this,"onFullscreenClick",()=>{c.a.dispatch({action:"video_fullscreen",fullscreen:!0})}),o()(this,"onExpandClick",()=>{const e=d.b.roomIdForCall(this.props.call);c.a.dispatch({action:"view_room",room_id:e})}),o()(this,"onControlsHideTimer",()=>{this.controlsHideTimer=null,this.setState({controlsVisible:!1})}),o()(this,"onMouseMove",()=>{this.showControls()}),o()(this,"onDialpadClick",()=>{this.state.showDialpad?(null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3),this.setState({showDialpad:!1})):(this.controlsHideTimer&&(clearTimeout(this.controlsHideTimer),this.controlsHideTimer=null),this.setState({showDialpad:!0,controlsVisible:!0}))}),o()(this,"onMicMuteClick",()=>{const e=!this.state.micMuted;this.props.call.setMicrophoneMuted(e),this.setState({micMuted:e})}),o()(this,"onVidMuteClick",()=>{const e=!this.state.vidMuted;this.props.call.setLocalVideoMuted(e),this.setState({vidMuted:e})}),o()(this,"onMoreClick",()=>{this.controlsHideTimer&&(clearTimeout(this.controlsHideTimer),this.controlsHideTimer=null),this.setState({showMoreMenu:!0,controlsVisible:!0})}),o()(this,"closeDialpad",()=>{this.setState({showDialpad:!1}),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3)}),o()(this,"closeContextMenu",()=>{this.setState({showMoreMenu:!1}),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3)}),o()(this,"onNativeKeyDown",e=>{let t=!1;const s=Object(_.d)(e);switch(e.key){case _.a.D:s&&(this.onMicMuteClick(),this.showControls(),t=!0);break;case _.a.E:s&&(this.onVidMuteClick(),this.showControls(),t=!0)}t&&(e.stopPropagation(),e.preventDefault())}),o()(this,"onRoomAvatarClick",()=>{const e=d.b.roomIdForCall(this.props.call);c.a.dispatch({action:"view_room",room_id:e})}),o()(this,"onSecondaryRoomAvatarClick",()=>{const e=d.b.roomIdForCall(this.props.secondaryCall);c.a.dispatch({action:"view_room",room_id:e})}),o()(this,"onCallResumeClick",()=>{const e=d.b.roomIdForCall(this.props.call);d.b.sharedInstance().setActiveCallRoomId(e)}),this.state={isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state,controlsVisible:!0,showMoreMenu:!1,showDialpad:!1},this.updateCallListeners(null,this.props.call)}componentDidMount(){this.dispatcherRef=c.a.register(this.onAction),document.addEventListener("keydown",this.onNativeKeyDown)}componentWillUnmount(){S()&&x(),document.removeEventListener("keydown",this.onNativeKeyDown),this.updateCallListeners(this.props.call,null),c.a.unregister(this.dispatcherRef)}componentDidUpdate(e){this.props.call!==e.call&&(this.setState({isLocalOnHold:this.props.call.isLocalOnHold(),isRemoteOnHold:this.props.call.isRemoteOnHold(),micMuted:this.props.call.isMicrophoneMuted(),vidMuted:this.props.call.isLocalVideoMuted(),callState:this.props.call.state}),this.updateCallListeners(null,this.props.call))}updateCallListeners(e,t){e!==t&&(e&&(e.removeListener(g.c.State,this.onCallState),e.removeListener(g.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),e.removeListener(g.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold)),t&&(t.on(g.c.State,this.onCallState),t.on(g.c.LocalHoldUnhold,this.onCallLocalHoldUnhold),t.on(g.c.RemoteHoldUnhold,this.onCallRemoteHoldUnhold)))}showControls(){this.state.showMoreMenu||this.state.showDialpad||(this.state.controlsVisible||this.setState({controlsVisible:!0}),null!==this.controlsHideTimer&&clearTimeout(this.controlsHideTimer),this.controlsHideTimer=window.setTimeout(this.onControlsHideTimer,1e3))}render(){const e=m.a.get(),t=d.b.roomIdForCall(this.props.call),s=d.b.roomIdForCall(this.props.secondaryCall),n=e.getRoom(t),i=this.props.secondaryCall?e.getRoom(s):null;let o,r;this.state.showDialpad&&(o=l.a.createElement(w.a,a()({},Object(y.m)(this.dialpadButton.current.getBoundingClientRect(),y.a.None,8),{onFinished:this.closeDialpad,call:this.props.call}))),this.state.showMoreMenu&&(r=l.a.createElement(E.a,a()({},Object(y.l)(this.contextMenuButton.current.getBoundingClientRect(),y.a.None,8),{onFinished:this.closeContextMenu,call:this.props.call})));const f=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_micOn:!this.state.micMuted,mx_CallView_callControls_button_micOff:this.state.micMuted}),_=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_vidOn:!this.state.vidMuted,mx_CallView_callControls_button_vidOff:this.state.vidMuted}),x=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_micOn:this.state.micMuted,mx_CallView_callControls_button_micOff:!this.state.micMuted,mx_CallView_callControls_button_invisible:!0}),R=b()({mx_CallView_callControls_button:!0,mx_CallView_callControls_button_vidOn:this.state.micMuted,mx_CallView_callControls_button_vidOff:!this.state.micMuted,mx_CallView_callControls_button_invisible:!0}),O=b()({mx_CallView_callControls:!0,mx_CallView_callControls_hidden:!this.state.controlsVisible}),k=this.props.call.type===g.f.Video?l.a.createElement(v.a,{className:_,onClick:this.onVidMuteClick}):null,I=this.state.callState===g.e.Connected?l.a.createElement(y.c,{className:"mx_CallView_callControls_button mx_CallView_callControls_dialpad",inputRef:this.dialpadButton,onClick:this.onDialpadClick,isExpanded:this.state.showDialpad}):l.a.createElement("div",{className:"mx_CallView_callControls_button mx_CallView_callControls_button_dialpad_hidden"}),T=this.state.callState===g.e.Connected?l.a.createElement(y.c,{className:"mx_CallView_callControls_button mx_CallView_callControls_button_more",onClick:this.onMoreClick,inputRef:this.contextMenuButton,isExpanded:this.state.showMoreMenu}):l.a.createElement("div",{className:"mx_CallView_callControls_button mx_CallView_callControls_button_more_hidden"}),j=l.a.createElement("div",{className:O},I,l.a.createElement(v.a,{className:f,onClick:this.onMicMuteClick}),l.a.createElement(v.a,{className:"mx_CallView_callControls_button mx_CallView_callControls_button_hangup",onClick:()=>{c.a.dispatch({action:"hangup",room_id:t})}}),k,l.a.createElement("div",{className:x}),l.a.createElement("div",{className:R}),T);let N;const P=this.state.isLocalOnHold||this.state.isRemoteOnHold;let D=null;if(this.state.isRemoteOnHold){const e=d.b.sharedInstance().hasAnyUnheldCall()?Object(h.b)("You held the call <a>Switch</a>"):Object(h.b)("You held the call <a>Resume</a>");D=Object(h.a)(e,{},{a:e=>l.a.createElement(v.a,{kind:"link",onClick:this.onCallResumeClick},e)})}else this.state.isLocalOnHold&&(D=Object(h.a)("%(peerName)s held the call",{peerName:this.props.call.getOpponentMember().name}));if(this.props.call.type===g.f.Video){let e=null,t=null,s=null;const n={},a=b()({mx_CallView_video:!0,mx_CallView_video_hold:P});if(P){t=l.a.createElement("div",{className:"mx_CallView_video_holdContent"},D);const e=Object(C.a)(this.props.call.getOpponentMember(),1024,1024,"crop");n.backgroundImage="url("+e+")",s=l.a.createElement("div",{className:"mx_CallView_video_holdBackground",style:n})}this.state.vidMuted||(e=l.a.createElement(u.b,{type:u.a.Local,call:this.props.call}));const i=S()?null:this.props.maxVideoHeight-64;N=l.a.createElement("div",{className:a,ref:this.contentRef,onMouseMove:this.onMouseMove,style:{maxHeight:i}},s,l.a.createElement(u.b,{type:u.a.Remote,call:this.props.call,onResize:this.props.onResize,maxHeight:i}),e,t,j)}else{const e=this.props.pipMode?76:160,t=b()({mx_CallView_voice:!0,mx_CallView_voice_hold:P});N=l.a.createElement("div",{className:t,onMouseMove:this.onMouseMove},l.a.createElement("div",{className:"mx_CallView_voice_avatarsContainer"},l.a.createElement("div",{className:"mx_CallView_voice_avatarContainer",style:{width:e,height:e}},l.a.createElement(p.a,{room:n,height:e,width:e}))),l.a.createElement("div",{className:"mx_CallView_voice_holdText"},D),j)}const A=this.props.call.type===g.f.Video?Object(h.a)("Video Call"):Object(h.a)("Voice Call");let U,M,L;this.props.call.type!==g.f.Video||this.props.pipMode||(M=l.a.createElement("div",{className:"mx_CallView_header_button mx_CallView_header_button_fullscreen",onClick:this.onFullscreenClick,title:Object(h.a)("Fill Screen")})),this.props.pipMode&&(L=l.a.createElement("div",{className:"mx_CallView_header_button mx_CallView_header_button_expand",onClick:this.onExpandClick,title:Object(h.a)("Return to call")}));const F=l.a.createElement("div",{className:"mx_CallView_header_controls"},M,L);let B;if(this.props.pipMode){let e;this.props.secondaryCall&&(e=l.a.createElement("span",{className:"mx_CallView_header_secondaryCallInfo"},l.a.createElement(v.a,{element:"span",onClick:this.onSecondaryRoomAvatarClick},l.a.createElement(p.a,{room:i,height:16,width:16}),l.a.createElement("span",{className:"mx_CallView_secondaryCall_roomName"},Object(h.a)("%(name)s on hold",{name:i.name}))))),B=l.a.createElement("div",{className:"mx_CallView_header"},l.a.createElement(v.a,{onClick:this.onRoomAvatarClick},l.a.createElement(p.a,{room:n,height:32,width:32})),l.a.createElement("div",{className:"mx_CallView_header_callInfo"},l.a.createElement("div",{className:"mx_CallView_header_roomName"},n.name),l.a.createElement("div",{className:"mx_CallView_header_callTypeSmall"},A,e)),F),U="mx_CallView_pip"}else B=l.a.createElement("div",{className:"mx_CallView_header"},l.a.createElement("div",{className:"mx_CallView_header_phoneIcon"}),l.a.createElement("span",{className:"mx_CallView_header_callType"},A),F),U="mx_CallView_large";return l.a.createElement("div",{className:"mx_CallView "+U},B,N,o,r)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),a=s.n(n),i=s(81),o=s(91);const r=["1","2","3","4","5","6","7","8","9","*","0","#"];var l;!function(e){e[e.Digit=0]="Digit",e[e.Delete=1]="Delete",e[e.Dial=2]="Dial"}(l||(l={}));class c extends i.PureComponent{constructor(...e){super(...e),a()(this,"onClick",()=>{this.props.onButtonPress(this.props.digit)})}render(){switch(this.props.kind){case l.Digit:return i.createElement(o.a,{className:"mx_DialPad_button",onClick:this.onClick},this.props.digit);case l.Delete:return i.createElement(o.a,{className:"mx_DialPad_button mx_DialPad_deleteButton",onClick:this.onClick});case l.Dial:return i.createElement(o.a,{className:"mx_DialPad_button mx_DialPad_dialButton",onClick:this.onClick})}}}class d extends i.PureComponent{render(){const e=[];for(const t of r)e.push(i.createElement(c,{key:t,kind:l.Digit,digit:t,onButtonPress:this.props.onDigitPress}));return this.props.hasDialAndDelete&&(e.push(i.createElement(c,{key:"del",kind:l.Delete,onButtonPress:this.props.onDeletePress})),e.push(i.createElement(c,{key:"dial",kind:l.Dial,onButtonPress:this.props.onDialPress}))),i.createElement("div",{className:"mx_DialPad"},e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(344);class l extends o.a.Component{constructor(...e){super(...e),a()(this,"_onResizeStart",()=>{this.props.resizeNotifier.startResizing()}),a()(this,"_onResize",()=>{this.props.resizeNotifier.notifyRightHandleResized()}),a()(this,"_onResizeStop",(e,t,s,n)=>{this.props.resizeNotifier.stopResizing(),window.localStorage.setItem("mx_rhs_size",this._loadSidePanelSize().width+n.width)})}_loadSidePanelSize(){let e=parseInt(window.localStorage.getItem("mx_rhs_size"),10);return isNaN(e)&&(e=350),{height:"100%",width:e}}render(){const e=o.a.Children.only(this.props.children),t=this.props.panel;let s;return!this.props.collapsedRhs&&t&&(s=o.a.createElement(r.Resizable,{defaultSize:this._loadSidePanelSize(),minWidth:264,maxWidth:"50%",enable:{top:!1,right:!1,bottom:!1,left:!0,topRight:!1,bottomRight:!1,bottomLeft:!1,topLeft:!1},onResizeStart:this._onResizeStart,onResize:this._onResize,onResizeStop:this._onResizeStop,className:"mx_RightPanel_ResizeWrapper",handleClasses:{left:"mx_RightPanel_ResizeHandle"}},t)),o.a.createElement("div",{className:"mx_MainSplit"},e,s)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return w}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(259),d=s(85),m=s(87),h=s(254),u=s(355),p=s(114),g=s(123),f=s(294),b=s(97),v=s(94),_=s(491),y=s(698);function E(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function C(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?E(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):E(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class w extends o.a.Component{static get propTypes(){return{room:l.a.instanceOf(c.b),groupId:l.a.string,user:l.a.object}}constructor(e,t){super(e,t),a()(this,"onClose",()=>{this.props.user?m.a.dispatch({action:"view_home_page"}):this.state.phase===g.b.EncryptionPanel&&this.state.verificationRequest&&this.state.verificationRequest.pending?this.state.verificationRequest.cancel():m.a.dispatch({action:v.a.ToggleRightPanel,type:this.props.groupId?"group":"room"})}),this.state=C(C({},f.a.getSharedInstance().roomPanelPhaseParams),{},{phase:this._getPhaseFromProps(),isUserPrivilegedInGroup:null,member:this._getUserForPanel()}),this.onAction=this.onAction.bind(this),this.onRoomStateMember=this.onRoomStateMember.bind(this),this.onGroupStoreUpdated=this.onGroupStoreUpdated.bind(this),this.onInviteToGroupButtonClick=this.onInviteToGroupButtonClick.bind(this),this.onAddRoomToGroupButtonClick=this.onAddRoomToGroupButtonClick.bind(this),this._delayedUpdate=new h.a(()=>{this.forceUpdate()},500)}_getUserForPanel(){if(this.state&&this.state.member)return this.state.member;const e=f.a.getSharedInstance().roomPanelPhaseParams;return this.props.user||e.member}_getPhaseFromProps(){const e=f.a.getSharedInstance(),t=this._getUserForPanel();return this.props.groupId?g.a.includes(e.groupPanelPhase)?e.groupPanelPhase:(m.a.dispatch({action:v.a.SetRightPanelPhase,phase:g.b.GroupMemberList}),g.b.GroupMemberList):t?e.roomPanelPhaseParams.member&&t.userId===e.roomPanelPhaseParams.member.userId&&e.roomPanelPhaseParams.verificationRequest?e.roomPanelPhase:g.b.RoomMemberInfo:e.roomPanelPhase}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction);this.context.on("RoomState.members",this.onRoomStateMember),this._initGroupStore(this.props.groupId)}componentWillUnmount(){m.a.unregister(this.dispatcherRef),this.context&&this.context.removeListener("RoomState.members",this.onRoomStateMember),this._unregisterGroupStore(this.props.groupId)}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this._unregisterGroupStore(this.props.groupId),this._initGroupStore(e.groupId))}_initGroupStore(e){e&&p.a.registerListener(e,this.onGroupStoreUpdated)}_unregisterGroupStore(){p.a.unregisterListener(this.onGroupStoreUpdated)}onGroupStoreUpdated(){this.setState({isUserPrivilegedInGroup:p.a.isUserPrivileged(this.props.groupId)})}onInviteToGroupButtonClick(){Object(u.b)(this.props.groupId).then(()=>{this.setState({phase:g.b.GroupMemberList})})}onAddRoomToGroupButtonClick(){Object(u.a)(this.props.groupId).then(()=>{this.forceUpdate()})}onRoomStateMember(e,t,s){this.props.room&&s.roomId===this.props.room.roomId&&(this.state.phase===g.b.RoomMemberList&&s.roomId===this.props.room.roomId||this.state.phase===g.b.RoomMemberInfo&&s.roomId===this.props.room.roomId&&s.userId===this.state.member.userId)&&this._delayedUpdate()}onAction(e){e.action===v.a.AfterRightPanelPhaseChange&&this.setState({phase:e.phase,groupRoomId:e.groupRoomId,groupId:e.groupId,member:e.member,event:e.event,verificationRequest:e.verificationRequest,verificationRequestPromise:e.verificationRequestPromise,widgetId:e.widgetId})}render(){const e=d.getComponent("rooms.MemberList"),t=d.getComponent("right_panel.UserInfo"),s=d.getComponent("rooms.ThirdPartyMemberInfo"),n=d.getComponent("structures.NotificationPanel"),a=d.getComponent("structures.FilePanel"),i=d.getComponent("groups.GroupMemberList"),r=d.getComponent("groups.GroupRoomList"),l=d.getComponent("groups.GroupRoomInfo");let c=o.a.createElement("div",null);const m=this.props.room?this.props.room.roomId:void 0;switch(this.state.phase){case g.b.RoomMemberList:m&&(c=o.a.createElement(e,{roomId:m,key:m,onClose:this.onClose}));break;case g.b.GroupMemberList:this.props.groupId&&(c=o.a.createElement(i,{groupId:this.props.groupId,key:this.props.groupId}));break;case g.b.GroupRoomList:c=o.a.createElement(r,{groupId:this.props.groupId,key:this.props.groupId});break;case g.b.RoomMemberInfo:case g.b.EncryptionPanel:c=o.a.createElement(t,{user:this.state.member,room:this.props.room,key:m||this.state.member.userId,onClose:this.onClose,phase:this.state.phase,verificationRequest:this.state.verificationRequest,verificationRequestPromise:this.state.verificationRequestPromise});break;case g.b.Room3pidMemberInfo:c=o.a.createElement(s,{event:this.state.event,key:m});break;case g.b.GroupMemberInfo:c=o.a.createElement(t,{user:this.state.member,groupId:this.props.groupId,key:this.state.member.userId,onClose:this.onClose});break;case g.b.GroupRoomInfo:c=o.a.createElement(l,{groupRoomId:this.state.groupRoomId,groupId:this.props.groupId,key:this.state.groupRoomId});break;case g.b.NotificationPanel:c=o.a.createElement(n,{onClose:this.onClose});break;case g.b.FilePanel:c=o.a.createElement(a,{roomId:m,resizeNotifier:this.props.resizeNotifier,onClose:this.onClose});break;case g.b.RoomSummary:c=o.a.createElement(_.a,{room:this.props.room,onClose:this.onClose});break;case g.b.Widget:c=o.a.createElement(y.a,{room:this.props.room,widgetId:this.state.widgetId,onClose:this.onClose})}return o.a.createElement("aside",{className:"mx_RightPanel dark-panel",id:"mx_RightPanel"},c)}}a()(w,"contextType",b.a)},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s(1181),c=s(90),d=s.n(c),m=s(83),h=s(117);function u(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function p(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?u(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):u(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const g={errorCorrectionLevel:"L"};t.a=e=>{let{data:t,className:s}=e,n=o()(e,["data","className"]);const[a,i]=r.useState(null);return r.useEffect(()=>{let e=!1;return Object(l.toDataURL)(t,p(p({},g),n)).then(t=>{e||i(t)}),()=>{e=!0}},[JSON.stringify(t),n]),r.createElement("div",{className:d()("mx_QRCode",s)},a?r.createElement("img",{src:a,className:"mx_VerificationQRCode",alt:Object(m.a)("QR Code")}):r.createElement(h.a,null))}},,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return c}));var n=s(214),a=s(83),i=s(92),o=s(81),r=s.n(o);let l;function c({isRoomEncrypted:e,kind:t}){if(!e)return null;if(n.a.get())return null;const{desktopBuilds:s,brand:o}=i.a.get();let c=null,d=null;if(s.available)switch(d=r.a.createElement("img",{src:s.logo}),t){case l.Files:c=Object(a.a)("Use the <a>Desktop app</a> to see all encrypted files",{},{a:e=>r.a.createElement("a",{href:s.url,target:"_blank",rel:"noreferrer noopener"},e)});break;case l.Search:c=Object(a.a)("Use the <a>Desktop app</a> to search encrypted messages",{},{a:e=>r.a.createElement("a",{href:s.url,target:"_blank",rel:"noreferrer noopener"},e)})}else switch(t){case l.Files:c=Object(a.a)("This version of %(brand)s does not support viewing some encrypted files",{brand:o});break;case l.Search:c=Object(a.a)("This version of %(brand)s does not support searching encrypted messages",{brand:o})}return c?r.a.createElement("div",{className:"mx_DesktopBuildsNotice"},d,r.a.createElement("span",null,c)):(console.warn("Unknown desktop builds warning kind: ",t),null)}!function(e){e[e.Files=0]="Files",e[e.Search=1]="Search"}(l||(l={}))},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(83),o=s(97),r=s(130),l=s(88);const c=a.a.forwardRef(({mxEvent:e},t)=>{const s=Object(n.useContext)(o.a);let c=Object(i.a)("Message deleted");const d=e.getUnsigned(),m=d&&d.redacted_because&&d.redacted_because.sender;if(m&&m!==e.getSender()){const t=s.getRoom(e.getRoomId()),n=t&&t.getMember(m);c=Object(i.a)("Message deleted by %(name)s",{name:n?n.name:m})}const h=l.a.getValue("showTwelveHourTimestamps"),u=Object(r.b)(new Date(d.redacted_because.origin_server_ts),h),p=Object(i.a)("Message deleted on %(date)s",{date:u});return a.a.createElement("span",{className:"mx_RedactedBody",ref:t,title:p},c)});t.a=c},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(81),a=s.n(n),i=s(90),o=s.n(i),r=s(116),l=s(115);class c extends a.a.Component{constructor(e){super(e),this.onClick=this.onClick.bind(this)}onClick(){r.a.trackEvent(...this.props.analytics),this.props.onClick()}render(){const e=o()({mx_RightPanel_headerButton:!0,mx_RightPanel_headerButton_highlight:this.props.isHighlighted,["mx_RightPanel_"+this.props.name]:!0});return a.a.createElement(l.a,{"aria-selected":this.props.isHighlighted,role:"tab",title:this.props.title,className:e,onClick:this.onClick})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return m}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(87),l=s(294),c=s(94);let d;!function(e){e.Room="room",e.Group="group"}(d||(d={}));class m extends o.a.Component{constructor(e,t){super(e),a()(this,"storeToken",void 0),a()(this,"dispatcherRef",void 0);const s=l.a.getSharedInstance();this.state={headerKind:t,phase:t===d.Room?s.visibleRoomPanelPhase:s.visibleGroupPanelPhase}}componentDidMount(){this.storeToken=l.a.getSharedInstance().addListener(this.onRightPanelUpdate.bind(this)),this.dispatcherRef=r.a.register(this.onAction.bind(this))}componentWillUnmount(){this.storeToken&&this.storeToken.remove(),this.dispatcherRef&&r.a.unregister(this.dispatcherRef)}setPhase(e,t){r.a.dispatch({action:c.a.SetRightPanelPhase,phase:e,refireParams:t})}isPhase(e){return Array.isArray(e)?e.includes(this.state.phase):e===this.state.phase}onRightPanelUpdate(){const e=l.a.getSharedInstance();this.state.headerKind===d.Room?this.setState({phase:e.visibleRoomPanelPhase}):this.state.headerKind===d.Group&&this.setState({phase:e.visibleGroupPanelPhase})}render(){return o.a.createElement("div",{className:"mx_HeaderButtons"},this.renderButtons())}}},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(85),l=s(87),c=s(90),d=s.n(c),m=s(95),h=s(84),u=s.n(h),p=s(86),g=s(148),f=s(110),b=s(97),v=s(94),_=s(98);class y extends o.a.Component{constructor(...e){super(...e),a()(this,"state",{resourceId:null,pillType:null,member:null,group:null,room:null}),a()(this,"onUserPillClicked",()=>{l.a.dispatch({action:v.a.ViewUser,member:this.state.member})})}static roomNotifPos(e){return e.indexOf("@room")}static roomNotifLen(){return"@room".length}async UNSAFE_componentWillReceiveProps(e){let t,s;if(e.url)if(e.inMessage){const n=Object(f.h)(e.url);t=n.primaryEntityId,s=n.sigil}else t=Object(f.b)(e.url),s=t?t[0]:void 0;const n=this.props.type||{"@":y.TYPE_USER_MENTION,"#":y.TYPE_ROOM_MENTION,"!":y.TYPE_ROOM_MENTION,"+":y.TYPE_GROUP_MENTION}[s];let a,i,o;switch(n){case y.TYPE_AT_ROOM_MENTION:o=e.room;break;case y.TYPE_USER_MENTION:{const s=e.room?e.room.getMember(t):void 0;a=s,s||(a=new m.l(null,t),this.doProfileLookup(t,a))}break;case y.TYPE_ROOM_MENTION:{const e="#"===t[0]?p.a.get().getRooms().find(e=>e.getCanonicalAlias()===t||e.getAltAliases().includes(t)):p.a.get().getRoom(t);o=e}break;case y.TYPE_GROUP_MENTION:{const e=p.a.get();try{i=await g.a.getGroupProfileCached(e,t)}catch(e){i={groupId:t,avatarUrl:null,name:null}}}}this.setState({resourceId:t,pillType:n,member:a,group:i,room:o})}componentDidMount(){this._unmounted=!1,this._matrixClient=p.a.get(),this.UNSAFE_componentWillReceiveProps(this.props)}componentWillUnmount(){this._unmounted=!0}doProfileLookup(e,t){p.a.get().getProfileInfo(e).then(e=>{this._unmounted||(t.name=e.displayname,t.rawDisplayName=e.displayname,t.events.member={getContent:()=>({avatar_url:e.avatar_url}),getDirectionalContent:function(){return this.getContent()}},this.setState({member:t}))}).catch(t=>{console.error("Could not retrieve profile data for "+e+":",t)})}render(){const e=r.getComponent("views.avatars.BaseAvatar"),t=r.getComponent("avatars.MemberAvatar"),s=r.getComponent("avatars.RoomAvatar"),n=this.state.resourceId;let a,i,l,c=null,m=n,h=this.props.url;switch(this.state.pillType){case y.TYPE_AT_ROOM_MENTION:{const e=this.props.room;e&&(m="@room",this.props.shouldShowPillAvatar&&(c=o.a.createElement(s,{room:e,width:16,height:16,"aria-hidden":"true"})),a="mx_AtRoomPill")}break;case y.TYPE_USER_MENTION:{const e=this.state.member;e&&(i=e.userId,e.rawDisplayName=e?e.rawDisplayName:"",m=e.rawDisplayName,this.props.shouldShowPillAvatar&&(c=o.a.createElement(t,{member:e,width:16,height:16,"aria-hidden":"true"})),a="mx_UserPill",h=null,l=this.onUserPillClicked)}break;case y.TYPE_ROOM_MENTION:{const e=this.state.room;e&&(m=_.a.computeLongRoomNameFromRoom(e),this.props.shouldShowPillAvatar&&(c=o.a.createElement(s,{room:e,width:16,height:16,"aria-hidden":"true"}))),a="mx_RoomPill"}break;case y.TYPE_GROUP_MENTION:if(this.state.group){const{avatarUrl:t,groupId:s,name:n}=this.state.group,i=p.a.get();m=s,this.props.shouldShowPillAvatar&&(c=o.a.createElement(e,{name:n||s,width:16,height:16,"aria-hidden":"true",url:t?i.mxcUrlToHttp(t,16,16):null})),a="mx_GroupPill"}}const u=d()("mx_Pill",a,{mx_UserPill_me:i===p.a.get().getUserId(),mx_UserPill_selected:this.props.isSelected});return this.state.pillType?o.a.createElement(b.a.Provider,{value:this._matrixClient},this.props.inMessage?o.a.createElement("a",{className:u,href:h,onClick:l,title:n,"data-offset-key":this.props.offsetKey},c,m):o.a.createElement("span",{className:u,title:n,"data-offset-key":this.props.offsetKey},c,m)):null}}a()(y,"TYPE_USER_MENTION","TYPE_USER_MENTION"),a()(y,"TYPE_ROOM_MENTION","TYPE_ROOM_MENTION"),a()(y,"TYPE_GROUP_MENTION","TYPE_GROUP_MENTION"),a()(y,"TYPE_AT_ROOM_MENTION","TYPE_AT_ROOM_MENTION"),a()(y,"propTypes",{type:u.a.string,url:u.a.string,inMessage:u.a.bool,room:u.a.instanceOf(m.k),shouldShowPillAvatar:u.a.bool,isSelected:u.a.bool}),t.a=y},function(e,t){e.exports="img/ellipsis.c2118e5.svg"},,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return k}));var n=s(81),a=s.n(n),i=s(90),o=s.n(i),r=s(97),l=s(692),c=s(218),d=s(83),m=s(199),h=s(91),u=s(87),p=s(94),g=s(123),f=s(89),b=s(356),v=s(146),_=(s(122),s(164),s(88),s(464),s(115),s(197)),y=s(227),E=(s(102),s(353),s(106));var C=s(173),w=s(86),S=s(109),x=s(98);const R=({children:e,className:t,onClick:s})=>a.a.createElement(h.a,{className:o()("mx_BaseCard_Button mx_RoomSummaryCard_Button",t),onClick:s},e);var O;!function(e){e.None="NONE",e.Encrypted="ENCRYPTED",e.Forum="FORUM"}(O||(O={}));const k=e=>{const[t,s]=Object(n.useState)(_.a.instance.getApps(e.roomId)),a=Object(n.useCallback)(()=>{s([..._.a.instance.getApps(e.roomId)])},[e]);return Object(n.useEffect)(a,[e,a]),Object(v.a)(_.a.instance,e.roomId,a),Object(v.a)(C.d.instance,C.d.emissionForRoom(e),a),t},I=()=>{u.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.b.RoomMemberList})},T=()=>{u.a.dispatch({action:p.a.SetRightPanelPhase,phase:g.b.FilePanel})},j=()=>{u.a.dispatch({action:"open_room_settings"})};t.a=({room:e,onClose:t})=>{const s=Object(n.useContext)(r.a),i=()=>{f.a.createTrackedDialog("share room dialog","",b.a,{target:e})},o=(Object(l.a)(s,e),Object(n.useContext)(y.a).e2eStatus,new S.a(w.a.get())),h=Boolean(o.getUserIdForRoomId(e.roomId)),u=x.a.isRoomNotice(e),p=x.a.isRoomForum(e.roomId),g=x.a.getJoinRules(e.roomId),_=x.a.getAccessRules(e.roomId);let C=54,O="mx_RoomSummaryCard_avatar";h||u||(O+=" tc_RoomSummaryCard_avatar_hexa","unrestricted"===_&&(O+=" tc_RoomSummaryCard_avatar_hexa_unrestricted",C=50));const k=a.a.createElement(a.a.Fragment,null,a.a.createElement("div",{className:O,role:"presentation"},a.a.createElement(m.a,{room:e,height:C,width:C,viewAvatarOnClick:!0})),a.a.createElement("h2",{title:e.name},e.name)),N=((e,t=250)=>{const[s,a]=Object(n.useState)(e.getJoinedMemberCount());return Object(v.a)(e.currentState,"RoomState.members",Object(E.throttle)(()=>{a(e.getJoinedMemberCount())},t,{leading:!0,trailing:!0})),s})(e);let P,D,A,U;if(h||(p||"public"===g)&&(P=a.a.createElement(R,{className:"mx_RoomSummaryCard_icon_share",onClick:i},Object(d.a)("Share room"))),!h&&!u){A=a.a.createElement(R,{className:"mx_RoomSummaryCard_icon_settings",onClick:j},Object(d.a)("Room settings"));const t=e.currentState.getStateEvents("m.room.topic","");t&&(D=a.a.createElement(c.a,{title:Object(d.a)("Room Topic"),className:"mx_RoomSummaryCard_aboutGroup"},a.a.createElement("div",{className:"tc_RoomSummaryCard_topic"},t.getContent().topic)))}return u||(U=a.a.createElement(R,{className:"mx_RoomSummaryCard_icon_files",onClick:T},Object(d.a)("Show files"))),a.a.createElement(c.b,{header:k,className:"mx_RoomSummaryCard",onClose:t},D,a.a.createElement(c.a,{title:Object(d.a)("About"),className:"mx_RoomSummaryCard_aboutGroup"},a.a.createElement(R,{className:"mx_RoomSummaryCard_icon_people",onClick:I},Object(d.a)("%(count)s people",{count:N})),U,P,A))}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(91);const d=e=>{let{label:t,isExpanded:s,children:n,onClick:i,onContextMenu:r}=e,d=o()(e,["label","isExpanded","children","onClick","onContextMenu"]);return l.a.createElement(c.a,a()({},d,{onClick:i,onContextMenu:r||i,title:t,"aria-label":t,"aria-haspopup":!0,"aria-expanded":s}),n)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(115);const d=e=>{let{isExpanded:t,children:s,onClick:n,onContextMenu:i}=e,r=o()(e,["isExpanded","children","onClick","onContextMenu"]);return l.a.createElement(c.a,a()({},r,{onClick:n,onContextMenu:i||n,"aria-haspopup":!0,"aria-expanded":t}),s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r);const c=e=>{let{children:t,label:s}=e,n=o()(e,["children","label"]);return l.a.createElement("div",a()({},n,{role:"group","aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(91);const d=e=>{let{children:t,label:s}=e,n=o()(e,["children","label"]);const i=n["aria-label"]||s;return l.a.createElement(c.a,a()({},n,{role:"menuitem",tabIndex:-1,"aria-label":i}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(91);const d=e=>{let{children:t,label:s,active:n,disabled:i}=e,r=o()(e,["children","label","active","disabled"]);return l.a.createElement(c.a,a()({},r,{role:"menuitemcheckbox","aria-checked":n,"aria-disabled":i,disabled:i,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(91);const d=e=>{let{children:t,label:s,active:n,disabled:i}=e,r=o()(e,["children","label","active","disabled"]);return l.a.createElement(c.a,a()({},r,{role:"menuitemradio","aria-checked":n,"aria-disabled":i,disabled:i,tabIndex:-1,"aria-label":s}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(99),d=s(145);const m=e=>{let{children:t,label:s,onChange:n,onClose:i}=e,r=o()(e,["children","label","onChange","onClose"]);return l.a.createElement(d.a,a()({},r,{role:"menuitemcheckbox",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==c.a.ENTER&&e.key!==c.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===c.a.ENTER&&i())},onKeyUp:e=>{e.key!==c.a.SPACE&&e.key!==c.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(93),a=s.n(n),i=s(101),o=s.n(i),r=s(81),l=s.n(r),c=s(99),d=s(225);const m=e=>{let{children:t,label:s,onChange:n,onClose:i}=e,r=o()(e,["children","label","onChange","onClose"]);return l.a.createElement(d.a,a()({},r,{role:"menuitemradio",tabIndex:-1,"aria-label":s,onChange:n,onKeyDown:e=>{e.key!==c.a.ENTER&&e.key!==c.a.SPACE||(e.stopPropagation(),e.preventDefault(),n(),e.key===c.a.ENTER&&i())},onKeyUp:e=>{e.key!==c.a.SPACE&&e.key!==c.a.ENTER||(e.stopPropagation(),e.preventDefault())}}),t)}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(504),a=s.n(n),i=s(86),o=s(368);const r={"image/jpeg":!0,"image/gif":!0,"image/png":!0,"video/mp4":!0,"video/webm":!0,"video/ogg":!0,"audio/mp4":!0,"audio/webm":!0,"audio/aac":!0,"audio/mpeg":!0,"audio/ogg":!0,"audio/wave":!0,"audio/wav":!0,"audio/x-wav":!0,"audio/x-pn-wav":!0,"audio/flac":!0,"audio/x-flac":!0};async function l(t){const s=i.a.get().baseUrl;let n,l;try{const e=await fetch(s+o.a.publicKeyUrl);n=(await e.json()).public_key}catch(e){console.warn("Unable to retrive the publicKey : "+e)}if(n){const s=new e.Olm.PkEncryption;s.set_recipient_key(n),l={encrypted_body:s.encrypt(JSON.stringify({file:t}))}}else l={file:t};return Promise.resolve(fetch(s+o.a.downloadEncryptedUrl,{headers:{"Content-Type":"application/json"},method:"POST",body:JSON.stringify(l)})).then((function(e){return e.arrayBuffer()})).then((function(e){return a.a.decryptAttachment(e,t)})).then((function(e){let s=t.mimetype?t.mimetype.split(";")[0].trim():"";return r[s]||(s="application/octet-stream"),new Blob([e],{type:s})}))}}).call(this,s(5))},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n),i=s(86),o=s(6);class r extends o.EventEmitter{constructor(e){super(),this.dispatcher=e,a()(this,"matrixClient",void 0),a()(this,"dispatcherRef",void 0),a()(this,"onAction",async e=>{if("MatrixActions.sync"===e.action){if("PREPARED"!==e.prevState||"PREPARED"===e.state)return;this.matrixClient!==e.matrixClient&&(this.matrixClient&&await this.onNotReady(),this.matrixClient=e.matrixClient,await this.onReady())}else"on_client_not_viable"!==e.action&&"on_logged_out"!==e.action||this.matrixClient&&(await this.onNotReady(),this.matrixClient=null)}),this.dispatcherRef=this.dispatcher.register(this.onAction),i.a.get()&&(this.matrixClient=i.a.get(),this.onReady())}get mxClient(){return this.matrixClient}useUnitTestClient(e){this.matrixClient=e}destroy(){this.dispatcher.unregister(this.dispatcherRef)}async onReady(){}async onNotReady(){}}},function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return i}));var n=s(81);const a=(e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setTimeout(()=>{s.current()},t);return()=>clearTimeout(e)},[t])},i=(e,t,s)=>{const[a,i]=Object(n.useState)(s);return((e,t)=>{const s=Object(n.useRef)();Object(n.useEffect)(()=>{s.current=e},[e]),Object(n.useEffect)(()=>{const e=setInterval(()=>{s.current()},t);return()=>clearInterval(e)},[t])})(()=>i(e=>e-1),t),0===a&&e(),a}},,,,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return a})),s.d(t,"a",(function(){return i}));const n=new Map;function a(e,t){n.set(e,t)}function i(e){return n.get(e)}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){var n=s(82),a=s.n(n),i=s(87),o=s(6),r=s.n(o),l=s(106),c=s(88),d=s(150),m=s(176),h=s(125),u=s(152);function p(e,t){const s=Math.min(e.length,t.length);let n;for(let a=0;a<s;++a)if(e.charAt(a)!==t.charAt(a)){n=e.substr(0,a);break}void 0===n&&(n=e.substr(0,s));const a=n.indexOf(" ");return-1!==a&&(n=n.substr(0,a+1)),n.length>=2?n:""}class g extends r.a{constructor(){super(),a()(this,"_onListsUpdated",()=>{const e=this._getUpdatedTags();this._state.tags&&!Object(u.c)(this._state.tags,e)||this._setState({tags:e})}),this._state={tags:{}},this._getUpdatedTags=Object(l.throttle)(this._getUpdatedTags,500,{leading:!0,trailing:!0}),d.b.instance.on(d.a,this._onListsUpdated),i.a.register(e=>this._onDispatch(e))}getTags(){return this._state.tags}_setState(e){this._state=Object.assign(this._state,e),this.emit("change")}addListener(e){return this.on("change",e),{remove:()=>{this.removeListener("change",e)}}}getSortedTags(){const e=Object.keys(this._state.tags).sort(),t=e.map((t,s)=>{const n=0===s,a=s===e.length-1,i=n?"":p(t,e[s-1]),o=a?"":p(t,e[s+1]);return i.length>o.length?i:o});return e.map((e,s)=>{const n=m.a.instance.getListState(e);let a;n.hasUnreadCount&&(a=n);const i=e.substr(t[s].length,1);return{name:e,avatarLetter:i,badgeNotifState:a,selected:this._state.tags[e]}})}_onDispatch(e){switch(e.action){case"select_custom_room_tag":{const t=this._state.tags;if(t.hasOwnProperty(e.tag)){const s={};s[e.tag]=!t[e.tag];const n=Object.assign({},t,s);this._setState({tags:n})}}break;case"on_client_not_viable":case"on_logged_out":this._state={tags:{}},d.b.instance.off(d.a,this._onListsUpdated)}}_getUpdatedTags(){if(!c.a.getValue("feature_custom_tags"))return{};const e=Object.keys(d.b.instance.orderedLists).filter(e=>Object(h.d)(e)).sort(),t=this._state&&this._state.tags;return e.reduce((e,s)=>(e[s]=t&&t[s]||!1,e),{})}}void 0===e.singletonCustomRoomTagStore&&(e.singletonCustomRoomTagStore=new g),t.a=e.singletonCustomRoomTagStore}).call(this,s(5))},function(e,t,s){"use strict";function n(e){return Object.keys(e).filter(t=>["string","number"].includes(typeof e[t])).map(t=>e[t])}function a(e,t){return n(e).includes(t)}s.d(t,"a",(function(){return n})),s.d(t,"b",(function(){return a}))},function(e,t,s){"use strict";function n(e,t){const s=t.getUserId();for(const t of Object.keys(e.getContent())){if(Object.keys(e.getContent()[t]["m.read"]||{}).includes(s))return!0}}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"b",(function(){return o})),s.d(t,"a",(function(){return r}));var n=s(86),a=s(269),i=s(208);function o(e){return(!e.sender||e.sender.userId!=n.a.get().credentials.userId)&&("m.room.member"!=e.getType()&&("m.room.third_party_invite"!=e.getType()&&("m.call.answer"!=e.getType()&&"m.call.hangup"!=e.getType()&&(("m.room.message"!=e.getType()||"m.notify"!=e.getContent().msgtype)&&("m.room.aliases"!=e.getType()&&"m.room.canonical_alias"!=e.getType()&&("m.room.server_acl"!=e.getType()&&Object(i.b)(e)))))))}function r(e){const t=n.a.get().credentials.userId,s=e.getEventReadUpTo(t);if(e.timeline.length&&e.timeline[e.timeline.length-1].sender&&e.timeline[e.timeline.length-1].sender.userId===t)return!1;for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getId()==s)return!1;if(!Object(a.a)(n)&&o(n))return!0}return!0}},,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i}));var n=s(406);const a="https://matrix.to";class i extends n.b{constructor(){super()}forEvent(e,t,s){return`${a}/#/${e}/${t}`}forRoom(e,t){return`${a}/#/${e}`}forUser(e){return`${a}/#/${e}`}forGroup(e){return`${a}/#/${e}`}forEntity(e){return`${a}/#/${e}`}isPermalinkHost(e){return"matrix.to"===e}encodeServerCandidates(e){return e&&0!==e.length?"?via="+e.map(e=>encodeURIComponent(e)).join("&via="):""}parsePermalink(e){if(!e||!e.startsWith(a))throw new Error("Does not appear to be a permalink");const t=e.substring((a+"/#/").length).split("/"),s=t[0];if("@"===s[0])return n.a.forUser(s);if("+"===s[0])return n.a.forGroup(s);if("#"===s[0]||"!"===s[0]){if(1===t.length){const[e,t=""]=s.split("?"),a=t.split(/&?via=/g).filter(e=>!!e);return n.a.forRoom(e,a)}const e=t.length>1?t.slice(1).join("/"):"",[a,i=""]=e.split("?"),o=i.split(/&?via=/g).filter(e=>!!e);return n.a.forEvent(s,a,o)}throw new Error("Unknown entity type in permalink")}}},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,,,,,,,,,function(e,t){e.exports="img/icon-email-pill-avatar.575ff20.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(131),l=s(83),c=s(104),d=s(91),m=s(86),h=s(120),u=s(92),p=s(336),g=s(168),f=s(133),b=s(154),v=s(145),_=s(89),y=s(140);class E extends o.a.PureComponent{constructor(e){super(e),a()(this,"onSubmit",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=[...this.state.emailTargets,...this.state.userTargets],t=await Object(b.a)(this.props.roomId,e),s=m.a.get().getRoom(this.props.roomId);Object(b.d)(t.states,s,t.inviter)?this.props.onFinished(!0):this.setState({busy:!1})}catch(e){this.setState({busy:!1}),console.error(e),_.a.createTrackedDialog("Failed to invite","",y.a,{title:Object(l.a)("Failed to invite"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}),a()(this,"onAddressChange",(e,t)=>{const s=Object(h.c)(this.state.emailTargets);t>=s.length?s.push(e.target.value):s[t]=e.target.value,this.setState({emailTargets:s})}),a()(this,"onAddressBlur",e=>{const t=Object(h.c)(this.state.emailTargets);e>=t.length||""===t[e].trim()&&(t.splice(e,1),this.setState({emailTargets:t}))}),a()(this,"onShowPeopleClick",()=>{this.setState({showPeople:!this.state.showPeople})}),a()(this,"setPersonToggle",(e,t)=>{const s=Object(h.c)(this.state.userTargets);t&&!s.includes(e.userId)?s.push(e.userId):!t&&s.includes(e.userId)&&s.splice(s.indexOf(e.userId),1),this.setState({userTargets:s})}),a()(this,"onShowMorePeople",()=>{this.setState({numPeople:this.state.numPeople+5})}),this.state={emailTargets:[],userTargets:[],showPeople:!1,people:this.buildSuggestions(),numPeople:5,busy:!1}}buildSuggestions(){const e=new Set([m.a.get().getUserId(),u.a.get().welcomeUserId]);if(this.props.roomId){const t=m.a.get().getRoom(this.props.roomId);if(!t)throw new Error("Room ID given to InviteDialog does not look like a room");t.getMembersWithMembership("invite").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("join").forEach(t=>e.add(t.userId)),t.getMembersWithMembership("ban").forEach(t=>e.add(t.userId))}return p.d.buildRecents(e)}renderPerson(e,t){return o.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_person",key:t},o.a.createElement(g.a,{url:Object(f.a)(m.a.get().getHomeserverUrl(),e.user.getMxcAvatarUrl(),36,36,"crop"),name:e.user.name,idName:e.user.userId,width:36,height:36}),o.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_personIdentifiers"},o.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personName"},e.user.name),o.a.createElement("span",{className:"mx_CommunityPrototypeInviteDialog_personId"},e.userId)),o.a.createElement(v.a,{onChange:t=>this.setPersonToggle(e,t.target.checked)}))}render(){const e=[];this.state.emailTargets.forEach((t,s)=>{e.push(o.a.createElement(c.a,{key:s,value:t,onChange:e=>this.onAddressChange(e,s),label:Object(l.a)("Email address"),placeholder:Object(l.a)("Email address"),onBlur:()=>this.onAddressBlur(s)}))}),e.push(o.a.createElement(c.a,{key:e.length,value:"",onChange:t=>this.onAddressChange(t,e.length),label:e.length>0?Object(l.a)("Add another email"):Object(l.a)("Email address"),placeholder:e.length>0?Object(l.a)("Add another email"):Object(l.a)("Email address")}));let t=null;const s=[];if(this.state.showPeople){const e=this.state.people.slice(0,this.state.numPeople);e.forEach((e,t)=>{s.push(this.renderPerson(e,t))}),e.length<this.state.people.length&&s.push(o.a.createElement(d.a,{onClick:this.onShowMorePeople,kind:"link",key:"more",className:"mx_CommunityPrototypeInviteDialog_morePeople"},Object(l.a)("Show more")))}this.state.people.length>0&&(t=o.a.createElement("div",{className:"mx_CommunityPrototypeInviteDialog_people"},o.a.createElement("span",null,Object(l.a)("People you know on %(brand)s",{brand:u.a.get().brand})),o.a.createElement(d.a,{onClick:this.onShowPeopleClick},this.state.showPeople?Object(l.a)("Hide"):Object(l.a)("Show"))));let n=Object(l.a)("Skip");const a=this.state.userTargets.length+this.state.emailTargets.length;return a>0&&(n=Object(l.a)("Send %(count)s invites",{count:a})),o.a.createElement(r.a,{className:"mx_CommunityPrototypeInviteDialog",onFinished:this.props.onFinished,title:Object(l.a)("Invite people to join %(communityName)s",{communityName:this.props.communityName})},o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},e,t,s,o.a.createElement(d.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy,className:"mx_CommunityPrototypeInviteDialog_primaryButton"},n))))}}},,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(83),m=s(87),h=s(99);class u extends o.a.Component{constructor(e){super(e),a()(this,"onKeyDown",e=>{e.key===h.a.ESCAPE&&(e.stopPropagation(),e.preventDefault(),this.props.onFinished())}),a()(this,"onAction",e=>{"close_scalar"===e.action&&this.props.onFinished()}),a()(this,"onError",()=>{this.setState({errored:!0})}),this.state={errored:!1}}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction),document.addEventListener("keydown",this.onKeyDown)}componentWillUnmount(){m.a.unregister(this.dispatcherRef),document.removeEventListener("keydown",this.onKeyDown)}render(){if(this.props.loading){const e=c.getComponent("elements.Spinner");return o.a.createElement("div",{className:"mx_IntegrationManager_loading"},o.a.createElement("h3",null,Object(d.a)("Connecting to integration manager...")),o.a.createElement(e,null))}return!this.props.connected||this.state.errored?o.a.createElement("div",{className:"mx_IntegrationManager_error"},o.a.createElement("h3",null,Object(d.a)("Cannot connect to integration manager")),o.a.createElement("p",null,Object(d.a)("The integration manager is offline or it cannot reach your homeserver."))):o.a.createElement("iframe",{src:this.props.url,onError:this.onError})}}a()(u,"propTypes",{connected:l.a.bool.isRequired,loading:l.a.bool.isRequired,url:l.a.string,onFinished:l.a.func.isRequired}),a()(u,"defaultProps",{connected:!0,loading:!1})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(92),m=s(85);class h extends o.a.Component{constructor(...e){super(...e),a()(this,"_onAcknowledgeClick",()=>{this.props.onFinished()})}render(){const e=d.a.get().brand,t=m.getComponent("views.dialogs.BaseDialog"),s=m.getComponent("views.elements.DialogButtons");return o.a.createElement(t,{className:"mx_IntegrationsImpossibleDialog",hasCancel:!1,onFinished:this.props.onFinished,title:Object(c.a)("Integrations not allowed")},o.a.createElement("div",{className:"mx_IntegrationsImpossibleDialog_content"},o.a.createElement("p",null,Object(c.a)("Your %(brand)s doesn't allow you to use an Integration Manager to do this. Please contact an admin.",{brand:e}))),o.a.createElement(s,{primaryButton:Object(c.a)("OK"),onPrimaryButtonClick:this._onAcknowledgeClick,hasCancel:!1}))}}a()(h,"propTypes",{onFinished:l.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(164),d=s(95),m=s(85),h=s(285),u=s(90),p=s.n(u),g=s(629);class f extends o.a.Component{constructor(e){super(e),a()(this,"openManager",async(e,t=!1)=>{if(e===this.state.currentIndex&&!t)return;const s=this.state.managers[e],n=s.getScalarClient();this.setState({busy:!0,currentIndex:e,currentLoading:!0,currentConnected:!1,currentScalarClient:n}),g.a(s.uiUrl),n.setTermsInteractionCallback((e,t)=>Object(h.c)(e,t,"mx_TermsDialog_forIntegrationManager"));try{await n.connect(),n.hasCredentials()?this.setState({busy:!1,currentLoading:!1,currentConnected:!0}):this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}catch(e){if(e instanceof h.b)return;console.error(e),this.setState({busy:!1,currentLoading:!1,currentConnected:!1})}}),this.state={managers:c.a.sharedInstance().getOrderedManagers(),busy:!0,currentIndex:0,currentConnected:!1,currentLoading:!0,currentScalarClient:null}}componentDidMount(){this.openManager(0,!0)}_renderTabs(){const e=m.getComponent("views.elements.AccessibleButton");return this.state.managers.map((t,s)=>{const n=p()({mx_TabbedIntegrationManagerDialog_tab:!0,mx_TabbedIntegrationManagerDialog_currentTab:this.state.currentIndex===s});return o.a.createElement(e,{className:n,onClick:()=>this.openManager(s),key:"tab_"+s,disabled:this.state.busy},t.name)})}_renderTab(){const e=m.getComponent("views.settings.IntegrationManager");let t=null;return this.state.currentScalarClient&&(t=this.state.currentScalarClient.getScalarInterfaceUrlForRoom(this.props.room,this.props.screen,this.props.integrationId)),o.a.createElement(e,{configured:!0,loading:this.state.currentLoading,connected:this.state.currentConnected,url:t,onFinished:()=>{}})}render(){return o.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_container"},o.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_tabs"},this._renderTabs()),o.a.createElement("div",{className:"mx_TabbedIntegrationManagerDialog_currentManager"},this._renderTab()))}}a()(f,"propTypes",{onFinished:l.a.func.isRequired,room:l.a.instanceOf(d.k),screen:l.a.string,integrationId:l.a.string})},function(e,t,s){"use strict";s.d(t,"b",(function(){return y})),s.d(t,"c",(function(){return E})),s.d(t,"a",(function(){return C}));var n=s(86),a=s(95),i=s(87),o=s(122),r=s(128),l=s(83),c=s(164),d=s(132),m=s(152);function h(e,t){const s=Object(m.a)(e.data);s.response=t,e.source.postMessage(s,e.origin)}function u(e,t,s){console.error("Action:"+e.data.action+" failed with message: "+t);const n=Object(m.a)(e.data);n.response={error:{message:t}},s&&(n.response.error._error=s),e.source.postMessage(n,e.origin)}function p(e,t){const s=e.data.widget_id;let n=e.data.type;const a=e.data.url,r=e.data.name,c=e.data.data,m=e.data.userWidget;if(s&&void 0!==a){if(null!==a){if(void 0!==r&&"string"!=typeof r)return void u(e,Object(l.a)("Unable to create widget."),new Error("Optional field 'name' must be a string."));if(void 0!==c&&!(c instanceof Object))return void u(e,Object(l.a)("Unable to create widget."),new Error("Optional field 'data' must be an Object."));if("string"!=typeof n)return void u(e,Object(l.a)("Unable to create widget."),new Error("Field 'type' must be a string."));if("string"!=typeof a)return void u(e,Object(l.a)("Unable to create widget."),new Error("Field 'url' must be a string or null."))}n=d.a.fromString(n),m?o.a.setUserWidget(s,n,a,r,c).then(()=>{h(e,{success:!0}),i.a.dispatch({action:"user_widget_updated"})}).catch(t=>{u(e,Object(l.a)("Unable to create widget."),t)}):(t||u(e,Object(l.a)("Missing roomId."),null),o.a.setRoomWidget(t,s,n,a,r,c).then(()=>{h(e,{success:!0})},t=>{u(e,Object(l.a)("Failed to send request."),t)}))}else u(e,Object(l.a)("Unable to create widget."),new Error("Missing required widget fields."))}function g(e,t){const s=n.a.get();if(!s)return void u(e,Object(l.a)("You need to be logged in."));let a=[];if(t){const n=s.getRoom(t);if(!n)return void u(e,Object(l.a)("This room is not recognised."));a=o.a.getRoomWidgets(n).map(e=>e.event)}const i=o.a.getUserWidgetsArray();a=a.concat(i),h(e,a)}function f(e,t,s,a){const i=n.a.get();if(!i)return void u(e,Object(l.a)("You need to be logged in."));const o=i.getRoom(t);if(!o)return void u(e,Object(l.a)("This room is not recognised."));const r=o.currentState.getStateEvents(s,a);h(e,r?r.getContent():null)}const b=function(e){let t,s;e.origin||(e.origin=e.originalEvent.origin);try{_||(_=c.a.sharedInstance().getPrimaryManager().uiUrl),t=new URL(_)}catch(e){return}try{s=new URL(e.origin)}catch(e){return}if(t.origin!==s.origin||!e.data.action||e.data.api)return;if("close_scalar"===e.data.action)return i.a.dispatch({action:"close_scalar"}),void h(e,null);const o=e.data.room_id,d=e.data.user_id;if(!o)return"get_widgets"===e.data.action?void g(e,null):"set_widget"===e.data.action?void p(e,null):void u(e,Object(l.a)("Missing room_id in request"));if(o===r.a.getRoomId())if("get_widgets"!==e.data.action)if("set_widget"!==e.data.action)if("join_rules_state"!==e.data.action)if("set_plumbing_state"!==e.data.action)if("get_membership_count"!==e.data.action)if("get_room_enc_state"!==e.data.action)if("can_send_event"!==e.data.action)if(d)switch(e.data.action){case"membership_state":!function(e,t,s){console.log(`membership_state of ${s} in room ${t} requested.`),f(e,t,"m.room.member",s)}(e,o,d);break;case"invite":!function(e,t,s){console.log(`Received request to invite ${s} into room ${t}`);const a=n.a.get();if(!a)return void u(e,Object(l.a)("You need to be logged in."));const i=a.getRoom(t);if(i){const t=i.getMember(s);if(t&&"invite"===t.membership)return void h(e,{success:!0})}a.invite(t,s).then((function(){h(e,{success:!0})}),(function(t){u(e,Object(l.a)("You need to be able to invite users to do that."),t)}))}(e,o,d);break;case"bot_options":!function(e,t,s){console.log(`bot_options of ${s} in room ${t} requested.`),f(e,t,"m.room.bot.options","_"+s)}(e,o,d);break;case"set_bot_options":!function(e,t,s){console.log(`Received request to set options for bot ${s} in room ${t}`);const a=n.a.get();a?a.sendStateEvent(t,"m.room.bot.options",e.data.content,"_"+s).then(()=>{h(e,{success:!0})},t=>{u(e,t.message?t.message:Object(l.a)("Failed to send request."),t)}):u(e,Object(l.a)("You need to be logged in."))}(e,o,d);break;case"set_bot_power":!function(e,t,s,i){if(!(Number.isInteger(i)&&i>=0))return void u(e,Object(l.a)("Power level must be positive integer."));console.log(`Received request to set power level to ${i} for bot ${s} in room ${t}.`);const o=n.a.get();o?o.getStateEvent(t,"m.room.power_levels","").then(n=>{const r=new a.j({type:"m.room.power_levels",content:n});o.setPowerLevel(t,s,i,r).then(()=>{h(e,{success:!0})},t=>{u(e,t.message?t.message:Object(l.a)("Failed to send request."),t)})}):u(e,Object(l.a)("You need to be logged in."))}(e,o,d,e.data.level);break;default:console.warn("Unhandled postMessage event with action '"+e.data.action+"'")}else u(e,Object(l.a)("Missing user_id in request"));else!function(e,t){const s=""+e.data.event_type,a=Boolean(e.data.is_state),i=n.a.get();if(!i)return void u(e,Object(l.a)("You need to be logged in."));const o=i.getRoom(t);if(!o)return void u(e,Object(l.a)("This room is not recognised."));if("join"!==o.getMyMembership())return void u(e,Object(l.a)("You are not in this room."));const r=i.credentials.userId;let c=!1;c=a?o.currentState.maySendStateEvent(s,r):o.currentState.maySendEvent(s,r),c?h(e,!0):u(e,Object(l.a)("You do not have permission to do that in this room."))}(e,o);else!function(e,t){const s=n.a.get();if(!s)return void u(e,Object(l.a)("You need to be logged in."));if(!s.getRoom(t))return void u(e,Object(l.a)("This room is not recognised."));h(e,n.a.get().isRoomEncrypted(t))}(e,o);else!function(e,t){const s=n.a.get();if(!s)return void u(e,Object(l.a)("You need to be logged in."));const a=s.getRoom(t);if(!a)return void u(e,Object(l.a)("This room is not recognised."));h(e,a.getJoinedMemberCount())}(e,o);else!function(e,t,s){if("string"!=typeof s)throw new Error("Plumbing state status should be a string");console.log(`Received request to set plumbing state to status "${s}" in room ${t}`);const a=n.a.get();a?a.sendStateEvent(t,"m.room.plumbing",{status:s}).then(()=>{h(e,{success:!0})},t=>{u(e,t.message?t.message:Object(l.a)("Failed to send request."),t)}):u(e,Object(l.a)("You need to be logged in."))}(e,o,e.data.status);else!function(e,t){console.log(`join_rules of ${t} requested.`),f(e,t,"m.room.join_rules","")}(e,o);else p(e,o);else g(e,o);else u(e,Object(l.a)("Room %(roomId)s not visible",{roomId:o}))};let v=0,_=null;function y(){0===v&&window.addEventListener("message",b,!1),v+=1}function E(){if(v-=1,0===v&&window.removeEventListener("message",b),v<0){const e=new Error("ScalarMessaging: mismatched startListening / stopListening detected. Negative count");console.error(e)}}function C(e){_=e}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(85),m=s(87),h=s(94);class u extends o.a.Component{constructor(...e){super(...e),a()(this,"_onAcknowledgeClick",()=>{this.props.onFinished()}),a()(this,"_onOpenSettingsClick",()=>{this.props.onFinished(),m.a.fire(h.a.ViewUserSettings)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_IntegrationsDisabledDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Integrations are disabled")},o.a.createElement("div",{className:"mx_IntegrationsDisabledDialog_content"},o.a.createElement("p",null,Object(c.a)("Enable 'Manage Integrations' in Settings to do this."))),o.a.createElement(t,{primaryButton:Object(c.a)("Settings"),onPrimaryButtonClick:this._onOpenSettingsClick,cancelButton:Object(c.a)("OK"),onCancel:this._onAcknowledgeClick}))}}a()(u,"propTypes",{onFinished:l.a.func.isRequired})},,,,,,,,function(e,t,s){"use strict";function n(e,t){return Number.isFinite(e)?Number(e):t}function a(e,t,s){return Math.min(Math.max(e,t),s)}function i(...e){return[...e].reduce((e,t)=>t+e,0)}function o(e,t,s){return e*(s-t)+t}function r(e,t,s){return(e-t)/(s-t)}s.d(t,"b",(function(){return n})),s.d(t,"a",(function(){return a})),s.d(t,"e",(function(){return i})),s.d(t,"d",(function(){return o})),s.d(t,"c",(function(){return r}))},function(e,t,s){"use strict";s.d(t,"d",(function(){return r})),s.d(t,"a",(function(){return d})),s.d(t,"c",(function(){return m})),s.d(t,"b",(function(){return h}));var n=s(151),a=s(86),i=s(109),o=s(92);function r(){return void 0!==o.a.get().voip_mxid_translate_pattern}function l(e,t){if(void 0===t&&(t=o.a.get().voip_mxid_translate_pattern),!t)return null;const s=t.replace("${mxid}","(.+)"),n=e.match("^"+s+"$");return n?decodeURIComponent(n[1].replace(/=/g,"%")):null}async function c(e){const t=function(e,t){return void 0===t&&(t=o.a.get().voip_mxid_translate_pattern),t?t.replace("${mxid}",encodeURIComponent(e).replace(/%/g,"=").toLowerCase()):null}(e);return t?await Object(n.c)(a.a.get(),t):null}async function d(e){const t=i.a.shared().getUserIdForRoomId(e);return t?c(t):null}function m(e){const t=i.a.shared().getUserIdForRoomId(e);if(!t)return null;const s=l(t),o=Object(n.d)(a.a.get(),s);return o?o.roomId:null}function h(e){const t=i.a.shared().getUserIdForRoomId(e);if(!t)return null;const s=l(t);return Boolean(s)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return c}));var n=s(82),a=s.n(n),i=s(314),o=s(6),r=s(1),l=s(106);class c extends o.EventEmitter{constructor(){super(),a()(this,"_search",""),a()(this,"callUpdate",Object(l.throttle)(()=>{this.emit(i.a)},200,{trailing:!0,leading:!0}))}get relativePriority(){return i.b.Highest}get search(){return this._search}set search(e){this._search=e,this.callUpdate()}isVisible(e){const t=this.search.toLowerCase();if("#"===this.search[0]){if(e.getCanonicalAlias()&&e.getCanonicalAlias().toLowerCase().startsWith(t))return!0;if(e.getAltAliases().some(e=>e.toLowerCase().startsWith(t)))return!0}return!!e.name&&this.matches(e.name)}matches(e){const t=Object(r.B)(this.search.toLowerCase()).toLowerCase();return Object(r.B)(e.toLowerCase()).toLowerCase().includes(t)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return V}));var n,a=s(93),i=s.n(a),o=s(82),r=s.n(o),l=s(81),c=s.n(l),d=s(90),m=s.n(d),h=s(177),u=s(91),p=s(87),g=s(99),f=s(642),b=s(83),v=s(102),_=s(125),y=s(1498),E=s(365),C=s(304),w=s(86),S=s(287),x=s(150),R=s(643),O=s(176),k=s(246),I=s(115),T=s(1129),j=s(645),N=s(646),P=s(205),D=s(157),A=s(109),U=s(98),M=s(174);!function(e){e.None="NONE",e.Encrypted="ENCRYPTED",e.Forum="FORUM",e.Unrestricted="UNRESTRICTED"}(n||(n={}));const L=e=>{switch(e){case n.Forum:return Object(b.a)("Forum room");case n.Encrypted:return Object(b.a)("Private room");case n.Unrestricted:return Object(b.a)("Private room opened to externals")}},F=e=>"mx_RoomTile_messagePreview_"+e,B=e=>({left:e.left+window.pageXOffset-9,top:e.bottom+window.pageYOffset+17,chevronFace:v.a.None});class V extends c.a.PureComponent{constructor(t){super(t),r()(this,"dispatcherRef",void 0),r()(this,"roomTileRef",Object(l.createRef)()),r()(this,"notificationState",void 0),r()(this,"roomProps",void 0),r()(this,"onRoomNameUpdate",e=>{this.forceUpdate()}),r()(this,"onNotificationUpdate",()=>{this.forceUpdate()}),r()(this,"onRoomPropertyUpdate",e=>{e===j.a.NotificationVolume&&this.onNotificationUpdate()}),r()(this,"onAction",t=>{"view_room"===t.action&&t.room_id===this.props.room.roomId&&t.show_room_tile&&e(()=>{this.scrollIntoView()})}),r()(this,"onCommunityUpdate",e=>{e===this.props.room.roomId&&this.forceUpdate()}),r()(this,"onRoomPreviewChanged",e=>{this.props.room&&e.roomId===this.props.room.roomId&&this.setState({messagePreview:this.generatePreview()})}),r()(this,"scrollIntoView",()=>{this.roomTileRef.current&&this.roomTileRef.current.scrollIntoView({block:"nearest",behavior:"auto"})}),r()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"view_room",show_room_tile:!0,room_id:this.props.room.roomId,clear_search:e&&(e.key===g.a.ENTER||e.key===g.a.SPACE)})}),r()(this,"onActiveRoomUpdate",e=>{this.setState({selected:e})}),r()(this,"onNotificationsMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({notificationsMenuPosition:t.getBoundingClientRect()})}),r()(this,"onCloseNotificationsMenu",()=>{this.setState({notificationsMenuPosition:null})}),r()(this,"onGeneralMenuOpenClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({generalMenuPosition:t.getBoundingClientRect()})}),r()(this,"onContextMenu",e=>{this.showContextMenu&&(e.preventDefault(),e.stopPropagation(),this.setState({generalMenuPosition:{left:e.clientX,bottom:e.clientY}}))}),r()(this,"onCloseGeneralMenu",()=>{this.setState({generalMenuPosition:null})}),r()(this,"onTagRoom",(e,t)=>{if(e.preventDefault(),e.stopPropagation(),t===_.a.Favourite||t===_.a.LowPriority){const e=t===_.a.Favourite?_.a.LowPriority:_.a.Favourite,s=x.b.instance.getTagsForRoom(this.props.room).includes(t),n=s?t:e,a=s?null:t;p.a.dispatch(R.a.tagRoom(w.a.get(),this.props.room,n,a,void 0,0))}else console.warn(`Unexpected tag ${t} applied to ${this.props.room.room_id}`);e.key===g.a.ENTER&&this.setState({generalMenuPosition:null})}),r()(this,"onLeaveRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"leave_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onForgetRoomClick",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"forget_room",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onOpenRoomSettings",e=>{e.preventDefault(),e.stopPropagation(),p.a.dispatch({action:"open_room_settings",room_id:this.props.room.roomId}),this.setState({generalMenuPosition:null})}),r()(this,"onClickAllNotifs",e=>this.saveNotifState(e,C.a)),r()(this,"onClickAlertMe",e=>this.saveNotifState(e,C.b)),r()(this,"onClickMentions",e=>this.saveNotifState(e,C.c)),r()(this,"onClickMute",e=>this.saveNotifState(e,C.d)),this.state={selected:f.a.activeRoomId===this.props.room.roomId,notificationsMenuPosition:null,generalMenuPosition:null,messagePreview:this.generatePreview(),icon:n.None},f.a.addListener(this.props.room.roomId,this.onActiveRoomUpdate),this.dispatcherRef=p.a.register(this.onAction),y.a.instance.on(y.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),this.notificationState=O.a.instance.getRoomState(this.props.room),this.notificationState.on(k.a,this.onNotificationUpdate),this.roomProps=T.a.forRoom(this.props.room),this.roomProps.on(N.b,this.onRoomPropertyUpdate),D.a.instance.on(D.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate),this.props.room.on("Room.name",this.onRoomNameUpdate)}get showContextMenu(){return this.props.tag!==_.a.Invite}get showMessagePreview(){return!this.props.isMinimized&&this.props.showMessagePreview}componentDidUpdate(e,t){var s,n,a,i,o,r;(e.showMessagePreview!==this.props.showMessagePreview&&this.showMessagePreview&&this.setState({messagePreview:this.generatePreview()}),(null===(s=e.room)||void 0===s?void 0:s.roomId)!==(null===(n=this.props.room)||void 0===n?void 0:n.roomId))&&(y.a.instance.off(y.a.getPreviewChangedEventName(e.room),this.onRoomPreviewChanged),y.a.instance.on(y.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),D.a.instance.off(D.a.getUpdateEventName(null===(a=e.room)||void 0===a?void 0:a.roomId),this.onCommunityUpdate),D.a.instance.on(D.a.getUpdateEventName(null===(i=this.props.room)||void 0===i?void 0:i.roomId),this.onCommunityUpdate),null===(o=e.room)||void 0===o||o.off("Room.name",this.onRoomNameUpdate),null===(r=this.props.room)||void 0===r||r.on("Room.name",this.onRoomNameUpdate))}componentDidMount(){const e=A.a.shared().getUserIdForRoomId(this.props.room.roomId),t=U.a.isRoomNotice(this.props.room),s="unrestricted"===U.a.getAccessRules(this.props.room.roomId);let a;a=e||t?n.None:U.a.isRoomForum(this.props.room.roomId)?n.Forum:s?n.Unrestricted:n.Encrypted,this.setState({icon:a}),this.state.selected&&this.scrollIntoView()}componentWillUnmount(){this.props.room&&(f.a.removeListener(this.props.room.roomId,this.onActiveRoomUpdate),y.a.instance.off(y.a.getPreviewChangedEventName(this.props.room),this.onRoomPreviewChanged),D.a.instance.off(D.a.getUpdateEventName(this.props.room.roomId),this.onCommunityUpdate),this.props.room.off("Room.name",this.onRoomNameUpdate)),p.a.unregister(this.dispatcherRef),this.notificationState.off(k.a,this.onNotificationUpdate)}generatePreview(){return this.showMessagePreview?y.a.instance.getPreviewForRoom(this.props.room,this.props.tag):null}async saveNotifState(e,t){if(e.preventDefault(),e.stopPropagation(),w.a.get().isGuest())return;this.roomProps.notificationVolume=t;e.key===g.a.ENTER&&this.setState({notificationsMenuPosition:null})}renderNotificationsMenu(e){if(w.a.get().isGuest()||this.props.tag===_.a.Archived||!this.showContextMenu||this.props.isMinimized)return null;const t=this.roomProps.notificationVolume;let s=null;this.state.notificationsMenuPosition&&(s=c.a.createElement(P.e,i()({},B(this.state.notificationsMenuPosition),{onFinished:this.onCloseNotificationsMenu,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(P.c,{first:!0},c.a.createElement(P.d,{label:Object(b.a)("Use default"),active:t===C.a,iconClassName:"mx_RoomTile_iconBell",onClick:this.onClickAllNotifs}),c.a.createElement(P.d,{label:Object(b.a)("All messages"),active:t===C.b,iconClassName:"mx_RoomTile_iconBellDot",onClick:this.onClickAlertMe}),c.a.createElement(P.d,{label:Object(b.a)("Mentions & Keywords"),active:t===C.c,iconClassName:"mx_RoomTile_iconBellMentions",onClick:this.onClickMentions}),c.a.createElement(P.d,{label:Object(b.a)("None"),active:t===C.d,iconClassName:"mx_RoomTile_iconBellCrossed",onClick:this.onClickMute}))));const n=m()("mx_RoomTile_notificationsButton",{mx_RoomTile_iconBell:t===C.a,mx_RoomTile_iconBellDot:t===C.b,mx_RoomTile_iconBellMentions:t===C.c,mx_RoomTile_iconBellCrossed:t===C.d,mx_RoomTile_notificationsButton_show:t===C.d});return c.a.createElement(c.a.Fragment,null,c.a.createElement(v.d,{className:n,onClick:this.onNotificationsMenuOpenClick,title:Object(b.a)("Notification options"),isExpanded:!!this.state.notificationsMenuPosition,tabIndex:e?0:-1}),s)}renderGeneralMenu(){if(!this.showContextMenu)return null;let e=null;if(this.state.generalMenuPosition&&this.props.tag===_.a.Archived)e=c.a.createElement(P.e,i()({},B(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(P.c,{red:!0},c.a.createElement(P.b,{iconClassName:"mx_RoomTile_iconSignOut",label:Object(b.a)("Forget Room"),onClick:this.onForgetRoomClick})));else if(this.state.generalMenuPosition){const t=x.b.instance.getTagsForRoom(this.props.room),s=new A.a(w.a.get()),n=Boolean(s.getUserIdForRoomId(this.props.room.roomId)),a=t.includes(_.a.Favourite),o=a?Object(b.a)("Pinned room"):Object(b.a)("Pin room");let r=null;n||(r=c.a.createElement(P.b,{onClick:this.onOpenRoomSettings,label:Object(b.a)("Settings"),iconClassName:"mx_RoomTile_iconSettings"})),e=c.a.createElement(P.e,i()({},B(this.state.generalMenuPosition),{onFinished:this.onCloseGeneralMenu,className:"mx_RoomTile_contextMenu",compact:!0}),c.a.createElement(P.c,null,c.a.createElement(P.a,{onClick:e=>this.onTagRoom(e,_.a.Favourite),active:a,label:o,iconClassName:"mx_RoomTile_iconStar"}),r),c.a.createElement(P.c,{red:!0},c.a.createElement(P.b,{onClick:this.onLeaveRoomClick,label:Object(b.a)("Leave Room"),iconClassName:"mx_RoomTile_iconSignOut"})))}return c.a.createElement(c.a.Fragment,null,c.a.createElement(v.d,{className:"mx_RoomTile_menuButton",onClick:this.onGeneralMenuOpenClick,title:Object(b.a)("Room options"),isExpanded:!!this.state.generalMenuPosition}),e)}renderRoomTypeElement(){let e="tc_RoomTile_roomType",t=" ";return U.a.isRoomForum(this.props.room.roomId)?(e+=" tc_Room_roomType_forum",t=Object(b.a)("Forum")):U.a.isRoomNotice(this.props.room)?(e+=" tc_Room_roomType_infos",t=Object(b.a)("Infos")):"restricted"===U.a.getAccessRules(this.props.room.roomId)?(e+=" tc_Room_roomType_restricted",t=Object(b.a)("Private")):"unrestricted"===U.a.getAccessRules(this.props.room.roomId)&&(e+=" tc_Room_roomType_unrestricted",t=Object(b.a)("External")),this.props.isMinimized||"invite"===this.props.room.getMyMembership()?null:c.a.createElement(c.a.Fragment,null,c.a.createElement("div",{className:e},t))}render(){const e=m()({mx_RoomTile:!0,mx_RoomTile_selected:this.state.selected,mx_RoomTile_hasMenuOpen:!(!this.state.generalMenuPosition&&!this.state.notificationsMenuPosition),mx_RoomTile_minimized:this.props.isMinimized});let t={displayName:null,avatarMxc:null};this.props.tag===_.a.Invite&&(t=D.a.instance.getInviteProfile(this.props.room.roomId));let s=t.displayName||this.props.room.name;"string"!=typeof s&&(s=""),s=s.replace(":",":​");if(A.a.shared().getUserIdForRoomId(this.props.room.roomId)){const e=this.props.room.getMembersWithMembership("leave");s.startsWith("Empty room (was ")&&e.length>0&&(s=e[0].rawDisplayName)}const a=c.a.createElement(E.a,{room:this.props.room,avatarSize:38,tag:this.props.tag,displayBadge:this.props.isMinimized,oobData:{avatarUrl:t.avatarMxc}});let o,r;this.state.icon!==n.None&&(o=c.a.createElement(M.a,{tooltip:L(this.state.icon),class:"mx_DecoratedRoomAvatar_icon mx_DecoratedRoomAvatar_icon_"+this.state.icon.toLowerCase()})),this.props.isMinimized||(r=c.a.createElement("div",{className:"mx_RoomTile_badgeContainer","aria-hidden":"true"},c.a.createElement(S.a,{notification:this.notificationState,forceCount:!1,roomId:this.props.room.roomId})));let l=null;this.showMessagePreview&&this.state.messagePreview&&(l=c.a.createElement("div",{className:"mx_RoomTile_messagePreview",id:F(this.props.room.roomId)},U.a.transformServerErrors(this.state.messagePreview,!0)));const d=m()({mx_RoomTile_name:!0,mx_RoomTile_nameWithPreview:!!l,mx_RoomTile_nameHasUnreadEvents:this.notificationState.isUnread});let p=c.a.createElement("div",{className:"mx_RoomTile_nameContainer"},c.a.createElement("div",{title:s,className:d,tabIndex:-1,dir:"auto"},s),l);this.props.isMinimized&&(p=null);let g,f=s;this.props.tag===_.a.Invite||(this.notificationState.hasMentions?f+=" "+Object(b.a)("%(count)s unread messages including mentions.",{count:this.notificationState.count}):this.notificationState.hasUnreadCount?f+=" "+Object(b.a)("%(count)s unread messages.",{count:this.notificationState.count}):this.notificationState.isUnread&&(f+=" "+Object(b.a)("Unread messages."))),this.showMessagePreview&&(g=F(this.props.room.roomId));const v={};let y=u.a;return this.props.isMinimized&&(y=I.a,v.title=s,v.forceHide=!!this.state.generalMenuPosition),c.a.createElement(c.a.Fragment,null,c.a.createElement(h.d,{inputRef:this.roomTileRef},({onFocus:t,isActive:s,ref:n})=>c.a.createElement(y,i()({},v,{onFocus:t,tabIndex:s?0:-1,inputRef:n,className:e,onClick:this.onTileClick,onContextMenu:this.onContextMenu,role:"treeitem","aria-label":f,"aria-selected":this.state.selected,"aria-describedby":g}),a,o,p,r,this.renderRoomTypeElement(),this.renderGeneralMenu(),this.renderNotificationsMenu(s))))}}}).call(this,s(167).setImmediate)},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(128);class o{constructor(){a()(this,"listeners",{}),a()(this,"_activeRoomId",i.a.getRoomId()),a()(this,"roomStoreToken",void 0),a()(this,"onRoomViewStoreUpdate",()=>{this._activeRoomId&&this.emit(this._activeRoomId,!1),this._activeRoomId=i.a.getRoomId(),this._activeRoomId&&this.emit(this._activeRoomId,!0)}),this.roomStoreToken=i.a.addListener(this.onRoomViewStoreUpdate)}get activeRoomId(){return this._activeRoomId}addListener(e,t){this.listeners[e]||(this.listeners[e]=[]),this.listeners[e].push(t)}removeListener(e,t){if(this.listeners[e]){const s=this.listeners[e].indexOf(t);s>-1&&this.listeners[e].splice(s,1)}else console.warn("Unregistering unrecognised listener (roomId="+e+")")}emit(e,t){if(this.listeners[e])for(const s of this.listeners[e])s.call(null,t)}}void 0===window.mxActiveRoomObserver&&(window.mxActiveRoomObserver=new o),t.a=window.mxActiveRoomObserver},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(371),a=s(89),i=s(282),o=s(83),r=s(85),l=s(150),c=s(237),d=s(125);class m{static tagRoom(e,t,s,m,h,u){let p=null;const g=l.b.instance;if(m&&g.getTagSorting(m)===c.b.Manual){const e=[...g.orderedLists[m]];e.sort((e,t)=>e.tags[m].order-t.tags[m].order);const t=m===s&&h<u?1:0,n=t+u-1,a=t+u,i=n<=0?0:e[n].tags[m].order,o=a>=e.length?1:e[a].tags[m].order;p={order:(i+o)/2}}return Object(n.a)("RoomListActions.tagRoom",()=>{const n=[],l=t.roomId;if(void 0===s&&m===d.a.DM||s===d.a.DM&&void 0===m)return i.b(t,m===d.a.DM).catch(e=>{const t=r.getComponent("dialogs.ErrorDialog");console.error("Failed to set direct chat tag "+e),a.a.createTrackedDialog("Failed to set direct chat tag","",t,{title:Object(o.a)("Failed to set direct chat tag"),description:e&&e.message?e.message:Object(o.a)("Operation failed")})});const c=s!==m;if(s&&s!==d.a.DM&&c){const t=e.deleteRoomTag(l,s).catch((function(e){const t=r.getComponent("dialogs.ErrorDialog");console.error("Failed to remove tag "+s+" from room: "+e),a.a.createTrackedDialog("Failed to remove tag from room","",t,{title:Object(o.a)("Failed to remove tag %(tagName)s from room",{tagName:s}),description:e&&e.message?e.message:Object(o.a)("Operation failed")})}));n.push(t)}if(m&&m!==d.a.DM&&(c||p)){p=p||{};const t=e.setRoomTag(l,m,p).catch((function(e){const t=r.getComponent("dialogs.ErrorDialog");throw console.error("Failed to add tag "+m+" to room: "+e),a.a.createTrackedDialog("Failed to add tag to room","",t,{title:Object(o.a)("Failed to add tag %(tagName)s to room",{tagName:m}),description:e&&e.message?e.message:Object(o.a)("Operation failed")}),e}));n.push(t)}return Promise.all(n)},()=>({room:t,oldTag:s,newTag:m,metaData:p}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(645),o=s(648),r=s(147),l=s(87),c=s(649),d=s(650),m=s(651);const h=e=>"room-"+e.roomId;class u extends r.a{constructor(){super(l.a),a()(this,"caches",new Map)}static get instance(){return u._instance||(u._instance=new u),u._instance}get contexts(){return Array.from(this.caches.values()).map(e=>e.context)}getOrCreateChamberForRoom(e){if(this.caches.has(h(e)))return this.caches.get(h(e));const t=new o.a(e);t.whenAnything(()=>this.checkContexts());const s=new i.b(t);return s.setClient(this.matrixClient),this.caches.set(h(e),s),s}async checkContexts(){let e=!1;for(const t of this.caches.values())if(e=t.context.state===c.a.PendingErrors,e)break;if(e&&!this.state.toastRef){const e=d.a.instance.addToast(m.a);await this.updateState({toastRef:e})}else!e&&this.state.toastRef&&(d.a.instance.removeToast(this.state.toastRef),await this.updateState({toastRef:null}))}async onReady(){if(this.caches)for(const e of this.caches.values())e.setClient(this.matrixClient)}async onNotReady(){for(const e of this.caches.values())e.setClient(null)}async onAction(e){return Promise.resolve()}}a()(u,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return c}));var n=s(82),a=s.n(n),i=s(646),o=s(304),r=s(83);let l;!function(e){e[e.NotificationVolume=0]="NotificationVolume"}(l||(l={}));class c extends i.a{constructor(e){super(e,e=>this.properties.get(e)),a()(this,"properties",new Map),a()(this,"onAccountData",e=>{if("m.push_rules"===e.getType()){this.properties.get(l.NotificationVolume)!==Object(o.f)(this.context.room.roomId)&&this.updateNotificationVolume()}})}onClientChanged(e,t){this.properties.clear(),e&&e.removeListener("accountData",this.onAccountData),t&&(t.on("accountData",this.onAccountData),this.updateNotificationVolume())}updateNotificationVolume(){this.properties.set(l.NotificationVolume,Object(o.f)(this.context.room.roomId)),this.markEchoReceived(l.NotificationVolume),this.emit(i.b,l.NotificationVolume)}get notificationVolume(){return this.getValue(l.NotificationVolume)}set notificationVolume(e){this.setValue(Object(r.a)("Change notification settings"),l.NotificationVolume,e,async()=>Object(o.h)(this.context.room.roomId,e),i.c)}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return r})),s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c}));var n=s(82),a=s.n(n),i=s(446),o=s(6);async function r(){}const l="property_updated";class c extends o.EventEmitter{constructor(e,t){super(),this.context=e,this.lookupFn=t,a()(this,"cache",new Map),a()(this,"matrixClient",void 0)}setClient(e){const t=this.matrixClient;this.matrixClient=e,this.onClientChanged(t,e)}getValue(e){return this.cache.has(e)?this.cache.get(e).val:this.lookupFn(e)}cacheVal(e,t,s){this.cache.set(e,{txn:s,val:t}),this.emit(l,e)}decacheKey(e){this.cache.has(e)&&(this.context.disownTransaction(this.cache.get(e).txn),this.cache.delete(e),this.emit(l,e))}markEchoReceived(e){if(this.cache.has(e)){const t=this.cache.get(e).txn;this.context.disownTransaction(t),t.cancel()}this.decacheKey(e)}setValue(e,t,s,n,a){this.cache.has(t)&&this.cache.get(t).txn.cancel();const o=this.context.beginTransaction(e,n);this.cacheVal(t,s,o),o.when(i.b.Pending,()=>this.cacheVal(t,s,o)).when(i.b.Error,()=>a()),o.run()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(82),a=s.n(n),i=s(120);class o{constructor(){a()(this,"listeners",[])}when(e,t){return this.listeners.push({condition:e,fn:t}),this}whenAnyOf(e,t){for(const s of e)this.when(s,t);return this}whenAnything(e){return this.listeners.push({condition:null,fn:e}),this}notifyCondition(e){const t=Object(i.c)(this.listeners);for(const s of t)if(null===s.condition||s.condition===e)try{s.fn(this)}catch(t){console.error(`Error calling whenable listener for ${e}:`,t)}}destroy(){this.listeners=[]}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(649);class a extends n.b{constructor(e){super(),this.room=e}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l})),s.d(t,"b",(function(){return c}));var n=s(82),a=s.n(n),i=s(446),o=s(120),r=s(647);let l;!function(e){e[e.NotStarted=0]="NotStarted",e[e.PendingErrors=1]="PendingErrors",e[e.AllSuccessful=2]="AllSuccessful"}(l||(l={}));class c extends r.a{constructor(...e){super(...e),a()(this,"_transactions",[]),a()(this,"_state",l.NotStarted),a()(this,"checkTransactions",()=>{let e=l.AllSuccessful;for(const t of this.transactions){if(t.status===i.b.Error||t.didPreviouslyFail){e=l.PendingErrors;break}t.status===i.b.Pending&&(e=l.NotStarted)}this._state=e,this.notifyCondition(e)})}get transactions(){return Object(o.c)(this._transactions)}get state(){return this._state}get firstFailedTime(){const e=this.transactions.find(e=>e.didPreviouslyFail||e.status===i.b.Error);return e?e.startTime:null}disownTransaction(e){const t=this._transactions.indexOf(e);t>=0&&this._transactions.splice(t,1),e.destroy(),this.checkTransactions()}beginTransaction(e,t){const s=new i.a(e,t);return this._transactions.push(s),s.whenAnything(this.checkTransactions),s.when(i.b.Success,()=>s.destroy()),s}destroy(){for(const e of this.transactions)e.destroy();this._transactions=[],super.destroy()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(82),a=s.n(n),i=s(6),o=s.n(i),r=s(113);class l extends o.a{constructor(...e){super(...e),a()(this,"toasts",new Map)}static get instance(){return l._instance||(l._instance=new l),l._instance}get components(){return Array.from(this.toasts.values())}addToast(e){const t=Symbol();return this.toasts.set(t,e),this.emit(r.b),t}removeToast(e){this.toasts.delete(e),this.emit(r.b)}}a()(l,"_instance",void 0)},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(83),l=s(91),c=s(89),d=s(652);class m extends o.a.PureComponent{constructor(...e){super(...e),a()(this,"openDialog",()=>{c.a.createTrackedDialog("Local Echo Server Error","",d.a,{})})}render(){return o.a.createElement("div",{className:"mx_NonUrgentEchoFailureToast"},o.a.createElement("span",{className:"mx_NonUrgentEchoFailureToast_icon"}),Object(r.a)("Your server isn't responding to some <a>requests</a>.",{},{a:e=>o.a.createElement(l.a,{kind:"link",onClick:this.openDialog},e)}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(82),a=s.n(n),i=s(81),o=s(131),r=s(83),l=s(644),c=s(130),d=s(88),m=s(648),h=s(199),u=s(446),p=s(117),g=s(91),f=s(113),b=s(86);class v extends i.PureComponent{constructor(...e){super(...e),a()(this,"onEchosUpdated",()=>{this.forceUpdate()})}componentDidMount(){l.a.instance.on(f.b,this.onEchosUpdated)}componentWillUnmount(){l.a.instance.off(f.b,this.onEchosUpdated)}renderTimeline(){return l.a.instance.contexts.map((e,t)=>{if(!e.firstFailedTime)return null;if(!(e instanceof m.a))throw new Error("Cannot render unknown context: "+e);const s=i.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline_header"},i.createElement(h.a,{width:24,height:24,room:e.room}),i.createElement("span",null,e.room.name)),n=e.transactions.filter(e=>e.status===u.b.Error||e.didPreviouslyFail).map((e,t)=>{let s=i.createElement(p.a,{w:19,h:19});return e.status===u.b.Error&&(s=i.createElement(g.a,{kind:"link",onClick:()=>e.run()},Object(r.a)("Resend"))),i.createElement("div",{className:"mx_ServerOfflineDialog_content_context_txn",key:"txn-"+t},i.createElement("span",{className:"mx_ServerOfflineDialog_content_context_txn_desc"},e.auditName),s)});return i.createElement("div",{className:"mx_ServerOfflineDialog_content_context",key:"context-"+t},i.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timestamp"},Object(c.d)(e.firstFailedTime,d.a.getValue("showTwelveHourTimestamps"))),i.createElement("div",{className:"mx_ServerOfflineDialog_content_context_timeline"},s,n))})}render(){let e=this.renderTimeline().filter(e=>!!e);0===e.length&&(e=[i.createElement("div",{key:1},Object(r.a)("You're all caught up."))]);const t=b.a.getHomeserverName();return i.createElement(o.a,{title:Object(r.a)("Server isn't responding"),className:"mx_ServerOfflineDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished,hasCancel:!0},i.createElement("div",{className:"mx_ServerOfflineDialog_content"},i.createElement("p",null,Object(r.a)("Your server isn't responding to some of your requests. Below are some of the most likely reasons.")),i.createElement("ul",null,i.createElement("li",null,Object(r.a)("The server (%(serverName)s) took too long to respond.",{serverName:t})),i.createElement("li",null,Object(r.a)("Your firewall or anti-virus is blocking the request.")),i.createElement("li",null,Object(r.a)("A browser extension is preventing the request.")),i.createElement("li",null,Object(r.a)("The server is offline.")),i.createElement("li",null,Object(r.a)("The server has denied your request.")),i.createElement("li",null,Object(r.a)("Your area is experiencing difficulties connecting to the internet.")),i.createElement("li",null,Object(r.a)("A connection error occurred while trying to contact the server.")),i.createElement("li",null,Object(r.a)("The server is not configured to indicate what the problem is (CORS)."))),i.createElement("hr",null),i.createElement("h2",null,Object(r.a)("Recent changes that have not yet been received")),e))}}},function(e,t){e.exports="img/spinner.a5c5b3b.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(83),l=s(131),c=s(91),d=s(127);let m;!function(e){e.Screens="screens",e.Windows="windows"}(m||(m={}));class h extends o.a.Component{constructor(e){super(e),a()(this,"onClick",e=>{this.props.onSelect(this.props.source)})}render(){return o.a.createElement(c.a,{className:"mx_desktopCapturerSourcePicker_stream_button",title:this.props.source.name,onClick:this.onClick},o.a.createElement("img",{className:"mx_desktopCapturerSourcePicker_stream_thumbnail",src:this.props.source.thumbnailURL}),o.a.createElement("span",{className:"mx_desktopCapturerSourcePicker_stream_name"},this.props.source.name))}}class u extends o.a.Component{constructor(e){super(e),a()(this,"interval",void 0),a()(this,"onSelect",e=>{this.props.onFinished(e)}),a()(this,"onScreensClick",e=>{this.setState({selectedTab:m.Screens})}),a()(this,"onWindowsClick",e=>{this.setState({selectedTab:m.Windows})}),a()(this,"onCloseClick",e=>{this.props.onFinished(null)}),this.state={selectedTab:m.Screens,sources:[]}}async componentDidMount(){this.setState({sources:await Object(d.h)()}),this.interval=setInterval(async()=>{this.setState({sources:await Object(d.h)()})},500)}componentWillUnmount(){clearInterval(this.interval)}render(){let e;e=this.state.selectedTab===m.Screens?this.state.sources.filter(e=>e.id.startsWith("screen")).map(e=>o.a.createElement(h,{source:e,onSelect:this.onSelect,key:e.id})):this.state.sources.filter(e=>e.id.startsWith("window")).map(e=>o.a.createElement(h,{source:e,onSelect:this.onSelect,key:e.id}));const t="mx_desktopCapturerSourcePicker_tabLabel",s=t+(this.state.selectedTab===m.Screens?"_selected":""),n=t+(this.state.selectedTab===m.Windows?"_selected":"");return o.a.createElement(l.a,{className:"mx_desktopCapturerSourcePicker",onFinished:this.onCloseClick,title:Object(r.a)("Share your screen")},o.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_tabLabels"},o.a.createElement(c.a,{className:s,onClick:this.onScreensClick},Object(r.a)("Screens")),o.a.createElement(c.a,{className:n,onClick:this.onWindowsClick},Object(r.a)("Windows"))),o.a.createElement("div",{className:"mx_desktopCapturerSourcePicker_panel"},e))}}},,function(e,t){e.exports="img/external-link.a8d3e9b.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return o}));var n=s(95);const a=window.localStorage;let i;try{i=window.indexedDB}catch(e){}function o(e){const t={useAuthorizationHeader:!0};return i&&a&&(t.store=new n.g({indexedDB:i,dbName:"riot-web-sync",localStorage:a,workerScript:o.indexedDbWorkerScript})),a&&(t.sessionStore=new n.o(a)),i&&(t.cryptoStore=new n.f(i,"matrix-js-sdk:crypto")),e=Object.assign(t,e),n.p(e)}o.indexedDbWorkerScript=null},function(e,t,s){"use strict";s.d(t,"c",(function(){return o})),s.d(t,"b",(function(){return l})),s.d(t,"a",(function(){return c}));var n=s(159),a=s(86),i=s(263);function o(){const e=new i.a(a.a.get()).getPushRuleById(".m.rule.master");return e?e.enabled&&!e.actions.includes("notify"):(console.warn("No master push rule! Notifications are disabled for this user."),!0)}function r(){let e=s(249);return e.default&&(e=e.default),e}class l extends n.a{getValueOverride(e,t,s,n){return!!r().isPossible()&&(null===s||"default"===n?!o():s)}onChange(e,t,s){r().supportsDesktopNotifications()&&r().setEnabled(s)}}class c extends n.a{getValueOverride(e,t,s){return!!r().isPossible()&&(null===s?!o():s)}}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return o}));var n=s(86),a=s(88),i=s(250);class o{constructor(){this.reset()}static sharedInstance(){return void 0===e.mxTypingStore&&(e.mxTypingStore=new o),e.mxTypingStore}reset(){this._typingStates={}}setSelfTyping(e,t){if(!a.a.getValue("sendTypingNotifications"))return;if(a.a.getValue("lowBandwidth"))return;let s=this._typingStates[e];!t&&!s||s&&s.isTyping===t||(s||(s=this._typingStates[e]={isTyping:t,serverTimer:new i.a(3e4),userTimer:new i.a(1e4)}),s.isTyping=t,t&&(s.serverTimer.isRunning()?s.serverTimer.restart():s.serverTimer.restart().finished().then(()=>{const t=this._typingStates[e];t&&(t.isTyping=!1)}),s.userTimer.isRunning()?s.userTimer.restart():s.userTimer.restart().finished().then(()=>{this.setSelfTyping(e,!1)})),n.a.get().sendTyping(e,t,3e4))}}}).call(this,s(5))},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(453),d=s(131),m=s(83),h=s(454);function u(e){return e===h.c?s(1142):s(348)}class p extends o.a.Component{constructor(){super(),a()(this,"_onStoreUpdate",()=>{this.setState({icon:u(this.store.phase)})}),this.store=h.f.sharedInstance(),this.state={icon:u(this.store.phase)}}componentDidMount(){this.store.on("update",this._onStoreUpdate)}componentWillUnmount(){this.store.removeListener("update",this._onStoreUpdate)}render(){return o.a.createElement(d.a,{headerImage:this.state.icon,onFinished:this.props.onFinished,title:Object(m.a)("Verify this session")},o.a.createElement(c.a,{onFinished:this.props.onFinished}))}}a()(p,"propTypes",{onFinished:l.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(82),a=s.n(n),i=s(106),o=s(90),r=s.n(o),l=s(81),c=s.n(l),d=s(84),m=s.n(d),h=s(85),u=s(86),p=s(104),g=s(91),f=s(83);class b extends c.a.PureComponent{constructor(e){super(e),a()(this,"_onCancel",()=>{this.props.onFinished(!1)}),a()(this,"_onUseRecoveryKeyClick",()=>{this.setState({forceRecoveryKey:!0})}),a()(this,"_validateRecoveryKeyOnChange",Object(i.debounce)(()=>{this._validateRecoveryKey()},200)),a()(this,"_onRecoveryKeyChange",e=>{this.setState({recoveryKey:e.target.value,recoveryKeyFileError:null}),this._fileUpload.current&&(this._fileUpload.current.value=null),this._validateRecoveryKeyOnChange()}),a()(this,"_onRecoveryKeyFileChange",async e=>{if(0===e.target.files.length)return;const t=e.target.files[0];if(t.size>128)this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1});else{const e=await t.text();/^[123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz\s]+$/.test(e)?(this.setState({recoveryKeyFileError:null,recoveryKey:e.trim()}),this._validateRecoveryKey()):this.setState({recoveryKeyFileError:!0,recoveryKeyCorrect:!1,recoveryKeyValid:!1,recoveryKey:""})}}),a()(this,"_onRecoveryKeyFileUploadClick",()=>{this._fileUpload.current.click()}),a()(this,"_onPassPhraseNext",async e=>{if(e.preventDefault(),this.state.passPhrase.length<=0)return;this.setState({keyMatches:null});const t={passphrase:this.state.passPhrase},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),a()(this,"_onRecoveryKeyNext",async e=>{if(e.preventDefault(),!this.state.recoveryKeyValid)return;this.setState({keyMatches:null});const t={recoveryKey:this.state.recoveryKey},s=await this.props.checkPrivateKey(t);s?this.props.onFinished(t):this.setState({keyMatches:s})}),a()(this,"_onPassPhraseChange",e=>{this.setState({passPhrase:e.target.value,keyMatches:null})}),this._fileUpload=c.a.createRef(),this.state={recoveryKey:"",recoveryKeyValid:null,recoveryKeyCorrect:null,recoveryKeyFileError:null,forceRecoveryKey:!1,passPhrase:"",keyMatches:null}}async _validateRecoveryKey(){if(""!==this.state.recoveryKey)try{const e=u.a.get(),t=e.keyBackupKeyFromRecoveryKey(this.state.recoveryKey),s=await e.checkSecretStorageKey(t,this.props.keyInfo);this.setState({recoveryKeyValid:!0,recoveryKeyCorrect:s})}catch(e){this.setState({recoveryKeyValid:!1,recoveryKeyCorrect:!1})}else this.setState({recoveryKeyValid:null,recoveryKeyCorrect:null})}getKeyValidationText(){return this.state.recoveryKeyFileError?Object(f.a)("Wrong file type"):this.state.recoveryKeyCorrect?Object(f.a)("Looks good!"):this.state.recoveryKeyValid?Object(f.a)("Wrong Security Key"):null===this.state.recoveryKeyValid?"":Object(f.a)("Invalid Security Key")}render(){const e=h.getComponent("views.dialogs.BaseDialog");let t,s,n;if(this.props.keyInfo&&this.props.keyInfo.passphrase&&this.props.keyInfo.passphrase.salt&&this.props.keyInfo.passphrase.iterations&&!this.state.forceRecoveryKey){const e=h.getComponent("views.elements.DialogButtons"),a=h.getComponent("elements.AccessibleButton");let i;s=Object(f.a)("Security Phrase"),n=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_securePhraseTitle"],i=!1===this.state.keyMatches?c.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"},"👎 ",Object(f.a)("Unable to access secret storage. Please verify that you entered the correct Security Phrase.")):c.a.createElement("div",{className:"mx_AccessSecretStorageDialog_keyStatus"}),t=c.a.createElement("div",null,c.a.createElement("p",null,Object(f.a)("Enter your Security Phrase or <button>Use your Security Key</button> to continue.",{},{button:e=>c.a.createElement(a,{className:"mx_linkButton",element:"span",onClick:this._onUseRecoveryKeyClick},e)})),c.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this._onPassPhraseNext},c.a.createElement("input",{type:"password",className:"mx_AccessSecretStorageDialog_passPhraseInput",onChange:this._onPassPhraseChange,value:this.state.passPhrase,autoFocus:!0,autoComplete:"new-password",placeholder:Object(f.a)("Security Phrase")}),i,c.a.createElement(e,{primaryButton:Object(f.a)("Continue"),onPrimaryButtonClick:this._onPassPhraseNext,hasCancel:!0,onCancel:this._onCancel,focus:!1,primaryDisabled:0===this.state.passPhrase.length})))}else{s=Object(f.a)("Security Key"),n=["mx_AccessSecretStorageDialog_titleWithIcon mx_AccessSecretStorageDialog_secureBackupTitle"];const e=h.getComponent("views.elements.DialogButtons"),a=r()({mx_AccessSecretStorageDialog_recoveryKeyFeedback:!0,mx_AccessSecretStorageDialog_recoveryKeyFeedback_valid:!0===this.state.recoveryKeyCorrect,mx_AccessSecretStorageDialog_recoveryKeyFeedback_invalid:!1===this.state.recoveryKeyCorrect}),i=c.a.createElement("div",{className:a},this.getKeyValidationText());t=c.a.createElement("div",null,c.a.createElement("p",null,Object(f.a)("Use your Security Key to continue.")),c.a.createElement("form",{className:"mx_AccessSecretStorageDialog_primaryContainer",onSubmit:this._onRecoveryKeyNext,spellCheck:!1,autoComplete:"off"},c.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry"},c.a.createElement("div",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_textInput"},c.a.createElement(p.a,{type:"password",label:Object(f.a)("Security Key"),value:this.state.recoveryKey,onChange:this._onRecoveryKeyChange,forceValidity:this.state.recoveryKeyCorrect,autoComplete:"off"})),c.a.createElement("span",{className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_entryControlSeparatorText"},Object(f.a)("or")),c.a.createElement("div",null,c.a.createElement("input",{type:"file",className:"mx_AccessSecretStorageDialog_recoveryKeyEntry_fileInput",ref:this._fileUpload,onChange:this._onRecoveryKeyFileChange}),c.a.createElement(g.a,{kind:"primary",onClick:this._onRecoveryKeyFileUploadClick},Object(f.a)("Upload")))),i,c.a.createElement(e,{primaryButton:Object(f.a)("Continue"),onPrimaryButtonClick:this._onRecoveryKeyNext,hasCancel:!0,cancelButton:Object(f.a)("Go Back"),cancelButtonClass:"danger",onCancel:this._onCancel,focus:!1,primaryDisabled:!this.state.recoveryKeyValid})))}return c.a.createElement(e,{className:"mx_AccessSecretStorageDialog",onFinished:this.props.onFinished,title:s,titleClass:n},c.a.createElement("div",null,t))}}a()(b,"propTypes",{keyInfo:m.a.object.isRequired,checkPrivateKey:m.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(81),a=s.n(n),i=s(84),o=s.n(i),r=s(85),l=s(261),c=s.n(l),d=s(83);const m=["vector-im/element-web","matrix-org/matrix-react-sdk","matrix-org/matrix-js-sdk"];class h extends a.a.Component{constructor(e){super(e),this.state={}}componentDidMount(){const e=this.props.newVersion.split("-"),t=this.props.version.split("-");if(null!=e&&null!=t)for(let s=0;s<m.length;s++){const n=t[2*s],a=e[2*s],i=`https://riot.im/github/repos/${m[s]}/compare/${n}...${a}`;c()(i,(e,t,n)=>{t.statusCode<200||t.statusCode>=300?this.setState({[m[s]]:t.statusText}):this.setState({[m[s]]:JSON.parse(n).commits})})}}_elementsForCommit(e){return a.a.createElement("li",{key:e.sha,className:"mx_ChangelogDialog_li"},a.a.createElement("a",{href:e.html_url,target:"_blank",rel:"noreferrer noopener"},e.commit.message.split("\n")[0]))}render(){const e=r.getComponent("views.elements.Spinner"),t=r.getComponent("dialogs.QuestionDialog"),s=m.map(t=>{let s;return s=null==this.state[t]?a.a.createElement(e,{key:t}):"string"==typeof this.state[t]?Object(d.a)("Unable to load commit detail: %(msg)s",{msg:this.state[t]}):this.state[t].map(this._elementsForCommit),a.a.createElement("div",{key:t},a.a.createElement("h2",null,t),a.a.createElement("ul",null,s))}),n=a.a.createElement("div",{className:"mx_ChangelogDialog_content"},null==this.props.version||null==this.props.newVersion?a.a.createElement("h2",null,Object(d.a)("Unavailable")):s);return a.a.createElement(t,{title:Object(d.a)("Changelog"),description:n,button:Object(d.a)("Update"),onFinished:this.props.onFinished})}}h.propTypes={version:o.a.string.isRequired,newVersion:o.a.string.isRequired,onFinished:o.a.func.isRequired}},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return c}));var n=s(82),a=s.n(n),i=s(6),o=s.n(i),r=s(654);function l(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class c extends o.a{static get instance(){return c._instance||(c._instance=new c),c._instance}storeInvite(e,t){const s=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?l(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):l(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({roomId:e},t),n=this.generateIdOf(s);return localStorage.setItem("mx_threepid_invite_"+n,JSON.stringify(s)),this.translateInvite(s)}getWireInvites(){const e=[];for(let t=0;t<localStorage.length;t++){const s=localStorage.key(t);s.startsWith("mx_threepid_invite_")&&e.push(JSON.parse(localStorage.getItem(s)))}return e}getInvites(){return this.getWireInvites().map(e=>this.translateInvite(e))}pickBestInvite(){return this.getInvites()[0]}resolveInvite(e){localStorage.removeItem("mx_threepid_invite_"+e.id)}generateIdOf(t){return r.base32.stringify(e.from(JSON.stringify(t)))}translateInvite(e){return{id:this.generateIdOf(e),roomId:e.roomId,toEmail:e.email,signUrl:e.signurl,roomName:e.room_name,roomAvatarUrl:e.room_avatar_url,inviterName:e.inviter_name}}translateToWireFormat(e){return{email:e.toEmail,signurl:e.signUrl,room_name:e.roomName,room_avatar_url:e.roomAvatarUrl,inviter_name:e.inviterName}}}a()(c,"_instance",void 0)}).call(this,s(32).Buffer)},function(e,t,s){"use strict";s.d(t,"a",(function(){return g})),s.d(t,"b",(function(){return f}));var n=s(1144),a=s.n(n),i=s(86),o=s(107),r=s(83),l=s(1153),c=s.n(l),d=s(461),m=s(302),h=s(88);let u=window.TextEncoder;async function p(e={},t=!0){const s=e.progressCallback||(()=>{});s(Object(r.a)("Collecting app version information"));let n="UNKNOWN";try{n=await o.a.get().getAppVersion()}catch(e){}let l="UNKNOWN";window.navigator&&window.navigator.userAgent&&(l=window.navigator.userAgent);let c="UNKNOWN";try{c=String(window.matchMedia("(display-mode: standalone)").matches)}catch(e){}let m="UNKNOWN";try{m=String(window.matchMedia("(pointer: coarse)").matches)}catch(e){}const p=i.a.get();console.log("Sending bug report.");const g=new FormData;if(g.append("text",e.userText||"User did not supply any additional text."),g.append("app","tchap-web"),g.append("version",n),g.append("user_agent",l),g.append("installed_pwa",c),g.append("touch_input",m),p&&(g.append("user_id",p.credentials.userId),g.append("device_id",p.deviceId),p.isCryptoEnabled())){const e=["ed25519:"+p.getDeviceEd25519Key()];p.getDeviceCurve25519Key&&e.push("curve25519:"+p.getDeviceCurve25519Key()),g.append("device_keys",e.join(", ")),g.append("cross_signing_key",p.getCrossSigningId());const t=p._crypto._crossSigningInfo,s=p._crypto._secretStorage;g.append("cross_signing_ready",String(await p.isCrossSigningReady())),g.append("cross_signing_supported_by_hs",String(await p.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"))),g.append("cross_signing_key",t.getId()),g.append("cross_signing_pk_in_secret_storage",String(!!await t.isStoredInSecretStorage(s)));const n=p.getCrossSigningCacheCallbacks();g.append("cross_signing_master_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("master")))),g.append("cross_signing_self_signing_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("self_signing")))),g.append("cross_signing_user_signing_pk_cached",String(!(!n||!await n.getCrossSigningKeyCache("user_signing")))),g.append("secret_storage_ready",String(await p.isSecretStorageReady())),g.append("secret_storage_key_in_account",String(!!await s.hasKey())),g.append("session_backup_key_in_secret_storage",String(!!await p.isKeyBackupKeyStored()));const a=await p._crypto.getSessionBackupPrivateKey();g.append("session_backup_key_cached",String(!!a)),g.append("session_backup_key_well_formed",String(a instanceof Uint8Array))}e.label&&g.append("label",e.label);const f=h.a.getFeatureSettingNames().filter(e=>h.a.getValue(e));if(f.length&&g.append("enabled_labs",f.join(", ")),h.a.getValue("lowBandwidth")&&g.append("lowBandwidth","enabled"),navigator.storage&&navigator.storage.persisted)try{g.append("storageManager_persisted",String(await navigator.storage.persisted()))}catch(e){}else if(document.hasStorageAccess)try{g.append("storageManager_persisted",String(await document.hasStorageAccess()))}catch(e){}if(navigator.storage&&navigator.storage.estimate)try{const e=await navigator.storage.estimate();g.append("storageManager_quota",String(e.quota)),g.append("storageManager_usage",String(e.usage)),e.usageDetails&&Object.keys(e.usageDetails).forEach(t=>{g.append("storageManager_usage_"+t,String(e.usageDetails[t]))})}catch(e){}if(window.Modernizr){const e=Object.keys(window.Modernizr).filter(e=>!1===window.Modernizr[e]);e.length>0&&g.append("modernizr_missing_features",e.join(", "))}if(g.append("mx_local_settings",localStorage.getItem("mx_local_settings")),e.sendLogs){s(Object(r.a)("Collecting logs"));const e=await d.c();for(const s of e){let e=(new u).encode(s.lines);t&&(e=a.a.gzip(e)),g.append("compressed-log",new Blob([e]),s.id)}}return g}async function g(e,t={}){if(!e)throw new Error("No bug report endpoint has been set.");const s=t.progressCallback||(()=>{}),n=await p(t);s(Object(r.a)("Uploading logs")),await function(e,t,s){return new Promise((n,a)=>{const i=new XMLHttpRequest;i.open("POST",e),i.timeout=3e5,i.onreadystatechange=function(){if(i.readyState===XMLHttpRequest.LOADING)s(Object(r.a)("Waiting for response from server"));else if(i.readyState===XMLHttpRequest.DONE){if(i.status<200||i.status>=400)return void a(new Error("HTTP "+i.status));n()}},i.send(t)})}(e,n,s)}async function f(e={}){const t=e.progressCallback||(()=>{}),s=await p(e,!1);t(Object(r.a)("Downloading logs"));let n="";const a=new c.a;let i=0;for(const[e,t]of s.entries())"compressed-log"===e?await new Promise(e=>{const s=new FileReader;s.addEventListener("loadend",t=>{a.append(`log-${i++}.log`,(new TextDecoder).decode(t.target.result)),e()}),s.readAsArrayBuffer(t)}):n+=`${e} = ${t}\n`;a.append("issue.txt",n);const o=document.createElement("a");o.href="data:application/octet-stream;base64,"+btoa(function(e){let t="";for(let s=0;s<e.length;s+=1)t+=String.fromCharCode(e[s]);return t}(a.out)),o.download="rageshake.tar",document.body.appendChild(o),o.click(),document.body.removeChild(o)}u||(u=m.TextEncoder)},,,,,,,function(e,t){e.exports="img/tchap/encryption-informations-dialog/login-logo.3b0f9a5.svg"},function(e,t){e.exports="img/tchap/tchap-logo.a5d01a3.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return g}));var n=s(82),a=s.n(n),i=s(81),o=s(90),r=s.n(o),l=s(87),c=s(83),d=s(99),m=s(91),h=s(94),u=s(150),p=s(640);class g extends i.PureComponent{constructor(t){super(t),a()(this,"dispatcherRef",void 0),a()(this,"inputRef",Object(i.createRef)()),a()(this,"searchFilter",new p.a),a()(this,"onAction",e=>{"view_room"===e.action&&e.clear_search?this.clearInput():"focus_room_filter"===e.action&&this.inputRef.current&&this.inputRef.current.focus()}),a()(this,"clearInput",()=>{this.inputRef.current&&(this.inputRef.current.value="",this.onChange())}),a()(this,"openSearch",()=>{l.a.dispatch({action:"show_left_panel"}),l.a.dispatch({action:"focus_room_filter"})}),a()(this,"onChange",()=>{this.inputRef.current&&this.setState({query:this.inputRef.current.value})}),a()(this,"onFocus",e=>{this.setState({focused:!0}),e.target.select()}),a()(this,"onBlur",e=>{this.setState({focused:!1})}),a()(this,"onKeyDown",t=>{if(t.key===d.a.ESCAPE)this.clearInput(),l.a.fire(h.a.FocusComposer);else if(t.key===d.a.ARROW_UP||t.key===d.a.ARROW_DOWN)this.props.onVerticalArrow(t);else if(t.key===d.a.ENTER){this.props.onEnter(t)&&e(()=>{this.clearInput()})}}),this.state={query:"",focused:!1},this.dispatcherRef=l.a.register(this.onAction)}componentDidUpdate(e,t){if(t.query!==this.state.query){const e=!!this.searchFilter.search.trim(),t=!!this.state.query.trim();this.searchFilter.search=this.state.query,!e&&t?u.b.instance.addFilter(this.searchFilter):e&&!t&&u.b.instance.removeFilter(this.searchFilter)}}componentWillUnmount(){l.a.unregister(this.dispatcherRef)}render(){const e=r()({mx_RoomSearch:!0,mx_RoomSearch_hasQuery:this.state.query,mx_RoomSearch_focused:this.state.focused,mx_RoomSearch_minimized:this.props.isMinimized}),t=r()({mx_RoomSearch_input:!0,mx_RoomSearch_inputExpanded:this.state.query||this.state.focused});let s=i.createElement("div",{className:"mx_RoomSearch_icon"}),n=i.createElement("input",{type:"text",ref:this.inputRef,className:t,value:this.state.query,onFocus:this.onFocus,onBlur:this.onBlur,onChange:this.onChange,onKeyDown:this.onKeyDown,placeholder:Object(c.a)("Filter"),autoComplete:"off"}),a=i.createElement(m.a,{tabIndex:-1,title:Object(c.a)("Clear filter"),className:"mx_RoomSearch_clearButton",onClick:this.clearInput});return this.props.isMinimized&&(s=i.createElement(m.a,{title:Object(c.a)("Filter rooms and people"),className:"mx_RoomSearch_icon mx_RoomSearch_minimizedHandle",onClick:this.openSearch}),n=null,a=null),i.createElement("div",{className:e},s,n,a)}}}).call(this,s(167).setImmediate)},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return v}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(112),d=s.n(c),m=s(85),h=s(83),u=s(92),p=s(122),g=s(86);function f(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function b(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?f(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):f(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class v extends o.a.Component{constructor(e){super(e);const t=this.parseWidgetUrl(),s=g.a.get().getRoom(this.props.roomId);let n;s&&(n=s.getMember(this.props.creatorUserId)),this.state=b(b({},t),{},{roomMember:n})}parseWidgetUrl(){const e=d.a.parse(this.props.url),t=new URLSearchParams(e.search);if(p.a.isScalarUrl(e)&&t&&t.get("url")){const e=d.a.parse(t.get("url"));return{widgetDomain:e.host||e.hostname,isWrapped:!0}}return{widgetDomain:e.host||e.hostname,isWrapped:!1}}render(){const e=u.a.get().brand,t=m.getComponent("views.elements.AccessibleButton"),s=m.getComponent("views.avatars.MemberAvatar"),n=m.getComponent("views.avatars.BaseAvatar"),a=m.getComponent("views.elements.TextWithTooltip"),i=this.state.roomMember?this.state.roomMember.name:this.props.creatorUserId,r=(i===this.props.creatorUserId||this.props.creatorUserId,this.state.roomMember?o.a.createElement(s,{member:this.state.roomMember,width:38,height:38}):o.a.createElement(n,{name:this.props.creatorUserId,width:38,height:38})),l=o.a.createElement("div",null,Object(h.a)("Any of the following data may be shared:"),o.a.createElement("ul",null,o.a.createElement("li",null,Object(h.a)("Your display name")),o.a.createElement("li",null,Object(h.a)("Your avatar URL")),o.a.createElement("li",null,Object(h.a)("Your user ID")),o.a.createElement("li",null,Object(h.a)("Your theme")),o.a.createElement("li",null,Object(h.a)("%(brand)s URL",{brand:e})),o.a.createElement("li",null,Object(h.a)("Room ID")),o.a.createElement("li",null,Object(h.a)("Widget ID")))),c=o.a.createElement(a,{tooltip:l,tooltipClass:"mx_AppPermissionWarning_tooltip mx_Tooltip_dark"},o.a.createElement("span",{className:"mx_AppPermissionWarning_helpIcon"})),d=this.state.isWrapped?Object(h.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s & your Integration Manager.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>c}):Object(h.a)("Using this widget may share data <helpIcon /> with %(widgetDomain)s.",{widgetDomain:this.state.widgetDomain},{helpIcon:()=>c}),p=this.props.isRoomEncrypted?Object(h.a)("Widgets do not use message encryption."):null;return o.a.createElement("div",{className:"mx_AppPermissionWarning"},o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_bolder mx_AppPermissionWarning_smallText"},Object(h.a)("Widget added by")),o.a.createElement("div",{className:"mx_AppPermissionWarning_row"},r,o.a.createElement("h4",{className:"mx_AppPermissionWarning_bolder"},i)),o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},d),o.a.createElement("div",{className:"mx_AppPermissionWarning_row mx_AppPermissionWarning_smallText"},Object(h.a)("This widget may use cookies.")," ",p),o.a.createElement("div",{className:"mx_AppPermissionWarning_row"},o.a.createElement(t,{kind:"primary_sm",onClick:this.props.onPermissionGranted},Object(h.a)("Continue"))))}}a()(v,"propTypes",{url:l.a.string.isRequired,creatorUserId:l.a.string.isRequired,roomId:l.a.string.isRequired,onPermissionGranted:l.a.func.isRequired,isRoomEncrypted:l.a.bool}),a()(v,"defaultProps",{onPermissionGranted:()=>{}})},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(84);const o=e=>a.a.createElement("div",{className:"mx_AppPermissionWarning"},a.a.createElement("div",{className:"mx_AppPermissionWarningImage"},a.a.createElement("img",{src:s(160),alt:""})),a.a.createElement("div",{className:"mx_AppPermissionWarningText"},a.a.createElement("span",{className:"mx_AppPermissionWarningTextLabel"},e.errorMsg)));o.propTypes={errorMsg:s.n(i).a.string},o.defaultProps={errorMsg:"Error"},t.a=o},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(85),m=s(143),h=s(137),u=s(681);class p extends o.a.Component{constructor(){super(),a()(this,"_onAllow",()=>{this._onPermissionSelection(!0)}),a()(this,"_onDeny",()=>{this._onPermissionSelection(!1)}),a()(this,"_onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),this.state={rememberSelection:!1}}_onPermissionSelection(e){this.state.rememberSelection&&(console.log(`Remembering ${this.props.widgetId} as allowed=${e} for OpenID`),u.b.instance.setOIDCState(this.props.widget,this.props.widgetKind,this.props.inRoomId,e?u.a.Allowed:u.a.Denied)),this.props.onFinished(e)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return o.a.createElement(e,{className:"mx_WidgetOpenIDPermissionsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(c.a)("Allow this widget to verify your identity")},o.a.createElement("div",{className:"mx_WidgetOpenIDPermissionsDialog_content"},o.a.createElement("p",null,Object(c.a)("The widget will verify your user ID, but won't be able to perform actions for you:")),o.a.createElement("p",{className:"text-muted"},this.props.widget.templateUrl.split("?")[0].split("#")[0])),o.a.createElement(t,{primaryButton:Object(c.a)("Continue"),onPrimaryButtonClick:this._onAllow,onCancel:this._onDeny,additive:o.a.createElement(m.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this._onRememberSelectionChange,label:Object(c.a)("Remember this")})}))}}a()(p,"propTypes",{onFinished:l.a.func.isRequired,widget:l.a.objectOf(h.Widget).isRequired,widgetKind:l.a.string.isRequired,inRoomId:l.a.string})},function(e,t,s){"use strict";s.d(t,"a",(function(){return c})),s.d(t,"b",(function(){return d}));var n=s(82),a=s.n(n),i=s(88),o=s(137),r=s(86),l=s(96);let c;!function(e){e[e.Allowed=0]="Allowed",e[e.Denied=1]="Denied",e[e.Unknown=2]="Unknown"}(c||(c={}));class d{constructor(){}static get instance(){return d.internalInstance||(d.internalInstance=new d),d.internalInstance}packSettingKey(e,t,s){let n=s;if(t!==o.WidgetKind.Room&&(n=r.a.get().getUserId()),t===o.WidgetKind.Modal&&(n="*MODAL*-"+n),!n)throw new Error("Failed to determine a location to check the widget's OIDC state with");return encodeURIComponent(`${n}::${e.templateUrl}`)}getOIDCState(e,t,s){var n,a;const o=this.packSettingKey(e,t,s),r=i.a.getValue("widgetOpenIDPermissions");return null!=r&&null!==(n=r.deny)&&void 0!==n&&n.includes(o)?c.Denied:null!=r&&null!==(a=r.allow)&&void 0!==a&&a.includes(o)?c.Allowed:c.Unknown}setOIDCState(e,t,s,n){const a=this.packSettingKey(e,t,s),o=i.a.getValue("widgetOpenIDPermissions");o.allow||(o.allow=[]),o.deny||(o.deny=[]),n===c.Allowed?o.allow.push(a):n===c.Denied?o.deny.push(a):(o.allow=o.allow.filter(e=>e!==a),o.deny=o.deny.filter(e=>e!==a)),i.a.setValue("widgetOpenIDPermissions",null,l.a.DEVICE,o)}}a()(d,"internalInstance",void 0)},function(e,t,s){"use strict";let n;s.d(t,"a",(function(){return n})),function(e){e.CanChangeViewedRoom="io.element.view_room"}(n||(n={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(82),a=s.n(n),i=s(81),o=s(131),r=s(83),l=s(91),c=s(137),d=s(762),m=s(86),h=s(204),u=s(120),p=s(769);function g(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function f(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?g(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):g(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class b extends i.PureComponent{constructor(e){super(e),a()(this,"widget",void 0),a()(this,"possibleButtons",void 0),a()(this,"appFrame",i.createRef()),a()(this,"state",{disabledButtonIds:[]}),a()(this,"onReady",()=>{this.state.messaging.sendWidgetConfig(this.props.widgetDefinition)}),a()(this,"onLoad",()=>{this.state.messaging.once("ready",this.onReady),this.state.messaging.on("action:"+c.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.on("action:"+c.WidgetApiFromWidgetAction.SetModalButtonEnabled,this.onButtonEnableToggle)}),a()(this,"onWidgetClose",e=>{this.props.onFinished(!0,e.detail.data)}),a()(this,"onButtonEnableToggle",e=>{e.preventDefault();if(e.detail.data.button===c.BuiltInModalButtonID.Close||!this.possibleButtons.includes(e.detail.data.button))return this.state.messaging.transport.reply(e.detail,{error:{message:"Invalid button"}});let t;if(e.detail.data.enabled)t=Object(u.c)(this.state.disabledButtonIds).filter(t=>t!==e.detail.data.button);else{const s=new Set(this.state.disabledButtonIds);s.add(e.detail.data.button),t=Array.from(s)}this.setState({disabledButtonIds:t}),this.state.messaging.transport.reply(e.detail,{})}),this.widget=new p.a(f(f({},this.props.widgetDefinition),{},{creatorUserId:m.a.get().getUserId(),id:"modal_"+this.props.sourceWidgetId})),this.possibleButtons=(this.props.widgetDefinition.buttons||[]).map(e=>e.id)}componentDidMount(){const e=new d.a([],this.widget,c.WidgetKind.Modal),t=new c.ClientWidgetApi(this.widget,this.appFrame.current,e);this.setState({messaging:t})}componentWillUnmount(){this.state.messaging.off("ready",this.onReady),this.state.messaging.off("action:"+c.WidgetApiFromWidgetAction.CloseModalWidget,this.onWidgetClose),this.state.messaging.stop()}render(){const e=this.widget.getCompleteUrl({widgetRoomId:this.props.widgetRoomId,currentUserId:m.a.get().getUserId(),userDisplayName:h.a.instance.displayName,userHttpAvatarUrl:h.a.instance.getHttpAvatarUrl()}),t=new URL(e);t.searchParams.set("widgetId",this.widget.id),t.searchParams.set("parentUrl",window.location.href.split("#",2)[0]);const n=t.toString().replace(/%24/g,"$");let a;return this.props.widgetDefinition.buttons&&(a=this.props.widgetDefinition.buttons.slice(0,3).reverse().map(e=>{let t="secondary";switch(e.kind){case c.ModalButtonKind.Primary:t="primary";break;case c.ModalButtonKind.Secondary:t="primary_outline";break;case c.ModalButtonKind.Danger:t="danger"}const s=this.state.disabledButtonIds.includes(e.id);return i.createElement(l.a,{key:e.id,kind:t,onClick:()=>{this.state.messaging.notifyModalWidgetButtonClicked(e.id)},disabled:s},e.label)})),i.createElement(o.a,{title:this.props.widgetDefinition.name||Object(r.a)("Modal Widget"),className:"mx_ModalWidgetDialog",contentId:"mx_Dialog_content",onFinished:this.props.onFinished},i.createElement("div",{className:"mx_ModalWidgetDialog_warning"},i.createElement("img",{src:s(1165),height:"16",width:"16",alt:""}),Object(r.a)("Data on this screen is shared with %(widgetDomain)s",{widgetDomain:t.hostname})),i.createElement("div",null,i.createElement("iframe",{ref:this.appFrame,sandbox:"allow-forms allow-scripts allow-same-origin",src:n,onLoad:this.onLoad})),i.createElement("div",{className:"mx_ModalWidgetDialog_buttons"},a))}}},function(e,t){e.exports="img/tchap/logo_rep_fr_v2.db94623.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82),a=s.n(n);class i{constructor(e,t,s){this.resizer=t,this.sizer=s,a()(this,"domNode",void 0),a()(this,"id",void 0),a()(this,"reverse",void 0),this.reverse=t.isReverseResizeHandle(e),this.domNode=this.reverse?e.nextElementSibling:e.previousElementSibling,this.id=e.getAttribute("data-id")}copyWith(e,t,s){return new(0,this.constructor)(e,t,s)}advance(e){let t=this.reverse?this.domNode.previousElementSibling:this.domNode.nextElementSibling;const s=e!==this.reverse;do{t=s?t.nextElementSibling:t.previousElementSibling}while(t&&!this.resizer.isResizeHandle(t));if(t){const e=this.copyWith(t,this.resizer,this.sizer);return e.reverse=this.reverse,e}}next(){return this.advance(!0)}previous(){return this.advance(!1)}size(){return this.sizer.getItemSize(this.domNode)}offset(){return this.sizer.getItemOffset(this.domNode)}start(){this.sizer.start(this.domNode)}finish(){this.sizer.finish(this.domNode)}getSize(){return this.sizer.getDesiredItemSize(this.domNode)}setRawSize(e){this.sizer.setItemSize(this.domNode,e)}setSize(e){this.setRawSize(Math.round(e)+"px");const t=this.resizer.config.onResized;t&&t(e,this.id,this.domNode)}clearSize(){this.sizer.clearItemSize(this.domNode);const e=this.resizer.config.onResized;e&&e(null,this.id,this.domNode)}first(){const e=Array.from(this.domNode.parentElement.children).find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}last(){const e=Array.from(this.domNode.parentElement.children).reverse().find(e=>this.resizer.isResizeHandle(e));if(e)return this.copyWith(e,this.resizer,this.sizer)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e,t,s){this.container=e,this.vertical=t,this.reverse=s}getItemOffset(e){const t=(this.vertical?e.offsetTop:e.offsetLeft)-this.getOffset();return this.reverse?this.getTotalSize()-(t+this.getItemSize(e)):t}getItemSize(e){return this.vertical?e.offsetHeight:e.offsetWidth}getTotalSize(){return this.vertical?this.container.offsetHeight:this.container.offsetWidth}getOffset(){return this.vertical?this.container.offsetTop:this.container.offsetLeft}getPageOffset(){let e=this.container,t=0;for(;e;){t+=this.vertical?e.offsetTop:e.offsetLeft,e=e.offsetParent}return t}getDesiredItemSize(e){return this.vertical?e.style.height:e.style.width}setItemSize(e,t){this.vertical?e.style.height=t:e.style.width=t}clearItemSize(e){this.vertical?e.style.height=null:e.style.width=null}start(e){}finish(e){}offsetFromEvent(e){const t=this.vertical?e.pageY:e.pageX;return this.reverse?this.getPageOffset()+this.getTotalSize()-t:t-this.getPageOffset()}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return d})),s.d(t,"b",(function(){return m}));var n=s(82),a=s.n(n),i=s(90),o=s.n(i),r=s(81),l=s.n(r),c=s(88);let d;!function(e){e[e.Local=0]="Local",e[e.Remote=1]="Remote"}(d||(d={}));class m extends l.a.Component{constructor(...e){super(...e),a()(this,"vid",Object(r.createRef)()),a()(this,"onResize",e=>{this.props.onResize&&this.props.onResize(e)})}componentDidMount(){this.vid.current.addEventListener("resize",this.onResize),this.setVideoElement()}componentDidUpdate(e){this.props.call!==e.call&&this.setVideoElement()}componentWillUnmount(){this.vid.current.removeEventListener("resize",this.onResize)}setVideoElement(){this.props.type===d.Local?this.props.call.setLocalVideoElement(this.vid.current):this.props.call.setRemoteVideoElement(this.vid.current)}render(){const e={mx_VideoFeed:!0,mx_VideoFeed_local:this.props.type===d.Local,mx_VideoFeed_remote:this.props.type===d.Remote,mx_VideoFeed_mirror:this.props.type===d.Local&&c.a.getValue("VideoView.flipVideoHorizontally")};let t={};return this.props.maxHeight&&(t={maxHeight:this.props.maxHeight}),l.a.createElement("video",{className:o()(e),ref:this.vid,style:t})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(102),m=s(141),h=s(336),u=s(89);class p extends o.a.Component{constructor(e){super(e),a()(this,"onHoldClick",()=>{this.props.call.setRemoteOnHold(!0),this.props.onFinished()}),a()(this,"onUnholdClick",()=>{m.b.sharedInstance().setActiveCallRoomId(this.props.call.roomId),this.props.onFinished()}),a()(this,"onTransferClick",()=>{u.a.createTrackedDialog("Transfer Call","",h.d,{kind:h.a,call:this.props.call},null,!1,!0),this.props.onFinished()})}render(){const e=this.props.call.isRemoteOnHold()?Object(c.a)("Resume"):Object(c.a)("Hold"),t=this.props.call.isRemoteOnHold()?this.onUnholdClick:this.onHoldClick;let s;return this.props.call.opponentCanBeTransferred()&&(s=o.a.createElement(d.f,{className:"mx_CallContextMenu_item",onClick:this.onTransferClick},Object(c.a)("Transfer"))),o.a.createElement(d.b,this.props,o.a.createElement(d.f,{className:"mx_CallContextMenu_item",onClick:t},e),s)}}a()(p,"propTypes",{user:l.a.object})},function(e,t,s){"use strict";s.d(t,"a",(function(){return d}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(83),l=s(102),c=s(469);class d extends o.a.Component{constructor(e){super(e),a()(this,"onDigitPress",e=>{this.props.call.sendDtmfDigit(e),this.setState({value:this.state.value+e})}),this.state={value:""}}render(){return o.a.createElement(l.b,this.props,o.a.createElement("div",{className:"mx_DialPadContextMenu_header"},o.a.createElement("div",null,o.a.createElement("span",{className:"mx_DialPadContextMenu_title"},Object(r.a)("Dial pad"))),o.a.createElement("div",{className:"mx_DialPadContextMenu_dialled"},this.state.value)),o.a.createElement("div",{className:"mx_DialPadContextMenu_horizSep"}),o.a.createElement("div",{className:"mx_DialPadContextMenu_dialPad"},o.a.createElement(c.a,{onDigitPress:this.onDigitPress,hasDialAndDelete:!1})))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(6),a=s(106);class i extends n.EventEmitter{constructor(){super(),this._throttledMiddlePanel=Object(a.throttle)(()=>this.emit("middlePanelResized"),200),this._isResizing=!1}get isResizing(){return this._isResizing}startResizing(){this._isResizing=!0,this.emit("isResizing",!0)}stopResizing(){this._isResizing=!1,this.emit("isResizing",!1)}_noisyMiddlePanel(){this.emit("middlePanelResizedNoisy")}_updateMiddlePanel(){this._throttledMiddlePanel(),this._noisyMiddlePanel()}notifyLeftHandleResized(){this._updateMiddlePanel()}notifyRightHandleResized(){this._updateMiddlePanel()}notifyTimelineHeightChanged(){this._updateMiddlePanel()}notifyWindowResized(){this.emit("leftPanelResized"),this._updateMiddlePanel()}}},function(e,t,s){"use strict";s.d(t,"c",(function(){return g})),s.d(t,"a",(function(){return f})),s.d(t,"d",(function(){return b})),s.d(t,"b",(function(){return v}));var n=s(86),a=s(87),i=s(89),o=s(85),r=s(83),l=s(123),c=s(151),d=s(175),m=s(318),h=s(94);async function u(){const e=n.a.get();if(!e.isCryptoEnabled())return!1;return!!e.getCrossSigningId("user_signing")||(await Object(d.b)(),!1)}function p(e){const{device:t,user:a,onFinished:i}=e,l=o.getComponent("dialogs.BaseDialog"),c=o.getComponent("elements.AccessibleButton");let d,m;return n.a.get().getUserId()===a.userId?(m=Object(r.a)("You signed in to a new session without verifying it:"),d=Object(r.a)("Verify your other session using one of the options below.")):(m=Object(r.a)("%(name)s (%(userId)s) signed in to a new session without verifying it:",{name:a.displayName,userId:a.userId}),d=Object(r.a)("Ask this user to verify their session, or manually verify it below.")),React.createElement(l,{onFinished:i,headerImage:s(348),title:Object(r.a)("Not Trusted")},React.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},React.createElement("p",null,m),React.createElement("p",null,t.getDisplayName()," (",t.deviceId,")"),React.createElement("p",null,d)),React.createElement("div",{className:"mx_Dialog_buttons"},React.createElement(c,{element:"button",kind:"secondary",onClick:()=>i("legacy")},Object(r.a)("Manually Verify by Text")),React.createElement(c,{element:"button",kind:"secondary",onClick:()=>i("sas")},Object(r.a)("Interactively verify by Emoji")),React.createElement(c,{kind:"primary",onClick:()=>i()},Object(r.a)("Done"))))}async function g(e,t){const s=n.a.get();s.isGuest()?a.a.dispatch({action:"require_registration"}):s.getCryptoTrustCrossSignedDevices()&&!await u()||i.a.createTrackedDialog("Verification warning","unverified session",p,{user:e,device:t,onFinished:async n=>{if("sas"===n){const n=s.legacyDeviceVerification(e.userId,t.deviceId,m.d.SAS);a.a.dispatch({action:h.a.SetRightPanelPhase,phase:l.b.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:n}})}else if("legacy"===n){const s=o.getComponent("dialogs.ManualDeviceKeyVerificationDialog");i.a.createTrackedDialog("Legacy verify session","legacy verify session",s,{userId:e.userId,device:t})}}})}async function f(e){const t=n.a.get();if(t.isGuest())return void a.a.dispatch({action:"require_registration"});if(t.getCryptoTrustCrossSignedDevices()&&!await u())return;const s=t.requestVerification(e.userId);a.a.dispatch({action:h.a.SetRightPanelPhase,phase:l.b.EncryptionPanel,refireParams:{member:e,verificationRequestPromise:s}})}async function b(e){if(n.a.get().isGuest())return void a.a.dispatch({action:"require_registration"});if(!await u())return;const t=v(e);a.a.dispatch({action:h.a.SetRightPanelPhase,phase:l.b.EncryptionPanel,refireParams:{member:e,verificationRequest:t}})}function v(e){const t=n.a.get(),s=Object(c.d)(t,e.userId);if(s)return t.findVerificationRequestDMInProgress(s.roomId)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(81),a=s(146);function i(e,t){const[s,i]=Object(n.useState)(t?e.isRoomEncrypted(t.roomId):void 0),o=Object(n.useCallback)(s=>{t&&"m.room.encryption"===s.getType()&&i(e.isRoomEncrypted(t.roomId))},[e,t]);return Object(a.a)(t?t.currentState:void 0,"RoomState.events",o),s}},,,,,function(e,t){e.exports="img/tchap/warning.51721d3.svg"},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(97),o=s(218),r=s(122),l=s(291),c=s(83),d=s(491),m=s(123),h=s(87),u=s(94),p=s(102),g=s(353),f=s(173);t.a=({room:e,widgetId:t,onClose:s})=>{const b=Object(n.useContext)(i.a),v=Object(d.b)(e).find(e=>e.id===t),_=v&&f.d.instance.isInContainer(e,v,f.a.Top),[y,E,C,w]=Object(p.q)();if(Object(n.useEffect)(()=>{v&&!_||h.a.dispatch({action:u.a.SetRightPanelPhase,phase:m.b.RoomSummary})},[v,_]),!v||_)return null;let S;if(y){const e=E.current.getBoundingClientRect();S=a.a.createElement(g.a,{chevronFace:p.a.None,right:window.innerWidth-e.right-12,top:e.bottom+12,onFinished:w,app:v})}const x=a.a.createElement(a.a.Fragment,null,a.a.createElement("h2",null,r.a.getWidgetName(v)),a.a.createElement(p.c,{kind:"secondary",className:"mx_WidgetCard_optionsButton",inputRef:E,onClick:C,isExpanded:y,label:Object(c.a)("Options")}),S);return a.a.createElement(o.b,{header:x,className:"mx_WidgetCard",onClose:s,previousPhase:m.b.RoomSummary,withoutScrollContainer:!0},a.a.createElement(l.a,{app:v,fullWidth:!0,show:!0,showMenubar:!1,room:e,userId:b.getUserId(),creatorUserId:v.creatorUserId,widgetPageTitle:r.a.getWidgetDataTitle(v),waitForIframeLoad:v.waitForIframeLoad}))}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a})),s.d(t,"b",(function(){return i}));var n=s(109);let a;async function i(e,t){const s=(await t.getEncryptionTargetMembers()).map(({userId:e})=>e),i=!!n.a.shared().getUserIdForRoomId(t.roomId),o=[],r=[];s.filter(t=>t!==e.getUserId()).forEach(t=>{(e.checkUserTrust(t).isCrossSigningVerified()?o:r).push(t)});for(const t of r)if(e.checkUserTrust(t).wasCrossSigningVerified())return a.Warning;const l=o.length>0&&!i&&2!==s.length||1===s.length?[...o,e.getUserId()]:o;for(const t of l){if(e.getStoredDevicesForUser(t).some(({deviceId:s})=>!e.checkDeviceTrust(t,s).isVerified()))return a.Warning}return 0===r.length?a.Verified:a.Normal}!function(e){e.Warning="warning",e.Verified="verified",e.Normal="normal"}(a||(a={}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(99),d=s(250),m=s(119);let h;h=function(){};class u extends o.a.Component{constructor(e){super(e),a()(this,"onScroll",e=>{this.props.resizeNotifier&&this.props.resizeNotifier.isResizing||(h("onScroll",this._getScrollNode().scrollTop),this._scrollTimeout.restart(),this._saveScrollState(),this.updatePreventShrinking(),this.props.onScroll(e),this.checkFillState())}),a()(this,"onResize",()=>{h("onResize"),this.checkScroll(),this.preventShrinkingState&&this.preventShrinking()}),a()(this,"checkScroll",()=>{this.unmounted||(this._restoreSavedScrollState(),this.checkFillState())}),a()(this,"isAtBottom",()=>{const e=this._getScrollNode();return Math.abs(e.scrollHeight-(e.scrollTop+e.clientHeight))<=1}),a()(this,"checkFillState",async(e=0)=>{if(this.unmounted)return;const t=0===e,s=this._getScrollNode();if(t){if(this._isFilling)return h("_isFilling: not entering while request is ongoing, marking for a subsequent request"),void(this._fillRequestWhileRunning=!0);h("_isFilling: setting"),this._isFilling=!0}const n=this._itemlist.current,a=n&&n.firstElementChild,i=a&&a.offsetTop,o=[];if((!a||s.scrollTop-i<s.clientHeight)&&o.push(this._maybeFill(e,!0)),s.scrollHeight-s.scrollTop<2*s.clientHeight&&o.push(this._maybeFill(e,!1)),o.length)try{await Promise.all(o)}catch(e){console.error(e)}t&&(h("_isFilling: clearing"),this._isFilling=!1),this._fillRequestWhileRunning&&(this._fillRequestWhileRunning=!1,this.checkFillState())}),a()(this,"getScrollState",()=>this.scrollState),a()(this,"resetScrollState",()=>{this.scrollState={stuckAtBottom:this.props.startAtBottom},this._bottomGrowth=0,this._pages=0,this._scrollTimeout=new d.a(100),this._heightUpdateInProgress=!1}),a()(this,"scrollToTop",()=>{this._getScrollNode().scrollTop=0,this._saveScrollState()}),a()(this,"scrollToBottom",()=>{const e=this._getScrollNode();e.scrollTop=e.scrollHeight,this._saveScrollState()}),a()(this,"scrollRelative",e=>{const t=this._getScrollNode(),s=e*t.clientHeight*.5;t.scrollBy(0,s),this._saveScrollState()}),a()(this,"handleScrollKey",e=>{switch(e.key){case c.a.PAGE_UP:e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollRelative(-1);break;case c.a.PAGE_DOWN:e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollRelative(1);break;case c.a.HOME:!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollToTop();break;case c.a.END:!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||this.scrollToBottom()}}),a()(this,"scrollToToken",(e,t,s)=>{t=t||0,s=s||0,this.scrollState={stuckAtBottom:!1,trackedScrollToken:e};const n=this._getTrackedNode(),a=this._getScrollNode();n&&(h("scrollToken: setting scrollTop",{offsetBase:s,pixelOffset:t,offsetTop:n.offsetTop}),a.scrollTop=n.offsetTop-a.clientHeight*s+t,this._saveScrollState())}),a()(this,"_collectScroll",e=>{this._divScroll=e}),a()(this,"preventShrinking",()=>{const e=this._itemlist.current,t=e&&e.children;if(!e)return;let s;for(let e=t.length-1;e>=0;e--){const n=t[e];if(n.dataset.scrollTokens){s=n;break}}if(!s)return;this.clearPreventShrinking();const n=e.clientHeight-(s.offsetTop+s.clientHeight);this.preventShrinkingState={offsetFromBottom:n,offsetNode:s},h("prevent shrinking, last tile ",n,"px from bottom")}),a()(this,"clearPreventShrinking",()=>{const e=this._itemlist.current,t=e&&e.parentElement;t&&(t.style.paddingBottom=null),this.preventShrinkingState=null,h("prevent shrinking cleared")}),a()(this,"updatePreventShrinking",()=>{if(this.preventShrinkingState){const e=this._getScrollNode(),t=this.scrollState,s=this._itemlist.current,{offsetNode:n,offsetFromBottom:a}=this.preventShrinkingState,i=s.parentElement;let o=!n.parentElement;if(!o&&!t.stuckAtBottom){o=e.scrollHeight-(e.scrollTop+e.clientHeight)>=200}if(!o){const e=a-(s.clientHeight-(n.offsetTop+n.clientHeight));e>0?(i.style.paddingBottom=e+"px",h("update prevent shrinking ",e,"px from bottom")):e<0&&(o=!0)}o&&this.clearPreventShrinking()}}),this._pendingFillRequests={b:null,f:null},this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResizedNoisy",this.onResize),this.resetScrollState(),this._itemlist=Object(i.createRef)()}componentDidMount(){this.checkScroll()}componentDidUpdate(){this.checkScroll(),this.updatePreventShrinking()}componentWillUnmount(){this.unmounted=!0,this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResizedNoisy",this.onResize)}_getExcessHeight(e){const t=this._getScrollNode(),s=this._getMessagesHeight(),n=s-this._getListHeight(),a=t.scrollTop+n;return e?a-t.clientHeight-6e3:s-(a+2*t.clientHeight)-6e3}_checkUnfillState(e){let t=this._getExcessHeight(e);if(t<=0)return;const s=t,n=this._itemlist.current.children;let a,i=null;for(let s=0;s<n.length&&(a=n[e?s:n.length-1-s],t-=a.clientHeight,!(a.clientHeight>t));s++)a.dataset.scrollTokens&&(i=a.dataset.scrollTokens.split(",")[0]);i&&(this._unfillDebouncer&&clearTimeout(this._unfillDebouncer),this._unfillDebouncer=setTimeout(()=>{this._unfillDebouncer=null,h("unfilling now",e,s),this.props.onUnfillRequest(e,i)},200))}_maybeFill(e,t){const s=t?"b":"f";if(!this._pendingFillRequests[s])return h("starting "+s+" fill"),this._pendingFillRequests[s]=!0,new Promise(e=>setTimeout(e,1)).then(()=>this.props.onFillRequest(t)).finally(()=>{this._pendingFillRequests[s]=!1}).then(n=>{if(!this.unmounted)return this._checkUnfillState(!t),h(s+" fill complete; hasMoreResults:"+n),n?this.checkFillState(e+1):void 0});h("Already a "+s+" fill in progress - not starting another")}_saveScrollState(){if(this.props.stickyBottom&&this.isAtBottom())return this.scrollState={stuckAtBottom:!0},void h("saved stuckAtBottom state");const e=this._getScrollNode(),t=e.scrollHeight-(e.scrollTop+e.clientHeight),s=this._itemlist.current.children;let n=null;for(let e=s.length-1;e>=0&&!(s[e].dataset.scrollTokens&&(n=s[e],this._topFromBottom(n)>t));--e);if(!n)return void h("unable to save scroll state: found no children in the viewport");const a=n.dataset.scrollTokens.split(",")[0];h("saving anchored scroll state to message",n&&n.innerText,a);const i=this._topFromBottom(n);this.scrollState={stuckAtBottom:!1,trackedNode:n,trackedScrollToken:a,bottomOffset:i,pixelOffset:i-t}}async _restoreSavedScrollState(){const e=this.scrollState;if(e.stuckAtBottom){const e=this._getScrollNode();e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight)}else if(e.trackedScrollToken){const t=this._itemlist.current,s=this._getTrackedNode();if(s){const n=this._topFromBottom(s),a=n-e.bottomOffset;this._bottomGrowth+=a,e.bottomOffset=n;const i=this._getListHeight()+"px";t.style.height!==i&&(t.style.height=i),h("balancing height because messages below viewport grew by",a)}}if(this._heightUpdateInProgress)h("not updating height because request already in progress");else{this._heightUpdateInProgress=!0;try{await this._updateHeight()}finally{this._heightUpdateInProgress=!1}}}async _updateHeight(){if(this._scrollTimeout.isRunning()?(h("updateHeight waiting for scrolling to end ... "),await this._scrollTimeout.finished()):h("updateHeight getting straight to business, no scrolling going on."),this.unmounted)return;const e=this._getScrollNode(),t=this._itemlist.current,s=this._getMessagesHeight(),n=e.clientHeight,a=Math.max(n,s);this._pages=Math.ceil(a/400),this._bottomGrowth=0;const i=this._getListHeight()+"px",o=this.scrollState;if(o.stuckAtBottom)t.style.height!==i&&(t.style.height=i),e.scrollTop!==e.scrollHeight&&(e.scrollTop=e.scrollHeight),h("updateHeight to",i);else if(o.trackedScrollToken){const s=this._getTrackedNode();if(s){const n=s.offsetTop;t.style.height!==i&&(t.style.height=i);const a=s.offsetTop-n;e.scrollBy(0,a),h("updateHeight to",{newHeight:i,topDiff:a})}}}_getTrackedNode(){const e=this.scrollState,t=e.trackedNode;if(!t||!t.parentElement){let t;const s=this._itemlist.current.children,n=e.trackedScrollToken;for(let e=s.length-1;e>=0;--e){const a=s[e];if(a.dataset.scrollTokens&&-1!==a.dataset.scrollTokens.split(",").indexOf(n)){t=a;break}}t&&h("had to find tracked node again for "+e.trackedScrollToken),e.trackedNode=t}if(e.trackedNode)return e.trackedNode;h("No node with ; '"+e.trackedScrollToken+"'")}_getListHeight(){return this._bottomGrowth+400*this._pages}_getMessagesHeight(){const e=this._itemlist.current,t=e.lastElementChild;return(t?t.offsetTop+t.clientHeight:0)-(e.firstElementChild?e.firstElementChild.offsetTop:0)+36}_topFromBottom(e){return this._itemlist.current.clientHeight-e.offsetTop}_getScrollNode(){if(this.unmounted)throw new Error("ScrollPanel._getScrollNode called when unmounted");if(!this._divScroll)throw new Error("ScrollPanel._getScrollNode called before AutoHideScrollbar ref collected");return this._divScroll}render(){return o.a.createElement(m.a,{wrappedRef:this._collectScroll,onScroll:this.onScroll,className:"mx_ScrollPanel "+this.props.className,style:this.props.style},this.props.fixedChildren,o.a.createElement("div",{className:"mx_RoomView_messageListWrapper"},o.a.createElement("ol",{ref:this._itemlist,className:"mx_RoomView_MessageList","aria-live":"polite",role:"list"},this.props.children)))}}a()(u,"propTypes",{stickyBottom:l.a.bool,startAtBottom:l.a.bool,onFillRequest:l.a.func,onUnfillRequest:l.a.func,onScroll:l.a.func,className:l.a.string,style:l.a.object,resizeNotifier:l.a.object,fixedChildren:l.a.node}),a()(u,"defaultProps",{stickyBottom:!0,startAtBottom:!0,onFillRequest:function(e){return Promise.resolve(!1)},onUnfillRequest:function(e,t){},onScroll:function(){}})},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(88),o=s(81),r=s.n(o),l=s(139),c=s.n(l),d=s(84),m=s.n(d),h=s(95),u=s(83),p=s(86),g=s(343),f=s(451),b=s(89),v=s(87),_=s(85),y=s(99),E=s(250),C=s(269),w=s(702),S=s(208),x=s(108);let R=function(){};class O extends r.a.Component{constructor(e){super(e),a()(this,"onMessageListUnfillRequest",(e,t)=>{const s=e?h.c.BACKWARDS:h.c.FORWARDS;R("TimelinePanel: unpaginating events in direction",s);const n=t,a=this.state.events.findIndex(e=>e.getId()===n),i=e?a+1:this.state.events.length-a;if(i>0){R("TimelinePanel: Unpaginating",i,"in direction",s),this._timelineWindow.unpaginate(i,e);const t=e?"canBackPaginate":"canForwardPaginate",{events:n,liveEvents:a,firstVisibleEventIndex:o}=this._getEvents();this.setState({[t]:!0,events:n,liveEvents:a,firstVisibleEventIndex:o})}}),a()(this,"onPaginationRequest",(e,t,s)=>this.props.onPaginationRequest?this.props.onPaginationRequest(e,t,s):e.paginate(t,s)),a()(this,"onMessageListFillRequest",e=>{if(!this._shouldPaginate())return Promise.resolve(!1);const t=e?h.c.BACKWARDS:h.c.FORWARDS,s=e?"canBackPaginate":"canForwardPaginate",n=e?"backPaginating":"forwardPaginating";return this.state[s]?this._timelineWindow.canPaginate(t)?e&&0!==this.state.firstVisibleEventIndex?(R("TimelinePanel: won't",t,"paginate past first visible event"),Promise.resolve(!1)):(R("TimelinePanel: Initiating paginate; backwards:"+e),this.setState({[n]:!0}),this.onPaginationRequest(this._timelineWindow,t,20).then(t=>{if(this.unmounted)return;R("TimelinePanel: paginate complete backwards:"+e+"; success:"+t);const{events:a,liveEvents:i,firstVisibleEventIndex:o}=this._getEvents(),r={[n]:!1,[s]:t,events:a,liveEvents:i,firstVisibleEventIndex:o},l=e?h.c.FORWARDS:h.c.BACKWARDS,c=e?"canForwardPaginate":"canBackPaginate";return!this.state[c]&&this._timelineWindow.canPaginate(l)&&(R("TimelinePanel: can now",l,"paginate again"),r[c]=!0),new Promise(s=>{this.setState(r,()=>{s(t&&(!e||0===o))})})})):(R("TimelinePanel: can't",t,"paginate any further"),this.setState({[s]:!1}),Promise.resolve(!1)):(R("TimelinePanel: have given up",t,"paginating this timeline"),Promise.resolve(!1))}),a()(this,"onMessageListScroll",e=>{if(this.props.onScroll&&this.props.onScroll(e),this.props.manageReadMarkers){const e=this.getReadMarkerPosition();e<0&&this.setState({readMarkerVisible:!0});const t=this._readMarkerTimeout(e);this._readMarkerActivityTimer.changeTimeout(t)}}),a()(this,"onAction",e=>{if("ignore_state_changed"===e.action&&this.forceUpdate(),"edit_event"===e.action){const t=e.event?new w.a(e.event):null;this.setState({editState:t},()=>{e.event&&this._messagePanel.current&&this._messagePanel.current.scrollToEventIfNeeded(e.event.getId())})}}),a()(this,"onRoomTimeline",(e,t,s,n,a)=>{a.timeline.getTimelineSet()===this.props.timelineSet&&!s&&a&&a.liveEvent&&this._messagePanel.current&&(this._messagePanel.current.getScrollState().stuckAtBottom?this._timelineWindow.paginate(h.c.FORWARDS,1,!1).then(()=>{if(this.unmounted)return;const{events:t,liveEvents:s,firstVisibleEventIndex:n}=this._getEvents(),a=s[s.length-1],i={events:t,liveEvents:s,firstVisibleEventIndex:n};let o;if(this.props.manageReadMarkers){const t=p.a.get().credentials.userId,s=e.sender?e.sender.userId:null;o=!1,s==t||f.a.sharedInstance().userActiveRecently()?a&&0===this.getReadMarkerPosition()&&(this._setReadMarker(a.getId(),a.getTs(),!0),i.readMarkerVisible=!1,i.readMarkerEventId=a.getId(),o=!0):i.readMarkerVisible=!0}this.setState(i,()=>{this._messagePanel.current.updateTimelineMinHeight(),o&&this.props.onReadMarkerUpdated()})}):this.setState({canForwardPaginate:!0}))}),a()(this,"onRoomTimelineReset",(e,t)=>{t===this.props.timelineSet&&this._messagePanel.current&&this._messagePanel.current.isAtBottom()&&this._loadTimeline()}),a()(this,"canResetTimeline",()=>this._messagePanel.current&&this._messagePanel.current.isAtBottom()),a()(this,"onRoomRedaction",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),a()(this,"onEventReplaced",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),a()(this,"onRoomReceipt",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&this.forceUpdate()}),a()(this,"onLocalEchoUpdated",(e,t,s)=>{this.unmounted||t===this.props.timelineSet.room&&this._reloadEvents()}),a()(this,"onAccountData",(e,t)=>{this.unmounted||t===this.props.timelineSet.room&&"m.fully_read"===e.getType()&&this.setState({readMarkerEventId:e.getContent().event_id},this.props.onReadMarkerUpdated)}),a()(this,"onEventDecrypted",e=>{this.props.timelineSet.room&&e.getRoomId()===this.props.timelineSet.room.roomId&&this.forceUpdate()}),a()(this,"onSync",(e,t,s)=>{this.setState({clientSyncState:e})}),a()(this,"sendReadReceipt",()=>{if(i.a.getValue("lowBandwidth"))return;if(!this._messagePanel.current)return;if(!this.props.manageReadReceipts)return;const e=p.a.get();if(!e||e.isGuest())return;let t=!0;const s=this._getCurrentReadReceipt(!0),n=this._indexForEventId(s);s&&null===n&&this._timelineWindow.canPaginate(h.c.FORWARDS)&&(t=!1);const a=this._getLastDisplayedEventIndex({ignoreOwn:!0});null===a&&(t=!1);let o=this.state.events[a];t=t&&a>n&&this.lastRRSentEventId!=o.getId();const r=this.lastRMSentEventId!=this.state.readMarkerEventId;(t||r)&&(t?this.lastRRSentEventId=o.getId():o=null,this.lastRMSentEventId=this.state.readMarkerEventId,R("TimelinePanel: Sending Read Markers for ",this.props.timelineSet.room.roomId,"rm",this.state.readMarkerEventId,o?"rr "+o.getId():""),p.a.get().setRoomReadMarkers(this.props.timelineSet.room.roomId,this.state.readMarkerEventId,o,{}).catch(e=>{if("M_UNRECOGNIZED"===e.errcode&&o)return p.a.get().sendReadReceipt(o,{}).catch(e=>{console.error(e),this.lastRRSentEventId=void 0});console.error(e),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0}),this.isAtEndOfLiveTimeline()&&(this.props.timelineSet.room.setUnreadNotificationCount("total",0),this.props.timelineSet.room.setUnreadNotificationCount("highlight",0),v.a.dispatch({action:"on_room_read",roomId:this.props.timelineSet.room.roomId})))}),a()(this,"updateReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(1===this.getReadMarkerPosition())return;const e=this._getLastDisplayedEventIndex({allowPartial:!0});if(null===e)return;const t=this.state.events[e];this._setReadMarker(t.getId(),t.getTs()),this.state.readMarkerVisible&&this.setState({readMarkerVisible:!1}),this.sendReadReceipt()}),a()(this,"jumpToLiveTimeline",()=>{this._timelineWindow.canPaginate(h.c.FORWARDS)?this._loadTimeline():this._messagePanel.current&&this._messagePanel.current.scrollToBottom()}),a()(this,"jumpToReadMarker",()=>{if(!this.props.manageReadMarkers)return;if(!this._messagePanel.current)return;if(!this.state.readMarkerEventId)return;null===this._messagePanel.current.getReadMarkerPosition()?this._loadTimeline(this.state.readMarkerEventId,0,1/3):this._messagePanel.current.scrollToEvent(this.state.readMarkerEventId,0,1/3)}),a()(this,"forgetReadMarker",()=>{if(!this.props.manageReadMarkers)return;const e=this._getCurrentReadReceipt(),t=this.props.timelineSet.getTimelineForEvent(e);let s;if(t){const n=t.getEvents().find(t=>t.getId()==e);n&&(s=n.getTs())}this._setReadMarker(e,s)}),a()(this,"isAtEndOfLiveTimeline",()=>this._messagePanel.current&&this._messagePanel.current.isAtBottom()&&this._timelineWindow&&!this._timelineWindow.canPaginate(h.c.FORWARDS)),a()(this,"getScrollState",()=>this._messagePanel.current?this._messagePanel.current.getScrollState():null),a()(this,"getReadMarkerPosition",()=>{if(!this.props.manageReadMarkers)return null;if(!this._messagePanel.current)return null;const e=this._messagePanel.current.getReadMarkerPosition();if(null!==e)return e;const t=O.roomReadMarkerTsMap[this.props.timelineSet.room.roomId];return t&&this.state.events.length>0?t<this.state.events[0].getTs()?-1:1:null}),a()(this,"canJumpToReadMarker",()=>{const e=this.getReadMarkerPosition();return null!==this.state.readMarkerEventId&&(e<0||null===e)}),a()(this,"handleScrollKey",e=>{this._messagePanel.current&&(!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||e.key!==y.a.END?this._messagePanel.current.handleScrollKey(e):this.jumpToLiveTimeline())}),a()(this,"getRelationsForEvent",(...e)=>this.props.timelineSet.getRelationsForEvent(...e)),R("TimelinePanel: mounting"),this.lastRRSentEventId=void 0,this.lastRMSentEventId=void 0,this._messagePanel=Object(o.createRef)();let t=null;if(this.props.manageReadMarkers){const e=this.props.timelineSet.room.getAccountData("m.fully_read");t=e?e.getContent().event_id:this._getCurrentReadReceipt()}this.state={events:[],liveEvents:[],timelineLoading:!0,firstVisibleEventIndex:0,canBackPaginate:!1,canForwardPaginate:!1,readMarkerVisible:!0,readMarkerEventId:t,backPaginating:!1,forwardPaginating:!1,clientSyncState:p.a.get().getSyncState(),isTwelveHour:i.a.getValue("showTwelveHourTimestamps"),alwaysShowTimestamps:i.a.getValue("alwaysShowTimestamps"),readMarkerInViewThresholdMs:i.a.getValue("readMarkerInViewThresholdMs"),readMarkerOutOfViewThresholdMs:i.a.getValue("readMarkerOutOfViewThresholdMs")},this.dispatcherRef=v.a.register(this.onAction),p.a.get().on("Room.timeline",this.onRoomTimeline),p.a.get().on("Room.timelineReset",this.onRoomTimelineReset),p.a.get().on("Room.redaction",this.onRoomRedaction),p.a.get().on("Room.redactionCancelled",this.onRoomRedaction),p.a.get().on("Room.receipt",this.onRoomReceipt),p.a.get().on("Room.localEchoUpdated",this.onLocalEchoUpdated),p.a.get().on("Room.accountData",this.onAccountData),p.a.get().on("Event.decrypted",this.onEventDecrypted),p.a.get().on("Event.replaced",this.onEventReplaced),p.a.get().on("sync",this.onSync)}UNSAFE_componentWillMount(){this.props.manageReadReceipts&&this.updateReadReceiptOnUserActivity(),this.props.manageReadMarkers&&this.updateReadMarkerOnUserActivity(),this._initTimeline(this.props)}UNSAFE_componentWillReceiveProps(e){if(e.timelineSet!==this.props.timelineSet&&console.warn("Replacing timelineSet on a TimelinePanel - confusion may ensue"),e.eventId!=this.props.eventId)return console.log("TimelinePanel switching to eventId "+e.eventId+" (was "+this.props.eventId+")"),this._initTimeline(e)}shouldComponentUpdate(e,t){return!g.a(this.props,e)||!g.a(this.state,t)}componentWillUnmount(){this.unmounted=!0,this._readReceiptActivityTimer&&(this._readReceiptActivityTimer.abort(),this._readReceiptActivityTimer=null),this._readMarkerActivityTimer&&(this._readMarkerActivityTimer.abort(),this._readMarkerActivityTimer=null),v.a.unregister(this.dispatcherRef);const e=p.a.get();e&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Room.timelineReset",this.onRoomTimelineReset),e.removeListener("Room.redaction",this.onRoomRedaction),e.removeListener("Room.redactionCancelled",this.onRoomRedaction),e.removeListener("Room.receipt",this.onRoomReceipt),e.removeListener("Room.localEchoUpdated",this.onLocalEchoUpdated),e.removeListener("Room.accountData",this.onAccountData),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Event.replaced",this.onEventReplaced),e.removeListener("sync",this.onSync))}_readMarkerTimeout(e){return 0===e?this.state.readMarkerInViewThresholdMs:this.state.readMarkerOutOfViewThresholdMs}async updateReadMarkerOnUserActivity(){const e=this._readMarkerTimeout(this.getReadMarkerPosition());for(this._readMarkerActivityTimer=new E.a(e);this._readMarkerActivityTimer;){f.a.sharedInstance().timeWhileActiveRecently(this._readMarkerActivityTimer);try{await this._readMarkerActivityTimer.finished()}catch(e){continue}this.updateReadMarker()}}async updateReadReceiptOnUserActivity(){for(this._readReceiptActivityTimer=new E.a(500);this._readReceiptActivityTimer;){f.a.sharedInstance().timeWhileActiveNow(this._readReceiptActivityTimer);try{await this._readReceiptActivityTimer.finished()}catch(e){continue}this.sendReadReceipt()}}_advanceReadMarkerPastMyEvents(){if(!this.props.manageReadMarkers)return;const e=this._timelineWindow.getEvents();let t;for(t=0;t<e.length&&e[t].getId()!=this.state.readMarkerEventId;t++);if(t>=e.length)return;const s=p.a.get().credentials.userId;for(t++;t<e.length;t++){const n=e[t];if(!n.sender||n.sender.userId!=s)break}t--;const n=e[t];this._setReadMarker(n.getId(),n.getTs())}_initTimeline(e){const t=e.eventId,s=e.eventPixelOffset;let n=1;return null==s&&(n=.5),this._loadTimeline(t,s,n)}_loadTimeline(e,t,s){this._timelineWindow=new h.n(p.a.get(),this.props.timelineSet,{windowLimit:this.props.timelineCap});const n=()=>{this._messagePanel.current&&this._messagePanel.current.onTimelineReset(),this._reloadEvents(),this._advanceReadMarkerPastMyEvents(),this.setState({canBackPaginate:this._timelineWindow.canPaginate(h.c.BACKWARDS),canForwardPaginate:this._timelineWindow.canPaginate(h.c.FORWARDS),timelineLoading:!1},()=>{this._messagePanel.current?(e?this._messagePanel.current.scrollToEvent(e,t,s):this._messagePanel.current.scrollToBottom(),this.sendReadReceipt()):console.log("can't initialise scroll state because messagePanel didn't load")})},a=t=>{this.setState({timelineLoading:!1}),console.error(`Error loading timeline panel at ${e}: ${t}`);const s=_.getComponent("dialogs.ErrorDialog");let n,a;e&&(n=()=>{v.a.dispatch({action:"view_room",room_id:this.props.timelineSet.room.roomId})}),a="M_FORBIDDEN"==t.errcode?Object(u.a)("Tried to load a specific point in this room's timeline, but you do not have permission to view the message in question."):Object(u.a)("Tried to load a specific point in this room's timeline, but was unable to find it."),b.a.createTrackedDialog("Failed to load timeline position","",s,{title:Object(u.a)("Failed to load timeline position"),description:a,onFinished:n})};if(this.props.timelineSet.getTimelineForEvent(e))this._timelineWindow.load(e,20),n();else{const t=this._timelineWindow.load(e,20);this.setState({events:[],liveEvents:[],canBackPaginate:!1,canForwardPaginate:!1,timelineLoading:!0}),t.then(n,a)}}_reloadEvents(){this.unmounted||this.setState(this._getEvents())}_getEvents(){const e=this._timelineWindow.getEvents(),t=this._checkForPreJoinUISI(e),s=[...e];return this._timelineWindow.canPaginate(h.c.FORWARDS)||e.push(...this.props.timelineSet.getPendingEvents()),{events:e,liveEvents:s,firstVisibleEventIndex:t}}_checkForPreJoinUISI(e){const t=this.props.timelineSet.room;if(0===e.length||!t||!p.a.get().isRoomEncrypted(t.roomId))return 0;const s=p.a.get().credentials.userId;let n,a="leave";for(n=e.length-1;n>=0;n--){const i=t.getTimelineForEvent(e[n].getId());if(!i){console.warn(`Event ${e[n].getId()} in room ${t.roomId} is live, but it does not have a timeline`);continue}const o=i.getState(h.c.FORWARDS).getMember(s);a=o?o.membership:"leave";const r=i.getEvents();for(let t=r.length-1;t>=0;t--){const i=r[t];if(i.getId()===e[n].getId())break;if(i.getStateKey()===s&&"m.room.member"===i.getType()){a=i.getPrevContent().membership||"leave"}}break}for(;n>=0;n--){const t=e[n];if(t.getStateKey()===s&&"m.room.member"===t.getType()){a=t.getPrevContent().membership||"leave"}else if("leave"===a&&(t.isDecryptionFailure()||t.isBeingDecrypted()))return n+1}return 0}_indexForEventId(e){for(let t=0;t<this.state.events.length;++t)if(e==this.state.events[t].getId())return t;return null}_getLastDisplayedEventIndex(e){const t=(e=e||{}).ignoreOwn||!1,s=e.allowPartial||!1,n=this._messagePanel.current;if(!n)return null;const a=c.a.findDOMNode(n);if(!a)return null;const i=a.getBoundingClientRect(),o=p.a.get().credentials.userId,r=e=>{if(e){const t=e.getBoundingClientRect();if(s&&t.top<i.bottom||!s&&t.bottom<i.bottom)return!0}return!1};let l=0;for(let e=this.state.liveEvents.length-1;e>=0;--e){const s=this.state.liveEvents[e],a=n.getNodeForEventId(s.getId()),i=r(a);if(i&&0!==l)return e+l;a&&!i&&(l=0);const c=!!s.status||t&&s.sender&&s.sender.userId==o;if(!(!Object(S.b)(s)||Object(C.a)(s))&&a){if(!c&&i)return e}else(!c||c&&0!==l)&&++l}return null}_getCurrentReadReceipt(e){const t=p.a.get();if(null==t)return null;const s=t.credentials.userId;return this.props.timelineSet.room.getEventReadUpTo(s,e)}_setReadMarker(e,t,s){const n=this.props.timelineSet.room.roomId;e!==this.state.readMarkerEventId&&(O.roomReadMarkerTsMap[n]=t,s||this.setState({readMarkerEventId:e},this.props.onReadMarkerUpdated))}_shouldPaginate(){return!this.state.events.some(e=>e.isBeingDecrypted())}render(){const e=_.getComponent("structures.MessagePanel"),t=_.getComponent("elements.Spinner");if(this.state.timelineLoading)return r.a.createElement("div",{className:"mx_RoomView_messagePanelSpinner"},r.a.createElement(t,null));if(0==this.state.events.length&&!this.state.canBackPaginate&&this.props.empty)return r.a.createElement("div",{className:this.props.className+" mx_RoomView_messageListWrapper"},r.a.createElement("div",{className:"mx_RoomView_empty"},this.props.empty));const s=!this._timelineWindow.canPaginate(h.c.FORWARDS),n=this.state.forwardPaginating||["PREPARED","CATCHUP"].includes(this.state.clientSyncState),a=this.state.firstVisibleEventIndex?this.state.events.slice(this.state.firstVisibleEventIndex):this.state.events;return r.a.createElement(e,{ref:this._messagePanel,room:this.props.timelineSet.room,permalinkCreator:this.props.permalinkCreator,hidden:this.props.hidden,backPaginating:this.state.backPaginating,forwardPaginating:n,events:a,highlightedEventId:this.props.highlightedEventId,readMarkerEventId:this.state.readMarkerEventId,readMarkerVisible:this.state.readMarkerVisible,suppressFirstDateSeparator:this.state.canBackPaginate,showUrlPreview:this.props.showUrlPreview,showReadReceipts:this.props.showReadReceipts,ourUserId:p.a.get().credentials.userId,stickyBottom:s,onScroll:this.onMessageListScroll,onFillRequest:this.onMessageListFillRequest,onUnfillRequest:this.onMessageListUnfillRequest,isTwelveHour:this.state.isTwelveHour,alwaysShowTimestamps:this.state.alwaysShowTimestamps,className:this.props.className,tileShape:this.props.tileShape,resizeNotifier:this.props.resizeNotifier,getRelationsForEvent:this.getRelationsForEvent,editState:this.state.editState,showReactions:this.props.showReactions,useIRCLayout:this.props.useIRCLayout,enableFlair:i.a.getValue(x.a.Flair)})}}a()(O,"propTypes",{timelineSet:m.a.object.isRequired,showReadReceipts:m.a.bool,manageReadReceipts:m.a.bool,manageReadMarkers:m.a.bool,hidden:m.a.bool,highlightedEventId:m.a.string,eventId:m.a.string,eventPixelOffset:m.a.number,showUrlPreview:m.a.bool,onScroll:m.a.func,onReadMarkerUpdated:m.a.func,onPaginationRequest:m.a.func,timelineCap:m.a.number,className:m.a.string,tileShape:m.a.string,empty:m.a.node,showReactions:m.a.bool,useIRCLayout:m.a.bool}),a()(O,"roomReadMarkerTsMap",{}),a()(O,"defaultProps",{timelineCap:Number.MAX_VALUE,className:"mx_RoomView_messagePanel"}),t.a=O},function(e,t,s){"use strict";s.d(t,"a",(function(){return n}));class n{constructor(e){this._event=e,this._serializedParts=null,this.caret=null}setEditorState(e,t){this._caret=e,this._serializedParts=t}hasEditorState(){return!!this._serializedParts}getSerializedParts(){return this._serializedParts}getCaret(){return this._caret}getEvent(){return this._event}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(85),l=s(83),c=s(86),d=s(107),m=s(89),h=s(92);class u extends o.a.PureComponent{constructor(e){super(e),a()(this,"_onClearCacheAndReload",()=>{d.a.get()&&(c.a.get().stopClient(),c.a.get().store.deleteAllData().then(()=>{d.a.get().reload()}))}),a()(this,"_onBugReport",()=>{const e=r.getComponent("dialogs.BugReportDialog");e&&m.a.createTrackedDialog("Bug Report Dialog","",e,{label:"react-soft-crash"})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}componentDidCatch(e,{componentStack:t}){console.error(e),console.error("The above error occured while React was rendering the following components:",t)}render(){if(this.state.error){const e=r.getComponent("elements.AccessibleButton"),t="https://github.com/vector-im/element-web/issues/new";let s;return h.a.get().bug_report_endpoint_url&&(s=o.a.createElement(o.a.Fragment,null,o.a.createElement("p",null,Object(l.a)("Please <newIssueLink>create a new issue</newIssueLink> on GitHub so that we can investigate this bug.",{},{newIssueLink:e=>o.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:t},e)})),o.a.createElement("p",null,Object(l.a)("If you've submitted a bug via GitHub, debug logs can help us track down the problem. Debug logs contain application usage data including your username, the IDs or aliases of the rooms or groups you have visited and the usernames of other users. They do not contain messages.")),o.a.createElement(e,{onClick:this._onBugReport,kind:"primary"},Object(l.a)("Submit debug logs")))),o.a.createElement("div",{className:"mx_ErrorBoundary"},o.a.createElement("div",{className:"mx_ErrorBoundary_body"},o.a.createElement("h1",null,Object(l.a)("Something went wrong!")),s,o.a.createElement(e,{onClick:this._onClearCacheAndReload,kind:"danger"},Object(l.a)("Clear cache and reload"))))}return this.props.children}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(86),m=s(87),h=s(90),u=s.n(h),p=s(83),g=s(92),f=s(215),b=s(157),v=s(113),_=s(98);s(1204);const y=Object.freeze({NotLoggedIn:"NotLoggedIn",Joining:"Joining",Loading:"Loading",Rejecting:"Rejecting",Kicked:"Kicked",Banned:"Banned",ExternNotInvited:"ExternNotInvited",OtherThreePIDError:"OtherThreePIDError",InvitedEmailNotFoundInAccount:"InvitedEmailNotFoundInAccount",InvitedEmailNoIdentityServer:"InvitedEmailNoIdentityServer",InvitedEmailMismatch:"InvitedEmailMismatch",Invite:"Invite",ViewingRoom:"ViewingRoom",RoomNotFound:"RoomNotFound",OtherError:"OtherError"});class E extends o.a.Component{constructor(...e){super(...e),a()(this,"state",{busy:!1}),a()(this,"_onCommunityUpdate",e=>{this.props.room&&this.props.room.roomId!==e||this.forceUpdate()}),a()(this,"onLoginClick",()=>{m.a.dispatch({action:"start_login",screenAfterLogin:this._makeScreenAfterLogin()})}),a()(this,"onRegisterClick",()=>{m.a.dispatch({action:"start_registration",screenAfterLogin:this._makeScreenAfterLogin()})})}componentDidMount(){this._checkInvitedEmail(),b.a.instance.on(v.b,this._onCommunityUpdate)}componentDidUpdate(e,t){this.props.invitedEmail===e.invitedEmail&&this.props.inviterName===e.inviterName||this._checkInvitedEmail()}componentWillUnmount(){b.a.instance.off(v.b,this._onCommunityUpdate)}async _checkInvitedEmail(){if(this.props.inviterName&&this.props.invitedEmail){this.setState({busy:!0});try{const e=await d.a.get().getThreePids();if(this.setState({accountEmails:e.threepids.filter(e=>"email"===e.medium).map(e=>e.address)}),!d.a.get().getIdentityServerUrl())return void this.setState({busy:!1});const t=new f.a,s=(await t.getAccessToken(),await _.a.lookupThreePid("email",this.props.invitedEmail));this.setState({invitedEmailMxid:s.mxid})}catch(e){this.setState({threePidFetchError:e})}this.setState({busy:!1})}}_getMessageCase(){if(d.a.get().isGuest())return y.NotLoggedIn;const e=_.a.isCurrentUserExtern(),t=this._getMyMember();if(t){if(t.isKicked())return y.Kicked;if("ban"===t.membership)return y.Banned}if(this.props.joining)return y.Joining;if(this.props.rejecting)return y.Rejecting;if(e&&this.props.error)return y.ExternNotInvited;if(this.props.loading||this.state.busy)return y.Loading;if(this.props.inviterName){if(this.props.invitedEmail){if(this.state.threePidFetchError)return y.OtherThreePIDError;if(this.state.accountEmails&&!this.state.accountEmails.includes(this.props.invitedEmail))return y.InvitedEmailNotFoundInAccount;if(!d.a.get().getIdentityServerUrl())return y.InvitedEmailNoIdentityServer;if(this.state.invitedEmailMxid!=d.a.get().getUserId())return y.InvitedEmailMismatch}return y.Invite}return this.props.error?"M_NOT_FOUND"==this.props.error.errcode?y.RoomNotFound:y.OtherError:y.ViewingRoom}_getKickOrBanInfo(){const e=this._getMyMember();if(!e)return{};const t=this.props.room.currentState.getMember(e.events.member.getSender());return{memberName:t?t.name:e.events.member.getSender(),reason:e.events.member.getContent().reason}}_joinRule(){const e=this.props.room;if(e){const t=e.currentState.getStateEvents("m.room.join_rules","");if(t)return t.getContent().join_rule}}_communityProfile(){return this.props.room?b.a.instance.getInviteProfile(this.props.room.roomId):{displayName:null,avatarMxc:null}}_roomName(e=!1){return this.props.room?this.props.room.name:this.props.roomAlias?this.props.roomAlias.split(":")[0]:e?Object(p.a)("This room"):Object(p.a)("this room")}_getMyMember(){return this.props.room&&this.props.room.getMember(d.a.get().getUserId())}_getInviteMember(){const{room:e}=this.props;if(!e)return;const t=d.a.get().getUserId(),s=e.currentState.getMember(t);if(!s)return;const n=s.events.member.getSender();return e.currentState.getMember(n)}_isDMInvite(){const e=this._getMyMember();if(!e)return!1;const t=e.events.member.getContent();return"invite"===t.membership&&t.is_direct}_makeScreenAfterLogin(){return{screen:"room",params:{email:this.props.invitedEmail,signurl:this.props.signUrl,room_name:this.props.oobData?this.props.oobData.room_name:null,room_avatar_url:this.props.oobData?this.props.oobData.avatarUrl:null,inviter_name:this.props.oobData?this.props.oobData.inviterName:null}}}render(){const e=g.a.get().brand,t=c.getComponent("elements.Spinner"),s=c.getComponent("elements.AccessibleButton");let n,a,i,r,l,d,m,h=!1;const f=[],b=this._getMessageCase();switch(b){case y.Joining:n=Object(p.a)("Joining room …"),h=!0;break;case y.Loading:n=Object(p.a)("Loading …"),h=!0;break;case y.Rejecting:n=Object(p.a)("Rejecting invite …"),h=!0;break;case y.NotLoggedIn:n=Object(p.a)("Join the conversation with an account"),r=Object(p.a)("Sign Up"),i=this.onRegisterClick,d=Object(p.a)("Sign In"),l=this.onLoginClick,this.props.previewLoading&&(m=o.a.createElement("div",null,o.a.createElement(t,{w:20,h:20}),Object(p.a)("Loading room preview")));break;case y.Kicked:{const{memberName:e,reason:t}=this._getKickOrBanInfo();n=Object(p.a)("You were kicked from %(roomName)s by %(memberName)s",{memberName:e,roomName:this._roomName()}),a=t?Object(p.a)("Reason: %(reason)s",{reason:t}):null,"invite"===this._joinRule()?(r=Object(p.a)("Forget this room"),i=this.props.onForgetClick):(r=Object(p.a)("Re-join"),i=this.props.onJoinClick,d=Object(p.a)("Forget this room"),l=this.props.onForgetClick);break}case y.Banned:{const{memberName:e,reason:t}=this._getKickOrBanInfo();n=Object(p.a)("You were banned from %(roomName)s by %(memberName)s",{memberName:e,roomName:this._roomName()}),a=t?Object(p.a)("Reason: %(reason)s",{reason:t}):null,r=Object(p.a)("Forget this room"),i=this.props.onForgetClick;break}case y.ExternNotInvited:n=Object(p.a)("You are not allowed to join %(roomName)s",{roomName:this._roomName()}),a=Object(p.a)("Try again later, or ask a room admin to check if you can have access.");break;case y.OtherThreePIDError:{n=Object(p.a)("Something went wrong with your invite to %(roomName)s",{roomName:this._roomName()});const e=this._joinRule(),t=Object(p.a)("An error (%(errcode)s) was returned while trying to validate your invite. You could try to pass this information on to a room admin.",{errcode:this.state.threePidFetchError.errcode||Object(p.a)("unknown error code")});switch(e){case"invite":a=[Object(p.a)("You can only join it with a working invite."),t],r=Object(p.a)("Try to join anyway"),i=this.props.onJoinClick;break;case"public":a=Object(p.a)("You can still join it because this is a forum."),r=Object(p.a)("Join the discussion"),i=this.props.onJoinClick;break;default:a=t,r=Object(p.a)("Try to join anyway"),i=this.props.onJoinClick}break}case y.InvitedEmailNotFoundInAccount:n=Object(p.a)("This invite to %(roomName)s was sent to %(email)s which is not associated with your account",{roomName:this._roomName(),email:this.props.invitedEmail}),a=Object(p.a)("Link this email with your account in Settings to receive invites directly in %(brand)s.",{brand:e}),r=Object(p.a)("Join the discussion"),i=this.props.onJoinClick;break;case y.InvitedEmailNoIdentityServer:n=Object(p.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this._roomName(),email:this.props.invitedEmail}),a=Object(p.a)("Use an identity server in Settings to receive invites directly in %(brand)s.",{brand:e}),r=Object(p.a)("Join the discussion"),i=this.props.onJoinClick;break;case y.InvitedEmailMismatch:n=Object(p.a)("This invite to %(roomName)s was sent to %(email)s",{roomName:this._roomName(),email:this.props.invitedEmail}),a=Object(p.a)("Share this email in Settings to receive invites directly in %(brand)s.",{brand:e}),r=Object(p.a)("Join the discussion"),i=this.props.onJoinClick;break;case y.Invite:{const e=c.getComponent("views.avatars.RoomAvatar"),t=this._isDMInvite(),m=_.a.isRoomNotice(this.props.room),h=Object.assign({},this.props.oobData,{avatarUrl:this._communityProfile().avatarMxc});let u="";t||m||(u+=" tc_RoomTile_avatar_hexa");const g=o.a.createElement(e,{className:u,room:this.props.room,oobData:h}),b=this._getInviteMember();let v;v=b?o.a.createElement("span",null,o.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},b.rawDisplayName)):o.a.createElement("span",{className:"mx_RoomPreviewBar_inviter"},this.props.inviterName),t?(n=Object(p.a)("Do you want to chat with %(user)s?",{user:b.name}),a=[g,Object(p.a)("<userName/> wants to chat",{},{userName:()=>v})],r=Object(p.a)("Start chatting")):(n=Object(p.a)("Do you want to join %(roomName)s?",{roomName:this._roomName()}),a=[g,Object(p.a)("<userName/> invited you",{},{userName:()=>v})],r=Object(p.a)("Accept")),i=this.props.onJoinClick,d=Object(p.a)("Reject"),l=this.props.onRejectClick,this.props.onRejectAndIgnoreClick&&f.push(o.a.createElement(s,{kind:"secondary",onClick:this.props.onRejectAndIgnoreClick,key:"ignore"},Object(p.a)("Reject & Ignore user")));break}case y.ViewingRoom:n=this.props.canPreview?Object(p.a)("You're previewing %(roomName)s. Want to join it?",{roomName:this._roomName()}):Object(p.a)("%(roomName)s can't be previewed. Do you want to join it?",{roomName:this._roomName()}),r=Object(p.a)("Join the discussion"),i=this.props.onJoinClick;break;case y.RoomNotFound:n=Object(p.a)("%(roomName)s does not exist.",{roomName:this._roomName(!0)}),a=Object(p.a)("This room doesn't exist. Are you sure you're at the right place?");break;case y.OtherError:n=Object(p.a)("You are not allowed to join %(roomName)s",{roomName:this._roomName()}),a=Object(p.a)("Try again later, or ask a room admin to check if you have access.")}let v,E,C,w;a&&(Array.isArray(a)||(a=[a]),v=a.map((e,t)=>o.a.createElement("p",{key:"subTitle"+t},e))),E=h?o.a.createElement("h3",{className:"mx_RoomPreviewBar_spinnerTitle"},o.a.createElement(t,null),n):o.a.createElement("h3",null,n),i&&(C=o.a.createElement(s,{kind:"primary",onClick:i},r)),l&&(w=o.a.createElement(s,{kind:"secondary",onClick:l},d));const S=u()("mx_RoomPreviewBar","dark-panel","mx_RoomPreviewBar_"+b,{mx_RoomPreviewBar_panel:this.props.canPreview,mx_RoomPreviewBar_dialog:!this.props.canPreview});return o.a.createElement("div",{className:S},o.a.createElement("div",{className:"mx_RoomPreviewBar_message"},E,v),o.a.createElement("div",{className:"mx_RoomPreviewBar_actions"},w,f,C),o.a.createElement("div",{className:"mx_RoomPreviewBar_footer"},m))}}a()(E,"propTypes",{onJoinClick:l.a.func,onRejectClick:l.a.func,onRejectAndIgnoreClick:l.a.func,onForgetClick:l.a.func,inviterName:l.a.string,invitedEmail:l.a.string,oobData:l.a.object,signUrl:l.a.string,error:l.a.object,canPreview:l.a.bool,previewLoading:l.a.bool,room:l.a.object,spinner:l.a.bool,spinnerState:l.a.oneOf(["joining"]),loading:l.a.bool,joining:l.a.bool,rejecting:l.a.bool,roomAlias:l.a.string}),a()(E,"defaultProps",{onJoinClick(){}})},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(99);class m extends o.a.Component{constructor(...e){super(...e),a()(this,"_onKeyDown",e=>{switch(e.key){case d.a.ESCAPE:this.props.onCancelClick()}})}componentDidMount(){document.addEventListener("keydown",this._onKeyDown)}componentWillUnmount(){document.removeEventListener("keydown",this._onKeyDown)}render(){return o.a.createElement("div",{className:"mx_ForwardMessage"},o.a.createElement("h1",null,Object(c.a)("Please select the destination room for this message")))}}a()(m,"propTypes",{onCancelClick:l.a.func.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(91),l=s(90),c=s.n(l),d=s(83),m=s(99),h=s(482);class u extends o.a.Component{constructor(e){super(e),a()(this,"onThisRoomClick",()=>{this.setState({scope:"Room"},()=>this._searchIfQuery())}),a()(this,"onAllRoomsClick",()=>{this.setState({scope:"All"},()=>this._searchIfQuery())}),a()(this,"onSearchChange",e=>{switch(e.key){case m.a.ENTER:this.onSearch();break;case m.a.ESCAPE:this.props.onCancelClick()}}),a()(this,"onSearch",()=>{this.props.onSearch(this._search_term.current.value,this.state.scope)}),this._search_term=Object(i.createRef)(),this.state={scope:"Room"}}_searchIfQuery(){this._search_term.current.value&&this.onSearch()}render(){const e=c()("mx_SearchBar_searchButton",{mx_SearchBar_searching:this.props.searchInProgress}),t=c()("mx_SearchBar_button",{mx_SearchBar_unselected:"Room"!==this.state.scope}),s=c()("mx_SearchBar_button",{mx_SearchBar_unselected:"All"!==this.state.scope});return o.a.createElement(o.a.Fragment,null,o.a.createElement("div",{className:"mx_SearchBar"},o.a.createElement("div",{className:"mx_SearchBar_buttons",role:"radiogroup"},o.a.createElement(r.a,{className:t,onClick:this.onThisRoomClick,"aria-checked":"Room"===this.state.scope,role:"radio"},Object(d.a)("This Room")),o.a.createElement(r.a,{className:s,onClick:this.onAllRoomsClick,"aria-checked":"All"===this.state.scope,role:"radio"},Object(d.a)("All Rooms"))),o.a.createElement("div",{className:"mx_SearchBar_input mx_textinput"},o.a.createElement("input",{ref:this._search_term,type:"text",autoFocus:!0,placeholder:Object(d.a)("Search…"),onKeyDown:this.onSearchChange}),o.a.createElement(r.a,{className:e,onClick:this.onSearch})),o.a.createElement(r.a,{className:"mx_SearchBar_cancel",onClick:this.props.onCancelClick})),o.a.createElement(h.b,{isRoomEncrypted:this.props.isRoomEncrypted,kind:h.a.Search}))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(89),m=s(83),h=s(86);class u extends o.a.Component{constructor(e){super(e),a()(this,"_onStateEvents",(e,t)=>{if(!this.props.room||e.getRoomId()!==this.props.room.roomId)return;if("m.room.tombstone"!==e.getType())return;const s=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:s&&s.getContent().replacement_room})}),a()(this,"onUpgradeClick",()=>{const e=c.getComponent("dialogs.RoomUpgradeDialog");d.a.createTrackedDialog("Upgrade Room Version","",e,{room:this.props.room})}),this.state={}}componentDidMount(){const e=this.props.room.currentState.getStateEvents("m.room.tombstone","");this.setState({upgraded:e&&e.getContent().replacement_room}),h.a.get().on("RoomState.events",this._onStateEvents)}componentWillUnmount(){const e=h.a.get();e&&e.removeListener("RoomState.events",this._onStateEvents)}render(){const e=c.getComponent("elements.AccessibleButton");let t=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.a.createElement("p",null,Object(m.a)("Upgrading this room will shut down the current instance of the room and create an upgraded room with the same name.")),o.a.createElement("p",null,Object(m.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>o.a.createElement("b",null,e),i:e=>o.a.createElement("i",null,e)}))),o.a.createElement("p",{className:"mx_RoomUpgradeWarningBar_upgradelink"},o.a.createElement(e,{onClick:this.onUpgradeClick},Object(m.a)("Upgrade this room to the recommended room version"))));return this.state.upgraded&&(t=o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_body"},o.a.createElement("p",null,Object(m.a)("This room has already been upgraded.")))),o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar"},o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_wrapped"},o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_header"},Object(m.a)("This room is running room version <roomVersion />, which this homeserver has marked as <i>unstable</i>.",{},{roomVersion:()=>o.a.createElement("code",null,this.props.room.getVersion()),i:e=>o.a.createElement("i",null,e)})),t,o.a.createElement("div",{className:"mx_RoomUpgradeWarningBar_small"},Object(m.a)("Only room administrators will see this warning"))))}}a()(u,"propTypes",{room:l.a.object.isRequired,recommendation:l.a.object.isRequired})},function(e,t,s){"use strict";s.d(t,"a",(function(){return f}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(86),d=s(87),m=s(91),h=s(743),u=s(257),p=s(83),g=s(130);class f extends o.a.Component{constructor(...e){super(...e),a()(this,"onTileClicked",()=>{d.a.dispatch({action:"view_room",event_id:this.props.mxEvent.getId(),highlighted:!0,room_id:this.props.mxEvent.getRoomId()})}),a()(this,"onUnpinClicked",()=>{const e=this.props.mxRoom.currentState.getStateEvents("m.room.pinned_events","");if(e&&e.getContent().pinned){const t=e.getContent().pinned,s=t.indexOf(this.props.mxEvent.getId());-1!==s?(t.splice(s,1),c.a.get().sendStateEvent(this.props.mxRoom.roomId,"m.room.pinned_events",{pinned:t},"").then(()=>{this.props.onUnpinned&&this.props.onUnpinned()})):this.props.onUnpinned&&this.props.onUnpinned()}else this.props.onUnpinned&&this.props.onUnpinned()})}_canUnpin(){return this.props.mxRoom.currentState.mayClientSendStateEvent("m.room.pinned_events",c.a.get())}render(){const e=this.props.mxEvent.getSender(),t=this.props.mxRoom.getMember(e);let n=null;return this._canUnpin()&&(n=o.a.createElement(m.a,{onClick:this.onUnpinClicked,className:"mx_PinnedEventTile_unpinButton"},o.a.createElement("img",{src:s(1255),width:"8",height:"8",alt:Object(p.a)("Unpin Message"),title:Object(p.a)("Unpin Message")}))),o.a.createElement("div",{className:"mx_PinnedEventTile"},o.a.createElement("div",{className:"mx_PinnedEventTile_actions"},o.a.createElement(m.a,{className:"mx_PinnedEventTile_gotoButton mx_textButton",onClick:this.onTileClicked},Object(p.a)("Jump to message")),n),o.a.createElement("span",{className:"mx_PinnedEventTile_senderAvatar"},o.a.createElement(u.a,{member:t,width:40,height:40,fallbackUserId:e})),o.a.createElement("span",{className:"mx_PinnedEventTile_sender"},t?t.name:e),o.a.createElement("span",{className:"mx_PinnedEventTile_timestamp"},Object(g.b)(new Date(this.props.mxEvent.getTs()))),o.a.createElement("div",{className:"mx_PinnedEventTile_message"},o.a.createElement(h.a,{mxEvent:this.props.mxEvent,className:"mx_PinnedEventTile_body",maxImageHeight:150,onHeightChanged:()=>{}})))}}a()(f,"propTypes",{mxRoom:l.a.object.isRequired,mxEvent:l.a.object.isRequired,onUnpinned:l.a.func})},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(85),d=s(88),m=s(452),h=s(483),u=s(744);class p extends o.a.Component{constructor(e){super(e),a()(this,"getEventTileOps",()=>this._body.current&&this._body.current.getEventTileOps?this._body.current.getEventTileOps():null),a()(this,"onTileUpdate",()=>{this.forceUpdate()}),this._body=Object(i.createRef)()}render(){const e={"m.text":c.getComponent("messages.TextualBody"),"m.notice":c.getComponent("messages.TextualBody"),"m.emote":c.getComponent("messages.TextualBody"),"m.image":c.getComponent("messages.MImageBody"),"m.file":c.getComponent("messages.MFileBody"),"m.audio":c.getComponent("messages.MAudioBody"),"m.video":c.getComponent("messages.MVideoBody")},t={"m.sticker":c.getComponent("messages.MStickerBody")},s=this.props.mxEvent.getContent(),n=this.props.mxEvent.getType(),a=s.msgtype;let i=h.a;if(this.props.mxEvent.isRedacted()||(i=n&&t[n]?t[n]:a&&e[a]?e[a]:s.url?e["m.file"]:u.a),d.a.getValue("feature_mjolnir")){const e=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;if(!("true"===localStorage.getItem(e))){const e=this.props.mxEvent.getSender().split(":").slice(1).join(":"),t=m.a.sharedInstance().isUserBanned(this.props.mxEvent.getSender()),s=m.a.sharedInstance().isServerBanned(e);(t||s)&&(i=c.getComponent("messages.MjolnirBody"))}}return o.a.createElement(i,{ref:this._body,mxEvent:this.props.mxEvent,highlights:this.props.highlights,highlightLink:this.props.highlightLink,showUrlPreview:this.props.showUrlPreview,tileShape:this.props.tileShape,maxImageHeight:this.props.maxImageHeight,replacingEventId:this.props.replacingEventId,editState:this.props.editState,onHeightChanged:this.props.onHeightChanged,onMessageAllowed:this.onTileUpdate})}}a()(p,"propTypes",{mxEvent:l.a.object.isRequired,highlights:l.a.array,highlightLink:l.a.string,showUrlPreview:l.a.bool,onHeightChanged:l.a.func,tileShape:l.a.string,maxImageHeight:l.a.number})},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=(s(83),s(98));t.a=Object(n.forwardRef)(({mxEvent:e},t)=>{let s=e.getContent().body;return s=i.a.transformServerErrors(s),a.a.createElement("span",{className:"mx_UnknownBody",ref:t},s)})},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(86),l=s(85),c=s(87),d=s(343),m=s(766),h=s(83),u=s(90),p=s.n(u),g=s(254),f=s(88),b=s(119),v=s(108),_=s(746);class y extends o.a.Component{constructor(e){super(e),a()(this,"onConferenceNotificationClick",(e,t)=>{c.a.dispatch({action:"place_call",type:t,room_id:this.props.room.roomId}),e.stopPropagation(),e.preventDefault()}),a()(this,"_rateLimitedUpdate",new g.a(()=>{f.a.getValue("feature_state_counters")&&this.setState({counters:this._computeCounters()})},500)),this.state={counters:this._computeCounters()}}componentDidMount(){r.a.get().on("RoomState.events",this._rateLimitedUpdate)}componentWillUnmount(){const e=r.a.get();e&&e.removeListener("RoomState.events",this._rateLimitedUpdate)}shouldComponentUpdate(e,t){return!d.a(this.props,e)||!d.a(this.state,t)}componentDidUpdate(e,t){this.props.onResize&&this.props.onResize()}_computeCounters(){const e=[];if(this.props.room&&f.a.getValue("feature_state_counters")){const t=this.props.room.currentState.getStateEvents("re.jki.counter");t.sort((e,t)=>e.getStateKey()<t.getStateKey());for(const s of t){const t=s.getContent().title,n=s.getContent().value,a=s.getContent().link,i=s.getContent().severity||"normal",o=s.getStateKey();t&&void 0!==n&&e.push({title:t,value:n,link:a,severity:i,stateKey:o})}}return e}render(){const e=l.getComponent("elements.TintableSvg");let t=null;this.props.draggingFile&&(t=o.a.createElement("div",{className:"mx_RoomView_fileDropTarget"},o.a.createElement("div",{className:"mx_RoomView_fileDropTargetLabel",title:Object(h.a)("Drop File Here")},o.a.createElement(e,{src:s(1256),width:"45",height:"59"}),o.a.createElement("br",null),Object(h.a)("Drop file here to upload"))));const n=o.a.createElement(_.a,{roomId:this.props.room.roomId,onResize:this.props.onResize,maxVideoHeight:this.props.maxHeight});let a;f.a.getValue(v.a.Widgets)&&(a=o.a.createElement(m.a,{room:this.props.room,userId:this.props.userId,maxHeight:this.props.maxHeight,showApps:this.props.showApps,resizeNotifier:this.props.resizeNotifier}));let i=null;if(this.state.counters&&f.a.getValue("feature_state_counters")){const e=[];this.state.counters.forEach((t,s)=>{const n=t.title,a=t.value,i=t.link,r=t.severity,l=t.stateKey;let c=o.a.createElement("span",null,n,": ",a);i&&(c=o.a.createElement("a",{href:i,target:"_blank",rel:"noreferrer noopener"},c)),c=o.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_span","data-severity":r,key:"x-"+l},c),e.push(c),e.push(o.a.createElement("span",{className:"m_RoomView_auxPanel_stateViews_delim",key:"delim"+s}," ─ "))}),e.length>0&&(e.pop(),i=o.a.createElement("div",{className:"m_RoomView_auxPanel_stateViews"},e))}const r=p()({mx_RoomView_auxPanel:!0,mx_RoomView_auxPanel_fullHeight:this.props.fullHeight}),c={};return this.props.fullHeight||(c.maxHeight=this.props.maxHeight),o.a.createElement(b.a,{className:r,style:c},i,a,t,n,this.props.children)}}a()(y,"defaultProps",{showApps:!0})},function(e,t,s){"use strict";s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(127),o=s(81),r=s.n(o),l=s(141),c=s(468),d=s(87);class m extends r.a.Component{constructor(e){super(e),a()(this,"dispatcherRef",void 0),a()(this,"onAction",e=>{switch(e.action){case"call_state":{const e=this.getCall();e!==this.state.call&&this.setState({call:e});break}}}),this.state={call:this.getCall()}}componentDidMount(){this.dispatcherRef=d.a.register(this.onAction)}componentWillUnmount(){d.a.unregister(this.dispatcherRef)}getCall(){const e=l.b.sharedInstance().getCallForRoom(this.props.roomId);return e&&[i.e.Ended,i.e.Ringing].includes(e.state)?null:e}render(){return this.state.call?r.a.createElement(c.a,{call:this.state.call,pipMode:!1,onResize:this.props.onResize,maxVideoHeight:this.props.maxVideoHeight}):null}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return O}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(90),d=s.n(c),m=s(83),h=s(86),u=s(254),p=s(121),g=s(748),f=s(88),b=s(749),v=s(198),_=s(365),y=s(125),E=s(115),C=s(109),w=s(98),S=(s(174),s(89)),x=s(356);const R=Object.freeze({None:"NONE",Encrypted:"ENCRYPTED",Forum:"FORUM"});class O extends o.a.Component{constructor(e){super(e),a()(this,"state",{icon:R.None}),a()(this,"_onRoomStateEvents",(e,t)=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&this._rateLimitedUpdate()}),a()(this,"_onRoomAccountData",(e,t)=>{this.props.room&&t.roomId===this.props.room.roomId&&"im.vector.room.read_pins"===e.getType()&&this._rateLimitedUpdate()}),a()(this,"_rateLimitedUpdate",new u.a((function(){this.forceUpdate()}),500)),a()(this,"_onRoomNameChange",e=>{this.forceUpdate()}),a()(this,"_onShareRoomClick",()=>{S.a.createTrackedDialog("share room dialog","",x.a,{target:this.props.room})}),this._topic=Object(i.createRef)()}componentDidMount(){const e=h.a.get(),t=C.a.shared().getUserIdForRoomId(this.props.room.roomId),s=w.a.isRoomNotice(this.props.room);let n;e.on("RoomState.events",this._onRoomStateEvents),e.on("Room.accountData",this._onRoomAccountData),n=w.a.isRoomForum(this.props.room.roomId)?R.Forum:t||s?R.None:R.Encrypted,this.setState({icon:n}),this.props.room&&this.props.room.on("Room.name",this._onRoomNameChange)}componentDidUpdate(){this._topic.current&&Object(p.f)(this._topic.current)}componentWillUnmount(){this.props.room&&this.props.room.removeListener("Room.name",this._onRoomNameChange);const e=h.a.get();e&&(e.removeListener("RoomState.events",this._onRoomStateEvents),e.removeListener("Room.accountData",this._onRoomAccountData))}_hasUnreadPins(){const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");if(!e)return!1;if(e.getContent().pinned&&e.getContent().pinned.length<=0)return!1;const t=this.props.room.getAccountData("im.vector.room.read_pins");if(t&&t.getContent()){const s=t.getContent().event_ids||[];if(s)return!s.includes(e.getId())}return!0}_hasPins(){const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");return!!e&&!(e.getContent().pinned&&e.getContent().pinned.length<=0)}renderRoomSublineElement(){const e=C.a.shared().getUserIdForRoomId(this.props.room.roomId),t=w.a.isRoomNotice(this.props.room);if(e||t||"direct"===w.a.getAccessRules(this.props.room.roomId))return null;let n="",a="",i=s(350);w.a.isRoomForum(this.props.room.roomId)?(n+="tc_Room_roomType_forum",a=Object(m.a)("Forum"),i=s(1257)):"restricted"===w.a.getAccessRules(this.props.room.roomId)?(n+="tc_Room_roomType_restricted",a=Object(m.a)("Private"),i=s(1258)):"unrestricted"===w.a.getAccessRules(this.props.room.roomId)&&(n+="tc_Room_roomType_unrestricted",a=Object(m.a)("External"),i=s(1259));let r=o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"tc_RoomHeader_middot"},"·"),o.a.createElement("div",{className:"tc_RoomHeader_memberCount"},o.a.createElement("img",{className:"tc_RoomHeader_memberCount_icon",src:s(1260),width:"16",height:"16",alt:"People"}),o.a.createElement("span",{className:"tc_RoomHeader_memberCount_value"},this.props.room.getJoinedMemberCount()))),l=o.a.createElement(o.a.Fragment,null,o.a.createElement("span",{className:"tc_RoomHeader_middot"},"·"),o.a.createElement("div",{className:"tc_RoomHeader_retention"},o.a.createElement("img",{className:"tc_RoomHeader_retention_icon",src:s(1261),width:"14",height:"14",alt:"Retention time"}),o.a.createElement("span",{className:"tc_RoomHeader_retention_value"},"360 j")));return o.a.createElement("div",{className:"tc_RoomHeader_roomSubline"},o.a.createElement("div",{className:n},o.a.createElement("img",{src:i,className:"tc_Room_roomType_restricted",width:"12",height:"12",alt:a}),o.a.createElement("span",{className:"tc_Room_roomType_text"},a)),r,l)}render(){let e=null,t=null,s=null;this.props.e2eStatus&&(v.b,this.props.e2eStatus);const n=new C.a(h.a.get()),a=Boolean(n.getUserIdForRoomId(this.props.room.roomId)),i=w.a.getJoinRules(this.props.room.roomId),r=w.a.isRoomForum(this.props.room.roomId);this.props.onCancelClick&&(t=o.a.createElement(g.a,{onClick:this.props.onCancelClick})),this.props.searchInfo&&void 0!==this.props.searchInfo.searchCount&&null!==this.props.searchInfo.searchCount&&(e=o.a.createElement("div",{className:"mx_RoomHeader_searchStatus"}," ",Object(m.a)("(~%(count)s results)",{count:this.props.searchInfo.searchCount})));let l=!1;const c=this.props.room?this.props.room.getJoinedMembers():void 0;if(c&&1===c.length&&c[0].userId===h.a.get().credentials.userId){const e=this.props.room.currentState.getStateEvents("m.room.name","");e&&e.getContent().name||(l=!0)}let u=Object(m.a)("Join Room");this.props.oobData&&this.props.oobData.name?u=this.props.oobData.name:this.props.room&&(u=this.props.room.name);const p=d()("mx_RoomHeader_nametext",{mx_RoomHeader_settingsHint:l}),S=o.a.createElement("div",{className:"mx_RoomHeader_name"},o.a.createElement("div",{dir:"auto",className:p,title:u},u),e);let x;if(this.props.room){const e=this.props.room.currentState.getStateEvents("m.room.topic","");e&&(x=e.getContent().topic)}this._topic;let R,O,k,I;if(this.props.room&&(R=o.a.createElement(_.a,{room:this.props.room,avatarSize:48,tag:y.a.Untagged,oobData:this.props.oobData,viewAvatarOnClick:!0})),this.props.onPinnedClick&&f.a.getValue("feature_pinning")){let e=null;this._hasUnreadPins()?e=o.a.createElement("div",{className:"mx_RoomHeader_pinsIndicator mx_RoomHeader_pinsIndicatorUnread"}):this._hasPins()&&(e=o.a.createElement("div",{className:"mx_RoomHeader_pinsIndicator"})),s=o.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_pinnedButton",onClick:this.props.onPinnedClick,title:Object(m.a)("Pinned Messages")},e)}this.props.onForgetClick&&(O=o.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_forgetButton",onClick:this.props.onForgetClick,title:Object(m.a)("Forget room")})),this.props.onSearchClick&&this.props.inRoom&&!h.a.get().isRoomEncrypted(this.props.room.roomId)&&(k=o.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomHeader_searchButton",onClick:this.props.onSearchClick,title:Object(m.a)("Search")})),this.props.inRoom&&!a&&(r||"public"===i)&&(I=o.a.createElement(E.a,{className:"mx_RoomHeader_button mx_RoomSummaryCard_icon_share",onClick:this._onShareRoomClick,title:Object(m.a)("Share room")}));const T=o.a.createElement("div",{className:"mx_RoomHeader_buttons"},s,I,O,k);return o.a.createElement("div",{className:"mx_RoomHeader light-panel"},o.a.createElement("div",{className:"mx_RoomHeader_wrapper","aria-owns":"mx_RightPanel"},o.a.createElement("div",{className:"mx_RoomHeader_avatar"},R),o.a.createElement("div",{className:"tc_RoomHeader_infos"},S,this.renderRoomSublineElement()),o.a.createElement("div",{className:"tc_RoomHeader_button"},t,T,o.a.createElement(b.a,null))))}}a()(O,"propTypes",{room:l.a.object,oobData:l.a.object,inRoom:l.a.bool,onSettingsClick:l.a.func,onPinnedClick:l.a.func,onSearchClick:l.a.func,onLeaveClick:l.a.func,onCancelClick:l.a.func,e2eStatus:l.a.string,onAppsClick:l.a.func,appsShown:l.a.bool}),a()(O,"defaultProps",{editing:!1,inRoom:!1,onCancelClick:null})},function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(91),d=s(85),m=s(83);function h(e){const{onClick:t}=e;return o.a.createElement(c.a,{className:"mx_RoomHeader_cancelButton",onClick:t},o.a.createElement("img",{src:s(222),className:"mx_filterFlipColor",width:"18",height:"18",alt:Object(m.a)("Cancel")}))}class u extends o.a.Component{render(){let e,t;if(this.props.onCancelClick&&(e=o.a.createElement(h,{onClick:this.props.onCancelClick})),this.props.icon){const e=d.getComponent("elements.TintableSvg");t=o.a.createElement(e,{className:"mx_RoomHeader_icon",src:this.props.icon,width:"25",height:"25"})}return o.a.createElement("div",{className:"mx_RoomHeader"},o.a.createElement("div",{className:"mx_RoomHeader_wrapper"},o.a.createElement("div",{className:"mx_RoomHeader_simpleHeader"},t,this.props.title,e)))}}a()(u,"propTypes",{title:l.a.string,onCancelClick:l.a.func,icon:l.a.string})},function(e,t,s){"use strict";s.d(t,"a",(function(){return p}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(83),l=s(484),c=s(485),d=s(123),m=s(94),h=s(294);const u=[d.b.RoomSummary,d.b.Widget,d.b.FilePanel,d.b.RoomMemberList,d.b.RoomMemberInfo,d.b.EncryptionPanel,d.b.Room3pidMemberInfo];class p extends c.b{constructor(e){super(e,c.a.Room),a()(this,"onRoomSummaryClicked",()=>{const e=h.a.getSharedInstance().roomPanelPhase;u.includes(e)?this.state.phase===e?this.setPhase(e):this.setPhase(e,h.a.getSharedInstance().roomPanelPhaseParams):this.setPhase(d.b.RoomSummary)}),a()(this,"onNotificationsClicked",()=>{this.setPhase(d.b.NotificationPanel)})}onAction(e){e.action===m.a.ViewUser?e.member?this.setPhase(d.b.RoomMemberInfo,{member:e.member}):this.setPhase(d.b.RoomMemberList):"view_3pid_invite"===e.action&&(e.event?this.setPhase(d.b.Room3pidMemberInfo,{event:e.event}):this.setPhase(d.b.RoomMemberList))}renderButtons(){return[o.a.createElement(l.a,{key:"notifsButton",name:"notifsButton",title:Object(r.a)("Notifications"),isHighlighted:this.isPhase(d.b.NotificationPanel),onClick:this.onNotificationsClicked,analytics:["Right Panel","Notification List Button","click"]}),o.a.createElement(l.a,{key:"roomSummaryButton",name:"roomSummaryButton",title:Object(r.a)("Room Info"),isHighlighted:this.isPhase(u),onClick:this.onRoomSummaryClicked,analytics:["Right Panel","Room Summary Button","click"]})]}}},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(87),o=s(202);t.a=({roomWidth:e})=>{const t=Object(n.useRef)(null),r=Object(n.useRef)(new Map);return Object(n.useEffect)(()=>{const e=()=>{t.current&&(t.current.height=window.innerHeight)},n=i.a.register(e=>{if(0===e.action.indexOf("effects.")){(async e=>{if(!e)return null;let t=r.current[e]||null;if(null===t){var n;const a=null===(n=o.CHAT_EFFECTS.find(t=>t.command===e))||void 0===n?void 0:n.options;try{const{default:n}=await s(1262)("./"+e);t=new n(a),r.current[e]=t}catch(e){console.warn("Unable to load effect module at '../../../effects/${name}'.",e)}}return t})(e.action.substr("effects.".length)).then(e=>null==e?void 0:e.start(t.current))}});return t.current.height=window.innerHeight,window.addEventListener("resize",e,!0),()=>{i.a.unregister(n),window.removeEventListener("resize",e);const t=r.current;for(const e in t){const s=t[e];s&&s.isRunning&&s.stop()}}},[]),a.a.createElement("canvas",{ref:t,width:e,style:{display:"block",zIndex:999999,pointerEvents:"none",position:"fixed",top:0,right:0}})}},,function(e,t,s){"use strict";(function(e){var n=s(81),a=s.n(n),i=s(124),o=s(97),r=s(227),l=s(109),c=s(83),d=s(91),m=s(370),h=s(199),u=s(87),p=s(94);t.a=()=>{const t=Object(n.useContext)(o.a),{room:s,roomId:g}=Object(n.useContext)(r.a),f=l.a.shared().getUserIdForRoomId(g);let b;if(f){let e;s.getJoinedMemberCount()+s.getInvitedMemberCount()===2&&(e=Object(c.a)("Only the two of you are in this conversation, unless either of you invites anyone to join."));const t=null==s?void 0:s.getMember(f),n=(null==t?void 0:t.rawDisplayName)||f;b=a.a.createElement(a.a.Fragment,null,a.a.createElement(h.a,{room:s,width:m.a,height:m.a,onClick:()=>{u.a.dispatch({action:p.a.ViewUser,member:t||{userId:f}})}}),a.a.createElement("h2",null,s.name),a.a.createElement("p",null,Object(c.a)("This is the beginning of your direct message history with <displayName/>.",{},{displayName:()=>a.a.createElement("b",null,n)})))}else{var v,_,y,E,C,w,S;const n=s&&"join"===s.getMyMembership(),o=null===(v=s.currentState.getStateEvents(i.a.RoomTopic,""))||void 0===v||null===(_=v.getContent())||void 0===_?void 0:_.topic,r=n&&s.currentState.maySendStateEvent(i.a.RoomTopic,t.getUserId()),l=()=>{u.a.dispatch({action:"open_room_settings",room_id:g},!0),e(()=>{window.document.getElementById("profileTopic").focus()})};let p;r&&o?p=Object(c.a)("Topic: %(topic)s (<a>edit</a>)",{topic:o},{a:e=>a.a.createElement(d.a,{kind:"link",onClick:l},e)}):o?p=Object(c.a)("Topic: %(topic)s ",{topic:o}):r&&(p=Object(c.a)("<a>Add a topic</a> to help people know what it is about.",{},{a:e=>a.a.createElement(d.a,{kind:"link",onClick:l},e)}));const x=null===(y=s.currentState.getStateEvents(i.a.RoomCreate,""))||void 0===y?void 0:y.getSender(),R=(null==s||null===(E=s.getMember(x))||void 0===E?void 0:E.rawDisplayName)||x;let O;O=x===t.getUserId()?Object(c.a)("You created this room."):Object(c.a)("%(displayName)s created this room.",{displayName:R});let k=n;const I=null===(C=s.currentState.getStateEvents(i.a.RoomPowerLevels,""))||void 0===C?void 0:C.getContent(),T=s.getMember(t.getUserId());let j;if(I&&T&&I.invite>T.powerLevel&&(k=!1),k){const e=()=>{u.a.dispatch({action:"view_invite",roomId:g})};j=a.a.createElement("div",{className:"mx_NewRoomIntro_buttons"},a.a.createElement(d.a,{className:"mx_NewRoomIntro_inviteButton",kind:"primary",onClick:e},Object(c.a)("Invite to this room")))}const N=null===(w=s.currentState.getStateEvents(i.a.RoomAvatar,""))||void 0===w||null===(S=w.getContent())||void 0===S?void 0:S.url;b=a.a.createElement(a.a.Fragment,null,a.a.createElement(m.b,{hasAvatar:!!N,noAvatarLabel:Object(c.a)("Add a photo, so people can easily spot your room."),setAvatarUrl:e=>t.sendStateEvent(g,i.a.RoomAvatar,{url:e},""),isDirect:Boolean(f)},a.a.createElement(h.a,{room:s,width:m.a,height:m.a})),a.a.createElement("h2",null,s.name),a.a.createElement("p",null,O," ",Object(c.a)("This is the start of <roomName/>.",{},{roomName:()=>a.a.createElement("b",null,s.name)})),a.a.createElement("p",null,p),j)}return a.a.createElement("div",{className:"mx_NewRoomIntro"},b)}}).call(this,s(167).setImmediate)},function(e,t,s){"use strict";var n=s(81),a=s.n(n),i=s(138),o=s(158),r=s(507);t.a=({description:e,acceptLabel:t,dismissLabel:s,onAccept:n,onDismiss:l,toastKey:c,numSeconds:d})=>{const m=()=>{l&&l(),i.a.sharedInstance().dismissToast(c)},h=Object(r.a)(m,1e3,d);let u=s;return h>0&&(u+=` (${h})`),a.a.createElement(o.a,{description:e,acceptLabel:t,onAccept:n,rejectLabel:u,onReject:m})}},function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(261),d=s.n(c),m=s(83),h=s(330),u=s.n(h),p=s(87),g=s(86),f=s(90),b=s.n(f),v=s(97),_=s(119);class y extends o.a.PureComponent{constructor(e,t){super(e,t),a()(this,"onAction",e=>{"client_started"===e.action&&this.forceUpdate()}),this._dispatcherRef=null,this.state={page:""}}translate(e){return u()(Object(m.a)(e))}componentDidMount(){this._unmounted=!1,this.props.url&&(d()({method:"GET",url:this.props.url},(e,t,s)=>{if(!this._unmounted){if(e||t.status<200||t.status>=300)return console.warn("Error loading page: "+e),void this.setState({page:Object(m.a)("Couldn't load page")});s=s.replace(/_t\(['"]([\s\S]*?)['"]\)/gm,(e,t)=>this.translate(t)),this.props.replaceMap&&Object.keys(this.props.replaceMap).forEach(e=>{s=s.split(e).join(this.props.replaceMap[e])}),this.setState({page:s})}}),this._dispatcherRef=p.a.register(this.onAction))}componentWillUnmount(){this._unmounted=!0,null!==this._dispatcherRef&&p.a.unregister(this._dispatcherRef)}render(){const e=this.context||g.a.get(),t=!e||e.isGuest(),s=this.props.className,n=b()({[s]:!0,[s+"_guest"]:t,[s+"_loggedIn"]:!!e}),a=o.a.createElement("div",{className:s+"_body",dangerouslySetInnerHTML:{__html:this.state.page}});return this.props.scrollbar?o.a.createElement(_.a,{className:n},a):o.a.createElement("div",{className:n},a)}}a()(y,"propTypes",{url:l.a.string,className:l.a.string,scrollbar:l.a.bool,replaceMap:l.a.object}),a()(y,"contextType",v.a)},function(e,t){e.exports="img/icons-create-room.817ede2.svg"},function(e,t){e.exports="img/cancel-small.495f44c.svg"},,function(e,t,s){"use strict";s.d(t,"a",(function(){return h})),s.d(t,"b",(function(){return u}));var n=s(81),a=s.n(n),i=s(139),o=s.n(i),r=s(86),l=s(88),c=s(263),d=s(486),m=s(110);function h(e,t,s){const n=r.a.get().getRoom(t.getRoomId()),i=l.a.getValue("Pill.shouldShowPillAvatar");let u=e[0];for(;u;){let e=!1;if("A"===u.tagName&&u.getAttribute("href")){const t=u.getAttribute("href"),r=Object(m.h)(t);if(r&&!r.eventId){const r=document.createElement("span"),l=a.a.createElement(d.a,{url:t,inMessage:!0,room:n,shouldShowPillAvatar:i});o.a.render(l,r),u.parentNode.replaceChild(r,u),s.push(r),e=!0,u=r}}else if(u.nodeType===Node.TEXT_NODE&&!u.parentElement.classList.contains("mx_AtRoomPill")){let e=u;const l=[];for(;null!==e;){const t=d.a.roomNotifPos(e.textContent);let s=null;if(t>-1){let n=e;t>0&&(n=n.splitText(t)),n.textContent.length>d.a.roomNotifLen()&&(s=n.splitText(d.a.roomNotifLen())),l.push(n)}e=s}if(l.length>0){const e=new c.a(r.a.get()),m=e.getPushRuleById(".m.rule.roomnotif");if(m&&e.ruleMatchesEvent(m,t)){for(const e of l){u=e.nextSibling;const t=document.createElement("span"),r=a.a.createElement(d.a,{type:d.a.TYPE_AT_ROOM_MENTION,inMessage:!0,room:n,shouldShowPillAvatar:i});o.a.render(r,t),e.parentNode.replaceChild(t,e),s.push(t)}continue}}}u.childNodes&&u.childNodes.length&&!e&&h(u.childNodes,t,s),u=u.nextSibling}}function u(e){for(const t of e)o.a.unmountComponentAtNode(t)}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return y}));var n=s(82),a=s.n(n),i=s(137),o=s(120);var r=s(86),l=s(642),c=s(89),d=s(680),m=s(764);const h={};var u=s(681),p=s(132),g=s(124),f=s(202),b=s(292),v=s(87),_=s(110);class y extends i.WidgetDriver{constructor(e,t,s,n){if(super(),this.forWidget=t,this.forWidgetKind=s,this.inRoomId=n,a()(this,"allowedCapabilities",void 0),this.allowedCapabilities=new Set([...e,i.MatrixCapabilities.Screenshots]),p.a.JITSI.matches(this.forWidget.type)&&s===i.WidgetKind.Room)this.allowedCapabilities.add(i.MatrixCapabilities.AlwaysOnScreen);else if(p.a.STICKERPICKER.matches(this.forWidget.type)&&s===i.WidgetKind.Account){const e=i.WidgetEventCapability.forRoomEvent(i.EventDirection.Send,g.a.Sticker).raw;this.allowedCapabilities.add(i.MatrixCapabilities.StickerSending),this.allowedCapabilities.add(e),this.allowedCapabilities.add("visibility")}}async validateCapabilities(e){const t=(s=e,n=this.allowedCapabilities,Object(o.b)(Array.from(s),Array.from(n)));var s,n;const a=new Set(t.removed),i=new Set(this.allowedCapabilities);if(Object(m.b)(this.forWidget).forEach(e=>{i.add(e),a.delete(e)}),h.preapproveCapabilities){const t=await h.preapproveCapabilities(this.forWidget,e);t&&t.forEach(e=>{i.add(e),a.delete(e)})}if(a.size>0)try{const[e]=await c.a.createTrackedDialog("Approve Widget Caps","",m.a,{requestedCapabilities:a,widget:this.forWidget,widgetKind:this.forWidgetKind}).finished;(e.approved||[]).forEach(e=>i.add(e))}catch(e){console.error("Non-fatal error getting capabilities: ",e)}return new Set(function(e,t){return Object(o.g)(Array.from(e),Array.from(t))}(i,e))}async sendEvent(e,t,s=null){const n=r.a.get(),a=l.a.activeRoomId;if(!n||!a)throw new Error("Not in a room or not attached to a client");let i=null;return null!==s?i=await n.sendStateEvent(a,e,t,s):(i=await n.sendEvent(a,e,t),e===g.a.RoomMessage&&f.CHAT_EFFECTS.forEach(e=>{Object(b.containsEmoji)(t,e.emojis)&&v.a.dispatch({action:"effects."+e.command})})),{roomId:a,eventId:i.event_id}}async askOpenID(e){const t=u.b.instance.getOIDCState(this.forWidget,this.forWidgetKind,this.inRoomId),s=()=>r.a.get().getOpenIdToken();return t===u.a.Denied?e.update({state:i.OpenIDRequestState.Blocked}):t===u.a.Allowed?e.update({state:i.OpenIDRequestState.Allowed,token:await s()}):(e.update({state:i.OpenIDRequestState.PendingUserConfirmation}),void c.a.createTrackedDialog("OpenID widget permissions","",d.a,{widget:this.forWidget,widgetKind:this.forWidgetKind,inRoomId:this.inRoomId,onFinished:async t=>t?e.update({state:i.OpenIDRequestState.Allowed,token:await s()}):e.update({state:i.OpenIDRequestState.Blocked})}))}async navigate(e){const t=Object(_.k)(e);if(!t||t===e)throw new Error("Failed to transform URI");window.location.hash=t}}},,function(e,t,s){"use strict";s.d(t,"b",(function(){return b})),s.d(t,"a",(function(){return v}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(131),l=s(83),c=s(137),d=s(152),m=s(145),h=s(201),u=s(143),p=s(124),g=s(682);class f{static bylineFor(e){return e.isState?e.keyStr?Object(l.a)("with state key %(stateKey)s",{stateKey:e.keyStr}):Object(l.a)("with an empty state key"):null}static for(e,t){if(f.simpleCaps[e]){const s=f.simpleCaps[e];if(s[t])return{primary:Object(l.a)(s[t])};if(s.generic)return{primary:Object(l.a)(s.generic)}}const[s]=c.WidgetEventCapability.findEventCapabilities([e]);if(s){if(!s.isState&&s.eventType===p.a.RoomMessage)return f.forRoomMessageCap(s,t);const e=s.isState?f.stateSendRecvCaps:f.nonStateSendRecvCaps;if(e[s.eventType]){const n=e[s.eventType],a=n[t]||n.generic;if(a&&a[s.direction])return{primary:Object(l.a)(a[s.direction])}}return t===c.WidgetKind.Room?s.direction===c.EventDirection.Send?{primary:Object(l.a)("Send <b>%(eventType)s</b> events as you in this room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:f.bylineFor(s)}:{primary:Object(l.a)("See <b>%(eventType)s</b> events posted to this room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:f.bylineFor(s)}:s.direction===c.EventDirection.Send?{primary:Object(l.a)("Send <b>%(eventType)s</b> events as you in your active room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:f.bylineFor(s)}:{primary:Object(l.a)("See <b>%(eventType)s</b> events posted to your active room",{eventType:s.eventType},{b:e=>o.a.createElement("b",null,e)}),byline:f.bylineFor(s)}}return{primary:Object(l.a)("The <b>%(capability)s</b> capability",{capability:e},{b:e=>o.a.createElement("b",null,e)})}}static forRoomMessageCap(e,t){if(!e.keyStr)return e.direction===c.EventDirection.Send?{primary:t===c.WidgetKind.Room?Object(l.a)("Send messages as you in this room"):Object(l.a)("Send messages as you in your active room")}:{primary:t===c.WidgetKind.Room?Object(l.a)("See messages posted to this room"):Object(l.a)("See messages posted to your active room")};switch(e.keyStr){case p.b.Text:return e.direction===c.EventDirection.Send?{primary:t===c.WidgetKind.Room?Object(l.a)("Send text messages as you in this room"):Object(l.a)("Send text messages as you in your active room")}:{primary:t===c.WidgetKind.Room?Object(l.a)("See text messages posted to this room"):Object(l.a)("See text messages posted to your active room")};case p.b.Emote:return e.direction===c.EventDirection.Send?{primary:t===c.WidgetKind.Room?Object(l.a)("Send emotes as you in this room"):Object(l.a)("Send emotes as you in your active room")}:{primary:t===c.WidgetKind.Room?Object(l.a)("See emotes posted to this room"):Object(l.a)("See emotes posted to your active room")};case p.b.Image:return e.direction===c.EventDirection.Send?{primary:t===c.WidgetKind.Room?Object(l.a)("Send images as you in this room"):Object(l.a)("Send images as you in your active room")}:{primary:t===c.WidgetKind.Room?Object(l.a)("See images posted to this room"):Object(l.a)("See images posted to your active room")};case p.b.Video:return e.direction===c.EventDirection.Send?{primary:t===c.WidgetKind.Room?Object(l.a)("Send videos as you in this room"):Object(l.a)("Send videos as you in your active room")}:{primary:t===c.WidgetKind.Room?Object(l.a)("See videos posted to this room"):Object(l.a)("See videos posted to your active room")};case p.b.File:return e.direction===c.EventDirection.Send?{primary:t===c.WidgetKind.Room?Object(l.a)("Send general files as you in this room"):Object(l.a)("Send general files as you in your active room")}:{primary:t===c.WidgetKind.Room?Object(l.a)("See general files posted to this room"):Object(l.a)("See general files posted to your active room")};default:{let s;return s=e.direction===c.EventDirection.Send?t===c.WidgetKind.Room?Object(l.a)("Send <b>%(msgtype)s</b> messages as you in this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(l.a)("Send <b>%(msgtype)s</b> messages as you in your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):t===c.WidgetKind.Room?Object(l.a)("See <b>%(msgtype)s</b> messages posted to this room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}):Object(l.a)("See <b>%(msgtype)s</b> messages posted to your active room",{msgtype:e.keyStr},{b:e=>o.a.createElement("b",null,e)}),{primary:s}}}}}function b(e){return JSON.parse(localStorage.getItem(`widget_${e.id}_approved_caps`)||"[]")}a()(f,"simpleCaps",{[c.MatrixCapabilities.AlwaysOnScreen]:{[c.WidgetKind.Room]:Object(l.b)("Remain on your screen when viewing another room, when running"),generic:Object(l.b)("Remain on your screen while running")},[c.MatrixCapabilities.StickerSending]:{[c.WidgetKind.Room]:Object(l.b)("Send stickers into this room"),generic:Object(l.b)("Send stickers into your active room")},[g.a.CanChangeViewedRoom]:{generic:Object(l.b)("Change which room you're viewing")},[c.MatrixCapabilities.MSC2931Navigate]:{generic:Object(l.b)("Change which room, message, or user you're viewing")}}),a()(f,"stateSendRecvCaps",{[p.a.RoomTopic]:{[c.WidgetKind.Room]:{[c.EventDirection.Send]:Object(l.b)("Change the topic of this room"),[c.EventDirection.Receive]:Object(l.b)("See when the topic changes in this room")},generic:{[c.EventDirection.Send]:Object(l.b)("Change the topic of your active room"),[c.EventDirection.Receive]:Object(l.b)("See when the topic changes in your active room")}},[p.a.RoomName]:{[c.WidgetKind.Room]:{[c.EventDirection.Send]:Object(l.b)("Change the name of this room"),[c.EventDirection.Receive]:Object(l.b)("See when the name changes in this room")},generic:{[c.EventDirection.Send]:Object(l.b)("Change the name of your active room"),[c.EventDirection.Receive]:Object(l.b)("See when the name changes in your active room")}},[p.a.RoomAvatar]:{[c.WidgetKind.Room]:{[c.EventDirection.Send]:Object(l.b)("Change the avatar of this room"),[c.EventDirection.Receive]:Object(l.b)("See when the avatar changes in this room")},generic:{[c.EventDirection.Send]:Object(l.b)("Change the avatar of your active room"),[c.EventDirection.Receive]:Object(l.b)("See when the avatar changes in your active room")}}}),a()(f,"nonStateSendRecvCaps",{[p.a.Sticker]:{[c.WidgetKind.Room]:{[c.EventDirection.Send]:Object(l.b)("Send stickers to this room as you"),[c.EventDirection.Receive]:Object(l.b)("See when a sticker is posted in this room")},generic:{[c.EventDirection.Send]:Object(l.b)("Send stickers to your active room as you"),[c.EventDirection.Receive]:Object(l.b)("See when anyone posts a sticker to your active room")}}});class v extends o.a.PureComponent{constructor(e){super(e),a()(this,"eventPermissionsMap",new Map),a()(this,"onToggle",e=>{const t=Object(d.e)(this.state.booleanStates);t[e]=!t[e],this.setState({booleanStates:t})}),a()(this,"onRememberSelectionChange",e=>{this.setState({rememberSelection:e})}),a()(this,"onSubmit",async e=>{this.closeAndTryRemember(Object.entries(this.state.booleanStates).filter(([e,t])=>t).map(([e])=>e))}),a()(this,"onReject",async e=>{this.closeAndTryRemember([])});c.WidgetEventCapability.findEventCapabilities(this.props.requestedCapabilities).forEach(e=>this.eventPermissionsMap.set(e.raw,e));const t={};this.props.requestedCapabilities.forEach(e=>t[e]=!0),this.state={booleanStates:t,rememberSelection:!0}}closeAndTryRemember(e){var t,s;this.state.rememberSelection&&(t=this.props.widget,s=e,localStorage.setItem(`widget_${t.id}_approved_caps`,JSON.stringify(s))),this.props.onFinished({approved:e})}render(){const e=Object.entries(this.state.booleanStates).map(([e,t],s)=>{const n=f.for(e,this.props.widgetKind),a=n.byline?o.a.createElement("span",{className:"mx_WidgetCapabilitiesPromptDialog_byline"},n.byline):null;return o.a.createElement("div",{className:"mx_WidgetCapabilitiesPromptDialog_cap",key:e+s},o.a.createElement(m.a,{checked:t,onChange:()=>this.onToggle(e)},n.primary),a)});return o.a.createElement(r.a,{className:"mx_WidgetCapabilitiesPromptDialog",onFinished:this.props.onFinished,title:Object(l.a)("Approve widget permissions")},o.a.createElement("form",{onSubmit:this.onSubmit},o.a.createElement("div",{className:"mx_Dialog_content"},o.a.createElement("div",{className:"text-muted"},Object(l.a)("This widget would like to:")),e,o.a.createElement(h.a,{primaryButton:Object(l.a)("Approve"),cancelButton:Object(l.a)("Decline All"),onPrimaryButtonClick:this.onSubmit,onCancel:this.onReject,additive:o.a.createElement(u.a,{value:this.state.rememberSelection,toggleInFront:!0,onChange:this.onRememberSelectionChange,label:Object(l.a)("Remember my selection for this widget")})}))))}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(86),d=s(91),m=s(742),h=s(83);class u extends o.a.Component{constructor(...e){super(...e),a()(this,"state",{loading:!0}),a()(this,"_onStateEvent",e=>{e.getRoomId()===this.props.room.roomId&&"m.room.pinned_events"===e.getType()&&this._updatePinnedMessages()}),a()(this,"_updatePinnedMessages",()=>{const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");if(e&&e.getContent().pinned){const t=[],s=c.a.get();e.getContent().pinned.map(e=>{t.push(s.getEventTimeline(this.props.room.getUnfilteredTimelineSet(),e,0).then(t=>{const s=t.getEvents().find(t=>t.getId()===e);return{eventId:e,timeline:t,event:s}}).catch(t=>(console.error("Error looking up pinned event "+e+" in room "+this.props.room.roomId),console.error(t),null)))}),Promise.all(t).then(e=>{const t=e.filter(e=>class{static isPinnable(e){return!!e&&("m.room.message"===e.getType()&&!e.isRedacted())}}.isPinnable(e.event));this.setState({loading:!1,pinned:t})})}else this.setState({loading:!1,pinned:[]});this._updateReadState()})}componentDidMount(){this._updatePinnedMessages(),c.a.get().on("RoomState.events",this._onStateEvent)}componentWillUnmount(){c.a.get()&&c.a.get().removeListener("RoomState.events",this._onStateEvent)}_updateReadState(){const e=this.props.room.currentState.getStateEvents("m.room.pinned_events","");if(!e)return;let t=[];const s=this.props.room.getAccountData("im.vector.room.read_pins");s&&s.getContent()&&(t=s.getContent().event_ids||[]),t.includes(e.getId())||(t.push(e.getId()),t=t.reverse().splice(0,10).reverse(),c.a.get().setRoomAccountData(this.props.room.roomId,"im.vector.room.read_pins",{event_ids:t}))}_getPinnedTiles(){return 0===this.state.pinned.length?o.a.createElement("div",null,Object(h.a)("No pinned messages.")):this.state.pinned.map(e=>o.a.createElement(m.a,{key:e.event.getId(),mxRoom:this.props.room,mxEvent:e.event,onUnpinned:this._updatePinnedMessages}))}render(){let e=o.a.createElement("div",null,Object(h.a)("Loading..."));return this.state&&!this.state.loading&&(e=this._getPinnedTiles()),o.a.createElement("div",{className:"mx_PinnedEventsPanel"},o.a.createElement("div",{className:"mx_PinnedEventsPanel_body"},o.a.createElement(d.a,{className:"mx_PinnedEventsPanel_cancel",onClick:this.props.onCancelClick},o.a.createElement("img",{className:"mx_filterFlipColor",src:s(222),width:"18",height:"18"})),o.a.createElement("h3",{className:"mx_PinnedEventsPanel_header"},Object(h.a)("Pinned Messages")),e))}}a()(u,"propTypes",{room:l.a.object.isRequired,onCancelClick:l.a.func})},function(e,t,s){"use strict";s.d(t,"a",(function(){return R}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(90),d=s.n(c),m=s(344),h=s(291),u=s(87),p=s(85),g=s(629),f=s(122),b=s(243),v=s(164),_=s(88),y=s(690),E=s(465),C=s(467),w=s(466),S=s(173),x=s(638);class R extends o.a.Component{constructor(e){super(e),a()(this,"onIsResizing",e=>{this.setState({resizing:e}),e||this._relaxResizer()}),a()(this,"_collectResizer",e=>{this._resizeContainer&&this.resizer.detach(),e&&(this.resizer.container=e,this.resizer.attach()),this._resizeContainer=e,this._loadResizerPreferences()}),a()(this,"_getAppsHash",e=>e.map(e=>e.id).join("~")),a()(this,"_relaxResizer",()=>{const e=this.resizer.getDistributors();e.forEach(e=>e.start()),e.forEach(e=>e.finish())}),a()(this,"_loadResizerPreferences",()=>{const e=S.d.instance.getResizerDistributions(this.props.room,S.a.Top);if(this.state.apps&&this.state.apps.length-1===e.length)e.forEach((e,t)=>{const s=this.resizer.forHandleAt(t);s&&(s.size=e,s.finish())});else if(this.state.apps){const e=this.resizer.getDistributors();e.forEach(e=>e.item.clearSize()),e.forEach(e=>e.start()),e.forEach(e=>e.finish())}}),a()(this,"onAction",e=>{const t=this.props.room.roomId+"_hide_widget_drawer";switch(e.action){case"appsDrawer":e.show?localStorage.setItem(t,"false"):localStorage.setItem(t,"true")}}),a()(this,"_getApps",()=>S.d.instance.getContainerWidgets(this.props.room,S.a.Top)),a()(this,"_updateApps",()=>{this.setState({apps:this._getApps()})}),this.state={apps:this._getApps()},this._resizeContainer=null,this.resizer=this._createResizer(),this.props.resizeNotifier.on("isResizing",this.onIsResizing)}componentDidMount(){g.b(),S.d.instance.on(S.d.emissionForRoom(this.props.room),this._updateApps),this.dispatcherRef=u.a.register(this.onAction)}componentWillUnmount(){g.c(),S.d.instance.off(S.d.emissionForRoom(this.props.room),this._updateApps),this.dispatcherRef&&u.a.unregister(this.dispatcherRef),this._resizeContainer&&this.resizer.detach(),this.props.resizeNotifier.off("isResizing",this.onIsResizing)}UNSAFE_componentWillReceiveProps(e){this._updateApps()}_createResizer(){const e={onResizeStart:()=>{this._resizeContainer.classList.add("mx_AppsDrawer_resizing")},onResizeStop:()=>{this._resizeContainer.classList.remove("mx_AppsDrawer_resizing"),S.d.instance.setResizerDistributions(this.props.room,S.a.Top,this.state.apps.slice(1).map((e,t)=>this.resizer.forHandleAt(t).size))}},t=new C.a({},w.a,e);return t.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),t}componentDidUpdate(e,t){this._getAppsHash(this.state.apps)!==this._getAppsHash(t.apps)&&this._loadResizerPreferences()}_launchManageIntegrations(){_.a.getValue("feature_many_integration_managers")?v.a.sharedInstance().openAll():v.a.sharedInstance().getPrimaryManager().open(this.props.room,"add_integ")}render(){if(!this.props.showApps)return o.a.createElement("div",null);const e=this.state.apps.map((e,t,s)=>o.a.createElement(h.a,{key:e.id,app:e,fullWidth:s.length<2,room:this.props.room,userId:this.props.userId,creatorUserId:e.creatorUserId,widgetPageTitle:f.a.getWidgetDataTitle(e),waitForIframeLoad:e.waitForIframeLoad}));if(0===e.length)return o.a.createElement("div",null);let t;if(0===e.length&&b.a.roomHasPendingWidgets(this.props.room.roomId,f.a.getRoomWidgets(this.props.room))){const e=p.getComponent("elements.Spinner");t=o.a.createElement(e,null)}const s=d()({mx_AppsDrawer:!0,mx_AppsDrawer_fullWidth:e.length<2,mx_AppsDrawer_resizing:this.state.resizing,mx_AppsDrawer_2apps:2===e.length,mx_AppsDrawer_3apps:3===e.length});return o.a.createElement("div",{className:s},o.a.createElement(O,{room:this.props.room,minHeight:100,maxHeight:this.props.maxHeight?this.props.maxHeight-50:void 0,handleClass:"mx_AppsContainer_resizerHandle",handleWrapperClass:"mx_AppsContainer_resizerHandleContainer",className:"mx_AppsContainer_resizer",resizeNotifier:this.props.resizeNotifier},o.a.createElement("div",{className:"mx_AppsContainer",ref:this._collectResizer},e.map((t,s)=>s<1?t:o.a.createElement(o.a.Fragment,{key:t.key},o.a.createElement(E.a,{reverse:s>e.length/2}),t)))),t)}}a()(R,"propTypes",{userId:l.a.string.isRequired,room:l.a.object.isRequired,resizeNotifier:l.a.instanceOf(y.a).isRequired,showApps:l.a.bool}),a()(R,"defaultProps",{showApps:!0});const O=({room:e,minHeight:t,maxHeight:s,className:n,handleWrapperClass:a,handleClass:r,resizeNotifier:l,children:c})=>{let d=S.d.instance.getContainerHeight(e,S.a.Top);t||(t=100),s||(s=window.innerHeight/4*3),d?(d=Object(x.a)(d,0,100),d=Object(x.d)(d/100,t,s)):d=280;const[h,u]=((e,t)=>{const[s,n]=Object(i.useState)(e);return[s,e=>{n(e),t(e)}]})(d,n=>{n=100*Object(x.c)(n,t,s),S.d.instance.setContainerHeight(e,S.a.Top,n)});return o.a.createElement(m.Resizable,{size:{height:Math.min(h,s)},minHeight:t,maxHeight:s,onResizeStart:()=>{l.startResizing()},onResize:()=>{l.notifyTimelineHeightChanged()},onResizeStop:(e,t,s,n)=>{u(h+n.height),l.stopResizing()},handleWrapperClass:a,handleClasses:{bottom:r},className:n,enable:{bottom:!0}},c)}},function(e,t,s){"use strict";s.d(t,"b",(function(){return l})),s.d(t,"c",(function(){return d})),s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(1096),o=s.n(i);class r{constructor(e){a()(this,"_regex",void 0);const t=o()(e,{extended:!1,globstar:!1}).toString().replace(/\\\?/g,".");this._regex=new RegExp(t.substring(1,t.length-1))}test(e){return this._regex.test(e)}}const l="m.ban",c=[l,"org.matrix.mjolnir.ban"];function d(e,t=!0){return c.includes(e)?t?c[c.length-1]:l:null}class m{constructor(e,t,s,n){a()(this,"_glob",void 0),a()(this,"_entity",void 0),a()(this,"_action",void 0),a()(this,"_reason",void 0),a()(this,"_kind",void 0),this._glob=new r(e),this._entity=e,this._action=d(t,!1),this._reason=s,this._kind=n}get entity(){return this._entity}get reason(){return this._reason}get kind(){return this._kind}get recommendation(){return this._action}isMatch(e){return this._glob.test(e)}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return l}));var n=s(82),a=s.n(n);class i{constructor(e){this.tagId=e,a()(this,"_n",0),a()(this,"_previews",!1),a()(this,"_collapsed",!1);const t=localStorage.getItem(this.key);if(t){const e=JSON.parse(t);this._n=e.numTiles,this._previews=e.showPreviews,this._collapsed=e.collapsed}}get isCollapsed(){return this._collapsed}set isCollapsed(e){this._collapsed=e,this.save()}get showPreviews(){return this._previews}set showPreviews(e){this._previews=e,this.save()}get tileHeight(){return 57}get key(){return`mx_sublist_layout_${this.tagId}_boxed`}get visibleTiles(){return 0===this._n?this.defaultVisibleTiles:Math.max(this._n,this.minVisibleTiles)}set visibleTiles(e){this._n=e,this.save()}get minVisibleTiles(){return 1}get defaultVisibleTiles(){return 5}tilesWithPadding(e,t){return this.pixelsToTiles(this.tilesToPixelsWithPadding(e,t))}tilesToPixelsWithPadding(e,t){return this.tilesToPixels(e)+t}tilesToPixels(e){return e*this.tileHeight}pixelsToTiles(e){return e/this.tileHeight}reset(){localStorage.removeItem(this.key)}save(){localStorage.setItem(this.key,JSON.stringify(this.serialize()))}serialize(){return{numTiles:this.visibleTiles,showPreviews:this.showPreviews,collapsed:this.isCollapsed}}}var o=s(147),r=s(87);class l extends o.a{constructor(){super(r.a),a()(this,"layoutMap",new Map)}static get instance(){return l.internalInstance||(l.internalInstance=new l),l.internalInstance}ensureLayoutExists(e){this.layoutMap.has(e)||this.layoutMap.set(e,new i(e))}getLayoutFor(e){return this.layoutMap.has(e)||this.layoutMap.set(e,new i(e)),this.layoutMap.get(e)}async resetLayouts(){console.warn("Resetting layouts for room list");for(const e of this.layoutMap.values())e.reset()}async onNotReady(){this.layoutMap.clear()}async onAction(e){return Promise.resolve()}}a()(l,"internalInstance",void 0),window.mxRoomListLayoutStore=l.instance},function(e,t,s){"use strict";s.d(t,"a",(function(){return N})),s.d(t,"b",(function(){return P}));var n=s(82),a=s.n(n),i=s(137),o=s(762),r=s(6),l=s(260),c=s(128),d=s(86),m=s(204),h=s(122),u=s(164),p=s(88),g=s(132),f=s(244),b=s(152),v=s(87),_=s(7),y=s(147),E=s(89),C=s(683);function w(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function S(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?w(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):w(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class x extends y.a{constructor(){super(v.a,{}),a()(this,"modalInstance",null),a()(this,"openSourceWidgetId",null),a()(this,"canOpenModalWidget",()=>!this.modalInstance),a()(this,"openModalWidget",(e,t,s)=>{this.modalInstance||(this.openSourceWidgetId=t.id,this.modalInstance=E.a.createTrackedDialog("Modal Widget","",C.a,{widgetDefinition:S({},e),widgetRoomId:s,sourceWidgetId:t.id,onFinished:(e,s)=>{e?this.closeModalWidget(t,s):this.closeModalWidget(t,{"m.exited":!0}),this.openSourceWidgetId=null,this.modalInstance=null}},null,!1,!0))}),a()(this,"closeModalWidget",(e,t)=>{if(this.modalInstance&&this.openSourceWidgetId===e.id){this.openSourceWidgetId=null,this.modalInstance.close(),this.modalInstance=null;const s=l.a.instance.getMessaging(e);if(!s)return void console.error("No source widget messaging for modal widget");s.notifyModalWidgetClose(t)}})}static get instance(){return x.internalInstance}async onAction(e){}}a()(x,"internalInstance",new x),window.mxModalWidgetStore=x.instance;var R=s(351),O=s(253),k=s(105),I=s(682);function T(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function j(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?T(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):T(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class N extends i.Widget{constructor(e){super(e),this.rawDefinition=e}get templateUrl(){var e;return g.a.JITSI.matches(this.type)?h.a.getLocalJitsiWrapperUrl({forLocalRender:!0,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):super.templateUrl}get popoutTemplateUrl(){var e;return g.a.JITSI.matches(this.type)?h.a.getLocalJitsiWrapperUrl({forLocalRender:!1,auth:null===(e=super.rawData)||void 0===e?void 0:e.auth}):this.templateUrl}get rawData(){let e=super.rawData.conferenceId;if(void 0===e){e=new URL(super.templateUrl).searchParams.get("confId")}let t=super.rawData.domain;void 0===t&&(t="jitsi.riot.im");let s=(new R.a).getEffectiveTheme();if(s.startsWith("custom-")){const e=Object(O.c)(s.substr(7));s=e.is_dark?"dark":"light"}return s=s.includes("light")?"light":"dark",j(j({},super.rawData),{},{theme:s,conferenceId:e,domain:t})}getCompleteUrl(e,t=!1){return Object(i.runTemplate)(t?this.popoutTemplateUrl:this.templateUrl,j(j({},this.rawDefinition),{},{data:this.rawData}),e)}}class P extends r.EventEmitter{constructor(e){var t;super(),this.appTileProps=e,a()(this,"messaging",void 0),a()(this,"mockWidget",void 0),a()(this,"scalarToken",void 0),a()(this,"roomId",void 0),a()(this,"kind",void 0),a()(this,"onOpenModal",async e=>{e.preventDefault(),x.instance.canOpenModalWidget()?(x.instance.openModalWidget(e.detail.data,this.mockWidget),this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"Unable to open modal at this time"}})}),a()(this,"onEvent",e=>{e.isBeingDecrypted()||e.isDecryptionFailure()||e.getRoomId()===this.eventListenerRoomId&&this.feedEvent(e)}),a()(this,"onEventDecrypted",e=>{e.isDecryptionFailure()||e.getRoomId()===this.eventListenerRoomId&&this.feedEvent(e)});let s=e.app;s.creatorUserId||(s=Object(b.e)(s),s.creatorUserId=d.a.get().getUserId()),this.mockWidget=new N(s),this.roomId=null===(t=e.room)||void 0===t?void 0:t.roomId,this.kind=e.userWidget?i.WidgetKind.Account:i.WidgetKind.Room}get eventListenerRoomId(){return this.roomId?this.roomId:c.a.getRoomId()}get widgetApi(){return this.messaging}get embedUrl(){return this.runUrlTemplate({asPopout:!1})}get popoutUrl(){return this.runUrlTemplate({asPopout:!0})}runUrlTemplate(e={asPopout:!1}){const t=this.mockWidget.getCompleteUrl({widgetRoomId:this.roomId,currentUserId:d.a.get().getUserId(),userDisplayName:m.a.instance.displayName,userHttpAvatarUrl:m.a.instance.getHttpAvatarUrl()},null==e?void 0:e.asPopout),s=new URL(t);return null!=e&&e.asPopout||(s.searchParams.set("widgetId",this.mockWidget.id),s.searchParams.set("parentUrl",window.location.href.split("#",2)[0]),this.scalarToken&&s.searchParams.set("scalar_token",this.scalarToken)),s.toString().replace(/%24/g,"$")}get isManagedByManager(){return!!this.scalarToken}get started(){return!!this.messaging}get widgetId(){return this.messaging.widget.id}start(e){if(this.started)return;const t=this.appTileProps.whitelistCapabilities||[],s=new o.a(t,this.mockWidget,this.kind,this.roomId);this.messaging=new i.ClientWidgetApi(this.mockWidget,e,s),this.messaging.on("preparing",()=>this.emit("preparing")),this.messaging.on("ready",()=>this.emit("ready")),this.messaging.on("action:"+i.WidgetApiFromWidgetAction.OpenModalWidget,this.onOpenModal),l.a.instance.storeMessaging(this.mockWidget,this.messaging),!this.appTileProps.userWidget&&this.appTileProps.room&&f.a.setRoomId(this.mockWidget.id,this.appTileProps.room.roomId),this.messaging.on("action:"+_.a.ViewRoom,e=>{e.preventDefault();const t=(e.detail.data||{}).room_id;return t?this.messaging.hasCapability(I.a.CanChangeViewedRoom)?(v.a.dispatch({action:"view_room",room_id:t}),void this.messaging.transport.reply(e.detail,{})):this.messaging.transport.reply(e.detail,{error:{message:"This widget does not have permission for this action (denied)."}}):this.messaging.transport.reply(e.detail,{error:{message:"Room ID not supplied."}})}),d.a.get().on("event",this.onEvent),d.a.get().on("Event.decrypted",this.onEventDecrypted),this.messaging.on("action:"+i.WidgetApiFromWidgetAction.UpdateAlwaysOnScreen,e=>{this.messaging.hasCapability(i.MatrixCapabilities.AlwaysOnScreen)&&(g.a.JITSI.matches(this.mockWidget.type)&&k.a.instance.trackJoinCall(this.appTileProps.room.roomId,!0,!0),f.a.setWidgetPersistence(this.mockWidget.id,e.detail.data.value),e.preventDefault(),this.messaging.transport.reply(e.detail,{}))}),this.messaging.on("action:"+i.WidgetApiFromWidgetAction.SendSticker,e=>{this.messaging.hasCapability(i.MatrixCapabilities.StickerSending)&&(e.preventDefault(),this.messaging.transport.reply(e.detail,{}),v.a.dispatch({action:"m.sticker",data:e.detail.data,widgetId:this.mockWidget.id}))}),g.a.STICKERPICKER.matches(this.mockWidget.type)&&this.messaging.on("action:"+_.a.OpenIntegrationManager,e=>{e.preventDefault(),this.messaging.transport.reply(e.detail,{}),v.a.dispatch({action:"stickerpicker_close"});const t=e.detail.data,s=null==t?void 0:t.integType,n=null==t?void 0:t.integId;p.a.getValue("feature_many_integration_managers")?u.a.sharedInstance().openAll(d.a.get().getRoom(c.a.getRoomId()),"type_"+s,n):u.a.sharedInstance().getPrimaryManager().open(d.a.get().getRoom(c.a.getRoomId()),"type_"+s,n)})}async prepare(){if(this.scalarToken)return;const e=l.a.instance.getMessaging(this.mockWidget);e&&(this.messaging=e);try{if(h.a.isScalarUrl(this.mockWidget.templateUrl)){const e=u.a.sharedInstance();if(e.hasManager()){const t=e.getPrimaryManager();if(h.a.isScalarUrl(t.apiUrl)){const e=t.getScalarClient();this.scalarToken=await e.getScalarToken()}}}}catch(e){console.error("Error preparing widget communications: ",e)}}stop(e={forceDestroy:!1}){null!=e&&e.forceDestroy||f.a.getPersistentWidgetId()!==this.mockWidget.id?this.started&&(l.a.instance.stopMessaging(this.mockWidget),f.a.delRoomId(this.mockWidget.id),d.a.get()&&(d.a.get().off("event",this.onEvent),d.a.get().off("Event.decrypted",this.onEventDecrypted))):console.log("Skipping destroy - persistent widget")}feedEvent(e){if(!this.messaging)return;const t=e.event;this.messaging.feedEvent(t).catch(e=>{console.error("Error sending event to widget: ",e)})}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return r}));var n=s(82),a=s.n(n);const i={};var o=s(639);class r{constructor(){}static get instance(){return r.internalInstance||(r.internalInstance=new r),r.internalInstance}isRoomVisible(e){let t=!0,s=!1;Object(o.d)()&&Object(o.b)(e.roomId)&&(t=!1,s=!0);const n=i.isRoomVisible;return!s&&n&&(t=n(e)),t}}a()(r,"internalInstance",void 0)},,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){class n{constructor(){this.components=null}getComponent(e){if(!e)throw new Error("Invalid component name: "+e);if(null===this.components)throw new Error("Attempted to get a component before a skin has been loaded. This is probably because either: a) Your app has not called sdk.loadSkin(), or b) A component has called getComponent at the root level");const t=(t=>{if(!t)return null;let s=t[e];return s||(s=t["views."+e]),s})(this.components);if(!t)return null;if(!("function"==typeof t||t.render))throw new Error(`Not a valid component: ${e} (type = ${typeof t}).`);return t}load(e){if(null!==this.components)throw new Error("Attempted to load a skin while a skin is already loadedIf you want to change the active skin, call resetSkin first");this.components={};const t=Object.keys(e.components);for(let s=0;s<t.length;++s){const n=e.components[t[s]];this.addComponent(t[s],n)}const n=s(1496);if(!n||!n.components)throw new Error("Invalid react-sdk component index");for(const e in n.components)this.components[e]||(this.components[e]=n.components[e])}addComponent(e,t){let s=e;void 0!==t.replaces&&(s=t.replaces.indexOf(".")>-1?t.replaces:e.substr(0,e.lastIndexOf(".")+1)+t.replaces.split(".").pop()),this.components[s]=t}reset(){this.components=null}}void 0===e.mxSkinner&&(e.mxSkinner=new n),t.a=e.mxSkinner}).call(this,s(5))},,function(e,t){e.exports="img/feather-customised/check.5745b4e.svg"},function(e,t){e.exports="img/element-desktop-logo.93fc5eb.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){},,,,,,,,,function(e,t){},,,,,,,,,,,,function(e,t){},,,function(e,t){e.exports="img/icon-pill-remove.7719165.svg"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/rotate-ccw.96d36a7.svg"},function(e,t){e.exports="img/rotate-cw.b6a9518.svg"},function(e,t){e.exports="img/cancel-white.3709ff3.svg"},function(e,t,s){"use strict";s.d(t,"a",(function(){return i}));var n=s(82),a=s.n(n);class i{constructor(e){this.fn=e,a()(this,"marked",!1)}reset(){this.marked=!1}mark(){this.marked=!0}trigger(){this.marked&&(this.reset(),this.fn())}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(644);class a{constructor(){}static forRoom(e){return n.a.instance.getOrCreateChamberForRoom(e)}}},,function(e,t,s){"use strict";function n(){window.TouchEvent||(window.TouchEvent=class extends UIEvent{get altKey(){return!1}get changedTouches(){return[]}get ctrlKey(){return!1}get metaKey(){return!1}get shiftKey(){return!1}get targetTouches(){return[]}get touches(){return[]}get rotation(){return 0}get scale(){return 0}constructor(e,t){super(e,t)}})}s.d(t,"a",(function(){return n}))},function(e,t,s){"use strict";s.d(t,"a",(function(){return a}));var n=s(1133);function a(){return n({words:3}).raw.map(e=>e[0].toUpperCase()+e.substring(1).toLowerCase()).join("")}},,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return m})),s.d(t,"a",(function(){return h}));var n=s(86),a=s(283),i=s(122),o=s(173),r=s(243),l=s(197),c=s(92);function d(){var e;return c.a.get().widget_build_url?c.a.get().widget_build_url:null===(e=Object(a.a)())||void 0===e?void 0:e.widget_build_url}function m(){return!!d()}async function h(e){const t=n.a.get().getRoom(e);if(!t)return;if(!i.a.canUserModifyWidgets(e))return void console.error("User not allowed to modify widgets in "+e);const s=d();if(!s)return;let a;try{const t=await fetch(`${s}?roomId=${e}`);a=await t.json()}catch(t){return void console.error("Managed hybrid widget builder failed for room "+e,t)}if(!a)return;const{widget_id:c,widget:m,layout:h}=a;let u=l.a.instance.getApps(e);if(u.some(e=>e.id===c)||r.a.roomHasPendingWidgets(e,[]))return void console.error("Managed hybrid widget already present in room "+e);try{await i.a.setRoomWidgetContent(e,c,m)}catch(t){return void console.error("Unable to add managed hybrid widget in room "+e,t)}if(!o.d.instance.canCopyLayoutToRoom(t))return;u=l.a.instance.getApps(e);const p=u.find(e=>e.id===c);p&&(o.d.instance.moveToContainer(t,p,h.container),o.d.instance.setContainerHeight(t,h.container,h.height),o.d.instance.copyLayoutToRoom(t))}},,,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(82),a=s.n(n),i=s(107),o=s(86),r=s(95),l=s(134),c=s(88),d=s(6),m=s(96);class h extends d.EventEmitter{constructor(){super(),a()(this,"onSync",async(e,t,s)=>{const n=i.a.get().getEventIndexingManager();if("PREPARED"===t&&"SYNCING"===e){return await n.isEventIndexEmpty()&&await this.addInitialCheckpoints(),void this.startCrawler()}"SYNCING"!==t||"SYNCING"!==e||await n.commitLiveEvents()}),a()(this,"onRoomTimeline",async(e,t,s,n,a)=>{if(o.a.get().isRoomEncrypted(t.roomId)&&!s&&a&&a.liveEvent&&!e.isRedacted())if(e.isBeingDecrypted()){const t=e.getId();this.liveEventsForIndex.add(t)}else await this.addLiveEventToIndex(e)}),a()(this,"onRoomStateEvent",async(e,t)=>{o.a.get().isRoomEncrypted(t.roomId)&&("m.room.encryption"!==e.getType()||await this.isRoomIndexed(t.roomId)||(console.log("EventIndex: Adding a checkpoint for a newly encrypted room",t.roomId),this.addRoomCheckpoint(t.roomId,!0)))}),a()(this,"onEventDecrypted",async(e,t)=>{const s=e.getId();this.liveEventsForIndex.delete(s)&&(t||await this.addLiveEventToIndex(e))}),a()(this,"onRedaction",async(e,t)=>{if(!o.a.get().isRoomEncrypted(t.roomId))return;const s=i.a.get().getEventIndexingManager();try{await s.deleteEvent(e.getAssociatedId())}catch(e){console.log("EventIndex: Error deleting event from index",e)}}),a()(this,"onTimelineReset",async(e,t,s)=>{null!==e&&o.a.get().isRoomEncrypted(e.roomId)&&(console.log("EventIndex: Adding a checkpoint because of a limited timeline",e.roomId),this.addRoomCheckpoint(e.roomId,!1))}),this.crawlerCheckpoints=[],this._crawlerIdleTime=5e3,this._eventsPerCrawl=100,this._crawler=null,this._currentCheckpoint=null,this.liveEventsForIndex=new Set}async init(){const e=i.a.get().getEventIndexingManager();this.crawlerCheckpoints=await e.loadCheckpoints(),console.log("EventIndex: Loaded checkpoints",this.crawlerCheckpoints),this.registerListeners()}registerListeners(){const e=o.a.get();e.on("sync",this.onSync),e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted),e.on("Room.timelineReset",this.onTimelineReset),e.on("Room.redaction",this.onRedaction),e.on("RoomState.events",this.onRoomStateEvent)}removeListeners(){const e=o.a.get();null!==e&&(e.removeListener("sync",this.onSync),e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted),e.removeListener("Room.timelineReset",this.onTimelineReset),e.removeListener("Room.redaction",this.onRedaction),e.removeListener("RoomState.events",this.onRoomStateEvent))}async addInitialCheckpoints(){const e=i.a.get().getEventIndexingManager(),t=o.a.get(),s=t.getRooms().filter(e=>t.isRoomEncrypted(e.roomId));console.log("EventIndex: Adding initial crawler checkpoints"),await Promise.all(s.map(async t=>{const s=t.getLiveTimeline().getPaginationToken("b"),n={roomId:t.roomId,token:s,direction:"b",fullCrawl:!0},a={roomId:t.roomId,token:s,direction:"f"};try{n.token&&(await e.addCrawlerCheckpoint(n),this.crawlerCheckpoints.push(n)),a.token&&(await e.addCrawlerCheckpoint(a),this.crawlerCheckpoints.push(a))}catch(e){console.log("EventIndex: Error adding initial checkpoints for room",t.roomId,n,a,e)}}))}isValidEvent(e){const t=["m.room.message","m.room.name","m.room.topic"].includes(e.getType())&&!e.isRedacted()&&!e.isDecryptionFailure();let s=!0,n=!0;if("m.room.message"!==e.getType()||e.isRedacted())"m.room.topic"!==e.getType()||e.isRedacted()?"m.room.name"!==e.getType()||e.isRedacted()||e.getContent().name||(n=!1):e.getContent().topic||(n=!1);else{const t=e.getContent().msgtype;s=!!t&&!t.startsWith("m.key.verification"),e.getContent().body||(n=!1)}return t&&s&&n}eventToJson(e){const t=e.toJSON(),s=e.isEncrypted()?t.decrypted:t;return e.isEncrypted()?(s.curve25519Key=e.getSenderKey(),s.ed25519Key=e.getClaimedEd25519Key(),s.algorithm=e.getWireContent().algorithm,s.forwardingCurve25519KeyChain=e.getForwardingCurve25519KeyChain()):(delete s.curve25519Key,delete s.ed25519Key,delete s.algorithm,delete s.forwardingCurve25519KeyChain),s}async addLiveEventToIndex(e){const t=i.a.get().getEventIndexingManager();if(!this.isValidEvent(e))return;const s=this.eventToJson(e),n={displayname:e.sender.rawDisplayName,avatar_url:e.sender.getMxcAvatarUrl()};await t.addEventToIndex(s,n)}emitNewCheckpoint(){this.emit("changedCheckpoint",this.currentRoom())}async addEventsFromLiveTimeline(e){const t=e.getEvents();for(let e=0;e<t.length;e++){const s=t[e];await this.addLiveEventToIndex(s)}}async addRoomCheckpoint(e,t=!1){const s=i.a.get().getEventIndexingManager(),n=o.a.get().getRoom(e);if(!n)return;const a=n.getLiveTimeline(),r=a.getPaginationToken("b");if(!r)return void await this.addEventsFromLiveTimeline(a);const l={roomId:n.roomId,token:r,fullCrawl:t,direction:"b"};console.log("EventIndex: Adding checkpoint",l);try{await s.addCrawlerCheckpoint(l)}catch(e){console.log("EventIndex: Error adding new checkpoint for room",n.roomId,l,e)}this.crawlerCheckpoints.push(l)}async crawlerFunc(){let e=!1;const t=o.a.get(),s=i.a.get().getEventIndexingManager();this._crawler={},this._crawler.cancel=()=>{e=!0};let n=!1;for(;!e;){let a=c.a.getValueAt(m.a.DEVICE,"crawlerSleepTime");if(a=Math.max(a,100),n&&(a=this._crawlerIdleTime),null!==this._currentCheckpoint&&(this._currentCheckpoint=null,this.emitNewCheckpoint()),await Object(l.d)(a),e)break;const i=this.crawlerCheckpoints.shift();if(void 0===i){n=!0;continue}this._currentCheckpoint=i,this.emitNewCheckpoint(),n=!1;const o=t.getEventMapper({preventReEmit:!0});let r;try{r=await t._createMessagesRequest(i.roomId,i.token,this._eventsPerCrawl,i.direction)}catch(e){if(403===e.httpStatus){console.log("EventIndex: Removing checkpoint as we don't have ","permissions to fetch messages from this room.",i);try{await s.removeCrawlerCheckpoint(i)}catch(e){console.log("EventIndex: Error removing checkpoint",i,e)}continue}console.log("EventIndex: Error crawling using checkpoint:",i,",",e),this.crawlerCheckpoints.push(i);continue}if(e){this.crawlerCheckpoints.push(i);break}if(0===r.chunk.length){console.log("EventIndex: Done with the checkpoint",i);try{await s.removeCrawlerCheckpoint(i)}catch(e){console.log("EventIndex: Error removing checkpoint",i,e)}continue}const d=r.chunk.map(o);let h=[];void 0!==r.state&&(h=r.state.map(o));const u={};h.forEach(e=>{e.event.content&&"join"===e.event.content.membership&&(u[e.event.sender]={displayname:e.event.content.displayname,avatar_url:e.event.content.avatar_url})});const p=[];d.forEach(e=>{(e.isBeingDecrypted()||e.isDecryptionFailure())&&p.push(e._decryptionPromise)}),await Promise.all(p);const g=d.filter(this.isValidEvent),f=d.filter(e=>"m.room.redaction"===e.getType()),b=g.map(e=>{const t=this.eventToJson(e);let s={};t.sender in u&&(s=u[t.sender]);return{event:t,profile:s}});let v;r.end&&(v={roomId:i.roomId,token:r.end,fullCrawl:i.fullCrawl,direction:i.direction});try{for(let e=0;e<f.length;e++){const t=f[e],n=t.getAssociatedId();n?await s.deleteEvent(n):console.warn("EventIndex: Redaction event doesn't contain a valid associated event id",t)}const e=await s.addHistoricEvents(b,v,i);if(!v){console.log("EventIndex: The server didn't return a valid ","new checkpoint, not continuing the crawl.",i);continue}!0===e&&!0!==v.fullCrawl?(console.log("EventIndex: Checkpoint had already all events","added, stopping the crawl",i),await s.removeCrawlerCheckpoint(v)):(!0===e&&console.log("EventIndex: Checkpoint had already all events","added, but continuing due to a full crawl",i),this.crawlerCheckpoints.push(v))}catch(e){console.log("EventIndex: Error durring a crawl",e),this.crawlerCheckpoints.push(i)}}this._crawler=null}startCrawler(){null===this._crawler&&this.crawlerFunc()}stopCrawler(){null!==this._crawler&&this._crawler.cancel()}async close(){const e=i.a.get().getEventIndexingManager();this.removeListeners(),this.stopCrawler(),await e.closeEventIndex()}async search(e){return i.a.get().getEventIndexingManager().searchEventIndex(e)}async loadFileEvents(e,t=10,s=null,n=r.c.BACKWARDS){const a=o.a.get(),l=i.a.get().getEventIndexingManager(),c={roomId:e.roomId,limit:t};let d;s&&(c.fromEvent=s,c.direction=n);try{d=await l.loadFileEvents(c)}catch(e){return console.log("EventIndex: Error getting file events",e),[]}const m=a.getEventMapper();return d.map(t=>{const s=m(t.event),n=new r.l(e.roomId,s.getSender());n.name=t.profile.displayname+" ("+s.getSender()+")";const a=m({content:{membership:"join",avatar_url:t.profile.avatar_url,displayname:t.profile.displayname},type:"m.room.member",event_id:s.getId()+":eventIndex",room_id:s.getRoomId(),sender:s.getSender(),origin_server_ts:s.getTs(),state_key:s.getSender()});return n.events.member=a,s.sender=n,s})}async populateFileTimeline(e,t,s,n=10,a=null,i=r.c.BACKWARDS){const o=await this.loadFileEvents(s,n,a,i);null===a&&(o.reverse(),i=i==r.c.BACKWARDS?r.c.FORWARDS:r.c.BACKWARDS),o.forEach(s=>{e.eventIdToTimeline(s.getId())||e.addEventToTimeline(s,t,i==r.c.BACKWARDS)});let l=!1,c="";return o.length>0&&(c=o[o.length-1].getId(),l=!0),console.log("EventIndex: Populating file panel with",o.length,"events and setting the pagination token to",c),t.setPaginationToken(c,r.c.BACKWARDS),l}paginateTimelineWindow(e,t,s,n){const a=t.getTimelineIndex(s);if(!a)return Promise.resolve(!1);if(a.pendingPaginate)return a.pendingPaginate;if(t.extend(s,n))return Promise.resolve(!0);const i=(async(e,t,s,n,a)=>{const i=e._timelineSet,o=t.timeline.getPaginationToken(n),r=await this.populateFileTimeline(i,t.timeline,s,a,o,n);return t.pendingPaginate=null,e.extend(n,a),r})(t,a,e,s,n);return a.pendingPaginate=i,i}async getStats(){return i.a.get().getEventIndexingManager().getStats()}async isRoomIndexed(e){return i.a.get().getEventIndexingManager().isRoomIndexed(e)}currentRoom(){if(null===this._currentCheckpoint&&0===this.crawlerCheckpoints.length)return null;const e=o.a.get();return null!==this._currentCheckpoint?e.getRoom(this._currentCheckpoint.roomId):e.getRoom(this.crawlerCheckpoints[0].roomId)}crawlingRooms(){const e=new Set,t=new Set;this.crawlerCheckpoints.forEach((e,s)=>{t.add(e.roomId)}),null!==this._currentCheckpoint&&t.add(this._currentCheckpoint.roomId);const s=o.a.get();return s.getRooms().filter(e=>s.isRoomEncrypted(e.roomId)).forEach((t,s)=>{e.add(t.roomId)}),{crawlingRooms:t,totalRooms:e}}}},function(e,t,s){"use strict";var n=s(82),a=s.n(n),i=s(86),o=s(87),r=s(250);var l;!function(e){e.Online="online",e.Offline="offline",e.Unavailable="unavailable"}(l||(l={}));t.a=new class{constructor(){a()(this,"unavailableTimer",null),a()(this,"dispatcherRef",null),a()(this,"state",null),a()(this,"onAction",e=>{"user_activity"===e.action&&(this.setState(l.Online),this.unavailableTimer.restart())})}async start(){for(this.unavailableTimer=new r.a(18e4),this.dispatcherRef=o.a.register(this.onAction);this.unavailableTimer;)try{await this.unavailableTimer.finished(),this.setState(l.Unavailable)}catch(e){}}stop(){this.dispatcherRef&&(o.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.unavailableTimer&&(this.unavailableTimer.abort(),this.unavailableTimer=null)}getState(){return this.state}async setState(e){if(e===this.state)return;const t=this.state;if(this.state=e,!i.a.get().isGuest())try{await i.a.get().setPresence(this.state),console.info("Presence: %s",e)}catch(e){console.error("Failed to set presence: %s",e),this.state=t}}}},function(e,t){e.exports="img/e2e/verified.5be6c9f.svg"},function(e,t,s){"use strict";t.a={}},,,,,,,,,,,,function(e,t){e.exports="img/tchap/encryption-informations-dialog/export-logo.9b15053.svg"},,,,,,,,,,function(e,t){e.exports="img/element-icons/warning-badge.2f8ddee.svg"},function(e,t){e.exports="img/element-icons/room/default_app.2034d23.svg"},function(e,t){e.exports="img/element-icons/room/default_video.66250a4.svg"},function(e,t){e.exports="img/element-icons/room/default_cal.65049a4.svg"},function(e,t){e.exports="img/element-icons/room/default_doc.02ee63f.svg"},function(e,t){e.exports="img/element-icons/room/default_clock.e3e0f9b.svg"},function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-colr.5bb743a.woff2"},function(e,t){e.exports="fonts/Twemoji_Mozilla/TwemojiMozilla-sbix.fb38407.woff2"},function(e,t){e.exports="img/tchap/encryption-informations-dialog/browser_off-logo.0d1ffdc.svg"},,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return oe}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(90),l=s.n(r),c=s(269),d=s(83),m=s(110),h=s(293),u=s(89),p=s(85),g=s(141),f=s(87),b=s(289),v=s(254),_=s(343),y=s(282),E=s(1180),C=s(99),w=s(470),S=s(471),x=s(128),R=s(1203),O=s(243),k=s(88),I=s(91),T=s(294),j=s(208),N=s(227),P=s(97),D=s(699),A=s(94),U=s(96),M=s(700),L=s(701),F=s(703),B=s(704),V=s(739),W=s(740),H=s(741),G=s(765),q=s(745),K=s(747),z=s(750),$=s(292),Y=s(202),J=s(197),Q=s(113),X=s(249),Z=s(449),ee=s(176),te=s(173),se=s(98),ne=s(171);let ae=function(e){};const ie="sandbox"in document.createElement("iframe");class oe extends o.a.Component{constructor(t,s){super(t,s),a()(this,"dispatcherRef",void 0),a()(this,"roomStoreToken",void 0),a()(this,"rightPanelStoreToken",void 0),a()(this,"showReadReceiptsWatchRef",void 0),a()(this,"layoutWatcherRef",void 0),a()(this,"unmounted",!1),a()(this,"permalinkCreators",{}),a()(this,"searchId",void 0),a()(this,"roomView",Object(i.createRef)()),a()(this,"searchResultsPanel",Object(i.createRef)()),a()(this,"messagePanel",void 0),a()(this,"onWidgetStoreUpdate",()=>{this.state.room&&this.checkWidgets(this.state.room)}),a()(this,"checkWidgets",e=>{this.setState({hasPinnedWidgets:te.d.instance.getContainerWidgets(e,te.a.Top).length>0,showApps:this.shouldShowApps(e)})}),a()(this,"onReadReceiptsChange",()=>{this.setState({showReadReceipts:k.a.getValue("showReadReceipts",this.state.roomId)})}),a()(this,"onRoomViewStoreUpdate",e=>{if(this.unmounted)return;if(!e&&this.state.roomId!==x.a.getRoomId())return;const t=x.a.getRoomId(),s={roomId:t,roomAlias:x.a.getRoomAlias(),roomLoading:x.a.isRoomLoading(),roomLoadError:x.a.getRoomLoadError(),joining:x.a.isJoining(),initialEventId:x.a.getInitialEventId(),isInitialEventHighlighted:x.a.isInitialEventHighlighted(),replyToEvent:x.a.getQuotingEvent(),forwardingEvent:x.a.getForwardingEvent(),shouldPeek:this.state.matrixClientIsReady&&x.a.shouldPeek(),showingPinned:k.a.getValue("PinnedEvents.isOpen",t),showReadReceipts:k.a.getValue("showReadReceipts",t)};if(e||!this.state.shouldPeek||s.shouldPeek||this.context.stopPeeking(),console.log("RVS update:",s.roomId,s.roomAlias,"loading?",s.roomLoading,"joining?",s.joining,"initial?",e,"shouldPeek?",s.shouldPeek),e&&(s.room=this.context.getRoom(s.roomId),s.room&&(s.showApps=this.shouldShowApps(s.room),this.onRoomLoaded(s.room))),null===this.state.roomId&&null!==s.roomId&&!s.initialEventId){const e=R.a.getScrollState(s.roomId);e&&(s.initialEventId=e.focussedEvent,s.initialEventPixelOffset=e.pixelOffset)}this.state.initialEventId!==s.initialEventId&&(s.searchResults=null),this.setState(s),e&&this.setupRoom(s.room,s.roomId,s.joining,s.shouldPeek)}),a()(this,"getRoomId",()=>this.state.room?this.state.room.roomId:this.state.roomId),a()(this,"onWidgetEchoStoreUpdate",()=>{this.state.room&&this.setState({hasPinnedWidgets:te.d.instance.getContainerWidgets(this.state.room,te.a.Top).length>0,showApps:this.shouldShowApps(this.state.room)})}),a()(this,"onWidgetLayoutChange",()=>{this.onWidgetEchoStoreUpdate()}),a()(this,"onLayoutChange",()=>{this.setState({useIRCLayout:k.a.getValue("useIRCLayout")})}),a()(this,"onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:T.a.getSharedInstance().isOpenForRoom})}),a()(this,"onPageUnload",e=>h.a.sharedInstance().getCurrentUploads().length>0?e.returnValue=Object(d.a)("You seem to be uploading files, are you sure you want to quit?"):this.getCallForRoom()&&"ended"!==this.state.callState?e.returnValue=Object(d.a)("You seem to be in a call, are you sure you want to quit?"):void 0),a()(this,"onReactKeyDown",e=>{let t=!1;switch(e.key){case C.a.ESCAPE:e.altKey||e.ctrlKey||e.shiftKey||e.metaKey||(this.messagePanel.forgetReadMarker(),this.jumpToLiveTimeline(),t=!0);break;case C.a.PAGE_UP:e.altKey||e.ctrlKey||!e.shiftKey||e.metaKey||(this.jumpToReadMarker(),t=!0);break;case C.a.U:case C.a.U.toUpperCase():Object(C.c)(e)&&e.shiftKey&&(f.a.dispatch({action:"upload_file"},!0),t=!0)}t&&(e.stopPropagation(),e.preventDefault())}),a()(this,"onAction",t=>{switch(t.action){case"message_sent":this.checkDesktopNotifications();break;case"post_sticker_message":this.injectSticker(t.data.content.url,t.data.content.info,t.data.description||t.data.name);break;case"picture_snapshot":h.a.sharedInstance().sendContentListToRoom([t.file],this.state.room.roomId,this.context);break;case"notifier_enabled":case"upload_started":case"upload_finished":case"upload_canceled":this.forceUpdate();break;case"call_state":{if(!t.room_id)return;const e=this.getCallForRoom();this.setState({callState:e?e.state:null});break}case"appsDrawer":this.setState({showApps:t.show});break;case"reply_to_event":this.state.searchResults&&t.event.getRoomId()===this.state.roomId&&!this.unmounted&&this.onCancelSearchClick();break;case"quote":if(this.state.searchResults){const s=t.event.getRoomId();s===this.state.roomId&&this.onCancelSearchClick(),e(()=>{f.a.dispatch({action:"view_room",room_id:s,deferred_action:t})})}break;case"sync_state":this.state.matrixClientIsReady||this.setState({matrixClientIsReady:this.context&&this.context.isInitialSyncComplete()},()=>{this.onRoomViewStoreUpdate(!0)});break;case"focus_search":this.onSearchClick()}}),a()(this,"onRoomTimeline",(e,t,s,n,a)=>{this.unmounted||t&&this.state.room&&t.roomId==this.state.room.roomId&&a.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&("org.matrix.room.preview_urls"===e.getType()&&this.updatePreviewUrlVisibility(t),"m.room.encryption"===e.getType()&&this.updateE2EStatus(t),!s&&a&&a.liveEvent&&(this.state.joining||e.getSender()!==this.context.credentials.userId&&(!this.state.searchResults&&this.state.atEndOfLiveTimeline||Object(c.a)(e)||this.setState((e,t)=>({numUnreadMessages:e.numUnreadMessages+1})))))}),a()(this,"onEventDecrypted",e=>{e.isDecryptionFailure()||this.handleEffects(e)}),a()(this,"onEvent",e=>{e.isBeingDecrypted()||e.isDecryptionFailure()||this.handleEffects(e)}),a()(this,"handleEffects",e=>{if(!this.state.room||!this.state.matrixClientIsReady)return;if(e.getRoomId()!==this.state.room.roomId)return;ee.a.instance.getRoomState(this.state.room).isUnread&&Y.CHAT_EFFECTS.forEach(t=>{(Object($.containsEmoji)(e.getContent(),t.emojis)||e.getContent().msgtype===t.msgType)&&f.a.dispatch({action:"effects."+t.command})})}),a()(this,"onRoomName",e=>{this.state.room&&e.roomId==this.state.room.roomId&&this.forceUpdate()}),a()(this,"onKeyBackupStatus",()=>{this.forceUpdate()}),a()(this,"canResetTimeline",()=>!this.messagePanel||this.messagePanel.canResetTimeline()),a()(this,"onRoomLoaded",e=>{te.d.instance.on(te.d.emissionForRoom(e),this.onWidgetLayoutChange),this.onWidgetLayoutChange(),this.calculatePeekRules(e),this.updatePreviewUrlVisibility(e),this.loadMembersIfJoined(e),this.calculateRecommendedVersion(e),this.updateE2EStatus(e),this.updatePermissions(e),this.checkWidgets(e);if(se.a.getAccessRules(e.roomId)){const t=e.currentState.getMembers().filter(e=>Object(ne.c)(e.membership)).find(e=>e.userId!==this.context.getUserId());y.c(e.roomId,t.userId)}}),a()(this,"onRoom",e=>{e&&e.roomId===this.state.roomId&&(this.state.room&&te.d.instance.off(te.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.setState({room:e},()=>{this.onRoomLoaded(e)}))}),a()(this,"onDeviceVerificationChanged",(e,t)=>{const s=this.state.room;s.currentState.getMember(e)&&this.updateE2EStatus(s)}),a()(this,"onUserVerificationChanged",(e,t)=>{const s=this.state.room;s&&s.currentState.getMember(e)&&this.updateE2EStatus(s)}),a()(this,"onCrossSigningKeysChanged",()=>{const e=this.state.room;e&&this.updateE2EStatus(e)}),a()(this,"onAccountData",e=>{const t=e.getType();"org.matrix.preview_urls"!==t&&"im.vector.web.settings"!==t||!this.state.room||this.updatePreviewUrlVisibility(this.state.room)}),a()(this,"onRoomAccountData",(e,t)=>{if(t.roomId==this.state.roomId){const s=e.getType();if("org.matrix.room.color_scheme"===s){const t=e.getContent();console.log("Tinter.tint from onRoomAccountData"),b.a.tint(t.primary_color,t.secondary_color)}else"org.matrix.room.preview_urls"!==s&&"im.vector.web.settings"!==s||this.updatePreviewUrlVisibility(t)}}),a()(this,"onRoomStateEvents",(e,t)=>{this.state.room&&this.state.room.roomId===t.roomId&&this.updatePermissions(this.state.room)}),a()(this,"onRoomStateMember",(e,t,s)=>{this.state.room&&s.roomId===this.state.room.roomId&&this.updateRoomMembers(s)}),a()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.state.roomId&&(this.forceUpdate(),this.loadMembersIfJoined(e),this.updatePermissions(e))}),a()(this,"updateRoomMembers",Object(v.a)(()=>{this.updateDMState(),this.updateE2EStatus(this.state.room)},500)),a()(this,"onSearchResultsFillRequest",e=>{if(!e)return Promise.resolve(!1);if(this.state.searchResults.next_batch){ae("requesting more search results");const e=Object(E.b)(this.state.searchResults);return this.handleSearchResult(e)}return ae("no more search results"),Promise.resolve(!1)}),a()(this,"onInviteButtonClick",()=>{f.a.dispatch({action:"view_invite",roomId:this.state.room.roomId})}),a()(this,"onJoinButtonClicked",()=>{this.context&&this.context.isGuest()?(f.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_room",room_id:this.getRoomId()}}),f.a.dispatch({action:"require_registration"})):Promise.resolve().then(()=>{var e;const t=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.signUrl;return f.a.dispatch({action:"join_room",opts:{inviteSignUrl:t,viaServers:this.props.viaServers},_type:"unknown"}),Promise.resolve()})}),a()(this,"onMessageListScroll",e=>{this.messagePanel.isAtEndOfLiveTimeline()?this.setState({numUnreadMessages:0,atEndOfLiveTimeline:!0}):this.setState({atEndOfLiveTimeline:!1}),this.updateTopUnreadMessagesBar()}),a()(this,"onDragOver",e=>{e.stopPropagation(),e.preventDefault(),e.dataTransfer.dropEffect="none",(e.dataTransfer.types.includes("Files")||e.dataTransfer.types.includes("application/x-moz-file"))&&(this.setState({draggingFile:!0}),e.dataTransfer.dropEffect="copy")}),a()(this,"onDrop",e=>{e.stopPropagation(),e.preventDefault(),h.a.sharedInstance().sendContentListToRoom(e.dataTransfer.files,this.state.room.roomId,this.context),this.setState({draggingFile:!1}),f.a.fire(A.a.FocusComposer)}),a()(this,"onDragLeaveOrEnd",e=>{e.stopPropagation(),e.preventDefault(),this.setState({draggingFile:!1})}),a()(this,"onSearch",(e,t)=>{let s;this.setState({searchTerm:e,searchScope:t,searchResults:{},searchHighlights:[]}),this.searchResultsPanel.current&&this.searchResultsPanel.current.resetScrollState(),this.searchId=(new Date).getTime(),"Room"===t&&(s=this.state.room.roomId),ae("sending search request");const n=Object(E.a)(e,s);this.handleSearchResult(n)}),a()(this,"onPinnedClick",()=>{const e=!this.state.showingPinned,t=this.state.room.roomId;this.setState({showingPinned:e,searching:!1}),k.a.setValue("PinnedEvents.isOpen",t,U.a.ROOM_DEVICE,e)}),a()(this,"onSettingsClick",()=>{f.a.dispatch({action:"open_room_settings"})}),a()(this,"onCancelClick",()=>{console.log("updateTint from onCancelClick"),this.updateTint(),this.state.forwardingEvent&&f.a.dispatch({action:"forward_event",event:null}),f.a.fire(A.a.FocusComposer)}),a()(this,"onAppsClick",()=>{f.a.dispatch({action:"appsDrawer",show:!this.state.showApps})}),a()(this,"onLeaveClick",()=>{f.a.dispatch({action:"leave_room",room_id:this.state.room.roomId})}),a()(this,"onForgetClick",()=>{f.a.dispatch({action:"forget_room",room_id:this.state.room.roomId})}),a()(this,"onRejectButtonClicked",e=>{this.setState({rejecting:!0}),this.context.leave(this.state.roomId).then(()=>{f.a.dispatch({action:"view_home_page"}),this.setState({rejecting:!1})},e=>{console.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e),s=p.getComponent("dialogs.ErrorDialog");u.a.createTrackedDialog("Failed to reject invite","",s,{title:Object(d.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})})}),a()(this,"onRejectAndIgnoreClick",async()=>{this.setState({rejecting:!0});try{const e=this.state.room.getMember(this.context.getUserId()).events.member,t=this.context.getIgnoredUsers();t.push(e.getSender()),await this.context.setIgnoredUsers(t),await this.context.leave(this.state.roomId),f.a.dispatch({action:"view_home_page"}),this.setState({rejecting:!1})}catch(e){console.error("Failed to reject invite: %s",e);const t=e.message?e.message:JSON.stringify(e),s=p.getComponent("dialogs.ErrorDialog");u.a.createTrackedDialog("Failed to reject invite","",s,{title:Object(d.a)("Failed to reject invite"),description:t}),this.setState({rejecting:!1,rejectError:e})}}),a()(this,"onRejectThreepidInviteButtonClicked",e=>{f.a.fire(A.a.ViewRoomDirectory)}),a()(this,"onSearchClick",()=>{this.setState({searching:!this.state.searching,showingPinned:!1})}),a()(this,"onCancelSearchClick",()=>{this.setState({searching:!1,searchResults:null})}),a()(this,"jumpToLiveTimeline",()=>{this.messagePanel.jumpToLiveTimeline(),f.a.fire(A.a.FocusComposer)}),a()(this,"jumpToReadMarker",()=>{this.messagePanel.jumpToReadMarker()}),a()(this,"forgetReadMarker",e=>{e.stopPropagation(),this.messagePanel.forgetReadMarker()}),a()(this,"updateTopUnreadMessagesBar",()=>{if(!this.messagePanel)return;const e=this.messagePanel.canJumpToReadMarker();this.state.showTopUnreadMessagesBar!=e&&this.setState({showTopUnreadMessagesBar:e})}),a()(this,"onResize",()=>{let e=window.innerHeight-261;e<50&&(e=50),this.setState({auxPanelMaxHeight:e})}),a()(this,"onFullscreenClick",()=>{f.a.dispatch({action:"video_fullscreen",fullscreen:!0},!0)}),a()(this,"onMuteAudioClick",()=>{const e=this.getCallForRoom();if(!e)return;const t=!e.isMicrophoneMuted();e.setMicrophoneMuted(t),this.forceUpdate()}),a()(this,"onMuteVideoClick",()=>{const e=this.getCallForRoom();if(!e)return;const t=!e.isLocalVideoMuted();e.setLocalVideoMuted(t),this.forceUpdate()}),a()(this,"onStatusBarVisible",()=>{this.unmounted||this.setState({statusBarVisible:!0})}),a()(this,"onStatusBarHidden",()=>{this.unmounted||this.setState({statusBarVisible:!1})}),a()(this,"handleScrollKey",e=>{let t;this.searchResultsPanel.current?t=this.searchResultsPanel.current:this.messagePanel&&(t=this.messagePanel),t&&t.handleScrollKey(e)}),a()(this,"gatherTimelinePanelRef",e=>{this.messagePanel=e,e&&(console.log("updateTint from RoomView.gatherTimelinePanelRef"),this.updateTint())}),a()(this,"onHiddenHighlightsClick",()=>{const e=this.getOldRoom();e&&f.a.dispatch({action:"view_room",room_id:e.roomId})});const n=this.context.hasLazyLoadMembersEnabled();this.state={roomId:null,roomLoading:!0,peekLoading:!1,shouldPeek:!0,membersLoaded:!n,numUnreadMessages:0,draggingFile:!1,searching:!1,searchResults:null,callState:null,guestsCanJoin:!1,canPeek:!1,showApps:!1,isPeeking:!1,showingPinned:!1,showReadReceipts:!0,showRightPanel:T.a.getSharedInstance().isOpenForRoom,joining:!1,atEndOfLiveTimeline:!0,atEndOfLiveTimelineInit:!1,showTopUnreadMessagesBar:!1,statusBarVisible:!1,canReact:!1,canReply:!1,useIRCLayout:k.a.getValue("useIRCLayout"),matrixClientIsReady:this.context&&this.context.isInitialSyncComplete()},this.dispatcherRef=f.a.register(this.onAction),this.context.on("Room",this.onRoom),this.context.on("Room.timeline",this.onRoomTimeline),this.context.on("Room.name",this.onRoomName),this.context.on("Room.accountData",this.onRoomAccountData),this.context.on("RoomState.events",this.onRoomStateEvents),this.context.on("RoomState.members",this.onRoomStateMember),this.context.on("Room.myMembership",this.onMyMembership),this.context.on("accountData",this.onAccountData),this.context.on("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.on("userTrustStatusChanged",this.onUserVerificationChanged),this.context.on("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.context.on("Event.decrypted",this.onEventDecrypted),this.context.on("event",this.onEvent),this.roomStoreToken=x.a.addListener(this.onRoomViewStoreUpdate),this.rightPanelStoreToken=T.a.getSharedInstance().addListener(this.onRightPanelStoreUpdate),O.a.on(Q.b,this.onWidgetEchoStoreUpdate),J.a.instance.on(Q.b,this.onWidgetStoreUpdate),this.showReadReceiptsWatchRef=k.a.watchSetting("showReadReceipts",null,this.onReadReceiptsChange),this.layoutWatcherRef=k.a.watchSetting("useIRCLayout",null,this.onLayoutChange)}getPermalinkCreatorForRoom(e){return this.permalinkCreators[e.roomId]||(this.permalinkCreators[e.roomId]=new m.a(e),this.state.room&&e.roomId===this.state.room.roomId?this.permalinkCreators[e.roomId].start():this.permalinkCreators[e.roomId].load()),this.permalinkCreators[e.roomId]}stopAllPermalinkCreators(){if(this.permalinkCreators)for(const e of Object.keys(this.permalinkCreators))this.permalinkCreators[e].stop()}setupRoom(e,t,s,n){!s&&t&&(this.props.autoJoin?this.onJoinButtonClicked():!e&&n?(console.info("Attempting to peek into room %s",t),this.setState({peekLoading:!0,isPeeking:!0}),this.context.peekInRoom(t).then(e=>{this.unmounted||(this.setState({room:e,peekLoading:!1}),this.onRoomLoaded(e))}).catch(e=>{if(!this.unmounted)if(this.setState({isPeeking:!1,peekLoading:!1}),"M_GUEST_ACCESS_FORBIDDEN"===e.errcode)this.setState({peekLoading:!1});else{if("M_FORBIDDEN"!==e.errcode||!se.a.isCurrentUserExtern())throw e;this.setState({peekLoading:!1,roomLoadError:e})}})):e&&(this.context.stopPeeking(),this.setState({isPeeking:!1})))}shouldShowApps(e){if(!ie||!e)return!1;const t="false"===localStorage.getItem(e.roomId+"_hide_widget_drawer");return te.d.instance.getContainerWidgets(e,te.a.Top).length>0||t}componentDidMount(){this.onRoomViewStoreUpdate(!0);const e=this.getCallForRoom(),t=e?e.state:null;this.setState({callState:t}),window.addEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.on("middlePanelResized",this.onResize),this.onResize()}shouldComponentUpdate(e,t){return!_.a(this.props,e)||!_.a(this.state,t)}componentDidUpdate(){if(this.roomView.current){const e=this.roomView.current;e.ondrop||(e.addEventListener("drop",this.onDrop),e.addEventListener("dragover",this.onDragOver),e.addEventListener("dragleave",this.onDragLeaveOrEnd),e.addEventListener("dragend",this.onDragLeaveOrEnd))}this.messagePanel&&!this.state.atEndOfLiveTimelineInit&&this.setState({atEndOfLiveTimelineInit:!0,atEndOfLiveTimeline:this.messagePanel.isAtEndOfLiveTimeline()})}componentWillUnmount(){if(this.unmounted=!0,this.state.roomId&&R.a.setScrollState(this.state.roomId,this.getScrollState()),this.state.shouldPeek&&this.context.stopPeeking(),this.stopAllPermalinkCreators(),this.roomView.current){const e=this.roomView.current;e.removeEventListener("drop",this.onDrop),e.removeEventListener("dragover",this.onDragOver),e.removeEventListener("dragleave",this.onDragLeaveOrEnd),e.removeEventListener("dragend",this.onDragLeaveOrEnd)}f.a.unregister(this.dispatcherRef),this.context&&(this.context.removeListener("Room",this.onRoom),this.context.removeListener("Room.timeline",this.onRoomTimeline),this.context.removeListener("Room.name",this.onRoomName),this.context.removeListener("Room.accountData",this.onRoomAccountData),this.context.removeListener("RoomState.events",this.onRoomStateEvents),this.context.removeListener("Room.myMembership",this.onMyMembership),this.context.removeListener("RoomState.members",this.onRoomStateMember),this.context.removeListener("accountData",this.onAccountData),this.context.removeListener("crypto.keyBackupStatus",this.onKeyBackupStatus),this.context.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged),this.context.removeListener("userTrustStatusChanged",this.onUserVerificationChanged),this.context.removeListener("crossSigning.keysChanged",this.onCrossSigningKeysChanged),this.context.removeListener("Event.decrypted",this.onEventDecrypted),this.context.removeListener("event",this.onEvent)),window.removeEventListener("beforeunload",this.onPageUnload),this.props.resizeNotifier&&this.props.resizeNotifier.removeListener("middlePanelResized",this.onResize),this.roomStoreToken&&this.roomStoreToken.remove(),this.rightPanelStoreToken&&this.rightPanelStoreToken.remove(),O.a.removeListener(Q.b,this.onWidgetEchoStoreUpdate),J.a.instance.removeListener(Q.b,this.onWidgetStoreUpdate),this.state.room&&te.d.instance.off(te.d.emissionForRoom(this.state.room),this.onWidgetLayoutChange),this.showReadReceiptsWatchRef&&k.a.unwatchSetting(this.showReadReceiptsWatchRef),this.updateRoomMembers.cancelPendingCall(),k.a.unwatchSetting(this.layoutWatcherRef)}async calculateRecommendedVersion(e){this.setState({upgradeRecommendation:await e.getRecommendedVersion()})}async loadMembersIfJoined(e){if(this.context.hasLazyLoadMembersEnabled()&&e&&"join"===e.getMyMembership())try{await e.loadMembersIfNeeded(),this.unmounted||this.setState({membersLoaded:!0})}catch(t){const s=`Fetching room members for ${e.roomId} failed. Room members will appear incomplete.`;console.error(s),console.error(t)}}calculatePeekRules(e){const t=e.currentState.getStateEvents("m.room.guest_access","");t&&"can_join"===t.getContent().guest_access&&this.setState({guestsCanJoin:!0});const s=e.currentState.getStateEvents("m.room.history_visibility","");s&&"world_readable"===s.getContent().history_visibility&&this.setState({canPeek:!0})}updatePreviewUrlVisibility({roomId:e}){const t=this.context.isRoomEncrypted(e)?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled";this.setState({showUrlPreview:k.a.getValue(t,e)})}async updateE2EStatus(e){this.context.isRoomEncrypted(e.roomId)&&(this.context.isCryptoEnabled()?this.setState({e2eStatus:await Object(D.b)(this.context,e)}):this.setState({e2eStatus:D.a.Warning}))}updateTint(){const e=this.state.room;if(!e)return;console.log("Tinter.tint from updateTint");const t=k.a.getValue("roomColor",e.roomId);b.a.tint(t.primary_color,t.secondary_color)}updatePermissions(e){if(e){const t=this.context.getUserId(),s="join"===e.getMyMembership()&&e.currentState.maySendEvent("m.reaction",t),n=e.maySendMessage();this.setState({canReact:s,canReply:n})}}checkDesktopNotifications(){this.state.room.getJoinedMemberCount()+this.state.room.getInvitedMemberCount()>1&&X.default.shouldShowPrompt()&&Object(Z.b)(!0)}updateDMState(){const e=this.state.room;if("join"!=e.getMyMembership())return;const t=e.getDMInviter();t&&y.c(e.roomId,t)}injectSticker(e,t,s){this.context.isGuest()?f.a.dispatch({action:"require_registration"}):h.a.sharedInstance().sendStickerContentToRoom(e,this.state.room.roomId,t,s,this.context).then(void 0,e=>{e.name})}handleSearchResult(e){const t=this.searchId;return this.setState({searchInProgress:!0}),e.then(e=>{if(ae("search complete"),this.unmounted||!this.state.searching||this.searchId!=t)return void console.error("Discarding stale search results");let s=e.highlights;s.indexOf(this.state.searchTerm)<0&&(s=s.concat(this.state.searchTerm)),s=s.sort((function(e,t){return t.length-e.length})),this.setState({searchHighlights:s,searchResults:e})},e=>{const t=p.getComponent("dialogs.ErrorDialog");console.error("Search failed",e),u.a.createTrackedDialog("Search failed","",t,{title:Object(d.a)("Search failed"),description:e&&e.message?e.message:Object(d.a)("Server may be unavailable, overloaded, or search timed out :(")})}).finally(()=>{this.setState({searchInProgress:!1})})}getSearchResultTiles(){const e=p.getComponent("rooms.SearchResultTile"),t=p.getComponent("elements.Spinner"),s=[];var n,a;(this.state.searchInProgress&&s.push(o.a.createElement("li",{key:"search-spinner"},o.a.createElement(t,null))),this.state.searchResults.next_batch)||(null!==(n=this.state.searchResults)&&void 0!==n&&null!==(a=n.results)&&void 0!==a&&a.length?s.push(o.a.createElement("li",{key:"search-top-marker"},o.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(d.a)("No more results")))):s.push(o.a.createElement("li",{key:"search-top-marker"},o.a.createElement("h2",{className:"mx_RoomView_topMarker"},Object(d.a)("No results")))));const i=()=>{const e=this.searchResultsPanel.current;e&&e.checkScroll()};let r;for(let t=((null===(l=this.state.searchResults)||void 0===l||null===(c=l.results)||void 0===c?void 0:c.length)||0)-1;t>=0;t--){var l,c;const n=this.state.searchResults.results[t],a=n.context.getEvent(),m=a.getRoomId(),h=this.context.getRoom(m);if(!h){console.log("Hiding search result from an unknown room",m);continue}if(!Object(j.b)(a))continue;"All"===this.state.searchScope&&m!==r&&(s.push(o.a.createElement("li",{key:a.getId()+"-room"},o.a.createElement("h2",null,Object(d.a)("Room"),": ",h.name))),r=m);const u="#/room/"+m+"/"+a.getId();s.push(o.a.createElement(e,{key:a.getId(),searchResult:n,searchHighlights:this.state.searchHighlights,resultLink:u,permalinkCreator:this.getPermalinkCreatorForRoom(h),onHeightChanged:i}))}return s}getScrollState(){const e=this.messagePanel;if(!e)return null;if(this.state.atEndOfLiveTimeline)return null;const t=e.getScrollState();return!t||t.stuckAtBottom?null:{focussedEvent:t.trackedScrollToken,pixelOffset:t.pixelOffset}}getCallForRoom(){return this.state.room?g.b.sharedInstance().getCallForRoom(this.state.room.roomId):null}getOldRoom(){const e=this.state.room.currentState.getStateEvents("m.room.create","");return e&&e.getContent().predecessor?this.context.getRoom(e.getContent().predecessor.room_id):null}getHiddenHighlightCount(){const e=this.getOldRoom();return e?e.getUnreadNotificationCount("highlight"):0}render(){if(!this.state.room){const s=!this.state.matrixClientIsReady||this.state.roomLoading||this.state.peekLoading;if(s){const e=!this.state.matrixClientIsReady||!this.state.roomId||this.state.peekLoading;return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(F.a,null,o.a.createElement(B.a,{canPreview:!1,previewLoading:e&&!this.state.roomLoadError,error:this.state.roomLoadError,loading:s,joining:this.state.joining,oobData:this.props.oobData})))}{var e,t;let s=void 0;this.props.oobData&&(s=this.props.oobData.inviterName);const n=null===(e=this.props.threepidInvite)||void 0===e?void 0:e.toEmail,a=this.state.roomAlias;return o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(F.a,null,o.a.createElement(B.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,canPreview:!1,error:this.state.roomLoadError,roomAlias:a,joining:this.state.joining,inviterName:s,invitedEmail:n,oobData:this.props.oobData,signUrl:null===(t=this.props.threepidInvite)||void 0===t?void 0:t.signUrl,room:this.state.room})))}}const s=this.state.room.getMyMembership();if("invite"==s){if(this.state.joining||this.state.rejecting)return o.a.createElement(F.a,null,o.a.createElement(B.a,{canPreview:!1,error:this.state.roomLoadError,joining:this.state.joining,rejecting:this.state.rejecting}));{const e=this.context.credentials.userId,t=this.state.room.getMember(e),s=t?t.events.member:null;let n=Object(d.a)("Unknown");return s&&(n=s.sender?s.sender.name:s.getSender()),o.a.createElement("div",{className:"mx_RoomView"},o.a.createElement(F.a,null,o.a.createElement(B.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectButtonClicked,onRejectAndIgnoreClick:this.onRejectAndIgnoreClick,inviterName:n,canPreview:!1,joining:this.state.joining,room:this.state.room})))}}let n=null;{const e=this.getCallForRoom();e&&"ended"!==this.state.callState&&"ringing"!==this.state.callState&&(n=e)}const a=l()({mx_RoomView_scrollheader:!0});let i,r=!0;if(h.a.sharedInstance().getCurrentUploads().length>0){const e=p.getComponent("structures.UploadBar");i=o.a.createElement(e,{room:this.state.room})}else if(!this.state.searchResults){const e=p.getComponent("structures.RoomStatusBar");r=this.state.statusBarVisible,i=o.a.createElement(e,{room:this.state.room,isPeeking:"join"!==s,onInviteClick:this.onInviteButtonClick,onVisible:this.onStatusBarVisible,onHidden:this.onStatusBarHidden})}const c=this.state.upgradeRecommendation,m=c&&c.needsUpgrade&&this.state.room.userMayUpgradeRoom(this.context.credentials.userId),u=this.getHiddenHighlightCount();let g,f=null,b=!1;if(this.state.forwardingEvent)f=o.a.createElement(V.a,{onCancelClick:this.onCancelClick});else if(this.state.searching)b=!0,f=o.a.createElement(W.a,{searchInProgress:this.state.searchInProgress,onCancelClick:this.onCancelSearchClick,onSearch:this.onSearch,isRoomEncrypted:this.context.isRoomEncrypted(this.state.room.roomId)});else if(m)f=o.a.createElement(H.a,{room:this.state.room,recommendation:c}),b=!0;else if(this.state.showingPinned)b=!0,f=o.a.createElement(G.a,{room:this.state.room,onCancelClick:this.onPinnedClick});else if("join"!==s){var v;let e=void 0;this.props.oobData&&(e=this.props.oobData.inviterName);const t=null===(v=this.props.threepidInvite)||void 0===v?void 0:v.toEmail;if(b=!0,g=o.a.createElement(B.a,{onJoinClick:this.onJoinButtonClicked,onForgetClick:this.onForgetClick,onRejectClick:this.onRejectThreepidInviteButtonClicked,joining:this.state.joining,inviterName:e,invitedEmail:t,oobData:this.props.oobData,canPreview:this.state.canPeek,room:this.state.room}),!this.state.canPeek)return o.a.createElement("div",{className:"mx_RoomView"},g)}else u>0&&(f=o.a.createElement(I.a,{element:"div",className:"mx_RoomView_auxPanel_hiddenHighlights",onClick:this.onHiddenHighlightsClick},Object(d.a)("You have %(count)s unread notifications in a prior version of this room.",{count:u})));const _=o.a.createElement(q.a,{room:this.state.room,fullHeight:!1,userId:this.context.credentials.userId,draggingFile:this.state.draggingFile,maxHeight:this.state.auxPanelMaxHeight,showApps:this.state.showApps,onResize:this.onResize,resizeNotifier:this.props.resizeNotifier},f);let y,E;if("join"===s&&!this.state.searchResults){const e=p.getComponent("rooms.MessageComposer");y=o.a.createElement(e,{room:this.state.room,callState:this.state.callState,showApps:this.state.showApps,e2eStatus:this.state.e2eStatus,resizeNotifier:this.props.resizeNotifier,replyToEvent:this.state.replyToEvent,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room)})}let C;this.state.searchResults&&(E={searchTerm:this.state.searchTerm,searchScope:this.state.searchScope,searchCount:this.state.searchResults.count});let x=!1;this.state.searchResults&&(C=void 0===this.state.searchResults.count?o.a.createElement("div",{className:"mx_RoomView_messagePanel mx_RoomView_messagePanelSearchSpinner"}):o.a.createElement(M.a,{ref:this.searchResultsPanel,className:"mx_RoomView_messagePanel mx_RoomView_searchResultsPanel mx_GroupLayout",onFillRequest:this.onSearchResultsFillRequest,resizeNotifier:this.props.resizeNotifier},o.a.createElement("li",{className:a}),this.getSearchResultTiles()),x=!0);const R=this.state.isInitialEventHighlighted;let O=null;this.state.forwardingEvent?O=this.state.forwardingEvent.getId():R&&(O=this.state.initialEventId);const T=l()("mx_RoomView_messagePanel",{mx_IRCLayout:this.state.useIRCLayout,mx_GroupLayout:!this.state.useIRCLayout}),j=o.a.createElement(L.a,{ref:this.gatherTimelinePanelRef,timelineSet:this.state.room.getUnfilteredTimelineSet(),showReadReceipts:this.state.showReadReceipts,manageReadReceipts:!this.state.isPeeking,manageReadMarkers:!this.state.isPeeking,hidden:x,highlightedEventId:O,eventId:this.state.initialEventId,eventPixelOffset:this.state.initialEventPixelOffset,onScroll:this.onMessageListScroll,onReadMarkerUpdated:this.updateTopUnreadMessagesBar,showUrlPreview:this.state.showUrlPreview,className:T,membersLoaded:this.state.membersLoaded,permalinkCreator:this.getPermalinkCreatorForRoom(this.state.room),resizeNotifier:this.props.resizeNotifier,showReactions:!0,useIRCLayout:this.state.useIRCLayout});let P,D=null;if(this.state.showTopUnreadMessagesBar&&!this.state.searchResults){const e=p.getComponent("rooms.TopUnreadMessagesBar");D=o.a.createElement(e,{onScrollUpClick:this.jumpToReadMarker,onCloseClick:this.forgetReadMarker})}if(!this.state.atEndOfLiveTimeline&&!this.state.searchResults){const e=p.getComponent("rooms.JumpToBottomButton");P=o.a.createElement(e,{highlight:this.state.room.getUnreadNotificationCount("highlight")>0,numUnreadMessages:this.state.numUnreadMessages,onScrollToBottomClick:this.jumpToLiveTimeline})}const A=l()("mx_RoomView_statusArea",{mx_RoomView_statusArea_expanded:r}),U=this.state.room&&this.state.showRightPanel?o.a.createElement(S.a,{room:this.state.room,resizeNotifier:this.props.resizeNotifier}):null,$=l()("mx_RoomView_timeline",{mx_RoomView_timeline_rr_enabled:this.state.showReadReceipts}),Y=l()("mx_RoomView",{mx_RoomView_inCall:Boolean(n)}),J=k.a.getValue("showChatEffects");return o.a.createElement(N.a.Provider,{value:this.state},o.a.createElement("main",{className:Y,ref:this.roomView,onKeyDown:this.onReactKeyDown},J&&this.roomView.current&&o.a.createElement(z.a,{roomWidth:this.roomView.current.offsetWidth}),o.a.createElement(F.a,null,o.a.createElement(K.a,{room:this.state.room,searchInfo:E,oobData:this.props.oobData,inRoom:"join"===s,onSearchClick:this.onSearchClick,onSettingsClick:this.onSettingsClick,onPinnedClick:this.onPinnedClick,onCancelClick:f&&!b?this.onCancelClick:null,onForgetClick:"leave"===s?this.onForgetClick:null,onLeaveClick:"join"===s?this.onLeaveClick:null,e2eStatus:this.state.e2eStatus,onAppsClick:this.state.hasPinnedWidgets?this.onAppsClick:null,appsShown:this.state.showApps}),o.a.createElement(w.a,{panel:U,resizeNotifier:this.props.resizeNotifier},o.a.createElement("div",{className:"mx_RoomView_body"},_,o.a.createElement("div",{className:$},D,P,j,C),o.a.createElement("div",{className:A},o.a.createElement("div",{className:"mx_RoomView_statusAreaBox"},o.a.createElement("div",{className:"mx_RoomView_statusAreaBox_line"}),i)),g,y)))))}}a()(oe,"contextType",P.a)}).call(this,s(167).setImmediate)},,,,function(e,t,s){"use strict";s.d(t,"b",(function(){return g})),s.d(t,"a",(function(){return f}));var n=s(214),a=s(86);async function i(e,t){const s=a.a.get(),n={limit:10};void 0!==t&&(n.rooms=[t]);const i={search_categories:{room_events:{search_term:e,filter:n,order_by:"recent",event_context:{before_limit:1,after_limit:1,include_profile:!0}}}};return{response:await s.search({body:i}),query:i}}async function o(e,t){const s=a.a.get(),n=await i(e,t),o={_query:n.query,results:[],highlights:[]};return s._processRoomEventsSearch(o,n.response)}function r(e,t){const s=e.result,n=t.result;return s.origin_server_ts>n.origin_server_ts?-1:s.origin_server_ts<n.origin_server_ts?1:0}async function l(e,t,s=!0){const a=n.a.get(),i={search_term:e,before_limit:1,after_limit:1,limit:10,order_by_recency:!0,room_id:void 0};void 0!==t&&(i.room_id=t);const o=await a.search(i);i.next_batch=o.next_batch;return{response:o,query:i}}function c(e,t){try{const s=e.results[e.results.length-1].result,n=t.results[t.results.length-1].result;return s.origin_server_ts<=n.origin_server_ts?-1:1}catch{return 0}}function d(e,t,s,n){const a=s.concat(n).sort(r);t.results=a.slice(0,10),e.cachedEvents=a.slice(10)}function m(e,t,s){const n=function(e,t,s){const n={},a=e.cachedEvents;let i=e.oldestEventFrom;return n.highlights=e.highlights,t&&s&&s.results?(c(t,s)<0&&(i="local"),d(e,n,t.results,s.results),n.highlights=t.highlights.concat(s.highlights)):t?(c(t,a)<0&&(i="local"),d(e,n,t.results,a)):s&&s.results?(c(s,a)<0&&(i="server"),d(e,n,s.results,a)):(n.results=a,e.cachedEvents=[]),e.oldestEventFrom=i,n}(e,t,s);return e.count?n.count=e.count:n.count=t.count+s.count,t&&(e.seshatQuery.next_batch=t.next_batch),s&&(e.serverSideNextBatch=s.next_batch),e.seshatQuery.next_batch?n.next_batch=e.seshatQuery.next_batch:e.serverSideNextBatch&&(n.next_batch=e.serverSideNextBatch),!n.next_batch&&e.cachedEvents.length>0&&(n.next_batch="cached"),n}function h(e=[]){for(let t=0;t<e.length;t++){const s=e[t].context.getTimeline();for(let e=0;e<s.length;e++){const t=s[e];t.event.curve25519Key&&(t.makeEncrypted("m.room.encrypted",{algorithm:t.event.algorithm},t.event.curve25519Key,t.event.ed25519Key),t._forwardingCurve25519KeyChain=t.event.forwardingCurve25519KeyChain,delete t.event.curve25519Key,delete t.event.ed25519Key,delete t.event.algorithm,delete t.event.forwardingCurve25519KeyChain)}}}function u(e,t){let s;return s=void 0!==t?a.a.get().isRoomEncrypted(t)?async function(e,t){const s={results:[],highlights:[]};if(""===e)return s;const n=await l(e,t);s.seshatQuery=n.query;const i={search_categories:{room_events:n.response}},o=a.a.get()._processRoomEventsSearch(s,i);return h(o.results),o}(e,t):o(e,t):async function(e){const t=a.a.get(),s=i(e),n=l(e);await Promise.all([s,n]);const o=await n,r=await s,c=r.query,d=r.response,u=o.query,p=o.response,g={seshatQuery:u,_query:c,serverSideNextBatch:d.next_batch,cachedEvents:[],oldestEventFrom:"server",results:[],highlights:[]},f={search_categories:{room_events:m(g,p,d.search_categories.room_events)}},b=t._processRoomEventsSearch(g,f);return h(b.results),b}(e),s}function p(e){const t=a.a.get(),s=e.seshatQuery,i=e._query;if(s){if(i){const t=async function(e){const t=n.a.get(),s=a.a.get(),i=e.seshatQuery,o=e.oldestEventFrom;let r,l,c;if(!i.next_batch||e.serverSideNextBatch&&"server"!==o||(r=await t.search(i)),e.serverSideNextBatch&&("local"===o||!i.next_batch)){const t={body:e._query,next_batch:e.serverSideNextBatch};l=await s.search(t)}l&&(c=l.search_categories.room_events);const d={search_categories:{room_events:m(e,r,c)}},u=e.results?e.results.length:0,p=s._processRoomEventsSearch(e,d),g=p.results.length-u;return h(p.results.slice(Math.max(p.results.length-g,0))),e.pendingRequest=null,p}(e);return e.pendingRequest=t,t}{const t=async function(e){const t=n.a.get(),s=e.seshatQuery,i=await t.search(s);e.seshatQuery.next_batch=i.next_batch;const o=i.results.length,r={search_categories:{room_events:i}},l=a.a.get()._processRoomEventsSearch(e,r);return h(l.results.slice(Math.max(l.results.length-o,0))),e.pendingRequest=null,l}(e);return e.pendingRequest=t,t}}return t.backPaginateRoomEventsSearch(e)}function g(e){const t=n.a.get(),s=a.a.get();return e.pendingRequest?e.pendingRequest:null===t?s.backPaginateRoomEventsSearch(e):p(e)}function f(e,t){return null===n.a.get()?o(e,t):u(e,t)}},,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/social/email-1.1134895.png"},function(e,t,s){"use strict";(function(e){class s{constructor(){this._scrollStateMap={}}getScrollState(e){return this._scrollStateMap[e]}setScrollState(e,t){this._scrollStateMap[e]=t}}void 0===e.mx_RoomScrollStateStore&&(e.mx_RoomScrollStateStore=new s),t.a=e.mx_RoomScrollStateStore}).call(this,s(5))},,,,,,,,,,,,,function(e,t){},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t){e.exports="img/cancel-red.3d9df3d.svg"},function(e,t){e.exports="img/upload-big.4e229de.svg"},function(e,t){e.exports="img/tchap/room-type/symbol-forum.e137a14.svg"},function(e,t){e.exports="img/tchap/room-type/symbol-private.f1c9d6d.svg"},function(e,t){e.exports="img/tchap/room-type/symbol-private-external.be3d23d.svg"},function(e,t){e.exports="img/tchap/room/people.a94a161.svg"},function(e,t){e.exports="img/tchap/room/clock.fed8587.svg"},function(e,t,s){var n={"./":[202,9],"./ICanvasEffect":[760,7,5],"./ICanvasEffect.ts":[760,7,5],"./confetti":[360,9,0],"./confetti/":[360,9,0],"./confetti/index":[360,9,0],"./confetti/index.ts":[360,9,0],"./fireworks":[361,9,1],"./fireworks/":[361,9,1],"./fireworks/index":[361,9,1],"./fireworks/index.ts":[361,9,1],"./index":[202,9],"./index.ts":[202,9],"./snowfall":[362,9,2],"./snowfall/":[362,9,2],"./snowfall/index":[362,9,2],"./snowfall/index.ts":[362,9,2],"./utils":[292,9],"./utils.ts":[292,9]};function a(e){if(!s.o(n,e))return Promise.resolve().then((function(){var t=new Error("Cannot find module '"+e+"'");throw t.code="MODULE_NOT_FOUND",t}));var t=n[e],a=t[0];return Promise.all(t.slice(2).map(s.e)).then((function(){return s.t(a,t[1])}))}a.keys=function(){return Object.keys(n)},a.id=1262,e.exports=a},function(e,t){e.exports="img/element-icons/brands/apple.5160971.svg"},function(e,t){e.exports="img/element-icons/brands/facebook.c3243cf.svg"},function(e,t){e.exports="img/element-icons/brands/github.bf60283.svg"},function(e,t){e.exports="img/element-icons/brands/gitlab.d4ee177.svg"},function(e,t){e.exports="img/element-icons/brands/google.04f5e48.svg"},function(e,t){e.exports="img/element-icons/brands/twitter.892d1c7.svg"},function(e,t){e.exports="img/download.4f331f0.svg"},function(e,t){e.exports="img/icons-room-add.bd36e26.svg"},function(e,t){e.exports="img/camera.2f271b6.svg"},function(e,t){e.exports="img/icons-groups.29180b0.svg"},function(e,t){e.exports="img/fileicon.a04644a.png"},,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,,function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return m}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=s(83),d=s(105);class m extends o.a.Component{constructor(e){super(e),this.state={errorText:null},this._captchaWidgetId=null,this._recaptchaContainer=Object(i.createRef)(),d.a.instance.track("onboarding_grecaptcha_begin")}componentDidMount(){if(e.grecaptcha)this._onCaptchaLoaded();else{console.log("Loading recaptcha script..."),window.mx_on_recaptcha_loaded=()=>{this._onCaptchaLoaded()};const e=document.createElement("script");e.setAttribute("src","https://www.recaptcha.net/recaptcha/api.js?onload=mx_on_recaptcha_loaded&render=explicit"),this._recaptchaContainer.current.appendChild(e)}}componentWillUnmount(){this._resetRecaptcha()}_renderRecaptcha(t){if(!e.grecaptcha)throw console.error("grecaptcha not loaded!"),new Error("Recaptcha did not load successfully");const s=this.props.sitePublicKey;if(!s)throw console.error("No public key for recaptcha!"),new Error("This server has not supplied enough information for Recaptcha authentication");console.info("Rendering to %s",t),this._captchaWidgetId=e.grecaptcha.render(t,{sitekey:s,callback:this.props.onCaptchaResponse})}_resetRecaptcha(){null!==this._captchaWidgetId&&e.grecaptcha.reset(this._captchaWidgetId)}_onCaptchaLoaded(){console.log("Loaded recaptcha script.");try{this._renderRecaptcha("mx_recaptcha"),this.setState({errorText:null}),d.a.instance.track("onboarding_grecaptcha_loaded")}catch(e){this.setState({errorText:e.toString()}),d.a.instance.track("onboarding_grecaptcha_error",{error:e.toString()})}}render(){let e=null;return this.state.errorText&&(e=o.a.createElement("div",{className:"error"},this.state.errorText)),o.a.createElement("div",{ref:this._recaptchaContainer},o.a.createElement("p",null,Object(c.a)("This homeserver would like to make sure you are not a robot.")),o.a.createElement("div",{id:"mx_recaptcha"}),e)}}a()(m,"propTypes",{sitePublicKey:l.a.string,onCaptchaResponse:l.a.func}),a()(m,"defaultProps",{onCaptchaResponse:()=>{}})}).call(this,s(5))},function(e,t){e.exports="img/icon_context_delete.f02c798.svg"},,function(e,t){e.exports="img/feather-customised/files.d6a33b8.svg"},function(e,t){e.exports="img/search-icon-vector.c463bb6.svg"},function(e,t){e.exports="img/icon-email-user.af133ff.svg"},function(e,t){e.exports="img/icon-address-delete.40c8a04.svg"},function(e,t){e.exports="img/icons-directory.a0cc9b7.svg"},function(e,t){e.exports="img/icons-people.af03c4c.svg"},,,function(e,t){e.exports="img/icons-show-stickers.4e420bf.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return I}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(139),l=s.n(r),c=s(84),d=s.n(c),m=s(757),h=s.n(m),u=s(121),p=s(130),g=s(85),f=s(89),b=s(87),v=s(83),_=s(102),y=s(88),E=s(238),C=s(758),w=s(164),S=s(110),x=s(295),R=s(115);function O(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function k(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?O(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):O(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class I extends o.a.Component{constructor(t){super(t),a()(this,"onCancelClick",t=>{this.setState({widgetHidden:!0}),e.localStorage&&e.localStorage.setItem("hide_preview_"+this.props.mxEvent.getId(),"1"),this.forceUpdate()}),a()(this,"onEmoteSenderClick",e=>{const t=this.props.mxEvent;b.a.dispatch({action:"insert_mention",user_id:t.getSender()})}),a()(this,"getEventTileOps",()=>({isWidgetHidden:()=>this.state.widgetHidden,unhideWidget:()=>{this.setState({widgetHidden:!1}),e.localStorage&&e.localStorage.removeItem("hide_preview_"+this.props.mxEvent.getId())}})),a()(this,"onStarterLinkClick",(e,t)=>{t.preventDefault();const s=w.a.sharedInstance();if(!s.hasManager())return void s.openNoManagerDialog();const n=s.getPrimaryManager(),a=n.getScalarClient();a.connect().then(()=>{const t=a.getStarterLink(e),s=g.getComponent("dialogs.QuestionDialog"),i=n.uiUrl;f.a.createTrackedDialog("Add an integration","",s,{title:Object(v.a)("Add an Integration"),description:o.a.createElement("div",null,Object(v.a)("You are about to be taken to a third-party site so you can authenticate your account for use with %(integrationsUrl)s. Do you wish to continue?",{integrationsUrl:i})),button:Object(v.a)("Continue"),onFinished(e){if(!e)return;const s=window.screen.width>1024?1024:window.screen.width,n=window.screen.height>800?800:window.screen.height,a=(window.screen.width-s)/2,i=`height=${n}, width=${s}, top=${(window.screen.height-n)/2}, left=${a},`;window.open(t,"_blank",i).opener=null}})})}),a()(this,"_openHistoryDialog",async()=>{const e=g.getComponent("views.dialogs.MessageEditHistoryDialog");f.a.createDialog(e,{mxEvent:this.props.mxEvent})}),this._content=Object(i.createRef)(),this.state={links:[],widgetHidden:!1}}componentDidMount(){this._unmounted=!1,this._pills=[],this.props.editState||this._applyFormatting()}_applyFormatting(){const e=y.a.getValue("showCodeLineNumbers");if(this.activateSpoilers([this._content.current]),Object(C.a)([this._content.current],this.props.mxEvent,this._pills),u.f(this._content.current),this.calculateUrlPreview(),"org.matrix.custom.html"===this.props.mxEvent.getContent().format){const t=l.a.findDOMNode(this).getElementsByTagName("pre");if(t.length>0)for(let s=0;s<t.length;s++){if("mx_EventTile_pre_container"==t[s].parentNode.className)continue;const n=this._wrapInDiv(t[s]);this._handleCodeBlockExpansion(t[s]),this._addCodeExpansionButton(n,t[s]),this._addCodeCopyButton(n),e&&this._addLineNumbers(t[s])}const s=l.a.findDOMNode(this).getElementsByTagName("code");s.length>0&&setTimeout(()=>{if(!this._unmounted)for(let e=0;e<s.length;e++)s[e].className.includes("hljs")||this._highlightCode(s[e])},10)}}_addCodeExpansionButton(e,t){if(t.offsetHeight/window.innerHeight*100<30)return;const s=document.createElement("span");s.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?s.className+="mx_EventTile_expandButton":s.className+="mx_EventTile_collapseButton",s.onclick=async()=>{s.className="mx_EventTile_button ","mx_EventTile_collapsedCodeBlock"==t.className?(t.className="",s.className+="mx_EventTile_collapseButton"):(t.className="mx_EventTile_collapsedCodeBlock",s.className+="mx_EventTile_expandButton"),this.props.onHeightChanged()},e.appendChild(s)}_addCodeCopyButton(e){const t=document.createElement("span");t.className="mx_EventTile_button mx_EventTile_copyButton ";e.getElementsByClassName("mx_EventTile_button").length>0&&(t.className+="mx_EventTile_buttonBottom"),t.onclick=async()=>{const e=t.parentNode.getElementsByTagName("code")[0],s=await Object(x.b)(e.textContent),n=t.getBoundingClientRect(),a=g.getComponent("context_menus.GenericTextContextMenu"),{close:i}=_.n(a,k(k({},Object(_.p)(n,2)),{},{message:s?Object(v.a)("Copied!"):Object(v.a)("Failed to copy")}));t.onmouseleave=i},e.appendChild(t)}_wrapInDiv(e){const t=document.createElement("div");return t.className="mx_EventTile_pre_container",e.parentNode.replaceChild(t,e),t.appendChild(e),t}_handleCodeBlockExpansion(e){y.a.getValue("expandCodeByDefault")||(e.className="mx_EventTile_collapsedCodeBlock")}_addLineNumbers(e){e.innerHTML='<span class="mx_EventTile_lineNumbers"></span>'+e.innerHTML+"<span></span>";const t=e.getElementsByClassName("mx_EventTile_lineNumbers")[0],s=e.innerHTML.split(/\n/).length;for(let e=1;e<s;e++)t.innerHTML+='<span class="mx_EventTile_lineNumber">'+e+"</span>"}_highlightCode(e){if(y.a.getValue("enableSyntaxHighlightLanguageDetection"))h.a.highlightBlock(e);else{0!=e.className.split(/\s+/).filter((function(e){return e.startsWith("language-")&&!e.startsWith("language-_")})).length&&h.a.highlightBlock(e)}}componentDidUpdate(e){if(!this.props.editState){const t=e.editState&&!this.props.editState;(e.replacingEventId!==this.props.replacingEventId||t)&&this._applyFormatting()}}componentWillUnmount(){this._unmounted=!0,Object(C.b)(this._pills)}shouldComponentUpdate(e,t){return e.mxEvent.getId()!==this.props.mxEvent.getId()||e.highlights!==this.props.highlights||e.replacingEventId!==this.props.replacingEventId||e.highlightLink!==this.props.highlightLink||e.showUrlPreview!==this.props.showUrlPreview||e.editState!==this.props.editState||t.links!==this.state.links||t.widgetHidden!==this.state.widgetHidden}calculateUrlPreview(){if(this.props.showUrlPreview){let t=this.findLinks([this._content.current]);if(t.length){const s=new Set;if(t=t.filter(e=>!s.has(e)&&(s.add(e),!0)),this.setState({links:t}),e.localStorage){const t=e.localStorage.getItem("hide_preview_"+this.props.mxEvent.getId());this.setState({widgetHidden:t})}}else this.state.links.length&&this.setState({links:[]})}}activateSpoilers(e){let t=e[0];for(;t;){if("SPAN"===t.tagName&&"string"==typeof t.getAttribute("data-mx-spoiler")){const e=document.createElement("span"),s=t.getAttribute("data-mx-spoiler"),n=g.getComponent("elements.Spoiler");t.removeAttribute("data-mx-spoiler");const a=o.a.createElement(n,{reason:s,contentHtml:t.outerHTML});l.a.render(a,e),t.parentNode.replaceChild(e,t),t=e}t.childNodes&&t.childNodes.length&&this.activateSpoilers(t.childNodes),t=t.nextSibling}}findLinks(e){let t=[];for(let s=0;s<e.length;s++){const n=e[s];if("A"===n.tagName&&n.getAttribute("href"))this.isLinkPreviewable(n)&&t.push(n.getAttribute("href"));else{if("PRE"===n.tagName||"CODE"===n.tagName||"BLOCKQUOTE"===n.tagName)continue;n.children&&n.children.length&&(t=t.concat(this.findLinks(n.children)))}}return t}isLinkPreviewable(e){if(!e.getAttribute("href").startsWith("http://")&&!e.getAttribute("href").startsWith("https://"))return!1;if(e.textContent.indexOf("/")>-1)return!0;{const t=e.getAttribute("href").match(/^https?:\/\/(.*?)(\/|$)/)[1];return!Object(S.c)(t)&&!e.textContent.toLowerCase().trim().startsWith(t.toLowerCase())}}_renderEditedMarker(){const e=this.props.mxEvent.replacingEventDate(),t=e&&Object(p.a)(e),s=o.a.createElement("div",null,o.a.createElement("div",{className:"mx_Tooltip_title"},Object(v.a)("Edited at %(date)s",{date:t})),o.a.createElement("div",{className:"mx_Tooltip_sub"},Object(v.a)("Click to view edits")));return o.a.createElement(R.a,{className:"mx_EventTile_edited",onClick:this._openHistoryDialog,title:Object(v.a)("Edited at %(date)s. Click to view edits.",{date:t}),tooltip:s},o.a.createElement("span",null,`(${Object(v.a)("edited")})`))}render(){if(this.props.editState){const e=g.getComponent("rooms.EditMessageComposer");return o.a.createElement(e,{editState:this.props.editState,className:"mx_EventTile_content"})}const e=this.props.mxEvent,t=e.getContent(),s=!e.replacingEvent()&&E.a.getParentEventId(e);let n,a=u.b(t,this.props.highlights,{disableBigEmoji:"m.emote"===t.msgtype||!y.a.getValue("TextualBody.enableBigEmoji"),stripReplyFallback:s,ref:this._content});if(this.props.replacingEventId&&(a=o.a.createElement(o.a.Fragment,null,a,this._renderEditedMarker())),this.props.highlightLink?a=o.a.createElement("a",{href:this.props.highlightLink},a):t.data&&"string"==typeof t.data["org.matrix.neb.starter_link"]&&(a=o.a.createElement("a",{href:"#",onClick:this.onStarterLinkClick.bind(this,t.data["org.matrix.neb.starter_link"])},a)),this.state.links.length&&!this.state.widgetHidden&&this.props.showUrlPreview){const e=g.getComponent("rooms.LinkPreviewWidget");n=this.state.links.map(t=>o.a.createElement(e,{key:t,link:t,mxEvent:this.props.mxEvent,onCancelClick:this.onCancelClick,onHeightChanged:this.props.onHeightChanged}))}switch(t.msgtype){case"m.emote":return o.a.createElement("span",{className:"mx_MEmoteBody mx_EventTile_content"},"* ",o.a.createElement("span",{className:"mx_MEmoteBody_sender",onClick:this.onEmoteSenderClick},e.sender?e.sender.name:e.getSender())," ",a,n);case"m.notice":return o.a.createElement("span",{className:"mx_MNoticeBody mx_EventTile_content"},a,n);default:return o.a.createElement("span",{className:"mx_MTextBody mx_EventTile_content"},a,n)}}}a()(I,"propTypes",{mxEvent:d.a.object.isRequired,highlights:d.a.array,highlightLink:d.a.string,showUrlPreview:d.a.bool,onHeightChanged:d.a.func,tileShape:d.a.string})}).call(this,s(5))},function(e,t){e.exports="img/plus.53bc1d6.svg"},function(e,t){e.exports="img/stickerpack-placeholder.9c54c13.png"},function(e,t){e.exports="img/room_replaced.80042bb.svg"},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return g}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(84),l=s.n(r),c=(s(1483),s(83)),d=s(130),m=s(1484),h=s(85),u=s(300);let p=!1;try{e.localStorage&&(p="true"==e.localStorage.getItem("avatar_bounce"))}catch(e){}class g extends o.a.Component{constructor(e){super(e),this._avatar=Object(i.createRef)(),this.state={suppressDisplay:!this.props.suppressAnimation}}componentWillUnmount(){const e=this.props.readReceiptInfo;if(!e)return;if(this.props.checkUnmounting&&this.props.checkUnmounting())return;const t=this._avatar.current;e.top=t.offsetTop,e.left=t.offsetLeft,e.parent=t.offsetParent}componentDidMount(){if(!this.state.suppressDisplay)return;let e=-15;const t=this.props.readReceiptInfo;t&&t.parent&&(e=t.top+t.parent.getBoundingClientRect().top);const s=this._avatar.current;let n;s.offsetParent?n=e-s.offsetParent.getBoundingClientRect().top:(console.warn(`ReadReceiptMarker for ${this.props.fallbackUserId} in has no offsetParent`),n=0);const a=[],i=[];if(t&&t.left){a.push({top:n+"px",left:Object(u.a)(t.left)});const e={duration:100,easing:"easeOut"};i.push(e)}a.push({top:n+"px",left:"0px"}),i.push({duration:p?Math.min(200*Math.log(Math.abs(n)),3e3):300,easing:p?"easeOutBounce":"easeOutCubic"}),this.setState({suppressDisplay:!1,startStyles:a,enterTransitionOpts:i})}render(){const e=h.getComponent("avatars.MemberAvatar");if(this.state.suppressDisplay)return o.a.createElement("div",{ref:this._avatar});const t={left:Object(u.a)(this.props.leftOffset),top:"0px",visibility:this.props.hidden?"hidden":"visible"};let s;if(this.props.timestamp){const e=Object(d.a)(new Date(this.props.timestamp),this.props.showTwelveHour);s=this.props.member&&this.props.fallbackUserId!==this.props.member.rawDisplayName?Object(c.a)("Seen by %(userName)s at %(dateTime)s",{userName:this.props.member.rawDisplayName,dateTime:e}):Object(c.a)("Seen by %(userName)s at %(dateTime)s",{userName:this.props.fallbackUserId,dateTime:e})}return o.a.createElement(m.a,{startStyles:this.state.startStyles,enterTransitionOpts:this.state.enterTransitionOpts},o.a.createElement(e,{member:this.props.member,fallbackUserId:this.props.fallbackUserId,"aria-hidden":"true",width:14,height:14,resizeMethod:"crop",style:t,title:s,onClick:this.props.onClick,inputRef:this._avatar}))}}a()(g,"propTypes",{member:l.a.object,fallbackUserId:l.a.string.isRequired,leftOffset:l.a.number,hidden:l.a.bool,suppressAnimation:l.a.bool,readReceiptInfo:l.a.object,checkUnmounting:l.a.func,onClick:l.a.func,timestamp:l.a.number,showTwelveHour:l.a.bool}),a()(g,"defaultProps",{leftOffset:0})}).call(this,s(5))},function(e,t,s){"use strict";var n=s(759);s.n(n).a.Easings.easeOutBounce=function(e){return 1-function(e){let t,s=4;for(;e<((t=Math.pow(2,--s))-1)/11;);return 1/Math.pow(4,3-s)-7.5625*Math.pow((3*t-2)/22-e,2)}(1-e)}},function(e,t,s){"use strict";s.d(t,"a",(function(){return u}));var n=s(82),a=s.n(n),i=s(81),o=s.n(i),r=s(139),l=s.n(r),c=s(759),d=s.n(c),m=s(84),h=s.n(m);class u extends o.a.Component{constructor(e){super(e),this.nodes={},this._updateChildren(this.props.children)}componentDidUpdate(){this._updateChildren(this.props.children)}_updateChildren(e){const t=this.children||{};this.children={},o.a.Children.toArray(e).forEach(e=>{if(t[e.key]){const s=t[e.key],n=l.a.findDOMNode(this.nodes[s.key]);n&&n.style.left!==e.props.style.left&&d()(n,{left:e.props.style.left},this.props.transition).then(()=>{"visible"===n.style.visibility&&"hidden"===e.props.style.visibility&&(n.style.visibility=e.props.style.visibility)}),n&&"hidden"===n.style.visibility&&"visible"===e.props.style.visibility&&(n.style.visibility=e.props.style.visibility),this.children[e.key]=o.a.cloneElement(s,e.props,e.props.children)}else{const t={},s=e.props.style,n=this.props.startStyles;if(n.length>0){const e=n[0];t.style=e}t.ref=t=>this._collectNode(e.key,t,s),this.children[e.key]=o.a.cloneElement(e,t)}})}_collectNode(e,t,s){if(t&&void 0===this.nodes[e]&&this.props.startStyles.length>0){const e=this.props.startStyles,a=this.props.enterTransitionOpts,i=l.a.findDOMNode(t);for(var n=1;n<e.length;++n)d()(i,e[n],a[n-1]);d()(i,s,a[n-1]).then(()=>{i.style.visibility=s.visibility})}else if(null===t){const t=l.a.findDOMNode(this.nodes[e]);t&&d.a.Utilities.removeData(t)}this.nodes[e]=t}render(){return o.a.createElement("span",null,Object.values(this.children))}}a()(u,"propTypes",{children:h.a.any,transition:h.a.object,startStyles:h.a.array,enterTransitionOpts:h.a.array}),a()(u,"defaultProps",{startStyles:[],enterTransitionOpts:[]})},function(e,t,s){"use strict";(function(e){s.d(t,"a",(function(){return l}));var n=s(100),a=s.n(n);function i(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function o(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?i(Object(s),!0).forEach((function(t){a()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):i(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const r={bgColor:"#d00",textColor:"#fff",fontFamily:"sans-serif",fontWeight:"bold",isUp:!1,isLeft:!1};class l{constructor(e={}){a()(this,"browser",{ff:void 0!==window.InstallTrigger,opera:!!window.opera||navigator.userAgent.includes("Opera")}),a()(this,"params",void 0),a()(this,"canvas",void 0),a()(this,"baseImage",void 0),a()(this,"context",void 0),a()(this,"icons",void 0),a()(this,"isReady",!1),a()(this,"readyCb",()=>{}),this.params=o(o({},r),e),this.icons=l.getIcons(),this.canvas=document.createElement("canvas"),this.baseImage=document.createElement("img");const t=this.icons[this.icons.length-1];t.hasAttribute("href")?(this.baseImage.setAttribute("crossOrigin","anonymous"),this.baseImage.onload=()=>{this.canvas.height=this.baseImage.height>0?this.baseImage.height:32,this.canvas.width=this.baseImage.width>0?this.baseImage.width:32,this.context=this.canvas.getContext("2d"),this.ready()},this.baseImage.setAttribute("src",t.getAttribute("href"))):(this.canvas.height=this.baseImage.height=32,this.canvas.width=this.baseImage.width=32,this.context=this.canvas.getContext("2d"),this.ready())}reset(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height)}options(e,t){const s={n:"number"==typeof e?Math.abs(e):e,len:(""+e).length,x:.4,y:.4,w:.6,h:.6};return t.isUp&&(s.y<.6?s.y=s.y-.4:s.y=s.y-2*s.y+(1-s.w)),t.isLeft&&(s.x<.6?s.x=s.x-.4:s.x=s.x-2*s.x+(1-s.h)),s.x=this.canvas.width*s.x,s.y=this.canvas.height*s.y,s.w=this.canvas.width*s.w,s.h=this.canvas.height*s.h,s}circle(e,t){const s=o(o({},this.params),t),n=this.options(e,s);let a=!1;2===n.len?(n.x=n.x-.4*n.w,n.w=1.4*n.w,a=!0):n.len>=3&&(n.x=n.x-.65*n.w,n.w=1.65*n.w,a=!0),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.context.drawImage(this.baseImage,0,0,this.canvas.width,this.canvas.height),this.context.beginPath();const i=Math.floor(n.h*(n.n>99?.85:1))+"px";if(this.context.font=`${s.fontWeight} ${i} ${s.fontFamily}`,this.context.textAlign="center",a?(this.context.moveTo(n.x+n.w/2,n.y),this.context.lineTo(n.x+n.w-n.h/2,n.y),this.context.quadraticCurveTo(n.x+n.w,n.y,n.x+n.w,n.y+n.h/2),this.context.lineTo(n.x+n.w,n.y+n.h-n.h/2),this.context.quadraticCurveTo(n.x+n.w,n.y+n.h,n.x+n.w-n.h/2,n.y+n.h),this.context.lineTo(n.x+n.h/2,n.y+n.h),this.context.quadraticCurveTo(n.x,n.y+n.h,n.x,n.y+n.h-n.h/2),this.context.lineTo(n.x,n.y+n.h/2),this.context.quadraticCurveTo(n.x,n.y,n.x+n.h/2,n.y)):this.context.arc(n.x+n.w/2,n.y+n.h/2,n.h/2,0,2*Math.PI),this.context.fillStyle=s.bgColor,this.context.fill(),this.context.closePath(),this.context.beginPath(),this.context.stroke(),this.context.fillStyle=s.textColor,"number"==typeof n.n&&n.n>999){const e=(n.n>9999?9:Math.floor(n.n/1e3))+"k+";this.context.fillText(e,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.2*n.h))}else this.context.fillText(""+n.n,Math.floor(n.x+n.w/2),Math.floor(n.y+n.h-.15*n.h));this.context.closePath()}ready(){this.isReady||(this.isReady=!0,this.readyCb())}setIcon(t){e(()=>{this.setIconSrc(t.toDataURL("image/png"))})}setIconSrc(e){if(this.browser.ff||this.browser.opera){const t=this.icons[this.icons.length-1],s=window.document.createElement("link");this.icons=[s],s.setAttribute("rel","icon"),s.setAttribute("type","image/png"),window.document.getElementsByTagName("head")[0].appendChild(s),s.setAttribute("href",e),t.parentNode&&t.parentNode.removeChild(t)}else this.icons.forEach(t=>{t.setAttribute("href",e)})}badge(e,t){this.isReady?("string"==typeof e||e>0?this.circle(e,t):this.reset(),this.setIcon(this.canvas)):this.readyCb=()=>{this.badge(e,t)}}static getLinks(){const e=[],t=window.document.getElementsByTagName("head")[0].getElementsByTagName("link");for(let s=0;s<t.length;s++)/(^|\s)icon(\s|$)/i.test(t[s].getAttribute("rel"))&&e.push(t[s]);return e}static getIcons(){let e=l.getLinks();return 0===e.length&&(e=[window.document.createElement("link")],e[0].setAttribute("rel","icon"),window.document.getElementsByTagName("head")[0].appendChild(e[0])),e.forEach(e=>{e.setAttribute("type","image/png")}),e}}}).call(this,s(167).setImmediate)},,,,,,,,,,,function(e,t,s){"use strict";s.r(t),s.d(t,"components",(function(){return Kg}));var n=s(102),a=s(81),i=s.n(a),o=s(119);function r(e){const t=e.embeddedPages;let s=null;return t&&(s=t.homeUrl),s||(s=e.welcomePageUrl),s}var l=s(83),c=s(92),d=s(85),m=s(87),h=s(94),u=s(168),p=s(204),g=s(113),f=s(146),b=s(97),v=s(370),_=s(116),y=s(105),E=s(98);const C=()=>{_.a.trackEvent("home_page","button","dm"),y.a.instance.track("home_page_button",{button:"dm"}),m.a.dispatch({action:"view_create_chat"})},w=()=>{_.a.trackEvent("home_page","button","room_directory"),y.a.instance.track("home_page_button",{button:"room_directory"}),m.a.fire(h.a.ViewRoomDirectory)},S=()=>{_.a.trackEvent("home_page","button","create_room"),y.a.instance.track("home_page_button",{button:"create_room"}),m.a.dispatch({action:"view_create_room"})},x=e=>({displayName:p.a.instance.displayName||e,avatarUrl:p.a.instance.getHttpAvatarUrl(v.a)}),R=()=>{const e=Object(a.useContext)(b.a),t=e.getUserId(),[s,n]=Object(a.useState)(x(t));return Object(f.a)(p.a.instance,g.b,()=>{n(x(t))}),a.createElement("div",null,a.createElement(v.b,{hasAvatar:!!s.avatarUrl,hasAvatarLabel:Object(l.a)("Great, that'll help people know it's you"),noAvatarLabel:Object(l.a)("Add a photo so people know it's you."),setAvatarUrl:t=>e.setAvatarUrl(t)},a.createElement(u.a,{idName:t,name:s.displayName,url:s.avatarUrl,width:v.a,height:v.a,resizeMethod:"crop"})),a.createElement("h1",null,Object(l.a)("Welcome %(name)s",{name:s.displayName})),a.createElement("h4",null,Object(l.a)("Now, let's help you get started")))};var O=({justRegistered:e=!1})=>{const t=c.a.get(),s=r(t),n=d.getComponent("elements.AccessibleButton");if(s){const e=d.getComponent("structures.EmbeddedPage");return a.createElement(e,{className:"mx_HomePage",url:s,scrollbar:!0})}let i;if(e)i=a.createElement(R,null);else{t.branding;let e="themes/tchap/img/logos/tchap-logo.svg";i=a.createElement(a.Fragment,null,a.createElement("img",{src:e,alt:t.brand}),a.createElement("h1",null,Object(l.a)("Welcome to %(appName)s",{appName:t.brand})),a.createElement("h4",null,Object(l.a)("State instant messaging")))}let m=null;return E.a.isCurrentUserExtern()||(m=a.createElement("div",{className:"mx_HomePage_default_buttons"},a.createElement(n,{onClick:C,className:"mx_HomePage_button_sendDm"},Object(l.a)("Send a Direct Message")),a.createElement(n,{onClick:w,className:"mx_HomePage_button_explore"},Object(l.a)("Explore Forums")),a.createElement(n,{onClick:S,className:"mx_HomePage_button_createGroup"},Object(l.a)("Create a Group Chat")))),a.createElement(o.a,{className:"mx_HomePage mx_HomePage_default"},a.createElement("div",{className:"mx_HomePage_default_wrapper"},i,m))},k=s(82),I=s.n(k),T=s(205);class j extends g.a{constructor(){super(m.a,{hostSignupActive:!1})}static get instance(){return j.internalInstance}get isHostSignupActive(){return this.state.hostSignupActive}async setHostSignupActive(e){return this.updateState({hostSignupActive:e})}onDispatch(e){}}I()(j,"internalInstance",new j);class N extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"openDialog",async()=>{await j.instance.setHostSignupActive(!0)})}render(){const e=c.a.get().hostSignup;return null!=e&&e.brand?i.a.createElement(T.c,null,i.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconHosting",label:Object(l.a)("Upgrade to %(hostSignupBrand)s",{hostSignupBrand:e.brand}),onClick:this.openDialog})):null}}var P=s(181),D=s(371);class A{static fetchJoinedGroups(e){return Object(D.a)("GroupActions.fetchJoinedGroups",()=>e.getJoinedGroups(),null)}}var U=s(305),M=s(90),L=s.n(M),F=s(88),B=s(115);class V extends i.a.PureComponent{constructor(e){super(e),I()(this,"tagStoreRef",void 0),I()(this,"onTagStoreUpdate",()=>{const e=0===P.a.getSelectedTags().length;this.setState({selected:e})}),I()(this,"onTileClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"deselect_tags"})}),this.state={selected:0===P.a.getSelectedTags().length}}componentDidMount(){this.tagStoreRef=P.a.addListener(this.onTagStoreUpdate)}componentWillUnmount(){this.tagStoreRef.remove()}render(){const e=L()({mx_TagTile:!0,mx_TagTile_prototype:!0,mx_TagTile_selected_prototype:this.state.selected,mx_TagTile_home:!0});return i.a.createElement(B.a,{className:e,onClick:this.onTileClick,title:Object(l.a)("Home")},i.a.createElement("div",{className:"mx_TagTile_avatar"},i.a.createElement("div",{className:"mx_TagTile_homeIcon"})))}}class W extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{orderedTags:[],selectedTags:[]}),I()(this,"_onGroupMyMembership",()=>{this.unmounted||m.a.dispatch(A.fetchJoinedGroups(this.context))}),I()(this,"_onClientSync",(e,t)=>{"ERROR"!==e&&t!==e&&m.a.dispatch(A.fetchJoinedGroups(this.context))}),I()(this,"onMouseDown",e=>{this.state.selectedTags.length>0&&m.a.dispatch({action:"deselect_tags"})}),I()(this,"onClearFilterClick",e=>{m.a.dispatch({action:"deselect_tags"})})}componentDidMount(){this.unmounted=!1,this.context.on("Group.myMembership",this._onGroupMyMembership),this.context.on("sync",this._onClientSync),this._groupFilterOrderStoreToken=P.a.addListener(()=>{this.unmounted||this.setState({orderedTags:P.a.getOrderedTags()||[],selectedTags:P.a.getSelectedTags()})}),m.a.dispatch(A.fetchJoinedGroups(this.context))}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("Group.myMembership",this._onGroupMyMembership),this.context.removeListener("sync",this._onClientSync),this._groupFilterOrderStoreToken&&this._groupFilterOrderStoreToken.remove()}renderGlobalIcon(){return F.a.getValue("feature_communities_v2_prototypes")?i.a.createElement("div",null,i.a.createElement(V,null),i.a.createElement("hr",{className:"mx_GroupFilterPanel_divider"})):null}render(){const e=d.getComponent("elements.DNDTagTile"),t=d.getComponent("elements.ActionButton"),s=this.state.orderedTags.map((t,s)=>i.a.createElement(e,{key:t,tag:t,index:s,selected:this.state.selectedTags.includes(t)})),n=this.state.selectedTags.length>0,a=L()("mx_GroupFilterPanel",{mx_GroupFilterPanel_items_selected:n});let r=i.a.createElement(t,{tooltip:!0,label:Object(l.a)("Communities"),action:"toggle_my_groups",className:"mx_TagTile mx_TagTile_plus"});return F.a.getValue("feature_communities_v2_prototypes")&&(r=i.a.createElement(t,{tooltip:!0,label:Object(l.a)("Create community"),action:"view_create_group",className:"mx_TagTile mx_TagTile_plus"})),i.a.createElement("div",{className:a,onClick:this.onClearFilterClick},i.a.createElement(o.a,{className:"mx_GroupFilterPanel_scroller",onMouseDown:this.onMouseDown},i.a.createElement(U.Droppable,{droppableId:"tag-panel-droppable",type:"draggable-TagTile"},(e,t)=>i.a.createElement("div",{className:"mx_GroupFilterPanel_tagTileContainer",ref:e.innerRef},this.renderGlobalIcon(),s,i.a.createElement("div",null,r),e.placeholder))))}}I()(W,"contextType",b.a);var H=W,G=s(551),q=s(153);class K extends i.a.Component{constructor(e){super(e),this.state={tags:G.a.getSortedTags()}}componentDidMount(){this._tagStoreToken=G.a.addListener(()=>{this.setState({tags:G.a.getSortedTags()})})}componentWillUnmount(){this._tagStoreToken&&this._tagStoreToken.remove()}render(){const e=this.state.tags.map(e=>i.a.createElement(z,{tag:e,key:e.name})),t=L()("mx_CustomRoomTagPanel",{mx_CustomRoomTagPanel_empty:0===this.state.tags.length});return i.a.createElement("div",{className:t},i.a.createElement("div",{className:"mx_CustomRoomTagPanel_divider"}),i.a.createElement(o.a,{className:"mx_CustomRoomTagPanel_scroller"},e))}}class z extends i.a.Component{constructor(...e){super(...e),I()(this,"onClick",()=>{m.a.dispatch({action:"select_custom_room_tag",tag:this.props.tag.name})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleTooltipButton"),s=this.props.tag,n=L()({CustomRoomTagPanel_tileSelected:s.selected}),a=s.name,o=s.badgeNotifState;let r;if(o){const e=L()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:o.hasMentions});r=i.a.createElement("div",{className:e},q.c(o.count))}return i.a.createElement(t,{className:n,onClick:this.onClick,title:a},i.a.createElement("div",{className:"mx_TagTile_avatar"},i.a.createElement(e,{name:s.avatarLetter,idName:a,width:40,height:40}),r))}}var $=K,Y=s(177),J=s(150),Q=s(128),X=s(125),Z=s(445),ee=s(86),te=s(93),se=s.n(te),ne=s(101),ae=s.n(ne);class ie extends i.a.Component{getGroupAvatarUrl(){return ee.a.get().mxcUrlToHttp(this.props.groupAvatarUrl,this.props.width,this.props.height,this.props.resizeMethod)}render(){const e=this.props,{groupId:t,groupAvatarUrl:s,groupName:n}=e,a=ae()(e,["groupId","groupAvatarUrl","groupName"]);return i.a.createElement(u.a,se()({name:n||this.props.groupId[1],idName:this.props.groupId,url:this.getGroupAvatarUrl()},a))}}I()(ie,"defaultProps",{width:36,height:36,resizeMethod:"crop"});var oe=s(287);class re extends i.a.Component{constructor(e){super(e),I()(this,"onTileMouseEnter",()=>{this.setState({hover:!0})}),I()(this,"onTileMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const e=L()({mx_RoomTile:!0,mx_TemporaryTile:!0,mx_RoomTile_selected:this.props.isSelected,mx_RoomTile_minimized:this.props.isMinimized}),t=i.a.createElement(oe.a,{notification:this.props.notificationState,forceCount:!1});let s=this.props.displayName;"string"!=typeof s&&(s=""),s=s.replace(":",":​");const n=L()({mx_RoomTile_name:!0,mx_RoomTile_nameHasUnreadEvents:this.props.notificationState.isUnread});let a=i.a.createElement("div",{className:"mx_RoomTile_nameContainer"},i.a.createElement("div",{title:s,className:n,tabIndex:-1,dir:"auto"},s));this.props.isMinimized&&(a=null);let o=Y.a;return this.props.isMinimized&&(o=Y.b),i.a.createElement(i.a.Fragment,null,i.a.createElement(o,{className:e,onMouseEnter:this.onTileMouseEnter,onMouseLeave:this.onTileMouseLeave,onClick:this.props.onClick,role:"treeitem",title:this.props.isMinimized?s:void 0},i.a.createElement("div",{className:"mx_RoomTile_avatarContainer"},this.props.avatar),a,i.a.createElement("div",{className:"mx_RoomTile_badgeContainer"},t)))}}var le=s(246);class ce extends le.b{constructor(e,t,s){super(),this._symbol=e,this._count=t,this._color=s}static forCount(e,t){return new ce(null,e,t)}static forSymbol(e,t){return new ce(e,0,t)}}var de=s(245),me=s(176),he=s(120),ue=s(152),pe=s(91),ge=s(157),fe=s(141);const be=[X.a.Invite,X.a.Favourite,X.a.DM,X.a.Untagged,X.a.ServerNotice],ve=X.a.Untagged,_e=[X.a.DM,X.a.Untagged],ye=e=>{(e||m.a).dispatch({action:"view_create_chat"})},Ee=e=>a.createElement(T.c,{first:!0},a.createElement(T.b,{label:Object(l.a)("Start a Conversation"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),m.a.dispatch({action:"view_create_chat"})}}),a.createElement(T.b,{label:Object(l.a)("Open dial pad"),iconClassName:"mx_RoomList_iconDialpad",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),m.a.fire(h.a.OpenDialPad)}})),Ce={[X.a.Invite]:{sectionLabel:Object(l.b)("Invites"),isInvite:!0,defaultHidden:!1},[X.a.Favourite]:{sectionLabel:Object(l.b)("Pinned"),isInvite:!1,defaultHidden:!1},[X.a.DM]:{sectionLabel:Object(l.b)("People"),isInvite:!1,defaultHidden:!1,addRoomLabel:Object(l.b)("Start chat")},[X.a.Untagged]:{sectionLabel:Object(l.b)("Rooms"),isInvite:!1,defaultHidden:!1,addRoomLabel:Object(l.b)("Add room"),addRoomContextMenu:e=>a.createElement(T.c,{first:!0},a.createElement(T.b,{label:Object(l.a)("Create new room"),iconClassName:"mx_RoomList_iconPlus",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),m.a.dispatch({action:"view_create_room"})}}),a.createElement(T.b,{label:ge.a.instance.getSelectedCommunityId()?Object(l.a)("Explore community rooms"):Object(l.a)("Explore forums"),iconClassName:"mx_RoomList_iconExplore",onClick:t=>{t.preventDefault(),t.stopPropagation(),e(),m.a.fire(h.a.ViewRoomDirectory)}}))},[X.a.LowPriority]:{sectionLabel:Object(l.b)("Low priority"),isInvite:!1,defaultHidden:!1},[X.a.ServerNotice]:{sectionLabel:Object(l.b)("System Alerts"),isInvite:!1,defaultHidden:!1},[X.a.Archived]:{sectionLabel:Object(l.b)("Historical"),isInvite:!1,defaultHidden:!0}};class we extends a.PureComponent{constructor(e){super(e),I()(this,"dispatcherRef",void 0),I()(this,"customTagStoreRef",void 0),I()(this,"tagAesthetics",void 0),I()(this,"onAction",e=>{if(e.action===h.a.ViewRoomDelta){const t=e,s=Q.a.getRoomId(),n=this.getRoomDelta(s,t.delta,t.unread);n&&m.a.dispatch({action:"view_room",room_id:n.roomId,show_room_tile:!0})}else e.action===h.a.PstnSupportUpdated&&(this.updateDmAddRoomAction(),this.updateLists())}),I()(this,"getRoomDelta",(e,t,s=!1)=>{const n=J.b.instance.orderedLists,a=[];be.forEach(t=>{let i=n[t];s&&(i=i.filter(t=>{const s=me.a.instance.getRoomState(t);return s.room.roomId===e||s.isUnread})),a.push(...i)});const i=a.findIndex(t=>t.roomId===e),[o]=a.slice((i+t)%a.length);return o}),I()(this,"updateLists",()=>{const e=J.b.instance.orderedLists;F.a.getValue("advancedRoomListLogging")&&console.log("new lists",e);const t=Object.keys(this.state.sublists),s=Object.keys(e).filter(e=>!Object(X.d)(e)||G.a.getTags()[e]),n=!!J.b.instance.getFirstNameFilterCondition();let a=this.state.isNameFiltering!==n||Object(he.d)(t,s);if(!a)for(const t of s){const s=this.state.sublists[t],n=e[t];if(s.length!==n.length){a=!0;break}}if(a){const t=Object(ue.f)(e,s),a=Object(ue.e)(t,(e,t)=>Object(he.c)(t));this.setState({sublists:a,isNameFiltering:n},()=>{this.props.onResize()})}}),I()(this,"onStartChat",()=>{var e;const t=null===(e=J.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;m.a.dispatch({action:"view_create_chat",initialText:t})}),I()(this,"onExplore",()=>{var e;const t=null===(e=J.b.instance.getFirstNameFilterCondition())||void 0===e?void 0:e.search;m.a.dispatch({action:h.a.ViewRoomDirectory,initialText:t})}),this.state={sublists:{},isNameFiltering:!!J.b.instance.getFirstNameFilterCondition()},this.tagAesthetics=Object(ue.e)(Ce),this.updateDmAddRoomAction(),this.dispatcherRef=m.a.register(this.onAction)}componentDidMount(){J.b.instance.on(J.a,this.updateLists),this.customTagStoreRef=G.a.addListener(this.updateLists),this.updateLists()}componentWillUnmount(){J.b.instance.off(J.a,this.updateLists),m.a.unregister(this.dispatcherRef),this.customTagStoreRef&&this.customTagStoreRef.remove()}updateDmAddRoomAction(){const e=Object(ue.e)(Ce[X.a.DM]);fe.b.sharedInstance().getSupportsPstnProtocol()?e.addRoomContextMenu=Ee:e.onAddRoom=ye,this.tagAesthetics[X.a.DM]=e}renderCommunityInvites(){return ee.a.get().getGroups().filter(e=>"invite"===e.myMembership).map(e=>{const t=a.createElement(ie,{groupId:e.groupId,groupName:e.name,groupAvatarUrl:e.avatarUrl,width:32,height:32,resizeMethod:"crop"});return a.createElement(re,{isMinimized:this.props.isMinimized,isSelected:!1,displayName:e.name,avatar:t,notificationState:ce.forSymbol("!",de.a.Red),onClick:()=>{m.a.dispatch({action:"view_group",group_id:e.groupId})},key:"temporaryGroupTile_"+e.groupId})})}renderSublists(){const e=[],t=be.reduce((e,t)=>{if(t===ve){const t=Object.keys(this.state.sublists).filter(e=>Object(X.d)(e));e.push(...t)}return e.push(t),e},[]),s=!this.state.isNameFiltering&&Object.values(J.b.instance.unfilteredLists).every(e=>!(null!=e&&e.length));for(const i of t){const t=this.state.sublists[i]||[],o=i===X.a.Invite?this.renderCommunityInvites():null;if(0===t.length+(o?o.length:0)&&!_e.includes(i))continue;const r=Object(X.d)(i)?((n=i).startsWith("u.")&&(n=n.substring(2)),{sectionLabel:Object(l.b)("Custom Tag"),sectionLabelRaw:n,isInvite:!1,defaultHidden:!1}):this.tagAesthetics[i];if(!r)throw new Error(`Tag ${i} does not have aesthetics`);e.push(a.createElement(Z.b,{key:"sublist-"+i,tagId:i,forRooms:!0,startAsHidden:r.defaultHidden,label:r.sectionLabelRaw?r.sectionLabelRaw:Object(l.a)(r.sectionLabel),onAddRoom:r.onAddRoom,addRoomLabel:r.addRoomLabel?Object(l.a)(r.addRoomLabel):r.addRoomLabel,addRoomContextMenu:r.addRoomContextMenu,isMinimized:this.props.isMinimized,onResize:this.props.onResize,showSkeleton:s,extraBadTilesThatShouldntExist:o}))}var n;return e}render(){let e;const t=ee.a.get().getUserId(),s=E.a.isUserExtern(t);if(!this.props.isMinimized)if(this.state.isNameFiltering&&!s)e=a.createElement("div",{className:"mx_RoomList_explorePrompt"},a.createElement("div",null,Object(l.a)("Can't see what you’re looking for?")),a.createElement(pe.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(l.a)("Start a new chat")),a.createElement(pe.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},Object(l.a)("Explore all public rooms")));else if(Object.values(this.state.sublists).some(e=>e.length>0)){const t=J.b.instance.unfilteredLists,n=t[X.a.Untagged]||[],i=t[X.a.Archived]||[],o=t[X.a.Favourite]||[];n.length<1&&i<1&&o<1&&!s&&(e=a.createElement("div",{className:"mx_RoomList_explorePrompt"},a.createElement("div",null,Object(l.a)("Use the + to make a new room or explore existing ones below")),a.createElement(pe.a,{className:"mx_RoomList_explorePrompt_startChat",kind:"link",onClick:this.onStartChat},Object(l.a)("Start a new chat")),a.createElement(pe.a,{className:"mx_RoomList_explorePrompt_explore",kind:"link",onClick:this.onExplore},Object(l.a)("Explore all public rooms"))))}const n=this.renderSublists();return a.createElement(Y.c,{handleHomeEnd:!0,onKeyDown:this.props.onKeyDown},({onKeyDownHandler:t})=>a.createElement("div",{onFocus:this.props.onFocus,onBlur:this.props.onBlur,onKeyDown:t,className:"mx_RoomList",role:"tree","aria-label":Object(l.a)("Rooms")},n,e))}}var Se=s(84),xe=s.n(Se);class Re{constructor(e,t,s,n){this.id=e,this.label=t,this.icon=s,this.body=n}}class Oe extends a.Component{constructor(e){super(e);let t=0;if(e.initialTabId){const s=e.tabs.findIndex(t=>t.id===e.initialTabId);s>=0&&(t=s)}this.state={activeTabIndex:t}}_getActiveTabIndex(){return this.state&&this.state.activeTabIndex?this.state.activeTabIndex:0}_setActiveTab(e){const t=this.props.tabs.indexOf(e);-1!==t?this.setState({activeTabIndex:t}):console.error("Could not find tab "+e.label+" in tabs")}_renderTabLabel(e){const t=d.getComponent("elements.AccessibleButton");let s="mx_TabbedView_tabLabel ";this.props.tabs.indexOf(e)===this._getActiveTabIndex()&&(s+="mx_TabbedView_tabLabel_active");let n=null;e.icon&&(n=a.createElement("span",{className:"mx_TabbedView_maskedIcon "+e.icon}));const i=Object(l.a)(e.label);return a.createElement(t,{className:s,key:"tab_label_"+e.label,onClick:()=>this._setActiveTab(e)},n,a.createElement("span",{className:"mx_TabbedView_tabLabel_text"},i))}_renderTabPanel(e){return a.createElement("div",{className:"mx_TabbedView_tabPanel",key:"mx_tabpanel_"+e.label},a.createElement(o.a,{className:"mx_TabbedView_tabPanelContent"},e.body))}render(){const e=this.props.tabs.map(e=>this._renderTabLabel(e)),t=this._renderTabPanel(this.props.tabs[this._getActiveTabIndex()]);return a.createElement("div",{className:"mx_TabbedView"},a.createElement("div",{className:"mx_TabbedView_tabLabels"},e),t)}}var ke=s(104),Ie=s(112),Te=s.n(Ie),je=s(1137),Ne=s.n(je);function Pe(e){const t=c.a.get().hosting_signup_link;if(!t)return null;if(!e)return t;if("matrix.org"!==ee.a.get().getDomain())return null;try{const s=Te.a.parse(t),n=Ne.a.parse(s.query);return n.utm_campaign=e,s.search=void 0,s.query=n,s.format()}catch(e){return t}}var De=s(89),Ae=s(140);class Ue extends i.a.Component{constructor(){super(),I()(this,"_uploadAvatar",()=>{this._avatarUpload.current.click()}),I()(this,"_removeAvatar",()=>{this._avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,enableProfileSave:!0})}),I()(this,"_cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),I()(this,"_saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=ee.a.get(),s={};try{if(this.state.originalDisplayName!==this.state.displayName&&(await t.setDisplayName(this.state.displayName),s.originalDisplayName=this.state.displayName),this.state.avatarFile){console.log(`Uploading new avatar, ${this.state.avatarFile.name} of type ${this.state.avatarFile.type}, (${this.state.avatarFile.size}) bytes`);const e=await t.uploadContent(this.state.avatarFile);await t.setAvatarUrl(e),s.avatarUrl=t.mxcUrlToHttp(e,96,96,"crop",!1),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.setAvatarUrl("")}catch(e){console.log("Failed to save profile",e),De.a.createTrackedDialog("Failed to save profile","",Ae.a,{title:Object(l.a)("Failed to save your profile"),description:e&&e.message?e.message:Object(l.a)("The operation could not be completed")})}this.setState(s)}),I()(this,"_onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const e=ee.a.get();let t=p.a.instance.avatarMxc;t&&(t=e.mxcUrlToHttp(t,96,96,"crop",!1)),this.state={userId:e.getUserId(),originalDisplayName:p.a.instance.displayName,displayName:p.a.instance.displayName,originalAvatarUrl:t,avatarUrl:t,avatarFile:null,enableProfileSave:!1},this._avatarUpload=Object(a.createRef)()}render(){const e=Pe("user-settings");let t=null;e&&(t=i.a.createElement("span",{className:"mx_ProfileSettings_hostingSignup"},Object(l.a)("<a>Upgrade</a> to your own domain",{},{a:t=>i.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},t)}),i.a.createElement("a",{href:e,target:"_blank",rel:"noreferrer noopener"},i.a.createElement("img",{src:s(657),width:"11",height:"10",alt:""}))));const n=d.getComponent("elements.AccessibleButton"),a=d.getComponent("settings.AvatarSetting");return i.a.createElement("form",{onSubmit:this._saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},i.a.createElement("input",{type:"file",ref:this._avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this._onAvatarChanged,accept:"image/*"}),i.a.createElement("div",{className:"mx_ProfileSettings_profile"},i.a.createElement("div",{className:"mx_ProfileSettings_controls"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Profile")),i.a.createElement("p",null,this.state.displayName)),i.a.createElement(a,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.state.userId,avatarAltText:Object(l.a)("Profile picture"),uploadAvatar:this._uploadAvatar,removeAvatar:this._removeAvatar})),i.a.createElement("div",{className:"mx_ProfileSettings_buttons"},i.a.createElement(n,{onClick:this._cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(l.a)("Cancel")),i.a.createElement(n,{onClick:this._saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(l.a)("Save"))))}}class Me extends i.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this.state={searchQuery:"",langs:null}}componentDidMount(){if(l.c().then(e=>{e.sort((function(e,t){return e.label<t.label?-1:e.label>t.label?1:0})),this.setState({langs:e})}).catch(()=>{this.setState({langs:["en"]})}),!this.props.value){const e=F.a.getValue("language",null,!0);if(e)this.props.onOptionChange(e);else{const e=l.i(l.e());this.props.onOptionChange(e)}}}_onSearchChange(e){this.setState({searchQuery:e})}render(){if(null===this.state.langs){const e=d.getComponent("elements.Spinner");return i.a.createElement(e,null)}const e=d.getComponent("elements.Dropdown");let t;t=this.state.searchQuery?this.state.langs.filter(e=>function(e,t){return!!t.label.toUpperCase().includes(e.toUpperCase())||t.value.toUpperCase()===e.toUpperCase()}(this.state.searchQuery,e)):this.state.langs;const s=t.map(e=>i.a.createElement("div",{key:e.value},e.label));let n=F.a.getValue("language",null,!0),a=null;return n||(n=navigator.language||navigator.userLanguage),a=this.props.value||n,i.a.createElement(e,{id:"mx_LanguageDropdown",className:this.props.className,onOptionChange:this.props.onOptionChange,onSearchChange:this._onSearchChange,searchEnabled:!0,value:a,label:Object(l.a)("Language Dropdown"),disabled:this.props.disabled},s)}}Me.propTypes={className:xe.a.string,onOptionChange:xe.a.func.isRequired,value:xe.a.string};var Le=s(345),Fe=s(95),Be=s(200);const Ve=new Error("User cancelled auth session");class We extends i.a.Component{constructor(e){super(e),I()(this,"_requestEmailToken",async(...e)=>{this.setState({busy:!0});try{return await this.props.requestEmailToken(...e)}finally{this.setState({busy:!1})}}),I()(this,"tryContinue",()=>{this._stageComponent.current&&this._stageComponent.current.tryContinue&&this._stageComponent.current.tryContinue()}),I()(this,"_authStateUpdated",(e,t)=>{const s=this.state.authStage;this.setState({busy:!1,authStage:e,stageState:t,errorText:t.error},()=>{s!==e?this._setFocus():!t.error&&this._stageComponent.current&&this._stageComponent.current.attemptFailed&&this._stageComponent.current.attemptFailed()})}),I()(this,"_requestCallback",e=>this.props.makeRequest(e)),I()(this,"_onBusyChanged",e=>{e&&this.setState({busy:!0,errorText:null,stageErrorText:null})}),I()(this,"_submitAuthDict",e=>{this._authLogic.submitAuthDict(e)}),I()(this,"_onPhaseChange",e=>{this.props.onStagePhaseChange&&this.props.onStagePhaseChange(this.state.authStage,e||0)}),I()(this,"_onStageCancel",()=>{this.props.onAuthFinished(!1,Ve)}),I()(this,"_onAuthStageFailed",e=>{this.props.onAuthFinished(!1,e)}),I()(this,"_setEmailSid",e=>{this._authLogic.setEmailSid(e)}),this.state={authStage:null,busy:!1,errorText:null,stageErrorText:null,submitButtonEnabled:!1},this._unmounted=!1,this._authLogic=new Fe.h({authData:this.props.authData,doRequest:this._requestCallback,busyChanged:this._onBusyChanged,inputs:this.props.inputs,stateUpdated:this._authStateUpdated,matrixClient:this.props.matrixClient,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.emailSid,requestEmailToken:this._requestEmailToken}),this._authLogic.poll(),this._stageComponent=Object(a.createRef)()}UNSAFE_componentWillMount(){this._authLogic.attemptAuth().then(e=>{const t={emailSid:this._authLogic.getEmailSid(),clientSecret:this._authLogic.getClientSecret()};this.props.onAuthFinished(!0,e,t)}).catch(e=>{let t=e;if(e.errcode&&"M_THREEPID_DENIED"===e.errcode&&(t=Object(l.a)(e.message)),this.props.onAuthFinished(!1,t),console.error("Error during user-interactive auth:",e),this._unmounted)return;const s=e.message||e.toString();this.setState({errorText:s})})}componentWillUnmount(){this._unmounted=!0,null!==this._intervalId&&clearInterval(this._intervalId)}_setFocus(){this._stageComponent.current&&this._stageComponent.current.focus&&this._stageComponent.current.focus()}_renderCurrentStage(){const e=this.state.authStage;if(!e){if(this.state.busy){const e=d.getComponent("elements.Spinner");return i.a.createElement(e,null)}return null}const t=Object(Be.d)(e);return i.a.createElement(t,{ref:this._stageComponent,loginType:e,matrixClient:this.props.matrixClient,authSessionId:this._authLogic.getSessionId(),clientSecret:this._authLogic.getClientSecret(),stageParams:this._authLogic.getStageParams(e),submitAuthDict:this._submitAuthDict,errorText:this.state.stageErrorText,busy:this.state.busy,inputs:this.props.inputs,stageState:this.state.stageState,fail:this._onAuthStageFailed,setEmailSid:this._setEmailSid,showContinue:!this.props.continueIsManaged,onPhaseChange:this._onPhaseChange,continueText:this.props.continueText,continueKind:this.props.continueKind,onCancel:this._onStageCancel})}render(){let e=null;return this.state.errorText&&(e=i.a.createElement("div",{className:"error"},this.state.errorText)),i.a.createElement("div",null,i.a.createElement("div",null,this._renderCurrentStage(),e))}}I()(We,"propTypes",{matrixClient:xe.a.object.isRequired,authData:xe.a.shape({flows:xe.a.array,params:xe.a.object,session:xe.a.string}),makeRequest:xe.a.func.isRequired,onAuthFinished:xe.a.func.isRequired,inputs:xe.a.object,requestEmailToken:xe.a.func,sessionId:xe.a.string,clientSecret:xe.a.string,emailSid:xe.a.string,poll:xe.a.bool,continueIsManaged:xe.a.bool,onStagePhaseChange:xe.a.func,continueText:xe.a.string,continueKind:xe.a.string});var He=s(145);class Ge extends i.a.Component{constructor(e){super(e),I()(this,"_onStagePhaseChange",(e,t)=>{const s={[Be.c.PHASE_PREAUTH]:{body:Object(l.a)("Confirm your account deactivation by using Single Sign On to prove your identity."),continueText:Object(l.a)("Single Sign On"),continueKind:"danger"},[Be.c.PHASE_POSTAUTH]:{body:Object(l.a)("Are you sure you want to deactivate your account? This is irreversible."),continueText:Object(l.a)("Confirm account deactivation"),continueKind:"danger"}},n={[Be.c.LOGIN_TYPE]:s,[Be.c.UNSTABLE_LOGIN_TYPE]:s,[Be.b.LOGIN_TYPE]:{[Be.a]:{body:Object(l.a)("To continue, please enter your password:")}}}[e];let a=null,i=null,o=null;if(n){const e=n[t];e&&e.body&&(a=e.body),e&&e.continueText&&(i=e.continueText),e&&e.continueKind&&(o=e.continueKind)}this.setState({bodyText:a,continueText:i,continueKind:o})}),I()(this,"_onUIAuthFinished",(e,t,s)=>{e||(t!==Ve?(console.error("Error during UI Auth:",{result:t,extra:s}),this.setState({errStr:Object(l.a)("There was a problem communicating with the server. Please try again.")})):this._onCancel())}),I()(this,"_onUIAuthComplete",e=>{ee.a.get().deactivateAccount(e,this.state.shouldErase).then(e=>{_.a.trackEvent("Account","Deactivate Account"),Le.i(),this.props.onFinished(!0)}).catch(e=>{console.error(e),this.setState({errStr:Object(l.a)("There was a problem communicating with the server. Please try again.")})})}),I()(this,"_onEraseFieldChange",e=>{this.setState({shouldErase:e.target.checked,authEnabled:!1}),this._initAuth(e.target.checked)}),this.state={shouldErase:!1,errStr:null,authData:null,authEnabled:!0,bodyText:null,continueText:null,continueKind:null},this._initAuth(!1)}_onCancel(){this.props.onFinished(!1)}_initAuth(e){ee.a.get().deactivateAccount(null,e).then(e=>{console.warn("User's account got deactivated without confirmation: Server had no auth"),this.setState({errStr:Object(l.a)("Server did not require any authentication")})}).catch(e=>{e&&401===e.httpStatus&&e.data?this.setState({authData:e.data,authEnabled:!0}):this.setState({errStr:Object(l.a)("Server did not return valid authentication information.")})})}render(){const e=d.getComponent("views.dialogs.BaseDialog");let t=null;this.state.errStr&&(t=i.a.createElement("div",{className:"error"},this.state.errStr));let s=i.a.createElement("div",null,Object(l.a)("Loading..."));return this.state.authData&&this.state.authEnabled&&(s=i.a.createElement("div",null,this.state.bodyText,i.a.createElement(We,{matrixClient:ee.a.get(),authData:this.state.authData,makeRequest:this._onUIAuthComplete,onAuthFinished:this._onUIAuthFinished,onStagePhaseChange:this._onStagePhaseChange,continueText:this.state.continueText,continueKind:this.state.continueKind}))),i.a.createElement(e,{className:"mx_DeactivateAccountDialog",onFinished:this.props.onFinished,titleClass:"danger",title:Object(l.a)("Deactivate Account")},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("p",null,Object(l.a)("This will make your account permanently unusable. You will not be able to log in, and no one will be able to re-register the same user ID. This will cause your account to leave all rooms it is participating in, and it will remove your account details from your identity server. <b>This action is irreversible.</b>",{},{b:e=>i.a.createElement("b",null," ",e," ")})),i.a.createElement("p",null,Object(l.a)("Deactivating your account <b>does not by default cause us to forget messages you have sent.</b> If you would like us to forget your messages, please tick the box below.",{},{b:e=>i.a.createElement("b",null," ",e," ")})),i.a.createElement("p",null,Object(l.a)("Message visibility in Matrix is similar to email. Our forgetting your messages means that messages you have sent will not be shared with any new or unregistered users, but registered users who already have access to these messages will still have access to their copy.")),i.a.createElement("div",{className:"mx_DeactivateAccountDialog_input_section"},i.a.createElement("p",null,i.a.createElement(He.a,{checked:this.state.shouldErase,onChange:this._onEraseFieldChange},Object(l.a)("Please forget all messages I have sent when my account is deactivated (<b>Warning:</b> this will cause future users to see an incomplete view of conversations)",{},{b:e=>i.a.createElement("b",null,e)}))),t,s)))}}Ge.propTypes={onFinished:xe.a.func.isRequired};var qe=s(107),Ke=s(285),ze=s(215),$e=s(288);async function Ye(e,t){const s=e.getUserId();let{threepids:n}=await e.getThreePids();if(t&&(n=n.filter(e=>e.medium===t)),n.length>0&&e.getIdentityServerUrl())try{const a=new ze.a,i=await a.getAccessToken({check:!1}),o=n.map(({medium:e,address:t})=>[e,t]),r=await e.bulkLookupThreePids(o,i);for(const[e,a,i]of r.threepids){if(i!==s)continue;if(t&&e!==t)continue;const o=n.find(t=>t.medium===e&&t.address===a);o&&(o.bound=!0)}}catch(e){if("M_TERMS_NOT_SIGNED"!==e.errcode)throw e}return n}var Je=s(117),Qe=s(96),Xe=s(108),Ze=s(143),et=s(174);class tt extends i.a.Component{constructor(){super(),I()(this,"_onAction",e=>{"id_server_changed"===e.action&&(this.setState({haveIdServer:Boolean(ee.a.get().getIdentityServerUrl())}),this._getThreepidState())}),I()(this,"_onLanguageChange",e=>{this.state.language!==e&&(F.a.setValue("language",null,Qe.a.DEVICE,e),this.setState({language:e}),qe.a.get().reload())}),I()(this,"_onPasswordChangeError",e=>{let t=e.error||"";403===e.httpStatus?t=Object(l.a)("Failed to change password. Is your password correct?"):e.httpStatus&&(t+=` (HTTP status ${e.httpStatus})`);const s=d.getComponent("dialogs.ErrorDialog");console.error("Failed to change password: "+t),De.a.createTrackedDialog("Failed to change password","",s,{title:Object(l.a)("Error"),description:t})}),I()(this,"_onPasswordChanged",()=>{const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Password changed","",e,{title:Object(l.a)("Success"),description:Object(l.a)("Your password was successfully changed. You will not receive push notifications on other sessions until you log back in to them")+"."})}),I()(this,"_onDeactivateClicked",()=>{De.a.createTrackedDialog("Deactivate Account","",Ge,{onFinished:e=>{e&&this.props.closeSettingsFn()}})}),I()(this,"_onRedListOptionChange",async()=>{try{const e=this.state.redListOption;if(E.a.isCurrentUserExtern()&&e){const t=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Redlist disabled","",t,{title:Object(l.a)("Register my account on the red list"),description:Object(l.a)("To disable this option, you must accept that your email address will be visible to the other users."),button:Object(l.a)("Accept"),onFinished:async t=>{t?(await ee.a.get().setAccountData("im.vector.hide_profile",{hide_profile:!e}),this.setState({redListOption:!e})):this.setState({redListOption:e})}})}else await ee.a.get().setAccountData("im.vector.hide_profile",{hide_profile:!e}),this.setState({redListOption:!e})}catch(e){console.error("Error setting AccountData 'im.vector.hide_profile': "+e)}});const e=ee.a.get().getAccountData("im.vector.hide_profile"),t=!!e&&e.event.content.hide_profile;this.state={language:l.d(),haveIdServer:Boolean(ee.a.get().getIdentityServerUrl()),serverSupportsSeparateAddAndBind:null,idServerHasUnsignedTerms:!1,requiredPolicyInfo:{hasTerms:!1},emails:[],msisdns:[],redListOption:t,loading3pids:!0},this.dispatcherRef=m.a.register(this._onAction)}async UNSAFE_componentWillMount(){const e=ee.a.get(),t=await e.doesServerSupportSeparateAddAndBind(),s=(await e.getCapabilities())["m.change_password"],n=!s||!1!==s.enabled;this.setState({serverSupportsSeparateAddAndBind:t,canChangePassword:n}),this._getThreepidState()}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}async _getThreepidState(){const e=ee.a.get();let t=[];try{t=await Ye(e)}catch(e){const t=ee.a.get().getIdentityServerUrl();console.warn(`Unable to reach identity server at ${t} to check for 3PIDs bindings in Settings`),console.warn(e)}this.setState({emails:t.filter(e=>"email"===e.medium),msisdns:t.filter(e=>"msisdn"===e.medium),loading3pids:!1})}async _checkTerms(){if(!this.state.haveIdServer)return void this.setState({idServerHasUnsignedTerms:!1});const e=ee.a.get().getIdentityServerUrl(),t=new ze.a;try{const s=await t.getAccessToken({check:!1});await Object(Ke.d)([new Ke.a(Fe.m.IS,e,s)],(t,s,n)=>new Promise((n,a)=>{this.setState({idServerName:Object($e.a)(e),requiredPolicyInfo:{hasTerms:!0,policiesAndServices:t,agreedUrls:s,resolve:n}})})),this.setState({requiredPolicyInfo:{hasTerms:!1}})}catch(t){console.warn(`Unable to reach identity server at ${e} to check for terms in Settings`),console.warn(t)}}_renderProfileSection(){return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(Ue,null))}_renderAccountSection(){const e=d.getComponent("views.settings.ChangePassword");let t=i.a.createElement(e,{className:"mx_GeneralUserSettingsTab_changePassword",rowClassName:"",buttonKind:"primary",onError:this._onPasswordChangeError,onFinished:this._onPasswordChanged}),n=Object(l.a)("Set a new account password...");this.state.canChangePassword||(n=null,t=null);const a=i.a.createElement("div",null,Object(l.a)("Your password must include a lower-case letter, an upper-case letter, a number and a symbol and be at a minimum 8 characters in length."));return i.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralUserSettingsTab_accountSection"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Account")),i.a.createElement(Ze.a,{value:this.state.redListOption,onChange:this._onRedListOptionChange,label:Object(l.a)("Register my account on the red list")}),i.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},"(",Object(l.a)("Other users will not be able to discover my account on their searches"),")"),i.a.createElement("br",null),i.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},n,i.a.createElement(et.a,{tooltip:a,tooltipClass:"mx_Tooltip_dark"},i.a.createElement("img",{className:"tc_PasswordHelper",src:s(350),width:25,height:25,alt:"Password Complexity Helper"}))),t)}_renderLanguageSection(){return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Language and region")),i.a.createElement(Me,{className:"mx_GeneralUserSettingsTab_languageInput",onOptionChange:this._onLanguageChange,value:this.state.language}))}_renderManagementSection(){return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Account management")),i.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Deactivating your account is a permanent action - be careful!")),i.a.createElement(pe.a,{onClick:this._onDeactivateClicked,kind:"danger"},Object(l.a)("Deactivate Account")))}_renderIntegrationManagerSection(){if(!F.a.getValue(Xe.a.Widgets))return null;const e=d.getComponent("views.settings.SetIntegrationManager");return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(e,null))}render(){this.state.requiredPolicyInfo.hasTerms&&(s(457),Object(l.a)("Warning"));let e;return F.a.getValue(Xe.a.Deactivate)&&(e=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Deactivate account")),this._renderManagementSection())),i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("General")),this._renderProfileSection(),this._renderAccountSection(),this._renderLanguageSection(),e)}}I()(tt,"propTypes",{closeSettingsFn:xe.a.func.isRequired});class st extends i.a.Component{constructor(...e){super(...e),I()(this,"_onChange",async e=>{await F.a.setValue(this.props.featureId,null,Qe.a.DEVICE,e),this.forceUpdate()})}render(){const e=F.a.getDisplayName(this.props.featureId),t=F.a.getValue(this.props.featureId),s=F.a.canSetValue(this.props.featureId,null,Qe.a.DEVICE);return i.a.createElement(Ze.a,{value:t,label:e,onChange:this._onChange,disabled:!s})}}I()(st,"propTypes",{featureId:xe.a.string.isRequired});class nt extends i.a.Component{constructor(){super()}render(){const e=d.getComponent("views.elements.SettingsFlag"),t=F.a.getFeatureSettingNames().map(e=>i.a.createElement(st,{featureId:e,key:e}));return i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Labs")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Customise your experience with experimental labs features. <a>Learn more</a>.",{},{a:e=>i.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/develop/docs/labs.md",rel:"noreferrer noopener",target:"_blank"},e)})),i.a.createElement("div",{className:"mx_SettingsTab_section"},t,i.a.createElement(e,{name:"enableWidgetScreenshots",level:Qe.a.ACCOUNT}),i.a.createElement(e,{name:"showHiddenEventsInTimeline",level:Qe.a.DEVICE}),i.a.createElement(e,{name:"lowBandwidth",level:Qe.a.DEVICE}),i.a.createElement(e,{name:"advancedRoomListLogging",level:Qe.a.DEVICE})))}}var at=s(253),it=s(351);class ot extends a.Component{offset(e,t){const s=e.reduce((e,s)=>t>s?e+1:e,0);if(0===s)return 0;if(s===e.length)return 100;const n=e[s-1],a=e[s],i=1/(e.length-1);return 100*(s-1+(t-n)/(a-n))*i}render(){const e=this.props.values.map(e=>a.createElement(rt,{active:e<=this.props.value,label:this.props.displayFunc(e),onClick:this.props.disabled?()=>{}:()=>this.props.onSelectionChange(e),key:e,disabled:this.props.disabled}));let t=null;if(!this.props.disabled){const e=this.offset(this.props.values,this.props.value);t=a.createElement("div",{className:"mx_Slider_selection"},a.createElement("div",{className:"mx_Slider_selectionDot",style:{left:"calc(-0.55em + "+e+"%)"}}),a.createElement("hr",{style:{width:e+"%"}}))}return a.createElement("div",{className:"mx_Slider"},a.createElement("div",null,a.createElement("div",{className:"mx_Slider_bar"},a.createElement("hr",{onClick:this.props.disabled?()=>{}:this.onClick.bind(this)}),t),a.createElement("div",{className:"mx_Slider_dotContainer"},e)))}onClick(e){const t=e.target.clientWidth,s=e.nativeEvent.offsetX/t,n=this.props.values[Math.round(s*(this.props.values.length-1))];this.props.onSelectionChange(n)}}class rt extends a.PureComponent{render(){let e="mx_Slider_dot";return!this.props.disabled&&this.props.active&&(e+=" mx_Slider_dotActive"),a.createElement("span",{onClick:this.props.onClick,className:"mx_Slider_dotValue"},a.createElement("div",{className:e}),a.createElement("div",{className:"mx_Slider_labelContainer"},a.createElement("div",{className:"mx_Slider_label"},this.props.label)))}}var lt=s(300);class ct{constructor(){I()(this,"dispatcherRef",void 0),I()(this,"onAction",e=>{e.action===h.a.UpdateFontSize?this.setRootFontSize(e.size):e.action===h.a.UpdateSystemFont&&this.setSystemFont(e)}),I()(this,"setRootFontSize",e=>{const t=Math.max(Math.min(ct.MAX_SIZE,e),ct.MIN_SIZE);t!==e&&F.a.setValue("baseFontSize",null,Qe.a.DEVICE,t),document.querySelector(":root").style.fontSize=Object(lt.a)(t)}),I()(this,"setSystemFont",({useSystemFont:e,font:t})=>{document.body.style.fontFamily=e?t:""}),this.dispatcherRef=null}start(){this.setRootFontSize(F.a.getValue("baseFontSize")),this.setSystemFont({useSystemFont:F.a.getValue("useSystemFont"),font:F.a.getValue("systemFont")}),this.dispatcherRef=m.a.register(this.onAction)}stop(){m.a.unregister(this.dispatcherRef)}}I()(ct,"MIN_SIZE",8),I()(ct,"MAX_SIZE",15),I()(ct,"SIZE_DIFF",5);var dt=s(225),mt=s(349);class ht extends i.a.Component{constructor(e){super(e),I()(this,"onChange",async e=>{await this.save(e),this.setState({value:e}),this.props.onChange&&this.props.onChange(e)}),I()(this,"checkBoxOnChange",e=>{this.onChange(e.target.checked)}),I()(this,"save",async e=>{await F.a.setValue(this.props.name,this.props.roomId,this.props.level,void 0!==e?e:this.state.value)}),this.state={value:F.a.getValueAt(this.props.level,this.props.name,this.props.roomId,this.props.isExplicit)}}render(){const e=F.a.canSetValue(this.props.name,this.props.roomId,this.props.level);let t=this.props.label;return t=t?Object(l.a)(t):F.a.getDisplayName(this.props.name,this.props.level),this.props.useCheckbox?i.a.createElement(He.a,{checked:this.state.value,onChange:this.checkBoxOnChange,disabled:this.props.disabled||!e},t):i.a.createElement("div",{className:"mx_SettingsFlag"},i.a.createElement("span",{className:"mx_SettingsFlag_label"},t),i.a.createElement(mt.a,{checked:this.state.value,onChange:this.onChange,disabled:this.props.disabled||!e,"aria-label":t}))}}var ut=s(118),pt=s(226),gt=s(208);class ft extends i.a.Component{constructor(e){super(e),this.state={userId:"@erim:fink.fink",displayname:"Erimayas Fink",avatar_url:null}}async componentDidMount(){const e=ee.a.get(),t=e.getUserId(),s=await e.getProfileInfo(t),n=pt.c({avatarUrl:s.avatar_url},32,32,"crop");this.setState({userId:t,displayname:s.displayname,avatar_url:n})}fakeEvent({userId:e,displayname:t,avatar_url:s}){const n={type:"m.room.message",sender:e,content:{"m.new_content":{msgtype:"m.text",body:this.props.message,displayname:t,avatar_url:s},msgtype:"m.text",body:this.props.message,displayname:t,avatar_url:s},unsigned:{age:97},event_id:"$9999999999999999999999999999999999999999999",room_id:"!999999999999999999:example.org"},a=new ut.b(n);return a.sender={name:t,userId:e,getAvatarUrl:(...e)=>s},a}render(){const e=this.fakeEvent(this.state),t=L()(this.props.className,{mx_IRCLayout:this.props.useIRCLayout,mx_GroupLayout:!this.props.useIRCLayout});return i.a.createElement("div",{className:t},i.a.createElement(gt.a,{mxEvent:e,useIRCLayout:this.props.useIRCLayout,enableFlair:F.a.getValue(Xe.a.Flair)}))}}var bt=function({name:e,definitions:t,value:s,className:n,outlined:a,onChange:o}){const r=e=>{o(e.target.value)};return i.a.createElement(i.a.Fragment,null,t.map(t=>i.a.createElement(i.a.Fragment,{key:t.value},i.a.createElement(dt.a,{className:L()(n,t.className),onChange:r,checked:void 0!==t.checked?t.checked:t.value===s,name:e,value:t.value,disabled:t.disabled,outlined:a},t.label),t.description)))};function vt(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function _t(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?vt(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):vt(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class yt extends i.a.Component{constructor(e){super(e),I()(this,"MESSAGE_PREVIEW_TEXT",Object(l.a)("Hey you. You're the best!")),I()(this,"themeTimer",void 0),I()(this,"onThemeChange",e=>{if(this.state.theme===e)return;const t=F.a.getValue("theme");F.a.setValue("theme",null,Qe.a.DEVICE,e).catch(()=>{m.a.dispatch({action:h.a.RecheckTheme}),this.setState({theme:t})}),this.setState({theme:e}),m.a.dispatch({action:h.a.RecheckTheme,forceTheme:e})}),I()(this,"onUseSystemThemeChanged",e=>{this.setState({useSystemTheme:e}),F.a.setValue("use_system_theme",null,Qe.a.DEVICE,e),m.a.dispatch({action:h.a.RecheckTheme})}),I()(this,"onFontSizeChanged",e=>{this.setState({fontSize:e.toString()}),F.a.setValue("baseFontSize",null,Qe.a.DEVICE,e-ct.SIZE_DIFF)}),I()(this,"onValidateFontSize",async({value:e})=>{const t=parseFloat(e),s=ct.MIN_SIZE+ct.SIZE_DIFF,n=ct.MAX_SIZE+ct.SIZE_DIFF;return isNaN(t)?{valid:!1,feedback:Object(l.a)("Size must be a number")}:s<=t&&t<=n?(F.a.setValue("baseFontSize",null,Qe.a.DEVICE,parseInt(e,10)-ct.SIZE_DIFF),{valid:!0,feedback:Object(l.a)("Use between %(min)s pt and %(max)s pt",{min:s,max:n})}):{valid:!1,feedback:Object(l.a)("Custom font size can only be between %(min)s pt and %(max)s pt",{min:s,max:n})}}),I()(this,"onAddCustomTheme",async()=>{let e=F.a.getValue("custom_themes");e||(e=[]),e=e.map(e=>e),this.themeTimer&&clearTimeout(this.themeTimer);try{const t=await fetch(this.state.customThemeUrl),s=await t.json();if(!s||"string"!=typeof s.name||"object"!=typeof s.colors)return void this.setState({customThemeMessage:{text:Object(l.a)("Invalid theme schema."),isError:!0}});e.push(s)}catch(e){return console.error(e),void this.setState({customThemeMessage:{text:Object(l.a)("Error downloading theme information."),isError:!0}})}await F.a.setValue("custom_themes",null,Qe.a.ACCOUNT,e),this.setState({customThemeUrl:"",customThemeMessage:{text:Object(l.a)("Theme added!"),isError:!1}}),this.themeTimer=setTimeout(()=>{this.setState({customThemeMessage:{text:"",isError:!1}})},3e3)}),I()(this,"onCustomThemeChange",e=>{this.setState({customThemeUrl:e.target.value})}),I()(this,"onLayoutChange",e=>{const t="true"===e.target.value;this.setState({useIRCLayout:t}),F.a.setValue("useIRCLayout",null,Qe.a.DEVICE,t)}),I()(this,"renderLayoutSection",()=>i.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Layout"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Message layout")),i.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_Layout_RadioButtons"},i.a.createElement("div",{className:L()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:this.state.useIRCLayout})},i.a.createElement(ft,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,useIRCLayout:!0}),i.a.createElement(dt.a,{name:"layout",value:"true",checked:this.state.useIRCLayout,onChange:this.onLayoutChange},Object(l.a)("Compact"))),i.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_spacer"}),i.a.createElement("div",{className:L()("mx_AppearanceUserSettingsTab_Layout_RadioButton",{mx_AppearanceUserSettingsTab_Layout_RadioButton_selected:!this.state.useIRCLayout})},i.a.createElement(ft,{className:"mx_AppearanceUserSettingsTab_Layout_RadioButton_preview",message:this.MESSAGE_PREVIEW_TEXT,useIRCLayout:!1}),i.a.createElement(dt.a,{name:"layout",value:"false",checked:!this.state.useIRCLayout,onChange:this.onLayoutChange},Object(l.a)("Modern")))))),this.state=_t(_t({fontSize:(F.a.getValue("baseFontSize",null)+ct.SIZE_DIFF).toString()},this.calculateThemeState()),{},{customThemeUrl:"",customThemeMessage:{isError:!1,text:""},useCustomFontSize:F.a.getValue("useCustomFontSize"),useSystemFont:F.a.getValue("useSystemFont"),systemFont:F.a.getValue("systemFont"),showAdvanced:!1,useIRCLayout:F.a.getValue("useIRCLayout")})}calculateThemeState(){const e=F.a.getValue("theme"),t=F.a.getValueAt(Qe.a.DEVICE,"use_system_theme",null,!1,!0),s=F.a.getValueAt(Qe.a.DEVICE,"theme",null,!1,!0);return t?{theme:e,useSystemTheme:!0}:s?{theme:e,useSystemTheme:!1}:{theme:e,useSystemTheme:F.a.getValueAt(Qe.a.DEVICE,"use_system_theme")}}renderThemeSection(){let e,t;if((new it.a).isSystemThemeSupported()&&(e=i.a.createElement("div",null,i.a.createElement(He.a,{checked:this.state.useSystemTheme,onChange:e=>this.onUseSystemThemeChanged(e.target.checked)},F.a.getDisplayName("use_system_theme")))),F.a.getValue("feature_custom_themes")){let e=null;this.state.customThemeMessage.text&&(e=this.state.customThemeMessage.isError?i.a.createElement("div",{className:"text-error"},this.state.customThemeMessage.text):i.a.createElement("div",{className:"text-success"},this.state.customThemeMessage.text)),t=i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("form",{onSubmit:this.onAddCustomTheme},i.a.createElement(ke.a,{label:Object(l.a)("Custom theme URL"),type:"text",id:"mx_GeneralUserSettingsTab_customThemeInput",autoComplete:"off",onChange:this.onCustomThemeChange,value:this.state.customThemeUrl}),i.a.createElement(pe.a,{onClick:this.onAddCustomTheme,type:"submit",kind:"primary_sm",disabled:!this.state.customThemeUrl.trim()},Object(l.a)("Add theme")),e))}const s=Object.entries(Object(at.b)()).map(e=>({id:e[0],name:e[1]})),n=s.filter(e=>!e.id.startsWith("custom-")),a=s.filter(e=>!n.includes(e)).sort((e,t)=>e.name.localeCompare(t.name)),o=[...n,...a];return i.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_themeSection"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Theme")),e,i.a.createElement("div",{className:"mx_ThemeSelectors"},i.a.createElement(bt,{name:"theme",definitions:o.map(e=>({value:e.id,label:e.name,disabled:this.state.useSystemTheme,className:"mx_ThemeSelector_"+e.id})),onChange:this.onThemeChange,value:this.state.useSystemTheme?void 0:this.state.theme,outlined:!0})),t)}renderFontSection(){return i.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_fontScaling"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Font size")),i.a.createElement(ft,{className:"mx_AppearanceUserSettingsTab_fontSlider_preview",message:this.MESSAGE_PREVIEW_TEXT,useIRCLayout:this.state.useIRCLayout}),i.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider"},i.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider_smallText"},"Aa"),i.a.createElement(ot,{values:[13,14,15,16,18],value:parseInt(this.state.fontSize,10),onSelectionChange:this.onFontSizeChanged,displayFunc:e=>"",disabled:this.state.useCustomFontSize}),i.a.createElement("div",{className:"mx_AppearanceUserSettingsTab_fontSlider_largeText"},"Aa")))}renderAdvancedSection(){if(!F.a.getValue(Xe.a.AdvancedSettings))return null;c.a.get().brand,this.state.showAdvanced?Object(l.a)("Hide advanced"):Object(l.a)("Show advanced");let e;return e=i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Advanced")),i.a.createElement(ht,{name:"useCompactLayout",level:Qe.a.DEVICE,useCheckbox:!0,disabled:this.state.useIRCLayout}),i.a.createElement(ht,{name:"useIRCLayout",level:Qe.a.DEVICE,useCheckbox:!0,onChange:e=>this.setState({useIRCLayout:e})})),i.a.createElement("div",{className:"mx_SettingsTab_section mx_AppearanceUserSettingsTab_Advanced"},e)}render(){const e=c.a.get().brand;return i.a.createElement("div",{className:"mx_SettingsTab mx_AppearanceUserSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Customise your appearance")),i.a.createElement("div",{className:"mx_SettingsTab_SubHeading"},Object(l.a)("Appearance Settings only affect this %(brand)s session.",{brand:e})),this.renderFontSection(),this.renderAdvancedSection())}}var Et=s(134),Ct=s(151),wt=s(283),St=s(142),xt=s(251),Rt=s(175);class Ot extends i.a.PureComponent{constructor(e){super(e),I()(this,"_onKeyBackupSessionsRemaining",e=>{this.setState({sessionsRemaining:e})}),I()(this,"_onKeyBackupStatus",()=>{this._loadBackupStatus()}),I()(this,"_startNewBackup",()=>{De.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(4).then(s.bind(null,1488)),{onFinished:()=>{this._loadBackupStatus()}},null,!1,!0)}),I()(this,"_deleteBackup",()=>{De.a.createTrackedDialog("Delete Backup","",St.a,{title:Object(l.a)("Delete Backup"),description:Object(l.a)("Are you sure? You will lose your encrypted messages if your keys are not backed up properly."),button:Object(l.a)("Delete Backup"),danger:!0,onFinished:e=>{e&&(this.setState({loading:!0}),ee.a.get().deleteKeyBackupVersion(this.state.backupInfo.version).then(()=>{this._loadBackupStatus()}))}})}),I()(this,"_restoreBackup",async()=>{De.a.createTrackedDialog("Restore Backup","",xt.a,null,null,!1,!0)}),I()(this,"_resetSecretStorage",async()=>{this.setState({error:null});try{await Object(Rt.b)(()=>{},!0)}catch(e){if(console.error("Error resetting secret storage",e),this._unmounted)return;this.setState({error:e})}this._unmounted||this._loadBackupStatus()}),this._unmounted=!1,this.state={loading:!0,error:null,backupKeyStored:null,backupKeyCached:null,backupKeyWellFormed:null,secretStorageKeyInAccount:null,secretStorageReady:null,backupInfo:null,backupSigStatus:null,sessionsRemaining:0}}componentDidMount(){this._checkKeyBackupStatus(),ee.a.get().on("crypto.keyBackupStatus",this._onKeyBackupStatus),ee.a.get().on("crypto.keyBackupSessionsRemaining",this._onKeyBackupSessionsRemaining)}componentWillUnmount(){this._unmounted=!0,ee.a.get()&&(ee.a.get().removeListener("crypto.keyBackupStatus",this._onKeyBackupStatus),ee.a.get().removeListener("crypto.keyBackupSessionsRemaining",this._onKeyBackupSessionsRemaining))}async _checkKeyBackupStatus(){this._getUpdatedDiagnostics();try{const{backupInfo:e,trustInfo:t}=await ee.a.get().checkKeyBackup();this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(console.log("Unable to fetch check backup status",e),this._unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async _loadBackupStatus(){this.setState({loading:!0}),this._getUpdatedDiagnostics();try{const e=await ee.a.get().getKeyBackupVersion(),t=await ee.a.get().isKeyBackupTrusted(e);if(this._unmounted)return;this.setState({loading:!1,error:null,backupInfo:e,backupSigStatus:t})}catch(e){if(console.log("Unable to fetch key backup status",e),this._unmounted)return;this.setState({loading:!1,error:e,backupInfo:null,backupSigStatus:null})}}async _getUpdatedDiagnostics(){const e=ee.a.get(),t=e._crypto._secretStorage,s=!!await e.isKeyBackupKeyStored(),n=await e._crypto.getSessionBackupPrivateKey(),a=!!n,i=n instanceof Uint8Array,o=await t.hasKey(),r=await e.isSecretStorageReady();this._unmounted||this.setState({backupKeyStored:s,backupKeyCached:a,backupKeyWellFormed:i,secretStorageKeyInAccount:o,secretStorageReady:r})}render(){const{loading:e,error:t,backupKeyStored:s,backupKeyCached:n,backupKeyWellFormed:a,secretStorageKeyInAccount:o,secretStorageReady:r,backupInfo:c,backupSigStatus:d,sessionsRemaining:m}=this.state;let h,u,p;const g=[];if(t)h=i.a.createElement("div",{className:"error"},Object(l.a)("Unable to load key backup status"));else if(e)h=i.a.createElement(Je.a,null);else if(c){let e,t=Object(l.a)("Restore from Backup");ee.a.get().getKeyBackupEnabled()?h=i.a.createElement("p",null,"✅ ",Object(l.a)("This session is backing up your keys. ")):(h=i.a.createElement(i.a.Fragment,null,i.a.createElement("p",null,Object(l.a)("This session is <b>not backing up your keys</b>, but you do have an existing backup you can restore from and add to going forward.",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("p",null,Object(l.a)("Connect this session to key backup before signing out to avoid losing any keys that may only be on this session."))),t=Object(l.a)("Connect this session to Key Backup")),e=ee.a.get().getKeyBackupEnabled()?m>0?i.a.createElement("div",null,Object(l.a)("Backing up %(sessionsRemaining)s keys...",{sessionsRemaining:m})," ",i.a.createElement("br",null)):i.a.createElement("div",null,Object(l.a)("All keys backed up")," ",i.a.createElement("br",null)):"";let s,n=d.sigs.map((e,t)=>{const s=e.device?e.device.getDisplayName()||e.device.deviceId:null,n=t=>i.a.createElement("span",{className:e.valid?"mx_SecureBackupPanel_sigValid":"mx_SecureBackupPanel_sigInvalid"},t),a=t=>i.a.createElement("span",{className:e.device&&e.deviceTrust.isVerified()?"mx_SecureBackupPanel_deviceVerified":"mx_SecureBackupPanel_deviceNotVerified"},t),o=e=>i.a.createElement("span",{className:"mx_SecureBackupPanel_deviceName"},s),r=e.device&&e.device.getFingerprint()===ee.a.get().getDeviceEd25519Key(),c=e.crossSigningId&&e.deviceId===ee.a.get().getCrossSigningId();let d;return e.valid&&c?d=Object(l.a)("Backup has a <validity>valid</validity> signature from this user",{},{validity:n}):!e.valid&&c?d=Object(l.a)("Backup has a <validity>invalid</validity> signature from this user",{},{validity:n}):e.crossSigningId?d=Object(l.a)("Backup has a signature from <verify>unknown</verify> user with ID %(deviceId)s",{deviceId:e.deviceId},{verify:a}):e.device?e.valid&&r?d=Object(l.a)("Backup has a <validity>valid</validity> signature from this session",{},{validity:n}):!e.valid&&r?d=Object(l.a)("Backup has an <validity>invalid</validity> signature from this session",{},{validity:n}):e.valid&&e.deviceTrust.isVerified()?d=Object(l.a)("Backup has a <validity>valid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:a,device:o}):e.valid&&!e.deviceTrust.isVerified()?d=Object(l.a)("Backup has a <validity>valid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:a,device:o}):!e.valid&&e.deviceTrust.isVerified()?d=Object(l.a)("Backup has an <validity>invalid</validity> signature from <verify>verified</verify> session <device></device>",{},{validity:n,verify:a,device:o}):e.valid||e.deviceTrust.isVerified()||(d=Object(l.a)("Backup has an <validity>invalid</validity> signature from <verify>unverified</verify> session <device></device>",{},{validity:n,verify:a,device:o})):d=Object(l.a)("Backup has a signature from <verify>unknown</verify> session with ID %(deviceId)s",{deviceId:e.deviceId},{verify:a}),i.a.createElement("div",{key:t},d)});0===d.sigs.length&&(n=Object(l.a)("Backup is not signed by any of your sessions")),d.trusted_locally&&(s=Object(l.a)("This backup is trusted because it has been restored on this session")),u=i.a.createElement(i.a.Fragment,null,i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Backup version:")),i.a.createElement("td",null,c.version)),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Algorithm:")),i.a.createElement("td",null,c.algorithm))),p=i.a.createElement(i.a.Fragment,null,e,i.a.createElement("div",null,n),i.a.createElement("div",null,s)),g.push(i.a.createElement(pe.a,{key:"restore",kind:"primary",onClick:this._restoreBackup},t)),Object(wt.d)()||g.push(i.a.createElement(pe.a,{key:"delete",kind:"danger",onClick:this._deleteBackup},Object(l.a)("Delete Backup")))}else h=i.a.createElement(i.a.Fragment,null,i.a.createElement("p",null,Object(l.a)("Your keys are <b>not being backed up from this session</b>.",{},{b:e=>i.a.createElement("b",null,e)})),i.a.createElement("p",null,Object(l.a)("Back up your keys before signing out to avoid losing them."))),g.push(i.a.createElement(pe.a,{key:"setup",kind:"primary",onClick:this._startNewBackup},Object(l.a)("Set up")));o&&g.push(i.a.createElement(pe.a,{key:"reset",kind:"danger",onClick:this._resetSecretStorage},Object(l.a)("Reset")));let f,b="";return n&&(b=", ",b+=a?Object(l.a)("well formed"):Object(l.a)("unexpected type")),g.length&&(f=i.a.createElement("div",{className:"mx_SecureBackupPanel_buttonRow"},g)),i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Back up your encryption keys with your account data in case you lose access to your sessions. Your keys will be secured with a unique Security Key.")),h,i.a.createElement("details",null,i.a.createElement("summary",null,Object(l.a)("Advanced")),i.a.createElement("table",{className:"mx_SecureBackupPanel_statusList"},i.a.createElement("tbody",null,i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Backup key stored:")),i.a.createElement("td",null,!0===s?Object(l.a)("in secret storage"):Object(l.a)("not stored"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Backup key cached:")),i.a.createElement("td",null,n?Object(l.a)("cached locally"):Object(l.a)("not found locally"),b)),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Secret storage public key:")),i.a.createElement("td",null,o?Object(l.a)("in account data"):Object(l.a)("not found"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Secret storage:")),i.a.createElement("td",null,r?Object(l.a)("ready"):Object(l.a)("not ready"))),u)),p),f)}}var kt=e=>{const t=d.getComponent("views.elements.SettingsFlag");return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Encryption")),i.a.createElement(t,{name:"e2ee.manuallyVerifyAllSessions",level:Qe.a.DEVICE}),i.a.createElement("div",{className:"mx_E2eAdvancedPanel_settingLongDescription"},Object(l.a)("Individually verify each session used by a user to mark it as trusted, not trusting cross-signed devices.")))};class It extends i.a.Component{constructor(...e){super(...e),I()(this,"_onUnignoreClicked",e=>{this.props.onUnignored(this.props.userId)})}render(){const e="mx_SecurityUserSettingsTab_ignoredUser_"+this.props.userId;return i.a.createElement("div",{className:"mx_SecurityUserSettingsTab_ignoredUser"},i.a.createElement(pe.a,{onClick:this._onUnignoreClicked,kind:"primary_sm","aria-describedby":e,disabled:this.props.inProgress},Object(l.a)("Unignore")),i.a.createElement("span",{id:e},this.props.userId))}}I()(It,"propTypes",{userId:xe.a.string.isRequired,onUnignored:xe.a.func.isRequired,inProgress:xe.a.bool.isRequired});class Tt extends i.a.Component{constructor(){super(),I()(this,"_updateBlacklistDevicesFlag",e=>{ee.a.get().setGlobalBlacklistUnverifiedDevices(e)}),I()(this,"_updateAnalytics",e=>{e?_.a.enable():_.a.disable(),y.a.instance.enable(!e)}),I()(this,"_onExportE2eKeysClicked",()=>{De.a.createTrackedDialogAsync("Export E2E Keys","",s.e(3).then(s.bind(null,1506)),{matrixClient:ee.a.get()})}),I()(this,"_onImportE2eKeysClicked",()=>{De.a.createTrackedDialogAsync("Import E2E Keys","",s.e(20).then(s.bind(null,1507)),{matrixClient:ee.a.get()})}),I()(this,"_onGoToUserProfileClick",()=>{m.a.dispatch({action:"view_user_info",userId:ee.a.get().getUserId()}),this.props.closeSettingsFn()}),I()(this,"_onUserUnignored",async e=>{const{ignoredUserIds:t,waitingUnignored:s}=this.state,n=t.filter(e=>!s.includes(e)),a=n.indexOf(e);-1!==a&&(n.splice(a,1),this.setState(({waitingUnignored:t})=>({waitingUnignored:[...t,e]})),ee.a.get().setIgnoredUsers(n))}),I()(this,"_getInvitedRooms",()=>ee.a.get().getRooms().filter(e=>e.hasMembershipState(ee.a.get().getUserId(),"invite"))),I()(this,"_manageInvites",async e=>{this.setState({managingInvites:!0});const t=this._getInvitedRooms().map(e=>e.roomId),s=this,n=ee.a.get(),a=e?n.joinRoom.bind(n):n.leave.bind(n);for(let e=0;e<t.length;e++){const n=t[e];await a(n).then(()=>{this.setState({invitedRoomAmt:s.state.invitedRoomAmt-1})},async t=>{"M_LIMIT_EXCEEDED"===t.errcode?(await Object(Et.d)(t.retry_after_ms||2500),e--):console.warn(t)})}this.setState({managingInvites:!1})}),I()(this,"_onAcceptAllInvitesClicked",e=>{this._manageInvites(!0)}),I()(this,"_onRejectAllInvitesClicked",e=>{this._manageInvites(!1)});const e=this._getInvitedRooms();this.state={ignoredUserIds:ee.a.get().getIgnoredUsers(),waitingUnignored:[],managingInvites:!1,invitedRoomAmt:e.length},this._onAction=this._onAction.bind(this)}_onAction({action:e}){if("ignore_state_changed"===e){const e=ee.a.get().getIgnoredUsers(),t=this.state.waitingUnignored.filter(t=>e.includes(t));this.setState({ignoredUserIds:e,waitingUnignored:t})}}componentDidMount(){this.dispatcherRef=m.a.register(this._onAction)}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}_renderCurrentDeviceInfo(){const e=d.getComponent("views.elements.SettingsFlag"),t=ee.a.get(),s=t.deviceId;let n=t.getDeviceEd25519Key();n=n?q.e(n):Object(l.a)("<not supported>");let a,o=null;return t.isCryptoEnabled()&&(o=i.a.createElement("div",{className:"mx_SecurityUserSettingsTab_importExportButtons"},i.a.createElement(pe.a,{kind:"primary",onClick:this._onExportE2eKeysClicked},Object(l.a)("Export E2E keys")),i.a.createElement(pe.a,{kind:"primary",onClick:this._onImportE2eKeysClicked},Object(l.a)("Import E2E keys")))),F.a.isEnabled("blacklistUnverifiedDevices")&&(a=i.a.createElement(e,{name:"blacklistUnverifiedDevices",level:Qe.a.DEVICE,onChange:this._updateBlacklistDevicesFlag})),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Cryptography")),i.a.createElement("ul",{className:"mx_SettingsTab_subsectionText mx_SecurityUserSettingsTab_deviceInfo"},i.a.createElement("li",null,i.a.createElement("label",null,Object(l.a)("Session ID:")),i.a.createElement("span",null,i.a.createElement("code",null,s))),i.a.createElement("li",null,i.a.createElement("label",null,Object(l.a)("Session key:")),i.a.createElement("span",null,i.a.createElement("code",null,i.a.createElement("b",null,n))))),o)}_renderIgnoredUsers(){const{waitingUnignored:e,ignoredUserIds:t}=this.state;if(!t||0===t.length)return null;const s=t.map(t=>i.a.createElement(It,{userId:t,onUnignored:this._onUserUnignored,key:t,inProgress:e.includes(t)}));return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Ignored users")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},s))}_renderManageInvites(){if(0===this.state.invitedRoomAmt)return null;const e=this._getInvitedRooms(),t=d.getComponent("elements.InlineSpinner"),s=this._onAcceptAllInvitesClicked.bind(this,e),n=this._onRejectAllInvitesClicked.bind(this,e);return i.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityUserSettingsTab_bulkOptions"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Bulk options")),i.a.createElement(pe.a,{onClick:s,kind:"primary",disabled:this.state.managingInvites},Object(l.a)("Accept all %(invitedRooms)s invites",{invitedRooms:this.state.invitedRoomAmt})),i.a.createElement(pe.a,{onClick:n,kind:"danger",disabled:this.state.managingInvites},Object(l.a)("Reject all %(invitedRooms)s invites",{invitedRooms:this.state.invitedRoomAmt})),this.state.managingInvites?i.a.createElement(t,null):i.a.createElement("div",null))}render(){const e=c.a.get().brand,t=d.getComponent("views.settings.DevicesPanel"),s=d.getComponent("views.elements.SettingsFlag"),n=d.getComponent("views.settings.EventIndexPanel"),a=(Object(l.a)("Secure Backup"),Object(l.a)("Message search"),d.getComponent("views.settings.CrossSigningPanel"));Object(l.a)("Cross-signing");let o,r;Object(Ct.e)()||(o=i.a.createElement("div",{className:"mx_SecurityUserSettingsTab_warning"},Object(l.a)("Your server admin has disabled end-to-end encryption by default in private rooms & Direct Messages."))),(_.a.canEnable()||y.a.instance.canEnable())&&(r=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Privacy")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Analytics")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("%(brand)s collects anonymous analytics to allow us to improve the application.",{brand:e})," ",Object(l.a)("Privacy is important to us, so we don't collect any personal or identifiable data for our analytics."),i.a.createElement(pe.a,{className:"mx_SettingsTab_linkBtn",onClick:_.a.showDetailsModal},Object(l.a)("Learn more about how we use analytics."))),i.a.createElement(s,{name:"analyticsOptIn",level:Qe.a.DEVICE,onChange:this._updateAnalytics}))));const m=d.getComponent("views.settings.E2eAdvancedPanel");let h;if(F.a.getValue(Xe.a.AdvancedSettings)){const e=this._renderIgnoredUsers(),t=this._renderManageInvites(),s=F.a.isEnabled("e2ee.manuallyVerifyAllSessions")?i.a.createElement(m,null):null;(e||t||s)&&(h=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Advanced")),i.a.createElement("div",{className:"mx_SettingsTab_section"},e,t)))}return i.a.createElement("div",{className:"mx_SettingsTab mx_SecurityUserSettingsTab"},o,i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Encryption")),i.a.createElement("div",{className:"mx_SettingsTab_section"},this._renderCurrentDeviceInfo()),i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Where you’re logged in")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",null,Object(l.a)("Manage the names of and sign out of your sessions below.")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("A session's public name is visible to people you communicate with"),i.a.createElement(t,null))))}}I()(Tt,"propTypes",{closeSettingsFn:xe.a.func.isRequired});class jt extends i.a.Component{constructor(){super()}render(){const e=d.getComponent("views.settings.Notifications");return i.a.createElement("div",{className:"mx_SettingsTab mx_NotificationUserSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Notifications")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement(e,null)))}}class Nt extends i.a.Component{constructor(){super(),I()(this,"_onAutoLaunchChange",e=>{qe.a.get().setAutoLaunchEnabled(e).then(()=>this.setState({autoLaunch:e}))}),I()(this,"_onAlwaysShowMenuBarChange",e=>{qe.a.get().setAutoHideMenuBarEnabled(!e).then(()=>this.setState({alwaysShowMenuBar:e}))}),I()(this,"_onMinimizeToTrayChange",e=>{qe.a.get().setMinimizeToTrayEnabled(e).then(()=>this.setState({minimizeToTray:e}))}),I()(this,"_onAutocompleteDelayChange",e=>{this.setState({autocompleteDelay:e.target.value}),F.a.setValue("autocompleteDelay",null,Qe.a.DEVICE,e.target.value)}),I()(this,"_onReadMarkerInViewThresholdMs",e=>{this.setState({readMarkerInViewThresholdMs:e.target.value}),F.a.setValue("readMarkerInViewThresholdMs",null,Qe.a.DEVICE,e.target.value)}),I()(this,"_onReadMarkerOutOfViewThresholdMs",e=>{this.setState({readMarkerOutOfViewThresholdMs:e.target.value}),F.a.setValue("readMarkerOutOfViewThresholdMs",null,Qe.a.DEVICE,e.target.value)}),this.state={autoLaunch:!1,autoLaunchSupported:!1,alwaysShowMenuBar:!0,alwaysShowMenuBarSupported:!1,minimizeToTray:!0,minimizeToTraySupported:!1,autocompleteDelay:F.a.getValueAt(Qe.a.DEVICE,"autocompleteDelay").toString(10),readMarkerInViewThresholdMs:F.a.getValueAt(Qe.a.DEVICE,"readMarkerInViewThresholdMs").toString(10),readMarkerOutOfViewThresholdMs:F.a.getValueAt(Qe.a.DEVICE,"readMarkerOutOfViewThresholdMs").toString(10)}}async componentDidMount(){const e=qe.a.get(),t=await e.supportsAutoLaunch();let s=!1;t&&(s=await e.getAutoLaunchEnabled());const n=await e.supportsAutoHideMenuBar();let a=!0;n&&(a=!await e.getAutoHideMenuBarEnabled());const i=await e.supportsMinimizeToTray();let o=!0;i&&(o=await e.getMinimizeToTrayEnabled()),this.setState({autoLaunch:s,autoLaunchSupported:t,alwaysShowMenuBarSupported:n,alwaysShowMenuBar:a,minimizeToTraySupported:i,minimizeToTray:o})}_renderGroup(e){const t=d.getComponent("views.elements.SettingsFlag");return e.filter(F.a.isEnabled).map(e=>i.a.createElement(t,{key:e,name:e,level:Qe.a.ACCOUNT}))}render(){let e=null;this.state.autoLaunchSupported&&(e=i.a.createElement(Ze.a,{value:this.state.autoLaunch,onChange:this._onAutoLaunchChange,label:Object(l.a)("Start automatically after system login")}));let t=null;this.state.alwaysShowMenuBarSupported&&(t=i.a.createElement(Ze.a,{value:this.state.alwaysShowMenuBar,onChange:this._onAlwaysShowMenuBarChange,label:Object(l.a)("Always show the window menu bar")}));let s=null;return this.state.minimizeToTraySupported&&(s=i.a.createElement(Ze.a,{value:this.state.minimizeToTray,onChange:this._onMinimizeToTrayChange,label:Object(l.a)("Show tray icon and minimize window to it on close")})),i.a.createElement("div",{className:"mx_SettingsTab mx_PreferencesUserSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Preferences")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Composer")),this._renderGroup(Nt.COMPOSER_SETTINGS)),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Timeline")),this._renderGroup(Nt.TIMELINE_SETTINGS)))}}I()(Nt,"ROOM_LIST_SETTINGS",["breadcrumbs"]),I()(Nt,"COMPOSER_SETTINGS",["MessageComposerInput.autoReplaceEmoji","MessageComposerInput.suggestEmoji","sendTypingNotifications","MessageComposerInput.ctrlEnterToSend"]),I()(Nt,"TIMELINE_SETTINGS",["showTypingNotifications","autoplayGifsAndVideos","urlPreviewsEnabled","TextualBody.enableBigEmoji","showReadReceipts","showTwelveHourTimestamps","alwaysShowTimestamps","showRedactions","enableSyntaxHighlightLanguageDetection","expandCodeByDefault","showCodeLineNumbers","showJoinLeaves","showAvatarChanges","showDisplaynameChanges","showImages","showChatEffects","Pill.shouldShowPillAvatar","ctrlFForSearch"]),I()(Nt,"GENERAL_SETTINGS",["TagPanel.enableTagPanel","promptBeforeInviteUnknownUsers"]);var Pt=async function(){return(await navigator.mediaDevices.enumerateDevices()).some(e=>!!e.label)},Dt=function(){return navigator.mediaDevices.enumerateDevices().then((function(e){const t=[],s=[],n=[];return e.forEach(e=>{switch(e.kind){case"audiooutput":t.push(e);break;case"audioinput":s.push(e);break;case"videoinput":n.push(e)}}),{audiooutput:t,audioinput:s,videoinput:n}}),e=>{console.log("Unable to refresh WebRTC Devices: ",e)})},At=function(){const e=F.a.getValue("webrtc_audiooutput"),t=F.a.getValue("webrtc_audioinput"),s=F.a.getValue("webrtc_videoinput");Fe.setMatrixCallAudioOutput(e),Fe.r(t),Fe.t(s)},Ut=function(e){F.a.setValue("webrtc_audiooutput",null,Qe.a.DEVICE,e),Fe.setMatrixCallAudioOutput(e)},Mt=function(e){F.a.setValue("webrtc_audioinput",null,Qe.a.DEVICE,e),Fe.r(e)},Lt=function(e){F.a.setValue("webrtc_videoinput",null,Qe.a.DEVICE,e),Fe.t(e)},Ft=function(){return F.a.getValueAt(Qe.a.DEVICE,"webrtc_audiooutput")},Bt=function(){return F.a.getValueAt(Qe.a.DEVICE,"webrtc_audioinput")},Vt=function(){return F.a.getValueAt(Qe.a.DEVICE,"webrtc_videoinput")};class Wt extends i.a.Component{constructor(){super(),I()(this,"_refreshMediaDevices",async e=>{this.setState({mediaDevices:await Dt(),activeAudioOutput:Ft(),activeAudioInput:Bt(),activeVideoInput:Vt()}),e&&e.getTracks().forEach(e=>e.stop())}),I()(this,"_requestMediaPermissions",async()=>{let e,t,s;try{e={video:!0,audio:!0},t=await navigator.mediaDevices.getUserMedia(e)}catch(n){if("NotFoundError"===n.name){e={audio:!0};try{t=await navigator.mediaDevices.getUserMedia(e)}catch(e){s=e}}else s=n}if(s){const e=c.a.get().brand,t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("No media permissions","",t,{title:Object(l.a)("No media permissions"),description:Object(l.a)("You may need to manually permit %(brand)s to access your microphone/webcam",{brand:e})})}else this._refreshMediaDevices(t)}),I()(this,"_setAudioOutput",e=>{Ut(e.target.value),this.setState({activeAudioOutput:e.target.value})}),I()(this,"_setAudioInput",e=>{Mt(e.target.value),this.setState({activeAudioInput:e.target.value})}),I()(this,"_setVideoInput",e=>{Lt(e.target.value),this.setState({activeVideoInput:e.target.value})}),I()(this,"_changeWebRtcMethod",e=>{ee.a.get().setForceTURN(!e)}),I()(this,"_changeFallbackICEServerAllowed",e=>{ee.a.get().setFallbackICEServerAllowed(e)}),this.state={mediaDevices:!1,activeAudioOutput:null,activeAudioInput:null,activeVideoInput:null}}async componentDidMount(){await Pt()&&this._refreshMediaDevices()}_renderDeviceOptions(e,t){return e.map(e=>i.a.createElement("option",{key:`${t}-${e.deviceId}`,value:e.deviceId},e.label))}render(){const e=d.getComponent("views.elements.SettingsFlag");let t=null,s=null,n=null,a=null;if(!1===this.state.mediaDevices)t=i.a.createElement("div",{className:"mx_VoiceUserSettingsTab_missingMediaPermissions"},i.a.createElement("p",null,Object(l.a)("Missing media permissions, click the button below to request.")),i.a.createElement(pe.a,{onClick:this._requestMediaPermissions,kind:"primary"},Object(l.a)("Request media permissions")));else if(this.state.mediaDevices){s=i.a.createElement("p",null,Object(l.a)("No Audio Outputs detected")),n=i.a.createElement("p",null,Object(l.a)("No Microphones detected")),a=i.a.createElement("p",null,Object(l.a)("No Webcams detected"));const e={deviceId:"",label:Object(l.a)("Default Device")},t=t=>t.some(e=>"default"===e.deviceId)?"default":(t.unshift(e),""),o=this.state.mediaDevices.audiooutput.slice(0);if(o.length>0){const e=t(o);s=i.a.createElement(ke.a,{element:"select",label:Object(l.a)("Audio Output"),value:this.state.activeAudioOutput||e,onChange:this._setAudioOutput},this._renderDeviceOptions(o,"audioOutput"))}const r=this.state.mediaDevices.audioinput.slice(0);if(r.length>0){const e=t(r);n=i.a.createElement(ke.a,{element:"select",label:Object(l.a)("Microphone"),value:this.state.activeAudioInput||e,onChange:this._setAudioInput},this._renderDeviceOptions(r,"audioInput"))}const c=this.state.mediaDevices.videoinput.slice(0);if(c.length>0){const e=t(c);a=i.a.createElement(ke.a,{element:"select",label:Object(l.a)("Camera"),value:this.state.activeVideoInput||e,onChange:this._setVideoInput},this._renderDeviceOptions(c,"videoInput"))}}return i.a.createElement("div",{className:"mx_SettingsTab mx_VoiceUserSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Voice & Video")),i.a.createElement("div",{className:"mx_SettingsTab_section"},t,s,n,a,i.a.createElement(e,{name:"VideoView.flipVideoHorizontally",level:Qe.a.ACCOUNT})))}}var Ht=s(459),Gt=s(252);var qt=s(216);function Kt(){qe.a.get().installUpdate()}const zt=[Gt.d.Ready,Gt.d.Error,Gt.d.NotAvailable];var $t=()=>{const[e,t]=Object(a.useState)(null);((e,t)=>{const s=Object(a.useRef)(e=>{});Object(a.useEffect)(()=>{s.current=t},[t]),Object(a.useEffect)(()=>{const t=e.register(e=>s.current(e));return()=>{e.unregister(t)}},[e])})(m.a,e=>{let{action:s}=e,n=ae()(e,["action"]);s===h.a.CheckUpdates&&t(n)});const s=e&&!zt.includes(e.status);let n;return e&&(n=i.a.createElement("span",{className:"mx_UpdateCheckButton_summary"},function(e,t){switch(e){case Gt.d.Error:return Object(l.a)("Error encountered (%(errorDetail)s).",{errorDetail:t});case Gt.d.Checking:return Object(l.a)("Checking for an update...");case Gt.d.NotAvailable:return Object(l.a)("No update available.");case Gt.d.Downloading:return Object(l.a)("Downloading update...");case Gt.d.Ready:return Object(l.a)("New version available. <a>Update now.</a>",{},{a:e=>i.a.createElement(pe.a,{kind:"link",onClick:Kt},e)})}}(e.status,e.detail),s&&i.a.createElement(qt.a,null))),i.a.createElement(i.a.Fragment,null,i.a.createElement(pe.a,{onClick:()=>{t(null),qe.a.get().startUpdateCheck()},kind:"primary",disabled:s},Object(l.a)("Check for update")),n)};class Yt extends i.a.Component{constructor(){super(),I()(this,"_onClearCacheAndReload",e=>{qe.a.get()&&(console.log("Clear cache & reload clicked"),ee.a.get().stopClient(),ee.a.get().store.deleteAllData().then(()=>{qe.a.get().reload()}))}),I()(this,"_onBugReport",e=>{const t=d.getComponent("dialogs.BugReportDialog");t&&De.a.createTrackedDialog("Bug Report Dialog","",t,{})}),I()(this,"_onStartBotChat",e=>{this.props.closeSettingsFn(),Object(Ct.b)({dmUserId:c.a.get().welcomeUserId,andView:!0})}),I()(this,"_showSpoiler",e=>{const t=e.target;t.innerHTML=t.getAttribute("data-spoiler");const s=document.createRange();s.selectNodeContents(t);const n=window.getSelection();n.removeAllRanges(),n.addRange(s)}),this.state={appVersion:null,canUpdate:!1}}componentDidMount(){qe.a.get().getAppVersion().then(e=>this.setState({appVersion:e})).catch(e=>{console.error("Error getting vector version: ",e)}),qe.a.get().canSelfUpdate().then(e=>this.setState({canUpdate:e})).catch(e=>{console.error("Error getting self updatability: ",e)})}_renderLegal(){if(!c.a.get().terms_and_conditions_links)return null;const e=[];for(const t of c.a.get().terms_and_conditions_links)e.push(i.a.createElement("div",{key:t.url},i.a.createElement("a",{href:t.url,rel:"noreferrer noopener",target:"_blank"},t.text)));return i.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Legal")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},e))}_renderCredits(){return i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Credits")),i.a.createElement("ul",null,i.a.createElement("li",null,"The ",i.a.createElement("a",{href:"https://github.com/matrix-org/twemoji-colr",rel:"noreferrer noopener",target:"_blank"}," twemoji-colr")," font is © ",i.a.createElement("a",{href:"https://mozilla.org",rel:"noreferrer noopener",target:"_blank"},"Mozilla Foundation")," ","used under the terms of ",i.a.createElement("a",{href:"http://www.apache.org/licenses/LICENSE-2.0",rel:"noreferrer noopener",target:"_blank"},"Apache 2.0"),"."),i.a.createElement("li",null,"The ",i.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twemoji")," emoji art is © ",i.a.createElement("a",{href:"https://twemoji.twitter.com/",rel:"noreferrer noopener",target:"_blank"},"Twitter, Inc and other contributors")," used under the terms of ",i.a.createElement("a",{href:"https://creativecommons.org/licenses/by/4.0/",rel:"noreferrer noopener",target:"_blank"},"CC-BY 4.0"),".")))}render(){const e=c.a.get().brand,t=c.a.get().base_host_url,s=c.a.get().generic_endpoints.faq;let n=Object(l.a)("For help with using %(brand)s, click <a>here</a>.",{brand:e},{a:e=>i.a.createElement("a",{href:t+s,rel:"noreferrer nofollow noopener",target:"_blank"},e)});const a=this.state.appVersion||"unknown";let o=ee.a.get().olmVersion;o=o?`${o[0]}.${o[1]}.${o[2]}`:"<not-enabled>";let r,d=null;return this.state.canUpdate&&(d=i.a.createElement($t,null)),c.a.get().bug_report_endpoint_url&&(r=i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Bug reporting")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("You have encountered an error and you want to help us ? Please describe the error encountered. There will be no direct answer, but your report will help us to improve Tchap. What have you done ? What was the expected behavior ? What really happened ?"),i.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},i.a.createElement(pe.a,{onClick:this._onBugReport,kind:"primary"},Object(l.a)("Report an error")))))),i.a.createElement("div",{className:"mx_SettingsTab mx_HelpUserSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Help & About")),r,i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("FAQ")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},n),i.a.createElement(pe.a,{kind:"primary",onClick:Ht.d},Object(l.a)("Keyboard Shortcuts"))),i.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Versions")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("%(brand)s version:",{brand:e})," ",a,i.a.createElement("br",null),Object(l.a)("olm version:")," ",o,i.a.createElement("br",null),d)),this._renderLegal(),this._renderCredits(),i.a.createElement("div",{className:"mx_SettingsTab_section mx_HelpUserSettingsTab_versions"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Advanced")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},i.a.createElement("div",{className:"mx_HelpUserSettingsTab_debugButton"},i.a.createElement(pe.a,{onClick:this._onClearCacheAndReload,kind:"danger"},Object(l.a)("Clear cache and reload"))))))}}I()(Yt,"propTypes",{closeSettingsFn:xe.a.func.isRequired});class Jt extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{error:null,groups:null})}componentDidMount(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups||[],error:null})},e=>{console.error(e),this.setState({groups:null,error:e})})}render(){let e="",t=null;const s=this.state.groups;if(this.state.error)e=Object(l.a)("Something went wrong when trying to get your communities.");else if(null===s)e=Object(l.a)("Loading...");else if(s.length>0){const n=d.getComponent("groups.GroupPublicityToggle");t=s.map((e,t)=>i.a.createElement(n,{key:t,groupId:e})),e=Object(l.a)("Display your community flair in rooms configured to show it.")}else e=Object(l.a)("You're not currently a member of any communities.");return i.a.createElement("div",null,i.a.createElement("p",{className:"mx_SettingsTab_subsectionText"},e),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},t))}}I()(Jt,"contextType",b.a);class Qt extends i.a.Component{render(){return i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("span",{className:"mx_SettingsTab_heading"},Object(l.a)("Flair")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(Jt,null)))}}var Xt=s(452),Zt=(s(767),s(342));class es extends i.a.Component{constructor(){super(),I()(this,"_onPersonalRuleChanged",e=>{this.setState({newPersonalRule:e.target.value})}),I()(this,"_onNewListChanged",e=>{this.setState({newList:e.target.value})}),I()(this,"_onAddPersonalRule",async e=>{e.preventDefault(),e.stopPropagation();let t=Zt.d;this.state.newPersonalRule.startsWith("@")&&(t=Zt.e),this.setState({busy:!0});try{const e=await Xt.a.sharedInstance().getOrCreatePersonalList();await e.banEntity(t,this.state.newPersonalRule,Object(l.a)("Ignored/Blocked")),this.setState({newPersonalRule:""})}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to add Mjolnir rule","",t,{title:Object(l.a)("Error adding ignored user/server"),description:Object(l.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}),I()(this,"_onSubscribeList",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});try{const e=await ee.a.get().joinRoom(this.state.newList);await Xt.a.sharedInstance().subscribeToList(e.roomId),this.setState({newList:""})}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to subscribe to Mjolnir list","",t,{title:Object(l.a)("Error subscribing to list"),description:Object(l.a)("Please verify the room ID or address and try again.")})}finally{this.setState({busy:!1})}}),this.state={busy:!1,newPersonalRule:"",newList:""}}async _removePersonalRule(e){this.setState({busy:!0});try{const t=Xt.a.sharedInstance().getPersonalList();await t.unbanEntity(e.kind,e.entity)}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to remove Mjolnir rule","",t,{title:Object(l.a)("Error removing ignored user/server"),description:Object(l.a)("Something went wrong. Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}async _unsubscribeFromList(e){this.setState({busy:!0});try{await Xt.a.sharedInstance().unsubscribeFromList(e.roomId),await ee.a.get().leave(e.roomId)}catch(e){console.error(e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to unsubscribe from Mjolnir list","",t,{title:Object(l.a)("Error unsubscribing from list"),description:Object(l.a)("Please try again or view your console for hints.")})}finally{this.setState({busy:!1})}}_viewListRules(e){const t=d.getComponent("dialogs.QuestionDialog"),s=ee.a.get().getRoom(e.roomId),n=s?s.name:e.roomId,a=e=>{if(0===e.length)return i.a.createElement("i",null,Object(l.a)("None"));const t=[];for(const s of e)t.push(i.a.createElement("li",{key:s.kind+s.entity},i.a.createElement("code",null,s.entity)));return i.a.createElement("ul",null,t)};De.a.createTrackedDialog("View Mjolnir list rules","",t,{title:Object(l.a)("Ban list rules - %(roomName)s",{roomName:n}),description:i.a.createElement("div",null,i.a.createElement("h3",null,Object(l.a)("Server rules")),a(e.serverRules),i.a.createElement("h3",null,Object(l.a)("User rules")),a(e.userRules)),button:Object(l.a)("Close"),hasCancelButton:!1})}_renderPersonalBanListRules(){const e=d.getComponent("elements.AccessibleButton"),t=Xt.a.sharedInstance().getPersonalList(),s=t?[...t.userRules,...t.serverRules]:[];if(!t||s.length<=0)return i.a.createElement("i",null,Object(l.a)("You have not ignored anyone."));const n=[];for(const t of s)n.push(i.a.createElement("li",{key:t.entity,className:"mx_MjolnirUserSettingsTab_listItem"},i.a.createElement(e,{kind:"danger_sm",onClick:()=>this._removePersonalRule(t),disabled:this.state.busy},Object(l.a)("Remove"))," ",i.a.createElement("code",null,t.entity)));return i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("You are currently ignoring:")),i.a.createElement("ul",null,n))}_renderSubscribedBanLists(){const e=d.getComponent("elements.AccessibleButton"),t=Xt.a.sharedInstance().getPersonalList(),s=Xt.a.sharedInstance().lists.filter(e=>!t||t.roomId!==e.roomId);if(!s||s.length<=0)return i.a.createElement("i",null,Object(l.a)("You are not subscribed to any lists"));const n=[];for(const t of s){const s=ee.a.get().getRoom(t.roomId),a=s?i.a.createElement("span",null,s.name," (",i.a.createElement("code",null,t.roomId),")"):i.a.createElement("code",null,"list.roomId");n.push(i.a.createElement("li",{key:t.roomId,className:"mx_MjolnirUserSettingsTab_listItem"},i.a.createElement(e,{kind:"danger_sm",onClick:()=>this._unsubscribeFromList(t),disabled:this.state.busy},Object(l.a)("Unsubscribe"))," ",i.a.createElement(e,{kind:"primary_sm",onClick:()=>this._viewListRules(t),disabled:this.state.busy},Object(l.a)("View rules"))," ",a))}return i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("You are currently subscribed to:")),i.a.createElement("ul",null,n))}render(){const e=d.getComponent("elements.Field"),t=d.getComponent("elements.AccessibleButton"),s=c.a.get().brand;return i.a.createElement("div",{className:"mx_SettingsTab mx_MjolnirUserSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Ignored users")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},i.a.createElement("span",{className:"warning"},Object(l.a)("⚠ These settings are meant for advanced users.")),i.a.createElement("br",null),i.a.createElement("br",null),Object(l.a)("Add users and servers you want to ignore here. Use asterisks to have %(brand)s match any characters. For example, <code>@bot:*</code> would ignore all users that have the name 'bot' on any server.",{brand:s},{code:e=>i.a.createElement("code",null,e)}),i.a.createElement("br",null),i.a.createElement("br",null),Object(l.a)("Ignoring people is done through ban lists which contain rules for who to ban. Subscribing to a ban list means the users/servers blocked by that list will be hidden from you."))),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Personal ban list")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Your personal ban list holds all the users/servers you personally don't want to see messages from. After ignoring your first user/server, a new room will show up in your room list named 'My Ban List' - stay in this room to keep the ban list in effect.")),i.a.createElement("div",null,this._renderPersonalBanListRules()),i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this._onAddPersonalRule,autoComplete:"off"},i.a.createElement(e,{type:"text",label:Object(l.a)("Server or user ID to ignore"),placeholder:Object(l.a)("eg: @bot:* or example.org"),value:this.state.newPersonalRule,onChange:this._onPersonalRuleChanged}),i.a.createElement(t,{type:"submit",kind:"primary",onClick:this._onAddPersonalRule,disabled:this.state.busy},Object(l.a)("Ignore"))))),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Subscribed lists")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},i.a.createElement("span",{className:"warning"},Object(l.a)("Subscribing to a ban list will cause you to join it!"))," ",i.a.createElement("span",null,Object(l.a)("If this isn't what you want, please use a different tool to ignore users."))),i.a.createElement("div",null,this._renderSubscribedBanLists()),i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this._onSubscribeList,autoComplete:"off"},i.a.createElement(e,{type:"text",label:Object(l.a)("Room ID or address of ban list"),value:this.state.newList,onChange:this._onNewListChanged}),i.a.createElement(t,{type:"submit",kind:"primary",onClick:this._onSubscribeList,disabled:this.state.busy},Object(l.a)("Subscribe"))))))}}class ts extends i.a.Component{constructor(){super(),this.state={mjolnirEnabled:F.a.getValue("feature_mjolnir")}}componentDidMount(){this._mjolnirWatcher=F.a.watchSetting("feature_mjolnir",null,this._mjolnirChanged.bind(this))}componentWillUnmount(){F.a.unwatchSetting(this._mjolnirWatcher)}_mjolnirChanged(e,t,s,n){this.setState({mjolnirEnabled:n})}_getTabs(){const e=[];return e.push(new Re("USER_GENERAL_TAB",Object(l.b)("General"),"mx_UserSettingsDialog_settingsIcon",i.a.createElement(tt,{closeSettingsFn:this.props.onFinished}))),e.push(new Re("USER_APPEARANCE_TAB",Object(l.b)("Appearance"),"mx_UserSettingsDialog_appearanceIcon",i.a.createElement(yt,null))),e.push(new Re("USER_NOTIFICATIONS_TAB",Object(l.b)("Notifications"),"mx_UserSettingsDialog_bellIcon",i.a.createElement(jt,null))),e.push(new Re("USER_PREFERENCES_TAB",Object(l.b)("Preferences"),"mx_UserSettingsDialog_preferencesIcon",i.a.createElement(Nt,null))),F.a.getValue(Xe.a.Voip)&&e.push(new Re("USER_VOICE_TAB",Object(l.b)("Voice & Video"),"mx_UserSettingsDialog_voiceIcon",i.a.createElement(Wt,null))),e.push(new Re("USER_SECURITY_TAB",Object(l.b)("Security & Privacy"),"mx_UserSettingsDialog_securityIcon",i.a.createElement(Tt,{closeSettingsFn:this.props.onFinished}))),c.a.get().showLabsSettings&&e.push(new Re("USER_LABS_TAB",Object(l.b)("Labs"),"mx_UserSettingsDialog_labsIcon",i.a.createElement(nt,null))),this.state.mjolnirEnabled&&e.push(new Re("USER_MJOLNIR_TAB",Object(l.b)("Ignored users"),"mx_UserSettingsDialog_mjolnirIcon",i.a.createElement(es,null))),e.push(new Re("USER_HELP_TAB",Object(l.b)("Help & About"),"mx_UserSettingsDialog_helpIcon",i.a.createElement(Yt,{closeSettingsFn:this.props.onFinished}))),e}render(){const e=d.getComponent("views.dialogs.BaseDialog");return i.a.createElement(e,{className:"mx_UserSettingsDialog tc_UserSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Settings")},i.a.createElement("div",{className:"ms_SettingsDialog_content"},i.a.createElement(Oe,{tabs:this._getTabs(),initialTabId:this.props.initialTabId})))}}I()(ts,"propTypes",{onFinished:xe.a.func.isRequired,initialTabId:xe.a.string});var ss=s(665);class ns extends i.a.Component{constructor(e){super(e),I()(this,"_onDownload",async e=>{this.setState({downloadBusy:!0}),this._downloadProgressCallback(Object(l.a)("Preparing to download logs"));try{await Object(ss.b)({sendLogs:!0,progressCallback:this._downloadProgressCallback,label:this.props.label}),this.setState({downloadBusy:!1,downloadProgress:null})}catch(e){this._unmounted||this.setState({downloadBusy:!1,downloadProgress:Object(l.a)("Failed to send logs: ")+""+e.message})}}),this.state={sendLogs:!0,busy:!1,err:null,issueUrl:"",text:e.initialText||"",progress:null,downloadBusy:!1,downloadProgress:null},this._unmounted=!1,this._onSubmit=this._onSubmit.bind(this),this._onCancel=this._onCancel.bind(this),this._onTextChange=this._onTextChange.bind(this),this._onSendLogsChange=this._onSendLogsChange.bind(this),this._sendProgressCallback=this._sendProgressCallback.bind(this),this._downloadProgressCallback=this._downloadProgressCallback.bind(this)}componentWillUnmount(){this._unmounted=!0}_onCancel(e){this.props.onFinished(!1)}_onSubmit(e){let t;if(!(this.state.text.length>0))return void(this._unmounted||this.setState({busy:!1,progress:null,err:Object(l.a)("The field note is required.")}));t=this.state.text+"\n\n";const s=ee.a.get().baseUrl+c.a.get().bug_report_endpoint_url;this.setState({busy:!0,progress:null,err:null}),this._sendProgressCallback(Object(l.a)("Preparing to send logs")),Object(ss.a)(s,{userText:t,sendLogs:!0,progressCallback:this._sendProgressCallback,label:this.props.label}).then(()=>{if(!this._unmounted){this.props.onFinished(!1);const e=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Bug report sent","",e,{title:Object(l.a)("Logs sent"),description:Object(l.a)("Thank you!"),hasCancelButton:!1})}},e=>{this._unmounted||this.setState({busy:!1,progress:null,err:Object(l.a)("Failed to send logs: ")+""+e.message})})}_onTextChange(e){this.setState({text:e.target.value})}_onSendLogsChange(e){this.setState({sendLogs:e.target.checked})}_sendProgressCallback(e){this._unmounted||this.setState({progress:e})}_downloadProgressCallback(e){this._unmounted||this.setState({downloadProgress:e})}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons"),n=d.getComponent("elements.Field");let a=null;this.state.err&&(a=i.a.createElement("div",{className:"error"},this.state.err));let o,r=null;return this.state.busy&&(r=i.a.createElement("div",{className:"progress"},i.a.createElement(e,null),this.state.progress," ...")),window.Modernizr&&Object.values(window.Modernizr).some(e=>!1===e)&&(o=i.a.createElement("p",null,i.a.createElement("b",null,Object(l.a)("Reminder: Your browser is unsupported, so your experience may be unpredictable.")))),i.a.createElement(t,{className:"mx_BugReportDialog",onFinished:this._onCancel,title:Object(l.a)("Report an error"),contentId:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},o,i.a.createElement("p",null,Object(l.a)("Describe your problem here.")),i.a.createElement("p",null,i.a.createElement("b",null,Object(l.a)("In order to diagnose problems, logs from this client will be sent with this error report. This error report, including logs, will not be visible publicly."))),i.a.createElement("div",{className:"mx_BugReportDialog_download"},i.a.createElement(pe.a,{onClick:this._onDownload,kind:"link",disabled:this.state.downloadBusy},Object(l.a)("Download logs")),this.state.downloadProgress&&i.a.createElement("span",null,this.state.downloadProgress," ...")),i.a.createElement(n,{className:"mx_BugReportDialog_field_input",element:"textarea",label:Object(l.a)("Notes"),rows:5,onChange:this._onTextChange,value:this.state.text,placeholder:Object(l.a)("Please describe the error encountered. What have you done ? What was the expected behavior ? What really happened ?")}),r,a),i.a.createElement(s,{primaryButton:Object(l.a)("Send logs"),onPrimaryButtonClick:this._onSubmit,focus:!0,onCancel:this._onCancel,disabled:this.state.busy}))}}ns.propTypes={onFinished:xe.a.func.isRequired,initialText:xe.a.string};var as=s(290);var is=e=>{const[t,s]=Object(a.useState)(""),[n,o]=Object(a.useState)(""),r=()=>{e.onFinished(),De.a.createTrackedDialog("Bug Report Dialog","",ns,{})},d=y.a.instance.canEnable(),m=c.a.get().brand;let h,u;return d&&(h=i.a.createElement(i.a.Fragment,null,i.a.createElement("hr",null),i.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_rateApp"},i.a.createElement("h3",null,Object(l.a)("Rate %(brand)s",{brand:m})),i.a.createElement("p",null,Object(l.a)("Tell us below how you feel about %(brand)s so far.",{brand:m})),i.a.createElement("p",null,Object(l.a)("Please go into as much detail as you like, so we can track down the problem.")),i.a.createElement(bt,{name:"feedbackRating",value:t,onChange:s,definitions:[{value:"1",label:"😠"},{value:"2",label:"😞"},{value:"3",label:"😑"},{value:"4",label:"😄"},{value:"5",label:"😍"}]}),i.a.createElement(ke.a,{id:"feedbackComment",label:Object(l.a)("Add comment"),placeholder:Object(l.a)("Comment"),type:"text",autoComplete:"off",value:n,element:"textarea",onChange:e=>{o(e.target.value)}})))),d&&(u=i.a.createElement("h2",null,Object(l.a)("There are two ways you can provide feedback and help us improve %(brand)s.",{brand:m}))),i.a.createElement(St.a,{className:"mx_FeedbackDialog",hasCancelButton:!!d,title:Object(l.a)("Feedback"),description:i.a.createElement(i.a.Fragment,null,u,i.a.createElement("div",{className:"mx_FeedbackDialog_section mx_FeedbackDialog_reportBug"},i.a.createElement("h3",null,Object(l.a)("Report a bug")),i.a.createElement("p",null,Object(l.a)("Please view <existingIssuesLink>existing bugs on Github</existingIssuesLink> first. No match? <newIssueLink>Start a new one</newIssueLink>.",{},{existingIssuesLink:e=>i.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/vector-im/element-web/issues?q=is%3Aopen+is%3Aissue+sort%3Areactions-%2B1-desc"},e),newIssueLink:e=>i.a.createElement("a",{target:"_blank",rel:"noreferrer noopener",href:"https://github.com/vector-im/element-web/issues/new"},e)})),i.a.createElement("p",null,Object(l.a)("PRO TIP: If you start a bug, please submit <debugLogsLink>debug logs</debugLogsLink> to help us track down the problem.",{},{debugLogsLink:e=>i.a.createElement(pe.a,{kind:"link",onClick:r},e)}))),h),button:d?Object(l.a)("Send feedback"):Object(l.a)("Go back"),buttonDisabled:d&&""===t,onFinished:s=>{d&&s&&(y.a.instance.reportFeedback(parseInt(t,10),n),De.a.createTrackedDialog("Feedback sent","",as.a,{title:Object(l.a)("Feedback sent"),description:Object(l.a)("Thank you!")})),e.onFinished()}})};class os extends i.a.Component{constructor(){super(),I()(this,"defaultProps",{onFinished:function(){}}),this._onSettingsLinkClick=this._onSettingsLinkClick.bind(this),this._onExportE2eKeysClicked=this._onExportE2eKeysClicked.bind(this),this._onFinished=this._onFinished.bind(this),this._onSetRecoveryMethodClick=this._onSetRecoveryMethodClick.bind(this),this._onLogoutConfirm=this._onLogoutConfirm.bind(this);const e=ee.a.get(),t=e.isCryptoEnabled()&&!e.getKeyBackupEnabled();this.state={shouldLoadBackupStatus:t,loading:t,backupInfo:null,error:null},t&&this._loadBackupStatus()}async _loadBackupStatus(){try{const e=await ee.a.get().getKeyBackupVersion();this.setState({loading:!1,backupInfo:e})}catch(e){console.log("Unable to fetch key backup status",e),this.setState({loading:!1,error:e})}}_onSettingsLinkClick(){this.props.onFinished()}_onExportE2eKeysClicked(){De.a.createTrackedDialogAsync("Export E2E Keys","",s.e(3).then(s.bind(null,1506)),{matrixClient:ee.a.get(),isLogout:!0})}_onFinished(e){e&&m.a.dispatch({action:"logout"}),window.localStorage&&window.localStorage.removeItem("tc_validate_encryption_informations"),this.props.onFinished()}_onSetRecoveryMethodClick(){this.state.backupInfo?De.a.createTrackedDialog("Restore Backup","",xt.a,null,null,!1,!0):De.a.createTrackedDialogAsync("Key Backup","Key Backup",s.e(4).then(s.bind(null,1488)),null,null,!1,!0),this.props.onFinished()}_onLogoutConfirm(){m.a.dispatch({action:"logout"}),window.localStorage&&window.localStorage.removeItem("tc_validate_encryption_informations"),this.props.onFinished()}render(){const e=d.getComponent("views.dialogs.BaseDialog");let t;const n=d.getComponent("views.elements.DialogButtons");return t=i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("By logging-out you can lose the encryption keys necessary to access your encrypted messages (<a>learn more</a>).",{},{a:e=>i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.encryption_info,rel:"noreferrer nofollow noopener",target:"_blank"},e)})),i.a.createElement("p",null,Object(l.a)("To avoid this it's strongly recommended to:"))),i.a.createElement("div",{className:"tc_ThreeColumn_block"},i.a.createElement("div",{className:"tc_ThreeColumn_block_bordered"},i.a.createElement("div",{className:"tc_ThreeColumn_block_content"},i.a.createElement("div",{className:"tc_ThreeColumn_block_image"},i.a.createElement("img",{src:s(672),alt:"Login logo",width:"50"})),i.a.createElement("p",null,Object(l.a)("Stay connected from at least one other device")),i.a.createElement("p",null," ")),i.a.createElement("p",{className:"tc_ThreeColumn_block_separator"},Object(l.a)("OR"))),i.a.createElement("div",{className:"tc_ThreeColumn_block_bordered"},i.a.createElement("div",{className:"tc_ThreeColumn_block_content"},i.a.createElement("div",{className:"tc_ThreeColumn_block_image"},i.a.createElement("img",{src:s(673),alt:"Tchap logo",width:"60"})),i.a.createElement("p",null,Object(l.a)("Connect also with the mobile app")),i.a.createElement("p",null,i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.mobile_download,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("Download")))),i.a.createElement("p",{className:"tc_ThreeColumn_block_separator"},Object(l.a)("OR"))),i.a.createElement("div",{className:"tc_ThreeColumn_block_last"},i.a.createElement("div",{className:"tc_ThreeColumn_block_content"},i.a.createElement("div",{className:"tc_ThreeColumn_block_image"},i.a.createElement("img",{src:s(1155),alt:"Export logo",width:"70"})),i.a.createElement("p",null,Object(l.a)("Export your encryption keys")),i.a.createElement("p",null,i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.export_info,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("Find out more"))))))),i.a.createElement(n,{primaryButton:Object(l.a)("Export keys and log-out"),hasCancel:!1,onPrimaryButtonClick:this._onExportE2eKeysClicked,focus:!0},i.a.createElement("button",{onClick:this._onLogoutConfirm},Object(l.a)("Sign out")))),i.a.createElement(e,{title:Object(l.a)("Before log-out"),contentId:"mx_Dialog_content",hasCancel:!0,onFinished:this._onFinished},t)}}var rs=s(154),ls=s(123),cs=s(131),ds=s(148);class ms extends i.a.PureComponent{constructor(e){super(e),I()(this,"avatarUploadRef",i.a.createRef()),I()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),I()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e=this.state.currentAvatarUrl||"";this.state.avatarFile&&(e=await ee.a.get().uploadContent(this.state.avatarFile)),await ee.a.get().setGroupProfile(this.props.communityId,{name:this.state.name,avatar_url:e}),await ds.a.refreshGroupProfile(ee.a.get(),this.props.communityId),this.props.onFinished(!0)}catch(e){console.error(e),this.setState({busy:!1,error:Object(l.a)("There was an error updating your community. The server is unable to process your request.")})}}}),I()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),I()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()});const t=ge.a.instance.getCommunityProfile(e.communityId);this.state={name:(null==t?void 0:t.name)||"",error:null,busy:!1,avatarFile:null,avatarPreview:null,currentAvatarUrl:null==t?void 0:t.avatarUrl}}render(){let e=i.a.createElement("img",{src:this.state.avatarPreview,className:"mx_EditCommunityPrototypeDialog_avatar"});if(!this.state.avatarPreview)if(this.state.currentAvatarUrl){const t=ee.a.get().mxcUrlToHttp(this.state.currentAvatarUrl);e=i.a.createElement("img",{src:t,className:"mx_EditCommunityPrototypeDialog_avatar"})}else e=i.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_placeholderAvatar"});return i.a.createElement(cs.a,{className:"mx_EditCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(l.a)("Update community")},i.a.createElement("form",{onSubmit:this.onSubmit},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowName"},i.a.createElement(ke.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(l.a)("Enter name"),label:Object(l.a)("Enter name")})),i.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_rowAvatar"},i.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),i.a.createElement(pe.a,{onClick:this.onChangeAvatar,className:"mx_EditCommunityPrototypeDialog_avatarContainer"},e),i.a.createElement("div",{className:"mx_EditCommunityPrototypeDialog_tip"},i.a.createElement("b",null,Object(l.a)("Add image (optional)")),i.a.createElement("span",null,Object(l.a)("An image will help people identify your community.")))),i.a.createElement(pe.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(l.a)("Save")))))}}class hs extends i.a.Component{constructor(e){super(e),I()(this,"dispatcherRef",void 0),I()(this,"themeWatcherRef",void 0),I()(this,"buttonRef",Object(a.createRef)()),I()(this,"tagStoreRef",void 0),I()(this,"onTagStoreUpdate",()=>{this.forceUpdate()}),I()(this,"onProfileUpdate",async()=>{this.forceUpdate()}),I()(this,"onThemeChanged",()=>{this.setState({isDarkTheme:this.isUserOnDarkTheme()})}),I()(this,"onAction",e=>{e.action===h.a.ToggleUserMenu&&(this.state.contextMenuPosition?this.setState({contextMenuPosition:null}):this.buttonRef.current&&this.buttonRef.current.click())}),I()(this,"onOpenMenuClick",e=>{e.preventDefault(),e.stopPropagation();const t=e.target;this.setState({contextMenuPosition:t.getBoundingClientRect()})}),I()(this,"onContextMenu",e=>{e.preventDefault(),e.stopPropagation(),this.setState({contextMenuPosition:{left:e.clientX,top:e.clientY,width:20,height:0}})}),I()(this,"onCloseMenu",()=>{this.setState({contextMenuPosition:null})}),I()(this,"onSwitchThemeClick",e=>{e.preventDefault(),e.stopPropagation(),F.a.setValue("use_system_theme",null,Qe.a.DEVICE,!1);const t=this.state.isDarkTheme?"light":"dark";F.a.setValue("theme",null,Qe.a.DEVICE,t)}),I()(this,"onSettingsOpen",(e,t)=>{e.preventDefault(),e.stopPropagation();const s={action:h.a.ViewUserSettings,initialTabId:t};m.a.dispatch(s),this.setState({contextMenuPosition:null})}),I()(this,"onShowArchived",e=>{e.preventDefault(),e.stopPropagation(),console.log("TODO: Show archived rooms")}),I()(this,"onProvideFeedback",e=>{e.preventDefault(),e.stopPropagation(),De.a.createTrackedDialog("Feedback Dialog","",is),this.setState({contextMenuPosition:null})}),I()(this,"onSignOutClick",async e=>{var t;e.preventDefault(),e.stopPropagation();const s=ee.a.get();s&&s.isCryptoEnabled()&&null!==(t=await s.exportRoomKeys())&&void 0!==t&&t.length?De.a.createTrackedDialog("Logout from LeftPanel","",os):m.a.dispatch({action:"logout"}),this.setState({contextMenuPosition:null})}),I()(this,"onSignInClick",()=>{m.a.dispatch({action:"start_login"}),this.setState({contextMenuPosition:null})}),I()(this,"onRegisterClick",()=>{m.a.dispatch({action:"start_registration"}),this.setState({contextMenuPosition:null})}),I()(this,"onHomeClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"view_home_page"}),this.setState({contextMenuPosition:null})}),I()(this,"onCommunitySettingsClick",e=>{e.preventDefault(),e.stopPropagation(),De.a.createTrackedDialog("Edit Community","",ms,{communityId:ge.a.instance.getSelectedCommunityId()}),this.setState({contextMenuPosition:null})}),I()(this,"onCommunityMembersClick",e=>{e.preventDefault(),e.stopPropagation();const t=ge.a.instance.getSelectedCommunityGeneralChat();t?(m.a.dispatch({action:"view_room",room_id:t.roomId},!0),m.a.dispatch({action:h.a.SetRightPanelPhase,phase:ls.b.RoomMemberList})):De.a.createTrackedDialog("Failed to find general chat","",Ae.a,{title:Object(l.a)("Failed to find the general chat for this community"),description:Object(l.a)("Failed to find the general chat for this community")}),this.setState({contextMenuPosition:null})}),I()(this,"onCommunityInviteClick",e=>{e.preventDefault(),e.stopPropagation(),Object(rs.e)(ge.a.instance.getSelectedCommunityId()),this.setState({contextMenuPosition:null})}),I()(this,"renderContextMenu",()=>{if(!this.state.contextMenuPosition)return null;const e=ge.a.instance.getSelectedCommunityName();let t=null;this.hasHomePage&&(t=i.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconHome",label:Object(l.a)("Home"),onClick:this.onHomeClick}));let s=i.a.createElement("div",{className:"mx_UserMenu_contextMenu_name"},i.a.createElement("span",{className:"mx_UserMenu_contextMenu_displayName"},p.a.instance.displayName)),n=i.a.createElement(i.a.Fragment,null,i.a.createElement(T.c,null,t,i.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconBell",label:Object(l.a)("Notification settings"),onClick:e=>this.onSettingsOpen(e,"USER_NOTIFICATIONS_TAB")}),i.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconLock",label:Object(l.a)("Security & privacy"),onClick:e=>this.onSettingsOpen(e,"USER_SECURITY_TAB")}),i.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSettings",label:Object(l.a)("All settings"),onClick:e=>this.onSettingsOpen(e,null)})),i.a.createElement(T.c,{red:!0},i.a.createElement(T.b,{iconClassName:"mx_UserMenu_iconSignOut",label:Object(l.a)("Sign out"),onClick:this.onSignOutClick})));const a=L()({mx_UserMenu_contextMenu:!0,mx_UserMenu_contextMenu_prototype:!!e});return i.a.createElement(T.e,{left:this.state.contextMenuPosition.width+this.state.contextMenuPosition.left-10,top:this.state.contextMenuPosition.top+this.state.contextMenuPosition.height+8,onFinished:this.onCloseMenu,className:a},i.a.createElement("div",{className:"mx_UserMenu_contextMenu_header"},s),n,null)}),this.state={contextMenuPosition:null,isDarkTheme:this.isUserOnDarkTheme()},p.a.instance.on(g.b,this.onProfileUpdate)}get hasHomePage(){return!!r(c.a.get())}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction),this.themeWatcherRef=F.a.watchSetting("theme",null,this.onThemeChanged),this.tagStoreRef=P.a.addListener(this.onTagStoreUpdate)}componentWillUnmount(){this.themeWatcherRef&&F.a.unwatchSetting(this.themeWatcherRef),this.dispatcherRef&&m.a.unregister(this.dispatcherRef),p.a.instance.off(g.b,this.onProfileUpdate),this.tagStoreRef.remove()}isUserOnDarkTheme(){const e=F.a.getValue("theme");return e.startsWith("custom-")?Object(at.c)(e.substring("custom-".length)).is_dark:"dark"===e}render(){const e=ee.a.get().getUserId(),t=p.a.instance.displayName||e,s=p.a.instance.getHttpAvatarUrl(46),a=ge.a.instance.getSelectedCommunityName();let o=!1,r=Object(l.a)("User menu"),c=i.a.createElement("span",{className:"mx_UserMenu_userName"},t),d=i.a.createElement("span",{className:"mx_UserMenu_headerButtons"});a?(c=i.a.createElement("div",{className:"mx_UserMenu_doubleName"},i.a.createElement("span",{className:"mx_UserMenu_userName"},a),i.a.createElement("span",{className:"mx_UserMenu_subUserName"},t)),r=Object(l.a)("Community and user menu"),o=!0):F.a.getValue("feature_communities_v2_prototypes")&&(c=i.a.createElement("div",{className:"mx_UserMenu_doubleName"},i.a.createElement("span",{className:"mx_UserMenu_userName"},Object(l.a)("Home")),i.a.createElement("span",{className:"mx_UserMenu_subUserName"},t)),o=!0),this.props.isMinimized&&(c=null,d=null);const m=L()({mx_UserMenu:!0,mx_UserMenu_minimized:this.props.isMinimized,mx_UserMenu_prototype:o});return i.a.createElement(i.a.Fragment,null,i.a.createElement(n.c,{className:m,onClick:this.onOpenMenuClick,inputRef:this.buttonRef,label:r,isExpanded:!!this.state.contextMenuPosition,onContextMenu:this.onContextMenu},i.a.createElement("div",{className:"mx_UserMenu_row"},i.a.createElement("span",{className:"mx_UserMenu_userAvatarContainer"},i.a.createElement(u.a,{idName:e,name:t,url:s,width:46,height:46,resizeMethod:"crop",className:"mx_UserMenu_userAvatar"})),c,d)),this.renderContextMenu())}}var us=s(674),ps=s(147),gs=s(1);class fs extends ps.a{constructor(){super(m.a),I()(this,"waitingRooms",[]),I()(this,"onMyMembership",async e=>{const t=F.a.getValue("breadcrumbs",null,!0);this.meetsRoomRequirement&&Object(gs.r)(t)&&await F.a.setValue("breadcrumbs",null,Qe.a.ACCOUNT,!0)}),I()(this,"onRoom",async e=>{const t=this.waitingRooms.find(t=>t.roomId===e.roomId);t&&(this.waitingRooms.splice(this.waitingRooms.indexOf(t),1),Date.now()-t.addedTs>9e4||await this.appendRoom(e))}),F.a.monitorSetting("breadcrumb_rooms",null),F.a.monitorSetting("breadcrumbs",null)}static get instance(){return fs.internalInstance}get rooms(){return this.state.rooms||[]}get visible(){return this.state.enabled&&this.meetsRoomRequirement}get meetsRoomRequirement(){return this.matrixClient&&this.matrixClient.getVisibleRooms().length>=20}async onAction(e){if(this.matrixClient)if("setting_updated"===e.action)"breadcrumb_rooms"===e.settingName?await this.updateRooms():"breadcrumbs"===e.settingName&&await this.updateState({enabled:F.a.getValue("breadcrumbs",null)});else if("view_room"===e.action)if(e.auto_join&&!this.matrixClient.getRoom(e.room_id))this.waitingRooms.push({roomId:e.room_id,addedTs:Date.now()});else{const t=this.matrixClient.getRoom(e.room_id);t&&await this.appendRoom(t)}}async onReady(){await this.updateRooms(),await this.updateState({enabled:F.a.getValue("breadcrumbs",null)}),this.matrixClient.on("Room.myMembership",this.onMyMembership),this.matrixClient.on("Room",this.onRoom)}async onNotReady(){this.matrixClient.removeListener("Room.myMembership",this.onMyMembership),this.matrixClient.removeListener("Room",this.onRoom)}async updateRooms(){let e=F.a.getValue("breadcrumb_rooms");e&&0!==e.length||(e=[]);const t=e.map(e=>this.matrixClient.getRoom(e)).filter(e=>!!e),s=this.state.rooms||[];Object(he.d)(t,s)&&await this.updateState({rooms:t})}async appendRoom(e){let t=!1;const s=(this.state.rooms||[]).slice(),n=this.matrixClient.getRoomUpgradeHistory(e.roomId);if(n.length>1){e=n[n.length-1];for(let e=0;e<n.length-1;e++){const a=s.findIndex(t=>t.roomId===n[e].roomId);-1!==a&&(s.splice(a,1),t=!0)}}const a=s.findIndex(t=>t.roomId===e.roomId);if(0!==a&&(-1!==a&&s.splice(a,1),s.splice(0,0,e),t=!0),s.length>20&&(s.splice(20,s.length-20),t=!0),t){await this.updateState({rooms:s});const e=s.map(e=>e.roomId);e.length>0&&await F.a.setValue("breadcrumb_rooms",null,Qe.a.ACCOUNT,e)}}}I()(fs,"internalInstance",new fs);var bs=s(365),vs=s(1156),_s=s(99);var ys=e=>{let{children:t}=e,s=ae()(e,["children"]);return i.a.createElement(Y.c,{handleHomeEnd:!0,onKeyDown:(e,t)=>{const s=e.target;if("INPUT"===s.tagName)return;let n=!0;switch(e.key){case _s.a.ARROW_UP:case _s.a.ARROW_DOWN:s.hasAttribute("aria-haspopup")&&s.click();break;case _s.a.ARROW_LEFT:case _s.a.ARROW_RIGHT:if(t.refs.length>0){const s=t.refs.findIndex(e=>e===t.activeRef),n=e.key===_s.a.ARROW_RIGHT?1:-1;t.refs.slice((s+n)%t.refs.length)[0].current.focus()}break;default:n=!1}n&&(e.preventDefault(),e.stopPropagation())}},({onKeyDownHandler:e})=>i.a.createElement("div",se()({},s,{onKeyDown:e,role:"toolbar"}),t))};class Es extends i.a.PureComponent{constructor(e){super(e),I()(this,"isMounted",!0),I()(this,"onBreadcrumbsUpdate",()=>{this.isMounted&&(this.setState({doAnimation:!1,skipFirst:!0}),setTimeout(()=>this.setState({doAnimation:!0,skipFirst:!1}),0))}),I()(this,"viewRoom",(e,t)=>{_.a.trackEvent("Breadcrumbs","click_node",String(t)),m.a.dispatch({action:"view_room",room_id:e.roomId})}),this.state={doAnimation:!0,skipFirst:!1},fs.instance.on(g.b,this.onBreadcrumbsUpdate)}componentWillUnmount(){this.isMounted=!1,fs.instance.off(g.b,this.onBreadcrumbsUpdate)}render(){const e=fs.instance.rooms.map((e,t)=>{const s=J.b.instance.getTagsForRoom(e),n=s.includes(X.a.DM)?X.a.DM:s[0];return i.a.createElement(Y.b,{className:"mx_RoomBreadcrumbs_crumb",key:e.roomId,onClick:()=>this.viewRoom(e,t),"aria-label":Object(l.a)("Room %(name)s",{name:e.name}),title:e.name,tooltipClassName:"mx_RoomBreadcrumbs_Tooltip"},i.a.createElement(bs.a,{room:e,avatarSize:32,tag:n,displayBadge:!0,forceCount:!0}))});return e.length>0?i.a.createElement(vs.CSSTransition,{appear:!0,in:this.state.doAnimation,timeout:640,classNames:"mx_RoomBreadcrumbs"},i.a.createElement(ys,{className:"mx_RoomBreadcrumbs","aria-label":Object(l.a)("Recently visited rooms")},e.slice(this.state.skipFirst?1:0))):i.a.createElement("div",{className:"mx_RoomBreadcrumbs"},i.a.createElement("div",{className:"mx_RoomBreadcrumbs_placeholder"},Object(l.a)("No recently visited rooms")))}}class Cs extends i.a.Component{constructor(e){super(e),I()(this,"onMouseWheel",e=>{if(this.props.verticalScrollsHorizontally&&this._scrollElement){const t=0,s=1,n=(new Date).getTime();if(Math.abs(e.deltaX)>0?(this._likelyTrackpadUser=!0,this._checkAgainForTrackpad=n+6e4):this._likelyTrackpadUser&&n>=this._checkAgainForTrackpad&&(this._likelyTrackpadUser=!1),this._likelyTrackpadUser)return;if(Math.abs(e.deltaX)<=t){const t=e.deltaY<0?-50:50,n=Math.abs(e.deltaY)<25?e.deltaY+t:e.deltaY;this._scrollElement.scrollLeft+=n*s}}}),this._collectScroller=this._collectScroller.bind(this),this._collectScrollerComponent=this._collectScrollerComponent.bind(this),this.checkOverflow=this.checkOverflow.bind(this),this._scrollElement=null,this._autoHideScrollbar=null,this._likelyTrackpadUser=null,this._checkAgainForTrackpad=0,this.state={leftIndicatorOffset:0,rightIndicatorOffset:0}}moveToOrigin(){this._scrollElement&&(this._scrollElement.scrollLeft=0,this._scrollElement.scrollTop=0)}_collectScroller(e){e&&!this._scrollElement&&(this._scrollElement=e,this._scrollElement.addEventListener("scroll",this.checkOverflow),this.checkOverflow())}_collectScrollerComponent(e){this._autoHideScrollbar=e}componentDidUpdate(e){(e&&e.children&&e.children.length||0)!==(this.props.children&&this.props.children.length||0)&&this.checkOverflow()}componentDidMount(){this.checkOverflow()}checkOverflow(){const e=this._scrollElement.scrollTop>0,t=this._scrollElement.scrollHeight>this._scrollElement.scrollTop+this._scrollElement.clientHeight,s=this._scrollElement.scrollLeft>0,n=this._scrollElement.scrollWidth>this._scrollElement.scrollLeft+this._scrollElement.clientWidth;e?this._scrollElement.classList.add("mx_IndicatorScrollbar_topOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_topOverflow"),t?this._scrollElement.classList.add("mx_IndicatorScrollbar_bottomOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_bottomOverflow"),s?this._scrollElement.classList.add("mx_IndicatorScrollbar_leftOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_leftOverflow"),n?this._scrollElement.classList.add("mx_IndicatorScrollbar_rightOverflow"):this._scrollElement.classList.remove("mx_IndicatorScrollbar_rightOverflow"),this.props.trackHorizontalOverflow&&this.setState({leftIndicatorOffset:s?this._scrollElement.scrollLeft+"px":"0",rightIndicatorOffset:n?`-${this._scrollElement.scrollLeft}px`:"0"})}getScrollTop(){return this._autoHideScrollbar.getScrollTop()}componentWillUnmount(){this._scrollElement&&this._scrollElement.removeEventListener("scroll",this.checkOverflow)}render(){const e={left:this.state.leftIndicatorOffset},t={right:this.state.rightIndicatorOffset},s=this.props.trackHorizontalOverflow?i.a.createElement("div",{className:"mx_IndicatorScrollbar_leftOverflowIndicator",style:e}):null,n=this.props.trackHorizontalOverflow?i.a.createElement("div",{className:"mx_IndicatorScrollbar_rightOverflowIndicator",style:t}):null;return i.a.createElement(o.a,se()({ref:this._collectScrollerComponent,wrappedRef:this._collectScroller,onWheel:this.onMouseWheel},this.props),s,this.props.children,n)}}I()(Cs,"propTypes",{trackHorizontalOverflow:xe.a.bool,verticalScrollsHorizontally:xe.a.bool});var ws=()=>{const[e,t]=Object(a.useState)(null);return Object(f.a)(J.b.instance,J.a,()=>{if(J.b.instance.getFirstNameFilterCondition()){const e=Object.values(J.b.instance.orderedLists).flat(1).length;t(e)}else t(null)}),"number"!=typeof e?null:i.a.createElement("div",{className:"mx_LeftPanel_roomListFilterCount"},Object(l.a)("%(count)s results",{count:e}))},Ss=s(344);const xs=(e,t)=>{try{const s=window.localStorage.getItem(e);return s?JSON.parse(s):t}catch(e){return t}},Rs=(e,t)=>{const s="mx_"+e,[n,i]=Object(a.useState)(xs(s,t));Object(a.useEffect)(()=>{i(xs(s,t))},[s,t]);return[n,Object(a.useCallback)(e=>{window.localStorage.setItem(s,JSON.stringify(e)),i(e)},[s])]};var Os=s(122);const ks=e=>e?e.getContent():void 0;var Is=s(291);const Ts=(e,t=null,s=!1)=>{const[n,i]=Object(a.useState)(F.a.getValue(e,t,s));return Object(a.useEffect)(()=>{const n=F.a.watchSetting(e,t,()=>{i(F.a.getValue(e,t,s))});return()=>{F.a.unwatchSetting(n)}},[e,t,s]),n};var js=({onResize:e})=>{const t=Object(a.useContext)(b.a),s=((e,t)=>{const[s,n]=Object(a.useState)(()=>ks(e.getAccountData(t))),i=Object(a.useCallback)(e=>{e.getType()===t&&n(e.getContent())},[t]);return Object(f.a)(e,"accountData",i),s||{}})(t,"m.widgets"),n=Ts("Widgets.leftPanel"),o=Object(a.useMemo)(()=>{if(!s||!n)return null;const e=Object.values(s).find(e=>e.id===n);return e?Os.a.makeAppConfig(e.state_key,e.content,e.sender,null,e.id):null},[s,n]),[r,l]=Rs("left-panel-widget-height",280),[c,d]=Rs("left-panel-widget-expanded",!0);Object(a.useEffect)(e,[c,e]);const[m,h,u]=Object(Y.e)(),p=h?0:-1;if(!o)return null;let g;return c&&(g=i.a.createElement(Ss.Resizable,{size:{height:r},minHeight:100,maxHeight:Math.min(window.innerHeight/2,500),onResize:e,onResizeStop:(e,t,s,n)=>{l(r+n.height)},handleWrapperClass:"mx_LeftPanelWidget_resizerHandles",handleClasses:{top:"mx_LeftPanelWidget_resizerHandle"},className:"mx_LeftPanelWidget_resizeBox",enable:{top:!0}},i.a.createElement(Is.a,{app:o,fullWidth:!0,show:!0,showMenubar:!1,userWidget:!0,userId:t.getUserId(),creatorUserId:o.creatorUserId,widgetPageTitle:Os.a.getWidgetDataTitle(o),waitForIframeLoad:o.waitForIframeLoad}))),i.a.createElement("div",{className:"mx_LeftPanelWidget"},i.a.createElement("div",{onFocus:m,className:"mx_LeftPanelWidget_headerContainer",onKeyDown:e=>{switch(e.key){case _s.a.ARROW_LEFT:e.stopPropagation(),d(!1);break;case _s.a.ARROW_RIGHT:e.stopPropagation(),d(!0)}}},i.a.createElement("div",{className:"mx_LeftPanelWidget_stickable"},i.a.createElement(pe.a,{onFocus:m,inputRef:u,tabIndex:p,className:"mx_LeftPanelWidget_headerText",role:"treeitem","aria-expanded":c,"aria-level":1,onClick:()=>{d(e=>!e)}},i.a.createElement("span",{className:L()({mx_LeftPanelWidget_collapseBtn:!0,mx_LeftPanelWidget_collapseBtn_collapsed:!c})}),i.a.createElement("span",null,Os.a.getWidgetName(o))))),g)},Ns=s(169);const Ps=["mx_RoomSearch_input","mx_RoomSearch_minimizedHandle","mx_RoomSublist_headerText","mx_RoomTile","mx_RoomSublist_showNButton"];class Ds extends a.Component{constructor(e){super(e),I()(this,"listContainerRef",Object(a.createRef)()),I()(this,"groupFilterPanelWatcherRef",void 0),I()(this,"bgImageWatcherRef",void 0),I()(this,"focusedElement",null),I()(this,"isDoingStickyHeaders",!1),I()(this,"onExplore",()=>{m.a.fire(h.a.ViewRoomDirectory)}),I()(this,"onBreadcrumbsUpdate",()=>{const e=fs.instance.visible;if(e!==this.state.showBreadcrumbs){if(this.setState({showBreadcrumbs:e}),!this.listContainerRef.current)return;this.handleStickyHeaders(this.listContainerRef.current)}}),I()(this,"onBackgroundImageUpdate",()=>{let e=p.a.instance.getHttpAvatarUrl(32);const t=F.a.getValue("RoomList.backgroundImage");t&&(e=ee.a.get().mxcUrlToHttp(t,32,32));let s=null;e&&(s=Ns.a.getUnencryptedContentUrl({url:E.a.imgUrlToUri(e)},!0));const n=`url(${s})`;e?document.body.style.getPropertyValue("--avatar-url")!==n&&document.body.style.setProperty("--avatar-url",n):document.body.style.removeProperty("--avatar-url")}),I()(this,"onScroll",e=>{const t=e.target;this.handleStickyHeaders(t)}),I()(this,"onResize",()=>{this.listContainerRef.current&&this.handleStickyHeaders(this.listContainerRef.current)}),I()(this,"onFocus",e=>{this.focusedElement=e.target}),I()(this,"onBlur",()=>{this.focusedElement=null}),I()(this,"onKeyDown",e=>{if(this.focusedElement)switch(e.key){case _s.a.ARROW_UP:case _s.a.ARROW_DOWN:e.stopPropagation(),e.preventDefault(),this.onMoveFocus(e.key===_s.a.ARROW_UP)}}),I()(this,"onEnter",()=>{const e=this.listContainerRef.current.querySelector(".mx_RoomTile");if(e)return e.click(),!0}),I()(this,"onMoveFocus",e=>{let t,s=this.focusedElement,n=!1;do{const a=e?s.lastElementChild:s.firstElementChild,i=e?s.previousElementSibling:s.nextElementSibling;n?a?s=a:i?s=i:(n=!1,s=s.parentElement):i?(s=i,n=!0):s=s.parentElement,s&&(t=s.classList)}while(s&&!Ps.some(e=>t.contains(e)));s&&(s.focus(),this.focusedElement=s)}),this.state={showBreadcrumbs:fs.instance.visible,showGroupFilterPanel:F.a.getValue("TagPanel.enableTagPanel")},fs.instance.on(g.b,this.onBreadcrumbsUpdate),J.b.instance.on(J.a,this.onBreadcrumbsUpdate),p.a.instance.on(g.b,this.onBackgroundImageUpdate),this.bgImageWatcherRef=F.a.watchSetting("RoomList.backgroundImage",null,this.onBackgroundImageUpdate),this.groupFilterPanelWatcherRef=F.a.watchSetting("TagPanel.enableTagPanel",null,()=>{this.setState({showGroupFilterPanel:F.a.getValue("TagPanel.enableTagPanel")})}),this.props.resizeNotifier.on("middlePanelResizedNoisy",this.onResize)}componentWillUnmount(){F.a.unwatchSetting(this.groupFilterPanelWatcherRef),F.a.unwatchSetting(this.bgImageWatcherRef),fs.instance.off(g.b,this.onBreadcrumbsUpdate),J.b.instance.off(J.a,this.onBreadcrumbsUpdate),p.a.instance.off(g.b,this.onBackgroundImageUpdate),this.props.resizeNotifier.off("middlePanelResizedNoisy",this.onResize)}handleStickyHeaders(e){this.isDoingStickyHeaders||(this.isDoingStickyHeaders=!0,window.requestAnimationFrame(()=>{this.doStickyHeaders(e),this.isDoingStickyHeaders=!1}))}doStickyHeaders(e){const t=e.scrollTop,s=e.offsetHeight+e.scrollTop,n=e.querySelectorAll(".mx_RoomSublist"),a=e.clientWidth-15,i=new Map;let o,r;for(const e of n){const a=e.querySelector(".mx_RoomSublist_stickable");a.style.removeProperty("display");const l=.4,c=e.offsetTop+l*Z.a<=t,d=e.offsetTop+l*Z.a>=s;c||e===n[0]?(i.set(a,{stickyTop:!0}),o&&(o.style.display="none",i.set(o,{makeInvisible:!0})),o=a):d&&!r?(i.set(a,{stickyBottom:!0}),r=a):i.set(a,{})}for(const t of i.keys()){const s=i.get(t);if(s.makeInvisible)t.style.display="none";else{if(s.stickyTop){t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")||t.classList.add("mx_RoomSublist_headerContainer_stickyTop");const s=e.parentElement.offsetTop+"px";t.style.top!==s&&(t.style.top=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyTop")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyTop"),t.style.top&&t.style.removeProperty("top");if(s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")||t.classList.add("mx_RoomSublist_headerContainer_stickyBottom");const s=window.innerHeight-(e.parentElement.offsetTop+e.parentElement.offsetHeight)+"px";t.style.bottom!==s&&(t.style.bottom=s)}else t.classList.contains("mx_RoomSublist_headerContainer_stickyBottom")&&t.classList.remove("mx_RoomSublist_headerContainer_stickyBottom"),t.style.bottom&&t.style.removeProperty("bottom");if(s.stickyTop||s.stickyBottom){t.classList.contains("mx_RoomSublist_headerContainer_sticky")||t.classList.add("mx_RoomSublist_headerContainer_sticky");const e=a+"px";t.style.width!==e&&(t.style.width=e)}else s.stickyTop||s.stickyBottom||(t.classList.contains("mx_RoomSublist_headerContainer_sticky")&&t.classList.remove("mx_RoomSublist_headerContainer_sticky"),t.style.width&&t.style.removeProperty("width"))}}const l=e.parentElement;o?l.classList.add("mx_LeftPanel_roomListWrapper_stickyTop"):l.classList.remove("mx_LeftPanel_roomListWrapper_stickyTop"),r?l.classList.add("mx_LeftPanel_roomListWrapper_stickyBottom"):l.classList.remove("mx_LeftPanel_roomListWrapper_stickyBottom")}renderHeader(){return a.createElement("div",{className:"mx_LeftPanel_userHeader"},a.createElement(hs,{isMinimized:this.props.isMinimized}))}renderBreadcrumbs(){if(this.state.showBreadcrumbs&&!this.props.isMinimized)return a.createElement(Cs,{className:"mx_LeftPanel_breadcrumbsContainer mx_AutoHideScrollbar",verticalScrollsHorizontally:!0,tabIndex:-1},a.createElement(Es,null))}renderSearchExplore(){const e=ee.a.get().getUserId();let t=null;return E.a.isUserExtern(e)||(t=a.createElement(B.a,{className:"mx_LeftPanel_exploreButton",onClick:this.onExplore,title:Object(l.a)("Explore rooms")})),a.createElement("div",{className:"mx_LeftPanel_filterContainer",onFocus:this.onFocus,onBlur:this.onBlur,onKeyDown:this.onKeyDown},a.createElement(us.a,{isMinimized:this.props.isMinimized,onVerticalArrow:this.onKeyDown,onEnter:this.onEnter}),t)}render(){const e=this.state.showGroupFilterPanel?a.createElement("div",{className:"mx_LeftPanel_GroupFilterPanelContainer"},a.createElement(H,null),F.a.getValue("feature_custom_tags")?a.createElement($,null):null):null;let t;t=this.props.isMinimized?a.createElement("div",{className:"tc_LeftPanel_Bottom_logo_collapsed"},a.createElement("img",{src:s(684),alt:"logo_rep_fr"})):a.createElement("div",{className:"tc_LeftPanel_Bottom"},a.createElement("div",{className:"tc_LeftPanel_Bottom_logo"},a.createElement("img",{src:s(684),alt:"logo_rep_fr"})),a.createElement("div",{className:"tc_LeftPanel_Bottom_links"},a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.faq,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("FAQ"))," · ",a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.tac,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("TAC"))," · ",a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.user_guide,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("User Guide"))));const n=a.createElement(we,{onKeyDown:this.onKeyDown,resizeNotifier:null,onFocus:this.onFocus,onBlur:this.onBlur,isMinimized:this.props.isMinimized,onResize:this.onResize}),i=L()({mx_LeftPanel:!0,mx_LeftPanel_hasGroupFilterPanel:!!e,mx_LeftPanel_minimized:this.props.isMinimized}),o=L()("mx_LeftPanel_actualRoomListContainer","mx_AutoHideScrollbar");return a.createElement("div",{className:i},e,a.createElement("aside",{className:"mx_LeftPanel_roomListContainer"},this.renderHeader(),this.renderSearchExplore(),this.renderBreadcrumbs(),a.createElement(ws,null),a.createElement("div",{className:"mx_LeftPanel_roomListWrapper"},a.createElement("div",{className:o,onScroll:this.onScroll,ref:this.listContainerRef,tabIndex:-1},n)),!this.props.isMinimized&&a.createElement(js,{onResize:this.onResize}),t))}}var As=s(209),Us="home_page",Ms="room_view",Ls="room_directory",Fs="user_view",Bs="group_view",Vs="my_groups";async function Ws(){console.log("Checking for COLR support");const{userAgent:e}=navigator;if(e.includes("Firefox"))return console.log("Browser is Firefox - assuming COLR is supported"),!0;if(!e.includes("Chrome")&&e.includes("Safari"))return function(e){console.log("Browser is Safari - checking version for COLR support");try{const t=e.match(/Mac OS X ([\d|_]+).*Version\/([\d|.]+).*Safari/);if(t){const e=t[1],s=t[2],n=e.split("_").map(e=>parseInt(e,10)),a=s.split(".").map(e=>parseInt(e,10)),i=n[0]>=10&&n[1]>=14&&a[0]>=12;return console.log(`COLR support on Safari requires macOS 10.14 and Safari 12, detected Safari ${s} on macOS ${e}, COLR supported: `+i),i}}catch(e){console.error("Error in Safari COLR version check",e)}return console.warn("Couldn't determine Safari version to check COLR font support, assuming no."),!1}(e);try{const e=document.createElement("canvas"),t=e.getContext("2d"),s=new Image,n=`\n        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="100" style="background:#fff;fill:#000;">\n            <style type="text/css">\n                @font-face {\n                    font-family: "chromacheck-colr";\n                    src: url(data:application/x-font-woff;base64,${"d09GRgABAAAAAAKAAAwAAAAAAowAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABDT0xSAAACVAAAABYAAAAYAAIAJUNQQUwAAAJsAAAAEgAAABLJAAAQT1MvMgAAAYAAAAA6AAAAYBfxJ0pjbWFwAAABxAAAACcAAAAsAAzpM2dseWYAAAH0AAAAGgAAABoNIh0kaGVhZAAAARwAAAAvAAAANgxLumdoaGVhAAABTAAAABUAAAAkCAEEAmhtdHgAAAG8AAAABgAAAAYEAAAAbG9jYQAAAewAAAAGAAAABgANAABtYXhwAAABZAAAABsAAAAgAg4AHW5hbWUAAAIQAAAAOAAAAD4C5wsecG9zdAAAAkgAAAAMAAAAIAADAAB4AWNgZGAAYQ5+qdB4fpuvDNIsDCBwaQGTAIi+VlscBaJZGMDiHAxMIAoAtjIF/QB4AWNgZGBgYQACOAkUQQWMAAGRABAAAAB4AWNgZGBgYGJgAdMMUJILJMQgAWICAAH3AC4AeAFjYGFhYJzAwMrAwDST6QwDA0M/hGZ8zWDMyMmAChgFkDgKQMBw4CXDSwYWEBdIYgAFBgYA/8sIdAAABAAAAAAAAAB4AWNgYGBkYAZiBgYeBhYGBSDNAoRA/kuG//8hpDgjWJ4BAFVMBiYAAAAAAAANAAAAAQAAAAAEAAQAAAMAABEhESEEAPwABAD8AAAAeAEtxgUNgAAAAMHHIQTShTlOAty9/4bf7AARCwlBNhBw4L/43qXjYGUmf19TMuLcj/BJL3XfBg54AWNgZsALAAB9AAR4AWNgYGAEYj4gFgGygGwICQACOwAoAAAAAAABAAEAAQAAAA4AAAAAyP8AAA=="}) format("woff");\n                }\n            </style>\n            <text x="0" y="0" font-size="20">\n                <tspan font-family="chromacheck-colr" x="0" dy="20">&#xe900;</tspan>\n            </text>\n        </svg>`;e.width=20,e.height=100,s.src="data:image/svg+xml;charset=utf-8,"+encodeURIComponent(n),console.log("Waiting for COLR SVG to load"),await new Promise(e=>s.onload=e),console.log("Drawing canvas to detect COLR support"),t.drawImage(s,0,0);const a=200===t.getImageData(10,10,1,1).data[0];return console.log("Canvas check revealed COLR is supported? "+a),a}catch(e){return console.error("Couldn't load COLR font",e),!1}}let Hs=!1;async function Gs(){if(!Hs)if(Hs=!0,await Ws()){const e=`url('${s(1171)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:600})),document.fonts.add(new FontFace("Twemoji",e,{weight:700}))}else{const e=`url('${s(1172)}')`;document.fonts.add(new FontFace("Twemoji",e,{})),document.fonts.add(new FontFace("Twemoji",e,{weight:600})),document.fonts.add(new FontFace("Twemoji",e,{weight:700}))}}class qs extends i.a.Component{constructor(e){super(e),I()(this,"onFinished",()=>{window.localStorage&&window.localStorage.setItem("tc_validate_encryption_informations","done"),this.props.onFinished()})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return i.a.createElement(e,{className:"mx_InfoDialog",onFinished:this.props.onFinished,title:Object(l.a)("Welcome to Tchap!"),contentId:"mx_Dialog_content",hasCancel:!0},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Tchap is the secure instant messaging service of the French State.")),i.a.createElement("p",null,Object(l.a)("All exchanges are end-to-end encrypted and accessible only using digital keys saved on your devices (<a>find out more</a>).",{},{a:e=>i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.encryption_info,rel:"noreferrer nofollow noopener",target:"_blank"},e)})),i.a.createElement("p",null,Object(l.a)("<b>Warning</b>: for an optimal experience, it's recommended to always stay connected.",{},{b:e=>i.a.createElement("b",null,e)}))),i.a.createElement("div",{className:"tc_ThreeColumn_block"},i.a.createElement("div",{className:"tc_ThreeColumn_block_bordered"},i.a.createElement("div",{className:"tc_ThreeColumn_block_content"},i.a.createElement("div",{className:"tc_ThreeColumn_block_image"},i.a.createElement("img",{src:s(672),alt:"Login logo",width:"50"})),i.a.createElement("p",null,Object(l.a)("Stay connected from at least one device")),i.a.createElement("p",null,i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.mobile_info,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("Why?")))),i.a.createElement("p",{className:"tc_ThreeColumn_block_separator"},Object(l.a)("OR"))),i.a.createElement("div",{className:"tc_ThreeColumn_block_bordered"},i.a.createElement("div",{className:"tc_ThreeColumn_block_content"},i.a.createElement("div",{className:"tc_ThreeColumn_block_image"},i.a.createElement("img",{src:s(673),alt:"Tchap logo",width:"60"})),i.a.createElement("p",null,Object(l.a)("Connect also with the mobile app")),i.a.createElement("p",null,i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.mobile_download,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("Download")))),i.a.createElement("p",{className:"tc_ThreeColumn_block_separator"},Object(l.a)("OR"))),i.a.createElement("div",{className:"tc_ThreeColumn_block_last"},i.a.createElement("div",{className:"tc_ThreeColumn_block_content"},i.a.createElement("div",{className:"tc_ThreeColumn_block_image"},i.a.createElement("img",{src:s(1173),alt:"Browser off logo",width:"70"})),i.a.createElement("p",null,Object(l.a)("Disable automatic logout on your browser")),i.a.createElement("p",null,i.a.createElement("a",{href:c.a.get().base_host_url+c.a.get().generic_endpoints.browser_session_info,rel:"noreferrer nofollow noopener",target:"_blank"},Object(l.a)("How?"))))))),i.a.createElement(t,{primaryButton:Object(l.a)("I understand"),onPrimaryButtonClick:this.onFinished,hasCancel:!1}))}}I()(qs,"propTypes",{onFinished:xe.a.func.isRequired});var Ks=s(367);class zs{static moveTag(e,t,s){let n=P.a.getOrderedTags(),a=P.a.getRemovedTagsAccountData()||[];if(!n)return;n=n.filter(e=>e!==t),n=[...n.slice(0,s),t,...n.slice(s)],a=a.filter(e=>e!==t);const i=P.a.getStoreId();return Object(D.a)("TagOrderActions.moveTag",()=>(_.a.trackEvent("TagOrderActions","commitTagOrdering"),e.setAccountData("im.vector.web.tag_ordering",{tags:n,removedTags:a,_storeId:i})),()=>({tags:n,removedTags:a}))}static removeTag(e,t){const s=P.a.getOrderedTags(),n=P.a.getRemovedTagsAccountData()||[];if(n.includes(t))return new Ks.a(()=>{});n.push(t);const a=P.a.getStoreId();return Object(D.a)("TagOrderActions.removeTag",()=>(_.a.trackEvent("TagOrderActions","removeTag"),e.setAccountData("im.vector.web.tag_ordering",{tags:s,removedTags:n,_storeId:a})),()=>({removedTags:n}))}}var $s=s(643),Ys=s(465),Js=s(354),Qs=(s(466),s(685));class Xs extends Qs.a{notifyCollapsed(e){const t=this.resizer.config.onCollapsed;t&&t(e,this.id,this.domNode)}}class Zs extends Js.a{static createItem(e,t,s){return new Xs(e,t,s)}constructor(e){var t,s;super(e),I()(this,"toggleSize",void 0),I()(this,"isCollapsed",!1),this.toggleSize=null===(t=e.resizer)||void 0===t||null===(s=t.config)||void 0===s?void 0:s.toggleSize}resize(e){const t=e<this.toggleSize;t&&!this.isCollapsed?(this.isCollapsed=!0,this.item.notifyCollapsed(!0)):!t&&this.isCollapsed&&(this.item.notifyCollapsed(!1),this.isCollapsed=!1),t||super.resize(e)}}var en=s(467),tn=s(158),sn=s(138);function nn(e,t,s,n){let a=s[e];void 0===a&&(a=s[""]);const i=e=>t?React.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e):e;return a.includes("<a>")?Object(l.a)(a,{},Object.assign({a:i},n)):Object(l.a)(a,{},n)}const an=()=>{sn.a.sharedInstance().dismissToast("serverlimit")};var on=s(199),rn=s(450),ln=s(127);class cn extends i.a.Component{constructor(e){super(e),I()(this,"dispatcherRef",void 0),I()(this,"onAction",e=>{switch(e.action){case"call_state":{const t=fe.b.sharedInstance().getCallForRoom(e.room_id);t&&t.state===ln.e.Ringing?this.setState({incomingCall:t}):this.setState({incomingCall:null})}}}),I()(this,"onAnswerClick",e=>{e.stopPropagation(),m.a.dispatch({action:"answer",room_id:fe.b.roomIdForCall(this.state.incomingCall)})}),I()(this,"onRejectClick",e=>{e.stopPropagation(),m.a.dispatch({action:"reject",room_id:fe.b.roomIdForCall(this.state.incomingCall)})}),this.dispatcherRef=m.a.register(this.onAction),this.state={incomingCall:null}}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}render(){if(!this.state.incomingCall)return null;let e=null;this.state.incomingCall&&(e=ee.a.get().getRoom(fe.b.roomIdForCall(this.state.incomingCall)));const t=e?e.name:Object(l.a)("Unknown caller");let s=null;return this.state.incomingCall&&(s="voice"===this.state.incomingCall.type?Object(l.a)("Incoming voice call"):"video"===this.state.incomingCall.type?Object(l.a)("Incoming video call"):Object(l.a)("Incoming call")),i.a.createElement("div",{className:"mx_IncomingCallBox"},i.a.createElement("div",{className:"mx_IncomingCallBox_CallerInfo"},i.a.createElement(on.a,{room:e,height:32,width:32}),i.a.createElement("div",null,i.a.createElement("h1",null,t),i.a.createElement("p",null,s))),i.a.createElement("div",{className:"mx_IncomingCallBox_buttons"},i.a.createElement(rn.a,{className:"mx_IncomingCallBox_decline",onClick:this.onRejectClick,kind:"danger",label:Object(l.a)("Decline")}),i.a.createElement("div",{className:"mx_IncomingCallBox_spacer"}),i.a.createElement(rn.a,{className:"mx_IncomingCallBox_accept",onClick:this.onAnswerClick,kind:"primary",label:Object(l.a)("Accept")})))}}var dn=s(468),mn=s(244);class hn extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{roomId:Q.a.getRoomId(),persistentWidgetId:mn.a.getPersistentWidgetId()}),I()(this,"_onRoomViewStoreUpdate",e=>{Q.a.getRoomId()!==this.state.roomId&&this.setState({roomId:Q.a.getRoomId()})}),I()(this,"_onActiveWidgetStoreUpdate",()=>{this.setState({persistentWidgetId:mn.a.getPersistentWidgetId()})})}componentDidMount(){this._roomStoreToken=Q.a.addListener(this._onRoomViewStoreUpdate),mn.a.on("update",this._onActiveWidgetStoreUpdate)}componentWillUnmount(){this._roomStoreToken&&this._roomStoreToken.remove(),mn.a.removeListener("update",this._onActiveWidgetStoreUpdate)}render(){if(this.state.persistentWidgetId){const e=mn.a.getRoomId(this.state.persistentWidgetId);if(this.state.roomId!==e){const t=ee.a.get().getRoom(e);if(!t)return null;const s=Os.a.getRoomWidgets(t).find(e=>e.getStateKey()===mn.a.getPersistentWidgetId()),n=Os.a.makeAppConfig(s.getStateKey(),s.getContent(),s.getSender(),e,s.getId()),a=d.getComponent("elements.AppTile");return i.a.createElement(a,{key:n.id,app:n,fullWidth:!0,room:t,userId:ee.a.get().credentials.userId,creatorUserId:n.creatorUserId,widgetPageTitle:Os.a.getWidgetDataTitle(n),waitForIframeLoad:n.waitForIframeLoad,miniMode:!0,showMenubar:!1})}}return null}}const un=[ln.e.Connected,ln.e.InviteSent,ln.e.Connecting,ln.e.CreateAnswer,ln.e.CreateOffer,ln.e.WaitLocalMedia];function pn(e){let t=null,s=[];for(const n of e)un.includes(n.state)&&(n.isRemoteOnHold()||null!==t?s.push(n):t=n);return null===t&&s.length>0&&(t=s[0],s=s.slice(1)),s.length>1&&console.log("Found more than 1 secondary call! Other calls will not be shown."),[t,s]}class gn extends i.a.Component{constructor(e){super(e),I()(this,"roomStoreToken",void 0),I()(this,"dispatcherRef",void 0),I()(this,"settingsWatcherRef",void 0),I()(this,"onRoomViewStoreUpdate",e=>{if(Q.a.getRoomId()===this.state.roomId)return;const t=Q.a.getRoomId(),[s,n]=pn(fe.b.sharedInstance().getAllActiveCallsNotInRoom(t));this.setState({roomId:t,primaryCall:s,secondaryCall:n[0]})}),I()(this,"onAction",e=>{switch(e.action){case"call_state":{const[e,t]=pn(fe.b.sharedInstance().getAllActiveCallsNotInRoom(this.state.roomId));this.setState({primaryCall:e,secondaryCall:t[0]});break}}}),I()(this,"onCallRemoteHold",()=>{const[e,t]=pn(fe.b.sharedInstance().getAllActiveCallsNotInRoom(this.state.roomId));this.setState({primaryCall:e,secondaryCall:t[0]})});const t=Q.a.getRoomId(),[s,n]=pn(fe.b.sharedInstance().getAllActiveCallsNotInRoom(t));this.state={roomId:t,primaryCall:s,secondaryCall:n[0]}}componentDidMount(){this.roomStoreToken=Q.a.addListener(this.onRoomViewStoreUpdate),this.dispatcherRef=m.a.register(this.onAction),ee.a.get().on(ln.c.RemoteHoldUnhold,this.onCallRemoteHold)}componentWillUnmount(){ee.a.get().removeListener(ln.c.RemoteHoldUnhold,this.onCallRemoteHold),this.roomStoreToken&&this.roomStoreToken.remove(),m.a.unregister(this.dispatcherRef),F.a.unwatchSetting(this.settingsWatcherRef)}render(){return this.state.primaryCall?i.a.createElement(dn.a,{call:this.state.primaryCall,secondaryCall:this.state.secondaryCall,pipMode:!0}):i.a.createElement(hn,null)}}class fn extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_CallContainer"},i.a.createElement(cn,null),i.a.createElement(gn,null))}}var bn=s(650);class vn extends a.PureComponent{constructor(e,t){super(e,t),I()(this,"onUpdateToasts",()=>{this.setState({toasts:bn.a.instance.components})}),this.state={toasts:bn.a.instance.components},bn.a.instance.on(g.b,this.onUpdateToasts)}componentWillUnmount(){bn.a.instance.off(g.b,this.onUpdateToasts)}render(){const e=this.state.toasts.map((e,t)=>a.createElement("div",{className:"mx_NonUrgentToastContainer_toast",key:"toast-"+t},a.createElement(e,{})));return a.createElement("div",{className:"mx_NonUrgentToastContainer",role:"alert"},e)}}var _n=s(352);let yn;!function(e){e.CloseDialog="close_dialog",e.HostSignupAccountDetails="host_signup_account_details",e.HostSignupAccountDetailsRequest="host_signup_account_details_request",e.Minimize="host_signup_minimize",e.Maximize="host_signup_maximize",e.SetupComplete="setup_complete"}(yn||(yn={}));class En extends i.a.PureComponent{constructor(e){super(e),I()(this,"iframeRef",i.a.createRef()),I()(this,"config",void 0),I()(this,"messageHandler",async e=>{if(this.config.url.startsWith(e.origin))switch(e.data.action){case yn.HostSignupAccountDetailsRequest:this.onAccountDetailsRequest();break;case yn.Maximize:this.setState({minimized:!1});break;case yn.Minimize:this.setState({minimized:!0});break;case yn.SetupComplete:this.setState({completed:!0});break;case yn.CloseDialog:return this.closeDialog()}}),I()(this,"maximizeDialog",()=>{this.setState({minimized:!1}),this.sendMessage({action:yn.Maximize})}),I()(this,"minimizeDialog",()=>{this.setState({minimized:!0}),this.sendMessage({action:yn.Minimize})}),I()(this,"closeDialog",async()=>(window.removeEventListener("message",this.messageHandler),_n.a.destroyElement("host_signup"),j.instance.setHostSignupActive(!1))),I()(this,"onCloseClick",async()=>{if(this.state.completed)return this.closeDialog();De.a.createDialog(St.a,{title:Object(l.a)("Confirm abort of host creation"),description:Object(l.a)("Are you sure you wish to abort creation of the host? The process cannot be continued."),button:Object(l.a)("Abort"),onFinished:e=>{if(e)return this.closeDialog()}})}),I()(this,"sendMessage",e=>{this.iframeRef.current.contentWindow.postMessage(e,this.config.url)}),I()(this,"onAccountDetailsDialogFinished",async e=>e?this.sendAccountDetails():this.closeDialog()),I()(this,"onAccountDetailsRequest",()=>{const e=i.a.createElement(i.a.Fragment,null,i.a.createElement("p",null,Object(l.a)("Continuing temporarily allows the %(hostSignupBrand)s setup process to access your account to fetch verified email addresses. This data is not stored.",{hostSignupBrand:this.config.brand})),i.a.createElement("p",null,Object(l.a)("Learn more in our <privacyPolicyLink />, <termsOfServiceLink /> and <cookiePolicyLink />.",{},{cookiePolicyLink:()=>i.a.createElement("a",{href:this.config.cookiePolicyUrl,target:"_blank",rel:"noreferrer noopener"},Object(l.a)("Cookie Policy")),privacyPolicyLink:()=>i.a.createElement("a",{href:this.config.privacyPolicyUrl,target:"_blank",rel:"noreferrer noopener"},Object(l.a)("Privacy Policy")),termsOfServiceLink:()=>i.a.createElement("a",{href:this.config.termsOfServiceUrl,target:"_blank",rel:"noreferrer noopener"},Object(l.a)("Terms of Service"))})));De.a.createDialog(St.a,{title:Object(l.a)("You should know"),description:e,button:Object(l.a)("Continue"),onFinished:this.onAccountDetailsDialogFinished})}),this.state={completed:!1,error:null,minimized:!1},this.config=c.a.get().hostSignup}async sendAccountDetails(){const e=await ee.a.get().getOpenIdToken();if(!e||!e.access_token)return console.warn("Failed to connect to homeserver for OpenID token."),void this.setState({completed:!0,error:Object(l.a)("Failed to connect to your homeserver. Please close this dialog and try again.")});this.sendMessage({action:yn.HostSignupAccountDetails,account:{accessToken:await ee.a.get().getAccessToken(),name:p.a.instance.displayName,openIdToken:e.access_token,serverName:await ee.a.get().getDomain(),userLocalpart:await ee.a.get().getUserIdLocalpart(),termsAccepted:!0}})}componentDidMount(){window.addEventListener("message",this.messageHandler)}componentWillUnmount(){if(j.instance.isHostSignupActive)return this.closeDialog()}render(){return i.a.createElement("div",{className:"mx_HostSignup_persisted"},i.a.createElement(_n.a,{key:"host_signup",persistKey:"host_signup"},i.a.createElement("div",{className:L()({mx_Dialog_wrapper:!this.state.minimized})},i.a.createElement("div",{className:L()("mx_Dialog",{mx_HostSignupDialog_minimized:this.state.minimized,mx_HostSignupDialog:!this.state.minimized})},this.state.minimized&&i.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithButton"},i.a.createElement("div",{className:"mx_Dialog_title"},Object(l.a)("%(hostSignupBrand)s Setup",{hostSignupBrand:this.config.brand})),i.a.createElement(pe.a,{className:"mx_HostSignup_maximize_button",onClick:this.maximizeDialog,"aria-label":Object(l.a)("Maximize dialog"),title:Object(l.a)("Maximize dialog")})),!this.state.minimized&&i.a.createElement("div",{className:"mx_Dialog_header mx_Dialog_headerWithCancel"},i.a.createElement(pe.a,{onClick:this.minimizeDialog,className:"mx_HostSignup_minimize_button","aria-label":Object(l.a)("Minimize dialog"),title:Object(l.a)("Minimize dialog")}),i.a.createElement(pe.a,{onClick:this.onCloseClick,className:"mx_Dialog_cancelButton","aria-label":Object(l.a)("Close dialog"),title:Object(l.a)("Close dialog")})),this.state.error&&i.a.createElement("div",null,this.state.error),!this.state.error&&i.a.createElement("iframe",{src:this.config.url,ref:this.iframeRef,sandbox:"allow-forms allow-scripts allow-same-origin allow-popups"})))))}}var Cn=()=>{const[e,t]=Object(a.useState)(j.instance.isHostSignupActive);return Object(f.a)(j.instance,g.b,()=>{t(j.instance.isHostSignupActive)}),i.a.createElement("div",{className:"mx_HostSignupContainer"},e&&i.a.createElement(En,null))};function wn(e){return"INPUT"===e.tagName||"TEXTAREA"===e.tagName||"SELECT"===e.tagName||!!e.getAttribute("contenteditable")}class Sn extends a.Component{constructor(e,t){super(e,t),I()(this,"_matrixClient",void 0),I()(this,"_roomView",void 0),I()(this,"_resizeContainer",void 0),I()(this,"compactLayoutWatcherRef",void 0),I()(this,"resizer",void 0),I()(this,"canResetTimelineInRoom",e=>!this._roomView.current||this._roomView.current.canResetTimeline()),I()(this,"onAccountData",e=>{"m.ignored_user_list"===e.getType()&&m.a.dispatch({action:"ignore_state_changed"})}),I()(this,"onCompactLayoutChanged",(e,t,s,n,a)=>{this.setState({useCompactLayout:n})}),I()(this,"onSync",(e,t,s)=>{const n=this.state.syncErrorData&&this.state.syncErrorData.error&&this.state.syncErrorData.error.errcode,a=s&&s.error&&s.error.errcode;e===t&&n===a||("ERROR"===e?this.setState({syncErrorData:s}):this.setState({syncErrorData:null}),"PREPARED"===t&&"SYNCING"===e?this._updateServerNoticeEvents():this._calculateServerLimitToast(this.state.syncErrorData,this.state.usageLimitEventContent))}),I()(this,"onRoomStateEvents",(e,t)=>{const s=J.b.instance.orderedLists[X.a.ServerNotice];s&&s.some(t=>t.roomId===e.getRoomId())&&this._updateServerNoticeEvents()}),I()(this,"_updateServerNoticeEvents",async()=>{const e=J.b.instance.orderedLists[X.a.ServerNotice];if(!e)return[];const t=[];for(const s of e){const e=s.currentState.getStateEvents("m.room.pinned_events","");if(!e||!e.getContent().pinned)continue;const n=e.getContent().pinned.slice(0,2);for(const e of n){const n=(await this._matrixClient.getEventTimeline(s.getUnfilteredTimelineSet(),e,0)).getEvents().find(t=>t.getId()===e);n&&t.push(n)}}const s=t.find(e=>e&&"m.room.message"===e.getType()&&"m.server_notice.usage_limit_reached"===e.getContent().server_notice_type),n=s&&s.getContent();this._calculateServerLimitToast(this.state.syncErrorData,n),this.setState({usageLimitEventContent:n})}),I()(this,"_onPaste",e=>{let t=!1,s=e.target;for(;!t&&s;)t=wn(s),s=s.parentElement;t||m.a.fire(h.a.FocusComposer,!0)}),I()(this,"_onReactKeyDown",e=>{this._onKeyDown(e)}),I()(this,"_onNativeKeyDown",e=>{e.target===document.body&&this._onKeyDown(e)}),I()(this,"_onKeyDown",e=>{let t=!1;const s=Object(_s.d)(e),n=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey,a=e.key===_s.a.ALT||e.key===_s.a.CONTROL||e.key===_s.a.META||e.key===_s.a.SHIFT,i=_s.b?e.metaKey:e.ctrlKey;switch(e.key){case _s.a.PAGE_UP:case _s.a.PAGE_DOWN:n||a||(this._onScrollKeyPressed(e),t=!0);break;case _s.a.HOME:case _s.a.END:!e.ctrlKey||e.shiftKey||e.altKey||e.metaKey||(this._onScrollKeyPressed(e),t=!0);break;case _s.a.K:s&&(m.a.dispatch({action:"focus_room_filter"}),t=!0);break;case _s.a.F:s&&F.a.getValue("ctrlFForSearch")&&(m.a.dispatch({action:"focus_search"}),t=!0);break;case _s.a.BACKTICK:s&&(m.a.fire(h.a.ToggleUserMenu),t=!0);break;case _s.a.SLASH:Object(_s.c)(e)&&(Ht.d(),t=!0);break;case _s.a.H:e.altKey&&i&&(m.a.dispatch({action:"view_home_page"}),De.a.closeCurrentModal("homeKeyboardShortcut"),t=!0);break;case _s.a.ARROW_UP:case _s.a.ARROW_DOWN:!e.altKey||e.ctrlKey||e.metaKey||(m.a.dispatch({action:h.a.ViewRoomDelta,delta:e.key===_s.a.ARROW_UP?-1:1,unread:e.shiftKey}),t=!0);break;case _s.a.PERIOD:!s||"room_view"!==this.props.page_type&&"group_view"!==this.props.page_type||(m.a.dispatch({action:h.a.ToggleRightPanel,type:"room_view"===this.props.page_type?"room":"group"}),t=!0);break;default:t=qe.a.get().onKeyDown(e)}if(t)e.stopPropagation(),e.preventDefault();else if(!(a||e.altKey||e.ctrlKey||e.metaKey)){const t=e.target!==document.body&&(e.key===_s.a.SPACE||e.key===_s.a.ENTER);if(e.key===_s.a.CONTEXT_MENU)return;t||e.key===_s.a.TAB||wn(e.target)||(m.a.fire(h.a.FocusComposer,!0),e.stopPropagation())}}),I()(this,"_onScrollKeyPressed",e=>{this._roomView.current&&this._roomView.current.handleScrollKey(e)}),I()(this,"_onDragEnd",e=>{if(!e.destination)return;const t=e.destination.droppableId;if("tag-panel-droppable"===t){const t=e.draggableId.split(" ").pop();m.a.dispatch(zs.moveTag(this._matrixClient,t,e.destination.index),!0)}else t.startsWith("room-sub-list-droppable_")&&this._onRoomTileEndDrag(e)}),I()(this,"_onRoomTileEndDrag",e=>{let t=e.destination.droppableId.split("_")[1],s=e.source.droppableId.split("_")[1];"undefined"===t&&(t=void 0),"undefined"===s&&(s=void 0);const n=e.draggableId.split("_")[1],a=e.source.index,i=e.destination.index;m.a.dispatch($s.a.tagRoom(this._matrixClient,this._matrixClient.getRoom(n),s,t,a,i),!0)}),this.state={syncErrorData:void 0,useCompactLayout:F.a.getValue("useCompactLayout")},window.localStorage&&!window.localStorage.getItem("tc_validate_encryption_informations")&&De.a.createTrackedDialog("","",qs),this._matrixClient=this.props.matrixClient,F.a.getValue(Xe.a.Voip)&&At(),Gs(),this._roomView=a.createRef(),this._resizeContainer=a.createRef()}componentDidMount(){document.addEventListener("keydown",this._onNativeKeyDown,!1),this._updateServerNoticeEvents(),this._matrixClient.on("accountData",this.onAccountData),this._matrixClient.on("sync",this.onSync),this.onSync(this._matrixClient.getSyncState(),null,this._matrixClient.getSyncStateData()),this._matrixClient.on("RoomState.events",this.onRoomStateEvents),this.compactLayoutWatcherRef=F.a.watchSetting("useCompactLayout",null,this.onCompactLayoutChanged),this.resizer=this._createResizer(),this.resizer.attach(),this._loadResizerPreferences()}componentWillUnmount(){document.removeEventListener("keydown",this._onNativeKeyDown,!1),this._matrixClient.removeListener("accountData",this.onAccountData),this._matrixClient.removeListener("sync",this.onSync),this._matrixClient.removeListener("RoomState.events",this.onRoomStateEvents),F.a.unwatchSetting(this.compactLayoutWatcherRef),this.resizer.detach()}shouldComponentUpdate(){return Boolean(ee.a.get())}_createResizer(){let e,t;const s={toggleSize:210,onCollapsed:e=>{t=e,e?(m.a.dispatch({action:"hide_left_panel"},!0),window.localStorage.setItem("mx_lhs_size","0")):m.a.dispatch({action:"show_left_panel"},!0)},onResized:t=>{e=t,this.props.resizeNotifier.notifyLeftHandleResized()},onResizeStart:()=>{this.props.resizeNotifier.startResizing()},onResizeStop:()=>{t||window.localStorage.setItem("mx_lhs_size",""+e),this.props.resizeNotifier.stopResizing()}},n=new en.a(this._resizeContainer.current,Zs,s);return n.setClassNames({handle:"mx_ResizeHandle",vertical:"mx_ResizeHandle_vertical",reverse:"mx_ResizeHandle_reverse"}),n}_loadResizerPreferences(){let e=parseInt(window.localStorage.getItem("mx_lhs_size"),10);isNaN(e)&&(e=350),this.resizer.forHandleAt(0).resize(e)}_calculateServerLimitToast(e,t){const s=e&&e.error&&"M_RESOURCE_LIMIT_EXCEEDED"===e.error.errcode;s&&(t=e.error.data),t?((e,t,s)=>{const n=nn(e,t,{monthly_active_user:Object(l.b)("Your homeserver has exceeded its user limit."),"":Object(l.b)("Your homeserver has exceeded one of its resource limits.")}),a=nn(e,t,{"":Object(l.b)("Contact your <a>server admin</a>.")});sn.a.sharedInstance().addOrReplaceToast({key:"serverlimit",title:Object(l.a)("Warning"),props:{description:i.a.createElement(i.a.Fragment,null,n," ",a),acceptLabel:Object(l.a)("Ok"),onAccept:an},component:tn.a,priority:70})})(t.limit_type,t.admin_contact):an()}render(){const e=d.getComponent("structures.RoomView"),t=d.getComponent("structures.UserView"),s=d.getComponent("structures.GroupView"),n=d.getComponent("structures.MyGroups"),i=d.getComponent("structures.ToastContainer");let o;switch(this.props.page_type){case Ms:o=a.createElement(e,{ref:this._roomView,autoJoin:this.props.autoJoin,onRegistered:this.props.onRegistered,threepidInvite:this.props.threepidInvite,oobData:this.props.roomOobData,viaServers:this.props.viaServers,key:this.props.currentRoomId||"roomview",resizeNotifier:this.props.resizeNotifier});break;case Vs:o=a.createElement(n,null);break;case Ls:break;case Us:o=a.createElement(O,{justRegistered:this.props.justRegistered});break;case Fs:o=a.createElement(t,{userId:this.props.currentUserId,resizeNotifier:this.props.resizeNotifier});break;case Bs:o=a.createElement(s,{groupId:this.props.currentGroupId,isNew:this.props.currentGroupIsNew,resizeNotifier:this.props.resizeNotifier})}let r="mx_MatrixChat";this.state.useCompactLayout&&(r+=" mx_MatrixChat_useCompactLayout");const l=a.createElement(Ds,{isMinimized:this.props.collapseLhs||!1,resizeNotifier:this.props.resizeNotifier});return a.createElement(b.a.Provider,{value:this._matrixClient},a.createElement("div",{onPaste:this._onPaste,onKeyDown:this._onReactKeyDown,className:"mx_MatrixChat_wrapper","aria-hidden":this.props.hideToSRUsers},a.createElement(i,null),a.createElement(U.DragDropContext,{onDragEnd:this._onDragEnd},a.createElement("div",{ref:this._resizeContainer,className:r},l,a.createElement(Ys.a,null),o))),a.createElement(fn,null),a.createElement(vn,null),a.createElement(Cn,null))}}I()(Sn,"displayName","LoggedInView"),I()(Sn,"propTypes",{matrixClient:Se.instanceOf(As.b).isRequired,page_type:Se.string.isRequired,onRoomCreated:Se.func,onRegistered:Se.func,viaServers:Se.arrayOf(Se.string)});var xn=Sn,Rn=s(210),On=s(166);s(1174),s(1175);function kn(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function In(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?kn(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):kn(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class Tn{constructor(e,t){this.failedEventId=e,this.errorCode=t,this.ts=Date.now()}}class jn{constructor(e,t){if(I()(this,"failures",[]),I()(this,"failureCounts",{}),I()(this,"trackedEventHashMap",{}),I()(this,"checkInterval",null),I()(this,"trackInterval",null),!e||"function"!=typeof e)throw new Error("DecryptionFailureTracker requires tracking function");if(t&&"function"!=typeof t)throw new Error("DecryptionFailureTracker second constructor argument should be a function");this._trackDecryptionFailure=e,this._mapErrorCode=t}eventDecrypted(e,t){t?this.addDecryptionFailure(new Tn(e.getId(),t.code)):this.removeDecryptionFailuresForEvent(e)}addDecryptionFailure(e){this.failures.push(e)}removeDecryptionFailuresForEvent(e){this.failures=this.failures.filter(t=>t.failedEventId!==e.getId())}start(){this.checkInterval=setInterval(()=>this.checkFailures(Date.now()),jn.CHECK_INTERVAL_MS),this.trackInterval=setInterval(()=>this.trackFailures(),jn.TRACK_INTERVAL_MS)}stop(){clearInterval(this.checkInterval),clearInterval(this.trackInterval),this.failures=[],this.failureCounts={}}checkFailures(e){const t=[],s=[];for(;this.failures.length>0;){const n=this.failures.shift();e>n.ts+jn.GRACE_PERIOD_MS?t.push(n):s.push(n)}this.failures=s;const n=t.reduce((e,t)=>this.trackedEventHashMap[t.failedEventId]?e:e.set(t.failedEventId,t),new Map),a=[...n.keys()];this.trackedEventHashMap=a.reduce((e,t)=>In(In({},e),{},{[t]:!0}),this.trackedEventHashMap);const i=n.values();this._aggregateFailures(i)}_aggregateFailures(e){for(const t of e){const e=t.errorCode;this.failureCounts[e]=(this.failureCounts[e]||0)+1}}trackFailures(){for(const e of Object.keys(this.failureCounts))if(this.failureCounts[e]>0){const t=this._mapErrorCode?this._mapErrorCode(e):e;this._trackDecryptionFailure(this.failureCounts[e],t),this.failureCounts[e]=0}}}I()(jn,"TRACK_INTERVAL_MS",6e4),I()(jn,"CHECK_INTERVAL_MS",5e3),I()(jn,"GRACE_PERIOD_MS",6e4);var Nn=s(249),Pn=s(289),Dn=s(282),An=s(407),Un=s(301);const Mn={deferred_action:null};class Ln extends Un.Store{constructor(){super(m.a),this._state=Mn}_setState(e){this._state=Object.assign(this._state,e),this.__emitChange()}__onDispatch(e){switch(e.action){case"do_after_sync_prepared":this._setState({deferred_action:e.deferred_action});break;case"cancel_after_sync_prepared":this._setState({deferred_action:null});break;case"sync_state":{if("PREPARED"!==e.state)break;if(!this._state.deferred_action)break;const t=Object.assign({},this._state.deferred_action);this._setState({deferred_action:null}),m.a.dispatch(t);break}case"on_client_not_viable":case"on_logged_out":this.reset()}}reset(){this._state=Object.assign({},Mn)}}let Fn=null;Fn||(Fn=new Ln);var Bn=s(458);var Vn=s(690);const Wn=[Fe.a.ERROR_INVALID_HOMESERVER,Fe.a.ERROR_INVALID_IDENTITY_SERVER];class Hn{constructor(){I()(this,"hsUrl",void 0),I()(this,"hsName",void 0),I()(this,"hsNameIsDifferent",void 0),I()(this,"isUrl",void 0),I()(this,"isDefault",void 0),I()(this,"isNameResolvable",void 0),I()(this,"warning",void 0)}}class Gn{static isLivelinessError(e){return!!e&&!!Wn.find(t=>t===e||t===e.message)}static authComponentStateForError(e,t="login"){if(!e)return{serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:null};let s=Object(l.a)("Cannot reach homeserver"),n=Object(l.a)("Ensure you have a stable internet connection, or get in touch with the server admin");if(!Gn.isLivelinessError(e)){const e=c.a.get().brand;s=Object(l.a)("Your %(brand)s is misconfigured",{brand:e}),n=Object(l.a)("Ask your %(brand)s admin to check <a>your config</a> for incorrect or duplicate entries.",{brand:e},{a:e=>i.a.createElement("a",{href:"https://github.com/vector-im/element-web/blob/master/docs/config.md",target:"_blank",rel:"noreferrer noopener"},e)})}let a=!0;return(e.message?e.message:e)===Fe.a.ERROR_INVALID_IDENTITY_SERVER&&(a=!1,s=Object(l.a)("Cannot reach identity server"),n="register"===t?Object(l.a)("You can register, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):"reset_password"===t?Object(l.a)("You can reset your password, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin."):Object(l.a)("You can log in, but some features will be unavailable until the identity server is back online. If you keep seeing this warning, check your configuration or contact a server admin.")),{serverIsAlive:!1,serverErrorIsFatal:a,serverDeadError:i.a.createElement("div",null,i.a.createElement("strong",null,s),i.a.createElement("div",null,n))}}static async validateServerConfigWithStaticUrls(e,t,s=!1){if(!e)throw Object(l.h)(Object(l.b)("No homeserver URL provided"));const n={"m.homeserver":{base_url:e}};t&&(n["m.identity_server"]={base_url:t});const a=await Fe.a.fromDiscoveryConfig(n),i=new URL(e).hostname;return Gn.buildValidatedConfigFromDiscovery(i,a,s,!0)}static async validateServerName(e){const t=await Fe.a.findClientConfig(e);return Gn.buildValidatedConfigFromDiscovery(e,t)}static buildValidatedConfigFromDiscovery(e,t,s=!1,n=!1){if(!t||!t["m.homeserver"])throw console.error("Ended up in a state of not knowing which homeserver to connect to."),Object(l.h)(Object(l.b)("Unexpected error resolving homeserver configuration"));const a=t["m.homeserver"],i=t["m.identity_server"],o=c.a.get().validated_server_config;let r=o&&o.isUrl;if(i&&i.state===Fe.a.SUCCESS)r=i.base_url;else if(i&&i.state!==Fe.a.PROMPT){if(console.error("Error determining preferred identity server URL:",i),i.state===Fe.a.FAIL_ERROR){if(-1!==Fe.a.ALL_ERRORS.indexOf(i.error))throw Object(l.h)(i.error);throw Object(l.h)(Object(l.b)("Unexpected error resolving identity server configuration"))}a.error=Fe.a.ERROR_INVALID_IDENTITY_SERVER,i.base_url&&(r=i.base_url)}if(a.state!==Fe.a.SUCCESS&&(console.error("Error processing homeserver config:",a),!s||!Gn.isLivelinessError(a.error))){if(-1!==Fe.a.ALL_ERRORS.indexOf(a.error))throw Object(l.h)(a.error);throw Object(l.h)(Object(l.b)("Unexpected error resolving homeserver configuration"))}const d=a.base_url;let m=e||a.server_name;const h=new URL(d);if(m||(m=h.hostname),!m)throw console.error("Failed to parse homeserver name from homeserver URL"),Object(l.h)(Object(l.b)("Unexpected error resolving homeserver configuration"));return function(e,t){const s=new e;return Object.assign(s,t),s}(Hn,{hsUrl:d,hsName:m,hsNameIsDifferent:h.hostname!==m,isUrl:r,isDefault:!1,warning:a.error,isNameResolvable:!n})}}var qn=s(109),Kn=s(513),zn=s(347);const $n=()=>{m.a.dispatch({action:"accept_cookies"})},Yn=()=>{m.a.dispatch({action:"reject_cookies"})},Jn=()=>{_.a.showDetailsModal()},Qn=()=>{sn.a.sharedInstance().dismissToast("analytics")};var Xn=s(449),Zn=s(171),ea=s(298);class ta extends i.a.PureComponent{constructor(e){super(e),I()(this,"onMouseOver",()=>{this.setState({hover:!0})}),I()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),this.state={hover:!1}}render(){const{tooltip:e,children:t,tooltipClassName:s}=this.props,n=Object(l.a)("Information"),a=this.state.hover?i.a.createElement(ea.a,{className:"mx_InfoTooltip_container",tooltipClassName:L()("mx_InfoTooltip_tooltip",s),label:e||n,forceOnRight:!0}):i.a.createElement("div",null);return i.a.createElement("div",{onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,className:"mx_InfoTooltip"},i.a.createElement("span",{className:"mx_InfoTooltip_icon","aria-label":n}),t,a)}}var sa=s(114);class na extends i.a.PureComponent{constructor(e){super(e),I()(this,"avatarUploadRef",i.a.createRef()),I()(this,"onNameChange",e=>{const t=(e.target.value||"").toLowerCase().replace(/[^a-z0-9.\-_]/g,"-");this.setState({name:e.target.value,localpart:t})}),I()(this,"onSubmit",async e=>{if(e.preventDefault(),e.stopPropagation(),!this.state.busy){this.setState({busy:!0});try{let e="";this.state.avatarFile&&(e=await ee.a.get().uploadContent(this.state.avatarFile));const t=await ee.a.get().createGroup({localpart:this.state.localpart,profile:{name:this.state.name,avatar_url:e}});m.a.dispatch({action:"deselect_tags"},!0),m.a.dispatch({action:"select_tag",tag:t.group_id}),this.props.onFinished(!0),t.room_id?(await sa.a.refreshGroupRooms(t.group_id),m.a.dispatch({action:"view_room",room_id:t.room_id}),Object(rs.f)(t.room_id,this.state.name)):m.a.dispatch({action:"view_group",group_id:t.group_id,group_is_new:!0})}catch(e){console.error(e),this.setState({busy:!1,error:Object(l.a)("There was an error creating your community. The name may be taken or the server is unable to process your request.")})}}}),I()(this,"onAvatarChanged",e=>{if(e.target.files&&e.target.files.length){this.setState({busy:!0});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarFile:t,busy:!1,avatarPreview:e.target.result})},s.readAsDataURL(t)}else this.setState({avatarFile:null})}),I()(this,"onChangeAvatar",()=>{this.avatarUploadRef.current&&this.avatarUploadRef.current.click()}),this.state={name:"",localpart:"",error:null,busy:!1,avatarFile:null,avatarPreview:null}}render(){let e=null;this.state.localpart&&(e=i.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_communityId"},Object(l.a)("Community ID: +<localpart />:%(domain)s",{domain:ee.a.getHomeserverName()},{localpart:()=>i.a.createElement("u",null,this.state.localpart)}),i.a.createElement(ta,{tooltip:Object(l.a)("Use this when referencing your community to others. The community ID cannot be changed.")})));let t=i.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"},Object(l.a)("You can change this later if needed."));if(this.state.error){const e="mx_CreateCommunityPrototypeDialog_subtext mx_CreateCommunityPrototypeDialog_subtext_error";t=i.a.createElement("span",{className:e},this.state.error)}let s=i.a.createElement("img",{src:this.state.avatarPreview,className:"mx_CreateCommunityPrototypeDialog_avatar"});return this.state.avatarPreview||(s=i.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_placeholderAvatar"})),i.a.createElement(cs.a,{className:"mx_CreateCommunityPrototypeDialog",onFinished:this.props.onFinished,title:Object(l.a)("What's the name of your community or team?")},i.a.createElement("form",{onSubmit:this.onSubmit},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colName"},i.a.createElement(ke.a,{value:this.state.name,onChange:this.onNameChange,placeholder:Object(l.a)("Enter name"),label:Object(l.a)("Enter name")}),t,i.a.createElement("span",{className:"mx_CreateCommunityPrototypeDialog_subtext"}," ",e),i.a.createElement(pe.a,{kind:"primary",onClick:this.onSubmit,disabled:this.state.busy},Object(l.a)("Create"))),i.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_colAvatar"},i.a.createElement("input",{type:"file",style:{display:"none"},ref:this.avatarUploadRef,accept:"image/*",onChange:this.onAvatarChanged}),i.a.createElement(pe.a,{onClick:this.onChangeAvatar,className:"mx_CreateCommunityPrototypeDialog_avatarContainer"},s),i.a.createElement("div",{className:"mx_CreateCommunityPrototypeDialog_tip"},i.a.createElement("b",null,Object(l.a)("Add image (optional)")),i.a.createElement("span",null,Object(l.a)("An image will help people identify your community.")))))))}}var aa=s(664),ia=s(469);class oa extends a.PureComponent{constructor(e){super(e),I()(this,"onCancelClick",()=>{this.props.onFinished(!1)}),I()(this,"onChange",e=>{this.setState({value:e.target.value})}),I()(this,"onFormSubmit",e=>{e.preventDefault(),this.onDialPress()}),I()(this,"onDigitPress",e=>{this.setState({value:this.state.value+e})}),I()(this,"onDeletePress",()=>{0!==this.state.value.length&&this.setState({value:this.state.value.slice(0,-1)})}),I()(this,"onDialPress",async()=>{const e=await ee.a.get().getThirdpartyUser("im.vector.protocol.pstn",{"m.id.phone":this.state.value});e&&0!==e.length&&e[0].userid||De.a.createTrackedDialog("","",Ae.a,{title:Object(l.a)("Unable to look up phone number"),description:Object(l.a)("There was an error looking up the phone number")});const t=e[0].userid,s=await Object(Ct.c)(ee.a.get(),t);m.a.dispatch({action:"view_room",room_id:s}),this.props.onFinished(!0)}),this.state={value:""}}render(){return a.createElement("div",{className:"mx_DialPadModal"},a.createElement("div",{className:"mx_DialPadModal_header"},a.createElement("div",null,a.createElement("span",{className:"mx_DialPadModal_title"},Object(l.a)("Dial pad")),a.createElement(pe.a,{className:"mx_DialPadModal_cancel",onClick:this.onCancelClick})),a.createElement("form",{onSubmit:this.onFormSubmit},a.createElement(ke.a,{className:"mx_DialPadModal_field",id:"dialpad_number",value:this.state.value,autoFocus:!0,onChange:this.onChange}))),a.createElement("div",{className:"mx_DialPadModal_horizSep"}),a.createElement("div",{className:"mx_DialPadModal_dialPad"},a.createElement(ia.a,{hasDialAndDelete:!0,onDigitPress:this.onDigitPress,onDeletePress:this.onDeletePress,onDialPress:this.onDialPress})))}}const ra=()=>{window.location.href="mobile_guide/"},la=()=>{document.cookie="element_mobile_redirect_to_guide=false;path=/;max-age=14400",ca()},ca=()=>{sn.a.sharedInstance().dismissToast("mobileguide")};var da=s(201);class ma extends i.a.Component{constructor(e){super(e),I()(this,"onOk",()=>{this.props.onFinished(!0)}),this.onResendEmail=this.onResendEmail.bind(this),this.state={newEmailRequested:this.props.newEmailRequested}}onResendEmail(){this.setState({newEmailRequested:!0}),this.props.onRequestNewEmail()}render(){let e=Object(l.a)("The validity period of your account has expired. An email has been sent to you in order to renew it. Once you’ve followed the link it contains, click below.");return this.state.newEmailRequested&&(e=Object(l.a)("An email has been sent to you. Once you’ve followed the link it contains, click below.")),i.a.createElement(cs.a,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:Object(l.a)("The validity period of your account has expired"),contentId:"mx_Dialog_content",hasCancel:!1},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("div",null,i.a.createElement("p",null," ",e))),i.a.createElement(da.a,{primaryButton:Object(l.a)("I renewed the validity of my account"),primaryButtonClass:null,cancelButton:null,hasCancel:!1,onPrimaryButtonClick:this.onOk,focus:this.props.focus,onCancel:null},i.a.createElement("button",{onClick:this.onResendEmail},Object(l.a)("Request a renewal email"))))}}let ha;I()(ma,"propTypes",{button:xe.a.string,focus:xe.a.bool,newEmailRequested:xe.a.bool.isRequired,onFinished:xe.a.func.isRequired,onRequestNewEmail:xe.a.func.isRequired}),function(e){e[e.LOADING=0]="LOADING",e[e.WELCOME=1]="WELCOME",e[e.LOGIN=2]="LOGIN",e[e.REGISTER=3]="REGISTER",e[e.FORGOT_PASSWORD=4]="FORGOT_PASSWORD",e[e.COMPLETE_SECURITY=5]="COMPLETE_SECURITY",e[e.E2E_SETUP=6]="E2E_SETUP",e[e.LOGGED_IN=7]="LOGGED_IN",e[e.SOFT_LOGOUT=8]="SOFT_LOGOUT"}(ha||(ha={}));const ua=["register","login","forgot_password","start_sso","start_cas"],pa=[h.a.ViewUserSettings,"view_create_chat","view_create_room","view_create_group"];class ga extends i.a.PureComponent{constructor(e,t){if(super(e,t),I()(this,"firstSyncComplete",void 0),I()(this,"firstSyncPromise",void 0),I()(this,"screenAfterLogin",void 0),I()(this,"windowWidth",void 0),I()(this,"pageChanging",void 0),I()(this,"tokenLogin",void 0),I()(this,"accountPassword",void 0),I()(this,"accountPasswordTimer",void 0),I()(this,"focusComposer",void 0),I()(this,"subTitleStatus",void 0),I()(this,"loggedInView",void 0),I()(this,"dispatcherRef",void 0),I()(this,"themeWatcher",void 0),I()(this,"fontWatcher",void 0),I()(this,"onAction",e=>{const t=d.getComponent("dialogs.QuestionDialog");if(ee.a.get()&&ee.a.get().isGuest()&&pa.includes(e.action))return m.a.dispatch({action:"do_after_sync_prepared",deferred_action:e}),void m.a.dispatch({action:"require_registration"});switch(e.action){case"MatrixActions.accountData":break;case"logout":Le.h();break;case"require_registration":!async function(e){void 0===e&&(e={});const t=d.getComponent("dialogs.QuestionDialog"),s=De.a.createTrackedDialog("Registration required","",t,{hasCancelButton:!0,quitOnly:!0,title:Object(l.a)("Sign In or Create Account"),description:Object(l.a)("Use your account or create a new one to continue."),button:Object(l.a)("Create Account"),extraButtons:[React.createElement("button",{key:"start_login",onClick:()=>{s.close(),m.a.dispatch({action:"start_login",screenAfterLogin:e.screen_after})}},Object(l.a)("Sign In"))],onFinished:t=>{t?m.a.dispatch({action:"start_registration",screenAfterLogin:e.screen_after}):e.go_home_on_cancel?m.a.dispatch({action:"view_home_page"}):e.go_welcome_on_cancel&&m.a.dispatch({action:"view_welcome_page"})}})}(e);break;case"start_registration":if(Le.f()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.startRegistration(e.params||{});break;case"start_login":if(Le.f()){this.onSoftLogout();break}e.screenAfterLogin&&(this.screenAfterLogin=e.screenAfterLogin),this.setStateForNewView({view:ha.LOGIN}),this.notifyNewScreen("login"),Bn.a.isLogin=!0,this.themeWatcher.recheck();break;case"start_password_recovery":this.setStateForNewView({view:ha.FORGOT_PASSWORD}),this.notifyNewScreen("forgot_password");break;case"start_chat":Object(Ct.b)({dmUserId:e.user_id});break;case"leave_room":this.leaveRoom(e.room_id);break;case"forget_room":this.forgetRoom(e.room_id);break;case"reject_invite":De.a.createTrackedDialog("Reject invitation","",t,{title:Object(l.a)("Reject invitation"),description:Object(l.a)("Are you sure you want to reject the invitation?"),onFinished:t=>{if(t){const t=d.getComponent("elements.Spinner"),s=De.a.createDialog(t,null,"mx_Dialog_spinner");ee.a.get().leave(e.room_id).then(()=>{s.close(),this.state.currentRoomId===e.room_id&&m.a.dispatch({action:"view_home_page"})},e=>{s.close(),De.a.createTrackedDialog("Failed to reject invitation","",Ae.a,{title:Object(l.a)("Failed to reject invitation"),description:e.toString()})})}}});break;case"view_user_info":this.viewUser(e.userId,e.subAction);break;case"view_room":{const t=this.viewRoom(e);e.deferred_action&&t.then(()=>{m.a.dispatch(e.deferred_action)});break}case h.a.ViewUserSettings:{const t=e,s=d.getComponent("dialogs.UserSettingsDialog");De.a.createTrackedDialog("User settings","",s,{initialTabId:t.initialTabId},null,!1,!0),this.viewSomethingBehindModal();break}case"view_create_room":this.createRoom(e.public);break;case"view_create_group":{let e=d.getComponent("dialogs.CreateGroupDialog");F.a.getValue("feature_communities_v2_prototypes")&&(e=na),De.a.createTrackedDialog("Create Community","",e);break}case h.a.ViewRoomDirectory:{const t=d.getComponent("structures.RoomDirectory");De.a.createTrackedDialog("Room directory","",t,{initialText:e.initialText},"mx_RoomDirectory_dialogWrapper",!1,!0),this.viewSomethingBehindModal();break}case"view_my_groups":this.setPage(Vs),this.notifyNewScreen("groups");break;case"view_group":this.viewGroup(e);break;case"view_welcome_page":this.viewWelcome();break;case"view_home_page":this.viewHome(e.justRegistered);break;case"view_start_chat_or_reuse":this.chatCreateOrReuse(e.user_id);break;case"view_create_chat":Object(rs.i)(e.initialText||"");break;case"view_invite":Object(rs.g)(e.roomId);break;case"view_invite_file":Object(rs.h)(e.roomId);break;case"view_last_screen":this.showScreenAfterLogin();break;case"toggle_my_groups":this.state.page_type===Vs?m.a.dispatch({action:"view_last_screen"}):m.a.dispatch({action:"view_my_groups"});break;case"hide_left_panel":this.setState({collapseLhs:!0},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case"focus_room_filter":case"show_left_panel":this.setState({collapseLhs:!1},()=>{this.state.resizeNotifier.notifyLeftHandleResized()});break;case h.a.OpenDialPad:De.a.createTrackedDialog("Dial pad","",oa,{},"mx_Dialog_dialPadWrapper");break;case"on_logged_in":this.tokenLogin||Le.f()||this.state.view===ha.LOGIN||this.state.view===ha.REGISTER||this.state.view===ha.COMPLETE_SECURITY||this.state.view===ha.E2E_SETUP||this.onLoggedIn();break;case"on_client_not_viable":this.onSoftLogout();break;case"on_logged_out":this.onLoggedOut();break;case"will_start_client":this.setState({ready:!1},()=>{this.onWillStartClient()});break;case"client_started":this.onClientStarted();break;case"send_event":this.onSendEvent(e.room_id,e.event);break;case"aria_hide_main_app":this.setState({hideToSRUsers:!0});break;case"aria_unhide_main_app":this.setState({hideToSRUsers:!1});break;case"accept_cookies":F.a.setValue("analyticsOptIn",null,Qe.a.DEVICE,!0),F.a.setValue("showCookieBar",null,Qe.a.DEVICE,!1),Qn(),_.a.canEnable()&&_.a.enable(),y.a.instance.canEnable()&&y.a.instance.enable(!1);break;case"reject_cookies":F.a.setValue("analyticsOptIn",null,Qe.a.DEVICE,!1),F.a.setValue("showCookieBar",null,Qe.a.DEVICE,!1),Qn()}}),I()(this,"handleResize",()=>{this.windowWidth>1e3&&window.innerWidth<=1e3&&m.a.dispatch({action:"hide_left_panel"}),this.windowWidth<=1e3&&window.innerWidth>1e3&&m.a.dispatch({action:"show_left_panel"}),this.state.resizeNotifier.notifyWindowResized(),this.windowWidth=window.innerWidth}),I()(this,"onRegisterClick",()=>{this.showScreen("register")}),I()(this,"onLoginClick",()=>{this.showScreen("login")}),I()(this,"onForgotPasswordClick",()=>{this.showScreen("forgot_password")}),I()(this,"onRegisterFlowComplete",(e,t)=>this.onUserCompletedLoginFlow(e,t)),I()(this,"onServerConfigChange",e=>{this.setState({serverConfig:e})}),I()(this,"makeRegistrationUrl",e=>(this.props.startingFragmentQueryParams.referrer&&(e.referrer=this.props.startingFragmentQueryParams.referrer),this.props.makeRegistrationUrl(e))),I()(this,"onUserCompletedLoginFlow",async(e,t)=>{this.accountPassword=t,null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer),this.accountPasswordTimer=setTimeout(()=>{this.accountPassword=null,this.accountPasswordTimer=null},3e5),await Le.k(e),await this.postLoginSetup()}),I()(this,"onCompleteSecurityE2eSetupFinished",()=>{this.onLoggedIn()}),this.state={view:ha.LOADING,collapseLhs:!1,hideToSRUsers:!1,syncError:null,resizeNotifier:new Vn.a,ready:!1},this.loggedInView=Object(a.createRef)(),c.a.put(this.props.config),this.firstSyncComplete=!1,this.firstSyncPromise=Object(Et.b)(),this.props.config.sync_timeline_limit&&(ee.a.opts.initialSyncLimit=this.props.config.sync_timeline_limit),this.screenAfterLogin=this.props.initialScreenAfterLogin,this.screenAfterLogin){const e=this.screenAfterLogin.params||{};if(this.screenAfterLogin.screen.startsWith("room/")&&e.signurl&&e.email){const t=this.screenAfterLogin.screen.substring("room/".length);aa.a.instance.storeInvite(t,e)}}this.windowWidth=1e4,this.handleResize(),window.addEventListener("resize",this.handleResize),this.pageChanging=!1,Pn.a.tint(),this.state.resizeNotifier.on("middlePanelResized",this.dispatchTimelineResize),Le.f()&&Le.g(),this.accountPassword=null,this.accountPasswordTimer=null,this.dispatcherRef=m.a.register(this.onAction),this.themeWatcher=new it.a,this.fontWatcher=new ct,this.themeWatcher.start(),this.fontWatcher.start(),this.focusComposer=!1,this.subTitleStatus="",this.onAliasClick&&(An.a.onAliasClick=this.onAliasClick),this.onUserClick&&(An.a.onUserClick=this.onUserClick),this.onGroupClick&&(An.a.onGroupClick=this.onGroupClick),Le.f()||Le.a(this.props.realQueryParams,this.props.defaultDeviceDisplayName,this.getFragmentAfterLogin()).then(async e=>{var t;if(null!==(t=this.props.realQueryParams)&&void 0!==t&&t.loginToken&&this.props.onTokenLoginCompleted(),e)return this.tokenLogin=!0,await Le.j({ignoreGuest:!0}),this.postLoginSetup();const s=this.screenAfterLogin?this.screenAfterLogin.screen:null;if("login"!==s&&"register"!==s&&"forgot_password"!==s)return this.loadSession();this.showScreenAfterLogin()}),F.a.getValue("analyticsOptIn")&&_.a.enable(),y.a.instance.enable(!0)}async postLoginSetup(){const e=ee.a.get(),t=e.isCryptoEnabled();t||this.onLoggedIn();const s=[this.firstSyncPromise.promise];t&&s.push(e.downloadKeys([e.getUserId()])),this.setState({pendingInitialSync:!0}),await Promise.all(s),t?(this.onLoggedIn(),this.setState({pendingInitialSync:!1})):this.setState({pendingInitialSync:!1})}UNSAFE_componentWillUpdate(e,t){this.shouldTrackPageChange(this.state,t)&&this.startPageChangeTimer()}componentDidUpdate(e,t){if(this.shouldTrackPageChange(t,this.state)){const e=this.stopPageChangeTimer();_.a.trackPageChange(e),y.a.instance.trackPageChange(e)}this.focusComposer&&(m.a.fire(h.a.FocusComposer),this.focusComposer=!1)}componentWillUnmount(){Le.m(),m.a.unregister(this.dispatcherRef),this.themeWatcher.stop(),this.fontWatcher.stop(),window.removeEventListener("resize",this.handleResize),this.state.resizeNotifier.removeListener("middlePanelResized",this.dispatchTimelineResize),null!==this.accountPasswordTimer&&clearTimeout(this.accountPasswordTimer)}getFallbackHsUrl(){return this.props.serverConfig&&this.props.serverConfig.isDefault?this.props.config.fallback_hs_url:null}getServerProperties(){let e=this.state.serverConfig;return e||(e=this.props.serverConfig),e||(e=c.a.get().validated_server_config),{serverConfig:e}}loadSession(){return Promise.resolve().then(()=>Le.g({fragmentQueryParams:this.props.startingFragmentQueryParams,enableGuest:this.props.enableGuest,guestHsUrl:null,guestIsUrl:null,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName})).then(e=>{e?F.a.getValue("analyticsOptIn")&&y.a.instance.enable(!1):aa.a.instance.pickBestInvite()?m.a.dispatch({action:"start_registration"}):m.a.dispatch({action:"view_welcome_page"})})}startPageChangeTimer(){if(!performance||!performance.mark)return null;this.pageChanging?console.warn("MatrixChat.startPageChangeTimer: timer already started"):(this.pageChanging=!0,performance.mark("element_MatrixChat_page_change_start"))}stopPageChangeTimer(){if(!performance||!performance.mark)return null;if(!this.pageChanging)return void console.warn("MatrixChat.stopPageChangeTimer: timer not started");this.pageChanging=!1,performance.mark("element_MatrixChat_page_change_stop"),performance.measure("element_MatrixChat_page_change_delta","element_MatrixChat_page_change_start","element_MatrixChat_page_change_stop"),performance.clearMarks("element_MatrixChat_page_change_start"),performance.clearMarks("element_MatrixChat_page_change_stop");const e=performance.getEntriesByName("element_MatrixChat_page_change_delta").pop();return e?e.duration:null}shouldTrackPageChange(e,t){return e.currentRoomId!==t.currentRoomId||e.view!==t.view||e.page_type!==t.page_type}setStateForNewView(e){if(void 0===e.view)throw new Error("setStateForNewView with no view!");const t={currentUserId:null,justRegistered:!1};Object.assign(t,e),this.setState(t)}setPage(e){this.setState({page_type:e})}async startRegistration(e){const t={view:ha.REGISTER};e.client_secret&&e.session_id&&e.hs_url&&e.is_url&&e.sid&&(t.serverConfig=await Gn.validateServerConfigWithStaticUrls(e.hs_url,e.is_url),t.register_client_secret=e.client_secret,t.register_session_id=e.session_id,t.register_id_sid=e.sid),this.setStateForNewView(t),Bn.a.isLogin=!0,this.themeWatcher.recheck(),this.notifyNewScreen("register")}viewRoom(e){this.focusComposer=!0,e.room_alias?console.log(`Switching to room alias ${e.room_alias} at event `+e.event_id):console.log(`Switching to room id ${e.room_id} at event `+e.event_id);let t=Promise.resolve(null);if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void console.warn("Cannot view a room before first sync. room_id:",e.room_id);t=this.firstSyncPromise.promise}return t.then(()=>{let t=e.room_alias||e.room_id;const s=ee.a.get().getRoom(e.room_id);if(s){const e=Dn.a(s);e&&(t=e,Object(Kn.b)(e,s.roomId)),localStorage&&localStorage.setItem("mx_last_room_id",s.roomId)}const n="#"===t[0]&&e.room_id===this.state.currentRoomId;e.event_id&&e.highlighted&&(t+="/"+e.event_id),this.setState({view:ha.LOGGED_IN,currentRoomId:e.room_id||null,page_type:Ms,threepidInvite:e.threepid_invite,roomOobData:e.oob_data,viaServers:e.via_servers,ready:!0},()=>{this.notifyNewScreen("room/"+t,n)})})}async viewGroup(e){const t=e.group_id;if(!this.firstSyncComplete){if(!this.firstSyncPromise)return void console.warn("Cannot view a group before first sync. group_id:",t);await this.firstSyncPromise.promise}this.setState({view:ha.LOGGED_IN,currentGroupId:t,currentGroupIsNew:e.group_is_new}),this.setPage(Bs),this.notifyNewScreen("group/"+t)}viewSomethingBehindModal(){this.state.view===ha.LOGGED_IN?this.state.currentGroupId||this.state.currentRoomId||this.viewHome():this.viewWelcome()}viewWelcome(){this.setStateForNewView({view:ha.WELCOME}),this.notifyNewScreen("welcome"),Bn.a.isLogin=!0,this.themeWatcher.recheck()}viewHome(e=!1){this.setStateForNewView({view:ha.LOGGED_IN,justRegistered:e}),this.setPage(Us),this.notifyNewScreen("home"),Bn.a.isLogin=!1,this.themeWatcher.recheck()}viewUser(e,t){(this.firstSyncPromise?this.firstSyncPromise.promise:Promise.resolve()).then(()=>{"chat"!==t?(this.notifyNewScreen("user/"+e),this.setState({currentUserId:e}),this.setPage(Fs)):this.chatCreateOrReuse(e)})}async createRoom(e=!1){const t=ge.a.instance.getSelectedCommunityId();if(t&&!ge.a.instance.isAdminOf(t))return void De.a.createTrackedDialog("Pre-failure to create room","",Ae.a,{title:Object(l.a)("Cannot create rooms in this community"),description:Object(l.a)("You do not have permission to create rooms in this community.")});const s=d.getComponent("dialogs.CreateRoomDialog"),n=De.a.createTrackedDialog("Create Room","",s,{defaultPublic:e}),[a,i]=await n.finished;a&&Object(Ct.b)(i)}chatCreateOrReuse(e){if(ee.a.get().isGuest())return e!==this.props.config.welcomeUserId&&m.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_start_chat_or_reuse",user_id:e}}),void m.a.dispatch({action:"require_registration",go_welcome_on_cancel:!0,screen_after:{screen:"user/"+this.props.config.welcomeUserId,params:{action:"chat"}}});const t=ee.a.get(),s=new qn.a(t).getDMRoomsForUserId(e);s.length>0?m.a.dispatch({action:"view_room",room_id:s[0]}):m.a.dispatch({action:"start_chat",user_id:e})}leaveRoomWarnings(e){const t=ee.a.get().getRoom(e).currentState.getStateEvents("m.room.join_rules",""),s=[];if(t){"public"!==t.getContent().join_rule&&s.push(i.a.createElement("span",{className:"warning",key:"non_public_warning"}," ",i.a.createElement("br",null),Object(l.a)("This room is not a forum. You will not be able to rejoin without an invite.")))}return s}leaveRoom(e){const t=d.getComponent("dialogs.QuestionDialog"),s=ee.a.get().getRoom(e),n=this.leaveRoomWarnings(e);De.a.createTrackedDialog("Leave room","",t,{title:Object(l.a)("Leave room"),description:i.a.createElement("span",null,Object(l.a)("Are you sure you want to leave the room '%(roomName)s'?",{roomName:s.name}),n),button:Object(l.a)("Leave"),onFinished:t=>{if(t){const t=Object(Zn.d)(e),s=d.getComponent("elements.Spinner"),n=De.a.createDialog(s,null,"mx_Dialog_spinner");t.finally(()=>n.close())}}})}forgetRoom(e){ee.a.get().forget(e).then(()=>{this.state.currentRoomId===e&&m.a.dispatch({action:"view_home_page"})}).catch(e=>{const t=e.errcode||Object(l.b)("unknown error code");De.a.createTrackedDialog("Failed to forget room","",Ae.a,{title:Object(l.a)("Failed to forget room %(errCode)s",{errCode:t}),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}async startWelcomeUserChat(){let e;e=this.firstSyncComplete?Promise.resolve():this.firstSyncPromise.promise,await e;if(0===qn.a.shared().getDMRoomsForUserId(this.props.config.welcomeUserId).length){const e=await Object(Ct.b)({dmUserId:this.props.config.welcomeUserId,andView:!this.state.currentRoomId,spinner:!1}),t=e=>{"m.direct"===e.getType()&&e.getContent()&&e.getContent()[this.props.config.welcomeUserId]&&(ee.a.get().store.save(!0),ee.a.get().removeListener("accountData",t))};return ee.a.get().on("accountData",t),e}return null}async onLoggedIn(){if(Bn.a.isLogin=!1,this.themeWatcher.recheck(),this.setStateForNewView({view:ha.LOGGED_IN}),this.screenAfterLogin&&this.screenAfterLogin.screen)this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null;else if(ee.a.currentUserIsJustRegistered())if(ee.a.setJustRegisteredUserId(null),this.props.config.welcomeUserId&&Object(l.d)().startsWith("fr")){null===await this.startWelcomeUserChat()&&m.a.dispatch({action:"view_home_page",justRegistered:!0})}else if(aa.a.instance.pickBestInvite()){const e=aa.a.instance.pickBestInvite(),t=aa.a.instance.translateToWireFormat(e);this.showScreen("room/"+e.roomId,t)}else m.a.dispatch({action:"view_home_page",justRegistered:!0});else this.showScreenAfterLogin();var e;(zn.g(),await Object(Et.d)(30),F.a.getValue("showCookieBar")&&(_.a.canEnable()||y.a.instance.canEnable()))&&(e=>{const t=c.a.get().brand;sn.a.sharedInstance().addOrReplaceToast({key:"analytics",title:Object(l.a)("Help us improve %(brand)s",{brand:t}),props:{description:Object(l.a)("Send <UsageDataLink>anonymous usage data</UsageDataLink> which helps us improve %(brand)s. This will use a <PolicyLink>cookie</PolicyLink>.",{brand:t},{UsageDataLink:e=>i.a.createElement(pe.a,{kind:"link",onClick:Jn},e),PolicyLink:t=>e?i.a.createElement("a",{target:"_blank",href:e},t):t}),acceptLabel:Object(l.a)("Yes"),onAccept:$n,rejectLabel:Object(l.a)("No"),onReject:Yn},component:tn.a,className:"mx_AnalyticsToast",priority:10})})(null===(e=this.props.config.piwik)||void 0===e?void 0:e.policyUrl);c.a.get().mobileGuideToast&&(()=>{const e=/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream,t=/Android/.test(navigator.userAgent);(e||t)&&(document.cookie.includes("element_mobile_redirect_to_guide=false")||sn.a.sharedInstance().addOrReplaceToast({key:"mobileguide",title:Object(l.a)("Use app for a better experience"),props:{description:Object(l.a)("Element Web is experimental on mobile. For a better experience and the latest features, use our free native app."),acceptLabel:Object(l.a)("Use app"),onAccept:ra,rejectLabel:Object(l.a)("Dismiss"),onReject:la},component:tn.a,priority:99}))})()}showScreenAfterLogin(){this.screenAfterLogin&&this.screenAfterLogin.screen?(this.showScreen(this.screenAfterLogin.screen,this.screenAfterLogin.params),this.screenAfterLogin=null):localStorage&&localStorage.getItem("mx_last_room_id")?this.viewLastRoom():ee.a.get().isGuest()?m.a.dispatch({action:"view_welcome_page"}):m.a.dispatch({action:"view_home_page"})}viewLastRoom(){m.a.dispatch({action:"view_room",room_id:localStorage.getItem("mx_last_room_id")})}onLoggedOut(){this.notifyNewScreen("login"),this.setStateForNewView({view:ha.LOGIN,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle(),Bn.a.isLogin=!0,this.themeWatcher.recheck()}onSoftLogout(){this.notifyNewScreen("soft_logout"),this.setStateForNewView({view:ha.SOFT_LOGOUT,ready:!1,collapseLhs:!1,currentRoomId:null}),this.subTitleStatus="",this.setPageSubtitle()}onWillStartClient(){this.firstSyncComplete=!1,this.firstSyncPromise=Object(Et.b)();const e=ee.a.get();let t=!1,n=!1;e.setCanResetTimelineCallback(e=>(console.log("Request to reset timeline in room ",e," viewing:",this.state.currentRoomId),e!==this.state.currentRoomId||(!this.loggedInView.current||this.loggedInView.current.canResetTimelineInRoom(e)))),e.on("sync",(e,s,a)=>{if(a&&a.error&&"ORG_MATRIX_EXPIRED_ACCOUNT"===a.error.errcode?(t=!0,De.a.createTrackedDialog("Expired Account Dialog","",ma,{newEmailRequested:n,onRequestNewEmail:()=>{n=!0,E.a.requestNewExpiredAccountEmail()},onFinished:()=>{n=!1}})):t=!1,m.a.dispatch({action:"sync_state",prevState:s,state:e}),!t){if("ERROR"===e||"RECONNECTING"===e?(a.error instanceof Rn.b&&Le.c(a.error),this.setState({syncError:a.error||!0})):this.state.syncError&&this.setState({syncError:null}),this.updateStatusIndicator(e,s),"SYNCING"===e&&"SYNCING"===s)return;if(console.info("MatrixClient sync state => %s",e),"PREPARED"!==e)return;this.firstSyncComplete=!0,this.firstSyncPromise.resolve(),Nn.default.shouldShowPrompt()&&!ee.a.userRegisteredWithinLastHours(24)&&Object(Xn.b)(!1),m.a.fire(h.a.FocusComposer),this.setState({ready:!0})}}),e.on("Session.logged_out",(function(e){if(!Le.e()){if(De.a.closeCurrentModal("Session.logged_out"),401===e.httpStatus&&e.data&&e.data.soft_logout)return console.warn("Soft logout issued by server - avoiding data deletion"),void Le.l();De.a.createTrackedDialog("Signed out","",Ae.a,{title:Object(l.a)("Signed Out"),description:Object(l.a)("For security, this session has been signed out. Please sign in again.")}),m.a.dispatch({action:"logout"})}})),e.on("no_consent",(function(t,s){const n=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("No Consent Dialog","",n,{title:Object(l.a)("Terms and Conditions"),description:i.a.createElement("div",null,i.a.createElement("p",null," ",Object(l.a)("To continue using the %(homeserverDomain)s homeserver you must review and agree to our terms and conditions.",{homeserverDomain:e.getDomain()}))),button:Object(l.a)("Review terms and conditions"),cancelButton:Object(l.a)("Dismiss"),onFinished:e=>{if(e){window.open(s,"_blank").opener=null}}},null,!0)}));const a=new jn((e,t)=>{_.a.trackEvent("E2E","Decryption failure",t,e),y.a.instance.track("decryption_failure",{errorCode:t},null,{sum:e})},e=>{switch(e){case"MEGOLM_UNKNOWN_INBOUND_SESSION_ID":return"olm_keys_not_sent_error";case"OLM_UNKNOWN_MESSAGE_INDEX":return"olm_index_error";case void 0:return"unexpected_error";default:return"unspecified_error"}});a.start(),e.on("Session.logged_out",()=>a.stop()),e.on("Event.decrypted",(e,t)=>a.eventDecrypted(e,t)),e.on("Room",e=>{if(ee.a.get().isCryptoEnabled()){const t=F.a.getValueAt(Qe.a.ROOM_DEVICE,"blacklistUnverifiedDevices",e.roomId,!0);e.setBlacklistUnverifiedDevices(t)}}),e.on("crypto.warning",e=>{switch(e){case"CRYPTO_WARNING_OLD_VERSION_DETECTED":De.a.createTrackedDialog("Crypto migrated","",Ae.a,{title:Object(l.a)("Old cryptography data detected"),description:Object(l.a)("Data from an older version of %(brand)s has been detected. This will have caused end-to-end cryptography to malfunction in the older version. End-to-end encrypted messages exchanged recently whilst using the older version may not be decryptable in this version. This may also cause messages exchanged with this version to fail. If you experience problems, log out and back in again. To retain message history, export and re-import your keys.",{brand:c.a.get().brand})})}}),e.on("crypto.keyBackupFailed",async e=>{let t,n;if(ee.a.get().getKeyBackupEnabled())t=!0;else try{n=await ee.a.get().getKeyBackupVersion(),null!==n&&(t=!0)}catch(e){return void console.error("Saw key backup error but failed to check backup version!",e)}t?De.a.createTrackedDialogAsync("New Recovery Method","New Recovery Method",s.e(23).then(s.bind(null,1508)),{newVersionInfo:n}):De.a.createTrackedDialogAsync("Recovery Method Removed","Recovery Method Removed",s.e(24).then(s.bind(null,1509)))}),e.on("crypto.keySignatureUploadFailure",(e,t,s)=>{const n=d.getComponent("views.dialogs.KeySignatureUploadFailedDialog");De.a.createTrackedDialog("Failed to upload key signatures","Failed to upload key signatures",n,{failures:e,source:t,continuation:s})}),e.on("crypto.verification.request",e=>{if(e.verifier){const t=d.getComponent("views.dialogs.IncomingSasDialog");De.a.createTrackedDialog("Incoming Verification","",t,{verifier:e.verifier},null,!1,!0)}else e.pending&&sn.a.sharedInstance().addOrReplaceToast({key:"verifreq_"+e.channel.transactionId,title:e.isSelfVerification?Object(l.a)("Self-verification request"):Object(l.a)("Verification Request"),icon:"verification",props:{request:e},component:d.getComponent("toasts.VerificationRequestToast"),priority:90})});const o=F.a.getValue("roomColor");Pn.a.tint(o.primary_color,o.secondary_color)}onClientStarted(){const e=ee.a.get();if(e.isCryptoEnabled()){const t=F.a.getValueAt(Qe.a.DEVICE,"blacklistUnverifiedDevices");e.setGlobalBlacklistUnverifiedDevices(t),e.setGlobalErrorOnUnknownDevices(!1)}}showScreen(e,t){const s=ee.a.get();if(!s||s.isGuest()||!ua.includes(e))if("register"===e)m.a.dispatch({action:"start_registration",params:t});else if("login"===e)m.a.dispatch({action:"start_login",params:t});else if("forgot_password"===e)m.a.dispatch({action:"start_password_recovery",params:t});else if("soft_logout"===e)s.getUserId()&&!Le.f()?this.viewLastRoom():m.a.dispatch({action:"start_login",params:t});else if("new"===e)m.a.dispatch({action:"view_create_room"});else if("settings"===e)m.a.fire(h.a.ViewUserSettings);else if("welcome"===e)m.a.dispatch({action:"view_welcome_page"});else if("home"===e)m.a.dispatch({action:"view_home_page"});else if("start"===e)this.showScreen("home"),m.a.dispatch({action:"require_registration"});else if("directory"===e)this.state.view===ha.WELCOME&&y.a.instance.track("onboarding_room_directory"),m.a.fire(h.a.ViewRoomDirectory);else if("start_sso"===e||"start_cas"===e){let t=ee.a.get();if(!t){const{hsUrl:e,isUrl:s}=this.props.serverConfig;t=Fe.p({baseUrl:e,idBaseUrl:s})}const s="start_sso"===e?"sso":"cas";qe.a.get().startSingleSignOn(t,s,this.getFragmentAfterLogin())}else if("groups"===e)m.a.dispatch({action:"view_my_groups"});else if(0===e.indexOf("room/")){var n,a,i;const s=e.substring(5),o=s.indexOf(":")+1;let r=s.length;s.substring(o).indexOf("/")>-1&&(r=o+s.substring(o).indexOf("/"));const l=s.substring(0,r);let c,d=s.substring(r+1);if(d||(d=void 0),t.signurl&&t.email&&(c=aa.a.instance.storeInvite(l,t)),!c){c=aa.a.instance.getInvites().find(e=>e.roomId===l)}let h=[];t.via&&(h="string"==typeof t.via?[t.via]:t.via);const u={action:"view_room",event_id:d,via_servers:h,highlighted:Boolean(d),threepid_invite:c,oob_data:{name:null===(n=c)||void 0===n?void 0:n.roomName,avatarUrl:null===(a=c)||void 0===a?void 0:a.roomAvatarUrl,inviterName:null===(i=c)||void 0===i?void 0:i.inviterName},room_alias:void 0,room_id:void 0};"#"===l[0]?u.room_alias=l:u.room_id=l,m.a.dispatch(u)}else if(0===e.indexOf("user/")){const s=e.substring(5);m.a.dispatch({action:"view_user_info",userId:s,subAction:t.action})}else if(0===e.indexOf("group/")){const t=e.substring(6);m.a.dispatch({action:"view_group",group_id:t})}else console.info("Ignoring showScreen for '%s'",e);else m.a.dispatch({action:"view_home_page"})}notifyNewScreen(e,t=!1){this.props.onNewScreen&&this.props.onNewScreen(e,t),this.setPageSubtitle()}onAliasClick(e,t){e.preventDefault(),m.a.dispatch({action:"view_room",room_alias:t})}onUserClick(e,t){e.preventDefault();const s=new On.a(null,t);s&&m.a.dispatch({action:h.a.ViewUser,member:s})}onGroupClick(e,t){e.preventDefault(),m.a.dispatch({action:"view_group",group_id:t})}onLogoutClick(e){m.a.dispatch({action:"logout"}),e.stopPropagation(),e.preventDefault()}dispatchTimelineResize(){m.a.dispatch({action:"timeline_resize"})}onRoomCreated(e){m.a.dispatch({action:"view_room",room_id:e})}onRegistered(e){return Le.k(e)}onSendEvent(e,t){const s=ee.a.get();s?s.sendEvent(e,t.getType(),t.getContent()).then(()=>{m.a.dispatch({action:"message_sent"})},e=>{m.a.dispatch({action:"message_send_failed"})}):m.a.dispatch({action:"message_send_failed"})}setPageSubtitle(e=""){if(this.state.currentRoomId){const t=ee.a.get(),s=t&&t.getRoom(this.state.currentRoomId);s&&(e=`${this.subTitleStatus} | ${s.name} ${e}`)}else e=`${this.subTitleStatus} ${e}`;const t=`${c.a.get().brand} ${e}`;document.title!==t&&(document.title=t)}updateStatusIndicator(e,t){const s=me.a.instance.globalState.numUnreadStates;qe.a.get()&&(qe.a.get().setErrorStatus("ERROR"===e),qe.a.get().setNotificationCount(s)),this.subTitleStatus="","ERROR"===e&&(this.subTitleStatus+=`[${Object(l.a)("Offline")}] `),s>0&&(this.subTitleStatus+=`[${s}]`),this.setPageSubtitle()}onCloseAllSettings(){m.a.dispatch({action:"close_settings"})}getFragmentAfterLogin(){let e="";const t=this.props.initialScreenAfterLogin;return t&&!["welcome","login","register","start_sso","start_cas"].includes(t.screen)&&(e="/"+t.screen),e}render(){const e=this.getFragmentAfterLogin();let t=null;if(this.state.view===ha.LOADING){const e=d.getComponent("elements.Spinner");t=i.a.createElement("div",{className:"mx_MatrixChat_splash"},i.a.createElement(e,null))}else if(this.state.view===ha.COMPLETE_SECURITY){const e=d.getComponent("structures.auth.CompleteSecurity");t=i.a.createElement(e,{onFinished:this.onCompleteSecurityE2eSetupFinished})}else if(this.state.view===ha.E2E_SETUP){const e=d.getComponent("structures.auth.E2eSetup");t=i.a.createElement(e,{onFinished:this.onCompleteSecurityE2eSetupFinished,accountPassword:this.accountPassword,tokenLogin:!!this.tokenLogin})}else if(this.state.view===ha.LOGGED_IN){const e=this.state.syncError&&this.state.syncError instanceof Rn.b;if(this.state.ready&&this.state.page_type&&!e){const e=d.getComponent("structures.LoggedInView");t=i.a.createElement(e,se()({},this.props,this.state,{ref:this.loggedInView,matrixClient:ee.a.get(),onRoomCreated:this.onRoomCreated,onCloseAllSettings:this.onCloseAllSettings,onRegistered:this.onRegistered,currentRoomId:this.state.currentRoomId}))}else{const s=d.getComponent("elements.Spinner");let n;this.state.syncError&&!e&&(n=i.a.createElement("div",{className:"mx_MatrixChat_syncError"},function(e){if("M_RESOURCE_LIMIT_EXCEEDED"===e.errcode){const t=nn(e.data.limit_type,e.data.admin_contact,{monthly_active_user:Object(l.b)("This homeserver has hit its Monthly Active User limit."),"":Object(l.b)("This homeserver has exceeded one of its resource limits.")}),s=nn(e.data.limit_type,e.data.admin_contact,{"":Object(l.b)("Please <a>contact your service administrator</a> to continue using the service.")});return React.createElement("div",null,React.createElement("div",null,t),React.createElement("div",null,s))}return"ORG_MATRIX_EXPIRED_ACCOUNT"===e.errcode?React.createElement("div",null,Object(l.a)("Your account's validity period has expired. Awaiting renewal validation...")):React.createElement("div",null,Object(l.a)("Unable to connect to Homeserver. Retrying..."))}(this.state.syncError))),t=i.a.createElement("div",{className:"mx_MatrixChat_splash"},n,i.a.createElement(s,null),i.a.createElement("a",{href:"#",className:"mx_MatrixChat_splashButtons",onClick:this.onLogoutClick},Object(l.a)("Logout")))}}else if(this.state.view===ha.WELCOME){const e=d.getComponent("auth.Welcome");t=i.a.createElement(e,null)}else if(this.state.view===ha.REGISTER&&F.a.getValue(Xe.a.Registration)){var s;const n=d.getComponent("structures.auth.Registration"),a=null===(s=aa.a.instance.pickBestInvite())||void 0===s?void 0:s.toEmail;t=i.a.createElement(n,se()({clientSecret:this.state.register_client_secret,sessionId:this.state.register_session_id,idSid:this.state.register_id_sid,email:a,brand:this.props.config.brand,makeRegistrationUrl:this.makeRegistrationUrl,onLoggedIn:this.onRegisterFlowComplete,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange,defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===ha.FORGOT_PASSWORD&&F.a.getValue(Xe.a.PasswordReset)){const e=d.getComponent("structures.auth.ForgotPassword");t=i.a.createElement(e,se()({onComplete:this.onLoginClick,onLoginClick:this.onLoginClick,onServerConfigChange:this.onServerConfigChange},this.getServerProperties()))}else if(this.state.view===ha.LOGIN){const s=F.a.getValue(Xe.a.PasswordReset),n=d.getComponent("structures.auth.Login");t=i.a.createElement(n,se()({isSyncing:this.state.pendingInitialSync,onLoggedIn:this.onUserCompletedLoginFlow,onRegisterClick:this.onRegisterClick,fallbackHsUrl:this.getFallbackHsUrl(),defaultDeviceDisplayName:this.props.defaultDeviceDisplayName,onForgotPasswordClick:s?this.onForgotPasswordClick:void 0,onServerConfigChange:this.onServerConfigChange,fragmentAfterLogin:e},this.getServerProperties()))}else if(this.state.view===ha.SOFT_LOGOUT){const s=d.getComponent("structures.auth.SoftLogout");t=i.a.createElement(s,{realQueryParams:this.props.realQueryParams,onTokenLoginCompleted:this.props.onTokenLoginCompleted,fragmentAfterLogin:e})}else console.error("Unknown view "+this.state.view);const n=d.getComponent("elements.ErrorBoundary");return i.a.createElement(n,null,t)}}I()(ga,"displayName","MatrixChat"),I()(ga,"defaultProps",{realQueryParams:{},startingFragmentQueryParams:{},config:{},onTokenLoginCompleted:()=>{}});var fa=s(1176);class ba extends a.Component{constructor(e,t){super(e,t),I()(this,"_onToastStoreUpdate",()=>{this.setState({toasts:sn.a.sharedInstance().getToasts(),countSeen:sn.a.sharedInstance().getCountSeen()})}),this.state={toasts:sn.a.sharedInstance().getToasts(),countSeen:sn.a.sharedInstance().getCountSeen()},sn.a.sharedInstance().on("update",this._onToastStoreUpdate)}componentWillUnmount(){sn.a.sharedInstance().removeListener("update",this._onToastStoreUpdate)}render(){const e=this.state.toasts.length,t=e>1;let s;if(0!==e){const n=this.state.toasts[0],{title:i,icon:o,key:r,component:l,className:c,props:d}=n,m=L()("mx_Toast_toast",{mx_Toast_hasIcon:o,["mx_Toast_icon_"+o]:o},c);let h;(t||this.state.countSeen>0)&&(h=` (${this.state.countSeen+1}/${this.state.countSeen+e})`);const u=Object.assign({},d,{key:r,toastKey:r});s=a.createElement("div",{className:m},a.createElement("div",{className:"mx_Toast_title"},a.createElement("h2",null,i),a.createElement("span",null,h)),a.createElement("div",{className:"mx_Toast_body"},a.createElement(l,u)))}const n=L()("mx_ToastContainer",{mx_ToastContainer_stacked:t});return a.createElement("div",{className:n,role:"alert"},s)}}var va,_a=s(346);function ya(e,t){return()=>d.getComponent(e)||t}let Ea=ya("views.auth.AuthPage")(va=class extends i.a.PureComponent{render(){const e=d.getComponent("auth.AuthFooter");return i.a.createElement("div",{className:"mx_AuthPage"},i.a.createElement("div",{className:"mx_AuthPage_modal"},this.props.children),i.a.createElement(e,null))}})||va;var Ca=s(163),wa=s(195);const Sa=127462-"A".charCodeAt(0),xa=/^[A-Z]{2}$/,Ra=[{iso2:"GB",name:Object(l.b)("United Kingdom"),prefix:"44"},{iso2:"US",name:Object(l.b)("United States"),prefix:"1"},{iso2:"AF",name:Object(l.b)("Afghanistan"),prefix:"93"},{iso2:"AX",name:Object(l.b)("Åland Islands"),prefix:"358"},{iso2:"AL",name:Object(l.b)("Albania"),prefix:"355"},{iso2:"DZ",name:Object(l.b)("Algeria"),prefix:"213"},{iso2:"AS",name:Object(l.b)("American Samoa"),prefix:"1"},{iso2:"AD",name:Object(l.b)("Andorra"),prefix:"376"},{iso2:"AO",name:Object(l.b)("Angola"),prefix:"244"},{iso2:"AI",name:Object(l.b)("Anguilla"),prefix:"1"},{iso2:"AQ",name:Object(l.b)("Antarctica"),prefix:"672"},{iso2:"AG",name:Object(l.b)("Antigua & Barbuda"),prefix:"1"},{iso2:"AR",name:Object(l.b)("Argentina"),prefix:"54"},{iso2:"AM",name:Object(l.b)("Armenia"),prefix:"374"},{iso2:"AW",name:Object(l.b)("Aruba"),prefix:"297"},{iso2:"AU",name:Object(l.b)("Australia"),prefix:"61"},{iso2:"AT",name:Object(l.b)("Austria"),prefix:"43"},{iso2:"AZ",name:Object(l.b)("Azerbaijan"),prefix:"994"},{iso2:"BS",name:Object(l.b)("Bahamas"),prefix:"1"},{iso2:"BH",name:Object(l.b)("Bahrain"),prefix:"973"},{iso2:"BD",name:Object(l.b)("Bangladesh"),prefix:"880"},{iso2:"BB",name:Object(l.b)("Barbados"),prefix:"1"},{iso2:"BY",name:Object(l.b)("Belarus"),prefix:"375"},{iso2:"BE",name:Object(l.b)("Belgium"),prefix:"32"},{iso2:"BZ",name:Object(l.b)("Belize"),prefix:"501"},{iso2:"BJ",name:Object(l.b)("Benin"),prefix:"229"},{iso2:"BM",name:Object(l.b)("Bermuda"),prefix:"1"},{iso2:"BT",name:Object(l.b)("Bhutan"),prefix:"975"},{iso2:"BO",name:Object(l.b)("Bolivia"),prefix:"591"},{iso2:"BA",name:Object(l.b)("Bosnia"),prefix:"387"},{iso2:"BW",name:Object(l.b)("Botswana"),prefix:"267"},{iso2:"BV",name:Object(l.b)("Bouvet Island"),prefix:"47"},{iso2:"BR",name:Object(l.b)("Brazil"),prefix:"55"},{iso2:"IO",name:Object(l.b)("British Indian Ocean Territory"),prefix:"246"},{iso2:"VG",name:Object(l.b)("British Virgin Islands"),prefix:"1"},{iso2:"BN",name:Object(l.b)("Brunei"),prefix:"673"},{iso2:"BG",name:Object(l.b)("Bulgaria"),prefix:"359"},{iso2:"BF",name:Object(l.b)("Burkina Faso"),prefix:"226"},{iso2:"BI",name:Object(l.b)("Burundi"),prefix:"257"},{iso2:"KH",name:Object(l.b)("Cambodia"),prefix:"855"},{iso2:"CM",name:Object(l.b)("Cameroon"),prefix:"237"},{iso2:"CA",name:Object(l.b)("Canada"),prefix:"1"},{iso2:"CV",name:Object(l.b)("Cape Verde"),prefix:"238"},{iso2:"BQ",name:Object(l.b)("Caribbean Netherlands"),prefix:"599"},{iso2:"KY",name:Object(l.b)("Cayman Islands"),prefix:"1"},{iso2:"CF",name:Object(l.b)("Central African Republic"),prefix:"236"},{iso2:"TD",name:Object(l.b)("Chad"),prefix:"235"},{iso2:"CL",name:Object(l.b)("Chile"),prefix:"56"},{iso2:"CN",name:Object(l.b)("China"),prefix:"86"},{iso2:"CX",name:Object(l.b)("Christmas Island"),prefix:"61"},{iso2:"CC",name:Object(l.b)("Cocos (Keeling) Islands"),prefix:"61"},{iso2:"CO",name:Object(l.b)("Colombia"),prefix:"57"},{iso2:"KM",name:Object(l.b)("Comoros"),prefix:"269"},{iso2:"CG",name:Object(l.b)("Congo - Brazzaville"),prefix:"242"},{iso2:"CD",name:Object(l.b)("Congo - Kinshasa"),prefix:"243"},{iso2:"CK",name:Object(l.b)("Cook Islands"),prefix:"682"},{iso2:"CR",name:Object(l.b)("Costa Rica"),prefix:"506"},{iso2:"HR",name:Object(l.b)("Croatia"),prefix:"385"},{iso2:"CU",name:Object(l.b)("Cuba"),prefix:"53"},{iso2:"CW",name:Object(l.b)("Curaçao"),prefix:"599"},{iso2:"CY",name:Object(l.b)("Cyprus"),prefix:"357"},{iso2:"CZ",name:Object(l.b)("Czech Republic"),prefix:"420"},{iso2:"CI",name:Object(l.b)("Côte d’Ivoire"),prefix:"225"},{iso2:"DK",name:Object(l.b)("Denmark"),prefix:"45"},{iso2:"DJ",name:Object(l.b)("Djibouti"),prefix:"253"},{iso2:"DM",name:Object(l.b)("Dominica"),prefix:"1"},{iso2:"DO",name:Object(l.b)("Dominican Republic"),prefix:"1"},{iso2:"EC",name:Object(l.b)("Ecuador"),prefix:"593"},{iso2:"EG",name:Object(l.b)("Egypt"),prefix:"20"},{iso2:"SV",name:Object(l.b)("El Salvador"),prefix:"503"},{iso2:"GQ",name:Object(l.b)("Equatorial Guinea"),prefix:"240"},{iso2:"ER",name:Object(l.b)("Eritrea"),prefix:"291"},{iso2:"EE",name:Object(l.b)("Estonia"),prefix:"372"},{iso2:"ET",name:Object(l.b)("Ethiopia"),prefix:"251"},{iso2:"FK",name:Object(l.b)("Falkland Islands"),prefix:"500"},{iso2:"FO",name:Object(l.b)("Faroe Islands"),prefix:"298"},{iso2:"FJ",name:Object(l.b)("Fiji"),prefix:"679"},{iso2:"FI",name:Object(l.b)("Finland"),prefix:"358"},{iso2:"FR",name:Object(l.b)("France"),prefix:"33"},{iso2:"GF",name:Object(l.b)("French Guiana"),prefix:"594"},{iso2:"PF",name:Object(l.b)("French Polynesia"),prefix:"689"},{iso2:"TF",name:Object(l.b)("French Southern Territories"),prefix:"262"},{iso2:"GA",name:Object(l.b)("Gabon"),prefix:"241"},{iso2:"GM",name:Object(l.b)("Gambia"),prefix:"220"},{iso2:"GE",name:Object(l.b)("Georgia"),prefix:"995"},{iso2:"DE",name:Object(l.b)("Germany"),prefix:"49"},{iso2:"GH",name:Object(l.b)("Ghana"),prefix:"233"},{iso2:"GI",name:Object(l.b)("Gibraltar"),prefix:"350"},{iso2:"GR",name:Object(l.b)("Greece"),prefix:"30"},{iso2:"GL",name:Object(l.b)("Greenland"),prefix:"299"},{iso2:"GD",name:Object(l.b)("Grenada"),prefix:"1"},{iso2:"GP",name:Object(l.b)("Guadeloupe"),prefix:"590"},{iso2:"GU",name:Object(l.b)("Guam"),prefix:"1"},{iso2:"GT",name:Object(l.b)("Guatemala"),prefix:"502"},{iso2:"GG",name:Object(l.b)("Guernsey"),prefix:"44"},{iso2:"GN",name:Object(l.b)("Guinea"),prefix:"224"},{iso2:"GW",name:Object(l.b)("Guinea-Bissau"),prefix:"245"},{iso2:"GY",name:Object(l.b)("Guyana"),prefix:"592"},{iso2:"HT",name:Object(l.b)("Haiti"),prefix:"509"},{iso2:"HM",name:Object(l.b)("Heard & McDonald Islands"),prefix:"672"},{iso2:"HN",name:Object(l.b)("Honduras"),prefix:"504"},{iso2:"HK",name:Object(l.b)("Hong Kong"),prefix:"852"},{iso2:"HU",name:Object(l.b)("Hungary"),prefix:"36"},{iso2:"IS",name:Object(l.b)("Iceland"),prefix:"354"},{iso2:"IN",name:Object(l.b)("India"),prefix:"91"},{iso2:"ID",name:Object(l.b)("Indonesia"),prefix:"62"},{iso2:"IR",name:Object(l.b)("Iran"),prefix:"98"},{iso2:"IQ",name:Object(l.b)("Iraq"),prefix:"964"},{iso2:"IE",name:Object(l.b)("Ireland"),prefix:"353"},{iso2:"IM",name:Object(l.b)("Isle of Man"),prefix:"44"},{iso2:"IL",name:Object(l.b)("Israel"),prefix:"972"},{iso2:"IT",name:Object(l.b)("Italy"),prefix:"39"},{iso2:"JM",name:Object(l.b)("Jamaica"),prefix:"1"},{iso2:"JP",name:Object(l.b)("Japan"),prefix:"81"},{iso2:"JE",name:Object(l.b)("Jersey"),prefix:"44"},{iso2:"JO",name:Object(l.b)("Jordan"),prefix:"962"},{iso2:"KZ",name:Object(l.b)("Kazakhstan"),prefix:"7"},{iso2:"KE",name:Object(l.b)("Kenya"),prefix:"254"},{iso2:"KI",name:Object(l.b)("Kiribati"),prefix:"686"},{iso2:"XK",name:Object(l.b)("Kosovo"),prefix:"383"},{iso2:"KW",name:Object(l.b)("Kuwait"),prefix:"965"},{iso2:"KG",name:Object(l.b)("Kyrgyzstan"),prefix:"996"},{iso2:"LA",name:Object(l.b)("Laos"),prefix:"856"},{iso2:"LV",name:Object(l.b)("Latvia"),prefix:"371"},{iso2:"LB",name:Object(l.b)("Lebanon"),prefix:"961"},{iso2:"LS",name:Object(l.b)("Lesotho"),prefix:"266"},{iso2:"LR",name:Object(l.b)("Liberia"),prefix:"231"},{iso2:"LY",name:Object(l.b)("Libya"),prefix:"218"},{iso2:"LI",name:Object(l.b)("Liechtenstein"),prefix:"423"},{iso2:"LT",name:Object(l.b)("Lithuania"),prefix:"370"},{iso2:"LU",name:Object(l.b)("Luxembourg"),prefix:"352"},{iso2:"MO",name:Object(l.b)("Macau"),prefix:"853"},{iso2:"MK",name:Object(l.b)("Macedonia"),prefix:"389"},{iso2:"MG",name:Object(l.b)("Madagascar"),prefix:"261"},{iso2:"MW",name:Object(l.b)("Malawi"),prefix:"265"},{iso2:"MY",name:Object(l.b)("Malaysia"),prefix:"60"},{iso2:"MV",name:Object(l.b)("Maldives"),prefix:"960"},{iso2:"ML",name:Object(l.b)("Mali"),prefix:"223"},{iso2:"MT",name:Object(l.b)("Malta"),prefix:"356"},{iso2:"MH",name:Object(l.b)("Marshall Islands"),prefix:"692"},{iso2:"MQ",name:Object(l.b)("Martinique"),prefix:"596"},{iso2:"MR",name:Object(l.b)("Mauritania"),prefix:"222"},{iso2:"MU",name:Object(l.b)("Mauritius"),prefix:"230"},{iso2:"YT",name:Object(l.b)("Mayotte"),prefix:"262"},{iso2:"MX",name:Object(l.b)("Mexico"),prefix:"52"},{iso2:"FM",name:Object(l.b)("Micronesia"),prefix:"691"},{iso2:"MD",name:Object(l.b)("Moldova"),prefix:"373"},{iso2:"MC",name:Object(l.b)("Monaco"),prefix:"377"},{iso2:"MN",name:Object(l.b)("Mongolia"),prefix:"976"},{iso2:"ME",name:Object(l.b)("Montenegro"),prefix:"382"},{iso2:"MS",name:Object(l.b)("Montserrat"),prefix:"1"},{iso2:"MA",name:Object(l.b)("Morocco"),prefix:"212"},{iso2:"MZ",name:Object(l.b)("Mozambique"),prefix:"258"},{iso2:"MM",name:Object(l.b)("Myanmar"),prefix:"95"},{iso2:"NA",name:Object(l.b)("Namibia"),prefix:"264"},{iso2:"NR",name:Object(l.b)("Nauru"),prefix:"674"},{iso2:"NP",name:Object(l.b)("Nepal"),prefix:"977"},{iso2:"NL",name:Object(l.b)("Netherlands"),prefix:"31"},{iso2:"NC",name:Object(l.b)("New Caledonia"),prefix:"687"},{iso2:"NZ",name:Object(l.b)("New Zealand"),prefix:"64"},{iso2:"NI",name:Object(l.b)("Nicaragua"),prefix:"505"},{iso2:"NE",name:Object(l.b)("Niger"),prefix:"227"},{iso2:"NG",name:Object(l.b)("Nigeria"),prefix:"234"},{iso2:"NU",name:Object(l.b)("Niue"),prefix:"683"},{iso2:"NF",name:Object(l.b)("Norfolk Island"),prefix:"672"},{iso2:"KP",name:Object(l.b)("North Korea"),prefix:"850"},{iso2:"MP",name:Object(l.b)("Northern Mariana Islands"),prefix:"1"},{iso2:"NO",name:Object(l.b)("Norway"),prefix:"47"},{iso2:"OM",name:Object(l.b)("Oman"),prefix:"968"},{iso2:"PK",name:Object(l.b)("Pakistan"),prefix:"92"},{iso2:"PW",name:Object(l.b)("Palau"),prefix:"680"},{iso2:"PS",name:Object(l.b)("Palestine"),prefix:"970"},{iso2:"PA",name:Object(l.b)("Panama"),prefix:"507"},{iso2:"PG",name:Object(l.b)("Papua New Guinea"),prefix:"675"},{iso2:"PY",name:Object(l.b)("Paraguay"),prefix:"595"},{iso2:"PE",name:Object(l.b)("Peru"),prefix:"51"},{iso2:"PH",name:Object(l.b)("Philippines"),prefix:"63"},{iso2:"PN",name:Object(l.b)("Pitcairn Islands"),prefix:"870"},{iso2:"PL",name:Object(l.b)("Poland"),prefix:"48"},{iso2:"PT",name:Object(l.b)("Portugal"),prefix:"351"},{iso2:"PR",name:Object(l.b)("Puerto Rico"),prefix:"1"},{iso2:"QA",name:Object(l.b)("Qatar"),prefix:"974"},{iso2:"RO",name:Object(l.b)("Romania"),prefix:"40"},{iso2:"RU",name:Object(l.b)("Russia"),prefix:"7"},{iso2:"RW",name:Object(l.b)("Rwanda"),prefix:"250"},{iso2:"RE",name:Object(l.b)("Réunion"),prefix:"262"},{iso2:"WS",name:Object(l.b)("Samoa"),prefix:"685"},{iso2:"SM",name:Object(l.b)("San Marino"),prefix:"378"},{iso2:"SA",name:Object(l.b)("Saudi Arabia"),prefix:"966"},{iso2:"SN",name:Object(l.b)("Senegal"),prefix:"221"},{iso2:"RS",name:Object(l.b)("Serbia"),prefix:"381 p"},{iso2:"SC",name:Object(l.b)("Seychelles"),prefix:"248"},{iso2:"SL",name:Object(l.b)("Sierra Leone"),prefix:"232"},{iso2:"SG",name:Object(l.b)("Singapore"),prefix:"65"},{iso2:"SX",name:Object(l.b)("Sint Maarten"),prefix:"1"},{iso2:"SK",name:Object(l.b)("Slovakia"),prefix:"421"},{iso2:"SI",name:Object(l.b)("Slovenia"),prefix:"386"},{iso2:"SB",name:Object(l.b)("Solomon Islands"),prefix:"677"},{iso2:"SO",name:Object(l.b)("Somalia"),prefix:"252"},{iso2:"ZA",name:Object(l.b)("South Africa"),prefix:"27"},{iso2:"GS",name:Object(l.b)("South Georgia & South Sandwich Islands"),prefix:"500"},{iso2:"KR",name:Object(l.b)("South Korea"),prefix:"82"},{iso2:"SS",name:Object(l.b)("South Sudan"),prefix:"211"},{iso2:"ES",name:Object(l.b)("Spain"),prefix:"34"},{iso2:"LK",name:Object(l.b)("Sri Lanka"),prefix:"94"},{iso2:"BL",name:Object(l.b)("St. Barthélemy"),prefix:"590"},{iso2:"SH",name:Object(l.b)("St. Helena"),prefix:"290 n"},{iso2:"KN",name:Object(l.b)("St. Kitts & Nevis"),prefix:"1"},{iso2:"LC",name:Object(l.b)("St. Lucia"),prefix:"1"},{iso2:"MF",name:Object(l.b)("St. Martin"),prefix:"590"},{iso2:"PM",name:Object(l.b)("St. Pierre & Miquelon"),prefix:"508"},{iso2:"VC",name:Object(l.b)("St. Vincent & Grenadines"),prefix:"1"},{iso2:"SD",name:Object(l.b)("Sudan"),prefix:"249"},{iso2:"SR",name:Object(l.b)("Suriname"),prefix:"597"},{iso2:"SJ",name:Object(l.b)("Svalbard & Jan Mayen"),prefix:"47"},{iso2:"SZ",name:Object(l.b)("Swaziland"),prefix:"268"},{iso2:"SE",name:Object(l.b)("Sweden"),prefix:"46"},{iso2:"CH",name:Object(l.b)("Switzerland"),prefix:"41"},{iso2:"SY",name:Object(l.b)("Syria"),prefix:"963"},{iso2:"ST",name:Object(l.b)("São Tomé & Príncipe"),prefix:"239"},{iso2:"TW",name:Object(l.b)("Taiwan"),prefix:"886"},{iso2:"TJ",name:Object(l.b)("Tajikistan"),prefix:"992"},{iso2:"TZ",name:Object(l.b)("Tanzania"),prefix:"255"},{iso2:"TH",name:Object(l.b)("Thailand"),prefix:"66"},{iso2:"TL",name:Object(l.b)("Timor-Leste"),prefix:"670"},{iso2:"TG",name:Object(l.b)("Togo"),prefix:"228"},{iso2:"TK",name:Object(l.b)("Tokelau"),prefix:"690"},{iso2:"TO",name:Object(l.b)("Tonga"),prefix:"676"},{iso2:"TT",name:Object(l.b)("Trinidad & Tobago"),prefix:"1"},{iso2:"TN",name:Object(l.b)("Tunisia"),prefix:"216"},{iso2:"TR",name:Object(l.b)("Turkey"),prefix:"90"},{iso2:"TM",name:Object(l.b)("Turkmenistan"),prefix:"993"},{iso2:"TC",name:Object(l.b)("Turks & Caicos Islands"),prefix:"1"},{iso2:"TV",name:Object(l.b)("Tuvalu"),prefix:"688"},{iso2:"VI",name:Object(l.b)("U.S. Virgin Islands"),prefix:"1"},{iso2:"UG",name:Object(l.b)("Uganda"),prefix:"256"},{iso2:"UA",name:Object(l.b)("Ukraine"),prefix:"380"},{iso2:"AE",name:Object(l.b)("United Arab Emirates"),prefix:"971"},{iso2:"UY",name:Object(l.b)("Uruguay"),prefix:"598"},{iso2:"UZ",name:Object(l.b)("Uzbekistan"),prefix:"998"},{iso2:"VU",name:Object(l.b)("Vanuatu"),prefix:"678"},{iso2:"VA",name:Object(l.b)("Vatican City"),prefix:"39"},{iso2:"VE",name:Object(l.b)("Venezuela"),prefix:"58"},{iso2:"VN",name:Object(l.b)("Vietnam"),prefix:"84"},{iso2:"WF",name:Object(l.b)("Wallis & Futuna"),prefix:"681"},{iso2:"EH",name:Object(l.b)("Western Sahara"),prefix:"212"},{iso2:"YE",name:Object(l.b)("Yemen"),prefix:"967"},{iso2:"ZM",name:Object(l.b)("Zambia"),prefix:"260"},{iso2:"ZW",name:Object(l.b)("Zimbabwe"),prefix:"263"}],Oa={};for(const e of Ra)Oa[e.iso2]=e;function ka(e,t){return"+"===e[0]&&(e=e.slice(1)),0==t.name.toUpperCase().indexOf(e.toUpperCase())||(t.iso2==e.toUpperCase()||-1!==t.prefix.indexOf(e))}class Ia extends i.a.Component{constructor(e){super(e),this._onSearchChange=this._onSearchChange.bind(this),this._onOptionChange=this._onOptionChange.bind(this),this._getShortOption=this._getShortOption.bind(this);let t=Ra[0];const s=c.a.get().defaultCountryCode;if(s){const e=Ra.find(e=>e.iso2===s.toUpperCase());e&&(t=e)}this.state={searchQuery:"",defaultCountry:t}}componentDidMount(){this.props.value||this.props.onOptionChange(this.state.defaultCountry)}_onSearchChange(e){this.setState({searchQuery:e})}_onOptionChange(e){this.props.onOptionChange(Oa[e])}_flagImgForIso2(e){return i.a.createElement("div",{className:"mx_Dropdown_option_emoji"},(t=e,xa.test(t)?String.fromCodePoint(...t.split("").map(e=>Sa+e.charCodeAt(0))):""));var t}_getShortOption(e){if(!this.props.isSmall)return;let t;return this.props.showPrefix&&(t="+"+Oa[e].prefix),i.a.createElement("span",{className:"mx_CountryDropdown_shortOption"},this._flagImgForIso2(e),t)}render(){const e=d.getComponent("elements.Dropdown");let t;if(this.state.searchQuery){if(t=Ra.filter(ka.bind(this,this.state.searchQuery)),2==this.state.searchQuery.length&&Oa[this.state.searchQuery.toUpperCase()]){const e=Oa[this.state.searchQuery.toUpperCase()];t=t.filter(t=>t.iso2!=e.iso2),t.unshift(e)}}else t=Ra;const s=t.map(e=>i.a.createElement("div",{className:"mx_CountryDropdown_option",key:e.iso2},this._flagImgForIso2(e.iso2),Object(l.a)(e.name)," (+",e.prefix,")")),n=this.props.value||this.state.defaultCountry.iso2;return i.a.createElement(e,{id:"mx_CountryDropdown",className:this.props.className+" mx_CountryDropdown",onOptionChange:this._onOptionChange,onSearchChange:this._onSearchChange,menuWidth:298,getShortOption:this._getShortOption,value:n,searchEnabled:!0,disabled:this.props.disabled,label:Object(l.a)("Country Dropdown")},s)}}Ia.propTypes={className:xe.a.string,isSmall:xe.a.bool,showPrefix:xe.a.bool,onOptionChange:xe.a.func.isRequired,value:xe.a.string,disabled:xe.a.bool};const Ta=/^[0-9()\-\s]*$/;var ja;!function(e){e.Email="login_field_email",e.MatrixId="login_field_mxid",e.Phone="login_field_phone",e.Password="login_field_phone"}(ja||(ja={}));class Na extends i.a.PureComponent{constructor(e){super(e),I()(this,"onForgotPasswordClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onForgotPasswordClick()}),I()(this,"onSubmitForm",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return void y.a.instance.track("onboarding_registration_submit_failed");let t=this.props.username;this.props.onSubmit(t,null,null,this.state.password)}),I()(this,"onUsernameChanged",e=>{this.props.onUsernameChanged(e.target.value)}),I()(this,"onUsernameFocus",()=>{this.state.loginType===ja.MatrixId?y.a.instance.track("onboarding_login_mxid_focus"):y.a.instance.track("onboarding_login_email_focus")}),I()(this,"onUsernameBlur",e=>{this.state.loginType===ja.MatrixId?y.a.instance.track("onboarding_login_mxid_blur"):y.a.instance.track("onboarding_login_email_blur"),this.props.onUsernameBlur(e.target.value)}),I()(this,"onLoginTypeChange",e=>{const t=e.target.value;this.setState({loginType:t}),this.props.onUsernameChanged(""),y.a.instance.track("onboarding_login_type_changed",{loginType:t})}),I()(this,"onPhoneCountryChanged",e=>{this.props.onPhoneCountryChanged(e.iso2)}),I()(this,"onPhoneNumberChanged",e=>{this.props.onPhoneNumberChanged(e.target.value)}),I()(this,"onPhoneNumberFocus",()=>{y.a.instance.track("onboarding_login_phone_number_focus")}),I()(this,"onPhoneNumberBlur",e=>{y.a.instance.track("onboarding_login_phone_number_blur")}),I()(this,"onPasswordChanged",e=>{this.setState({password:e.target.value})}),I()(this,"validateUsernameRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Enter username")}]})),I()(this,"onUsernameValidate",async e=>{const t=await this.validateUsernameRules(e);return this.markFieldValid(ja.MatrixId,t.valid),t}),I()(this,"validateEmailRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Enter email address")},{key:"email",test:({value:e})=>!e||wa.a(e),invalid:()=>Object(l.a)("Doesn't look like a valid email address")}]})),I()(this,"onEmailValidate",async e=>{const t=await this.validateEmailRules(e);return this.markFieldValid(ja.Email,t.valid),t}),I()(this,"validatePhoneNumberRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Enter phone number")},{key:"number",test:({value:e})=>!e||Ta.test(e),invalid:()=>Object(l.a)("That phone number doesn't look quite right, please check and try again")}]})),I()(this,"onPhoneNumberValidate",async e=>{const t=await this.validatePhoneNumberRules(e);return this.markFieldValid(ja.Password,t.valid),t}),I()(this,"validatePasswordRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Enter password")}]})),I()(this,"onPasswordValidate",async e=>{const t=await this.validatePasswordRules(e);return this.markFieldValid(ja.Password,t.valid),t}),this.state={fieldValid:{},loginType:ja.Email,password:""}}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[this.state.loginType,ja.Password];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}renderLoginField(e,t){const s={error:!1};switch(e){case ja.Email:return s.error=this.props.loginIncorrect&&!this.props.username,i.a.createElement(ke.a,{className:L()(s),name:"username",key:"email_input",type:"text",label:Object(l.a)("Email"),placeholder:"joe@example.com",value:this.props.username,onChange:this.onUsernameChanged,onFocus:this.onUsernameFocus,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onEmailValidate,ref:e=>this[ja.Email]=e});case ja.MatrixId:return s.error=this.props.loginIncorrect&&!this.props.username,i.a.createElement(ke.a,{className:L()(s),name:"username",key:"username_input",type:"text",label:Object(l.a)("Username"),placeholder:Object(l.a)("Username").toLocaleLowerCase(),value:this.props.username,onChange:this.onUsernameChanged,onFocus:this.onUsernameFocus,onBlur:this.onUsernameBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onUsernameValidate,ref:e=>this[ja.MatrixId]=e});case ja.Phone:{s.error=this.props.loginIncorrect&&!this.props.phoneNumber;const e=i.a.createElement(Ia,{value:this.props.phoneCountry,isSmall:!0,showPrefix:!0,onOptionChange:this.onPhoneCountryChanged});return i.a.createElement(ke.a,{className:L()(s),name:"phoneNumber",key:"phone_input",type:"text",label:Object(l.a)("Phone"),value:this.props.phoneNumber,prefixComponent:e,onChange:this.onPhoneNumberChanged,onFocus:this.onPhoneNumberFocus,onBlur:this.onPhoneNumberBlur,disabled:this.props.disableSubmit,autoFocus:t,onValidate:this.onPhoneNumberValidate,ref:e=>this[ja.Password]=e})}}}isLoginEmpty(){switch(this.state.loginType){case ja.Email:case ja.MatrixId:return!this.props.username;case ja.Phone:return!this.props.phoneCountry||!this.props.phoneNumber}}render(){let e;this.props.onForgotPasswordClick&&(e=i.a.createElement(pe.a,{className:"mx_Login_forgot",disabled:this.props.busy,kind:"link",onClick:this.onForgotPasswordClick},Object(l.a)("Forgot password?")));const t=L()({error:this.props.loginIncorrect&&!this.isLoginEmpty()}),s=!this.isLoginEmpty(),n=this.renderLoginField(this.state.loginType,!s);let a;return c.a.get().disable_3pid_login||(a=i.a.createElement("div",{className:"mx_Login_type_container"},i.a.createElement("label",{className:"mx_Login_type_label"},Object(l.a)("Sign in with")),i.a.createElement(ke.a,{element:"select",value:this.state.loginType,onChange:this.onLoginTypeChange,disabled:this.props.disableSubmit},i.a.createElement("option",{key:ja.MatrixId,value:ja.MatrixId},Object(l.a)("Username")),i.a.createElement("option",{key:ja.Email,value:ja.Email},Object(l.a)("Email address")),i.a.createElement("option",{key:ja.Password,value:ja.Password},Object(l.a)("Phone"))))),i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this.onSubmitForm},n,i.a.createElement(ke.a,{className:t,type:"password",name:"password",label:Object(l.a)("Password"),value:this.state.password,onChange:this.onPasswordChanged,disabled:this.props.disableSubmit,autoFocus:s,onValidate:this.onPasswordValidate,ref:e=>this[ja.Password]=e}),e,!this.props.busy&&i.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(l.a)("Sign in"),disabled:this.props.disableSubmit})))}}I()(Na,"defaultProps",{onUsernameChanged:function(){},onUsernameBlur:function(){},loginIncorrect:!1,disableSubmit:!1});var Pa=s(106);const Da=e=>{let{matrixClient:t,loginType:n,fragmentAfterLogin:a,idp:o,primary:r,mini:c}=e,d=ae()(e,["matrixClient","loginType","fragmentAfterLogin","idp","primary","mini"]);const m=o?Object(l.a)("Continue with %(provider)s",{provider:o.name}):Object(l.a)("Sign in with single sign-on"),h=()=>{qe.a.get().startSingleSignOn(t,n,a,null==o?void 0:o.id)};let u,p;const g=o?(e=>{switch(e){case _a.a.Apple:return s(1263);case _a.a.Facebook:return s(1264);case _a.a.Github:return s(1265);case _a.a.Gitlab:return s(1266);case _a.a.Google:return s(1267);case _a.a.Twitter:return s(1268);default:return null}})(o.brand):null;if(g){const e=o.brand.split(".").pop();p="mx_SSOButton_brand_"+e,u=i.a.createElement("img",{src:g,height:"24",width:"24",alt:e})}else if("string"==typeof(null==o?void 0:o.icon)&&o.icon.startsWith("mxc://")){const e=t.mxcUrlToHttp(o.icon,24,24,"crop",!0);u=i.a.createElement("img",{src:e,height:"24",width:"24",alt:o.name})}const f=L()("mx_SSOButton",{[p]:p,mx_SSOButton_mini:c,mx_SSOButton_default:!o,mx_SSOButton_primary:r});return c?i.a.createElement(B.a,se()({},d,{title:m,className:f,onClick:h}),u):i.a.createElement(pe.a,se()({},d,{className:f,onClick:h}),u,m)};var Aa=({matrixClient:e,flow:t,loginType:s,fragmentAfterLogin:n,primary:a})=>{const o=t["org.matrix.msc2858.identity_providers"]||[];if(o.length<2)return i.a.createElement("div",{className:"mx_SSOButtons"},i.a.createElement(Da,{matrixClient:e,loginType:s,fragmentAfterLogin:n,idp:o[0],primary:a}));const r=Math.ceil(o.length/6),l=Math.ceil(o.length/r);return i.a.createElement("div",{className:"mx_SSOButtons"},Object(Pa.chunk)(o,l).map(t=>i.a.createElement("div",{key:t[0].id,className:"mx_SSOButtons_row"},t.map(t=>i.a.createElement(Da,{key:t.id,matrixClient:e,loginType:s,fragmentAfterLogin:n,idp:t,mini:!0,primary:a})))))};Object(l.b)("Invalid homeserver discovery response"),Object(l.b)("Failed to get autodiscovery configuration from server"),Object(l.b)("Invalid base_url for m.homeserver"),Object(l.b)("Homeserver URL does not appear to be a valid Matrix homeserver"),Object(l.b)("Invalid identity server discovery response"),Object(l.b)("Invalid base_url for m.identity_server"),Object(l.b)("Identity server URL does not appear to be a valid identity server"),Object(l.b)("General failure");class Ua extends i.a.PureComponent{constructor(e){super(e),I()(this,"unmounted",!1),I()(this,"loginLogic",void 0),I()(this,"stepRendererMap",void 0),I()(this,"isBusy",()=>this.state.busy||this.props.busy),I()(this,"onPasswordLogin",async(e,t,s,n)=>{this.setState({busy:!0,busyLoggingIn:!0,errorText:null,loginIncorrect:!1}),await E.a.discoverPlatform(e).then(e=>{this.initLoginLogic(e,e)}).then(()=>{this.loginLogic.loginViaPassword(e,t,s,n).then(e=>{this.setState({serverIsAlive:!0}),this.props.onLoggedIn(e,n)},e=>{if(this.unmounted)return;let t;t=401===e.httpStatus||403===e.httpStatus?"M_USER_DEACTIVATED"===e.errcode?Object(l.a)("This account has been deactivated."):Object(l.a)("Incorrect username and/or password."):this.errorTextFromError(e),this.setState({busy:!1,busyLoggingIn:!1,errorText:t,loginIncorrect:401===e.httpStatus||403===e.httpStatus})})})}),I()(this,"onUsernameChanged",e=>{this.setState({username:e})}),I()(this,"onUsernameBlur",async e=>{this.setState({username:e,errorText:null,canTryLogin:!0})}),I()(this,"onRegisterClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onRegisterClick()}),I()(this,"onTryRegisterClick",e=>{this.onRegisterClick(e)}),I()(this,"isSupportedFlow",e=>!!this.stepRendererMap[e.type]||(console.log("Skipping flow",e,"due to unsupported login type",e.type),!1)),I()(this,"renderPasswordStep",()=>i.a.createElement(Na,{onSubmit:this.onPasswordLogin,username:this.state.username,onUsernameChanged:this.onUsernameChanged,onUsernameBlur:this.onUsernameBlur,onForgotPasswordClick:this.props.onForgotPasswordClick,loginIncorrect:this.state.loginIncorrect,serverConfig:null,disableSubmit:this.isBusy(),busy:this.props.isSyncing||this.state.busyLoggingIn})),I()(this,"renderSsoStep",e=>{const t=this.state.flows.find(t=>t.type==="m.login."+e);return i.a.createElement(Aa,{matrixClient:this.loginLogic.createTemporaryClient(),flow:t,loginType:e,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)})}),this.state={busy:!1,busyLoggingIn:null,errorText:null,loginIncorrect:!1,canTryLogin:!0,flows:null,username:"",serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""},this.stepRendererMap={"m.login.password":this.renderPasswordStep},y.a.instance.track("onboarding_login_begin")}componentDidMount(){const e=E.a.getRandomHSUrlFromList();this.initLoginLogic(e,e)}componentWillUnmount(){this.unmounted=!0}async initLoginLogic(e,t){const s=new _a.b(e,t,null,{defaultDeviceDisplayName:this.props.defaultDeviceDisplayName});this.loginLogic=s,this.setState({busy:!0,loginIncorrect:!1}),s.getFlows().then(e=>{const t=e.filter(this.isSupportedFlow);t.length>0?this.setState({flows:t}):this.setState({errorText:Object(l.a)("This homeserver doesn't offer any login flows which are supported by this client.")})},e=>{this.setState({errorText:this.errorTextFromError(e),loginIncorrect:!1,canTryLogin:!1})}).finally(()=>{this.setState({busy:!1})})}errorTextFromError(e){let t=e.errcode;!t&&e.httpStatus&&(t="HTTP "+e.httpStatus);let s="";return s="M_LIMIT_EXCEEDED"===t?"Your last three login attempts have failed. Please try again in 30 minutes.":Object(l.a)("Error: Problem communicating with the given homeserver.")+(t?" ("+t+")":""),"rejected"===e.cors&&(s=Object(l.a)("Homeserver unreachable.")),s}renderLoginComponentForFlows(){if(!this.state.flows)return null;const e=["m.login.password","m.login.sso"].map(e=>this.state.flows.find(t=>t.type===e)).filter(Boolean);return i.a.createElement(i.a.Fragment,null,e.map(e=>{const t=this.stepRendererMap[e.type];return i.a.createElement(i.a.Fragment,{key:e.type},t())}))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=this.isBusy()&&!this.state.busyLoggingIn?i.a.createElement("div",{className:"mx_Login_loader"},i.a.createElement(Je.a,null)):null,n=this.state.errorText;let a,o,r;if(n&&(a=i.a.createElement("div",{className:"mx_Login_error"},n)),!this.state.serverIsAlive){const e=L()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});o=i.a.createElement("div",{className:e},this.state.serverDeadError)}return r=this.props.isSyncing||this.state.busyLoggingIn?i.a.createElement("div",{className:"mx_AuthBody_paddedFooter"},i.a.createElement("div",{className:"mx_AuthBody_paddedFooter_title"},i.a.createElement(qt.a,{w:20,h:20}),this.props.isSyncing?Object(l.a)("Syncing..."):Object(l.a)("Signing In...")),this.props.isSyncing&&i.a.createElement("div",{className:"mx_AuthBody_paddedFooter_subtitle"},Object(l.a)("If you've joined lots of rooms, this might take a while"))):i.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(l.a)("New? <a>Create account</a>",{},{a:e=>i.a.createElement("a",{onClick:this.onTryRegisterClick,href:"#"},e)})),i.a.createElement(Ea,null,i.a.createElement(e,{disableLanguageSelector:this.props.isSyncing||this.state.busyLoggingIn}),i.a.createElement(t,null,i.a.createElement("h2",null,Object(l.a)("Sign in"),s),a,o,this.renderLoginComponentForFlows(),r))}}var Ma=s(358);class La extends i.a.Component{constructor(e){super(e),I()(this,"loginLogic",void 0),I()(this,"onFormSubmit",e=>{E.a.discoverPlatform(e.email).then(t=>{Ma.a.isPasswordValid(e.password).isValid?this.setState({errorText:"",busy:!0,formVals:e,doingUIAuth:!0}):this.setState({errorText:Object(l.a)("This password is too weak. It must include a lower-case letter, an upper-case letter, a number and a symbol and be at a minimum 8 characters in length.")}),this.replaceClient(t)}).catch(e=>{let t;console.warn(e),t="ERR_UNREACHABLE_HOMESERVER"===e?Object(l.a)("Unreachable Homeserver"):e,this.setState({errorText:t,busy:!1})})}),I()(this,"requestEmailToken",(e,t,s,n)=>this.state.matrixClient.requestRegisterEmailToken(e,t,1,this.props.makeRegistrationUrl({client_secret:t,hs_url:this.state.matrixClient.getHomeserverUrl(),is_url:this.state.matrixClient.getIdentityServerUrl(),session_id:n}))),I()(this,"onUIAuthFinished",async(e,t,s)=>{if(!e){let e=t.message||t.toString();if("M_RESOURCE_LIMIT_EXCEEDED"===t.errcode){const s=nn(t.data.limit_type,t.data.admin_contact,{monthly_active_user:Object(l.b)("This homeserver has hit its Monthly Active User limit."),"":Object(l.b)("This homeserver has exceeded one of its resource limits.")}),n=nn(t.data.limit_type,t.data.admin_contact,{"":Object(l.b)("Please <a>contact your service administrator</a> to continue using this service.")});e=i.a.createElement("div",null,i.a.createElement("p",null,s),i.a.createElement("p",null,n))}else if(t.required_stages&&t.required_stages.indexOf("m.login.msisdn")>-1){let s=!1;for(const e of t.available_flows)s=s||e.stages.includes("m.login.msisdn");s||(e=Object(l.a)("This server does not support authentication with a phone number."))}else"M_USER_IN_USE"===t.errcode&&(e=Object(l.a)("That username already exists, please try another."));return void this.setState({busy:!1,doingUIAuth:!1,errorText:e})}ee.a.setJustRegisteredUserId(t.user_id);const n={doingUIAuth:!1,registeredUsername:t.user_id,differentLoggedInUserId:null,completedNoSignin:!1,busy:!0},[a,o]=await Le.b();a&&!o&&a!==t.userId&&(console.log(`Found a session for ${a} but ${t.userId} has just registered.`),n.differentLoggedInUserId=a),t.access_token?(await this.props.onLoggedIn({userId:t.user_id,deviceId:t.device_id,homeserverUrl:this.state.matrixClient.getHomeserverUrl(),identityServerUrl:this.state.matrixClient.getIdentityServerUrl(),accessToken:t.access_token},this.state.formVals.password),this.setupPushers()):(n.busy=!1,n.completedNoSignin=!0),this.setState(n)}),I()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),I()(this,"onGoToFormClicked",e=>{e.preventDefault(),e.stopPropagation(),this.replaceClient(),this.setState({busy:!1,doingUIAuth:!1})}),I()(this,"makeRegisterRequest",e=>{let t=Boolean(this.state.formVals.email);return this.state.formVals.password||(t=null),E.a.discoverPlatform(this.state.formVals.email).then(e=>{if(e!==this.state.matrixClient.baseUrl)return this.replaceClient(e)}).then(()=>{const s={email:this.state.formVals.email,password:this.state.formVals.password,initial_device_display_name:this.props.defaultDeviceDisplayName,auth:void 0,inhibit_login:void 0};return e&&(s.auth=e),null!=t&&(s.inhibit_login=t),this.state.matrixClient.registerRequest(s)})}),I()(this,"onLoginClickWithCheck",async e=>{e.preventDefault();await Le.g({ignoreGuest:!0})||this.props.onLoginClick()}),this.state={busy:!1,errorText:null,formVals:{email:this.props.email},doingUIAuth:Boolean(this.props.sessionId),flows:null,completedNoSignin:!1,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""}}componentDidMount(){this.replaceClient()}UNSAFE_componentWillReceiveProps(e){this.replaceClient()}async replaceClient(e=null){this.setState({errorText:null,serverDeadError:null,serverErrorIsFatal:!1,busy:!0});let t=e;e||(t=E.a.getRandomHSUrlFromList());const s=Fe.q.createClient({baseUrl:t,idBaseUrl:t});this.setState({matrixClient:s,busy:!1});const n=e=>{this.setState({errorText:Object(l.a)("Unable to query for supported registration methods."),flows:[]})};try{this.state.doingUIAuth||(await this.makeRegisterRequest(null),console.log("Expecting 401 from register request but got success!"))}catch(e){401===e.httpStatus?this.setState({flows:e.data.flows}):(console.log("Unable to query for supported registration methods.",e),n())}}setupPushers(){if(!this.props.brand)return Promise.resolve();const e=ee.a.get();return e.getPushers().then(t=>{const s=t.pushers;for(let t=0;t<s.length;++t)if("email"===s[t].kind){const n=s[t];n.data={brand:this.props.brand},e.setPusher(n).then(()=>{console.log("Set email branding to "+this.props.brand)},e=>{console.error("Couldn't set email branding: "+e)})}},e=>{console.error("Couldn't get pushers: "+e)})}getUIAuthInputs(){return{emailAddress:this.state.formVals.email}}renderRegisterComponent(){const e=d.getComponent("structures.InteractiveAuth"),t=d.getComponent("elements.Spinner"),s=d.getComponent("auth.RegistrationForm");return this.state.matrixClient&&this.state.doingUIAuth?i.a.createElement(e,{matrixClient:this.state.matrixClient,makeRequest:this.makeRegisterRequest,onAuthFinished:this.onUIAuthFinished,inputs:this.getUIAuthInputs(),requestEmailToken:this.requestEmailToken,sessionId:this.props.sessionId,clientSecret:this.props.clientSecret,emailSid:this.props.idSid,poll:!0}):this.state.matrixClient||this.state.busy?this.state.busy||!this.state.flows?i.a.createElement("div",{className:"mx_AuthBody_spinner"},i.a.createElement(t,null)):this.state.flows.length?i.a.createElement(i.a.Fragment,null,i.a.createElement(s,{defaultEmail:this.state.formVals.email,defaultPassword:this.state.formVals.password,onRegisterClick:this.onFormSubmit,flows:this.state.flows,serverConfig:null,canSubmit:!this.state.serverErrorIsFatal})):void 0:null}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=d.getComponent("elements.AccessibleButton");let n;const a=this.state.errorText;let o;if(a&&(n=i.a.createElement("div",{className:"mx_Login_error"},a)),!this.state.serverIsAlive){const e=L()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});o=i.a.createElement("div",{className:e},this.state.serverDeadError)}const r=i.a.createElement("span",{className:"mx_AuthBody_changeFlow"},Object(l.a)("Already have an account? <a>Sign in here</a>",{},{a:e=>i.a.createElement("a",{onClick:this.onLoginClick,href:"#"},e)}));let c,m;if(this.state.doingUIAuth&&(c=i.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onGoToFormClicked,href:"#"},Object(l.a)("Go back"))),this.state.completedNoSignin){let e;e=this.state.differentLoggedInUserId?i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Your new account (%(newAccountId)s) is registered, but you're already logged into a different account (%(loggedInUserId)s).",{newAccountId:this.state.registeredUsername,loggedInUserId:this.state.differentLoggedInUserId})),i.a.createElement("p",null,i.a.createElement(s,{element:"span",className:"mx_linkButton",onClick:this.onLoginClickWithCheck},Object(l.a)("Continue with previous account")))):this.state.formVals.password?i.a.createElement("h3",null,Object(l.a)("<a>Log in</a> to your new account.",{},{a:e=>i.a.createElement("a",{href:"#/login",onClick:this.onLoginClickWithCheck},e)})):i.a.createElement("h3",null,Object(l.a)("You can now close this window or <a>log in</a> to your new account.",{},{a:e=>i.a.createElement("a",{href:"#/login",onClick:this.onLoginClickWithCheck},e)})),m=i.a.createElement("div",null,i.a.createElement("h2",null,Object(l.a)("Registration Successful")),e)}else m=i.a.createElement("div",null,i.a.createElement("h2",null,Object(l.a)("Create account")),n,o,this.renderRegisterComponent(),c,r);return i.a.createElement(Ea,null,i.a.createElement(e,null),i.a.createElement(t,null,m))}}var Fa,Ba=s(258);!function(e){e.Email="field_email",e.Password="field_password",e.PasswordConfirm="field_password_confirm"}(Fa||(Fa={}));class Va extends i.a.PureComponent{constructor(e){super(e),I()(this,"onSubmit",async e=>{if(e.preventDefault(),e.persist(),!this.props.canSubmit)return;await this.verifyFieldsBeforeSubmit()?this.doSubmit(e):y.a.instance.track("onboarding_registration_submit_failed")}),I()(this,"onEmailChange",e=>{this.setState({email:e.target.value,isExtern:!1})}),I()(this,"onEmailValidate",async e=>{const t=await this.validateEmailRules(e);return t.valid&&E.a.discoverPlatform(e.value).then(e=>{this.setState({isExtern:E.a.isUserExternFromServer(e),hsUrl:e})}),this.markFieldValid(Fa.Email,t.valid),t}),I()(this,"validateEmailRules",Object(Ca.a)({description:()=>Object(l.a)("Use an email address to recover your account"),hideDescriptionIfValid:!0,rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Enter email address")},{key:"email",test:({value:e})=>!e||wa.a(e),invalid:()=>Object(l.a)("Doesn't look like a valid email address")}]})),I()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),I()(this,"onPasswordValidate",e=>{this.markFieldValid(Fa.Password,e.valid)}),I()(this,"onPasswordConfirmChange",e=>{this.setState({passwordConfirm:e.target.value})}),I()(this,"onPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid(Fa.PasswordConfirm,t.valid),t}),I()(this,"validatePasswordConfirmRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Confirm password")},{key:"match",test({value:e}){return!e||e===this.state.password},invalid:()=>Object(l.a)("Passwords don't match")}]})),this.state={fieldValid:{},phoneCountry:this.props.defaultPhoneCountry,username:this.props.defaultUsername||"",email:this.props.defaultEmail||"",password:this.props.defaultPassword||"",passwordConfirm:this.props.defaultPassword||"",passwordComplexity:null,isExtern:!1,hsUrl:null},y.a.instance.track("onboarding_registration_begin")}doSubmit(e){const t=this.state.email.trim();y.a.instance.track("onboarding_registration_submit_ok",{email:!!t});const s=this.props.onRegisterClick({username:null,password:this.state.password.trim(),email:t});s&&(e.target.disabled=!0,s.finally((function(){e.target.disabled=!1})))}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=[Fa.Password,Fa.PasswordConfirm,Fa.Email];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}renderEmail(){return i.a.createElement(ke.a,{ref:e=>this[Fa.Email]=e,type:"text",label:Object(l.a)("Email"),value:this.state.email,onChange:this.onEmailChange,onValidate:this.onEmailValidate,onFocus:()=>y.a.instance.track("onboarding_registration_email_focus"),onBlur:()=>y.a.instance.track("onboarding_registration_email_blur")})}renderPassword(){return i.a.createElement(Ba.a,{id:"mx_RegistrationForm_password",fieldRef:e=>this[Fa.Password]=e,minScore:0,value:this.state.password,onChange:this.onPasswordChange,onValidate:this.onPasswordValidate,onFocus:()=>y.a.instance.track("onboarding_registration_password_focus"),onBlur:()=>y.a.instance.track("onboarding_registration_password_blur")})}renderPasswordConfirm(){return i.a.createElement(ke.a,{id:"mx_RegistrationForm_passwordConfirm",ref:e=>this[Fa.PasswordConfirm]=e,type:"password",autoComplete:"new-password",label:Object(l.a)("Confirm password"),value:this.state.passwordConfirm,onChange:this.onPasswordConfirmChange,onValidate:this.onPasswordConfirmValidate,onFocus:()=>y.a.instance.track("onboarding_registration_passwordConfirm_focus"),onBlur:()=>y.a.instance.track("onboarding_registration_passwordConfirm_blur")})}renderExternalWarning(){if(this.state.isExtern)return i.a.createElement("div",{className:"tc_RegistrationForm_extern_warning"},Object(l.a)('<b>Information</b>: The domain of your email address is not declared in Tchap. If you have received an invitation, you will be able to create a "guest" account, allowing only to participate in private exchanges to which you are invited.',{},{b:e=>i.a.createElement("b",null," ",e," ")}))}render(){const e=i.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(l.a)("Register"),disabled:!this.props.canSubmit});return i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this.onSubmit},i.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderEmail()),this.renderExternalWarning(),i.a.createElement("div",{className:"mx_AuthBody_fieldRow"},this.renderPassword(),this.renderPasswordConfirm()),e))}}I()(Va,"defaultProps",{onValidationChange:console.error,canSubmit:!0});var Wa=s(257);var Ha=e=>i.a.createElement("div",{className:"mx_PulsedAvatar"},e.children),Ga=s(464),qa=s(688),Ka=s(689),za=s(353),$a=s(615),Ya=s(336),Ja=s(683);const Qa=Object(Ca.a)({rules:[{key:"email",test:({value:e})=>!e||wa.a(e),invalid:()=>Object(l.a)("Doesn't look like a valid email address")}]});var Xa=({onFinished:e})=>{const[t,s]=Object(a.useState)(""),n=Object(a.useRef)(),i=async s=>{if(s.preventDefault(),t){if(!await n.current.validate({allowEmpty:!1}))return n.current.focus(),void n.current.validate({allowEmpty:!1,focused:!0})}e(!0,t)};return a.createElement(cs.a,{title:Object(l.a)("Continuing without email"),className:"mx_RegistrationEmailPromptDialog",contentId:"mx_RegistrationEmailPromptDialog",onFinished:()=>e(!1),fixedWidth:!1},a.createElement("div",{className:"mx_Dialog_content",id:"mx_RegistrationEmailPromptDialog"},a.createElement("p",null,Object(l.a)("Just a heads up, if you don't add an email and forget your password, you could <b>permanently lose access to your account</b>.",{},{b:e=>a.createElement("b",null,e)})),a.createElement("form",{onSubmit:i},a.createElement(ke.a,{ref:n,autoFocus:!0,type:"text",label:Object(l.a)("Email (optional)"),value:t,onChange:e=>{s(e.target.value)},onValidate:async e=>await Qa(e),onFocus:()=>y.a.instance.track("onboarding_registration_email2_focus"),onBlur:()=>y.a.instance.track("onboarding_registration_email2_blur")}))),a.createElement(da.a,{primaryButton:Object(l.a)("Continue"),onPrimaryButtonClick:i,hasCancel:!1}))},Za=s(652),ei=s(315);class ti extends i.a.PureComponent{constructor(e){super(e),I()(this,"defaultServer",void 0),I()(this,"fieldRef",Object(a.createRef)()),I()(this,"validatedConf",void 0),I()(this,"onDefaultChosen",()=>{this.setState({defaultChosen:!0})}),I()(this,"onOtherChosen",()=>{this.setState({defaultChosen:!1})}),I()(this,"onHomeserverChange",e=>{this.setState({otherHomeserver:e.target.value})}),I()(this,"validate",Object(Ca.a)({deriveData:async({value:e})=>{let t=e.trim();if(!t.includes("://"))try{const e=await ei.a.findClientConfig(t);return this.validatedConf=Gn.buildValidatedConfigFromDiscovery(t,e),{}}catch(e){console.error(`Attempted ${t} as a server_name but it failed`,e)}t.includes("://")||(t="https://"+t);try{return this.validatedConf=await Gn.validateServerConfigWithStaticUrls(t),{}}catch(e){console.error(e);if(Gn.authComponentStateForError(e).isFatalError){let t=Object(l.a)("Unable to validate homeserver");return e.translatedMessage&&(t=e.translatedMessage),{error:t}}try{return this.validatedConf=await Gn.validateServerConfigWithStaticUrls(t,null,!0),{}}catch(e){return console.error(e),{error:Object(l.a)("Invalid URL")}}}},rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Specify a homeserver")},{key:"valid",test:async function({value:e},{error:t}){return!e||!t},invalid:function({error:e}){return e}}]})),I()(this,"onHomeserverValidate",e=>this.validate(e)),I()(this,"onSubmit",async e=>{e.preventDefault();if(!await this.fieldRef.current.validate({allowEmpty:!1})&&!this.state.defaultChosen)return this.fieldRef.current.focus(),void this.fieldRef.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(this.state.defaultChosen?this.defaultServer:this.validatedConf)});const t=c.a.get();this.defaultServer=t.validated_server_config;const{serverConfig:s}=this.props;let n="";s.isDefault||(n=s.isNameResolvable&&s.hsName?s.hsName:s.hsUrl),this.state={defaultChosen:s.isDefault,otherHomeserver:n}}render(){let e;"matrix.org"===this.defaultServer.hsName&&(e=Object(l.a)("Matrix.org is the biggest public homeserver in the world, so it’s a good place for many."));let t=this.defaultServer.hsName;return this.defaultServer.hsNameIsDifferent&&(t=i.a.createElement(et.a,{class:"mx_Login_underlinedServerName",tooltip:this.defaultServer.hsUrl},this.defaultServer.hsName)),i.a.createElement(cs.a,{title:this.props.title||Object(l.a)("Sign into your homeserver"),className:"mx_ServerPickerDialog",contentId:"mx_ServerPickerDialog",onFinished:this.props.onFinished,fixedWidth:!1,hasCancel:!0},i.a.createElement("form",{className:"mx_Dialog_content",id:"mx_ServerPickerDialog",onSubmit:this.onSubmit},i.a.createElement("p",null,Object(l.a)("We call the places where you can host your account ‘homeservers’.")," ",e),i.a.createElement(dt.a,{name:"defaultChosen",value:"true",checked:this.state.defaultChosen,onChange:this.onDefaultChosen},t),i.a.createElement(dt.a,{name:"defaultChosen",value:"false",className:"mx_ServerPickerDialog_otherHomeserverRadio",checked:!this.state.defaultChosen,onChange:this.onOtherChosen},i.a.createElement(ke.a,{type:"text",className:"mx_ServerPickerDialog_otherHomeserver",label:Object(l.a)("Other homeserver"),onChange:this.onHomeserverChange,onClick:this.onOtherChosen,ref:this.fieldRef,onValidate:this.onHomeserverValidate,value:this.state.otherHomeserver,validateOnChange:!1,validateOnFocus:!1})),i.a.createElement("p",null,Object(l.a)("Use your preferred Matrix homeserver if you have one, or host your own.")),i.a.createElement(pe.a,{className:"mx_ServerPickerDialog_continue",kind:"primary",onClick:this.onSubmit},Object(l.a)("Continue")),i.a.createElement("h4",null,Object(l.a)("Learn more")),i.a.createElement("a",{href:"https://matrix.org/faq/#what-is-a-homeserver%3F",target:"_blank",rel:"noreferrer noopener"},Object(l.a)("About homeservers"))))}}var si=s(356),ni=s(764),ai=s(482),ii=s(655);class oi extends i.a.Component{constructor(e){super(e),I()(this,"onMouseDown",e=>{this.setState({location:{currentX:e.clientX,currentY:e.clientY}}),document.addEventListener("mousemove",this.state.onMouseMove),document.addEventListener("mouseup",this.state.onMouseUp)}),I()(this,"onMouseUp",e=>{document.removeEventListener("mousemove",this.state.onMouseMove),document.removeEventListener("mouseup",this.state.onMouseUp),this.props.onMouseUp(e)}),this.state={onMouseMove:this.onMouseMove.bind(this),onMouseUp:this.onMouseUp.bind(this),location:{currentX:0,currentY:0}}}onMouseMove(e){const t=this.props.dragFunc(this.state.location,e);this.setState({location:t})}render(){return i.a.createElement("div",{className:this.props.className,onMouseDown:this.onMouseDown.bind(this)})}}var ri=s(750);var li,ci=({events:e,children:t,threshold:s=3,onToggle:n,startExpanded:o,summaryMembers:r=[],summaryText:c})=>{const[d,m]=(e=>{const[t,s]=Object(a.useState)(e);return[t,()=>{s(!t)},s]})(o);Object(a.useEffect)(()=>{n&&n()},[d]);const h=e.map(e=>e.getId()).join(",");if(e.length<s)return i.a.createElement("div",{className:"mx_EventListSummary","data-scroll-tokens":h},t);let u;if(d)u=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_EventListSummary_line"}," "),t);else{const e=r.map(e=>i.a.createElement(Wa.a,{key:e.userId,member:e,width:14,height:14}));u=i.a.createElement("div",{className:"mx_EventTile_line"},i.a.createElement("div",{className:"mx_EventTile_info"},i.a.createElement("span",{className:"mx_EventListSummary_avatars",onClick:m},e),i.a.createElement("span",{className:"mx_TextualEvent mx_EventListSummary_summary"},c)))}return i.a.createElement("li",{className:"mx_EventListSummary","data-scroll-tokens":h},i.a.createElement(pe.a,{className:"mx_EventListSummary_toggle",onClick:m,"aria-expanded":d},d?Object(l.a)("collapse"):Object(l.a)("expand")),u)};class di extends i.a.Component{constructor(e){super(e),I()(this,"dragFunc",(e,t)=>{const s=t.clientX-e.currentX,n=this.state.width+s;return n<this.props.minWidth||n>this.props.maxWidth?e:(this.setState({width:n}),this.updateCSSWidth.bind(this)(n),{currentX:t.clientX,currentY:e.currentY})}),this.state={width:F.a.getValue("ircDisplayNameWidth",this.props.roomId),IRCLayoutRoot:null}}componentDidMount(){this.setState({IRCLayoutRoot:document.querySelector(".mx_IRCLayout")},()=>this.updateCSSWidth(this.state.width))}updateCSSWidth(e){this.state.IRCLayoutRoot.style.setProperty("--name-width",e+"px")}onMoueUp(e){this.props.roomId&&F.a.setValue("ircDisplayNameWidth",this.props.roomId,Qe.a.ROOM_DEVICE,this.state.width)}render(){return i.a.createElement(oi,{className:"mx_ProfileResizer",dragFunc:this.dragFunc.bind(this),onMouseUp:this.onMoueUp.bind(this)})}}!function(e){e.Joined="joined",e.Left="left",e.JoinedAndLeft="joined_and_left",e.LeftAndJoined="left_and_joined",e.InviteReject="invite_reject",e.InviteWithdrawal="invite_withdrawal",e.Invited="invited",e.Banned="banned",e.Unbanned="unbanned",e.Kicked="kicked",e.ChangedName="changed_name",e.ChangedAvatar="changed_avatar",e.NoChange="no_change"}(li||(li={}));class mi extends i.a.Component{shouldComponentUpdate(e){return e.events.length!==this.props.events.length||e.events.length<this.props.threshold}generateSummary(e,t){const s=t.map(t=>{const s=e[t],n=this.renderNameList(s),a=t.split(","),i=mi.getCanonicalTransitions(a),o=mi.coalesceRepeatedTransitions(i).map(e=>mi.getDescriptionForTransition(e.transitionType,s.length,e.repeats)),r=Object(q.b)(o);return Object(l.a)("%(nameList)s %(transitionList)s",{nameList:n,transitionList:r})});return s?s.join(", "):null}renderNameList(e){return Object(q.b)(e,this.props.summaryLength)}static getCanonicalTransitions(e){const t={[li.Joined]:{after:li.Left,newTransition:li.JoinedAndLeft},[li.Left]:{after:li.Joined,newTransition:li.LeftAndJoined}},s=[];for(let n=0;n<e.length;n++){const a=e[n],i=e[n+1];let o=a;n<e.length-1&&t[a]&&t[a].after===i&&(o=t[a].newTransition,n++),s.push(o)}return s}static coalesceRepeatedTransitions(e){const t=[];for(let s=0;s<e.length;s++)t.length>0&&t[t.length-1].transitionType===e[s]?t[t.length-1].repeats+=1:t.push({transitionType:e[s],repeats:1});return t}static getDescriptionForTransition(e,t,s){let n=null;switch(e){case"joined":n=t>1?Object(l.a)("%(severalUsers)sjoined %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)sjoined %(count)s times",{oneUser:"",count:s});break;case"left":n=t>1?Object(l.a)("%(severalUsers)sleft %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)sleft %(count)s times",{oneUser:"",count:s});break;case"joined_and_left":n=t>1?Object(l.a)("%(severalUsers)sjoined and left %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)sjoined and left %(count)s times",{oneUser:"",count:s});break;case"left_and_joined":n=t>1?Object(l.a)("%(severalUsers)sleft and rejoined %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)sleft and rejoined %(count)s times",{oneUser:"",count:s});break;case"invite_reject":n=t>1?Object(l.a)("%(severalUsers)srejected their invitations %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)srejected their invitation %(count)s times",{oneUser:"",count:s});break;case"invite_withdrawal":n=t>1?Object(l.a)("%(severalUsers)shad their invitations withdrawn %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)shad their invitation withdrawn %(count)s times",{oneUser:"",count:s});break;case"invited":n=t>1?Object(l.a)("were invited %(count)s times",{count:s}):Object(l.a)("was invited %(count)s times",{count:s});break;case"banned":n=t>1?Object(l.a)("were banned %(count)s times",{count:s}):Object(l.a)("was banned %(count)s times",{count:s});break;case"unbanned":n=t>1?Object(l.a)("were unbanned %(count)s times",{count:s}):Object(l.a)("was unbanned %(count)s times",{count:s});break;case"kicked":n=t>1?Object(l.a)("were kicked %(count)s times",{count:s}):Object(l.a)("was kicked %(count)s times",{count:s});break;case"changed_name":n=t>1?Object(l.a)("%(severalUsers)schanged their name %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)schanged their name %(count)s times",{oneUser:"",count:s});break;case"changed_avatar":n=t>1?Object(l.a)("%(severalUsers)schanged their avatar %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)schanged their avatar %(count)s times",{oneUser:"",count:s});break;case"no_change":n=t>1?Object(l.a)("%(severalUsers)smade no changes %(count)s times",{severalUsers:"",count:s}):Object(l.a)("%(oneUser)smade no changes %(count)s times",{oneUser:"",count:s})}return n}static getTransitionSequence(e){return e.map(mi.getTransition)}static getTransition(e){if("m.room.third_party_invite"===e.mxEvent.getType())return Object(rs.c)(e.mxEvent)?li.Invited:li.InviteWithdrawal;switch(e.mxEvent.getContent().membership){case"invite":return li.Invited;case"ban":return li.Banned;case"join":return"join"===e.mxEvent.getPrevContent().membership?e.mxEvent.getContent().displayname!==e.mxEvent.getPrevContent().displayname?li.ChangedName:e.mxEvent.getContent().avatar_url!==e.mxEvent.getPrevContent().avatar_url?li.ChangedAvatar:li.NoChange:li.Joined;case"leave":if(e.mxEvent.getSender()===e.mxEvent.getStateKey())switch(e.mxEvent.getPrevContent().membership){case"invite":return li.InviteReject;default:return li.Left}switch(e.mxEvent.getPrevContent().membership){case"invite":return li.InviteWithdrawal;case"ban":return li.Unbanned;default:return li.Kicked}default:return null}}getAggregate(e){const t={},s={};return Object.keys(e).forEach(n=>{const a=e[n][0],i=a.displayName,o=mi.getTransitionSequence(e[n]).join(",");t[o]||(t[o]=[],s[o]=-1),t[o].push(i),(-1===s[o]||a.index<s[o])&&(s[o]=a.index)}),{names:t,indices:s}}render(){const e=this.props.events,t=new Map,s={};e.forEach((e,n)=>{const a=e.getStateKey();s[a]||(s[a]=[]),e.target&&t.set(a,e.target);let i=a;"m.room.third_party_invite"===e.getType()?i=e.getContent().display_name:e.target&&(i=e.target.name),s[a].push({mxEvent:e,displayName:i,index:n})});const n=this.getAggregate(s),a=Object.keys(n.names).sort((e,t)=>n.indices[e]-n.indices[t]);return i.a.createElement(ci,{events:this.props.events,threshold:this.props.threshold,onToggle:this.props.onToggle,startExpanded:this.props.startExpanded,children:this.props.children,summaryMembers:[...t.values()],summaryText:this.generateSummary(n.names,a)})}}I()(mi,"defaultProps",{summaryLength:1,threshold:3,avatarsMaxLength:5});var hi=({value:e,max:t})=>i.a.createElement("progress",{className:"mx_ProgressBar",max:t,value:e}),ui=s(472);const pi=()=>{De.a.createTrackedDialog("Custom Server Dialog","",as.a,{title:Object(l.a)("Server Options"),description:Object(l.a)("You can use the custom server options to sign into other Matrix servers by specifying a different homeserver URL. This allows you to use Element with an existing Matrix account on a different homeserver."),button:Object(l.a)("Dismiss"),hasCloseButton:!1,fixedWidth:!1},"mx_ServerPicker_helpDialog")};var gi=({title:e,dialogTitle:t,serverConfig:s,onServerConfigChange:n})=>{let a;if(!c.a.get().disable_custom_urls&&n){const e=()=>{((e,t,s)=>{De.a.createTrackedDialog("Server Picker","",ti,{title:e,serverConfig:t,onFinished:s})})(t,s,e=>{e&&n(e)})};a=i.a.createElement(pe.a,{className:"mx_ServerPicker_change",kind:"link",onClick:e},Object(l.a)("Edit"))}let o,r=s.isNameResolvable?s.hsName:s.hsUrl;return s.hsNameIsDifferent&&(r=i.a.createElement(et.a,{class:"mx_Login_underlinedServerName",tooltip:s.hsUrl},s.hsName)),"matrix.org"===s.hsName&&(o=i.a.createElement("span",{className:"mx_ServerPicker_desc"},Object(l.a)("Join millions for free on the largest public server"))),i.a.createElement("div",{className:"mx_ServerPicker"},i.a.createElement("h3",null,e||Object(l.a)("Homeserver")),i.a.createElement(pe.a,{className:"mx_ServerPicker_help",onClick:pi}),i.a.createElement("span",{className:"mx_ServerPicker_server"},r),a,o)};function fi(){return F.a.getValue("recent_emoji")||[]}function bi(e=24){let t=fi();t.length<1&&(!function(){const e=JSON.parse(window.localStorage.mx_reaction_count||"{}"),t=Object.entries(e).sort(([,[e,t]],[,[s,n]])=>n-t).map(([e,[t,s]])=>[e,t]);F.a.setValue("recent_emoji",null,Qe.a.ACCOUNT,t.slice(0,100))}(),t=fi());return Object(Pa.orderBy)(t,"1","desc").slice(0,e).map(([e])=>e)}var vi=s(277);class _i extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"onKeyDown",e=>{let t=!0;switch(e.key){case _s.a.ARROW_LEFT:this.changeCategoryRelative(-1);break;case _s.a.ARROW_RIGHT:this.changeCategoryRelative(1);break;case _s.a.HOME:this.changeCategoryAbsolute(0);break;case _s.a.END:this.changeCategoryAbsolute(this.props.categories.length-1,-1);break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())})}findNearestEnabled(e,t){e+=this.props.categories.length;const s=[...this.props.categories,...this.props.categories,...this.props.categories];for(;e<s.length&&e>=0;){if(s[e].enabled)return e%this.props.categories.length;e+=t>0?1:-1}}changeCategoryRelative(e){const t=this.props.categories.findIndex(e=>e.visible);this.changeCategoryAbsolute(t+e,e)}changeCategoryAbsolute(e,t=1){const s=this.props.categories[this.findNearestEnabled(e,t)];s&&(this.props.onAnchorClick(s.id),s.ref.current.focus())}render(){return i.a.createElement("nav",{className:"mx_EmojiPicker_header",role:"tablist","aria-label":Object(l.a)("Categories"),onKeyDown:this.onKeyDown},this.props.categories.map(e=>{const t=L()("mx_EmojiPicker_anchor mx_EmojiPicker_anchor_"+e.id,{mx_EmojiPicker_anchor_visible:e.visible});return i.a.createElement("button",{disabled:!e.enabled,key:e.id,ref:e.ref,className:t,onClick:()=>this.props.onAnchorClick(e.id),title:e.name,role:"tab",tabIndex:e.visible?0:-1,"aria-selected":e.visible,"aria-controls":"mx_EmojiPicker_category_"+e.id})}))}}var yi=_i;class Ei extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"inputRef",i.a.createRef()),I()(this,"onKeyDown",e=>{e.key===_s.a.ENTER&&(this.props.onEnter(),e.stopPropagation(),e.preventDefault())})}componentDidMount(){setTimeout(()=>this.inputRef.current.focus(),0)}render(){let e;return e=this.props.query?i.a.createElement("button",{onClick:()=>this.props.onChange(""),className:"mx_EmojiPicker_search_icon mx_EmojiPicker_search_clear",title:Object(l.a)("Cancel search")}):i.a.createElement("span",{className:"mx_EmojiPicker_search_icon"}),i.a.createElement("div",{className:"mx_EmojiPicker_search"},i.a.createElement("input",{autoFocus:!0,type:"text",placeholder:"Search",value:this.props.query,onChange:e=>this.props.onChange(e.target.value),onKeyDown:this.onKeyDown,ref:this.inputRef}),e)}}var Ci=Ei;class wi extends i.a.PureComponent{render(){const{unicode:e="",annotation:t="",shortcodes:[s=""]}=this.props.emoji||{};return i.a.createElement("div",{className:"mx_EmojiPicker_footer mx_EmojiPicker_preview"},i.a.createElement("div",{className:"mx_EmojiPicker_preview_emoji"},e),i.a.createElement("div",{className:"mx_EmojiPicker_preview_text"},i.a.createElement("div",{className:"mx_EmojiPicker_name mx_EmojiPicker_preview_name"},t),i.a.createElement("div",{className:"mx_EmojiPicker_shortcode"},s)))}}var Si=wi;class xi extends i.a.PureComponent{render(){const{onClick:e,onMouseEnter:t,onMouseLeave:s,emoji:a,selectedEmojis:o}=this.props,r=o&&o.has(a.unicode);return i.a.createElement(n.f,{element:"li",onClick:()=>e(a),onMouseEnter:()=>t(a),onMouseLeave:()=>s(a),className:"mx_EmojiPicker_item_wrapper",label:a.unicode},i.a.createElement("div",{className:"mx_EmojiPicker_item "+(r?"mx_EmojiPicker_item_selected":"")},a.unicode))}}var Ri=xi;const Oi=["👍","👎","😄","🎉","😕","❤️","🚀","👀"].map(e=>{const t=Object(vi.e)(e);if(!t)throw new Error(`Emoji ${e} doesn't exist in emojibase`);return t});class ki extends i.a.Component{constructor(e){super(e),I()(this,"onMouseEnter",e=>{this.setState({hover:e})}),I()(this,"onMouseLeave",()=>{this.setState({hover:null})}),this.state={hover:null}}render(){return i.a.createElement("section",{className:"mx_EmojiPicker_footer mx_EmojiPicker_quick mx_EmojiPicker_category"},i.a.createElement("h2",{className:"mx_EmojiPicker_quick_header mx_EmojiPicker_category_label"},this.state.hover?i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mx_EmojiPicker_name"},this.state.hover.annotation),i.a.createElement("span",{className:"mx_EmojiPicker_shortcode"},this.state.hover.shortcodes[0])):Object(l.a)("Quick Reactions")),i.a.createElement("ul",{className:"mx_EmojiPicker_list","aria-label":Object(l.a)("Quick Reactions")},Oi.map(e=>i.a.createElement(Ri,{key:e.hexcode,emoji:e,onClick:this.props.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,selectedEmojis:this.props.selectedEmojis}))))}}var Ii=ki;function Ti(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}class ji extends i.a.Component{constructor(e){super(e),I()(this,"recentlyUsed",void 0),I()(this,"memoizedDataByCategory",void 0),I()(this,"categories",void 0),I()(this,"bodyRef",i.a.createRef()),I()(this,"onScroll",()=>{const e=this.bodyRef.current;this.setState({scrollTop:e.scrollTop,viewportHeight:e.clientHeight}),this.updateVisibility()}),I()(this,"updateVisibility",()=>{const e=this.bodyRef.current,t=e.getBoundingClientRect();for(const s of this.categories){const n=e.querySelector(`[data-category-id="${s.id}"]`);if(!n){s.visible=!1,s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible");continue}const a=n.getBoundingClientRect(),i=a.y-t.y,o=a.y+a.height-t.y;s.visible=i<t.height&&o>0,s.visible?(s.ref.current.classList.add("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected","true"),s.ref.current.setAttribute("tabindex","0")):(s.ref.current.classList.remove("mx_EmojiPicker_anchor_visible"),s.ref.current.setAttribute("aria-selected","false"),s.ref.current.setAttribute("tabindex","-1"))}}),I()(this,"scrollToCategory",e=>{this.bodyRef.current.querySelector(`[data-category-id="${e}"]`).scrollIntoView()}),I()(this,"onChangeFilter",e=>{e=e.toLowerCase();for(const t of this.categories){let s;s=e.includes(this.state.filter)?this.memoizedDataByCategory[t.id]:"recent"===t.id?this.recentlyUsed:vi.a[t.id],s=s.filter(t=>t.filterString.includes(e)),this.memoizedDataByCategory[t.id]=s,t.enabled=s.length>0,t.ref.current.disabled=!t.enabled}this.setState({filter:e}),setTimeout(this.updateVisibility,0)}),I()(this,"onEnterFilter",()=>{const e=this.bodyRef.current.querySelector(".mx_EmojiPicker_item");e&&e.click()}),I()(this,"onHoverEmoji",e=>{this.setState({previewEmoji:e})}),I()(this,"onHoverEmojiEnd",e=>{this.setState({previewEmoji:null})}),I()(this,"onClickEmoji",e=>{!1!==this.props.onChoose(e.unicode)&&function(e){const t=fi(),s=t.findIndex(([t])=>t===e);let n;s>=0?([n]=t.splice(s,1),n[1]++):n=[e,1],F.a.setValue("recent_emoji",null,Qe.a.ACCOUNT,[n,...t].slice(0,100))}(e.unicode)}),this.state={filter:"",previewEmoji:null,scrollTop:0,viewportHeight:280},this.recentlyUsed=Array.from(new Set(bi().map(vi.e).filter(Boolean))),this.memoizedDataByCategory=function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Ti(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Ti(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({recent:this.recentlyUsed},vi.a),this.categories=[{id:"recent",name:Object(l.a)("Frequently Used"),enabled:this.recentlyUsed.length>0,visible:this.recentlyUsed.length>0,ref:i.a.createRef()},{id:"people",name:Object(l.a)("Smileys & People"),enabled:!0,visible:!0,ref:i.a.createRef()},{id:"nature",name:Object(l.a)("Animals & Nature"),enabled:!0,visible:!1,ref:i.a.createRef()},{id:"foods",name:Object(l.a)("Food & Drink"),enabled:!0,visible:!1,ref:i.a.createRef()},{id:"activity",name:Object(l.a)("Activities"),enabled:!0,visible:!1,ref:i.a.createRef()},{id:"places",name:Object(l.a)("Travel & Places"),enabled:!0,visible:!1,ref:i.a.createRef()},{id:"objects",name:Object(l.a)("Objects"),enabled:!0,visible:!1,ref:i.a.createRef()},{id:"symbols",name:Object(l.a)("Symbols"),enabled:!0,visible:!1,ref:i.a.createRef()},{id:"flags",name:Object(l.a)("Flags"),enabled:!0,visible:!1,ref:i.a.createRef()}]}static categoryHeightForEmojiCount(e){return 0===e?0:22+37*Math.ceil(e/8)}render(){let e=0;return i.a.createElement("div",{className:"mx_EmojiPicker"},i.a.createElement(yi,{categories:this.categories,onAnchorClick:this.scrollToCategory}),i.a.createElement(Ci,{query:this.state.filter,onChange:this.onChangeFilter,onEnter:this.onEnterFilter}),i.a.createElement(o.a,{className:"mx_EmojiPicker_body",wrappedRef:e=>{this.bodyRef.current=e},onScroll:this.onScroll},this.categories.map(t=>{const s=this.memoizedDataByCategory[t.id],n=i.a.createElement(Ui,{key:t.id,id:t.id,name:t.name,heightBefore:e,viewportHeight:this.state.viewportHeight,scrollTop:this.state.scrollTop,emojis:s,onClick:this.onClickEmoji,onMouseEnter:this.onHoverEmoji,onMouseLeave:this.onHoverEmojiEnd,selectedEmojis:this.props.selectedEmojis}),a=ji.categoryHeightForEmojiCount(s.length);return e+=a,n})),this.state.previewEmoji||!this.props.showQuickReactions?i.a.createElement(Si,{emoji:this.state.previewEmoji}):i.a.createElement(Ii,{onClick:this.onClickEmoji,selectedEmojis:this.props.selectedEmojis}))}}var Ni=ji;class Pi{constructor(e,t,s){this.topCount=e,this.renderCount=t,this.bottomCount=s}contains(e){return!(!e.renderCount&&this.renderCount)&&(e.topCount>=this.topCount&&e.topCount+e.renderCount<=this.topCount+this.renderCount)}expand(e){if(0===this.renderCount)return this;const t=Math.min(e,this.topCount),s=Math.min(e,this.bottomCount);return new Pi(this.topCount-t,this.renderCount+t+s,this.bottomCount-s)}totalSize(){return this.topCount+this.renderCount+this.bottomCount}}class Di extends i.a.Component{constructor(e){super(e),this.state={}}static getDerivedStateFromProps(e,t){const s=Di.getVisibleRangeFromProps(e),n=s.expand(e.overflowMargin),a=s.expand(e.overflowItems);return!(!!t.renderRange&&a.totalSize()!==t.renderRange.totalSize())&&t.renderRange&&t.renderRange.contains(n)?null:{renderRange:a}}static getVisibleRangeFromProps(e){const{items:t,itemHeight:s,scrollTop:n,height:a}=e,i=t?t.length:0,o=Math.min(Math.max(0,Math.floor(n/s)),i),r=i-o,l=0!==a?Math.ceil(a/s):0,c=Math.min(l,r);return new Pi(o,c,r-c)}render(){const{itemHeight:e,items:t,renderItem:s}=this.props,{renderRange:n}=this.state,{topCount:a,renderCount:o,bottomCount:r}=n,l=a*e,c=r*e,d=(t||[]).slice(a,a+o),m=this.props.element||"div",h={style:{paddingTop:l+"px",paddingBottom:c+"px"},className:this.props.className};return i.a.createElement(m,h,d.map(s))}}Di.defaultProps={overflowItems:20,overflowMargin:5},Di.propTypes={itemHeight:xe.a.number.isRequired,renderItem:xe.a.func.isRequired,scrollTop:xe.a.number.isRequired,height:xe.a.number.isRequired,items:xe.a.array,overflowMargin:xe.a.number,overflowItems:xe.a.number};class Ai extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"renderEmojiRow",e=>{const{onClick:t,onMouseEnter:s,onMouseLeave:n,selectedEmojis:a,emojis:o}=this.props,r=o.slice(8*e,8*(e+1));return i.a.createElement("div",{key:e},r.map(e=>i.a.createElement(Ri,{key:e.hexcode,emoji:e,selectedEmojis:a,onClick:t,onMouseEnter:s,onMouseLeave:n})))})}render(){const{emojis:e,name:t,heightBefore:s,viewportHeight:n,scrollTop:a}=this.props;if(!e||0===e.length)return null;const o=new Array(Math.ceil(e.length/8));for(let e=0;e<o.length;++e)o[e]=e;const r=a,l=r+n,c=s+22,d=c+37*o.length,m=Math.max(r,c),h=Math.min(l,d),u=Math.max(0,h-m),p=Math.max(0,a-c);return i.a.createElement("section",{id:"mx_EmojiPicker_category_"+this.props.id,className:"mx_EmojiPicker_category","data-category-id":this.props.id,role:"tabpanel","aria-label":t},i.a.createElement("h2",{className:"mx_EmojiPicker_category_label"},t),i.a.createElement(Di,{element:"ul",className:"mx_EmojiPicker_list",itemHeight:37,items:o,scrollTop:p,height:u,overflowItems:3,overflowMargin:0,renderItem:this.renderEmojiRow}))}}var Ui=Ai;class Mi extends i.a.Component{constructor(e){super(e),I()(this,"onReactionsChange",()=>{this.setState({selectedEmojis:new Set(Object.keys(this.getReactions()))})}),I()(this,"onChoose",e=>{this.componentWillUnmount(),this.props.onFinished();const t=this.getReactions();return t.hasOwnProperty(e)?(ee.a.get().redactEvent(this.props.mxEvent.getRoomId(),t[e]),!1):(ee.a.get().sendEvent(this.props.mxEvent.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:this.props.mxEvent.getId(),key:e}}),m.a.dispatch({action:"message_sent"}),!0)}),this.state={selectedEmojis:new Set(Object.keys(this.getReactions()))},this.addListeners()}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.addListeners(),this.onReactionsChange())}addListeners(){this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange))}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener("Relations.add",this.onReactionsChange),this.props.reactions.removeListener("Relations.remove",this.onReactionsChange),this.props.reactions.removeListener("Relations.redaction",this.onReactionsChange))}getReactions(){if(!this.props.reactions)return{};const e=ee.a.get().getUserId(),t=this.props.reactions.getAnnotationsBySender()[e]||[];return Object.fromEntries([...t].filter(e=>!e.isRedacted()).map(e=>[e.getRelation().key,e.getId()]))}render(){return i.a.createElement(Ni,{onChoose:this.onChoose,selectedEmojis:this.state.selectedEmojis,showQuickReactions:!0})}}var Li=Mi;var Fi=Object(a.forwardRef)(({className:e,title:t,subtitle:s,children:n},a)=>i.a.createElement("div",{className:L()("mx_EventTileBubble",e),ref:a},i.a.createElement("div",{className:"mx_EventTileBubble_title"},t),s&&i.a.createElement("div",{className:"mx_EventTileBubble_subtitle"},s),n));var Bi=Object(a.forwardRef)(({mxEvent:e},t)=>{if("unrestricted"===e.getContent().rule)return i.a.createElement(Fi,{className:"tc_accessRulesEvent tc_accessRulesEvent_icon",title:Object(l.a)("Room open to external users"),subtitle:Object(l.a)("Externals are allowed to join this room"),ref:t})});var Vi=Object(a.forwardRef)(({mxEvent:e},t)=>{const s=Object(a.useContext)(b.a),n=e.getRoomId(),o=ee.a.get().isRoomEncrypted(n);if("m.megolm.v1.aes-sha2"===e.getContent().algorithm&&o){let e;const t=qn.a.shared().getUserIdForRoomId(n);if(t){var r,c;const a=(null==s||null===(r=s.getRoom(n))||void 0===r||null===(c=r.getMember(t))||void 0===c?void 0:c.rawDisplayName)||t;e=Object(l.a)("Messages here are end-to-end encrypted. Verify %(displayName)s in their profile - tap on their avatar.",{displayName:a})}else e=Object(l.a)("Messages in this room are end-to-end encrypted. When people join, you can verify them in their profile, just tap on their avatar.");return i.a.createElement(Fi,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(l.a)("Encryption enabled"),subtitle:e})}return o?i.a.createElement(Fi,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:Object(l.a)("Encryption enabled"),subtitle:Object(l.a)("Ignored attempt to disable encryption")}):i.a.createElement(Fi,{className:"mx_cryptoEvent mx_cryptoEvent_icon mx_cryptoEvent_icon_warning",title:Object(l.a)("Encryption not enabled"),subtitle:Object(l.a)("The encryption used by this room isn't supported."),ref:t})}),Wi=s(197),Hi=s(173);class Gi extends i.a.PureComponent{constructor(e){super(e)}render(){var e;const t=this.props.mxEvent.getContent().url,s=this.props.mxEvent.getPrevContent().url,n=(null===(e=this.props.mxEvent.sender)||void 0===e?void 0:e.name)||this.props.mxEvent.getSender(),a=ee.a.get().getRoom(this.props.mxEvent.getRoomId()),o=this.props.mxEvent.getStateKey(),r=Wi.a.instance.getRoom(a.roomId,!0).widgets.find(e=>e.id===o);let c=Object(l.a)("Join the conference at the top of this room");return r&&Hi.d.instance.isInContainer(a,r,Hi.a.Right)?c=Object(l.a)("Join the conference from the room information card on the right"):r||(c=null),t?s?i.a.createElement(Fi,{className:"mx_MJitsiWidgetEvent",title:Object(l.a)("Video conference updated by %(senderName)s",{senderName:n}),subtitle:c}):i.a.createElement(Fi,{className:"mx_MJitsiWidgetEvent",title:Object(l.a)("Video conference started by %(senderName)s",{senderName:n}),subtitle:c}):i.a.createElement(Fi,{className:"mx_MJitsiWidgetEvent",title:Object(l.a)("Video conference ended by %(senderName)s",{senderName:n})})}}var qi=s(286),Ki=s.n(qi),zi=s(261),$i=s.n(zi);let Yi,Ji=0;const Qi={};function Xi(e){if(!e)return"";const t=window.getComputedStyle(e,null);let s=t.cssText;if(""==s)for(let e=0;e<t.length;e++)s+=t[e]+":",s+=t.getPropertyValue(t[e])+";";return s}Pn.a.registerTintable((function(){$i()({uri:s(1269)},(e,t,s)=>{if(e)return;const n=(new DOMParser).parseFromString(s,"image/svg+xml"),a=Pn.a.calcSvgFixups([{contentDocument:n}]);Pn.a.applySvgFixups(a);const i=(new XMLSerializer).serializeToString(n);Yi="data:image/svg+xml;base64,"+window.btoa(i),Object.keys(Qi).forEach((function(e){Qi[e].tint()}))})}));class Zi extends i.a.Component{constructor(e){super(e),I()(this,"tint",()=>{this._downloadImage.current&&(this._downloadImage.current.src=Yi),this._iframe.current&&this._iframe.current.contentWindow.postMessage({imgSrc:Yi,style:Xi(this._dummyLink.current)},"*")}),this.state={decryptedBlob:this.props.decryptedBlob?this.props.decryptedBlob:null,contentUrl:null,isClean:null,isEncrypted:!1,decrypting:!1},this._iframe=Object(a.createRef)(),this._dummyLink=Object(a.createRef)(),this._downloadImage=Object(a.createRef)()}presentableTextForFile(e){let t=Object(l.a)("Attachment");return e.body&&e.body.length>0&&(t=e.body),e.info&&e.info.size&&(t+=" ("+Ki()(e.info.size)+")"),t}_getContentUrl(){return this.state.contentUrl}componentDidMount(){this.id=Ji++,Qi[this.id]=this,this.tint();const e=this.props.mxEvent.getContent();void 0!==e.url&&null===this.state.contentUrl?Ns.a.scanContent(e).then(t=>{!0===t.clean?this.setState({contentUrl:Ns.a.getUnencryptedContentUrl(e),isClean:!0,isEncrypted:!1}):this.setState({isClean:!1,isEncrypted:!1})}):void 0!==e.file&&Ns.a.scanContent(e).then(e=>{!0===e.clean?this.setState({isClean:!0,isEncrypted:!0}):this.setState({isClean:!1,isEncrypted:!0})})}componentDidUpdate(e,t){this.props.onHeightChanged&&!t.decryptedBlob&&this.state.decryptedBlob&&this.props.onHeightChanged()}componentWillUnmount(){delete Qi[this.id]}render(){const e=this.props.mxEvent.getContent(),t=this.presentableTextForFile(e),n=this.state.isEncrypted,a=this.state.isClean,o=e.body&&e.body.length>0?e.body:Object(l.a)("Attachment"),r=this._getContentUrl(),c=d.getComponent("dialogs.ErrorDialog"),m=e.info?e.info.size:null,h=e.info?e.info.mimetype:"application/octet-stream",u=this.state.decrypting;if(n){if(null===this.state.decryptedBlob){const n=t=>{if(u)return!1;this.setState({decrypting:!0}),Promise.resolve(Ns.a.downloadEncryptedContent(e)).then(e=>{e.size>0?this.setState({decryptedBlob:e,isClean:!0}):this.setState({decryptedBlob:null,isClean:!1})}).catch(e=>{console.warn("Unable to decrypt attachment: ",e),De.a.createTrackedDialog("Error decrypting attachment","",c,{title:Object(l.a)("Error"),description:Object(l.a)("Error decrypting attachment")})}).finally(()=>{this.setState({decrypting:!1})})};return null===a?i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(247),alt:Object(l.a)("Analysis in progress"),width:"16",height:"16"}),Object(l.a)("Analysis in progress")):u?i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(247),alt:Object(l.a)("Decrypting..."),width:"16",height:"16"}),Object(l.a)("Decrypting...")):!0===a?i.a.createElement("span",{className:"mx_MFileBody"},i.a.createElement("div",{className:"mx_MFileBody_download"},i.a.createElement(pe.a,{onClick:n},Object(l.a)("Decrypt %(text)s",{text:t})))):i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16",alt:"warning"}),Object(l.a)("The file %(file)s was rejected by the security policy",{file:e.body}))}const n=e=>{e.target.contentWindow.postMessage({imgSrc:Yi,style:Xi(this._dummyLink.current),blob:this.state.decryptedBlob,download:o,textContent:Object(l.a)("Download %(text)s",{text:t}),auto:!this.props.decryptedBlob},"*")},r="usercontent/";return i.a.createElement("span",{className:"mx_MFileBody"},i.a.createElement("div",{className:"mx_MFileBody_download"},i.a.createElement("div",{style:{display:"none"}},i.a.createElement("a",{ref:this._dummyLink})),i.a.createElement("iframe",{src:`${r}?origin=${encodeURIComponent(window.location.origin)}`,onLoad:n,ref:this._iframe,sandbox:"allow-scripts allow-downloads allow-downloads-without-user-activation"})))}if(null!==r){if(a){const s={target:"_blank",rel:"noreferrer noopener nofollow",href:r},n="number"!=typeof m||m>524288e3;return["application/pdf"].includes(h)&&!n?s.onClick=e=>{console.log(`Downloading ${h} as blob (unencrypted)`),e.preventDefault(),e.stopPropagation(),fetch(r).then(e=>e.blob()).then(e=>{const t=URL.createObjectURL(e),s=document.createElement("a");s.download=o,s.href=t,document.body.appendChild(s),s.click(),s.remove()})}:s.download=o,"file_grid"===this.props.tileShape?i.a.createElement("span",{className:"mx_MFileBody"},i.a.createElement("div",{className:"mx_MFileBody_download"},i.a.createElement("a",se()({className:"mx_MFileBody_downloadLink"},s),o),i.a.createElement("div",{className:"mx_MImageBody_size"},e.info&&e.info.size?Ki()(e.info.size):""))):i.a.createElement("span",{className:"mx_MFileBody"},i.a.createElement("div",{className:"mx_MFileBody_download"},i.a.createElement("a",s,i.a.createElement("img",{src:Yi,width:"12",height:"14",ref:this._downloadImage}),Object(l.a)("Download %(text)s",{text:t}))))}return i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16"}),Object(l.a)("The file %(file)s was rejected by the security policy",{file:e.body}))}{const e=t?": "+t:"";return i.a.createElement("span",{className:"mx_MFileBody"},Object(l.a)("Invalid file%(extra)s",{extra:e}))}}}I()(Zi,"propTypes",{mxEvent:xe.a.object.isRequired,decryptedBlob:xe.a.object,onHeightChanged:xe.a.func,tileShape:xe.a.string});var eo=s(503);class to extends i.a.PureComponent{constructor(e){super(e),I()(this,"videoRef",i.a.createRef()),I()(this,"videoOnPlay",async()=>{if(this.hasContentUrl()||this.state.fetchingData||this.state.error)return;this.setState({fetchingData:!0});const e=this.props.mxEvent.getContent();if(!e.file)return void this.setState({error:"No file given in content"});const t=await Object(eo.a)(e.file),s=URL.createObjectURL(t);this.setState({decryptedUrl:s,decryptedBlob:t,fetchingData:!1},()=>{this.videoRef.current&&this.videoRef.current.play()}),this.props.onHeightChanged()}),this.state={fetchingData:!1,decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,contentUrl:null,isClean:null,error:null}}thumbScale(e,t,s,n){if(!e||!t)return;if(e<s&&t<n)return 1;const a=s/e,i=n/t;return a<i?a:i}getContentUrl(){return void 0!==this.props.mxEvent.getContent().file?this.state.decryptedUrl:this.state.contentUrl}hasContentUrl(){const e=this.getContentUrl();return e&&!e.startsWith("data:")}getThumbUrl(){const e=this.props.mxEvent.getContent();return void 0!==e.file?this.state.decryptedThumbnailUrl:e.info&&e.info.thumbnail_url?Ns.a.getUnencryptedContentUrl(e,!0):null}async componentDidMount(){F.a.getValue("autoplayGifsAndVideos");const e=this.props.mxEvent.getContent();void 0!==e.file&&null===this.state.decryptedUrl?Ns.a.scanContent(e).then(t=>{if(!0===t.clean){this.setState({isClean:!0});let t,s=Promise.resolve(null);e.info&&e.info.thumbnail_file&&(s=Ns.a.downloadEncryptedContent(e,!0).then(e=>URL.createObjectURL(e))),s.then(s=>Promise.resolve(Ns.a.downloadEncryptedContent(e)).then(e=>(t=e,URL.createObjectURL(e))).then(e=>{this.setState({decryptedUrl:e,decryptedThumbnailUrl:s,decryptedBlob:t})})).catch(e=>{console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})})}else this.setState({isClean:!1})}):void 0!==e.url&&null===this.state.contentUrl&&Ns.a.scanContent(e).then(t=>{!0===t.clean?this.setState({contentUrl:Ns.a.getUnencryptedContentUrl(e),isClean:!0}):this.setState({isClean:!1})})}componentWillUnmount(){this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl),this.state.decryptedThumbnailUrl&&URL.revokeObjectURL(this.state.decryptedThumbnailUrl)}render(){const e=this.props.mxEvent.getContent(),t=F.a.getValue("autoplayGifsAndVideos");if(null!==this.state.error)return i.a.createElement("span",{className:"mx_MVideoBody"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16"}),Object(l.a)("Error decrypting video"));if(void 0!==e.file&&null===this.state.decryptedUrl&&t)return i.a.createElement("span",{className:"mx_MVideoBody"},i.a.createElement("div",{className:"mx_MImageBody_thumbnail mx_MImageBody_thumbnail_spinner"},i.a.createElement(qt.a,null)));const n=this.getContentUrl(),a=this.getThumbUrl();let o=null,r=null,c=null,d="metadata";if(e.info){const t=this.thumbScale(e.info.w,e.info.h,480,360);t&&(r=Math.floor(e.info.w*t),o=Math.floor(e.info.h*t)),a&&(c=a,d="none")}return i.a.createElement("span",{className:"mx_MVideoBody"},i.a.createElement("video",{className:"mx_MVideoBody",ref:this.videoRef,src:n,title:e.body,controls:!0,preload:d,muted:t,autoPlay:t,height:o,width:r,poster:c,onPlay:this.videoOnPlay}),i.a.createElement(Zi,se()({},this.props,{decryptedBlob:this.state.decryptedBlob})))}}var so=s(483),no=s(218);const ao=({text:e})=>{const t=d.getComponent("elements.Spinner");return i.a.createElement("div",{className:"mx_EncryptionInfo_spinner"},i.a.createElement(t,null),e)};var io,oo,ro,lo=({waitingForOtherParty:e,waitingForNetwork:t,member:s,onStartVerification:n,isRoomEncrypted:a,inDialog:o,isSelfVerification:r})=>{let c,m;if(e||t){let t;t=e?r?Object(l.a)("Waiting for you to accept on your other device…"):Object(l.a)("Waiting for %(displayName)s to accept…",{displayName:s.displayName||s.name||s.userId}):Object(l.a)("Accepting…"),c=i.a.createElement(ao,{text:t})}else{const e=d.getComponent("elements.AccessibleButton");c=i.a.createElement(e,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:n},Object(l.a)("Start Verification"))}return m=a?i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Messages in this room are end-to-end encrypted.")),i.a.createElement("p",null,Object(l.a)("Your messages are secured and only you and the recipient have the unique keys to unlock them."))):i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Messages in this room are not end-to-end encrypted.")),i.a.createElement("p",null,Object(l.a)("In encrypted rooms, your messages are secured and only you and the recipient have the unique keys to unlock them."))),o?c:i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Encryption")),m),i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Verify User")),i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("For extra security, verify this user by checking a one-time code on both of your devices.")),i.a.createElement("p",null,Object(l.a)("To be secure, do this in person or use a trusted way to communicate.")),c)))},co=s(318),mo=s(274);let ho=ya("views.elements.crypto.VerificationQRCode")((ro=oo=class extends i.a.PureComponent{render(){return i.a.createElement(ui.a,{data:[{data:this.props.qrCodeData.buffer,mode:"byte"}],className:"mx_VerificationQRCode",width:196})}},I()(oo,"propTypes",{qrCodeData:xe.a.object.isRequired}),io=ro))||io;var uo,po=s(198),go=s(211);!function(e){e[e.PHASE_UNSENT=0]="PHASE_UNSENT",e[e.PHASE_REQUESTED=1]="PHASE_REQUESTED",e[e.PHASE_READY=2]="PHASE_READY",e[e.PHASE_DONE=3]="PHASE_DONE",e[e.PHASE_STARTED=4]="PHASE_STARTED",e[e.PHASE_CANCELLED=5]="PHASE_CANCELLED"}(uo||(uo={}));class fo extends i.a.PureComponent{constructor(e){super(e),I()(this,"hasVerifier",void 0),I()(this,"onReciprocateYesClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.confirm()}),I()(this,"onReciprocateNoClick",()=>{this.setState({reciprocateButtonClicked:!0}),this.state.reciprocateQREvent.cancel()}),I()(this,"startSAS",async()=>{this.setState({emojiButtonClicked:!0});const e=this.props.request.beginKeyVerification(co.d.SAS);try{await e.verify()}catch(e){console.error(e)}}),I()(this,"onSasMatchesClick",()=>{this.state.sasEvent.confirm()}),I()(this,"onSasMismatchesClick",()=>{this.state.sasEvent.mismatch()}),I()(this,"updateVerifierState",()=>{const{request:e}=this.props,{sasEvent:t,reciprocateQREvent:s}=e.verifier;e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState),this.setState({sasEvent:t,reciprocateQREvent:s})}),I()(this,"onRequestChange",async()=>{const{request:e}=this.props,t=this.hasVerifier;if(this.hasVerifier=!!e.verifier,!t&&this.hasVerifier){e.verifier.on("show_sas",this.updateVerifierState),e.verifier.on("show_reciprocate_qr",this.updateVerifierState);try{await e.verifier.verify()}catch(e){console.error("error verify",e)}}}),this.state={},this.hasVerifier=!1}renderQRPhase(){const{member:e,request:t}=this.props,s=t.otherPartySupportsMethod(co.d.SAS),n=t.otherPartySupportsMethod(mo.c),a=d.getComponent("elements.AccessibleButton"),o=c.a.get().brand,r=s||n?null:i.a.createElement("p",null,Object(l.a)("The session you are trying to verify doesn't support scanning a QR code or emoji verification, which is what %(brand)s supports. Try with a different client.",{brand:o}));if("dialog"===this.props.layout){let e,o;n&&(e=i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},i.a.createElement("p",null,Object(l.a)("Scan this unique code")),i.a.createElement(ho,{qrCodeData:t.qrCodeData}))),s&&(o=i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOption"},i.a.createElement("p",null,Object(l.a)("Compare unique emoji")),i.a.createElement("span",{className:"mx_VerificationPanel_QRPhase_helpText"},Object(l.a)("Compare a unique set of emoji if you don't have a camera on either device")),i.a.createElement(a,{disabled:this.state.emojiButtonClicked,onClick:this.startSAS,kind:"primary"},Object(l.a)("Start"))));const c=e&&o?i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_betweenText"},Object(l.a)("or")):null;return i.a.createElement("div",null,Object(l.a)("Verify this device by completing one of the following:"),i.a.createElement("div",{className:"mx_VerificationPanel_QRPhase_startOptions"},e,c,o,r))}let m,h;if(n&&(m=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Verify by scanning")),i.a.createElement("p",null,Object(l.a)("Ask %(displayName)s to scan your code:",{displayName:e.displayName||e.name||e.userId})),i.a.createElement("div",{className:"mx_VerificationPanel_qrCode"},i.a.createElement(ho,{qrCodeData:t.qrCodeData})))),s){const e=this.state.emojiButtonClicked,t=n?Object(l.a)("If you can't scan the code above, verify by comparing unique emoji."):Object(l.a)("Verify by comparing unique emoji.");h=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Verify by emoji")),i.a.createElement("p",null,t),i.a.createElement(a,{disabled:e,kind:"primary",className:"mx_UserInfo_wideButton mx_VerificationPanel_verifyByEmojiButton",onClick:this.startSAS},Object(l.a)("Verify by emoji")))}const u=r?i.a.createElement("div",{className:"mx_UserInfo_container"},r):null;return i.a.createElement(i.a.Fragment,null,m,h,u)}getDevice(){const e=this.props.request&&this.props.request.channel.deviceId;return ee.a.get().getStoredDevice(ee.a.get().getUserId(),e)}renderQRReciprocatePhase(){const{member:e,request:t}=this.props;let s;s=this.props.inDialog?d.getComponent("elements.AccessibleButton"):d.getComponent("elements.FormButton");const n=t.isSelfVerification?Object(l.a)("Almost there! Is your other session showing the same shield?"):Object(l.a)("Almost there! Is %(displayName)s showing the same shield?",{displayName:e.displayName||e.name||e.userId});let a;return a=this.state.reciprocateQREvent?i.a.createElement(i.a.Fragment,null,i.a.createElement("p",null,n),i.a.createElement(po.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),i.a.createElement("div",{className:"mx_VerificationPanel_reciprocateButtons"},i.a.createElement(s,{label:Object(l.a)("No"),kind:"danger",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateNoClick},Object(l.a)("No")),i.a.createElement(s,{label:Object(l.a)("Yes"),kind:"primary",disabled:this.state.reciprocateButtonClicked,onClick:this.onReciprocateYesClick},Object(l.a)("Yes")))):i.a.createElement("p",null,i.a.createElement(Je.a,null)),i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_reciprocate_section"},i.a.createElement("h3",null,Object(l.a)("Verify by scanning")),a)}renderVerifiedPhase(){const{member:e,request:t}=this.props;let s,n;if(t.isSelfVerification||(s=this.props.isRoomEncrypted?Object(l.a)("Verify all users in a room to ensure it's secure."):Object(l.a)("In encrypted rooms, verify all users to ensure it’s secure.")),t.isSelfVerification){const e=this.getDevice();e?n=Object(l.a)("You've successfully verified %(deviceName)s (%(deviceId)s)!",{deviceName:e?e.getDisplayName():"",deviceId:this.props.request.channel.deviceId}):(console.warn("Verified device we don't know about: "+this.props.request.channel.deviceId),n=Object(l.a)("You've successfully verified your device!"))}else n=Object(l.a)("You've successfully verified %(displayName)s!",{displayName:e.displayName||e.name||e.userId});const a=d.getComponent("elements.AccessibleButton");return i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},i.a.createElement("h3",null,Object(l.a)("Verified")),i.a.createElement("p",null,n),i.a.createElement(po.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),s?i.a.createElement("p",null,s):null,i.a.createElement(a,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(l.a)("Got it")))}renderCancelledPhase(){const{member:e,request:t}=this.props,s=d.getComponent("elements.AccessibleButton");let n,a;return n=t.isSelfVerification?Object(l.a)("Start verification again from the notification."):Object(l.a)("Start verification again from their profile."),"m.timeout"===t.cancellationCode?a=Object(l.a)("Verification timed out.")+" "+n:t.cancellingUserId===t.otherUserId?(a=t.isSelfVerification?Object(l.a)("You cancelled verification on your other session."):Object(l.a)("%(displayName)s cancelled verification.",{displayName:e.displayName||e.name||e.userId}),a=`${a} ${n}`):a=Object(l.a)("You cancelled verification.")+" "+n,i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Verification cancelled")),i.a.createElement("p",null,a),i.a.createElement(s,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onClose},Object(l.a)("Got it")))}render(){const{member:e,phase:t,request:s}=this.props,n=e.displayName||e.name||e.userId;switch(t){case go.d:return this.renderQRPhase();case go.f:switch(s.chosenMethod){case co.d.RECIPROCATE_QR_CODE:return this.renderQRReciprocatePhase();case co.d.SAS:{const e=d.getComponent("views.verification.VerificationShowSas"),t=this.state.sasEvent?i.a.createElement(e,{displayName:n,device:this.getDevice(),sas:this.state.sasEvent.sas,onCancel:this.onSasMismatchesClick,onDone:this.onSasMatchesClick,inDialog:this.props.inDialog,isSelf:s.isSelfVerification}):i.a.createElement(Je.a,null);return i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Compare emoji")),t)}default:return null}case go.c:return this.renderVerifiedPhase();case go.b:return this.renderCancelledPhase()}return console.error("VerificationPanel unhandled phase:",t),null}componentDidMount(){const{request:e}=this.props;if(e.on("change",this.onRequestChange),e.verifier){const{sasEvent:t,reciprocateQREvent:s}=e.verifier;this.setState({sasEvent:t,reciprocateQREvent:s})}this.onRequestChange()}componentWillUnmount(){const{request:e}=this.props;e.verifier&&(e.verifier.off("show_sas",this.updateVerifierState),e.verifier.off("show_reciprocate_qr",this.updateVerifierState)),e.off("change",this.onRequestChange)}}const bo=["m.key_mismatch","m.user_error","m.mismatched_sas"];var vo=e=>{const{verificationRequest:t,verificationRequestPromise:n,member:o,onClose:r,layout:c,isRoomEncrypted:u}=e,[p,g]=Object(a.useState)(t),[b,v]=Object(a.useState)(!1),[_,y]=Object(a.useState)(p&&p.phase);Object(a.useEffect)(()=>{g(t),t&&(v(!1),y(t.phase))},[t]),Object(a.useEffect)(()=>{n&&async function(){v(!0);const e=await n;v(!1),g(e),y(e.phase)}()},[n]);const E=Object(a.useCallback)(()=>{if(p&&p.cancelled&&bo.includes(p.cancellationCode)){const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(348),title:Object(l.a)("Your messages are not secure"),description:i.a.createElement("div",null,Object(l.a)("One of the following may be compromised:"),i.a.createElement("ul",null,i.a.createElement("li",null,Object(l.a)("Your homeserver")),i.a.createElement("li",null,Object(l.a)("The homeserver the user you’re verifying is connected to")),i.a.createElement("li",null,Object(l.a)("Yours, or the other users’ internet connection")),i.a.createElement("li",null,Object(l.a)("Yours, or the other users’ session")))),onFinished:r})}else p&&y(p.phase)},[r,p]);Object(f.a)(p,"change",E);const C=Object(a.useCallback)(async()=>{v(!0);const e=ee.a.get(),t=await Object(Ct.c)(e,o.userId),s=await e.requestVerificationDM(o.userId,t);g(s),y(s.phase),m.a.dispatch({action:h.a.SetRightPanelPhase,phase:ls.b.EncryptionPanel,refireParams:{member:o,verificationRequest:s}})},[o]),w=!p&&b||p&&(_===go.e||_===go.g||void 0===_),S=p?p.isSelfVerification:o.userId===ee.a.get().getUserId();if(!p||w){const e=!p&&b||p&&p.initiatedByMe;return i.a.createElement(lo,{isRoomEncrypted:u,onStartVerification:C,member:o,isSelfVerification:S,waitingForOtherParty:w&&e,waitingForNetwork:w&&!e,inDialog:"dialog"===c})}return i.a.createElement(fo,{isRoomEncrypted:u,layout:c,onClose:r,member:o,request:p,key:p.channel.transactionId,inDialog:"dialog"===c,phase:_})},_o=s(484),yo=s(485);const Eo=[ls.b.GroupMemberInfo,ls.b.GroupMemberList],Co=[ls.b.GroupRoomList,ls.b.GroupRoomInfo];class wo extends yo.b{constructor(e){super(e,yo.a.Group),I()(this,"onMembersClicked",()=>{this.state.phase===ls.b.GroupMemberInfo?this.setPhase(ls.b.GroupMemberInfo):this.setPhase(ls.b.GroupMemberList)}),I()(this,"onRoomsClicked",()=>{this.setPhase(ls.b.GroupRoomList)})}onAction(e){e.action===h.a.ViewUser?e.member?this.setPhase(ls.b.RoomMemberInfo,{member:e.member}):this.setPhase(ls.b.GroupMemberList):"view_group"===e.action?this.setPhase(ls.b.GroupMemberList):"view_group_room"===e.action?this.setPhase(ls.b.GroupRoomInfo,{groupRoomId:e.groupRoomId,groupId:e.groupId}):"view_group_room_list"===e.action?this.setPhase(ls.b.GroupRoomList):"view_group_member_list"===e.action?this.setPhase(ls.b.GroupMemberList):"view_group_user"===e.action&&this.setPhase(ls.b.GroupMemberInfo,{member:e.member})}renderButtons(){return[i.a.createElement(_o.a,{key:"groupMembersButton",name:"groupMembersButton",title:Object(l.a)("Members"),isHighlighted:this.isPhase(Eo),onClick:this.onMembersClicked,analytics:["Right Panel","Group Member List Button","click"]}),i.a.createElement(_o.a,{key:"roomsButton",name:"roomsButton",title:Object(l.a)("Rooms"),isHighlighted:this.isPhase(Co),onClick:this.onRoomsClicked,analytics:["Right Panel","Group Room List Button","click"]})]}}var So=s(749),xo=s(491),Ro=s(165),Oo=s(335),ko=s(434);const Io=(e,t,s)=>{const[n,i]=Object(a.useState)(s);return Object(a.useEffect)(()=>{e().then(i)},t),n};var To=s(691),jo=s(692),No=s(699),Po=s(444);class Do extends i.a.Component{constructor(e){super(e),I()(this,"onSelectChange",e=>{"SELECT_VALUE_CUSTOM"===e.target.value?this.setState({custom:!0}):(this.props.onChange(e.target.value,this.props.powerLevelKey),this.setState({selectValue:e.target.value}))}),I()(this,"onCustomChange",e=>{this.setState({customValue:e.target.value})}),I()(this,"onCustomBlur",e=>{e.preventDefault(),e.stopPropagation(),this.props.onChange(parseInt(this.state.customValue),this.props.powerLevelKey)}),I()(this,"onCustomKeyDown",e=>{e.key===_s.a.ENTER&&(e.preventDefault(),e.stopPropagation(),e.target.blur())}),this.state={levelRoleMap:{},options:[],customValue:this.props.value,selectValue:0}}UNSAFE_componentWillMount(){this._initStateFromProps(this.props)}UNSAFE_componentWillReceiveProps(e){this._initStateFromProps(e)}_initStateFromProps(e){const t=ko.a(e.usersDefault),s=Object.keys(t).filter(t=>void 0===t||t<=e.maxValue||t==e.value),n=void 0===t[e.value];this.setState({levelRoleMap:t,options:s,custom:n,customLevel:e.value,selectValue:n?"SELECT_VALUE_CUSTOM":e.value})}render(){let e;const t=void 0===this.props.label?Object(l.a)("Power level"):this.props.label;if(this.state.custom)e=i.a.createElement(ke.a,{type:"number",label:t,max:this.props.maxValue,onBlur:this.onCustomBlur,onKeyDown:this.onCustomKeyDown,onChange:this.onCustomChange,value:String(this.state.customValue),disabled:this.props.disabled});else{let s=this.state.options.map(e=>({value:e,text:ko.b(e,this.props.usersDefault)}));s.push({value:"SELECT_VALUE_CUSTOM",text:Object(l.a)("Custom level")}),s=s.map(e=>i.a.createElement("option",{value:e.value,key:e.value},e.text)),e=i.a.createElement(ke.a,{element:"select",label:t,onChange:this.onSelectChange,value:String(this.state.selectValue),disabled:this.props.disabled},s)}return i.a.createElement("div",{className:"mx_PowerSelector"},e)}}I()(Do,"propTypes",{value:xe.a.number.isRequired,maxValue:xe.a.number.isRequired,usersDefault:xe.a.number.isRequired,disabled:xe.a.bool,onChange:xe.a.func,powerLevelKey:xe.a.string,label:xe.a.string}),I()(Do,"defaultProps",{maxValue:1/0,usersDefault:0});class Ao extends i.a.Component{getDuration(e){if(!e)return;const t=parseInt(e/1e3),s=t%60,n=parseInt(t/60)%60,a=parseInt(t/3600)%24,i=parseInt(t/86400);return t<60?t<0?Object(l.a)("%(duration)ss",{duration:0}):Object(l.a)("%(duration)ss",{duration:s}):t<3600?Object(l.a)("%(duration)sm",{duration:n}):t<86400?Object(l.a)("%(duration)sh",{duration:a}):Object(l.a)("%(duration)sd",{duration:i})}getPrettyPresence(e,t,s){if(!s&&void 0!==t&&t>0){const s=this.getDuration(t);return"online"===e?Object(l.a)("Online for %(duration)s",{duration:s}):"unavailable"===e?Object(l.a)("Idle for %(duration)s",{duration:s}):"offline"===e?Object(l.a)("Offline for %(duration)s",{duration:s}):Object(l.a)("Unknown for %(duration)s",{duration:s})}return"online"===e?Object(l.a)("Online"):"unavailable"===e?Object(l.a)("Idle"):"offline"===e?Object(l.a)("Offline"):Object(l.a)("Unknown")}render(){return i.a.createElement("div",{className:"mx_PresenceLabel"},this.getPrettyPresence(this.props.presenceState,this.props.activeAgo,this.props.currentlyActive))}}I()(Ao,"propTypes",{activeAgo:xe.a.number,currentlyActive:xe.a.bool,presenceState:xe.a.string}),I()(Ao,"defaultProps",{activeAgo:-1,presenceState:null});var Uo=s(303);class Mo extends i.a.Component{constructor(e){super(e),I()(this,"onOk",()=>{let e;this._reasonField&&(e=this._reasonField.value),this.props.onFinished(!0,e)}),I()(this,"onCancel",()=>{this.props.onFinished(!1)}),I()(this,"_collectReasonField",e=>{this._reasonField=e}),this._reasonField=null}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.avatars.MemberAvatar"),n=d.getComponent("views.avatars.BaseAvatar"),a=this.props.danger?"danger":"";let o,r,c,m;if(this.props.askReason&&(o=i.a.createElement("div",null,i.a.createElement("form",{onSubmit:this.onOk},i.a.createElement("input",{className:"mx_ConfirmUserActionDialog_reasonField",ref:this._collectReasonField,placeholder:Object(l.a)("Reason"),autoFocus:!0})))),this.props.member)r=i.a.createElement(s,{member:this.props.member,width:48,height:48}),c=this.props.member.name,m=this.props.member.userId;else{const e=this.props.groupMember.avatarUrl?this.props.matrixClient.mxcUrlToHttp(this.props.groupMember.avatarUrl,48,48):null;c=this.props.groupMember.displayname||this.props.groupMember.userId,m=this.props.groupMember.userId,r=i.a.createElement(n,{name:c,url:e,width:48,height:48})}return i.a.createElement(e,{className:"mx_ConfirmUserActionDialog",onFinished:this.props.onFinished,title:this.props.title,contentId:"mx_Dialog_content"},i.a.createElement("div",{id:"mx_Dialog_content",className:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_ConfirmUserActionDialog_avatar"},r),i.a.createElement("div",{className:"mx_ConfirmUserActionDialog_name"},c)),o,i.a.createElement(t,{primaryButton:this.props.action,onPrimaryButtonClick:this.onOk,primaryButtonClass:a,focus:!this.props.askReason,onCancel:this.onCancel}))}}I()(Mo,"propTypes",{member:xe.a.object,groupMember:Uo.a,matrixClient:xe.a.instanceOf(Fe.i),action:xe.a.string.isRequired,title:xe.a.string.isRequired,askReason:xe.a.bool,danger:xe.a.bool,onFinished:xe.a.func.isRequired}),I()(Mo,"defaultProps",{danger:!1,askReason:!1});var Lo=s(124);const Fo=({member:e,isIgnored:t,canInvite:s})=>{const n=Object(a.useContext)(b.a);let o=null,r=null,c=null,d=null;const h=e.userId===n.getUserId();if(!h){const a=()=>{const s=n.getIgnoredUsers();if(t){const t=s.indexOf(e.userId);-1!==t&&s.splice(t,1)}else s.push(e.userId);n.setIgnoredUsers(s)};if(o=i.a.createElement(pe.a,{onClick:a,className:L()("mx_UserInfo_field",{mx_UserInfo_destructive:!t})},t?Object(l.a)("Unignore"):Object(l.a)("Ignore")),e.roomId){const t=function(){const t=n.getRoom(e.roomId);m.a.dispatch({action:"view_room",highlighted:!0,event_id:t.getEventReadUpTo(e.userId),room_id:e.roomId})},s=function(){m.a.dispatch({action:"insert_mention",user_id:e.userId})},a=n.getRoom(e.roomId);null!=a&&a.getEventReadUpTo(e.userId)&&(d=i.a.createElement(pe.a,{onClick:t,className:"mx_UserInfo_field"},Object(l.a)("Jump to read receipt"))),r=i.a.createElement(pe.a,{onClick:s,className:"mx_UserInfo_field"},Object(l.a)("Mention"))}if(s&&(!e||!e.membership||"leave"===e.membership)){const t=e&&e.roomId?e.roomId:Q.a.getRoomId(),s=async()=>{try{const s=new Oo.a(t);await s.invite([e.userId]).then(()=>{if("invited"!==s.getCompletionState(e.userId))throw new Error(s.getErrorText(e.userId))})}catch(e){De.a.createTrackedDialog("Failed to invite","",Ae.a,{title:Object(l.a)("Failed to invite"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}};c=i.a.createElement(pe.a,{onClick:s,className:"mx_UserInfo_field"},Object(l.a)("Invite"))}}pe.a,Object(l.a)("Share Link to User");let u;h||E.a.isCurrentUserExtern()||(u=i.a.createElement(pe.a,{onClick:()=>async function(e,t){const s=Object(Ct.d)(e,t);if(s)return void m.a.dispatch({action:"view_room",room_id:s.roomId});const n={dmUserId:t,encryption:void 0};if(Object(Ct.e)()){const s=await e.downloadKeys([t]);Object.values(s).every(e=>Object.keys(e).length>0)&&(n.encryption=!0)}return Object(Ct.b)(n)}(n,e.userId),className:"mx_UserInfo_field"},Object(l.a)("Direct message")));const p=n.getRoom(e.roomId);return E.a.isRoomNotice(p)&&!h?null:i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Options")),i.a.createElement("div",null,u,d,r,c,o))},Bo=async()=>{const{finished:e}=De.a.createTrackedDialog("Demoting Self","",St.a,{title:Object(l.a)("Demote yourself?"),description:i.a.createElement("div",null,Object(l.a)("You will not be able to undo this change as you are demoting yourself, if you are the last privileged user in the room it will be impossible to regain privileges.")),button:Object(l.a)("Demote")}),[t]=await e;return t},Vo=({children:e})=>i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Admin Tools")),i.a.createElement("div",{className:"mx_UserInfo_buttons"},e)),Wo=({member:e,startUpdating:t,stopUpdating:s})=>{const n=Object(a.useContext)(b.a);if("invite"!==e.membership&&"join"!==e.membership)return null;const o="invite"===e.membership?Object(l.a)("Disinvite"):Object(l.a)("Kick");return i.a.createElement(pe.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{finished:a}=De.a.createTrackedDialog("Confirm User Action Dialog","onKick",Mo,{member:e,action:"invite"===e.membership?Object(l.a)("Disinvite"):Object(l.a)("Kick"),title:"invite"===e.membership?Object(l.a)("Disinvite this user?"):Object(l.a)("Kick this user?"),askReason:"join"===e.membership,danger:!0}),[i,o]=await a;i&&(t(),n.kick(e.roomId,e.userId,o||void 0).then(()=>{console.log("Kick success")},(function(e){console.error("Kick error: "+e),De.a.createTrackedDialog("Failed to kick","",Ae.a,{title:Object(l.a)("Failed to kick"),description:e&&e.message?e.message:"Operation failed"})})).finally(()=>{s()}))}},o)},Ho=({member:e})=>{const t=Object(a.useContext)(b.a);return i.a.createElement(pe.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:async()=>{const{roomId:s,userId:n}=e,a=t.getRoom(s);if(!a)return;let o=a.getLiveTimeline(),r=[];for(;o;)r=o.getEvents().reduce((e,t)=>t.getSender()!==n||t.isRedacted()||t.isRedaction()||t.getType()===Lo.a.RoomCreate||t.getType()===Lo.a.RoomServerAcl?e:e.concat(t),r),o=o.getNeighbouringTimeline(Ro.a.BACKWARDS);const c=r.length,d=e.name;if(0===c)De.a.createTrackedDialog("No user messages found to remove","",as.a,{title:Object(l.a)("No recent messages by %(user)s found",{user:d}),description:i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Try scrolling up in the timeline to see if there are any earlier ones.")))});else{const{finished:e}=De.a.createTrackedDialog("Remove recent messages by user","",St.a,{title:Object(l.a)("Remove recent messages by %(user)s",{user:d}),description:i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("You are about to remove %(count)s messages by %(user)s. This cannot be undone. Do you wish to continue?",{count:c,user:d})),i.a.createElement("p",null,Object(l.a)("For a large amount of messages, this might take some time. Please don't refresh your client in the meantime."))),button:Object(l.a)("Remove %(count)s messages",{count:c})}),[n]=await e;if(!n)return;await Promise.resolve(),console.info(`Started redacting recent ${c} messages for ${d} in ${s}`),await Promise.all(r.map(async e=>{try{await t.redactEvent(s,e.getId())}catch(t){console.error("Could not redact",e.getId()),console.error(t)}})),console.info(`Finished redacting recent ${c} messages for ${d} in ${s}`)}}},Object(l.a)("Remove recent messages"))},Go=({member:e,startUpdating:t,stopUpdating:s})=>{const n=Object(a.useContext)(b.a);let o=Object(l.a)("Ban");"ban"===e.membership&&(o=Object(l.a)("Unban"));const r=L()("mx_UserInfo_field",{mx_UserInfo_destructive:"ban"!==e.membership});return i.a.createElement(pe.a,{className:r,onClick:async()=>{const{finished:a}=De.a.createTrackedDialog("Confirm User Action Dialog","onBanOrUnban",Mo,{member:e,action:"ban"===e.membership?Object(l.a)("Unban"):Object(l.a)("Ban"),title:"ban"===e.membership?Object(l.a)("Unban this user?"):Object(l.a)("Ban this user?"),askReason:"ban"!==e.membership,danger:"ban"!==e.membership}),[i,o]=await a;if(!i)return;let r;t(),r="ban"===e.membership?n.unban(e.roomId,e.userId):n.ban(e.roomId,e.userId,o||void 0),r.then(()=>{console.log("Ban success")},(function(e){console.error("Ban error: "+e),De.a.createTrackedDialog("Failed to ban user","",Ae.a,{title:Object(l.a)("Error"),description:Object(l.a)("Failed to ban user")})})).finally(()=>{s()})}},o)},qo=({member:e,room:t,powerLevels:s,startUpdating:n,stopUpdating:o})=>{const r=Object(a.useContext)(b.a);if("join"!==e.membership)return null;const c=((e,t)=>{if(!t||!e)return!1;const s=(t.events?t.events["m.room.message"]:null)||t.events_default;return e.powerLevel<s})(e,s),d=L()("mx_UserInfo_field",{mx_UserInfo_destructive:!c}),m=c?Object(l.a)("Unmute"):Object(l.a)("Mute");return i.a.createElement(pe.a,{className:d,onClick:async()=>{const s=e.roomId,a=e.userId;if(a===r.getUserId())try{if(!await Bo())return}catch(e){return void console.error("Failed to warn about self demotion: ",e)}const i=t.currentState.getStateEvents("m.room.power_levels","");if(!i)return;const d=i.getContent(),m=(d.events?d.events["m.room.message"]:null)||d.events_default;let h;h=c?m:m-1,h=parseInt(h),isNaN(h)||(n(),r.setPowerLevel(s,a,h,i).then(()=>{console.log("Mute toggle success")},(function(e){console.error("Mute error: "+e),De.a.createTrackedDialog("Failed to mute user","",Ae.a,{title:Object(l.a)("Error"),description:Object(l.a)("Failed to mute user")})})).finally(()=>{o()}))}},m)},Ko=({room:e,children:t,member:s,startUpdating:n,stopUpdating:o,powerLevels:r})=>{const l=Object(a.useContext)(b.a);let c,d,m,h;const u=(r.events?r.events["m.room.power_levels"]:null)||r.state_default,{ban:p=50,kick:g=50,redact:f=50}=r,v=e.getMember(l.getUserId());if(!v)return i.a.createElement("div",null);const _=v.userId===s.userId,y=s.powerLevel<v.powerLevel||_;return y&&v.powerLevel>=g&&(c=i.a.createElement(Wo,{member:s,startUpdating:n,stopUpdating:o})),v.powerLevel>=f&&(h=i.a.createElement(Ho,{member:s,startUpdating:n,stopUpdating:o})),y&&v.powerLevel>=p&&(d=i.a.createElement(Go,{member:s,startUpdating:n,stopUpdating:o})),y&&v.powerLevel>=u&&(m=i.a.createElement(qo,{member:s,room:e,powerLevels:r,startUpdating:n,stopUpdating:o})),c||d||m||h||t?i.a.createElement(Vo,null,m,c,d,h,t):i.a.createElement("div",null)},zo=({children:e,groupId:t,groupMember:s,startUpdating:n,stopUpdating:o})=>{const r=Object(a.useContext)(b.a),[c,d]=Object(a.useState)(!1),[u,p]=Object(a.useState)(!1);if(Object(a.useEffect)(()=>{let e=!1;const n=()=>{e||(d(sa.a.isUserPrivileged(t)),p(sa.a.getGroupInvitedMembers(t).some(e=>e.userId===s.userId)))};return sa.a.registerListener(t,n),n(),()=>{e=!0,sa.a.unregisterListener(n)}},[t,s.userId]),c){const a=async()=>{const{finished:e}=De.a.createDialog(Mo,{matrixClient:r,groupMember:s,action:u?Object(l.a)("Disinvite"):Object(l.a)("Remove from community"),title:u?Object(l.a)("Disinvite this user from community?"):Object(l.a)("Remove this user from community?"),danger:!0}),[a]=await e;a&&(n(),r.removeUserFromGroup(t,s.userId).then(()=>{m.a.dispatch({action:h.a.ViewUser,member:null})}).catch(e=>{De.a.createTrackedDialog("Failed to remove user from group","",Ae.a,{title:Object(l.a)("Error"),description:u?Object(l.a)("Failed to withdraw invitation"):Object(l.a)("Failed to remove user from community")}),console.log(e)}).finally(()=>{o()}))},c=i.a.createElement(pe.a,{className:"mx_UserInfo_field mx_UserInfo_destructive",onClick:a},u?Object(l.a)("Disinvite"):Object(l.a)("Remove from community"));return i.a.createElement(Vo,null,c,e)}return i.a.createElement("div",null)};const $o=({user:e,room:t,roomPermissions:s,powerLevels:n})=>{if(s.canEdit&&!E.a.isUserExtern(e.userId))return i.a.createElement(Yo,{user:e,room:t,roomPermissions:s});{const t=n.users_default||0,s=parseInt(e.powerLevel,10),a=Object(ko.b)(s,t);return i.a.createElement("div",{className:"mx_UserInfo_profileField"},i.a.createElement("div",{className:"mx_UserInfo_roleDescription"},a))}},Yo=({user:e,room:t,roomPermissions:s})=>{const n=Object(a.useContext)(b.a),[o,r]=Object(a.useState)(parseInt(e.powerLevel,10)),c=Object(a.useCallback)(async s=>{const a=parseInt(s,10);r(a);const o=e.roomId,c=e.userId,d=t.currentState.getStateEvents("m.room.power_levels","");if(!d)return;const m=n.getUserId(),h=d.getContent().users[m];if(h&&parseInt(h)===a){const{finished:e}=De.a.createTrackedDialog("Promote to PL100 Warning","",St.a,{title:Object(l.a)("Warning!"),description:i.a.createElement("div",null,Object(l.a)("You will not be able to undo this change as you are promoting the user to have the same power level as yourself."),i.a.createElement("br",null),Object(l.a)("Are you sure?")),button:Object(l.a)("Continue")}),[t]=await e;if(!t)return}else if(m===c)try{if(!await Bo())return}catch(e){console.error("Failed to warn about self demotion: ",e)}await((e,t,s,a)=>n.setPowerLevel(e,t,parseInt(s),a).then((function(){console.log("Power change success")}),(function(e){console.error("Failed to change power level "+e),De.a.createTrackedDialog("Failed to change power level","",Ae.a,{title:Object(l.a)("Error"),description:Object(l.a)("Failed to change power level")})})))(o,c,a,d)},[e.roomId,e.userId,n,t]),d=t.currentState.getStateEvents("m.room.power_levels",""),m=d?d.getContent().users_default:0;return i.a.createElement("div",{className:"mx_UserInfo_profileField"},i.a.createElement(Do,{label:null,value:o,maxValue:s.modifyLevelMax,usersDefault:m,onChange:c}))},Jo=e=>{const t=Object(a.useContext)(b.a),[s,n]=Object(a.useState)(void 0);return Object(a.useEffect)(()=>{n(void 0);let s=!1;return async function(){try{await t.downloadKeys([e],!0);const a=t.getStoredDevicesForUser(e);if(s)return;(e=>{const t=Object.create(null);for(let s=0;s<e.length;s++){const n=e[s].getDisplayName(),a=t[n]||[];a.push(s),t[n]=a}for(const s in t)t[s].length>1&&t[s].forEach(t=>{e[t].ambiguous=!0})})(a),n(a)}catch(e){n(null)}}(),()=>{s=!0}},[t,e]),Object(a.useEffect)(()=>{let s=!1;const a=async()=>{const a=t.getStoredDevicesForUser(e);s||n(a)},i=t=>{t.includes(e)&&a()},o=(t,s)=>{t===e&&a()},r=(t,s)=>{t===e&&a()};return t.on("crypto.devicesUpdated",i),t.on("deviceVerificationChanged",o),t.on("userTrustStatusChanged",r),()=>{s=!0,t.removeListener("crypto.devicesUpdated",i),t.removeListener("deviceVerificationChanged",o),t.removeListener("userTrustStatusChanged",r)}},[t,e]),s},Qo=({room:e,member:t,groupId:s,devices:n,isRoomEncrypted:o})=>{const r=Object(a.useContext)(b.a),c=((e,t)=>{const[s,n]=Object(a.useState)({}),i=Object(a.useCallback)(()=>{if(!t)return;const e=t.currentState.getStateEvents("m.room.power_levels","");return n(e?e.getContent():{}),()=>{n({})}},[t]);return Object(f.a)(e,"RoomState.members",i),Object(a.useEffect)(()=>(i(),()=>{n({})}),[i]),s})(r,e),d=(e=>{const[t,s]=Object(a.useState)(!1);return Object(a.useEffect)(()=>{e.isSynapseAdministrator().then(e=>{s(e)},()=>{s(!1)})},[e]),t})(r),[m,h]=Object(a.useState)(r.isUserIgnored(t.userId));Object(a.useEffect)(()=>{h(r.isUserIgnored(t.userId))},[r,t.userId]);const u=Object(a.useCallback)(e=>{"m.ignored_user_list"===e.getType()&&h(r.isUserIgnored(t.userId))},[r,t.userId]);Object(f.a)(r,"accountData",u);const[p,g]=Object(a.useState)(0),v=Object(a.useCallback)(()=>{g(p+1)},[p]),_=Object(a.useCallback)(()=>{g(p-1)},[p]),y=function(e,t,s){const[n,i]=Object(a.useState)({modifyLevelMax:-1,canEdit:!1,canInvite:!1}),o=Object(a.useCallback)(()=>{if(!t)return;const n=t.currentState.getStateEvents("m.room.power_levels","");if(!n)return;const a=n.getContent();if(!a)return;const o=t.getMember(e.getUserId());if(!o)return;const r=s,l=o.userId===r.userId;let c=-1;if(r.powerLevel<o.powerLevel||l){const e=(a.events?a.events["m.room.power_levels"]:null)||a.state_default;o.powerLevel>=e&&(l||o.powerLevel>r.powerLevel)&&(c=o.powerLevel)}i({canInvite:o.powerLevel>=a.invite,canEdit:c>=0,modifyLevelMax:c})},[e,s,t]);return Object(f.a)(e,"RoomState.members",o),Object(a.useEffect)(()=>(o(),()=>{i({modifyLevelMax:-1,canEdit:!1,canInvite:!1})}),[o]),n}(r,e,t),E=Object(a.useCallback)(async()=>{const{finished:e}=De.a.createTrackedDialog("Synapse User Deactivation","",St.a,{title:Object(l.a)("Deactivate user?"),description:i.a.createElement("div",null,Object(l.a)("Deactivating this user will log them out and prevent them from logging back in. Additionally, they will leave all the rooms they are in. This action cannot be reversed. Are you sure you want to deactivate this user?")),button:Object(l.a)("Deactivate user"),danger:!0}),[s]=await e;if(s)try{await r.deactivateSynapseUser(t.userId)}catch(e){console.error("Failed to deactivate user"),console.error(e),De.a.createTrackedDialog("Failed to deactivate Synapse user","",Ae.a,{title:Object(l.a)("Failed to deactivate user"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}},[r,t.userId]);let C,w,S,x;d&&t.userId.endsWith(":"+ee.a.getHomeserverName())&&(C=i.a.createElement(pe.a,{onClick:E,className:"mx_UserInfo_field mx_UserInfo_destructive"},Object(l.a)("Deactivate user"))),e&&t.roomId?S=i.a.createElement(Ko,{powerLevels:c,member:t,room:e,startUpdating:v,stopUpdating:_},C):s?S=i.a.createElement(zo,{groupId:s,groupMember:t,startUpdating:v,stopUpdating:_},C):C&&(S=i.a.createElement(Vo,null,C)),p>0&&(w=i.a.createElement(Je.a,{imgClassName:"mx_ContextualMenu_spinner"})),e&&t.roomId&&!qn.a.shared().getUserIdForRoomId(t.roomId)&&(x=i.a.createElement("div",{className:"mx_UserInfo_container"},i.a.createElement("h3",null,Object(l.a)("Role")),i.a.createElement($o,{powerLevels:c,user:t,room:e,roomPermissions:y})));const R=r.isCryptoEnabled();let O,k;o?O=Object(l.a)("Messages in this room are end-to-end encrypted."):R?e&&(O=Object(l.a)("Messages in this room are not end-to-end encrypted.")):O=Object(l.a)("This client does not support end-to-end encryption.");const I=(e=>Io(async()=>e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),[e],!1))(r),T=R&&r.checkUserTrust(t.userId),j=R&&T.isCrossSigningVerified(),N=t.userId===r.getUserId(),P=R&&I&&!j&&!N&&n&&n.length>0,D=function(e,t,s,n){return Io(async()=>{if(s){n(!0);try{await e.downloadKeys([t.userId]);const s=e.getStoredCrossSigningForUser(t.userId);return!!(s&&s.getId())}finally{n(!1)}}},[e,t,s],void 0)}(r,t,P,e=>{g(t=>t+(e?1:-1))}),A=void 0===n;P&&(void 0!==D?k=i.a.createElement(pe.a,{className:"mx_UserInfo_field mx_UserInfo_verifyButton",onClick:()=>{D?Object(To.d)(t):Object(To.a)(t)}},Object(l.a)("Verify")):A||(k=i.a.createElement(Je.a,null)));Object(l.a)("Security"),R&&t.userId;let U=null;return N||(U=i.a.createElement(Fo,{canInvite:y.canInvite,isIgnored:m,member:t})),i.a.createElement(i.a.Fragment,null,x,U,S,w)},Xo=({member:e,e2eStatus:t})=>{const s=Object(a.useContext)(b.a),n=Object(a.useCallback)(()=>{const t=e.getMxcAvatarUrl?e.getMxcAvatarUrl():e.avatarUrl;if(!t)return;const n={src:s.mxcUrlToHttp(t),name:e.name};De.a.createDialog(Po.a,n,"mx_Dialog_lightbox")},[s,e]),o=i.a.createElement("div",{className:"mx_UserInfo_avatar"},i.a.createElement("div",null,i.a.createElement("div",null,i.a.createElement(Wa.a,{key:e.userId,member:e,width:.6*window.innerHeight,height:.6*window.innerHeight,resizeMethod:"scale",fallbackUserId:e.userId,onClick:n,urls:e.avatarUrl?[e.avatarUrl]:void 0}))));let r,l,d,m;e instanceof On.a&&e.user&&(r=e.user.presence,l=e.user.lastActiveAgo,d=e.user.currentlyActive,F.a.getValue("feature_custom_status")&&(m=e.user._unstable_statusMessage));const h=c.a.get().enable_presence_by_hs_url;let u=!1;h&&void 0!==h[s.baseUrl]&&(u=h[s.baseUrl]);let p=null;u&&(p=i.a.createElement(Ao,{activeAgo:l,currentlyActive:d,presenceState:r}));let g,f=null;m&&(f=i.a.createElement("span",{className:"mx_UserInfo_statusMessage"},m)),t&&(g=i.a.createElement(po.b,{size:18,status:t,isUser:!0}));const v=e.name||e.displayname;return i.a.createElement(i.a.Fragment,null,o,i.a.createElement("div",{className:"mx_UserInfo_container mx_UserInfo_separator"},i.a.createElement("div",{className:"mx_UserInfo_profile"},i.a.createElement("div",null,i.a.createElement("h2",null,i.a.createElement("span",{title:v,"aria-label":v},v))),i.a.createElement("div",{className:"mx_UserInfo_profileStatus"},p,f))))};var Zo=e=>{let{user:t,groupId:s,room:n,onClose:o,phase:r=ls.b.RoomMemberInfo}=e,c=ae()(e,["user","groupId","room","onClose","phase"]);const d=Object(a.useContext)(b.a),u=Object(a.useMemo)(()=>n&&n.getMember(t.userId)||t,[n,t]),p=Object(jo.a)(d,n),g=Jo(t.userId);let f;p&&g&&(f=((e,t,s)=>{const n=t===e.getUserId(),a=e.checkUserTrust(t);if(!a.isCrossSigningVerified())return a.wasCrossSigningVerified()?No.a.Warning:No.a.Normal;return s.some(s=>{const{deviceId:a}=s,i=e.checkDeviceTrust(t,a);return n?!i.isCrossSigningVerified():!i.isVerified()})?No.a.Warning:No.a.Verified})(d,t.userId,g));const v=["mx_UserInfo"];let _,y;n&&r===ls.b.EncryptionPanel?(y=ls.b.RoomMemberInfo,_={member:u}):n&&(y=ls.b.RoomMemberList);const E=()=>{m.a.dispatch({action:h.a.SetRightPanelPhase,phase:y,refireParams:_})};let C;switch(r){case ls.b.RoomMemberInfo:case ls.b.GroupMemberInfo:C=i.a.createElement(Qo,{room:n,member:u,groupId:s,devices:g,isRoomEncrypted:p});break;case ls.b.EncryptionPanel:v.push("mx_UserInfo_smallAvatar"),C=i.a.createElement(vo,se()({},c,{member:u,onClose:E,isRoomEncrypted:p}))}let w=void 0;if(r===ls.b.EncryptionPanel){const e=c.verificationRequest;e&&e.pending&&(w=Object(l.a)("Cancel"))}const S=i.a.createElement(Xo,{member:u,e2eStatus:f});return i.a.createElement(no.b,{className:v.join(" "),header:S,onClose:o,closeLabel:w,previousPhase:y,refireParams:_},C)},er=s(698);class tr{constructor(e,t){if(I()(this,"commandRegex",void 0),I()(this,"forcedCommandRegex",void 0),e){if(!e.global)throw new Error("commandRegex must have global flag set");this.commandRegex=e}if(t){if(!t.global)throw new Error("forcedCommandRegex must have global flag set");this.forcedCommandRegex=t}}destroy(){}getCurrentCommand(e,t,s=!1){let n,a=this.commandRegex;if(s&&this.shouldForceComplete()&&(a=this.forcedCommandRegex||/\S+/g),!a)return null;for(a.lastIndex=0;null!==(n=a.exec(e));){const e=n.index,s=e+n[0].length;if(t.start<=s&&t.end>=e)return{command:n,range:{start:e,end:s}}}return{command:null,range:{start:-1,end:-1}}}async getCompletions(e,t,s=!1){return[]}getName(){return"Default Provider"}renderCompletions(e){return console.error("stub; should be implemented in subclasses"),null}shouldForceComplete(){return!1}}function sr(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function nr(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?sr(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):sr(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class ar{constructor(e,t={keys:[]}){I()(this,"_options",void 0),I()(this,"_items",void 0),this._options=t,this.setObjects(e),void 0===this._options.shouldMatchWordsOnly&&(this._options.shouldMatchWordsOnly=!0),void 0===this._options.shouldMatchPrefix&&(this._options.shouldMatchPrefix=!1)}setObjects(e){this._items=new Map;for(const t of e){const e=Object(Pa.at)(t,this._options.keys);if(this._options.funcs)for(const s of this._options.funcs)e.push(s(t));for(const[s,n]of Object.entries(e)){if(!n)continue;const e=this.processQuery(n);this._items.has(e)||this._items.set(e,[]),this._items.get(e).push({keyWeight:Number(s),object:t})}}}match(e){if(e=this.processQuery(e),this._options.shouldMatchWordsOnly&&(e=e.replace(/[^\w]/g,"")),0===e.length)return[];const t=[];for(const[s,n]of this._items.entries()){let a=s;this._options.shouldMatchWordsOnly&&(a=a.replace(/[^\w]/g,""));const i=a.indexOf(e);-1===i||this._options.shouldMatchPrefix&&0!==i||t.push(...n.map(e=>nr({index:i},e)))}return t.sort((e,t)=>{if(e.index<t.index)return-1;if(e.index===t.index){if(e.keyWeight<t.keyWeight)return-1;if(e.keyWeight===t.keyWeight)return 0}return 1}),Object(Pa.uniq)(t.map(e=>e.object))}processQuery(e){return!1!==this._options.fuzzy?Object(gs.B)(e.toLowerCase()).toLowerCase():e.toLowerCase()}}const ir=Object(a.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:a,className:o}=e,r=ae()(e,["title","subtitle","description","className"]);return i.a.createElement("div",se()({},r,{className:L()("mx_Autocomplete_Completion_block",o),role:"option",ref:t}),i.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),i.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n),i.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},a))}),or=Object(a.forwardRef)((e,t)=>{const{title:s,subtitle:n,description:a,className:o,children:r}=e,l=ae()(e,["title","subtitle","description","className","children"]);let c=null;a.startsWith("#")&&(c=i.a.createElement("span",{className:"mx_Autocomplete_Completion_description"},"[",E.a.computeDomainFromRoomId(a),"]"));let d=n?i.a.createElement("span",{className:"mx_Autocomplete_Completion_subtitle"},n):null;return i.a.createElement("div",se()({},l,{className:L()("mx_Autocomplete_Completion_pill",o),role:"option",ref:t}),r,i.a.createElement("span",{className:"mx_Autocomplete_Completion_title"},s),d,c)});var rr=s(121);function lr(e){const t=2*Math.PI/e.length;return Array.from(e).map((e,s)=>{if(" "===e)return e;const[n,a]=function(e,t){const s=127*t*Math.cos(e),n=127*t*Math.sin(e);return[s,n]}(s*t,1),[i,o,r]=function(e,t,s){let n=(e+16)/116;const a=.9505*cr(n+t/500),i=1.089*cr(n-s/200);n=cr(n);const o=-.96924364*a+1.8759675*n+.04155506*i,r=.05563008*a-.20397696*n+1.05697151*i;return[dr(3.24096994*a-1.53738318*n-.49861076*i),dr(o),dr(r)]}(75,n,a);return'<font color="#'+i.toString(16).padStart(2,"0")+o.toString(16).padStart(2,"0")+r.toString(16).padStart(2,"0")+'">'+e+"</font>"}).join("")}function cr(e){return e>.2069?Math.pow(e,3):.1284*e-.01771}function dr(e){const t=function(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}(e),s=Math.min(Math.max(t,0),1);return Math.round(255*s)}var mr=s(242),hr=s(281),ur=s(110),pr=s(132),gr=s(447),fr=s(419),br=s(202);function vr(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function _r(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?vr(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):vr(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}const yr=async()=>new Promise(e=>{const t=document.createElement("input");t.setAttribute("type","file"),t.onchange=t=>{const s=t.target.files[0],n=d.getComponent("dialogs.UploadConfirmDialog");De.a.createTrackedDialog("Upload Files confirmation","",n,{file:s,onFinished:t=>{e(t?ee.a.get().uploadContent(s):null)}})},t.click()}),Er={messages:Object(l.b)("Messages"),actions:Object(l.b)("Actions"),admin:Object(l.b)("Admin"),advanced:Object(l.b)("Advanced"),effects:Object(l.b)("Effects"),other:Object(l.b)("Other")};class Cr{constructor(e){I()(this,"command",void 0),I()(this,"aliases",void 0),I()(this,"args",void 0),I()(this,"description",void 0),I()(this,"runFn",void 0),I()(this,"category",void 0),I()(this,"hideCompletionAfterSpace",void 0),I()(this,"_isEnabled",void 0),this.command=e.command,this.aliases=e.aliases||[],this.args=e.args||"",this.description=e.description,this.runFn=e.runFn,this.category=e.category||Er.other,this.hideCompletionAfterSpace=e.hideCompletionAfterSpace||!1,this._isEnabled=e.isEnabled}getCommand(){return"/"+this.command}getCommandWithArgs(){return this.getCommand()+" "+this.args}run(e,t,s){return this.runFn?this.runFn.bind(this)(e,t,s):wr(Object(l.a)("Command error"))}getUsage(){return Object(l.a)("Usage")+": "+this.getCommandWithArgs()}isEnabled(){return!this._isEnabled||this._isEnabled()}}function wr(e){return{error:e}}function Sr(e){return{promise:e}}const xr=[new Cr({command:"shrug",args:"<message>",description:Object(l.b)("Prepends ¯\\_(ツ)_/¯ to a plain-text message"),runFn:function(e,t){let s="¯\\_(ツ)_/¯";return t&&(s=s+" "+t),Sr(ee.a.get().sendTextMessage(e,s))},category:Er.messages}),new Cr({command:"tableflip",args:"<message>",description:Object(l.b)("Prepends (╯°□°）╯︵ ┻━┻ to a plain-text message"),runFn:function(e,t){let s="(╯°□°）╯︵ ┻━┻";return t&&(s=s+" "+t),Sr(ee.a.get().sendTextMessage(e,s))},category:Er.messages}),new Cr({command:"unflip",args:"<message>",description:Object(l.b)("Prepends ┬──┬ ノ( ゜-゜ノ) to a plain-text message"),runFn:function(e,t){let s="┬──┬ ノ( ゜-゜ノ)";return t&&(s=s+" "+t),Sr(ee.a.get().sendTextMessage(e,s))},category:Er.messages}),new Cr({command:"lenny",args:"<message>",description:Object(l.b)("Prepends ( ͡° ͜ʖ ͡°) to a plain-text message"),runFn:function(e,t){let s="( ͡° ͜ʖ ͡°)";return t&&(s=s+" "+t),Sr(ee.a.get().sendTextMessage(e,s))},category:Er.messages}),new Cr({command:"plain",args:"<message>",description:Object(l.b)("Sends a message as plain text, without interpreting it as markdown"),runFn:function(e,t){return Sr(ee.a.get().sendTextMessage(e,t))},category:Er.messages}),new Cr({command:"html",args:"<message>",description:Object(l.b)("Sends a message as html, without interpreting it as markdown"),runFn:function(e,t){return Sr(ee.a.get().sendHtmlMessage(e,t,t))},category:Er.messages}),new Cr({command:"ddg",args:"<query>",description:Object(l.b)("Searches DuckDuckGo for results"),runFn:function(){const e=d.getComponent("dialogs.ErrorDialog");return De.a.createTrackedDialog("Slash Commands","/ddg is not a command",e,{title:Object(l.a)("/ddg is not a command"),description:Object(l.a)("To use it, just wait for autocomplete results to load and tab through them.")}),Sr()},category:Er.actions,hideCompletionAfterSpace:!0}),new Cr({command:"upgraderoom",args:"<new_version>",description:Object(l.b)("Upgrades a room to a new version"),runFn:function(e,t){if(t){const s=ee.a.get(),n=s.getRoom(e);if(!n.currentState.mayClientSendStateEvent("m.room.tombstone",s))return wr(Object(l.a)("You do not have the required permissions to use this command."));const a=d.getComponent("dialogs.RoomUpgradeWarningDialog"),{finished:i}=De.a.createTrackedDialog("Slash Commands","upgrade room confirmation",a,{roomId:e,targetVersion:t},null,!1,!0);return Sr(i.then(async([a])=>{if(!a.continue)return;let i;try{const o=s.upgradeRoom(e,t);a.invite&&(i=async e=>{const{replacement_room:t}=await o;if(e.roomId!==t)return;const a=[...n.getMembersWithMembership("join"),...n.getMembersWithMembership("invite")].map(e=>e.userId).filter(e=>e!==s.getUserId());a.length>0&&await Object(rs.b)(t,a),s.removeListener("Room",i)},s.on("Room",i)),await o}catch(e){console.error(e),i&&s.removeListener("Room",i);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Slash Commands","room upgrade error",t,{title:Object(l.a)("Error upgrading room"),description:Object(l.a)("Double check that your server supports the room version chosen and try again.")})}}))}return wr(this.getUsage())},category:Er.admin}),new Cr({command:"nick",args:"<display_name>",description:Object(l.b)("Changes your display nickname"),runFn:function(e,t){return t?Sr(ee.a.get().setDisplayName(t)):wr(this.getUsage())},category:Er.actions}),new Cr({command:"myroomnick",aliases:["roomnick"],args:"<display_name>",description:Object(l.b)("Changes your display nickname in the current room only"),runFn:function(e,t){if(t){const s=ee.a.get(),n=s.getRoom(e).currentState.getStateEvents("m.room.member",s.getUserId()),a=_r(_r({},n?n.getContent():{membership:"join"}),{},{displayname:t});return Sr(s.sendStateEvent(e,"m.room.member",a,s.getUserId()))}return wr(this.getUsage())},category:Er.actions}),new Cr({command:"roomavatar",args:"[<mxc_url>]",description:Object(l.b)("Changes the avatar of the current room"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=yr()),Sr(s.then(t=>{if(t)return ee.a.get().sendStateEvent(e,"m.room.avatar",{url:t},"")}))},category:Er.actions}),new Cr({command:"myroomavatar",args:"[<mxc_url>]",description:Object(l.b)("Changes your avatar in this current room only"),runFn:function(e,t){const s=ee.a.get(),n=s.getRoom(e),a=s.getUserId();let i=Promise.resolve(t);return t||(i=yr()),Sr(i.then(t=>{if(!t)return;const i=n.currentState.getStateEvents("m.room.member",a),o=_r(_r({},i?i.getContent():{membership:"join"}),{},{avatar_url:t});return s.sendStateEvent(e,"m.room.member",o,a)}))},category:Er.actions}),new Cr({command:"myavatar",args:"[<mxc_url>]",description:Object(l.b)("Changes your avatar in all rooms"),runFn:function(e,t){let s=Promise.resolve(t);return t||(s=yr()),Sr(s.then(e=>{if(e)return ee.a.get().setAvatarUrl(e)}))},category:Er.actions}),new Cr({command:"topic",args:"[<topic>]",description:Object(l.b)("Gets or sets the room topic"),runFn:function(e,t){const s=ee.a.get();if(t)return Sr(s.setRoomTopic(e,t));const n=s.getRoom(e);if(!n)return wr(Object(l.a)("Failed to set topic"));const i=n.currentState.getStateEvents("m.room.topic",""),o=i&&i.getContent().topic,r=o?Object(rr.e)(o):Object(l.a)("This room has no topic."),c=d.getComponent("dialogs.InfoDialog");return De.a.createTrackedDialog("Slash Commands","Topic",c,{title:n.name,description:a.createElement("div",{dangerouslySetInnerHTML:{__html:r}}),hasCloseButton:!0}),Sr()},category:Er.admin}),new Cr({command:"roomname",args:"<name>",description:Object(l.b)("Sets the room name"),runFn:function(e,t){return t?Sr(ee.a.get().setRoomName(e,t)):wr(this.getUsage())},category:Er.admin}),new Cr({command:"invite",args:"<user-id>",description:Object(l.b)("Invites user with given id to current room"),runFn:function(e,t){if(t){const s=t.match(/^(\S+)$/);if(s){const t=s[1];let n=Promise.resolve();if("email"===Object(mr.c)(t)&&!ee.a.get().getIdentityServerUrl()){const e=Object(hr.c)();if(!e)return wr(Object(l.a)("Use an identity server to invite by email. Manage in Settings."));{const{finished:t}=De.a.createTrackedDialog("Slash Commands","Identity server",St.a,{title:Object(l.a)("Use an identity server"),description:a.createElement("p",null,Object(l.a)("Use an identity server to invite by email. Click continue to use the default identity server (%(defaultIdentityServerName)s) or manage in Settings.",{defaultIdentityServerName:Object($e.a)(e)})),button:Object(l.a)("Continue")});n=t.then(([e])=>{if(!e)throw new Error(Object(l.a)("Use an identity server to invite by email. Manage in Settings."));Object(hr.d)()})}}const i=new Oo.a(e);return Sr(n.then(()=>i.invite([t])).then(()=>{if("invited"!==i.getCompletionState(t))throw new Error(i.getErrorText(t))}))}}return wr(this.getUsage())},category:Er.actions}),new Cr({command:"join",aliases:["j","goto"],args:"<room-address>",description:Object(l.b)("Joins room with given address"),runFn:function(e,t){if(t){const e=t.split(" ");if(e.length<1)return wr(this.getUsage());let s=!1;if(e[0].startsWith("http:")||e[0].startsWith("https:")){const t=new URL(e[0]),n=t.host||t.hostname;Object(ur.c)(n)&&(s=!0)}if("#"===e[0][0]){let t=e[0];return t.includes(":")||(t+=":"+ee.a.get().getDomain()),m.a.dispatch({action:"view_room",room_alias:t,auto_join:!0,_type:"slash_command"}),Sr()}if("!"===e[0][0]){const[t,...s]=e;return m.a.dispatch({action:"view_room",room_id:t,opts:{viaServers:s},via_servers:s,auto_join:!0,_type:"slash_command"}),Sr()}if(s){const t=Object(ur.i)(e[0]);if(!t)return wr(this.getUsage());if(!t.roomIdOrAlias)return wr(this.getUsage());const s=t.roomIdOrAlias,n=t.viaServers,a=t.eventId,i={action:"view_room",auto_join:!0,_type:"slash_command"};return"!"===s[0]?i.room_id=s:i.room_alias=s,a&&(i.event_id=a,i.highlighted=!0),n&&(i.opts={viaServers:n},i.via_servers=n),m.a.dispatch(i),Sr()}}return wr(this.getUsage())},category:Er.actions}),new Cr({command:"part",args:"[<room-address>]",description:Object(l.b)("Leave room"),runFn:function(e,t){const s=ee.a.get();let n;if(t){const e=t.match(/^(\S+)$/);if(e){let t=e[1];if("#"!==t[0])return wr(this.getUsage());t.includes(":")||(t+=":"+s.getDomain());const a=s.getRooms();for(let e=0;e<a.length;e++){const s=a[e].currentState.getStateEvents("m.room.aliases");for(let i=0;i<s.length;i++){const o=s[i].getContent().aliases||[];for(let s=0;s<o.length;s++)if(o[s]===t){n=a[e].roomId;break}if(n)break}if(n)break}if(!n)return wr(Object(l.a)("Unrecognised room address:")+" "+t)}}return n||(n=e),Sr(Object(Zn.d)(n))},category:Er.actions}),new Cr({command:"kick",args:"<user-id> [reason]",description:Object(l.b)("Kicks user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return Sr(ee.a.get().kick(e,s[1],s[3]))}return wr(this.getUsage())},category:Er.admin}),new Cr({command:"ban",args:"<user-id> [reason]",description:Object(l.b)("Bans user with given id"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(.*))?$/);if(s)return Sr(ee.a.get().ban(e,s[1],s[3]))}return wr(this.getUsage())},category:Er.admin}),new Cr({command:"unban",args:"<user-id>",description:Object(l.b)("Unbans user with given ID"),runFn:function(e,t){if(t){const s=t.match(/^(\S+)$/);if(s)return Sr(ee.a.get().unban(e,s[1]))}return wr(this.getUsage())},category:Er.admin}),new Cr({command:"ignore",args:"<user-id>",description:Object(l.b)("Ignores a user, hiding their messages from you"),runFn:function(e,t){if(t){const e=ee.a.get(),s=t.match(/^(@[^:]+:\S+)$/);if(s){const t=s[1],n=e.getIgnoredUsers();return n.push(t),Sr(e.setIgnoredUsers(n).then(()=>{const e=d.getComponent("dialogs.InfoDialog");De.a.createTrackedDialog("Slash Commands","User ignored",e,{title:Object(l.a)("Ignored user"),description:a.createElement("div",null,a.createElement("p",null,Object(l.a)("You are now ignoring %(userId)s",{userId:t})))})}))}}return wr(this.getUsage())},category:Er.actions}),new Cr({command:"unignore",args:"<user-id>",description:Object(l.b)("Stops ignoring a user, showing their messages going forward"),runFn:function(e,t){if(t){const e=ee.a.get(),s=t.match(/(^@[^:]+:\S+$)/);if(s){const t=s[1],n=e.getIgnoredUsers(),i=n.indexOf(t);return-1!==i&&n.splice(i,1),Sr(e.setIgnoredUsers(n).then(()=>{const e=d.getComponent("dialogs.InfoDialog");De.a.createTrackedDialog("Slash Commands","User unignored",e,{title:Object(l.a)("Unignored user"),description:a.createElement("div",null,a.createElement("p",null,Object(l.a)("You are no longer ignoring %(userId)s",{userId:t})))})}))}}return wr(this.getUsage())},category:Er.actions}),new Cr({command:"op",args:"<user-id> [<power-level>]",description:Object(l.b)("Define the power level of a user"),runFn:function(e,t){if(t){const s=t.match(/^(\S+?)( +(-?\d+))?$/);let n=50;if(s){const t=s[1];if(4===s.length&&void 0!==s[3]&&(n=parseInt(s[3],10)),!isNaN(n)){const s=ee.a.get(),a=s.getRoom(e);if(!a)return wr(Object(l.a)("Command failed"));const i=a.getMember(t);if(!i||Object(Zn.b)(i.membership)===Zn.a.Leave)return wr(Object(l.a)("Could not find user in room"));const o=a.currentState.getStateEvents("m.room.power_levels","");return Sr(s.setPowerLevel(e,t,n,o))}}}return wr(this.getUsage())},category:Er.admin}),new Cr({command:"deop",args:"<user-id>",description:Object(l.b)("Deops user with given id"),runFn:function(e,t){if(t){if(t.match(/^(\S+)$/)){const s=ee.a.get(),n=s.getRoom(e);if(!n)return wr(Object(l.a)("Command failed"));const a=n.currentState.getStateEvents("m.room.power_levels","");return a.getContent().users[t]?Sr(s.setPowerLevel(e,t,void 0,a)):wr(Object(l.a)("Could not find user in room"))}}return wr(this.getUsage())},category:Er.admin}),new Cr({command:"devtools",description:Object(l.b)("Opens the Developer Tools dialog"),runFn:function(e){const t=d.getComponent("dialogs.DevtoolsDialog");return De.a.createDialog(t,{roomId:e}),Sr()},category:Er.advanced}),new Cr({command:"addwidget",args:"<url | embed code | Jitsi url>",description:Object(l.b)("Adds a custom widget by URL to the room"),isEnabled:()=>F.a.getValue(Xe.a.Widgets),runFn:function(e,t){if(!t)return wr(Object(l.a)("Please supply a widget URL or embed code"));if(t.toLowerCase().startsWith("<iframe ")){const e=Object(fr.parseFragment)(t);if(e&&e.childNodes&&1===e.childNodes.length){const s=e.childNodes[0];if("iframe"===s.tagName.toLowerCase()&&s.attrs){const e=s.attrs.find(e=>"src"===e.name);console.log("Pulling URL out of iframe (embed code)"),t=e.value}}}if(!t.startsWith("https://")&&!t.startsWith("http://"))return wr(Object(l.a)("Please supply a https:// or http:// widget URL"));if(Os.a.canUserModifyWidgets(e)){const s=ee.a.get().getUserId(),n=(new Date).getTime(),a=encodeURIComponent(`${e}_${s}_${n}`);let i=pr.a.CUSTOM,o="Custom Widget",r={};const l=gr.a.getInstance().parsePreferredConferenceUrl(t);return l&&(console.log("Making /addwidget widget a Jitsi conference"),i=pr.a.JITSI,o="Jitsi Conference",r=l,t=Os.a.getLocalJitsiWrapperUrl()),Sr(Os.a.setRoomWidget(e,a,i,t,o,r))}return wr(Object(l.a)("You cannot modify widgets in this room."))},category:Er.admin}),new Cr({command:"verify",args:"<user-id> <device-id> <device-signing-key>",description:Object(l.b)("Verifies a user, session, and pubkey tuple"),runFn:function(e,t){if(t){const e=t.match(/^(\S+) +(\S+) +(\S+)$/);if(e){const t=ee.a.get(),s=e[1],n=e[2],i=e[3];return Sr((async()=>{const e=t.getStoredDevice(s,n);if(!e)throw new Error(Object(l.a)("Unknown (user, session) pair:")+` (${s}, ${n})`);if((await t.checkDeviceTrust(s,n)).isVerified())throw e.getFingerprint()===i?new Error(Object(l.a)("Session already verified!")):new Error(Object(l.a)("WARNING: Session already verified, but keys do NOT MATCH!"));if(e.getFingerprint()!==i){const t=e.getFingerprint();throw new Error(Object(l.a)('WARNING: KEY VERIFICATION FAILED! The signing key for %(userId)s and session %(deviceId)s is "%(fprint)s" which does not match the provided key "%(fingerprint)s". This could mean your communications are being intercepted!',{fprint:t,userId:s,deviceId:n,fingerprint:i}))}await t.setDeviceVerified(s,n,!0);const o=d.getComponent("dialogs.InfoDialog");De.a.createTrackedDialog("Slash Commands","Verified key",o,{title:Object(l.a)("Verified key"),description:a.createElement("div",null,a.createElement("p",null,Object(l.a)("The signing key you provided matches the signing key you received from %(userId)s's session %(deviceId)s. Session marked as verified.",{userId:s,deviceId:n})))})})())}}return wr(this.getUsage())},category:Er.advanced}),new Cr({command:"discardsession",description:Object(l.b)("Forces the current outbound group session in an encrypted room to be discarded"),runFn:function(e){try{ee.a.get().forceDiscardSession(e)}catch(e){return wr(e.message)}return Sr()},category:Er.advanced}),new Cr({command:"rainbow",description:Object(l.b)("Sends the given message coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?Sr(ee.a.get().sendHtmlMessage(e,t,lr(t))):wr(this.getUserId())},category:Er.messages}),new Cr({command:"rainbowme",description:Object(l.b)("Sends the given emote coloured as a rainbow"),args:"<message>",runFn:function(e,t){return t?Sr(ee.a.get().sendHtmlEmote(e,t,lr(t))):wr(this.getUserId())},category:Er.messages}),new Cr({command:"help",description:Object(l.b)("Displays list of commands with usages and descriptions"),runFn:function(){const e=d.getComponent("dialogs.SlashCommandHelpDialog");return De.a.createTrackedDialog("Slash Commands","Help",e),Sr()},category:Er.advanced}),new Cr({command:"whois",description:Object(l.b)("Displays information about a user"),args:"<user-id>",runFn:function(e,t){if(!t||!t.startsWith("@")||!t.includes(":"))return wr(this.getUsage());const s=ee.a.get().getRoom(e).getMember(t);return m.a.dispatch({action:h.a.ViewUser,member:s||{userId:t}}),Sr()},category:Er.advanced}),new Cr({command:"rageshake",aliases:["bugreport"],description:Object(l.b)("Send a bug report with logs"),isEnabled:()=>!!c.a.get().bug_report_endpoint_url,args:"<description>",runFn:function(e,t){return Sr(De.a.createTrackedDialog("Slash Commands","Bug Report Dialog",ns,{initialText:t}).finished)},category:Er.advanced}),new Cr({command:"query",description:Object(l.b)("Opens chat with the given user"),args:"<user-id>",runFn:function(e,t){const s=t&&/^\+?[0123456789]+$/.test(t);return t&&(t.startsWith("@")&&t.includes(":")||s)?Sr((async()=>{if(s){const e=await ee.a.get().getThirdpartyUser("im.vector.protocol.pstn",{"m.id.phone":t});if(!e||0===e.length||!e[0].userid)throw new Error("Unable to find Matrix ID for phone number");t=e[0].userid}const e=await Object(Ct.c)(ee.a.get(),t);m.a.dispatch({action:"view_room",room_id:e})})()):wr(this.getUsage())},category:Er.actions}),new Cr({command:"msg",description:Object(l.b)("Sends a message to the given user"),args:"<user-id> <message>",runFn:function(e,t){if(t){const e=t.match(/^(\S+?)(?: +(.*))?$/s);if(e){const[t,s]=e.slice(1);if(s&&t&&t.startsWith("@")&&t.includes(":"))return Sr((async()=>{const e=ee.a.get(),n=await Object(Ct.c)(e,t);m.a.dispatch({action:"view_room",room_id:n}),e.sendTextMessage(n,s)})())}}return wr(this.getUsage())},category:Er.actions}),new Cr({command:"holdcall",description:Object(l.b)("Places the call in the current room on hold"),category:Er.other,runFn:function(e,t){const s=fe.b.sharedInstance().getCallForRoom(e);return s?(s.setRemoteOnHold(!0),Sr()):wr("No active call in this room")}}),new Cr({command:"unholdcall",description:Object(l.b)("Takes the call in the current room off hold"),category:Er.other,runFn:function(e,t){const s=fe.b.sharedInstance().getCallForRoom(e);return s?(s.setRemoteOnHold(!1),Sr()):wr("No active call in this room")}}),new Cr({command:"converttodm",description:Object(l.b)("Converts the room to a DM"),category:Er.other,runFn:function(e,t){const s=ee.a.get().getRoom(e);return Sr(Object(Dn.b)(s,!0))}}),new Cr({command:"converttoroom",description:Object(l.b)("Converts the DM to a room"),category:Er.other,runFn:function(e,t){const s=ee.a.get().getRoom(e);return Sr(Object(Dn.b)(s,!1))}}),new Cr({command:"me",args:"<message>",description:Object(l.b)("Displays action"),category:Er.messages,hideCompletionAfterSpace:!0}),...br.CHAT_EFFECTS.map(e=>new Cr({command:e.command,description:e.description(),args:"<message>",runFn:function(t,s){return Sr((async()=>{if(s){const n={msgtype:e.msgType,body:s};ee.a.get().sendMessage(t,n)}else s=e.fallbackMessage(),ee.a.get().sendEmoteMessage(t,s);m.a.dispatch({action:"effects."+e.command})})())},category:Er.effects}))],Rr=new Map;function Or(e){if("/"!==(e=e.replace(/\s+$/,""))[0])return{};const t=e.match(/^(\S+?)(?: +((.|\n)*))?$/);let s,n;return t?(s=t[1].substring(1).toLowerCase(),n=t[2]):s=e,{cmd:s,args:n}}function kr(e,t){const{cmd:s,args:n}=Or(t);if(Rr.has(s)&&Rr.get(s).isEnabled())return()=>Rr.get(s).run(e,n,s)}xr.forEach(e=>{Rr.set(e.command,e),e.aliases.forEach(t=>{Rr.set(t,e)})});const Ir=/(^\/\w*)(?: .*)?/g;const Tr=/\B\+\S*/g;const jr=/\/ddg\s+(.+)$/g;class Nr extends tr{constructor(){super(jr)}static getQueryUri(e){return"https://api.duckduckgo.com/?q="+encodeURIComponent(e)+"&format=json&no_redirect=1&no_html=1&t="+encodeURIComponent("vector")}async getCompletions(e,t,s=!1){const{command:n,range:a}=this.getCurrentCommand(e,t);if(!e||!n)return[];const o=await fetch(Nr.getQueryUri(n[1]),{method:"GET"}),r=await o.json(),l=r.Results.map(e=>({completion:e.Text,component:i.a.createElement(ir,{title:e.Text,description:e.Result}),range:a}));return r.Answer&&l.unshift({completion:r.Answer,component:i.a.createElement(ir,{title:r.Answer,description:r.AnswerType}),range:a}),r.RelatedTopics&&r.RelatedTopics.length>0&&l.unshift({completion:r.RelatedTopics[0].Text,component:i.a.createElement(ir,{title:r.RelatedTopics[0].Text}),range:a}),r.AbstractText&&l.unshift({completion:r.AbstractText,component:i.a.createElement(ir,{title:r.AbstractText}),range:a}),l}getName(){return"🔍 "+Object(l.a)("Results from DuckDuckGo")}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_block",role:"listbox","aria-label":Object(l.a)("DuckDuckGo Results")},e)}}const Pr=/\B#\S*/g;function Dr(e,t,s=""){return{room:e,matchName:s,displayedAlias:t}}const Ar=/\B@\S*/g,Ur=/[^/,:; \t\n]\S*/g;var Mr=s(751),Lr=s.n(Mr);const Fr=new RegExp("("+Lr.a.source+"|(?:^|\\s):[+-\\w]*:?)$","g"),Br=vi.b.sort((e,t)=>e.group===t.group?e.order-t.order:e.group-t.group).map((e,t)=>({emoji:e,shortname:`:${e.shortcodes[0]}:`,_orderBy:t}));function Vr(e,t){const s=t.indexOf(e);return-1===s?1/0:s}const Wr=/@\S*/g;const Hr=[class extends tr{constructor(e){super(Ar,Ur),I()(this,"matcher",void 0),I()(this,"users",void 0),I()(this,"room",void 0),I()(this,"onRoomTimeline",(e,t,s,n,a)=>{t&&(n||t.roomId===this.room.roomId&&a.timeline.getTimelineSet()===t.getUnfilteredTimelineSet()&&!s&&a&&a.liveEvent&&this.onUserSpoke(e.sender))}),I()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.room.roomId&&(this.users=null)}),this.room=e,this.matcher=new ar([],{keys:["name"],funcs:[e=>e.userId.slice(1)],shouldMatchPrefix:!0,shouldMatchWordsOnly:!1}),ee.a.get().on("Room.timeline",this.onRoomTimeline),ee.a.get().on("RoomState.members",this.onRoomStateMember)}destroy(){ee.a.get()&&(ee.a.get().removeListener("Room.timeline",this.onRoomTimeline),ee.a.get().removeListener("RoomState.members",this.onRoomStateMember))}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.MemberAvatar");this.users||this._makeUsers();let a=[];const{command:o,range:r}=this.getCurrentCommand(e,t,s);if(!o)return a;const l=o[0];if(l&&"@"!==l){const e=l.startsWith("@")?l.substring(1):l;a=this.matcher.match(e).map(e=>{const s=e.name||e.userId||"";return{completion:e.rawDisplayName,completionId:e.userId,type:"user",suffix:t.beginning&&0===r.start?": ":" ",href:Object(ur.g)(e.userId),component:i.a.createElement(or,{title:s,description:e.userId},i.a.createElement(n,{member:e,width:24,height:24})),range:r}})}return a}getName(){return Object(l.a)("Users")}_makeUsers(){const e=this.room.getLiveTimeline().getEvents(),t={};for(const s of e)t[s.getSender()]=s.getTs();const s=ee.a.get().credentials.userId;this.users=this.room.getJoinedMembers().filter(({userId:e})=>e!==s),this.users=Object(Pa.sortBy)(this.users,e=>1e20-t[e.userId]||1e20),this.matcher.setObjects(this.users)}onUserSpoke(e){this.users&&e&&e.userId!==ee.a.get().credentials.userId&&(this.users.splice(this.users.findIndex(t=>t.userId===e.userId),1),this.users=[e,...this.users],this.matcher.setObjects(this.users))}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"listbox","aria-label":Object(l.a)("User Autocomplete")},e)}shouldForceComplete(){return!0}},class extends tr{constructor(){super(Pr),I()(this,"matcher",void 0),this.matcher=new ar([],{keys:["displayedAlias","matchName"]})}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.RoomAvatar"),a=ee.a.get();let o=[];const{command:r,range:l}=this.getCurrentCommand(e,t,s);if(r){let e=a.getVisibleRooms().reduce((e,t)=>{if(t.getCanonicalAlias()&&(e=e.concat(Dr(t,t.getCanonicalAlias(),t.name))),t.getAltAliases().length){const s=t.getAltAliases().map(e=>Dr(t,e));e=e.concat(s)}return e},[]);e=e.filter(t=>{const s=t.room.currentState.getStateEvents("m.room.tombstone","");if(s&&s.getContent()&&s.getContent().replacement_room){return!e.some(e=>e.room.roomId===s.getContent().replacement_room)}return!0}),this.matcher.setObjects(e);const t=r[0];o=this.matcher.match(t),o=Object(Pa.sortBy)(o,[e=>function(e,t){const s=t.indexOf(e);return-1===s?1/0:s}(t,e.displayedAlias),e=>e.displayedAlias.length]),o=Object(Pa.uniqBy)(o,e=>e.room),o=o.map(e=>({completion:e.displayedAlias,completionId:e.room.roomId,type:"room",suffix:" ",href:Object(ur.f)(e.displayedAlias),component:i.a.createElement(or,{title:e.room.name,description:e.displayedAlias},i.a.createElement(n,{width:24,height:24,room:e.room})),range:l})).filter(e=>!!e.completion&&e.completion.length>0).slice(0,4)}return o}getName(){return Object(l.a)("Rooms")}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(l.a)("Room Autocomplete")},e)}},class extends tr{constructor(){super(Fr),I()(this,"matcher",void 0),I()(this,"nameMatcher",void 0),this.matcher=new ar(Br,{keys:["emoji.emoticon","shortname"],funcs:[e=>e.emoji.shortcodes.length>1?e.emoji.shortcodes.slice(1).map(e=>`:${e}:`).join(" "):""],shouldMatchWordsOnly:!1}),this.nameMatcher=new ar(Br,{keys:["emoji.annotation"],shouldMatchWordsOnly:!0})}async getCompletions(e,t,s){if(!F.a.getValue("MessageComposerInput.suggestEmoji"))return[];let n=[];const{command:a,range:o}=this.getCurrentCommand(e,t);if(a){const e=a[0];n=this.matcher.match(e),n=n.concat(this.nameMatcher.match(e));const t=[];t.push(t=>Vr(e,t.emoji.emoticon||"")),t.push(t=>Vr(e,t.shortname)),t.push(t=>Math.min(...t.emoji.shortcodes.map(t=>Vr(e.substring(1),t)))),e.length>1&&t.push(e=>e.shortname.length),t.push(e=>e._orderBy),n=Object(Pa.sortBy)(Object(Pa.uniq)(n),t),n=n.map(({shortname:e})=>{const t=Object(rr.i)(e);return{completion:t,component:i.a.createElement(or,{title:e,"aria-label":t},i.a.createElement("span",null,t)),range:o}}).slice(0,20)}return n}getName(){return"😃 "+Object(l.a)("Emoji")}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill",role:"listbox","aria-label":Object(l.a)("Emoji Autocomplete")},e)}},class extends tr{constructor(e){super(Wr),I()(this,"room",void 0),this.room=e}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.RoomAvatar"),a=ee.a.get();if(!this.room.currentState.mayTriggerNotifOfType("room",a.credentials.userId))return[];const{command:o,range:r}=this.getCurrentCommand(e,t,s);return o&&o[0]&&"@room".startsWith(o[0])&&o[0].length>1?[{completion:"@room",completionId:"@room",type:"at-room",suffix:" ",component:i.a.createElement(or,{title:"@room",description:Object(l.a)("Notify the whole room")},i.a.createElement(n,{width:24,height:24,room:this.room})),range:r}]:[]}getName(){return"❗️ "+Object(l.a)("Room Notification")}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(l.a)("Notification Autocomplete")},e)}},class extends tr{constructor(){super(Ir),I()(this,"matcher",void 0),this.matcher=new ar(xr,{keys:["command","args","description"],funcs:[({aliases:e})=>e.join(" ")]})}async getCompletions(e,t,s){const{command:n,range:a}=this.getCurrentCommand(e,t);if(!n)return[];let o=[];if(n[0]!==n[1]){const e=n[1].substr(1);if(Rr.has(e)&&Rr.get(e).isEnabled()){if(Rr.get(e).hideCompletionAfterSpace)return[];o=[Rr.get(e)]}}else o="/"===e?xr:this.matcher.match(n[1]);return o.filter(e=>e.isEnabled()).map(e=>{let t=e.getCommand()+" ";const s=e.aliases.find(e=>"/"+e===n[1]);return(s||e.getCommand()===n[1])&&(t=n[0]),{completion:t,type:"command",component:i.a.createElement(ir,{title:"/"+(s||e.command),subtitle:e.args,description:Object(l.a)(e.description)}),range:a}})}getName(){return"*️⃣ "+Object(l.a)("Commands")}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_block",role:"listbox","aria-label":Object(l.a)("Command Autocomplete")},e)}},class extends tr{constructor(){super(Tr),I()(this,"matcher",void 0),this.matcher=new ar([],{keys:["groupId","name","shortDescription"]})}async getCompletions(e,t,s=!1){const n=d.getComponent("views.avatars.BaseAvatar");if(/^(\/join|\/leave)/.test(e))return[];const a=ee.a.get();let o=[];const{command:r,range:l}=this.getCurrentCommand(e,t,s);if(r){const e=a.getGroups().filter(({myMembership:e})=>"join"===e),t=await Promise.all(e.map(async({groupId:e})=>{try{return ds.a.getGroupProfileCached(a,e)}catch(t){return Promise.resolve({name:"",groupId:e,avatarUrl:"",shortDescription:""})}}));this.matcher.setObjects(t);const s=r[0];o=this.matcher.match(s),o=Object(Pa.sortBy)(o,[e=>function(e,t){const s=t.indexOf(e);return-1===s?1/0:s}(s,e.groupId),e=>e.groupId.length]).map(({avatarUrl:e,groupId:t,name:s})=>({completion:t,suffix:" ",type:"community",href:Object(ur.e)(t),component:i.a.createElement(or,{title:s,description:t},i.a.createElement(n,{name:s||t,width:24,height:24,url:e?a.mxcUrlToHttp(e,24,24):null})),range:l})).slice(0,4)}return o}getName(){return"💬 "+Object(l.a)("Communities")}renderCompletions(e){return i.a.createElement("div",{className:"mx_Autocomplete_Completion_container_pill mx_Autocomplete_Completion_container_truncate",role:"listbox","aria-label":Object(l.a)("Community Autocomplete")},e)}},Nr];class Gr{constructor(e){I()(this,"room",void 0),I()(this,"providers",void 0),this.room=e,this.providers=Hr.map(t=>new t(e))}destroy(){this.providers.forEach(e=>{e.destroy()})}async getCompletions(e,t,s=!1){return(await Promise.all(this.providers.map(n=>Object(Et.e)(n.getCompletions(e,t,s),null,3e3)))).map((n,a)=>{if(n&&n.length)return{completions:n,provider:this.providers[a],command:this.providers[a].getCurrentCommand(e,t,s)}}).filter(Boolean)}}const qr=e=>"mx_Autocomplete_Completion_"+e;class Kr extends i.a.PureComponent{constructor(e){super(e),I()(this,"autocompleter",void 0),I()(this,"queryRequested",void 0),I()(this,"debounceCompletionsRequest",void 0),I()(this,"containerRef",Object(a.createRef)()),I()(this,"hide",()=>{this.setState({hide:!0,selectionOffset:0,completions:[],completionList:[]})}),I()(this,"onCompletionClicked",e=>0!==this.countCompletions()&&0!==e&&(this.props.onConfirm(this.state.completionList[e-1]),this.hide(),!0)),this.autocompleter=new Gr(e.room),this.state={completions:[],completionList:[],selectionOffset:0,shouldShowCompletions:!0,hide:!1,forceComplete:!1}}componentDidMount(){this.applyNewProps()}applyNewProps(e,t){t&&this.props.room.roomId!==t.roomId&&(this.autocompleter.destroy(),this.autocompleter=new Gr(this.props.room)),e!==this.props.query&&this.complete(this.props.query,this.props.selection)}componentWillUnmount(){this.autocompleter.destroy()}complete(e,t){if(this.queryRequested=e,this.debounceCompletionsRequest&&clearTimeout(this.debounceCompletionsRequest),""===e)return this.setState({completions:[],completionList:[],selectionOffset:0,hide:!0}),Promise.resolve(null);let s=F.a.getValue("autocompleteDelay");return(this.state.completions.length>0||this.state.forceComplete)&&(s=0),new Promise(n=>{this.debounceCompletionsRequest=setTimeout(()=>{n(this.processQuery(e,t))},s)})}processQuery(e,t){return this.autocompleter.getCompletions(e,t,this.state.forceComplete).then(t=>{e===this.queryRequested&&this.processCompletions(t)})}processCompletions(e){const t=Object(Pa.flatMap)(e,e=>e.completions);let s=0;if(t.length>0){const e=0===this.state.selectionOffset?null:this.state.completionList[this.state.selectionOffset-1].completion;s=t.findIndex(t=>t.completion===e),-1===s?s=0:s++}let n=this.state.hide;n=!e.some(e=>!!e.command.command),this.setState({completions:e,completionList:t,selectionOffset:s,hide:n,forceComplete:!1})}hasSelection(){return this.countCompletions()>0&&0!==this.state.selectionOffset}countCompletions(){return this.state.completionList.length}moveSelection(e){const t=this.countCompletions();if(0===t)return;const s=(this.state.selectionOffset+e+t+1)%(t+1);this.setSelection(s)}onEscape(e){0!==this.countCompletions()&&(e.preventDefault(),this.hide())}forceComplete(){return new Promise(e=>{this.setState({forceComplete:!0,hide:!1},()=>{this.complete(this.props.query,this.props.selection).then(()=>{e(this.countCompletions())})})})}setSelection(e){this.setState({selectionOffset:e,hide:!1}),this.props.onSelectionChange&&this.props.onSelectionChange(this.state.completionList[e-1],e-1)}componentDidUpdate(e){this.applyNewProps(e.query,e.room);const t=this.refs["completion"+this.state.selectionOffset];t?t.scrollIntoView({behavior:"auto",block:"nearest"}):this.containerRef.current&&this.containerRef.current.scrollTo({top:0})}render(){let e=1;const t=this.state.completions.map((t,s)=>{const n=t.completions.map((t,s)=>{const n=e===this.state.selectionOffset,a=L()("mx_Autocomplete_Completion",{selected:n}),o=e;e++;return i.a.cloneElement(t.component,{key:s,ref:"completion"+o,id:qr(o-1),className:a,onClick:()=>{this.onCompletionClicked(o)},"aria-selected":n})});return n.length>0?i.a.createElement("div",{key:s,className:"mx_Autocomplete_ProviderSection"},i.a.createElement("div",{className:"mx_Autocomplete_provider_name"},t.provider.getName()),t.provider.renderCompletions(n)):null}).filter(e=>!!e);return!this.state.hide&&t.length>0?i.a.createElement("div",{className:"mx_Autocomplete",ref:this.containerRef},t):null}}var zr=s(745);class $r{constructor(){I()(this,"stack",[]),I()(this,"newlyTypedCharCount",0),I()(this,"currentIndex",-1),I()(this,"changedSinceLastPush",!1),I()(this,"lastCaret",null),I()(this,"nonWordBoundarySinceLastPush",!1),I()(this,"addedSinceLastPush",!1),I()(this,"removedSinceLastPush",!1)}clear(){this.stack=[],this.newlyTypedCharCount=0,this.currentIndex=-1,this.changedSinceLastPush=!1,this.lastCaret=null,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}shouldPush(e,t){if(t&&("insertText"===e||"deleteContentForward"===e||"deleteContentBackward"===e)){if(t.added&&(this.addedSinceLastPush=!0),t.removed&&(this.removedSinceLastPush=!0),this.addedSinceLastPush!==this.removedSinceLastPush){const e=t.added?t.added:t.removed,s=" "===e||"\t"===e||"\n"===e;return!(!this.nonWordBoundarySinceLastPush||!s)||(s||(this.nonWordBoundarySinceLastPush=!0),this.newlyTypedCharCount+=e.length,this.newlyTypedCharCount>10)}return!0}return!0}pushState(e,t){for(;this.currentIndex<this.stack.length-1;)this.stack.pop();const s=e.serializeParts();this.stack.push({parts:s,caret:t}),this.currentIndex=this.stack.length-1,this.lastCaret=null,this.changedSinceLastPush=!1,this.newlyTypedCharCount=0,this.nonWordBoundarySinceLastPush=!1,this.addedSinceLastPush=!1,this.removedSinceLastPush=!1}tryPush(e,t,s,n){if("historyUndo"===s||"historyRedo"===s)return!1;const a=this.shouldPush(s,n);return a?this.pushState(e,t):(this.lastCaret=t,this.changedSinceLastPush=!0),a}ensureLastChangesPushed(e){this.changedSinceLastPush&&this.pushState(e,this.lastCaret)}canUndo(){return this.currentIndex>=1||this.changedSinceLastPush}canRedo(){return this.currentIndex<this.stack.length-1}undo(e){if(this.canUndo())return this.ensureLastChangesPushed(e),this.currentIndex-=1,this.stack[this.currentIndex]}redo(){if(this.canRedo())return this.changedSinceLastPush=!1,this.currentIndex+=1,this.stack[this.currentIndex]}}function Yr(e,t){const s=!t||"newline"===t.type;return!e.canEdit&&(s||!t.canEdit)}function Jr(e,t){return!e.canEdit&&t}function Qr(e,t){const s=e.nextSibling;s?e.parentElement.insertBefore(t,s):e.parentElement.appendChild(t)}function Xr(){const e=document.createElement("span");return e.className="caretNode",e.appendChild(document.createTextNode("\ufeff")),e}function Zr(e){"\ufeff"!==e.textContent&&(e.textContent="\ufeff")}function el(e){return e&&"SPAN"===e.tagName&&"caretNode"===e.className}function tl(e){if(e)for(e=e.nextSibling;e;){const t=e;e=e.nextSibling,t.remove()}}function sl(e,t){const s=t.parts.reduce((e,t)=>{if("newline"===t.type)e.push([]);else{e[e.length-1].push(t)}return e},[[]]);s.forEach((t,s)=>{let n=e.childNodes[s];for(;n&&("DIV"!==n.tagName||n.className);)e.removeChild(n),n=e.childNodes[s];n||(n=document.createElement("div"),e.appendChild(n)),t.length?function(e,t){let s,n;const a=t[t.length-1];for(const i of t){for(s=!n?e.firstChild:s.nextSibling,Yr(i,n)&&(el(s)?(Zr(s),s=s.nextSibling):e.insertBefore(Xr(),s));s&&!i.canUpdateDOMNode(s);){const t=s.nextSibling;e.removeChild(s),s=t}if(s&&i?i.updateDOMNode(s):i&&(s=i.toDOMNode(),e.appendChild(s)),Jr(i,i===a))if(el(s.nextSibling))s=s.nextSibling,Zr(s);else{const e=Xr();Qr(s,e),s=e}n=i}tl(s)}(n,t):function(e){let t=!1,s=e.firstChild;for(;s;){const e=s.nextSibling;t||"BR"!==s.tagName?s.remove():t=!0,s=e}t||e.appendChild(document.createElement("br"))}(n)}),s.length?tl(e.children[s.length-1]):function(e){const t=e.firstChild;t&&(tl(t),t.remove())}(e)}const nl=(e,t,s)=>""===s.text[t].trim();class al{constructor(e,t,s=t){this.model=e,I()(this,"_start",void 0),I()(this,"_end",void 0);const n=t.compare(s)<0;this._start=n?t:s,this._end=n?s:t}moveStart(e){this._start=this._start.forwardsWhile(this.model,()=>(e-=1)>=0)}trim(){this._start=this._start.forwardsWhile(this.model,nl),this._end=this._end.backwardsWhile(this.model,nl)}expandBackwardsWhile(e){this._start=this._start.backwardsWhile(this.model,e)}get text(){let e="";return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const a=t.text.substring(s,n);e+=a}),e}replace(e){const t=e.reduce((e,t)=>e+t.text.length,0);let s=0;return this._start.iteratePartsBetween(this._end,this.model,(e,t,n)=>{s+=n-t}),this.model.replaceRange(this._start,this._end,e),t-s}get parts(){const e=[];return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{const a=t.serialize();a.text=t.text.substring(s,n);const i=this.model.partCreator.deserializePart(a);e.push(i)}),e}get length(){let e=0;return this._start.iteratePartsBetween(this._end,this.model,(t,s,n)=>{e+=n-s}),e}get start(){return this._start}get end(){return this._end}}function il(e,t,s){s instanceof al?function(e,t,s){const n=document.getSelection();n.removeAllRanges();const a=document.createRange(),i=ol(e,t,s.start);a.setStart(i.node,i.offset);const o=ol(e,t,s.end);a.setEnd(o.node,o.offset),n.addRange(a)}(e,t,s):function(e,t,s){const n=document.createRange(),{node:a,offset:i}=ol(e,t,s);n.setStart(a,i),n.collapse(!0);const o=document.getSelection();if(1===o.rangeCount){const e=o.getRangeAt(0);if(e.startContainer===n.startContainer&&e.startOffset===n.startOffset&&e.collapsed===n.collapsed)return}o.removeAllRanges(),o.addRange(n)}(e,t,s)}function ol(e,t,s){const{offset:n,lineIndex:a,nodeIndex:i}=function(e,t){const{parts:s}=e,n=t.index,a=function(e,t){let s=0,n=-1,a=null;for(let i=0;i<=t;++i){const o=e[i];if("newline"===o.type)s+=1,n=-1,a=null;else{if(n+=1,Yr(o,a)&&(n+=1),i<t){const t=e[i+1],s=!t||"newline"===t.type;Jr(o,s)&&(n+=1)}a=o}}return{lineIndex:s,nodeIndex:n}}(s,n),{lineIndex:i}=a;let{nodeIndex:o}=a,{offset:r}=t;-1===o?r=0:({nodeIndex:o,offset:r}=function(e,t,s,n){const a=e[t];if(a&&!a.canEdit)if(0===n){s-=1;const i=e[t-1];Yr(a,i)||(n=i.text.length)}else s+=1,n=0;return{nodeIndex:s,offset:n}}(s,n,o,r));return{lineIndex:i,nodeIndex:o,offset:r}}(t,s),o=e.childNodes[a];let r;return-1===i?r=o:(r=o.childNodes[i],r.nodeType===Node.ELEMENT_NODE&&r.firstChild&&(r=r.firstChild)),{node:r,offset:n}}function rl(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,a=e.replace(t),i=e.start.asOffset(s),o=i.add(n+a);return s.startRange(i.asPosition(s),o.asPosition(s))})}function ll(e,t){const{model:s}=e;s.transform(()=>{const n=e.length,a=e.replace(t);return e.start.asOffset(s).add(n+a).asPosition(s)})}function cl(e){const{model:t}=e,s=0!==e.start.offset,n=0===e.start.index,a=!n&&"newline"===t.parts[e.start.index-1].type;return!s&&(n||a)}function dl(e){const{model:t}=e,s=t.parts[e.end.index],n=e.end.offset!==s.text.length,a=e.end.index===t.parts.length-1,i=!a&&"newline"===t.parts[e.end.index+1].type;return!n&&(a||i)}const ml=e=>!e.text||!/\S/.test(e.text),hl=e=>"newline"===e.type;function ul(e,t,s=t){const{model:n,parts:a}=e,{partCreator:i}=n,o=[];let r=0;for(let e=2;e<a.length;e++)ml(a[e-2])&&hl(a[e-1])&&!hl(a[e])&&!ml(a[e])&&(r=e),hl(a[e-1])&&hl(a[e])?(o.push([r,e-1]),r=e+1):hl(a[e-2])&&ml(a[e-1])&&hl(a[e])&&(o.push([r,e-2]),r=e+1);const l=a.map(ml).lastIndexOf(!1);r<=l&&o.push([r,l+1]);let c=0;o.forEach(([e,n])=>{const o=e+c,r=n+c;if(r-o>0&&a[o].text.startsWith(t)&&a[r-1].text.endsWith(s)){const e=a[o].serialize();e.text=e.text.substr(t.length),a[o]=i.deserializePart(e);const n=a[r-1].serialize(),l=n.text;n.text=l.substring(0,l.length-s.length),a[r-1]=i.deserializePart(n)}else a.splice(r,0,i.plain(s)),a.splice(o,0,i.plain(t)),c+=2}),rl(e,a)}class pl{constructor(e,t){this.offset=e,this.atNodeEnd=t}asPosition(e){return e.positionForOffset(this.offset,this.atNodeEnd)}add(e,t=!1){return new pl(this.offset+e,t)}}function gl(e,t,s){let n=e.firstChild;for(;n&&n!==e;){if(t(n)&&n.firstChild)n=n.firstChild;else if(n.nextSibling)n=n.nextSibling;else{for(;!n.nextSibling&&n!==e;)n=n.parentElement,n!==e&&s(n);n!==e&&(n=n.nextSibling)}}}function fl(e,t){const{offset:s,text:n}=bl(e,t.focusNode,t.focusOffset);return{caret:s,text:n}}function bl(e,t,s){const{node:n,characterOffset:a}=function(e,t){for(;e&&e.nodeType===Node.ELEMENT_NODE;){const s=e.childNodes.length;if(!s)break;t>=s?t=(e=e.lastChild).nodeType===Node.TEXT_NODE?e.textContent.length:Number.MAX_SAFE_INTEGER:(e=e.childNodes[t],t=0)}return{node:e,characterOffset:t}}(t,s),{text:i,offsetToNode:o}=function(e,t){let s=0,n=!1,a="";function i(e){n||e===t&&(n=!0),"BR"===e.tagName&&e.nextSibling&&(n||(s+=1),a+="\n");const i=e.nodeType===Node.TEXT_NODE&&function(e){const t=e.nodeValue;return el(e.parentElement)?1!==t.length?t.replace("\ufeff",""):"":t}(e);return i&&(n||(s+=i.length),a+=i),!0}function o(e){"DIV"===e.tagName&&e.nextSibling&&"DIV"===e.nextSibling.tagName&&(a+="\n",n||(s+=1))}return gl(e,i,o),{text:a,offsetToNode:s}}(e,n);return{offset:function(e,t,s){if(!e)return new pl(0,!1);let n=s===e.textContent.length;if(e.nodeType===Node.TEXT_NODE&&el(e.parentElement)){const t=e.nodeValue.indexOf("\ufeff");-1!==t&&t<s&&(s-=1),n=!0}return new pl(t+s,n)}(n,o,a),text:i}}function vl(e,t,s){const n=bl(e,s.focusNode,s.focusOffset).offset,a=bl(e,s.anchorNode,s.anchorOffset).offset,i=n.asPosition(t),o=a.asPosition(t);return t.startRange(i,o)}class _l{constructor(e,t,s,n){this.updateCallback=e,this.getAutocompleterComponent=t,this.updateQuery=s,this.partCreator=n,I()(this,"queryPart",void 0),I()(this,"partIndex",void 0)}onEscape(e){this.getAutocompleterComponent().onEscape(e),this.updateCallback({replaceParts:[this.partCreator.plain(this.queryPart.text)],close:!0})}close(){this.updateCallback({close:!0})}hasSelection(){return this.getAutocompleterComponent().hasSelection()}hasCompletions(){const e=this.getAutocompleterComponent();return e&&e.countCompletions()>0}onEnter(){this.updateCallback({close:!0})}async onTab(e){const t=this.getAutocompleterComponent();0===t.countCompletions()?(await t.forceComplete(),await t.moveSelection(1)):await t.moveSelection(e.shiftKey?-1:1)}onUpArrow(e){this.getAutocompleterComponent().moveSelection(-1)}onDownArrow(e){this.getAutocompleterComponent().moveSelection(1)}onPartUpdate(e,t){return this.queryPart=e,this.partIndex=t.index,this.updateQuery(e.text)}onComponentSelectionChange(e){e?this.updateCallback({replaceParts:this.partForCompletion(e)}):this.updateCallback({replaceParts:[this.queryPart]})}onComponentConfirm(e){this.updateCallback({replaceParts:this.partForCompletion(e),close:!0})}partForCompletion(e){const{completionId:t}=e,s=e.completion;switch(e.type){case"room":return[this.partCreator.roomPill(s,t),this.partCreator.plain(e.suffix)];case"at-room":return[this.partCreator.atRoomPill(t),this.partCreator.plain(e.suffix)];case"user":return this.partCreator.createMentionParts(this.partIndex,s,t);case"command":return[this.partCreator.command(s)];default:return[this.partCreator.plain(s)]}}}var yl;!function(e){e.Plain="plain",e.Newline="newline",e.Command="command",e.UserPill="user-pill",e.RoomPill="room-pill",e.AtRoomPill="at-room-pill",e.PillCandidate="pill-candidate"}(yl||(yl={}));class El{constructor(e=""){I()(this,"_text",void 0),this._text=e}acceptsInsertion(e,t,s){return!0}acceptsRemoval(e,t){return!0}merge(e){return!1}split(e){const t=this.text.substr(e);return this._text=this.text.substr(0,e),new wl(t)}remove(e,t){const s=this.text.substr(0,e)+this.text.substr(e+t);for(let n=e;n<t+e;++n){const e=this.text.charAt(n);if(!this.acceptsRemoval(n,e))return s}this._text=s}appendUntilRejected(e,t){const s=this.text.length;for(let n=0;n<e.length;++n){const a=e.charAt(n);if(!this.acceptsInsertion(a,s+n,t))return this._text=this._text+e.substr(0,n),e.substr(n)}this._text=this._text+e}validateAndInsert(e,t,s){for(let n=0;n<t.length;++n){const a=t.charAt(n);if(!this.acceptsInsertion(a,e+n,s))return!1}const n=this._text.substr(0,e),a=this._text.substr(e);return this._text=n+t+a,!0}createAutoComplete(e){}trim(e){const t=this._text.substr(e);return this._text=this._text.substr(0,e),t}get text(){return this._text}get canEdit(){return!0}toString(){return`${this.type}(${this.text})`}serialize(){return{type:this.type,text:this.text}}}class Cl extends El{acceptsInsertion(e,t,s){return"\n"!==e&&("insertFromPaste"===s||"insertFromDrop"===s||("@"!==e&&"#"!==e&&":"!==e&&"+"!==e||" "!==this._text[t-1]&&("+"!==this._text[t-1]||":"!==e)))}toDOMNode(){return document.createTextNode(this.text)}merge(e){return e.type===this.type&&(this._text=this.text+e.text,!0)}updateDOMNode(e){e.textContent!==this.text&&(e.textContent=this.text)}canUpdateDOMNode(e){return e.nodeType===Node.TEXT_NODE}}class wl extends Cl{get type(){return yl.Plain}}class Sl extends El{constructor(e,t){super(t),this.resourceId=e}acceptsInsertion(e){return" "!==e}acceptsRemoval(e,t){return 0!==e}toDOMNode(){const e=document.createElement("span");return e.setAttribute("spellcheck","false"),e.className=this.className,e.appendChild(document.createTextNode(this.text)),this.setAvatar(e),e}updateDOMNode(e){const t=e.childNodes[0];t.textContent!==this.text&&(t.textContent=this.text),e.className!==this.className&&(e.className=this.className),this.setAvatar(e)}canUpdateDOMNode(e){return e.nodeType===Node.ELEMENT_NODE&&"SPAN"===e.nodeName&&1===e.childNodes.length&&e.childNodes[0].nodeType===Node.TEXT_NODE}_setAvatarVars(e,t,s){const n=`url('${t}')`,a=`'${s}'`;e.style.getPropertyValue("--avatar-background")!==n&&e.style.setProperty("--avatar-background",n),e.style.getPropertyValue("--avatar-letter")!==a&&e.style.setProperty("--avatar-letter",a)}get canEdit(){return!1}}class xl extends El{acceptsInsertion(e,t){return 0===t&&"\n"===e}acceptsRemoval(e,t){return!0}toDOMNode(){return document.createElement("br")}merge(){return!1}updateDOMNode(){}canUpdateDOMNode(e){return"BR"===e.tagName}get type(){return yl.Newline}get canEdit(){return!1}}class Rl extends Sl{constructor(e,t){super(e,e),this.room=t}setAvatar(e){let t="",s=pt.b(this.room,16*window.devicePixelRatio,16*window.devicePixelRatio,"crop");s||(t=pt.e(this.room?this.room.name:this.resourceId),s=pt.d(this.room?this.room.roomId:this.resourceId)),this._setAvatarVars(e,s,t)}get type(){return yl.RoomPill}get className(){return"mx_RoomPill mx_Pill"}}class Ol extends Rl{get type(){return yl.AtRoomPill}}class kl extends Sl{constructor(e,t,s){super(e,t),this.member=s}setAvatar(e){if(!this.member)return;const t=this.member.name||this.member.userId,s=pt.d(this.member.userId),n=pt.a(this.member,16*window.devicePixelRatio,16*window.devicePixelRatio,"crop");let a="";n===s&&(a=pt.e(t)),this._setAvatarVars(e,n,a)}get type(){return yl.UserPill}get className(){return"mx_UserPill mx_Pill"}serialize(){return{type:this.type,text:this.text,resourceId:this.resourceId}}}class Il extends Cl{constructor(e,t){super(e),this.autoCompleteCreator=t}createAutoComplete(e){return this.autoCompleteCreator.create(e)}acceptsInsertion(e,t,s){return 0===t||super.acceptsInsertion(e,t,s)}merge(){return!1}acceptsRemoval(e,t){return!0}get type(){return yl.PillCandidate}}class Tl{constructor(e,t,s=null){this.room=e,this.client=t,I()(this,"autoCompleteCreator",void 0),this.autoCompleteCreator={create:s&&s(this)}}setAutoCompleteCreator(e){this.autoCompleteCreator.create=e(this)}createPartForInput(e,t,s){switch(e[0]){case"#":case"@":case":":case"+":return this.pillCandidate("");case"\n":return new xl;default:return new wl}}createDefaultPart(e){return this.plain(e)}deserializePart(e){switch(e.type){case yl.Plain:return this.plain(e.text);case yl.Newline:return this.newline();case yl.AtRoomPill:return this.atRoomPill(e.text);case yl.PillCandidate:return this.pillCandidate(e.text);case yl.RoomPill:return this.roomPill(e.text);case yl.UserPill:return this.userPill(e.text,e.resourceId)}}plain(e){return new wl(e)}newline(){return new xl("\n")}pillCandidate(e){return new Il(e,this.autoCompleteCreator)}roomPill(e,t){let s,n=e;return s=t||"#"!==n[0]?this.client.getRoom(t||n):this.client.getRooms().find(e=>e.getCanonicalAlias()===n||e.getAltAliases().includes(n)),s&&s.name&&(n=`${s.name} [${E.a.computeDomainFromRoomId(s.roomId)}]`),new Rl(n,s)}atRoomPill(e){return new Ol(e,this.room)}userPill(e,t){const s=this.room.getMember(t);return new kl(t,e,s)}createMentionParts(e,t,s){return[this.userPill(t,s),this.plain(0===e?": ":" ")]}}class jl extends Tl{createPartForInput(e,t){return 0===t&&"/"===e[0]?this.command(""):super.createPartForInput(e,t)}command(e){return new Nl(e,this.autoCompleteCreator)}deserializePart(e){return"command"===e.type?this.command(e.text):super.deserializePart(e)}}class Nl extends Il{get type(){return yl.Command}}function Pl(e,t){const s=[];return e.split("@room").forEach((e,n,a)=>{e.length&&s.push(t.plain(e));n===a.length-1||s.push(t.atRoomPill("@room"))}),s}function Dl(e,t,s,n){switch(e.nodeName){case"H1":case"H2":case"H3":case"H4":case"H5":case"H6":return function(e,t){const s=parseInt(e.nodeName.substr(1),10);return t.plain("#".repeat(s)+" ")}(e,t);case"A":return function(e,t){const{href:s}=e,n=Object(ur.b)(s);switch(n?n[0]:void 0){case"@":return t.userPill(e.textContent,n);case"#":return t.roomPill(n);default:return s===e.textContent?t.plain(e.textContent):t.plain(`[${e.textContent.replace(/[[\\\]]/g,e=>"\\"+e)}](${s})`)}}(e,t);case"BR":return t.newline();case"EM":return t.plain(`_${e.textContent}_`);case"STRONG":return t.plain(`**${e.textContent}**`);case"PRE":return function(e,t){const s=[];let n="";if(e.firstChild&&"CODE"===e.firstChild.nodeName)for(const t of e.firstChild.classList)if(t.startsWith("language-")&&!t.startsWith("language-_")){n=t.substr("language-".length);break}const a=("```"+n+"\n"+e.textContent+"```").split("\n");return a.forEach((e,n)=>{s.push(t.plain(e)),n<a.length-1&&s.push(t.newline())}),s}(e,t);case"CODE":return t.plain(`\`${e.textContent}\``);case"DEL":return t.plain(`<del>${e.textContent}</del>`);case"LI":{const s="  ".repeat(n.listDepth-1);if("OL"===e.parentElement.nodeName){const e=n.listIndex[n.listIndex.length-1];return n.listIndex[n.listIndex.length-1]+=1,t.plain(`${s}${e}. `)}return t.plain(s+"- ")}case"P":if(s)return t.newline();break;case"DIV":case"SPAN":if(e.hasAttribute("data-mx-maths")){const s="SPAN"==e.nodeName?(c.a.get().latex_maths_delims||{}).inline_left||"$":(c.a.get().latex_maths_delims||{}).display_left||"$$",n="SPAN"==e.nodeName?(c.a.get().latex_maths_delims||{}).inline_right||"$":(c.a.get().latex_maths_delims||{}).display_right||"$$",a=e.getAttribute("data-mx-maths");return t.plain(s+a+n)}if(!Al(e))return t.plain(e.textContent);break;case"OL":n.listIndex.push(e.start||1);case"UL":n.listDepth=(n.listDepth||0)+1;default:if(!Al(e))return t.plain(e.textContent)}}function Al(e){switch(e.nodeName){case"PRE":return!1;default:return Object(rr.c)(e)}}function Ul(e){return e.nodeType===Node.TEXT_NODE?"\n"===e.nodeValue:e.nodeType!==Node.ELEMENT_NODE||"MX-REPLY"===e.nodeName}function Ml(e,t,s){const n=e.split(/\r\n|\r|\n/g);return n.reduce((e,a,i)=>{s&&e.push(t.plain("> ")),e.push(...Pl(a,t));return i===n.length-1||e.push(t.newline()),e},[])}function Ll(e,t,{isQuotedMessage:s=!1}={}){const n=e.getContent();let a;return a="org.matrix.custom.html"===n.format?function(e,t,s){const n=(new DOMParser).parseFromString(e,"text/html").body,a=[];let i,o=s;const r={listIndex:[]};return gl(n,(function(e){if(Ul(e))return!1;"BLOCKQUOTE"===e.nodeName&&(o=!0);const s=[];if(i&&(Object(rr.c)(i)||Object(rr.c)(e))&&s.push(t.newline()),e.nodeType===Node.TEXT_NODE)s.push(...Pl(e.nodeValue,t));else if(e.nodeType===Node.ELEMENT_NODE){const n=Dl(e,t,i,r);n&&(Array.isArray(n)?s.push(...n):s.push(n))}if(s.length&&o){!function(e,t,s){e&&t.splice(0,0,s.plain("> "));for(let e=0;e<t.length;e+=1)"newline"===t[e].type&&(t.splice(e+1,0,s.plain("> ")),e+=1)}(0===a.length,s,t)}a.push(...s);const n=Al(e);return i=n?null:e,n}),(function(e){if(!Ul(e)){switch(e.nodeName){case"BLOCKQUOTE":o=!1;break;case"OL":r.listIndex.pop();case"UL":r.listDepth-=1}i=e}})),a}(n.formatted_body||"",t,s):Ml(n.body||"",t,s),"m.emote"===n.msgtype&&a.unshift(t.plain("/me ")),a}var Fl=s(660);class Bl extends i.a.PureComponent{constructor(e){super(e),this.state={visible:!1}}render(){const e=L()("mx_MessageComposerFormatBar",{mx_MessageComposerFormatBar_shown:this.state.visible});return i.a.createElement("div",{className:e,ref:e=>this._formatBarRef=e},i.a.createElement(Vl,{label:Object(l.a)("Bold"),onClick:()=>this.props.onAction("bold"),icon:"Bold",shortcut:this.props.shortcuts.bold,visible:this.state.visible}),i.a.createElement(Vl,{label:Object(l.a)("Italics"),onClick:()=>this.props.onAction("italics"),icon:"Italic",shortcut:this.props.shortcuts.italics,visible:this.state.visible}),i.a.createElement(Vl,{label:Object(l.a)("Strikethrough"),onClick:()=>this.props.onAction("strikethrough"),icon:"Strikethrough",visible:this.state.visible}),i.a.createElement(Vl,{label:Object(l.a)("Code block"),onClick:()=>this.props.onAction("code"),icon:"Code",visible:this.state.visible}),i.a.createElement(Vl,{label:Object(l.a)("Quote"),onClick:()=>this.props.onAction("quote"),icon:"Quote",shortcut:this.props.shortcuts.quote,visible:this.state.visible}))}showAt(e){this.setState({visible:!0});const t=this._formatBarRef.parentElement.getBoundingClientRect();this._formatBarRef.style.left=e.left-t.left+"px",this._formatBarRef.style.top=e.top-t.top-16-12+"px"}hide(){this.setState({visible:!1})}}I()(Bl,"propTypes",{onAction:xe.a.func.isRequired,shortcuts:xe.a.object.isRequired});class Vl extends i.a.PureComponent{render(){const e="mx_MessageComposerFormatBar_button mx_MessageComposerFormatBar_buttonIcon"+this.props.icon;let t;this.props.shortcut&&(t=i.a.createElement("div",{className:"mx_MessageComposerFormatBar_tooltipShortcut"},this.props.shortcut));const s=i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Tooltip_title"},this.props.label),i.a.createElement("div",{className:"mx_Tooltip_sub"},t));return i.a.createElement(B.a,{as:"span",role:"button",onClick:this.props.onClick,title:this.props.label,tooltip:s,className:e})}}I()(Vl,"propTypes",{label:xe.a.string.isRequired,onClick:xe.a.func.isRequired,icon:xe.a.string.isRequired,shortcut:xe.a.string,visible:xe.a.bool});const Wl=new RegExp("(?:^|\\s)("+Lr.a.source+")\\s$"),Hl=-1!==navigator.platform.indexOf("Mac");function Gl(e){return(Hl?"⌘":"Ctrl")+"+"+e}function ql(e){return{anchorNode:e.anchorNode,anchorOffset:e.anchorOffset,focusNode:e.focusNode,focusOffset:e.focusOffset,isCollapsed:e.isCollapsed,rangeCount:e.rangeCount,type:e.type}}var Kl;!function(e){e.Bold="bold",e.Italics="italics",e.Strikethrough="strikethrough",e.Code="code",e.Quote="quote"}(Kl||(Kl={}));class zl extends i.a.Component{constructor(e){super(e),I()(this,"editorRef",Object(a.createRef)()),I()(this,"autocompleteRef",Object(a.createRef)()),I()(this,"formatBarRef",Object(a.createRef)()),I()(this,"modifiedFlag",!1),I()(this,"isIMEComposing",!1),I()(this,"hasTextSelected",!1),I()(this,"_isCaretAtEnd",void 0),I()(this,"lastCaret",void 0),I()(this,"lastSelection",void 0),I()(this,"emoticonSettingHandle",void 0),I()(this,"shouldShowPillAvatarSettingHandle",void 0),I()(this,"historyManager",new $r),I()(this,"replaceEmoticon",e=>{const{model:t}=this.props,s=t.startRange(e);let n=8;s.expandBackwardsWhile((e,s)=>{const a=t.parts[e];return n-=1,n>=0&&("plain"===a.type||"pill-candidate"===a.type)});const a=Wl.exec(s.text);if(a){const e=a[1].replace("-",""),n=vi.c.get(e)||vi.c.get(e.toLowerCase());if(n){const{partCreator:e}=t,i=" "===a[0][0];return s.moveStart(a.index+(i?1:0)),s.replace([e.plain(n.unicode+" ")])}}}),I()(this,"updateEditorState",(e,t,s)=>{if(sl(this.editorRef.current,this.props.model),e){try{il(this.editorRef.current,this.props.model,e)}catch(e){console.error(e)}const t=e instanceof al?e.end:e;this.setLastCaretFromPosition(t)}const{isEmpty:n}=this.props.model;this.props.placeholder&&(n?this.showPlaceholder():this.hidePlaceholder()),n&&this.formatBarRef.current.hide(),this.setState({autoComplete:this.props.model.autoComplete}),this.historyManager.tryPush(this.props.model,e,t,s);let a=!this.props.model.isEmpty;if(a&&"command"===this.props.model.parts[0].type){const{cmd:e}=Or(this.props.model.parts[0].text),t=Rr.get(e);t&&t.isEnabled()&&t.category===Er.messages||(a=!1)}Fl.a.sharedInstance().setSelfTyping(this.props.room.roomId,a),this.props.onChange&&this.props.onChange()}),I()(this,"onCompositionStart",()=>{this.isIMEComposing=!0,this.hidePlaceholder()}),I()(this,"onCompositionEnd",()=>{this.isIMEComposing=!1;const e=navigator.userAgent.toLowerCase();e.includes("safari/")&&!e.includes("chrome/")?this.onInput({inputType:"insertCompositionText"}):Promise.resolve().then(()=>{this.onInput({inputType:"insertCompositionText"})})}),I()(this,"onCutCopy",(e,t)=>{const s=document.getSelection(),n=s.toString();if(n){const{model:a}=this.props,i=vl(this.editorRef.current,a,s),o=i.parts.map(e=>e.serialize());e.clipboardData.setData("application/x-element-composer",JSON.stringify(o)),e.clipboardData.setData("text/plain",n),"cut"===t&&(this.modifiedFlag=!0,ll(i,[])),e.preventDefault()}}),I()(this,"onCopy",e=>{this.onCutCopy(e,"copy")}),I()(this,"onCut",e=>{this.onCutCopy(e,"cut")}),I()(this,"onPaste",e=>{if(e.preventDefault(),this.props.onPaste&&this.props.onPaste(e,this.props.model))return!0;const{model:t}=this.props,{partCreator:s}=t,n=e.clipboardData.getData("application/x-element-composer");let a;if(n){a=JSON.parse(n).map(e=>s.deserializePart(e))}else{a=Ml(e.clipboardData.getData("text/plain"),s)}this.modifiedFlag=!0;ll(vl(this.editorRef.current,t,document.getSelection()),a)}),I()(this,"onInput",e=>{if(this.isIMEComposing)return;this.modifiedFlag=!0;const t=document.getSelection(),{caret:s,text:n}=fl(this.editorRef.current,t);this.props.model.update(n,e.inputType,s)}),I()(this,"onBlur",()=>{document.removeEventListener("selectionchange",this.onSelectionChange)}),I()(this,"onFocus",()=>{document.addEventListener("selectionchange",this.onSelectionChange),this.lastSelection=null,this.refreshLastCaretIfNeeded()}),I()(this,"onSelectionChange",()=>{const{isEmpty:e}=this.props.model;this.refreshLastCaretIfNeeded();const t=document.getSelection();if(this.hasTextSelected&&t.isCollapsed)this.hasTextSelected=!1,this.formatBarRef.current&&this.formatBarRef.current.hide();else if(!t.isCollapsed&&!e&&(this.hasTextSelected=!0,this.formatBarRef.current)){const e=t.getRangeAt(0).getBoundingClientRect();this.formatBarRef.current.showAt(e)}}),I()(this,"onKeyDown",e=>{const t=this.props.model,s=Hl?e.metaKey:e.ctrlKey;let n=!1;if(s&&e.key===_s.a.B)this.onFormatAction(Kl.Bold),n=!0;else if(s&&e.key===_s.a.I)this.onFormatAction(Kl.Italics),n=!0;else if(s&&e.key===_s.a.GREATER_THAN)this.onFormatAction(Kl.Quote),n=!0;else if(!Hl&&s&&e.key===_s.a.Y||Hl&&s&&e.shiftKey&&e.key===_s.a.Z){if(this.historyManager.canRedo()){const{parts:e,caret:s}=this.historyManager.redo();t.reset(e,s,"historyRedo")}n=!0}else if(s&&e.key===_s.a.Z){if(this.historyManager.canUndo()){const{parts:e,caret:s}=this.historyManager.undo(this.props.model);t.reset(e,s,"historyUndo")}n=!0}else if(e.key===_s.a.ENTER&&(e.shiftKey||Hl&&e.altKey))this.insertText("\n"),n=!0;else if(s&&e.key===_s.a.HOME&&!e.shiftKey)il(this.editorRef.current,t,{index:0,offset:0}),n=!0;else if(s&&e.key===_s.a.END&&!e.shiftKey)il(this.editorRef.current,t,{index:t.parts.length-1,offset:t.parts[t.parts.length-1].text.length}),n=!0;else{const s=e.metaKey||e.altKey,a=s||e.shiftKey;if(t.autoComplete&&t.autoComplete.hasCompletions()){const i=t.autoComplete;switch(e.key){case _s.a.ARROW_UP:a||(i.onUpArrow(e),n=!0);break;case _s.a.ARROW_DOWN:a||(i.onDownArrow(e),n=!0);break;case _s.a.TAB:s||(i.onTab(e),n=!0);break;case _s.a.ESCAPE:a||(i.onEscape(e),n=!0);break;default:return}}else e.key===_s.a.TAB?(this.tabCompleteName(e),n=!0):e.key!==_s.a.BACKSPACE&&e.key!==_s.a.DELETE||this.formatBarRef.current.hide()}n&&(e.preventDefault(),e.stopPropagation())}),I()(this,"onAutoCompleteConfirm",e=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentConfirm(e)}),I()(this,"onAutoCompleteSelectionChange",(e,t)=>{this.modifiedFlag=!0,this.props.model.autoComplete.onComponentSelectionChange(e),this.setState({completionIndex:t})}),I()(this,"configureEmoticonAutoReplace",()=>{const e=F.a.getValue("MessageComposerInput.autoReplaceEmoji");this.props.model.setTransformCallback(e?this.replaceEmoticon:null)}),I()(this,"configureShouldShowPillAvatar",()=>{const e=F.a.getValue("Pill.shouldShowPillAvatar");this.setState({showPillAvatar:e})}),I()(this,"onFormatAction",e=>{const t=vl(this.editorRef.current,this.props.model,document.getSelection());if(t.trim(),0!==t.length)switch(this.historyManager.ensureLastChangesPushed(this.props.model),this.modifiedFlag=!0,e){case Kl.Bold:ul(t,"**");break;case Kl.Italics:ul(t,"_");break;case Kl.Strikethrough:ul(t,"<del>","</del>");break;case Kl.Code:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;s.some(e=>"newline"===e.type)?(s.unshift(n.plain("```"),n.newline()),cl(e)||s.unshift(n.newline()),s.push(n.newline(),n.plain("```")),dl(e)||s.push(n.newline())):(s.unshift(n.plain("`")),s.push(n.plain("`"))),rl(e,s)}(t);break;case Kl.Quote:!function(e){const{model:t,parts:s}=e,{partCreator:n}=t;for(let e=0;e<s.length;++e){"newline"===s[e].type&&s.splice(e+1,0,n.plain("> "))}s.unshift(n.plain("> ")),cl(e)||s.unshift(n.newline()),dl(e)||s.push(n.newline()),s.push(n.newline()),rl(e,s)}(t)}}),this.state={showPillAvatar:F.a.getValue("Pill.shouldShowPillAvatar")},this.emoticonSettingHandle=F.a.watchSetting("MessageComposerInput.autoReplaceEmoji",null,this.configureEmoticonAutoReplace),this.configureEmoticonAutoReplace(),this.shouldShowPillAvatarSettingHandle=F.a.watchSetting("Pill.shouldShowPillAvatar",null,this.configureShouldShowPillAvatar)}componentDidUpdate(e){if(this.props.placeholder!==e.placeholder&&this.props.placeholder){const{isEmpty:e}=this.props.model;e?this.showPlaceholder():this.hidePlaceholder()}}showPlaceholder(){const e=this.props.placeholder.replace(/'/g,"\\'");this.editorRef.current.style.setProperty("--placeholder",`'${e}'`),this.editorRef.current.classList.add("mx_BasicMessageComposer_inputEmpty")}hidePlaceholder(){this.editorRef.current.classList.remove("mx_BasicMessageComposer_inputEmpty"),this.editorRef.current.style.removeProperty("--placeholder")}isComposing(e){return!!(this.isIMEComposing||e.nativeEvent&&e.nativeEvent.isComposing)}insertText(e,t="insertText"){const s=document.getSelection(),{caret:n,text:a}=fl(this.editorRef.current,s),i=a.substr(0,n.offset)+e+a.substr(n.offset);n.offset+=e.length,this.modifiedFlag=!0,this.props.model.update(i,t,n)}setLastCaretFromPosition(e){const{model:t}=this.props;this._isCaretAtEnd=e.isAtEnd(t),this.lastCaret=e.asOffset(t),this.lastSelection=ql(document.getSelection())}refreshLastCaretIfNeeded(){if(!this.editorRef.current)return;const e=document.getSelection();if(!this.lastSelection||(t=this.lastSelection,s=e,t.anchorNode!==s.anchorNode||t.anchorOffset!==s.anchorOffset||t.focusNode!==s.focusNode||t.focusOffset!==s.focusOffset||t.isCollapsed!==s.isCollapsed||t.rangeCount!==s.rangeCount||t.type!==s.type)){this.lastSelection=ql(e);const{caret:t,text:s}=fl(this.editorRef.current,e);this.lastCaret=t,this._isCaretAtEnd=t.offset===s.length}var t,s;return this.lastCaret}clearUndoHistory(){this.historyManager.clear()}getCaret(){return this.lastCaret}isSelectionCollapsed(){return!this.lastSelection||this.lastSelection.isCollapsed}isCaretAtStart(){return 0===this.getCaret().offset}isCaretAtEnd(){return this._isCaretAtEnd}async tabCompleteName(e){try{await new Promise(e=>this.setState({showVisualBell:!1},e));const{model:t}=this.props,s=this.getCaret(),n=t.positionForOffset(s.offset,s.atNodeEnd),a=t.startRange(n);a.expandBackwardsWhile((e,t,s)=>" "!==s.text[t]&&"+"!==s.text[t]&&("plain"===s.type||"pill-candidate"===s.type||"command"===s.type));const{partCreator:i}=t;await t.transform(()=>{const e=a.replace([i.pillCandidate(a.text)]);return t.positionForOffset(s.offset+e,!0)}),t.autoComplete&&(await t.autoComplete.onTab(e),t.autoComplete.hasSelection()||(this.setState({showVisualBell:!0}),t.autoComplete.close()))}catch(e){console.error(e)}}isModified(){return this.modifiedFlag}componentWillUnmount(){document.removeEventListener("selectionchange",this.onSelectionChange),this.editorRef.current.removeEventListener("input",this.onInput,!0),this.editorRef.current.removeEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.removeEventListener("compositionend",this.onCompositionEnd,!0),F.a.unwatchSetting(this.emoticonSettingHandle),F.a.unwatchSetting(this.shouldShowPillAvatarSettingHandle)}componentDidMount(){const e=this.props.model;e.setUpdateCallback(this.updateEditorState);var t,s;e.partCreator.setAutoCompleteCreator((t=()=>this.autocompleteRef.current,s=e=>new Promise(t=>this.setState({query:e},t)),e=>n=>new _l(n,t,s,e))),this.updateEditorState(this.getInitialCaretPosition()),this.editorRef.current.addEventListener("input",this.onInput,!0),this.editorRef.current.addEventListener("compositionstart",this.onCompositionStart,!0),this.editorRef.current.addEventListener("compositionend",this.onCompositionEnd,!0),this.editorRef.current.focus()}getInitialCaretPosition(){let e;if(this.props.initialCaret){const t=this.props.initialCaret;e=this.props.model.positionForOffset(t.offset,t.atNodeEnd)}else e=this.props.model.getPositionAtEnd();return e}render(){let e;if(this.state.autoComplete){const t=this.state.query,s=t.length;e=i.a.createElement("div",{className:"mx_BasicMessageComposer_AutoCompleteWrapper"},i.a.createElement(Kr,{ref:this.autocompleteRef,query:t,onConfirm:this.onAutoCompleteConfirm,onSelectionChange:this.onAutoCompleteSelectionChange,selection:{beginning:!0,end:s,start:s},room:this.props.room}))}const t=L()("mx_BasicMessageComposer",{mx_BasicMessageComposer_input_error:this.state.showVisualBell}),s=L()("mx_BasicMessageComposer_input",{mx_BasicMessageComposer_input_shouldShowPillAvatar:this.state.showPillAvatar}),n={bold:Gl("B"),italics:Gl("I"),quote:Gl(">")},{completionIndex:a}=this.state;return i.a.createElement("div",{className:t},e,i.a.createElement(Bl,{ref:this.formatBarRef,onAction:this.onFormatAction,shortcuts:n}),i.a.createElement("div",{className:s,contentEditable:"true",tabIndex:0,onBlur:this.onBlur,onFocus:this.onFocus,onCopy:this.onCopy,onCut:this.onCut,onPaste:this.onPaste,onKeyDown:this.onKeyDown,ref:this.editorRef,"aria-label":this.props.label,role:"textbox","aria-multiline":"true","aria-autocomplete":"both","aria-haspopup":"listbox","aria-expanded":Boolean(this.state.autoComplete),"aria-activedescendant":a>=0?qr(a):void 0,dir:"auto"}))}focus(){this.editorRef.current.focus()}}var $l=s(752),Yl=s(641),Jl=s(133),Ql=s(486);class Xl extends i.a.PureComponent{render(){var e,t;const s=this.props.ev.getContent();if(null===(e=s.channel)||void 0===e||!e.id||null===(t=s.protocol)||void 0===t||!t.id)return console.warn(`Bridge info event ${this.props.ev.getId()} has missing content. Tile will not render`),null;s.bridgebot||(console.warn(`Bridge info event ${this.props.ev.getId()} does not provide a 'bridgebot' key whichis deprecated behaviour. Using sender for now.`),s.bridgebot=this.props.ev.getSender());const{channel:n,network:a,protocol:o}=s,r=o.displayname||o.id,c=n.displayname||n.id;let d=null;s.creator&&(d=i.a.createElement("li",null,Object(l.a)("This bridge was provisioned by <user />.",{},{user:()=>i.a.createElement(Ql.a,{type:Ql.a.TYPE_USER_MENTION,room:this.props.room,url:Object(ur.g)(s.creator),shouldShowPillAvatar:F.a.getValue("Pill.shouldShowPillAvatar")})})));const m=i.a.createElement("li",null,Object(l.a)("This bridge is managed by <user />.",{},{user:()=>i.a.createElement(Ql.a,{type:Ql.a.TYPE_USER_MENTION,room:this.props.room,url:Object(ur.g)(s.bridgebot),shouldShowPillAvatar:F.a.getValue("Pill.shouldShowPillAvatar")})}));let h;if(o.avatar_url){const e=Object(Jl.a)(ee.a.get().getHomeserverUrl(),o.avatar_url,64,64,"crop");h=i.a.createElement(u.a,{className:"protocol-icon",width:48,height:48,resizeMethod:"crop",name:r,idName:r,url:e})}else h=i.a.createElement("div",{className:"noProtocolIcon"});let p=null;if(a){const e=a.displayname||a.id;let t=i.a.createElement("span",null,e);"string"==typeof a.external_url&&Object(rr.d)(a.external_url)&&(t=i.a.createElement("a",{href:a.external_url,target:"_blank",rel:"noreferrer noopener"},e)),p=Object(l.a)("Workspace: <networkLink/>",{},{networkLink:()=>t})}let g=i.a.createElement("span",null,c);"string"==typeof n.external_url&&Object(rr.d)(n.external_url)&&(g=i.a.createElement("a",{href:n.external_url,target:"_blank",rel:"noreferrer noopener"},c));const f=this.props.ev.getId();return i.a.createElement("li",{key:f},i.a.createElement("div",{className:"column-icon"},h),i.a.createElement("div",{className:"column-data"},i.a.createElement("h3",null,r),i.a.createElement("p",{className:"workspace-channel-details"},p,i.a.createElement("span",{className:"channel"},Object(l.a)("Channel: <channelLink/>",{},{channelLink:()=>g}))),i.a.createElement("ul",{className:"metadata"},d," ",m)))}}I()(Xl,"propTypes",{ev:xe.a.object.isRequired,room:xe.a.object.isRequired});const Zl=["uk.half-shot.bridge"];class ec extends i.a.Component{renderBridgeCard(e,t){const s=e.getContent();return s&&s.channel&&s.protocol?i.a.createElement(Xl,{key:e.getId(),room:t,ev:e}):null}static getBridgeStateEvents(e){const t=ee.a.get().getRoom(e).currentState;return Zl.map(e=>{const s=t.events.get(e);return s?Array.from(s.values()):[]}).flat(1)}render(){const e=ec.getBridgeStateEvents(this.props.roomId),t=ee.a.get().getRoom(this.props.roomId);let s;return s=e.length>0?i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("This room is bridging messages to the following platforms. <a>Learn more.</a>",{},{a:e=>i.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),i.a.createElement("ul",{className:"mx_RoomSettingsDialog_BridgeList"},e.map(e=>this.renderBridgeCard(e,t)))):i.a.createElement("p",null,Object(l.a)("This room isn’t bridging messages to any platforms. <a>Learn more.</a>",{},{a:e=>i.a.createElement("a",{href:"https://matrix.org/bridges/",target:"_blank",rel:"noreferrer noopener"},e)})),i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Bridges")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},s))}}var tc=s(753),sc=s(651);function nc(e,t){const s=ee.a.get().getRoom(t),n=s&&s.getMember(e);return n?n.name:e}function ac(e,t){const s=nc(e,t);return s!==e?Object(l.a)("%(name)s (%(userId)s)",{name:s,userId:e}):e}class ic extends i.a.PureComponent{constructor(e){super(e),I()(this,"intervalHandle",void 0),I()(this,"_checkRequestIsPending",()=>{const{request:e}=this.props;e.canAccept||sn.a.sharedInstance().dismissToast(this.props.toastKey)}),I()(this,"cancel",()=>{sn.a.sharedInstance().dismissToast(this.props.toastKey);try{this.props.request.cancel()}catch(e){console.error("Error while cancelling verification request",e)}}),I()(this,"accept",async()=>{sn.a.sharedInstance().dismissToast(this.props.toastKey);const{request:e}=this.props,t=ee.a.get();try{if(e.channel.roomId)m.a.dispatch({action:"view_room",room_id:e.channel.roomId,should_peek:!1}),m.a.dispatch({action:h.a.SetRightPanelPhase,phase:ls.b.EncryptionPanel,refireParams:{verificationRequest:e,member:t.getUser(e.otherUserId)}});else{const t=d.getComponent("views.dialogs.VerificationRequestDialog");De.a.createTrackedDialog("Incoming Verification","",t,{verificationRequest:e},null,!1,!0)}await e.accept()}catch(e){console.error(e.message)}}),this.state={counter:Math.ceil(e.request.timeout/1e3)}}async componentDidMount(){const{request:e}=this.props;if(e.timeout&&e.timeout>0&&(this.intervalHandle=setInterval(()=>{let{counter:e}=this.state;e=Math.max(0,e-1),this.setState({counter:e})},1e3)),e.on("change",this._checkRequestIsPending),this._checkRequestIsPending(),e.isSelfVerification){const t=ee.a.get();this.setState({device:t.getStoredDevice(t.getUserId(),e.channel.deviceId)})}}componentWillUnmount(){clearInterval(this.intervalHandle);const{request:e}=this.props;e.off("change",this._checkRequestIsPending)}render(){const{request:e}=this.props;let t;if(e.isSelfVerification)this.state.device&&(t=Object(l.a)("From %(deviceName)s (%(deviceId)s)",{deviceName:this.state.device.getDisplayName(),deviceId:this.state.device.deviceId}));else{const s=e.otherUserId,n=e.channel.roomId;if(t=n?ac(s,n):s,t===s){const e=ee.a.get().getUser(s);e&&e.displayName&&(t=Object(l.a)("%(name)s (%(userId)s)",{name:e.displayName,userId:s}))}}const s=0===this.state.counter?Object(l.a)("Decline"):Object(l.a)("Decline (%(counter)s)",{counter:this.state.counter});return i.a.createElement(tn.a,{description:t,acceptLabel:Object(l.a)("Accept"),onAccept:this.accept,rejectLabel:s,onReject:this.cancel})}}var oc=s(746),rc=s(687),lc=s(754),cc=s(214);class dc extends i.a.Component{constructor(...e){super(...e),I()(this,"decryptingEvents",new Set),I()(this,"state",{timelineSet:null}),I()(this,"onRoomTimeline",(e,t,s,n,a)=>{var i;(null==t?void 0:t.roomId)===(null===(i=this.props)||void 0===i?void 0:i.roomId)&&!s&&a&&a.liveEvent&&!e.isRedacted()&&(e.isBeingDecrypted()?this.decryptingEvents.add(e.getId()):this.addEncryptedLiveEvent(e))}),I()(this,"onEventDecrypted",(e,t)=>{if(e.getRoomId()!==this.props.roomId)return;const s=e.getId();this.decryptingEvents.delete(s)&&(t||this.addEncryptedLiveEvent(e))}),I()(this,"onPaginationRequest",(e,t,s)=>{const n=ee.a.get(),a=cc.a.get(),i=this.props.roomId,o=n.getRoom(i);return n.isRoomEncrypted(i)&&null!==a?a.paginateTimelineWindow(o,e,t,s):e.paginate(t,s)})}addEncryptedLiveEvent(e,t){if(!this.state.timelineSet)return;const s=this.state.timelineSet.getLiveTimeline();"m.room.message"===e.getType()&&-1!=["m.file","m.image","m.video","m.audio"].indexOf(e.getContent().msgtype)&&(this.state.timelineSet.eventIdToTimeline(e.getId())||this.state.timelineSet.addEventToTimeline(e,s,!1))}async componentDidMount(){const e=ee.a.get();await this.updateTimelineSet(this.props.roomId),ee.a.get().isRoomEncrypted(this.props.roomId)&&null!==cc.a.get()&&(e.on("Room.timeline",this.onRoomTimeline),e.on("Event.decrypted",this.onEventDecrypted))}componentWillUnmount(){const e=ee.a.get();null!==e&&ee.a.get().isRoomEncrypted(this.props.roomId)&&null!==cc.a.get()&&(e.removeListener("Room.timeline",this.onRoomTimeline),e.removeListener("Event.decrypted",this.onEventDecrypted))}async fetchFileEventsServer(e){const t=ee.a.get(),s=new Fe.d(t.credentials.userId);s.setDefinition({room:{timeline:{contains_url:!0,types:["m.room.message"]}}});const n=await t.getOrCreateFilter("FILTER_FILES_"+t.credentials.userId,s);s.filterId=n;return e.getOrCreateFilteredTimelineSet(s)}async updateTimelineSet(e){const t=ee.a.get(),s=t.getRoom(e),n=cc.a.get();if(this.noRoom=!s,s){let a;try{if(a=await this.fetchFileEventsServer(s),t.isRoomEncrypted(e)&&null!==n){const e=a.getLiveTimeline();await n.populateFileTimeline(a,e,s,10)}this.setState({timelineSet:a})}catch(e){console.error("Failed to get or create file panel filter",e)}}else console.error("Failed to add filtered timelineSet for FilePanel as no room!")}render(){if(ee.a.get().isGuest())return i.a.createElement(no.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:ls.b.RoomSummary},i.a.createElement("div",{className:"mx_RoomView_empty"},Object(l.a)("You must <a>register</a> to use this functionality",{},{a:e=>i.a.createElement("a",{href:"#/register",key:"sub"},e)})));if(this.noRoom)return i.a.createElement(no.b,{className:"mx_FilePanel mx_RoomView_messageListWrapper",onClose:this.props.onClose,previousPhase:ls.b.RoomSummary},i.a.createElement("div",{className:"mx_RoomView_empty"},Object(l.a)("You must join the room to see its files")));const e=d.getComponent("structures.TimelinePanel"),t=d.getComponent("elements.Spinner"),s=i.a.createElement("div",{className:"mx_RightPanel_empty mx_FilePanel_empty"},i.a.createElement("h2",null,Object(l.a)("No files visible in this room")),i.a.createElement("p",null,Object(l.a)("Attach files from chat or just drag and drop them anywhere in a room."))),n=!this.noRoom&&ee.a.get().isRoomEncrypted(this.props.roomId);return this.state.timelineSet?i.a.createElement(no.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:ls.b.RoomSummary,withoutScrollContainer:!0},i.a.createElement(ai.b,{isRoomEncrypted:n,kind:ai.a.Files}),i.a.createElement(e,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:this.state.timelineSet,showUrlPreview:!1,onPaginationRequest:this.onPaginationRequest,tileShape:"file_grid",resizeNotifier:this.props.resizeNotifier,empty:s})):i.a.createElement(no.b,{className:"mx_FilePanel",onClose:this.props.onClose,previousPhase:ls.b.RoomSummary},i.a.createElement(t,null))}}I()(dc,"propTypes",{roomId:xe.a.string.isRequired,onClose:xe.a.func.isRequired});var mc=dc;class hc extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_GenericErrorPage"},i.a.createElement("div",{className:"mx_GenericErrorPage_box"},i.a.createElement("h1",null,this.props.title),i.a.createElement("p",null,this.props.message)))}}I()(hc,"propTypes",{title:xe.a.object.isRequired,message:xe.a.object.isRequired});var uc=s(470),pc=s(471),gc=s(355),fc=s(294);const bc=Object(l.b)('<h1>HTML for your community\'s page</h1>\n<p>\n    Use the long description to introduce new members to the community, or distribute\n    some important <a href="foo">links</a>\n</p>\n<p>\n    You can even add images with Matrix URLs <img src="mxc://url" />\n</p>\n'),vc=xe.a.shape({room_id:xe.a.string.isRequired,profile:xe.a.shape({name:xe.a.string,avatar_url:xe.a.string,canonical_alias:xe.a.string}).isRequired}),_c=xe.a.shape({summaryInfo:xe.a.shape({user_id:xe.a.string.isRequired,role_id:xe.a.string,avatar_url:xe.a.string,displayname:xe.a.string}).isRequired});class yc extends i.a.Component{constructor(...e){super(...e),I()(this,"onAddRoomsToSummaryClicked",e=>{e.preventDefault();const t=d.getComponent("dialogs.AddressPickerDialog");De.a.createTrackedDialog("Add Rooms to Group Summary","",t,{title:Object(l.a)("Add rooms to the community summary"),description:Object(l.a)("Which rooms would you like to add to this summary?"),placeholder:Object(l.a)("Room name or address"),button:Object(l.a)("Add to summary"),pickerType:"room",validAddressTypes:["mx-room-id"],groupId:this.props.groupId,onFinished:(e,t)=>{if(!e)return;const s=[];Object(Et.a)(t.map(e=>sa.a.addRoomToGroupSummary(this.props.groupId,e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to add the following room to the group summary","",e,{title:Object(l.a)("Failed to add the following rooms to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=d.getComponent("elements.TintableSvg"),t=this.props.editing?i.a.createElement(pe.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddRoomsToSummaryClicked},i.a.createElement(e,{src:s(755),width:"64",height:"64"}),i.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(l.a)("Add a Room"))):i.a.createElement("div",null),n=this.props.rooms.map(e=>i.a.createElement(Ec,{key:e.room_id,groupId:this.props.groupId,editing:this.props.editing,summaryInfo:e}));let a=i.a.createElement("div",null);return this.props.category&&this.props.category.profile&&(a=i.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.category.profile.name)),i.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},a,n,t)}}I()(yc,"propTypes",{rooms:xe.a.arrayOf(vc).isRequired,category:xe.a.shape({profile:xe.a.shape({name:xe.a.string}).isRequired}),groupId:xe.a.string.isRequired,editing:xe.a.bool.isRequired});class Ec extends i.a.Component{constructor(...e){super(...e),I()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"view_room",room_alias:this.props.summaryInfo.profile.canonical_alias,room_id:this.props.summaryInfo.room_id})}),I()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),sa.a.removeRoomFromGroupSummary(this.props.groupId,this.props.summaryInfo.room_id).catch(e=>{console.error("Error whilst removing room from group summary",e);const t=this.props.summaryInfo.name||this.props.summaryInfo.canonical_alias||this.props.summaryInfo.room_id,s=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to remove room from group summary","",s,{title:Object(l.a)("Failed to remove the room from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(l.a)("The room '%(roomName)s' could not be removed from the summary.",{roomName:t})})})})}render(){const e=d.getComponent("avatars.RoomAvatar"),t=this.props.summaryInfo.profile.name||this.props.summaryInfo.profile.canonical_alias||Object(l.a)("Unnamed Room"),n={roomId:this.props.summaryInfo.room_id,avatarUrl:this.props.summaryInfo.profile.avatar_url,name:t};let a=null;this.props.summaryInfo.profile&&this.props.summaryInfo.profile.canonical_alias&&(a=Object(ur.e)(this.props.summaryInfo.profile.canonical_alias));let o=null;o=a?i.a.createElement("a",{href:a,onClick:this.onClick},t):i.a.createElement("span",null,t);const r=this.props.editing?i.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(756),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):i.a.createElement("div",null);return i.a.createElement(pe.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},i.a.createElement(e,{oobData:n,width:64,height:64}),i.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},o),r)}}I()(Ec,"propTypes",{summaryInfo:vc.isRequired,editing:xe.a.bool.isRequired,groupId:xe.a.string.isRequired});class Cc extends i.a.Component{constructor(...e){super(...e),I()(this,"onAddUsersClicked",e=>{e.preventDefault();const t=d.getComponent("dialogs.AddressPickerDialog");De.a.createTrackedDialog("Add Users to Group Summary","",t,{title:Object(l.a)("Add users to the community summary"),description:Object(l.a)("Who would you like to add to this summary?"),placeholder:Object(l.a)("Name or Matrix ID"),button:Object(l.a)("Add to summary"),validAddressTypes:["mx-user-id"],groupId:this.props.groupId,shouldOmitSelf:!1,onFinished:(e,t)=>{if(!e)return;const s=[];Object(Et.a)(t.map(e=>sa.a.addUserToGroupSummary(e.address).catch(()=>{s.push(e.address)}))).then(()=>{if(0===s.length)return;const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to add the following users to the community summary","",e,{title:Object(l.a)("Failed to add the following users to the summary of %(groupId)s:",{groupId:this.props.groupId}),description:s.join(", ")})})}},null,!1,!0)})}render(){const e=d.getComponent("elements.TintableSvg"),t=this.props.editing?i.a.createElement(pe.a,{className:"mx_GroupView_featuredThings_addButton",onClick:this.onAddUsersClicked},i.a.createElement(e,{src:s(755),width:"64",height:"64"}),i.a.createElement("div",{className:"mx_GroupView_featuredThings_addButton_label"},Object(l.a)("Add a User"))):i.a.createElement("div",null),n=this.props.users.map(e=>i.a.createElement(wc,{key:e.user_id,summaryInfo:e,editing:this.props.editing,groupId:this.props.groupId}));let a=i.a.createElement("div",null);return this.props.role&&this.props.role.profile&&(a=i.a.createElement("div",{className:"mx_GroupView_featuredThings_category"},this.props.role.profile.name)),i.a.createElement("div",{className:"mx_GroupView_featuredThings_container"},a,n,t)}}I()(Cc,"propTypes",{users:xe.a.arrayOf(_c).isRequired,role:xe.a.shape({profile:xe.a.shape({name:xe.a.string}).isRequired}),groupId:xe.a.string.isRequired,editing:xe.a.bool.isRequired});class wc extends i.a.Component{constructor(...e){super(...e),I()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"view_start_chat_or_reuse",user_id:this.props.summaryInfo.user_id})}),I()(this,"onDeleteClicked",e=>{e.preventDefault(),e.stopPropagation(),sa.a.removeUserFromGroupSummary(this.props.groupId,this.props.summaryInfo.user_id).catch(e=>{console.error("Error whilst removing user from group summary",e);const t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,s=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to remove user from community summary","",s,{title:Object(l.a)("Failed to remove a user from the summary of %(groupId)s",{groupId:this.props.groupId}),description:Object(l.a)("The user '%(displayName)s' could not be removed from the summary.",{displayName:t})})})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.props.summaryInfo.displayname||this.props.summaryInfo.user_id,n=Object(ur.g)(this.props.summaryInfo.user_id),a=i.a.createElement("a",{href:n,onClick:this.onClick},t),o=ee.a.get().mxcUrlToHttp(this.props.summaryInfo.avatar_url,64,64),r=this.props.editing?i.a.createElement("img",{className:"mx_GroupView_featuredThing_deleteButton",src:s(756),width:"14",height:"14",alt:"Delete",onClick:this.onDeleteClicked}):i.a.createElement("div",null);return i.a.createElement(pe.a,{className:"mx_GroupView_featuredThing",onClick:this.onClick},i.a.createElement(e,{name:t,url:o,width:64,height:64}),i.a.createElement("div",{className:"mx_GroupView_featuredThing_name"},a),r)}}I()(wc,"propTypes",{summaryInfo:_c.isRequired,editing:xe.a.bool.isRequired,groupId:xe.a.string.isRequired});class Sc extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{summary:null,isGroupPublicised:null,isUserPrivileged:null,groupRooms:null,groupRoomsLoading:null,error:null,editing:!1,saving:!1,uploadingAvatar:!1,avatarChanged:!1,membershipBusy:!1,publicityBusy:!1,inviterProfile:null,showRightPanel:fc.a.getSharedInstance().isOpenForGroup}),I()(this,"_onRightPanelStoreUpdate",()=>{this.setState({showRightPanel:fc.a.getSharedInstance().isOpenForGroup})}),I()(this,"_onGroupMyMembership",e=>{this._unmounted||e.groupId!==this.props.groupId||("leave"===e.myMembership&&this._closeSettings(),this.setState({membershipBusy:!1}))}),I()(this,"onGroupStoreUpdated",e=>{if(this._unmounted)return;const t=sa.a.getSummary(this.props.groupId);t.profile&&["avatar_url","long_description","name","short_description"].forEach(e=>{t.profile[e]=t.profile[e]||""}),this.setState({summary:t,summaryLoading:!sa.a.isStateReady(this.props.groupId,sa.a.STATE_KEY.Summary),isGroupPublicised:sa.a.getGroupPublicity(this.props.groupId),isUserPrivileged:sa.a.isUserPrivileged(this.props.groupId),groupRooms:sa.a.getGroupRooms(this.props.groupId),groupRoomsLoading:!sa.a.isStateReady(this.props.groupId,sa.a.STATE_KEY.GroupRooms),isUserMember:sa.a.getGroupMembers(this.props.groupId).some(e=>e.userId===this._matrixClient.credentials.userId)}),this.props.groupIsNew&&e&&this._onEditClick()}),I()(this,"_onEditClick",()=>{this.setState({editing:!0,profileForm:Object.assign({},this.state.summary.profile),joinableForm:{policyType:this.state.summary.profile.is_openly_joinable?"open":"invite"}})}),I()(this,"_onShareClick",()=>{const e=d.getComponent("dialogs.ShareDialog");De.a.createTrackedDialog("share community dialog","",e,{target:this._matrixClient.getGroup(this.props.groupId)||new Fe.e(this.props.groupId)})}),I()(this,"_onCancelClick",()=>{this._closeSettings()}),I()(this,"_onAction",e=>{switch(e.action){case"close_settings":this.setState({editing:!1,profileForm:null})}}),I()(this,"_closeSettings",()=>{m.a.dispatch({action:"close_settings"})}),I()(this,"_onNameChange",e=>{const t=Object.assign(this.state.profileForm,{name:e});this.setState({profileForm:t})}),I()(this,"_onShortDescChange",e=>{const t=Object.assign(this.state.profileForm,{short_description:e});this.setState({profileForm:t})}),I()(this,"_onLongDescChange",e=>{const t=Object.assign(this.state.profileForm,{long_description:e.target.value});this.setState({profileForm:t})}),I()(this,"_onAvatarSelected",e=>{const t=e.target.files[0];t&&(this.setState({uploadingAvatar:!0}),this._matrixClient.uploadContent(t).then(e=>{const t=Object.assign(this.state.profileForm,{avatar_url:e});this.setState({uploadingAvatar:!1,profileForm:t,avatarChanged:!0})}).catch(e=>{this.setState({uploadingAvatar:!1});const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to upload avatar image",e),De.a.createTrackedDialog("Failed to upload image","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Failed to upload image")})}))}),I()(this,"_onJoinableChange",e=>{this.setState({joinableForm:{policyType:e.target.value}})}),I()(this,"_onSaveClick",()=>{this.setState({saving:!0});(this.state.isUserPrivileged?this._saveGroup():Promise.resolve()).then(e=>{this.setState({saving:!1,editing:!1,summary:null}),this._initGroupStore(this.props.groupId),this.state.avatarChanged&&ds.a.refreshGroupProfile(this._matrixClient,this.props.groupId)}).catch(e=>{this.setState({saving:!1});const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to save community profile",e),De.a.createTrackedDialog("Failed to update group","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Failed to update community")})}).finally(()=>{this.setState({avatarChanged:!1})})}),I()(this,"_onAcceptInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(Et.d)(500),sa.a.acceptGroupInvite(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Error accepting invite","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Unable to accept invite")})})}),I()(this,"_onRejectInviteClick",async()=>{this.setState({membershipBusy:!0}),await Object(Et.d)(500),sa.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Unable to reject invite")})})}),I()(this,"_onJoinClick",async()=>{this._matrixClient.isGuest()?m.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+this.props.groupId}}):(this.setState({membershipBusy:!0}),await Object(Et.d)(500),sa.a.joinGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Error joining room","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Unable to join community")})}))}),I()(this,"_onLeaveClick",()=>{const e=d.getComponent("dialogs.QuestionDialog"),t=this._leaveGroupWarnings();De.a.createTrackedDialog("Leave Group","",e,{title:Object(l.a)("Leave Community"),description:i.a.createElement("span",null,Object(l.a)("Leave %(groupName)s?",{groupName:this.props.groupId}),t),button:Object(l.a)("Leave"),danger:this.state.isUserPrivileged,onFinished:async e=>{e&&(this.setState({membershipBusy:!0}),await Object(Et.d)(500),sa.a.leaveGroup(this.props.groupId).then(()=>{}).catch(e=>{this.setState({membershipBusy:!1});const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Error leaving community","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Unable to leave community")})}))}})}),I()(this,"_onAddRoomsClick",()=>{Object(gc.a)(this.props.groupId)})}componentDidMount(){this._unmounted=!1,this._matrixClient=ee.a.get(),this._matrixClient.on("Group.myMembership",this._onGroupMyMembership),this._initGroupStore(this.props.groupId,!0),this._dispatcherRef=m.a.register(this._onAction),this._rightPanelStoreToken=fc.a.getSharedInstance().addListener(this._onRightPanelStoreUpdate)}componentWillUnmount(){this._unmounted=!0,this._matrixClient.removeListener("Group.myMembership",this._onGroupMyMembership),m.a.unregister(this._dispatcherRef),this._rightPanelStoreToken&&this._rightPanelStoreToken.remove()}UNSAFE_componentWillReceiveProps(e){this.props.groupId!==e.groupId&&this.setState({summary:null,error:null},()=>{this._initGroupStore(e.groupId)})}_initGroupStore(e,t){const s=this._matrixClient.getGroup(e);s&&s.inviter&&s.inviter.userId&&this._fetchInviterProfile(s.inviter.userId),sa.a.registerListener(e,this.onGroupStoreUpdated.bind(this,t));let n=!1;sa.a.on("error",(t,s,a)=>{this._unmounted||e!==s||("M_GUEST_ACCESS_FORBIDDEN"!==t.errcode||n||(m.a.dispatch({action:"do_after_sync_prepared",deferred_action:{action:"view_group",group_id:e}}),m.a.dispatch({action:"require_registration",screen_after:{screen:"group/"+e}}),n=!0),a===sa.a.STATE_KEY.Summary&&this.setState({summary:null,error:t,editing:!1}))})}_fetchInviterProfile(e){this.setState({inviterProfileBusy:!0}),this._matrixClient.getProfileInfo(e).then(e=>{this._unmounted||this.setState({inviterProfile:{avatarUrl:e.avatar_url,displayName:e.displayname}})}).catch(e=>{console.error("Error getting group inviter profile",e)}).finally(()=>{this._unmounted||this.setState({inviterProfileBusy:!1})})}async _saveGroup(){await this._matrixClient.setGroupProfile(this.props.groupId,this.state.profileForm),await this._matrixClient.setGroupJoinPolicy(this.props.groupId,{type:this.state.joinableForm.policyType})}_leaveGroupWarnings(){const e=[];return this.state.isUserPrivileged&&e.push(i.a.createElement("span",{className:"warning"}," ",Object(l.a)("You are an administrator of this community. You will not be able to rejoin without an invite from another administrator."))),e}_getGroupSection(){const e=L()({mx_GroupView_group:this.state.editing,mx_GroupView_group_disabled:this.state.editing&&!this.state.isUserPrivileged}),t=this.state.editing?i.a.createElement("h2",null," ",Object(l.a)("Community Settings")," "):i.a.createElement("div",null),n=Pe("community-settings");let a=null;n&&this.state.isUserPrivileged&&(a=i.a.createElement("div",{className:"mx_GroupView_hostingSignup"},Object(l.a)("Want more than a community? <a>Get your own server</a>",{},{a:e=>i.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},e)}),i.a.createElement("a",{href:n,target:"_blank",rel:"noreferrer noopener"},i.a.createElement("img",{src:s(657),width:"11",height:"10",alt:""}))));const o=this.state.editing&&this.state.isUserPrivileged?i.a.createElement("div",{className:"mx_GroupView_changeDelayWarning"},Object(l.a)("Changes made to your community <bold1>name</bold1> and <bold2>avatar</bold2> might not be seen by other users for up to 30 minutes.",{},{bold1:e=>i.a.createElement("b",null," ",e," "),bold2:e=>i.a.createElement("b",null," ",e," ")})):i.a.createElement("div",null);return i.a.createElement("div",{className:e},t,a,o,this._getJoinableNode(),this._getLongDescriptionNode(),this._getRoomsNode())}_getRoomsNode(){const e=d.getComponent("rooms.RoomDetailList"),t=d.getComponent("elements.AccessibleButton"),n=d.getComponent("elements.TintableSvg"),a=d.getComponent("elements.Spinner"),o=d.getComponent("elements.TooltipButton"),r=this.state.editing?i.a.createElement(o,{helpText:Object(l.a)("These rooms are displayed to community members on the community page. Community members can join the rooms by clicking on them.")}):i.a.createElement("div",null),c=this.state.editing?i.a.createElement(t,{className:"mx_GroupView_rooms_header_addRow",onClick:this._onAddRoomsClick},i.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_button"},i.a.createElement(n,{src:s(1270),width:"24",height:"24"})),i.a.createElement("div",{className:"mx_GroupView_rooms_header_addRow_label"},Object(l.a)("Add rooms to this community"))):i.a.createElement("div",null);return i.a.createElement("div",{className:"mx_GroupView_rooms"},i.a.createElement("div",{className:"mx_GroupView_rooms_header"},i.a.createElement("h3",null,Object(l.a)("Rooms"),r),c),this.state.groupRoomsLoading?i.a.createElement(a,null):i.a.createElement(e,{rooms:this.state.groupRooms}))}_getFeaturedRoomsNode(){const e=this.state.summary,t=[],s={};e.rooms_section.rooms.forEach(e=>{if(null===e.category_id)t.push(e);else{let t=s[e.category_id];void 0===t&&(t=[],s[e.category_id]=t),t.push(e)}});const n=i.a.createElement(yc,{rooms:t,groupId:this.props.groupId,editing:this.state.editing}),a=Object.keys(s).map(t=>{const n=e.rooms_section.categories[t];return i.a.createElement(yc,{key:t,rooms:s[t],category:n,groupId:this.props.groupId,editing:this.state.editing})});return i.a.createElement("div",{className:"mx_GroupView_featuredThings"},i.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(l.a)("Featured Rooms:")),n,a)}_getFeaturedUsersNode(){const e=this.state.summary,t=[],s={};e.users_section.users.forEach(e=>{if(null===e.role_id)t.push(e);else{let t=s[e.role_id];void 0===t&&(t=[],s[e.role_id]=t),t.push(e)}});const n=i.a.createElement(Cc,{users:t,groupId:this.props.groupId,editing:this.state.editing}),a=Object.keys(s).map(t=>{const n=e.users_section.roles[t];return i.a.createElement(Cc,{key:t,users:s[t],role:n,groupId:this.props.groupId,editing:this.state.editing})});return i.a.createElement("div",{className:"mx_GroupView_featuredThings"},i.a.createElement("div",{className:"mx_GroupView_featuredThings_header"},Object(l.a)("Featured Users:")),n,a)}_getMembershipSection(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("avatars.BaseAvatar"),s=this._matrixClient.getGroup(this.props.groupId);if(s&&"invite"===s.myMembership){if(this.state.membershipBusy||this.state.inviterProfileBusy)return i.a.createElement("div",{className:"mx_GroupView_membershipSection"},i.a.createElement(e,null));const n=this.state.inviterProfile?this._matrixClient.mxcUrlToHttp(this.state.inviterProfile.avatarUrl,36,36):null,a=s.inviter||{};let o=a.userId;return this.state.inviterProfile&&(o=this.state.inviterProfile.displayName||a.userId),i.a.createElement("div",{className:"mx_GroupView_membershipSection mx_GroupView_membershipSection_invited"},i.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},i.a.createElement("div",{className:"mx_GroupView_membershipSection_description"},i.a.createElement(t,{url:n,name:o,width:36,height:36}),Object(l.a)("%(inviter)s has invited you to join this community",{inviter:o||Object(l.a)("Someone")})),i.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},i.a.createElement(pe.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onAcceptInviteClick},Object(l.a)("Accept")),i.a.createElement(pe.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",onClick:this._onRejectInviteClick},Object(l.a)("Decline")))))}let n,a,o,r,c;if((!s||"leave"===s.myMembership)&&this.state.summary&&this.state.summary.profile&&Boolean(this.state.summary.profile.is_openly_joinable))r=Object(l.a)("Join this community"),c=this._onJoinClick,a="mx_GroupView_joinButton",n="mx_GroupView_membershipSection_leave";else{if(!s||"join"!==s.myMembership||!this.state.editing)return null;r=Object(l.a)("Leave this community"),c=this._onLeaveClick,o=this.state.isUserPrivileged?Object(l.a)("You are an administrator of this community"):Object(l.a)("You are a member of this community"),a={mx_GroupView_leaveButton:!0,mx_RoomHeader_textButton_danger:this.state.isUserPrivileged},n="mx_GroupView_membershipSection_joined"}const m=L()(["mx_RoomHeader_textButton","mx_GroupView_textButton"],a),h=L()("mx_GroupView_membershipSection",n);return i.a.createElement("div",{className:h},i.a.createElement("div",{className:"mx_GroupView_membershipSubSection"},this.state.membershipBusy?i.a.createElement(e,null):i.a.createElement("div",null),i.a.createElement("div",{className:"mx_GroupView_membership_buttonContainer"},i.a.createElement(pe.a,{className:m,onClick:c,title:o},r))))}_getJoinableNode(){const e=d.getComponent("elements.InlineSpinner");return this.state.editing?i.a.createElement("div",null,i.a.createElement("h3",null,Object(l.a)("Who can join this community?"),this.state.groupJoinableLoading?i.a.createElement(e,null):i.a.createElement("div",null)),i.a.createElement("div",null,i.a.createElement("label",null,i.a.createElement("input",{type:"radio",value:"invite",checked:"invite"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),i.a.createElement("div",{className:"mx_GroupView_label_text"},Object(l.a)("Only people who have been invited")))),i.a.createElement("div",null,i.a.createElement("label",null,i.a.createElement("input",{type:"radio",value:"open",checked:"open"===this.state.joinableForm.policyType,onChange:this._onJoinableChange}),i.a.createElement("div",{className:"mx_GroupView_label_text"},Object(l.a)("Everyone"))))):null}_getLongDescriptionNode(){const e=this.state.summary;let t=null;e.profile&&e.profile.long_description?t=Object(rr.g)(e.profile.long_description):this.state.isUserPrivileged&&(t=i.a.createElement("div",{className:"mx_GroupView_groupDesc_placeholder",onClick:this._onEditClick},Object(l.a)("Your community hasn't got a Long Description, a HTML page to show to community members.<br />Click here to open settings and give it one!",{},{br:i.a.createElement("br",null)})));const s=L()({mx_GroupView_groupDesc:!0,mx_GroupView_groupDesc_disabled:!this.state.isUserPrivileged});return this.state.editing?i.a.createElement("div",{className:s},i.a.createElement("h3",null," ",Object(l.a)("Long Description (HTML)")," "),i.a.createElement("textarea",{value:this.state.profileForm.long_description,placeholder:Object(l.a)(bc),onChange:this._onLongDescChange,tabIndex:"4",key:"editLongDesc"})):i.a.createElement("div",{className:"mx_GroupView_groupDesc"},t)}render(){const e=d.getComponent("avatars.GroupAvatar"),t=d.getComponent("elements.Spinner");if(this.state.summaryLoading&&null===this.state.error||this.state.saving)return i.a.createElement(t,null);if(this.state.summary&&!this.state.error){const n=this.state.summary;let a,r,c;const m=[];if(this.state.editing&&this.state.isUserPrivileged){let e;if(this.state.uploadingAvatar)e=i.a.createElement(t,null);else{const t=d.getComponent("avatars.GroupAvatar");e=i.a.createElement(t,{groupId:this.props.groupId,groupName:this.state.profileForm.name,groupAvatarUrl:this.state.profileForm.avatar_url,width:28,height:28,resizeMethod:"crop"})}a=i.a.createElement("div",{className:"mx_GroupView_avatarPicker"},i.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},e),i.a.createElement("div",{className:"mx_GroupView_avatarPicker_edit"},i.a.createElement("label",{htmlFor:"avatarInput",className:"mx_GroupView_avatarPicker_label"},i.a.createElement("img",{src:s(1271),alt:Object(l.a)("Upload avatar"),title:Object(l.a)("Upload avatar"),width:"17",height:"15"})),i.a.createElement("input",{id:"avatarInput",className:"mx_GroupView_uploadInput",type:"file",onChange:this._onAvatarSelected})));const n=d.getComponent("elements.EditableText");r=i.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(l.a)("Community Name"),blurToCancel:!1,initialValue:this.state.profileForm.name,onValueChanged:this._onNameChange,tabIndex:"0",dir:"auto"}),c=i.a.createElement(n,{className:"mx_GroupView_editable",placeholderClassName:"mx_GroupView_placeholder",placeholder:Object(l.a)("Description"),blurToCancel:!1,initialValue:this.state.profileForm.short_description,onValueChanged:this._onShortDescChange,tabIndex:"0",dir:"auto"})}else{const t=this.state.isUserMember?this._onEditClick:null,s=n.profile?n.profile.avatar_url:null,o=n.profile?n.profile.name:null;a=i.a.createElement(e,{groupId:this.props.groupId,groupAvatarUrl:s,groupName:o,onClick:t,width:28,height:28}),r=n.profile&&n.profile.name?i.a.createElement("div",{onClick:t},i.a.createElement("span",null,n.profile.name),i.a.createElement("span",{className:"mx_GroupView_header_groupid"},"(",this.props.groupId,")")):i.a.createElement("span",{onClick:t},this.props.groupId),n.profile&&n.profile.short_description&&(c=i.a.createElement("span",{onClick:t},n.profile.short_description))}this.state.editing?(m.push(i.a.createElement(pe.a,{className:"mx_GroupView_textButton mx_RoomHeader_textButton",key:"_saveButton",onClick:this._onSaveClick},Object(l.a)("Save"))),m.push(i.a.createElement(pe.a,{className:"mx_RoomHeader_cancelButton",key:"_cancelButton",onClick:this._onCancelClick},i.a.createElement("img",{src:s(222),className:"mx_filterFlipColor",width:"18",height:"18",alt:Object(l.a)("Cancel")})))):(n.user&&"join"===n.user.membership&&m.push(i.a.createElement(pe.a,{className:"mx_GroupHeader_button mx_GroupHeader_editButton",key:"_editButton",onClick:this._onEditClick,title:Object(l.a)("Community Settings")})),m.push(i.a.createElement(pe.a,{className:"mx_GroupHeader_button mx_GroupHeader_shareButton",key:"_shareButton",onClick:this._onShareClick,title:Object(l.a)("Share Community")})));const h=this.state.showRightPanel?i.a.createElement(pc.a,{groupId:this.props.groupId}):void 0,u={mx_GroupView_header:!0,"light-panel":!0,mx_GroupView_header_view:!this.state.editing,mx_GroupView_header_isUserMember:this.state.isUserMember};return i.a.createElement("main",{className:"mx_GroupView"},i.a.createElement("div",{className:L()(u)},i.a.createElement("div",{className:"mx_GroupView_header_leftCol"},i.a.createElement("div",{className:"mx_GroupView_header_avatar"},a),i.a.createElement("div",{className:"mx_GroupView_header_info"},i.a.createElement("div",{className:"mx_GroupView_header_name"},r),i.a.createElement("div",{className:"mx_GroupView_header_shortDesc"},c))),i.a.createElement("div",{className:"mx_GroupView_header_rightCol"},m),i.a.createElement(wo,null)),i.a.createElement(uc.a,{panel:h,resizeNotifier:this.props.resizeNotifier},i.a.createElement(o.a,{className:"mx_GroupView_body"},this._getMembershipSection(),this._getGroupSection())))}if(this.state.error){if(404===this.state.error.httpStatus)return i.a.createElement("div",{className:"mx_GroupView_error"},Object(l.a)("Community %(groupId)s not found",{groupId:this.props.groupId}));{let e;return"M_UNRECOGNIZED"===this.state.error.errcode&&(e=i.a.createElement("div",null,Object(l.a)("This homeserver does not support communities"))),i.a.createElement("div",{className:"mx_GroupView_error"},Object(l.a)("Failed to load %(groupId)s",{groupId:this.props.groupId}),e)}}return console.error("Invalid state for GroupView"),i.a.createElement("div",null)}}I()(Sc,"propTypes",{groupId:xe.a.string.isRequired,groupIsNew:xe.a.bool});var xc=s(139),Rc=s.n(xc),Oc=s(269),kc=s(130),Ic=s(334);const Tc=["m.sticker","m.room.message"];const jc=e=>"m.room.member"===e.getType()||"m.room.third_party_invite"===e.getType();class Nc extends i.a.Component{constructor(e){super(e),I()(this,"onAction",e=>{switch(e.action){case"scroll_to_bottom":this.scrollToBottom()}}),I()(this,"onShowTypingNotificationsChange",()=>{this.setState({showTypingNotifications:F.a.getValue("showTypingNotifications")})}),I()(this,"_isUnmounting",()=>!this._isMounted),I()(this,"_collectGhostReadMarker",e=>{e&&requestAnimationFrame(()=>{e.style.width="10%",e.style.opacity="0"})}),I()(this,"_onGhostTransitionEnd",e=>{const t=e.target.dataset.eventid;this.setState({ghostReadMarkers:this.state.ghostReadMarkers.filter(e=>e!==t)})}),I()(this,"_collectEventNode",(e,t)=>{this.eventNodes[e]=t}),I()(this,"_onHeightChanged",()=>{const e=this._scrollPanel.current;e&&e.checkScroll()}),I()(this,"_onTypingShown",()=>{const e=this._scrollPanel.current;e.checkScroll(),e&&e.getScrollState().stuckAtBottom&&e.preventShrinking()}),I()(this,"_onTypingHidden",()=>{const e=this._scrollPanel.current;e&&(e.updatePreventShrinking(),e.checkScroll())}),this.state={ghostReadMarkers:[],showTypingNotifications:F.a.getValue("showTypingNotifications")},this._readReceiptMap={},this._readReceiptsByEvent={},this._readReceiptsByUserId={},this._showHiddenEventsInTimeline=F.a.getValue("showHiddenEventsInTimeline"),this._isMounted=!1,this._readMarkerNode=Object(a.createRef)(),this._whoIsTyping=Object(a.createRef)(),this._scrollPanel=Object(a.createRef)(),this._showTypingNotificationsWatcherRef=F.a.watchSetting("showTypingNotifications",null,this.onShowTypingNotificationsChange)}componentDidMount(){this._isMounted=!0,this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){this._isMounted=!1,F.a.unwatchSetting(this._showTypingNotificationsWatcherRef),m.a.unregister(this.dispatcherRef)}componentDidUpdate(e,t){if(e.readMarkerVisible&&this.props.readMarkerEventId!==e.readMarkerEventId){const t=this.state.ghostReadMarkers;t.push(e.readMarkerEventId),this.setState({ghostReadMarkers:t})}}getNodeForEventId(e){if(this.eventNodes)return this.eventNodes[e]}isAtBottom(){return this._scrollPanel.current&&this._scrollPanel.current.isAtBottom()}getScrollState(){return this._scrollPanel.current?this._scrollPanel.current.getScrollState():null}getReadMarkerPosition(){const e=this._readMarkerNode.current,t=this._scrollPanel.current;if(!e||!t)return null;const s=Rc.a.findDOMNode(t).getBoundingClientRect(),n=e.getBoundingClientRect();return n.bottom+2<s.top?-1:n.top<s.bottom?0:1}scrollToTop(){this._scrollPanel.current&&this._scrollPanel.current.scrollToTop()}scrollToBottom(){this._scrollPanel.current&&this._scrollPanel.current.scrollToBottom()}scrollRelative(e){this._scrollPanel.current&&this._scrollPanel.current.scrollRelative(e)}handleScrollKey(e){this._scrollPanel.current&&this._scrollPanel.current.handleScrollKey(e)}scrollToEvent(e,t,s){this._scrollPanel.current&&this._scrollPanel.current.scrollToToken(e,t,s)}scrollToEventIfNeeded(e){const t=this.eventNodes[e];t&&t.scrollIntoView({block:"nearest",behavior:"instant"})}checkFillState(){this._scrollPanel.current&&this._scrollPanel.current.checkFillState()}_shouldShowEvent(e){return(!e.sender||!ee.a.get().isUserIgnored(e.sender.userId))&&(!!this._showHiddenEventsInTimeline||!!Object(gt.b)(e)&&(this.props.highlightedEventId===e.getId()||!Object(Oc.a)(e)))}_readMarkerForEvent(e,t){const s=!t&&this.props.readMarkerVisible;if(this.props.readMarkerEventId===e){let t;return s&&(t=i.a.createElement("hr",{className:"mx_RoomView_myReadMarker",style:{opacity:1,width:"99%"}})),i.a.createElement("li",{key:"readMarker_"+e,ref:this._readMarkerNode,className:"mx_RoomView_myReadMarker_container","data-scroll-tokens":e},t)}if(this.state.ghostReadMarkers.includes(e)){const t=i.a.createElement("hr",{className:"mx_RoomView_myReadMarker",ref:this._collectGhostReadMarker,onTransitionEnd:this._onGhostTransitionEnd,"data-eventid":e});return i.a.createElement("li",{key:"_readuptoghost_"+e,className:"mx_RoomView_myReadMarker_container"},t)}return null}_getEventTiles(){let e,t;this.eventNodes={};let s=-1;for(e=this.props.events.length-1;e>=0;e--){const n=this.props.events[e];if(this._shouldShowEvent(n)&&(void 0===t&&(t=n),!n.status)){s=e;break}}const n=[];let a=null;this._readReceiptsByEvent={},this.props.showReadReceipts&&(this._readReceiptsByEvent=this._getReadReceiptsByShownEvent());let i=null;for(e=0;e<this.props.events.length;e++){const o=this.props.events[e],r=o.getId(),l=o===t;if(i){if(i.shouldGroup(o)){i.add(o);continue}n.push(...i.getTiles()),a=i.getNewPrevEvent(),i=null}for(const e of Ac)e.canStartGroup(this,o)&&(i=new e(this,o,a,t));if(!i){if(this._shouldShowEvent(o)){const t=e<this.props.events.length-1?this.props.events[e+1]:null;n.push(...this._getTilesForEvent(a,o,l,t)),a=o}const t=this._readMarkerForEvent(r,e>=s);t&&n.push(t)}}return i&&n.push(...i.getTiles()),n}_getTilesForEvent(e,t,s,n){const a=d.getComponent("messages.TileErrorBoundary"),o=d.getComponent("rooms.EventTile"),r=d.getComponent("messages.DateSeparator"),l=[],c=this.props.editState&&this.props.editState.getEvent().getId()===t.getId();let m=t.getTs(),h=t.getDate();t.status&&(h=new Date,m=h.getTime());const u=this._wantsDateSeparator(e,h);if(u){const e=i.a.createElement("li",{key:m},i.a.createElement(r,{key:m,ts:m}));l.push(e)}let p=!1;n&&(p=this._wantsDateSeparator(t,n.getDate()||new Date));const g=!u&&function(e,t){return!!(e&&e.sender&&t.sender)&&(!(t.getTs()-e.getTs()>3e5)&&(!!(t.getType()===e.getType()||Tc.includes(t.getType())&&Tc.includes(e.getType()))&&(t.sender.userId===e.sender.userId&&t.sender.name===e.sender.name&&t.sender.getMxcAvatarUrl()===e.sender.getMxcAvatarUrl()&&!!Object(gt.b)(e))))}(e,t),f=t.getId(),b=f===this.props.highlightedEventId,v=t.status?void 0:f,_=this._readReceiptsByEvent[f];return l.push(i.a.createElement("li",{key:t.getTxnId()||f,ref:this._collectEventNode.bind(this,f),"data-scroll-tokens":v},i.a.createElement(a,{mxEvent:t},i.a.createElement(o,{mxEvent:t,continuation:g,isRedacted:t.isRedacted(),replacingEventId:t.replacingEventId(),editState:c&&this.props.editState,onHeightChanged:this._onHeightChanged,readReceipts:_,readReceiptMap:this._readReceiptMap,showUrlPreview:this.props.showUrlPreview,checkUnmounting:this._isUnmounting,eventSendStatus:t.getAssociatedStatus(),tileShape:this.props.tileShape,isTwelveHour:this.props.isTwelveHour,permalinkCreator:this.props.permalinkCreator,last:s,lastInSection:p,isSelectedEvent:b,getRelationsForEvent:this.props.getRelationsForEvent,showReactions:this.props.showReactions,useIRCLayout:this.props.useIRCLayout,enableFlair:this.props.enableFlair})))),l}_wantsDateSeparator(e,t){return null==e?!this.props.suppressFirstDateSeparator:Object(kc.e)(e.getDate(),t)}_getReadReceiptsForEvent(e){const t=ee.a.get().credentials.userId,{room:s}=this.props;if(!s)return null;const n=[];return s.getReceiptsForEvent(e).forEach(e=>{if(!e.userId||"m.read"!==e.type||e.userId===t)return;if(ee.a.get().isUserIgnored(e.userId))return;const a=s.getMember(e.userId);n.push({userId:e.userId,roomMember:a,ts:e.data?e.data.ts:0})}),n}_getReadReceiptsByShownEvent(){const e={},t={};let s;for(const n of this.props.events){if(this._shouldShowEvent(n)&&(s=n.getId()),!s)continue;const a=e[s]||[],i=this._getReadReceiptsForEvent(n);e[s]=a.concat(i);for(const e of i)t[e.userId]={lastShownEventId:s,receipt:e}}for(const s in this._readReceiptsByUserId){if(t[s])continue;const{lastShownEventId:n,receipt:a}=this._readReceiptsByUserId[s],i=e[n]||[];e[n]=i.concat(a),t[s]={lastShownEventId:n,receipt:a}}this._readReceiptsByUserId=t;for(const t in e)e[t].sort((e,t)=>t.ts-e.ts);return e}updateTimelineMinHeight(){const e=this._scrollPanel.current;if(e){const t=e.isAtBottom(),s=this._whoIsTyping.current,n=s&&s.isVisible();t&&n&&e.preventShrinking()}}onTimelineReset(){const e=this._scrollPanel.current;e&&e.clearPreventShrinking()}render(){const e=d.getComponent("elements.ErrorBoundary"),t=d.getComponent("structures.ScrollPanel"),s=d.getComponent("rooms.WhoIsTypingTile"),n=d.getComponent("elements.Spinner");let a,o;this.props.backPaginating&&(a=i.a.createElement("li",{key:"_topSpinner"},i.a.createElement(n,null))),this.props.forwardPaginating&&(o=i.a.createElement("li",{key:"_bottomSpinner"},i.a.createElement(n,null)));const r=this.props.hidden?{display:"none"}:{},l=L()(this.props.className,{mx_MessagePanel_alwaysShowTimestamps:this.props.alwaysShowTimestamps});let c;this.props.room&&!this.props.tileShape&&this.state.showTypingNotifications&&(c=i.a.createElement(s,{room:this.props.room,onShown:this._onTypingShown,onHidden:this._onTypingHidden,ref:this._whoIsTyping}));let m=null;return this.props.useIRCLayout&&(m=i.a.createElement(di,{minWidth:20,maxWidth:600,roomId:this.props.room?this.props.room.roomId:null})),i.a.createElement(e,null,i.a.createElement(t,{ref:this._scrollPanel,className:l,onScroll:this.props.onScroll,onResize:this.onResize,onFillRequest:this.props.onFillRequest,onUnfillRequest:this.props.onUnfillRequest,style:r,stickyBottom:this.props.stickyBottom,resizeNotifier:this.props.resizeNotifier,fixedChildren:m},a,this._getEventTiles(),c,o))}}I()(Nc,"propTypes",{hidden:xe.a.bool,backPaginating:xe.a.bool,forwardPaginating:xe.a.bool,events:xe.a.array.isRequired,highlightedEventId:xe.a.string,room:xe.a.object,showUrlPreview:xe.a.bool,readMarkerEventId:xe.a.string,readMarkerVisible:xe.a.bool,ourUserId:xe.a.string,suppressFirstDateSeparator:xe.a.bool,showReadReceipts:xe.a.bool,stickyBottom:xe.a.bool,onScroll:xe.a.func,onFillRequest:xe.a.func,className:xe.a.string.isRequired,tileShape:xe.a.string,isTwelveHour:xe.a.bool,alwaysShowTimestamps:xe.a.bool,getRelationsForEvent:xe.a.func,showReactions:xe.a.bool,useIRCLayout:xe.a.bool,enableFlair:xe.a.bool});class Pc{constructor(e,t,s,n){this.panel=e,this.createEvent=t,this.prevEvent=s,this.lastShownEvent=n,this.events=[],this.ejectedEvents=[],this.readMarker=e._readMarkerForEvent(t.getId(),t===n)}shouldGroup(e){const t=this.panel,s=this.createEvent;return!t._shouldShowEvent(e)||!t._wantsDateSeparator(this.createEvent,e.getDate())&&(("m.room.member"!==e.getType()||e.getStateKey()===s.getSender()&&"join"===e.getContent().membership)&&("im.vector.room.access_rules"!==e.getType()&&!(!e.isState()||e.getSender()!==s.getSender())))}add(e){const t=this.panel;this.readMarker=this.readMarker||t._readMarkerForEvent(e.getId(),e===this.lastShownEvent),t._shouldShowEvent(e)&&("m.room.encryption"===e.getType()?this.ejectedEvents.push(e):this.events.push(e))}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.EventListSummary"),s=this.panel,n=[],a=this.createEvent,o=this.lastShownEvent;if(s._wantsDateSeparator(this.prevEvent,a.getDate())){const t=a.getTs();n.push(i.a.createElement("li",{key:t+"~"},i.a.createElement(e,{key:t+"~",ts:t})))}s._shouldShowEvent(a)&&n.push(...s._getTilesForEvent(a,a,!1));for(const e of this.ejectedEvents)n.push(...s._getTilesForEvent(a,e,a===o));const r=this.events.map(e=>s._getTilesForEvent(e,e,e===o)).reduce((e,t)=>e.concat(t),[]),c=this.events[this.events.length-1];let m;const h=c.getRoomId(),u=c.sender?c.sender.name:c.getSender();return m=qn.a.shared().getUserIdForRoomId(h)?Object(l.a)("%(creator)s created this DM.",{creator:u}):Object(l.a)("%(creator)s created and configured the room.",{creator:u}),n.push(i.a.createElement($l.a,{key:"newroomintro"})),n.push(i.a.createElement(t,{key:"roomcreationsummary",events:this.events,onToggle:s._onHeightChanged,summaryMembers:[c.sender],summaryText:m},r)),this.readMarker&&n.push(this.readMarker),n}getNewPrevEvent(){return this.createEvent}}I()(Pc,"canStartGroup",(function(e,t){return"m.room.create"===t.getType()}));class Dc{constructor(e,t,s,n){this.panel=e,this.readMarker=e._readMarkerForEvent(t.getId(),t===n),this.events=[t],this.prevEvent=s,this.lastShownEvent=n}shouldGroup(e){return!this.panel._wantsDateSeparator(this.events[0],e.getDate())&&jc(e)}add(e){if("m.room.member"===e.getType()){const t=Object(Ic.a)(e);if(!t||0===t.trim().length)return}this.readMarker=this.readMarker||this.panel._readMarkerForEvent(e.getId(),e===this.lastShownEvent),this.events.push(e)}getTiles(){if(!this.events||!this.events.length)return[];const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("views.elements.MemberEventListSummary"),s=this.panel,n=this.lastShownEvent,a=[];if(s._wantsDateSeparator(this.prevEvent,this.events[0].getDate())){const t=this.events[0].getTs();a.push(i.a.createElement("li",{key:t+"~"},i.a.createElement(e,{key:t+"~",ts:t})))}const o="membereventlistsummary-"+(this.prevEvent?this.events[0].getId():"initial");let r,l=this.events.map(e=>(e.getId()===s.props.highlightedEventId&&(r=!0),s._getTilesForEvent(e,e,e===n))).reduce((e,t)=>e.concat(t),[]);return 0===l.length&&(l=null),a.push(i.a.createElement(t,{key:o,events:this.events,onToggle:s._onHeightChanged,startExpanded:r},l)),this.readMarker&&a.push(this.readMarker),a}getNewPrevEvent(){return this.events[0]}}I()(Dc,"canStartGroup",(function(e,t){return e._shouldShowEvent(t)&&jc(t)}));const Ac=[Pc,Dc];class Uc extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{groups:null,error:null}),I()(this,"_onCreateGroupClick",()=>{m.a.dispatch({action:"view_create_group"})})}componentDidMount(){this._fetch()}_fetch(){this.context.getJoinedGroups().then(e=>{this.setState({groups:e.groups,error:null})},e=>{"M_GUEST_ACCESS_FORBIDDEN"!==e.errcode?this.setState({groups:null,error:e}):this.setState({groups:[],error:null})})}render(){const e=c.a.get().brand,t=d.getComponent("elements.Spinner"),n=d.getComponent("rooms.SimpleRoomHeader"),a=d.getComponent("groups.GroupTile");let r,m;if(this.state.groups){const t=[];this.state.groups.forEach(e=>{t.push(i.a.createElement(a,{key:e,groupId:e}))}),m=t.length>0?i.a.createElement("h3",null,Object(l.a)("Your Communities")):i.a.createElement("div",null),r=t.length>0?i.a.createElement(o.a,{className:"mx_MyGroups_scrollable"},i.a.createElement("div",{className:"mx_MyGroups_microcopy"},i.a.createElement("p",null,Object(l.a)("Did you know: you can use communities to filter your %(brand)s experience!",{brand:e})),i.a.createElement("p",null,Object(l.a)("To set up a filter, drag a community avatar over to the filter panel on the far left hand side of the screen. You can click on an avatar in the filter panel at any time to see only the rooms and people associated with that community."))),i.a.createElement("div",{className:"mx_MyGroups_joinedGroups"},t)):i.a.createElement("div",{className:"mx_MyGroups_placeholder"},Object(l.a)("You're not currently a member of any communities."))}else r=this.state.error?i.a.createElement("div",{className:"mx_MyGroups_error"},Object(l.a)("Error whilst fetching joined communities")):i.a.createElement(t,null);return i.a.createElement("div",{className:"mx_MyGroups"},i.a.createElement(n,{title:Object(l.a)("Communities"),icon:s(1272)}),i.a.createElement("div",{className:"mx_MyGroups_header"},i.a.createElement("div",{className:"mx_MyGroups_headerCard"},i.a.createElement(pe.a,{className:"mx_MyGroups_headerCard_button",onClick:this._onCreateGroupClick}),i.a.createElement("div",{className:"mx_MyGroups_headerCard_content"},i.a.createElement("div",{className:"mx_MyGroups_headerCard_header"},Object(l.a)("Create a new community")),Object(l.a)("Create a community to group together users and rooms! Build a custom homepage to mark out your space in the Matrix universe.")))),i.a.createElement("div",{className:"mx_MyGroups_content"},m,r))}}I()(Uc,"contextType",b.a);class Mc extends i.a.Component{render(){const e=d.getComponent("structures.TimelinePanel"),t=d.getComponent("elements.Spinner"),s=i.a.createElement("div",{className:"mx_RightPanel_empty mx_NotificationPanel_empty"},i.a.createElement("h2",null,Object(l.a)("You’re all caught up")),i.a.createElement("p",null,Object(l.a)("You have no visible notifications.")));let n;const a=ee.a.get().getNotifTimelineSet();return a?n=i.a.createElement(e,{manageReadReceipts:!1,manageReadMarkers:!1,timelineSet:a,showUrlPreview:!1,tileShape:"notif",empty:s}):(console.error("No notifTimelineSet available!"),n=i.a.createElement(t,null)),i.a.createElement(no.b,{className:"mx_NotificationPanel",onClose:this.props.onClose,withoutScrollContainer:!0},n)}}I()(Mc,"propTypes",{onClose:xe.a.func.isRequired});var Lc=Mc;function Fc(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return n}function Bc(e,t){if(!t)return null;for(const s of Object.keys(e))if(e[s].instances||!(e[s].instances instanceof Array))for(const n of e[s].instances)if(n.instance_id==t)return s}const Vc=Symbol("ALL_ROOMS"),Wc=Object(Ca.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(l.a)("Enter a server name")},{key:"available",final:!0,test:async({value:e})=>{try{const t={limit:1,server:e};return await ee.a.get().publicRooms(t),!0}catch(e){return!1}},valid:()=>Object(l.a)("Looks good"),invalid:()=>Object(l.a)("Can't find this server or its room list")}]}),Hc=({onOptionChange:e,protocols:t={},selectedServerName:s,selectedInstanceId:o})=>{const[r,m,h,u]=Object(n.q)(),p=Ts("room_directory_servers"),[g,f]=Object(a.useState)(p),b=(t,s)=>()=>{e(t,s),u()},v=e=>{f(e),F.a.setValue("room_directory_servers",null,"account",e)};let _;if(Object(a.useEffect)(()=>{f(p)},[p]),r){const a=c.a.get().roomDirectory||{},r=ee.a.getHomeserverName(),h=new Set(a.servers),p=new Set(g.filter(e=>!h.has(e)&&e!==r)),f=[r,...Array.from(h).filter(e=>e!==r).sort(),...Array.from(p).sort()],E=f.map(a=>{const c=a===s,m=[],h=a===r?Object.values(t):[];let g,_;if(h.length>0&&h.push({instances:[{instance_id:Vc,desc:Object(l.a)("All rooms")}]}),h.forEach(({instances:e=[]})=>{[...e].sort((e,t)=>t.desc.localeCompare(e.desc)).forEach(({desc:e,instance_id:t})=>{m.push(i.a.createElement(n.h,{key:String(t),active:c&&t===o,onClick:b(a,t),label:e,className:"mx_NetworkDropdown_server_network"},e))})}),a===r&&(g=i.a.createElement("div",{className:"mx_NetworkDropdown_server_subtitle"},Object(l.a)("Your server"))),p.has(a)){const t=async()=>{u();const t=d.getComponent("dialogs.QuestionDialog"),{finished:s}=De.a.createTrackedDialog("Network Dropdown","Remove server",t,{title:Object(l.a)("Are you sure?"),description:Object(l.a)("Are you sure you want to remove <b>%(serverName)s</b>",{serverName:a},{b:e=>i.a.createElement("b",null,e)}),button:Object(l.a)("Remove"),fixedWidth:!1},"mx_NetworkDropdown_dialog"),[n]=await s;n&&(v(f.filter(e=>e!==a)),c===a&&e(r,void 0))};_=i.a.createElement(n.f,{onClick:t,label:Object(l.a)("Remove server")})}return i.a.createElement(n.e,{label:a,className:"mx_NetworkDropdown_server",key:a},i.a.createElement("div",{className:"mx_NetworkDropdown_server_title"},a,_),g,i.a.createElement(n.h,{active:c&&!o,onClick:b(a,void 0),label:Object(l.a)("Matrix"),className:"mx_NetworkDropdown_server_network"},Object(l.a)("Matrix")),m)}),C=async()=>{u();const t=d.getComponent("dialogs.TextInputDialog"),{finished:s}=De.a.createTrackedDialog("Network Dropdown","Add a new server",t,{title:Object(l.a)("Add a new server"),description:Object(l.a)("Enter the name of a new server you want to explore."),button:Object(l.a)("Add"),hasCancel:!1,placeholder:Object(l.a)("Server name"),validator:Wc,fixedWidth:!1},"mx_NetworkDropdown_dialog"),[n,a]=await s;n&&(g.includes(a)||v([...g,a]),e(a))},w=m.current.getBoundingClientRect();_=i.a.createElement(n.b,se()({},(y=w,{right:window.innerWidth-y.right,top:y.top,chevronOffset:0,chevronFace:"none"}),{onFinished:u}),i.a.createElement("div",{className:"mx_NetworkDropdown_menu"},E,i.a.createElement(n.f,{className:"mx_NetworkDropdown_server_add",label:void 0,onClick:C},Object(l.a)("Add a new server..."))))}else{let e;if(o===Vc)e=Object(l.a)("All rooms");else if(o){const s=Fc(t,o);e=Object(l.a)("%(networkName)s rooms",{networkName:s.desc})}else e=Object(l.a)("Matrix rooms");_=i.a.createElement(n.c,{className:"mx_NetworkDropdown_handle",onClick:h,isExpanded:r},i.a.createElement("span",null,e)," ",i.a.createElement("span",{className:"mx_NetworkDropdown_handle_server"},"(",s,")"))}var y;return i.a.createElement("div",{className:"mx_NetworkDropdown",ref:m},_)};Hc.propTypes={onOptionChange:xe.a.func.isRequired,protocols:xe.a.object};var Gc=Hc;function qc(e){_.a.trackEvent("RoomDirectory",e)}class Kc extends i.a.Component{constructor(e){super(e),I()(this,"refreshRoomList",()=>{this.state.selectedCommunityId?this.setState({publicRooms:sa.a.getGroupRooms(this.state.selectedCommunityId).map(e=>({room_id:e.roomId,name:e.name,topic:e.topic,canonical_alias:e.canonicalAlias,num_joined_members:e.numJoinedMembers,avatarUrl:e.avatarUrl,world_readable:e.worldReadable,guest_can_join:e.guestsCanJoin})).filter(e=>{const t=this.state.filterString;if(t){const s=e=>(e||"").toLowerCase().includes(t.toLowerCase());return s(e.name)||s(e.topic)||s(e.canonical_alias)}return!0}),loading:!1}):(this.nextBatch=null,this.setState({publicRooms:[],loading:!0}),this._populateRoomList())}),I()(this,"onRoomClicked",(e,t)=>{t.shiftKey&&!this.state.selectedCommunityId?(t.preventDefault(),this.removeFromDirectory(e)):this.showRoom(e)}),I()(this,"onOptionChange",(e,t)=>{this.nextBatch=null,this.setState({publicRooms:[],roomServer:e,instanceId:t,error:null},this.refreshRoomList)}),I()(this,"onFillRequest",e=>e||!this.nextBatch?Promise.resolve(!1):this.getMoreRooms()),I()(this,"onFilterChange",e=>{this.setState({filterString:e||null}),this.filterTimeout&&clearTimeout(this.filterTimeout),this.filterTimeout=setTimeout(()=>{this.filterTimeout=null,this.refreshRoomList()},700)}),I()(this,"onFilterClear",()=>{this.setState({filterString:null},this.refreshRoomList),this.filterTimeout&&clearTimeout(this.filterTimeout)}),I()(this,"onJoinFromSearchClick",e=>{if(this.state.instanceId&&this.state.instanceId!==Vc){const t=Bc(this.protocols,this.state.instanceId),s=Fc(this.protocols,this.state.instanceId),n=t?this._getFieldsForThirdPartyLocation(e,this.protocols[t],s):null;if(!n){const e=d.getComponent("dialogs.ErrorDialog"),t=c.a.get().brand;return void De.a.createTrackedDialog("Unable to join network","",e,{title:Object(l.a)("Unable to join network"),description:Object(l.a)("%(brand)s does not know how to join a room on this network",{brand:t})})}ee.a.get().getThirdpartyLocation(t,n).then(e=>{if(e.length>0&&e[0].alias)this.showRoomAlias(e[0].alias,!0);else{const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Room not found","",e,{title:Object(l.a)("Room not found"),description:Object(l.a)("Couldn't find a matching Matrix room")})}},e=>{const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Fetching third party location failed","",t,{title:Object(l.a)("Fetching third party location failed"),description:Object(l.a)("Unable to look up room ID from server")})})}else-1==e.indexOf(":")&&(e=e+":"+this.state.roomServer),this.showRoomAlias(e,!0)}),I()(this,"onPreviewClick",(e,t)=>{this.showRoom(t,null,!1,!0),e.stopPropagation()}),I()(this,"onViewClick",(e,t)=>{this.showRoom(t),e.stopPropagation()}),I()(this,"onJoinClick",(e,t)=>{this.showRoom(t,null,!0),e.stopPropagation()}),I()(this,"onCreateRoomClick",e=>{this.onFinished(),m.a.dispatch({action:"view_create_room",public:!0})}),I()(this,"collectScrollPanel",e=>{this.scrollPanel=e}),I()(this,"handleScrollKey",e=>{this.scrollPanel&&this.scrollPanel.handleScrollKey(e)}),I()(this,"onFinished",()=>{y.a.instance.trackRoomDirectory(this.startTime),this.props.onFinished()}),y.a.instance.trackRoomDirectoryBegin(),this.startTime=y.a.getTimestamp();const t=P.a.getSelectedTags()[0],s=c.a.get().hs_url_list;this.state={publicRooms:[],loading:!0,protocolsLoading:!0,error:null,instanceId:void 0,roomServer:void 0,filterString:this.props.initialText||"",selectedCommunityId:F.a.getValue("feature_communities_v2_prototypes")?t:null,communityName:null,serverList:s||[]},this._unmounted=!1,this.nextBatch=null,this.filterTimeout=null,this.scrollPanel=null,this.protocols=null,this.state.protocolsLoading=!0,ee.a.get()?this.state.selectedCommunityId?(this.state.protocolsLoading=!1,ds.a.getGroupProfileCached(ee.a.get(),this.state.selectedCommunityId).then(e=>{this.setState({communityName:e.name})})):ee.a.get().getThirdpartyProtocols().then(e=>{this.protocols=e,this.setState({protocolsLoading:!1})},e=>{if(console.warn("error loading third party protocols: "+e),this.setState({protocolsLoading:!1}),ee.a.get().isGuest())return;qc("Failed to get protocol list from homeserver");const t=c.a.get().brand;this.setState({error:Object(l.a)("%(brand)s failed to get the protocol list from the homeserver. The homeserver may be too old to support third party networks.",{brand:t})})}):this.state.protocolsLoading=!1}componentDidMount(){this.refreshRoomList()}componentWillUnmount(){this.filterTimeout&&clearTimeout(this.filterTimeout),this._unmounted=!0}_populateRoomList(){const e=this.state.serverList;for(let t=0;t<e.length;t++)this.getMoreRooms(e[t])}getMoreRooms(e){if(!ee.a.get())return Promise.resolve();this.setState({loading:!0});const t=this.state.filterString,s=e,n={};return s!=ee.a.getHomeserverName()&&(n.server=s),this.state.instanceId===Vc?n.include_all_networks=!0:this.state.instanceId&&(n.third_party_instance_id=this.state.instanceId),t&&(n.filter={generic_search_term:t}),ee.a.get().publicRooms(n).then(e=>{if(t==this.state.filterString&&!this._unmounted){if(this.state.filterString){const t=e.total_room_count_estimate||e.chunk.length;y.a.instance.trackRoomDirectorySearch(t,this.state.filterString)}return this.nextBatch=e.next_batch,this.setState(t=>(t.publicRooms.push(...e.chunk||[]),t.loading=!1,t)),Boolean(e.next_batch)}},e=>{if(t!=this.state.filterString)return;if(this._unmounted)return;if(e&&("M_FORBIDDEN"===e.errcode||"M_UNKNOWN"===e.errcode||"M_UNAUTHORIZED"===e.errcode))return;console.error("Failed to get publicRooms: %s",JSON.stringify(e)),qc("Failed to get public room list");const s=c.a.get().brand;this.setState({loading:!1,error:Object(l.a)("%(brand)s failed to get the public room list.",{brand:s})+(e&&e.message)?e.message:Object(l.a)("The homeserver may be unavailable or overloaded.")})})}removeFromDirectory(e){const t=zc(e),s=e.name||t||Object(l.a)("Unnamed room"),n=d.getComponent("dialogs.QuestionDialog"),a=d.getComponent("dialogs.ErrorDialog");let i;i=t?Object(l.a)("Delete the room address %(alias)s and remove %(name)s from the directory?",{alias:t,name:s}):Object(l.a)("Remove %(name)s from the directory?",{name:s}),De.a.createTrackedDialog("Remove from Directory","",n,{title:Object(l.a)("Remove from Directory"),description:i,onFinished:n=>{if(!n)return;const i=d.getComponent("elements.Spinner"),o=De.a.createDialog(i);let r=Object(l.a)("remove %(name)s from the directory.",{name:s});ee.a.get().setRoomDirectoryVisibility(e.room_id,"private").then(()=>{if(t)return r=Object(l.a)("delete the address."),ee.a.get().deleteAlias(t)}).then(()=>{o.close(),this.refreshRoomList()},e=>{o.close(),this.refreshRoomList(),console.error("Failed to "+r+": "+e),De.a.createTrackedDialog("Remove from Directory Error","",a,{title:Object(l.a)("Error"),description:e&&e.message?e.message:Object(l.a)("The server may be unavailable or overloaded")})})}})}showRoomAlias(e,t=!1){this.showRoom(null,e,t)}showRoom(e,t,s=!1,n=!1){this.onFinished();const a={action:"view_room",auto_join:s,should_peek:n,_type:"room_directory"};if(e){if(ee.a.get().isGuest()&&!e.world_readable&&!e.guest_can_join)return void m.a.dispatch({action:"require_registration"});t||(t=zc(e)),a.oob_data={avatarUrl:e.avatar_url,name:e.name||t||Object(l.a)("Unnamed room")},this.state.roomServer&&(a.via_servers=[this.state.roomServer],a.opts={viaServers:[this.state.roomServer]})}t?a.room_alias=t:a.room_id=e.room_id,m.a.dispatch(a)}createRoomCells(e){const t=ee.a.get(),s=t.getRoom(e.room_id),n=s&&"join"===s.getMyMembership(),a=t.isGuest(),o=d.getComponent("avatars.BaseAvatar"),r=d.getComponent("elements.AccessibleButton");let c,m;!n&&e.world_readable&&(c=i.a.createElement(r,{kind:"secondary",className:"tc_RoomDirectory_roomPreview",onClick:t=>this.onPreviewClick(t,e)},Object(l.a)("Preview"))),n?m=i.a.createElement(r,{kind:"secondary",onClick:t=>this.onViewClick(t,e)},Object(l.a)("View")):a||(m=i.a.createElement(r,{kind:"primary",onClick:t=>this.onJoinClick(t,e)},Object(l.a)("Join")));let h=e.name||zc(e)||Object(l.a)("Unnamed room");h.length>80&&(h=h.substring(0,80)+"...");let u=e.topic||"";u.length>800&&(u=u.substring(0,800)+"..."),u=Object(rr.e)(u);const p=Object(Jl.a)(ee.a.get().getHomeserverUrl(),e.avatar_url,32,32,"crop");return[i.a.createElement("div",{key:e.room_id+"_avatar",onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()},className:"mx_RoomDirectory_roomAvatar"},i.a.createElement(o,{width:32,height:32,resizeMethod:"crop",name:h,idName:h,url:p})),i.a.createElement("div",{key:e.room_id+"_description",onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()},className:"mx_RoomDirectory_roomDescription"},i.a.createElement("div",{className:"mx_RoomDirectory_name"},h)," ",i.a.createElement("div",{className:"mx_RoomDirectory_topic",onClick:e=>{e.stopPropagation()},dangerouslySetInnerHTML:{__html:u}})),i.a.createElement("div",{key:e.room_id+"_domain",onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()},className:"mx_RoomDirectory_roomDomain"},E.a.getDomainFromId(e.room_id)),i.a.createElement("div",{key:e.room_id+"_memberCount",onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()},className:"mx_RoomDirectory_roomMemberCount"},e.num_joined_members),i.a.createElement("div",{key:e.room_id+"_preview",onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()},className:"mx_RoomDirectory_preview"},c),i.a.createElement("div",{key:e.room_id+"_join",onClick:t=>this.onRoomClicked(e,t),onMouseDown:e=>{e.preventDefault()},className:"mx_RoomDirectory_join"},m)]}_stringLooksLikeId(e,t){let s=/^#[^\s]+:[^\s]/;return t&&t.regexp&&(s=new RegExp(t.regexp)),s.test(e)}_getFieldsForThirdPartyLocation(e,t,s){const n=t.location_fields;if(!n)return null;const a={};for(let e=0;e<n.length-1;++e){const t=n[e];if(void 0===s.fields[t])return null;a[t]=s.fields[t]}return a[n[n.length-1]]=e,a}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("elements.AccessibleButton");let n,a;if(this.state.error)n=this.state.error;else if(this.state.protocolsLoading)n=i.a.createElement(e,null);else{const t=this.state.publicRooms||[];t.sort((e,t)=>t.num_joined_members-e.num_joined_members);const s=t.reduce((e,t)=>e.concat(this.createRoomCells(t)),[]);let a,o;this.state.loading&&(a=i.a.createElement(e,null)),o=0!==s.length||this.state.loading?i.a.createElement("div",{className:"mx_RoomDirectory_table"},s):i.a.createElement("i",null,Object(l.a)("No rooms to show"));const r=d.getComponent("structures.ScrollPanel");n=i.a.createElement(r,{ref:this.collectScrollPanel,className:"mx_RoomDirectory_tableWrapper",onFillRequest:this.onFillRequest,stickyBottom:!1,startAtBottom:!1},o,a)}if(!this.state.protocolsLoading){const e=d.getComponent("elements.DirectorySearchBox"),t=Bc(this.protocols,this.state.instanceId);let s;if(t&&this.protocols&&this.protocols[t]&&this.protocols[t].location_fields.length>0&&this.protocols[t].field_types){const e=this.protocols[t].location_fields.slice(-1)[0];s=this.protocols[t].field_types[e]}let n=Object(l.a)("Find a room…"),o=this._stringLooksLikeId(this.state.filterString,s);if(t){const e=Fc(this.protocols,this.state.instanceId);null===this._getFieldsForThirdPartyLocation(this.state.filterString,this.protocols[t],e)&&(o=!1)}a=i.a.createElement("div",{className:"mx_RoomDirectory_listheader"},i.a.createElement(e,{className:"mx_RoomDirectory_searchbox",onChange:this.onFilterChange,onClear:this.onFilterClear,onJoinClick:this.onJoinFromSearchClick,placeholder:n,showJoinButton:o,initialText:this.props.initialText}))}const o=Object(l.a)("If you can't find the room you're looking for, ask for an invite or <a>Create a new room</a>.",null,{a:e=>i.a.createElement(s,{kind:"secondary",onClick:this.onCreateRoomClick},e)}),r=Object(l.a)("Explore rooms");return i.a.createElement(t,{className:"mx_RoomDirectory_dialog",hasCancel:!0,onFinished:this.onFinished,title:r},i.a.createElement("div",{className:"mx_RoomDirectory"},o,i.a.createElement("div",{className:"mx_RoomDirectory_list"},a,n)))}}function zc(e){return e.canonical_alias||(e.aliases?e.aliases[0]:"")}I()(Kc,"propTypes",{initialText:xe.a.string,onFinished:xe.a.func.isRequired});class $c{static resendUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===Fe.b.NOT_SENT})).forEach((function(e){$c.resend(e)}))}static cancelUnsentEvents(e){e.getPendingEvents().filter((function(e){return e.status===Fe.b.NOT_SENT})).forEach((function(e){$c.removeFromQueue(e)}))}static resend(e){const t=ee.a.get().getRoom(e.getRoomId());ee.a.get().resendEvent(e,t).then((function(t){m.a.dispatch({action:"message_sent",event:e})}),(function(t){console.log("Resend got send failure: "+t.name+"("+t+")"),m.a.dispatch({action:"message_send_failed",event:e})}))}static removeFromQueue(e){ee.a.get().cancelPendingEvent(e)}}function Yc(e){return e?e.getPendingEvents().filter((function(e){return e.status===Fe.q.EventStatus.NOT_SENT})):[]}class Jc extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{syncState:ee.a.get().getSyncState(),syncStateData:ee.a.get().getSyncStateData(),unsentMessages:Yc(this.props.room)}),I()(this,"onSyncStateChange",(e,t,s)=>{"SYNCING"===e&&"SYNCING"===t||this.setState({syncState:e,syncStateData:s})}),I()(this,"_onResendAllClick",()=>{$c.resendUnsentEvents(this.props.room),m.a.fire(h.a.FocusComposer)}),I()(this,"_onCancelAllClick",()=>{$c.cancelUnsentEvents(this.props.room),m.a.fire(h.a.FocusComposer)}),I()(this,"_onRoomLocalEchoUpdated",(e,t,s,n)=>{t.roomId===this.props.room.roomId&&this.setState({unsentMessages:Yc(this.props.room)})}),I()(this,"_onReinviteClick",()=>{const e=qn.a.shared().getUserIdForRoomId(this.props.room.roomId);Object(rs.a)(this.props.room.roomId,[e]).then().catch(e=>{console.error("Failed to invite user to the room"),console.error(e)})})}componentDidMount(){ee.a.get().on("sync",this.onSyncStateChange),ee.a.get().on("Room.localEchoUpdated",this._onRoomLocalEchoUpdated),this._checkSize()}componentDidUpdate(){this._checkSize()}componentWillUnmount(){const e=ee.a.get();e&&(e.removeListener("sync",this.onSyncStateChange),e.removeListener("Room.localEchoUpdated",this._onRoomLocalEchoUpdated))}_checkSize(){this._getSize()?this.props.onVisible&&this.props.onVisible():this.props.onHidden&&this.props.onHidden()}_getSize(){return this._shouldShowConnectionError()?1:this.state.unsentMessages.length>0?2:0}_shouldShowConnectionError(){const e=Boolean(this.state.syncStateData&&this.state.syncStateData.error&&"M_RESOURCE_LIMIT_EXCEEDED"===this.state.syncStateData.error.errcode);return"ERROR"===this.state.syncState&&!e}_getUnsentMessageContent(){const e=this.state.unsentMessages;if(!e.length)return null;let t,n=null,a=null;for(const t of e){if(t.error&&"M_CONSENT_NOT_GIVEN"===t.error.errcode){n=t.error;break}if(t.error&&"M_RESOURCE_LIMIT_EXCEEDED"===t.error.errcode){a=t.error;break}}t=n?Object(l.a)("You can't send any messages until you review and agree to <consentLink>our terms and conditions</consentLink>.",{},{consentLink:e=>i.a.createElement("a",{href:n.data&&n.data.consent_uri,target:"_blank"},e)}):a?nn(a.data.limit_type,a.data.admin_contact,{monthly_active_user:Object(l.b)("Your message wasn't sent because this homeserver has hit its Monthly Active User Limit. Please <a>contact your service administrator</a> to continue using the service."),"":Object(l.b)("Your message wasn't sent because this homeserver has exceeded a resource limit. Please <a>contact your service administrator</a> to continue using the service.")}):1===e.length&&e[0].error&&e[0].error.data&&e[0].error.data.error?function(e){if("M_TOO_LARGE"===e.errcode)return Object(l.a)("The message you are trying to send is too large.")}(e[0].error.data)||e[0].error.data.error:Object(l.a)("%(count)s of your messages have not been sent.",{count:e.length});const o=Object(l.a)("%(count)s <resendText>Resend all</resendText> or <cancelText>cancel all</cancelText> now. You can also select individual messages to resend or cancel.",{count:e.length},{resendText:e=>i.a.createElement("a",{className:"mx_RoomStatusBar_resend_link",key:"resend",onClick:this._onResendAllClick},e),cancelText:e=>i.a.createElement("a",{className:"mx_RoomStatusBar_resend_link",key:"cancel",onClick:this._onCancelAllClick},e)});return i.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},i.a.createElement("img",{src:s(457),width:"24",height:"24",title:Object(l.a)("Warning"),alt:""}),i.a.createElement("div",null,i.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},t),i.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},o)))}_getContent(){if(this._shouldShowConnectionError())return i.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar"},i.a.createElement("img",{src:s(457),width:"24",height:"24",title:"/!\\ ",alt:"/!\\ "}),i.a.createElement("div",null,i.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_title"},Object(l.a)("Connectivity to the server has been lost.")),i.a.createElement("div",{className:"mx_RoomStatusBar_connectionLostBar_desc"},Object(l.a)("Sent messages will be stored until your connection has returned."))));if(this.state.unsentMessages.length>0)return this._getUnsentMessageContent();if(this.props.sentMessageAndIsAlone&&!this.props.isPeeking){let e=Object(l.a)("There's no one else here!");const t=qn.a.shared().getUserIdForRoomId(this.props.room.roomId);if("direct"===E.a.getAccessRules(this.props.room.roomId)&&t){const s=ee.a.get().getUser(t);e=Object(l.a)("%(user)s seems to have left the conversation. Do you want to <btn>invite</btn> him back?",{user:s.rawDisplayName},{btn:e=>i.a.createElement(pe.a,{onClick:this._onReinviteClick,kind:"primary_outline",className:"tc_RoomStatusBar_reinvite"},e)})}return i.a.createElement("div",{className:"mx_RoomStatusBar_isAlone"},e)}return null}render(){const e=this._getContent();return i.a.createElement("div",{className:"mx_RoomStatusBar"},i.a.createElement("div",{role:"alert"},e))}}I()(Jc,"propTypes",{room:xe.a.object.isRequired,isPeeking:xe.a.bool,onResendAllClick:xe.a.func,onCancelAllClick:xe.a.func,onInviteClick:xe.a.func,onResize:xe.a.func,onHidden:xe.a.func,onVisible:xe.a.func});var Qc=s(700);class Xc extends i.a.Component{constructor(e){super(e),I()(this,"onAction",e=>{if(this.props.enableRoomSearchFocus)switch(e.action){case"view_room":this._search.current&&e.clear_search&&this._clearSearch();break;case"focus_room_filter":this._search.current&&this._search.current.focus()}}),I()(this,"onChange",()=>{this._search.current&&(this.setState({searchTerm:this._search.current.value}),this.onSearch())}),I()(this,"onSearch",Object(Pa.throttle)(()=>{this.props.onSearch(this._search.current.value)},200,{trailing:!0,leading:!0})),I()(this,"_onKeyDown",e=>{switch(e.key){case _s.a.ESCAPE:this._clearSearch("keyboard")}this.props.onKeyDown&&this.props.onKeyDown(e)}),I()(this,"_onFocus",e=>{this.setState({blurred:!1}),e.target.select(),this.props.onFocus&&this.props.onFocus(e)}),I()(this,"_onBlur",e=>{this.setState({blurred:!0}),this.props.onBlur&&this.props.onBlur(e)}),this._search=Object(a.createRef)(),this.state={searchTerm:"",blurred:!0}}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}_clearSearch(e){this._search.current.value="",this.onChange(),this.props.onCleared&&this.props.onCleared(e)}render(){if(this.props.collapsed)return null;const e=!this.state.blurred||this.state.searchTerm?i.a.createElement(pe.a,{key:"button",tabIndex:-1,className:"mx_SearchBox_closeButton",onClick:()=>{this._clearSearch("button")}}):void 0,t=this.state.blurred&&this.props.blurredPlaceholder||this.props.placeholder,s=this.props.className||"";return i.a.createElement("div",{className:L()("mx_SearchBox","mx_textinput",{mx_SearchBox_blurred:this.state.blurred})},i.a.createElement("input",{key:"searchfield",type:"text",ref:this._search,className:"mx_textinput_icon mx_textinput_search "+s,value:this.state.searchTerm,onFocus:this._onFocus,onChange:this.onChange,onKeyDown:this._onKeyDown,onBlur:this._onBlur,placeholder:t,autoComplete:"off"}),e)}}I()(Xc,"propTypes",{onSearch:xe.a.func,onCleared:xe.a.func,onKeyDown:xe.a.func,className:xe.a.string,placeholder:xe.a.string.isRequired,enableRoomSearchFocus:xe.a.bool}),I()(Xc,"defaultProps",{enableRoomSearchFocus:!1});var Zc=s(701),ed=s(293);class td extends i.a.Component{constructor(...e){super(...e),I()(this,"onAction",e=>{switch(e.action){case"upload_progress":case"upload_finished":case"upload_canceled":case"upload_failed":this.mounted&&this.forceUpdate()}})}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction),this.mounted=!0}componentWillUnmount(){this.mounted=!1,m.a.unregister(this.dispatcherRef)}render(){const e=ed.a.sharedInstance().getCurrentUploads();if(0==e.length)return i.a.createElement("div",null);let t;for(let s=0;s<e.length;++s)if(e[s].roomId==this.props.room.roomId){t=e[s];break}if(!t)return i.a.createElement("div",null);const n={width:t.loaded/(t.total||1)*100+"%"};let a=Ki()(t.loaded);const o=Ki()(t.total);a.replace(/^.* /,"")===o.replace(/^.* /,"")&&(a=a.replace(/ .*/,""));const r=Object(l.a)("Uploading %(filename)s and %(count)s others",{filename:t.fileName,count:e.length-1});return i.a.createElement("div",{className:"mx_UploadBar"},i.a.createElement("div",{className:"mx_UploadBar_uploadProgressOuter"},i.a.createElement("div",{className:"mx_UploadBar_uploadProgressInner",style:n})),i.a.createElement("img",{className:"mx_UploadBar_uploadIcon mx_filterFlipColor",src:s(1273),width:"17",height:"22"}),i.a.createElement("img",{className:"mx_UploadBar_uploadCancel mx_filterFlipColor",src:s(222),width:"18",height:"18",onClick:function(){ed.a.sharedInstance().cancelUpload(t.promise)}}),i.a.createElement("div",{className:"mx_UploadBar_uploadBytes"},a," / ",o),i.a.createElement("div",{className:"mx_UploadBar_uploadFilename"},r))}}I()(td,"propTypes",{room:xe.a.object});class sd extends i.a.Component{static get propTypes(){return{userId:xe.a.string}}constructor(e){super(e),this.state={}}componentDidMount(){this.props.userId&&this._loadProfileInfo()}componentDidUpdate(e){e.userId!==this.props.userId&&this.props.userId&&this._loadProfileInfo()}async _loadProfileInfo(){const e=ee.a.get();let t;this.setState({loading:!0});try{t=await e.getProfileInfo(this.props.userId)}catch(e){const t=d.getComponent("dialogs.ErrorDialog");return De.a.createTrackedDialog(Object(l.a)("Could not load user profile"),"",t,{title:Object(l.a)("Could not load user profile"),description:e&&e.message?e.message:Object(l.a)("Operation failed")}),void this.setState({loading:!1})}const s=new Fe.q.MatrixEvent({type:"m.room.member",content:t}),n=new Fe.q.RoomMember(null,this.props.userId);n.setMembershipEvent(s),this.setState({member:n,loading:!1})}render(){if(this.state.loading){const e=d.getComponent("elements.Spinner");return i.a.createElement(e,null)}if(this.state.member){const e=d.getComponent("structures.RightPanel"),t=d.getComponent("structures.MainSplit"),s=i.a.createElement(e,{user:this.state.member});return i.a.createElement(t,{panel:s,resizeNotifier:this.props.resizeNotifier},i.a.createElement(O,null))}return i.a.createElement("div",null)}}var nd=s(757);class ad extends i.a.Component{constructor(e){super(e),this._ref=this._ref.bind(this)}componentDidUpdate(){this._el&&Object(nd.highlightBlock)(this._el)}_ref(e){this._el=e,this.componentDidUpdate()}render(){const{className:e,children:t}=this.props;return i.a.createElement("pre",{className:e+" mx_SyntaxHighlight",ref:this._ref},i.a.createElement("code",null,t))}}I()(ad,"propTypes",{className:xe.a.string,children:xe.a.node});class id extends i.a.Component{render(){const e=d.getComponent("views.dialogs.BaseDialog");return i.a.createElement(e,{className:"mx_ViewSource",onFinished:this.props.onFinished,title:Object(l.a)("View Source")},i.a.createElement("div",{className:"mx_ViewSource_label_left"},"Room ID: ",this.props.roomId),i.a.createElement("div",{className:"mx_ViewSource_label_right"},"Event ID: ",this.props.eventId),i.a.createElement("div",{className:"mx_ViewSource_label_bottom"}),i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(ad,{className:"json"},JSON.stringify(this.props.content,null,2))))}}I()(id,"propTypes",{content:xe.a.object.isRequired,onFinished:xe.a.func.isRequired,roomId:xe.a.string.isRequired,eventId:xe.a.string.isRequired});var od=s(454),rd=s(453);class ld extends i.a.Component{constructor(){super(),I()(this,"_onStoreUpdate",()=>{const e=od.f.sharedInstance();this.setState({phase:e.phase})});const e=od.f.sharedInstance();e.on("update",this._onStoreUpdate),e.start(),this.state={phase:e.phase}}componentWillUnmount(){const e=od.f.sharedInstance();e.off("update",this._onStoreUpdate),e.stop()}render(){const e=d.getComponent("auth.AuthPage"),t=d.getComponent("auth.CompleteSecurityBody"),{phase:s}=this.state;let n,a;if(s===od.e)n=i.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),a=Object(l.a)("Verify this login");else if(s===od.c)n=i.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_verified"}),a=Object(l.a)("Session verified");else if(s===od.b)n=i.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),a=Object(l.a)("Are you sure?");else{if(s!==od.a)throw new Error("Unknown phase "+s);n=i.a.createElement("span",{className:"mx_CompleteSecurity_headerIcon mx_E2EIcon_warning"}),a=Object(l.a)("Verify this login")}return i.a.createElement(e,null,i.a.createElement(t,null,i.a.createElement("h2",{className:"mx_CompleteSecurity_header"},n,a),i.a.createElement("div",{className:"mx_CompleteSecurity_body"},i.a.createElement(rd.a,{onFinished:this.props.onFinished}))))}}I()(ld,"propTypes",{onFinished:xe.a.func.isRequired});class cd extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_CompleteSecurityBody"},this.props.children)}}class dd extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{authError:null,uiaStage:null,uiaStagePhase:null}),I()(this,"_onAuthFinished",(e,t)=>{e?this.props.onFinished(!0,t):t===Ve?this.props.onFinished(!1,null):this.setState({authError:t})}),I()(this,"_onUpdateStagePhase",(e,t)=>{this.setState({uiaStage:e,uiaStagePhase:t})}),I()(this,"_onDismissClick",()=>{this.props.onFinished(!1)})}_getDefaultDialogAesthetics(){const e={[Be.c.PHASE_PREAUTH]:{title:Object(l.a)("Use Single Sign On to continue"),body:Object(l.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(l.a)("Single Sign On"),continueKind:"primary"},[Be.c.PHASE_POSTAUTH]:{title:Object(l.a)("Confirm to continue"),body:Object(l.a)("Click the button below to confirm your identity."),continueText:Object(l.a)("Confirm"),continueKind:"primary"}};return{[Be.c.LOGIN_TYPE]:e,[Be.c.UNSTABLE_LOGIN_TYPE]:e}}render(){const e=d.getComponent("structures.InteractiveAuth"),t=d.getComponent("views.dialogs.BaseDialog");let s=this.state.authError?"Error":this.props.title||Object(l.a)("Authentication"),n=this.state.authError?null:this.props.body,a=null,o=null;const r=this.props.aestheticsForStagePhases||this._getDefaultDialogAesthetics();if(!this.state.authError&&r&&r[this.state.uiaStage]){const e=r[this.state.uiaStage][this.state.uiaStagePhase];e&&e.title&&(s=e.title),e&&e.body&&(n=e.body),e&&e.continueText&&(a=e.continueText),e&&e.continueKind&&(o=e.continueKind)}let c;return c=this.state.authError?i.a.createElement("div",{id:"mx_Dialog_content"},i.a.createElement("div",{role:"alert"},this.state.authError.message||this.state.authError.toString()),i.a.createElement("br",null),i.a.createElement(pe.a,{onClick:this._onDismissClick,className:"mx_GeneralButton",autoFocus:"true"},Object(l.a)("Dismiss"))):i.a.createElement("div",{id:"mx_Dialog_content"},n,i.a.createElement(e,{ref:this._collectInteractiveAuth,matrixClient:this.props.matrixClient,authData:this.props.authData,makeRequest:this.props.makeRequest,onAuthFinished:this._onAuthFinished,onStagePhaseChange:this._onUpdateStagePhase,continueText:a,continueKind:o})),i.a.createElement(t,{className:"mx_InteractiveAuthDialog",onFinished:this.props.onFinished,title:s,contentId:"mx_Dialog_content"},c)}}I()(dd,"propTypes",{matrixClient:xe.a.object.isRequired,authData:xe.a.shape({flows:xe.a.array,params:xe.a.object,session:xe.a.string}),makeRequest:xe.a.func.isRequired,onFinished:xe.a.func.isRequired,title:xe.a.string,body:xe.a.string,aestheticsForStagePhases:xe.a.object});class md extends i.a.PureComponent{constructor(e){super(e),I()(this,"_doBootstrapUIAuth",async e=>{if(this.state.canUploadKeysWithPasswordOnly&&this.state.accountPassword)await e({type:"m.login.password",identifier:{type:"m.id.user",user:ee.a.get().getUserId()},user:ee.a.get().getUserId(),password:this.state.accountPassword});else if(this.props.tokenLogin)await e({});else{const t={[Be.c.PHASE_PREAUTH]:{title:Object(l.a)("Use Single Sign On to continue"),body:Object(l.a)("To continue, use Single Sign On to prove your identity."),continueText:Object(l.a)("Single Sign On"),continueKind:"primary"},[Be.c.PHASE_POSTAUTH]:{title:Object(l.a)("Confirm encryption setup"),body:Object(l.a)("Click the button below to confirm setting up encryption."),continueText:Object(l.a)("Confirm"),continueKind:"primary"}},{finished:s}=De.a.createTrackedDialog("Cross-signing keys dialog","",dd,{title:Object(l.a)("Setting up keys"),matrixClient:ee.a.get(),makeRequest:e,aestheticsForStagePhases:{[Be.c.LOGIN_TYPE]:t,[Be.c.UNSTABLE_LOGIN_TYPE]:t}}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")}}),I()(this,"_bootstrapCrossSigning",async()=>{this.setState({error:null});const e=ee.a.get();try{await e.bootstrapCrossSigning({authUploadDeviceSigningKeys:this._doBootstrapUIAuth}),this.props.onFinished(!0)}catch(e){if(this.props.tokenLogin)return void this.props.onFinished();this.setState({error:e}),console.error("Error bootstrapping cross-signing",e)}}),I()(this,"_onCancel",()=>{this.props.onFinished(!1)}),this.state={error:null,canUploadKeysWithPasswordOnly:null,accountPassword:e.accountPassword||""},this.state.accountPassword?this.state.canUploadKeysWithPasswordOnly=!0:this._queryKeyUploadAuth()}componentDidMount(){this._bootstrapCrossSigning()}async _queryKeyUploadAuth(){try{await ee.a.get().uploadDeviceSigningKeys(null,{}),console.log("uploadDeviceSigningKeys unexpectedly succeeded without UI auth!")}catch(e){if(!e.data||!e.data.flows)return void console.log("uploadDeviceSigningKeys advertised no flows!");const t=e.data.flows.some(e=>1===e.stages.length&&"m.login.password"===e.stages[0]);this.setState({canUploadKeysWithPasswordOnly:t})}}render(){let e;return e=this.state.error?i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Unable to set up keys")),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement(da.a,{primaryButton:Object(l.a)("Retry"),onPrimaryButtonClick:this._bootstrapCrossSigning,onCancel:this._onCancel}))):i.a.createElement("div",null,i.a.createElement(Je.a,null)),i.a.createElement(cs.a,{className:"mx_CreateCrossSigningDialog",onFinished:this.props.onFinished,title:Object(l.a)("Setting up keys"),hasCancel:!1,fixedWidth:!1},i.a.createElement("div",null,e))}}I()(md,"propTypes",{accountPassword:xe.a.string,tokenLogin:xe.a.bool});class hd extends i.a.Component{render(){return i.a.createElement(Ea,null,i.a.createElement(cd,null,i.a.createElement(md,{onFinished:this.props.onFinished,accountPassword:this.props.accountPassword,tokenLogin:this.props.tokenLogin})))}}I()(hd,"propTypes",{onFinished:xe.a.func.isRequired,accountPassword:xe.a.string,tokenLogin:xe.a.bool});class ud{constructor(e,t){this.client=Fe.p({baseUrl:e,idBaseUrl:t}),this.clientSecret=this.client.generateClientSecret(),this.identityServerDomain=t?t.split("://")[1]:null}resetPassword(e,t){return this.password=t,this.client.requestPasswordEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_NOT_FOUND"===e.errcode?e.message=Object(l.a)("This email address was not found"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async checkEmailLinkClicked(){const e={sid:this.sessionId,client_secret:this.clientSecret};try{await this.client.setPassword({type:"m.login.email.identity",threepid_creds:e,threepidCreds:e},this.password)}catch(e){throw 401===e.httpStatus?e.message=Object(l.a)("Failed to verify email address: make sure you clicked the link in the email"):404===e.httpStatus?e.message=Object(l.a)("Your email address does not appear to be associated with a Matrix ID on this Homeserver."):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}}class pd extends i.a.Component{constructor(e){super(e),I()(this,"state",{phase:1,email:"",password:"",password2:"",errorText:null,serverIsAlive:!0,serverErrorIsFatal:!1,serverDeadError:""}),I()(this,"onVerify",async e=>{if(e.preventDefault(),this.reset)try{await this.reset.checkEmailLinkClicked(),this.setState({phase:4})}catch(e){this.showErrorDialog(e.message)}else console.error("onVerify called before submitPasswordReset!")}),I()(this,"onSubmitForm",async e=>{if(e.preventDefault(),this.state.email)if(this.state.password&&this.state.password2)if(this.state.password!==this.state.password2)this.showErrorDialog(Object(l.a)("New passwords must match each other."));else{if(Ma.a.isPasswordValid(this.state.password).isValid){const e=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Forgot Password Warning","",e,{title:Object(l.a)("Warning!"),description:i.a.createElement("div",null,Object(l.a)("Changing your password will reset any end-to-end encryption keys on all of your devices, making encrypted chat history unreadable. Set up Key Backup or export your room keys from another device before resetting your password.")),button:Object(l.a)("Continue"),onFinished:e=>{e&&this.submitPasswordReset(this.state.email,this.state.password)}})}else this.showErrorDialog(Object(l.a)("This password is too weak. It must include a lower-case letter, an upper-case letter, a number and a symbol and be at a minimum 8 characters in length."))}else this.showErrorDialog(Object(l.a)("A new password must be entered."));else this.showErrorDialog(Object(l.a)("The email address linked to your account must be entered."))}),I()(this,"onInputChanged",(e,t)=>{this.setState({[e]:t.target.value})}),I()(this,"onLoginClick",e=>{e.preventDefault(),e.stopPropagation(),this.props.onLoginClick()}),y.a.instance.track("onboarding_forgot_password_begin")}componentDidMount(){this.reset=null}submitPasswordReset(e,t){this.setState({phase:2}),E.a.discoverPlatform(e).then(s=>{const n=e.toLowerCase();this.reset=new ud(s,s),this.reset.resetPassword(n,t).then(()=>{this.setState({phase:3})},e=>{this.showErrorDialog(Object(l.a)("Failed to send email")+": "+e.message),this.setState({phase:1})})}).catch(e=>{this.showErrorDialog(Object(l.a)("Failed to send email")+": "+e.message),this.setState({phase:1})})}showErrorDialog(e,t){const s=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Forgot Password Error","",s,{title:t,description:e})}renderForgot(){const e=d.getComponent("elements.Field");let t=null;const n=this.state.errorText;let a;if(n&&(t=i.a.createElement("div",{className:"mx_Login_error"},n)),!this.state.serverIsAlive){const e=L()({mx_Login_error:!0,mx_Login_serverError:!0,mx_Login_serverErrorNonFatal:!this.state.serverErrorIsFatal});a=i.a.createElement("div",{className:e},this.state.serverDeadError)}return i.a.createElement("div",null,t,a,i.a.createElement("form",{onSubmit:this.onSubmitForm},i.a.createElement("div",{className:"mx_AuthBody_fieldRow"},i.a.createElement(e,{name:"reset_email",type:"text",label:Object(l.a)("Email"),value:this.state.email,onChange:this.onInputChanged.bind(this,"email"),autoFocus:!0,onFocus:()=>y.a.instance.track("onboarding_forgot_password_email_focus"),onBlur:()=>y.a.instance.track("onboarding_forgot_password_email_blur")})),i.a.createElement("div",{className:"mx_AuthBody_fieldRow"},i.a.createElement(Ba.a,{name:"reset_password",minScore:0,value:this.state.password,onChange:this.onInputChanged.bind(this,"password"),onValidate:()=>{},onFocus:()=>y.a.instance.track("onboarding_forgot_password_newPassword_focus"),onBlur:()=>y.a.instance.track("onboarding_forgot_password_newPassword_blur"),autoComplete:"new-password"}),i.a.createElement(e,{name:"reset_password_confirm",type:"password",label:Object(l.a)("Confirm"),value:this.state.password2,onChange:this.onInputChanged.bind(this,"password2"),onFocus:()=>y.a.instance.track("onboarding_forgot_password_newPassword2_focus"),onBlur:()=>y.a.instance.track("onboarding_forgot_password_newPassword2_blur"),autoComplete:"new-password"}),i.a.createElement(et.a,{tooltip:Object(l.a)("Your password must include a lower-case letter, an upper-case letter, a number and a symbol and be at a minimum 8 characters in length."),tooltipClass:"mx_Tooltip_dark"},i.a.createElement("img",{className:"tc_PasswordHelper",src:s(350),width:25,height:25,alt:"Password Complexity Helper"}))),i.a.createElement("span",null,Object(l.a)("A verification email will be sent to your inbox to confirm setting your new password.")),i.a.createElement("input",{className:"mx_Login_submit",type:"submit",value:Object(l.a)("Send Reset Email")})),i.a.createElement("a",{className:"mx_AuthBody_changeFlow",onClick:this.onLoginClick,href:"#"},Object(l.a)("Sign in instead")))}renderSendingEmail(){const e=d.getComponent("elements.Spinner");return i.a.createElement(e,null)}renderEmailSent(){return i.a.createElement("div",null,Object(l.a)("If a Tchap account exists, an email has been sent to the address: %(emailAddress)s. Once you've followed the link it contains, click below.",{emailAddress:this.state.email}),i.a.createElement("br",null),i.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.onVerify,value:Object(l.a)("I have verified my email address")}))}renderDone(){return i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Your password has been reset.")),i.a.createElement("p",null,Object(l.a)("You have been logged out of all sessions and will no longer receive push notifications. To re-enable notifications, sign in again on each device.")),i.a.createElement("input",{className:"mx_Login_submit",type:"button",onClick:this.props.onComplete,value:Object(l.a)("Return to login screen")}))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody");let s;switch(this.state.phase){case 1:s=this.renderForgot();break;case 2:s=this.renderSendingEmail();break;case 3:s=this.renderEmailSent();break;case 4:s=this.renderDone()}return i.a.createElement(Ea,null,i.a.createElement(e,null),i.a.createElement(t,null,i.a.createElement("h2",null," ",Object(l.a)("Set a new password")," "),s))}}I()(pd,"propTypes",{onLoginClick:xe.a.func,onComplete:xe.a.func.isRequired});const gd=1,fd=2,bd=3,vd=4,_d=5,yd={"m.login.password":fd,"m.login.cas":bd,"m.login.sso":vd};class Ed extends i.a.Component{constructor(){super(),I()(this,"onClearAll",()=>{const e=d.getComponent("dialogs.ConfirmWipeDeviceDialog");De.a.createTrackedDialog("Clear Data","Soft Logout",e,{onFinished:e=>{e&&(console.log("Clearing data from soft-logged-out session"),Le.h())}})}),I()(this,"onPasswordChange",e=>{this.setState({password:e.target.value})}),I()(this,"onForgotPassword",()=>{m.a.dispatch({action:"start_password_recovery"})}),I()(this,"onPasswordLogin",async e=>{e.preventDefault(),e.stopPropagation(),this.setState({busy:!0});const t=ee.a.get().getHomeserverUrl(),s=ee.a.get().getIdentityServerUrl(),n={identifier:{type:"m.id.user",user:ee.a.get().getUserId()},password:this.state.password,device_id:ee.a.get().getDeviceId()};let a=null;try{a=await Object(_a.c)(t,s,"m.login.password",n)}catch(e){let t=Object(l.a)("Failed to re-authenticate due to a homeserver problem");return"M_FORBIDDEN"!==e.errcode||401!==e.httpStatus&&403!==e.httpStatus||(t=Object(l.a)("Incorrect password")),void this.setState({busy:!1,errorText:t})}Le.d(a).catch(e=>{console.error(e),this.setState({busy:!1,errorText:Object(l.a)("Failed to re-authenticate")})})}),this.state={loginView:gd,keyBackupNeeded:!0,busy:!1,password:"",errorText:""}}componentDidMount(){if(!Le.f())return void m.a.dispatch({action:"start_login"});this._initLogin();const e=ee.a.get();e.isCryptoEnabled()&&e.countSessionsNeedingBackup().then(e=>{this.setState({keyBackupNeeded:e>0})})}async _initLogin(){const e=this.props.realQueryParams;if(e&&e.loginToken)return this.setState({loginView:gd}),void this.trySsoLogin();const t=ee.a.get(),s=(await t.loginFlows()).flows,n=s.map(e=>yd[e.type]).filter(e=>!!e)[0]||_d;this.setState({flows:s,loginView:n})}async trySsoLogin(){this.setState({busy:!0});const e=localStorage.getItem(Gt.a),t=localStorage.getItem(Gt.c)||ee.a.get().getIdentityServerUrl(),s={token:this.props.realQueryParams.loginToken,device_id:ee.a.get().getDeviceId()};let n=null;try{n=await Object(_a.c)(e,t,"m.login.token",s)}catch(e){return console.error(e),void this.setState({busy:!1,loginView:_d})}Le.d(n).then(()=>{this.props.onTokenLoginCompleted&&this.props.onTokenLoginCompleted()}).catch(e=>{console.error(e),this.setState({busy:!1,loginView:_d})})}_renderSignInSection(){if(this.state.loginView===gd){const e=d.getComponent("elements.Spinner");return i.a.createElement(e,null)}let e=null;if(this.state.keyBackupNeeded&&(e=Object(l.a)("Regain access to your account and recover encryption keys stored in this session. Without them, you won’t be able to read all of your secure messages in any session.")),this.state.loginView===fd){const t=d.getComponent("elements.Field"),s=d.getComponent("elements.AccessibleButton");let n=null;return this.state.errorText&&(n=i.a.createElement("span",{className:"mx_Login_error"},this.state.errorText)),e||(e=Object(l.a)("Enter your password to sign in and regain access to your account.")),i.a.createElement("form",{onSubmit:this.onPasswordLogin},i.a.createElement("p",null,e),n,i.a.createElement(t,{type:"password",label:Object(l.a)("Password"),onChange:this.onPasswordChange,value:this.state.password,disabled:this.state.busy}),i.a.createElement(s,{onClick:this.onPasswordLogin,kind:"primary",type:"submit",disabled:this.state.busy},Object(l.a)("Sign In")),i.a.createElement(s,{onClick:this.onForgotPassword,kind:"link"},Object(l.a)("Forgotten your password?")))}if(this.state.loginView===vd||this.state.loginView===bd){e||(e=Object(l.a)("Sign in and regain access to your account."));const t=this.state.loginView===bd?"cas":"sso",s=this.state.flows.find(e=>e.type==="m.login."+t);return i.a.createElement("div",null,i.a.createElement("p",null,e),i.a.createElement(Aa,{matrixClient:ee.a.get(),flow:s,loginType:t,fragmentAfterLogin:this.props.fragmentAfterLogin,primary:!this.state.flows.find(e=>"m.login.password"===e.type)}))}return i.a.createElement("p",null,Object(l.a)("You cannot sign in to your account. Please contact your homeserver admin for more information."))}render(){const e=d.getComponent("auth.AuthHeader"),t=d.getComponent("auth.AuthBody"),s=d.getComponent("elements.AccessibleButton");return i.a.createElement(Ea,null,i.a.createElement(e,null),i.a.createElement(t,null,i.a.createElement("h2",null,Object(l.a)("You're signed out")),i.a.createElement("h3",null,Object(l.a)("Sign in")),i.a.createElement("div",null,this._renderSignInSection()),i.a.createElement("h3",null,Object(l.a)("Clear personal data")),i.a.createElement("p",null,Object(l.a)("Warning: Your personal data (including encryption keys) is still stored in this session. Clear it if you're finished using this session, or want to sign in to another account.")),i.a.createElement("div",null,i.a.createElement(s,{onClick:this.onClearAll,kind:"danger"},Object(l.a)("Clear all data")))))}}I()(Ed,"propTypes",{realQueryParams:xe.a.object,onTokenLoginCompleted:xe.a.func});class Cd extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_AuthBody"},this.props.children)}}class wd extends i.a.Component{render(){return i.a.createElement("div",{className:"mx_AuthFooter"},i.a.createElement("a",{href:"https://matrix.org",target:"_blank",rel:"noreferrer noopener"},Object(l.a)("powered by Matrix")))}}class Sd extends i.a.Component{render(){const e=d.getComponent("auth.AuthHeaderLogo"),t=d.getComponent("views.auth.LanguageSelector");return i.a.createElement("div",{className:"mx_AuthHeader"},i.a.createElement("span",{className:"tc_LoginView_Header_text"},"TCHAP"),i.a.createElement(e,null),i.a.createElement(t,{disabled:this.props.disableLanguageSelector}))}}I()(Sd,"propTypes",{disableLanguageSelector:xe.a.bool});class xd extends i.a.PureComponent{render(){return i.a.createElement("div",{className:"mx_AuthHeaderLogo"},"Tchap")}}var Rd=s(1466);function Od(e){Object(l.d)()!==e&&(F.a.setValue("language",null,Qe.a.DEVICE,e),qe.a.get().reload())}function kd({disabled:e}){if(c.a.get().disable_login_language_selector)return i.a.createElement("div",null);const t=d.getComponent("views.elements.LanguageDropdown");return i.a.createElement(t,{className:"mx_AuthBody_language",onOptionChange:Od,value:Object(l.d)(),disabled:e})}Object(l.b)("Sign in with SSO");class Id extends i.a.PureComponent{constructor(e){super(e),y.a.instance.track("onboarding_welcome")}render(){const e=d.getComponent("structures.EmbeddedPage"),t=d.getComponent("auth.LanguageSelector"),s=c.a.get().embeddedPages;let n=null;return s&&(n=s.welcomeUrl),n||(n="welcome.html"),i.a.createElement(Ea,null,i.a.createElement("div",{className:L()("mx_Welcome",{mx_WelcomePage_registrationDisabled:!F.a.getValue(Xe.a.Registration)})},i.a.createElement(e,{className:"mx_WelcomePage",url:n,replaceMap:{"$riot:ssoUrl":"#/start_sso","$riot:casUrl":"#/start_cas"}}),i.a.createElement(t,null)))}}class Td extends i.a.Component{constructor(e){super(e),I()(this,"_onStatusMessageCommitted",()=>{this.setState({message:this.comittedStatusMessage,waiting:!1})}),I()(this,"_onClearClick",e=>{ee.a.get()._unstable_setStatusMessage(""),this.setState({waiting:!0})}),I()(this,"_onSubmit",e=>{e.preventDefault(),ee.a.get()._unstable_setStatusMessage(this.state.message),this.setState({waiting:!0})}),I()(this,"_onStatusChange",e=>{this.setState({message:e.target.value})}),this.state={message:this.comittedStatusMessage}}componentDidMount(){const{user:e}=this.props;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props;e&&e.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted)}get comittedStatusMessage(){return this.props.user?this.props.user._unstable_statusMessage:""}render(){const e=d.getComponent("views.elements.Spinner");let t;t=this.comittedStatusMessage?this.state.message===this.comittedStatusMessage?i.a.createElement(pe.a,{className:"mx_StatusMessageContextMenu_clear",onClick:this._onClearClick},i.a.createElement("span",null,Object(l.a)("Clear status"))):i.a.createElement(pe.a,{className:"mx_StatusMessageContextMenu_submit",onClick:this._onSubmit},i.a.createElement("span",null,Object(l.a)("Update status"))):i.a.createElement(pe.a,{className:"mx_StatusMessageContextMenu_submit",disabled:!this.state.message,onClick:this._onSubmit},i.a.createElement("span",null,Object(l.a)("Set status")));let s=null;this.state.waiting&&(s=i.a.createElement(e,{w:"24",h:"24"}));const n=i.a.createElement("form",{className:"mx_StatusMessageContextMenu_form",autoComplete:"off",onSubmit:this._onSubmit},i.a.createElement("input",{type:"text",className:"mx_StatusMessageContextMenu_message",key:"message",placeholder:Object(l.a)("Set a new status..."),autoFocus:!0,maxLength:"60",value:this.state.message,onChange:this._onStatusChange}),i.a.createElement("div",{className:"mx_StatusMessageContextMenu_actionContainer"},t,s));return i.a.createElement("div",{className:"mx_StatusMessageContextMenu"},n)}}I()(Td,"propTypes",{user:xe.a.object});class jd extends i.a.Component{constructor(e){super(e),I()(this,"_onStatusMessageCommitted",()=>{this.setState({hasStatus:this.hasStatus})}),I()(this,"openMenu",()=>{this.setState({menuDisplayed:!0})}),I()(this,"closeMenu",()=>{this.setState({menuDisplayed:!1})}),this.state={hasStatus:this.hasStatus,menuDisplayed:!1},this._button=Object(a.createRef)()}componentDidMount(){if(this.props.member.userId!==ee.a.get().getUserId())throw new Error("Cannot use MemberStatusMessageAvatar on anyone but the logged in user");if(!F.a.getValue("feature_custom_status"))return;const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}componentWillUnmount(){const{user:e}=this.props.member;e&&e.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted)}get hasStatus(){const{user:e}=this.props.member;return!!e&&!!e._unstable_statusMessage}render(){const e=i.a.createElement(Wa.a,{member:this.props.member,title:this.props.member.rawDisplayName,width:this.props.width,height:this.props.height,resizeMethod:this.props.resizeMethod});if(!F.a.getValue("feature_custom_status"))return e;const t=L()({mx_MemberStatusMessageAvatar:!0,mx_MemberStatusMessageAvatar_hasStatus:this.state.hasStatus});let s;if(this.state.menuDisplayed){const e=this._button.current.getBoundingClientRect(),t=16,a=1;s=i.a.createElement(n.b,{chevronOffset:(e.width-t)/2,chevronFace:"bottom",left:e.left+window.pageXOffset,top:e.top+window.pageYOffset-a,menuWidth:226,onFinished:this.closeMenu},i.a.createElement(Td,{user:this.props.member.user,onFinished:this.closeMenu}))}return i.a.createElement(i.a.Fragment,null,i.a.createElement(n.c,{className:t,inputRef:this._button,onClick:this.openMenu,isExpanded:this.state.menuDisplayed,label:Object(l.a)("User Status")},e),s)}}I()(jd,"propTypes",{member:xe.a.object.isRequired,width:xe.a.number,height:xe.a.number,resizeMethod:xe.a.string}),I()(jd,"defaultProps",{width:40,height:40,resizeMethod:"crop"});class Nd extends i.a.Component{constructor(e){super(e),this.resize=this.resize.bind(this)}componentDidMount(){this.resize=this.resize.bind(this),window.addEventListener("resize",this.resize)}componentWillUnmount(){window.removeEventListener("resize",this.resize)}resize(){this.props.onResize&&this.props.onResize()}render(){return i.a.createElement("div",null,this.props.element)}}I()(Nd,"propTypes",{element:xe.a.element.isRequired,onResize:xe.a.func});class Pd extends i.a.Component{render(){return i.a.createElement("div",null,this.props.message)}}I()(Pd,"propTypes",{message:xe.a.string.isRequired});class Dd extends i.a.Component{constructor(e){super(e),this._onClickReject=this._onClickReject.bind(this)}componentDidMount(){this._unmounted=!1}componentWillUnmount(){this._unmounted=!0}_onClickReject(){const e=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Reject community invite","",e,{title:Object(l.a)("Reject invitation"),description:Object(l.a)("Are you sure you want to reject the invitation?"),onFinished:async e=>{if(!e)return;const t=d.getComponent("elements.Spinner"),s=De.a.createDialog(t,null,"mx_Dialog_spinner");try{await sa.a.leaveGroup(this.props.group.groupId)}catch(e){console.error("Error rejecting community invite: ",e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Error rejecting invite","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Unable to reject invite")})}finally{s.close()}}}),this.props.onFinished&&this.props.onFinished()}render(){return i.a.createElement("div",null,i.a.createElement(n.f,{className:"mx_RoomTileContextMenu_leave",onClick:this._onClickReject},i.a.createElement("img",{className:"mx_RoomTileContextMenu_tag_icon",src:s(1467),width:"15",height:"15",alt:""}),Object(l.a)("Reject")))}}function Ad(e){const{status:t}=e;if((!t||t===Fe.b.SENT)&&!e.isRedacted())if("m.room.message"===e.getType()){const t=e.getContent();if(t.msgtype&&"m.bad.encrypted"!==t.msgtype&&t.hasOwnProperty("body"))return!0}else if("m.sticker"===e.getType())return!0;return!1}function Ud(e){if(e.status===Fe.b.CANCELLED||"m.room.message"!==e.getType()||e.isRedacted())return!1;const t=e.getOriginalContent(),{msgtype:s}=t;return("m.text"===s||"m.emote"===s)&&t.body&&"string"==typeof t.body&&e.getSender()===ee.a.get().getUserId()}I()(Dd,"propTypes",{group:xe.a.instanceOf(Fe.e).isRequired,onFinished:xe.a.func});function Md(e,t,s){const n=e.getLiveTimeline().getEvents().concat(e.getPendingEvents()),a=n.length-1,i=t?1:-1,o=t?0:a;let r=t?a:0;s||(r=Math.min(Math.max(0,o+100*i),a));let l=!s;for(let e=o;e!==r+i;e+=i){const t=n[e];if(l||t.getId()!==s){if(l&&!Object(Oc.a)(t)&&Ud(t))return t}else l=!0,r=Math.min(Math.max(0,e+100*i),a)}}function Ld(e){return e===Fe.b.QUEUED||e===Fe.b.NOT_SENT}class Fd extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{canRedact:!1,canPin:!1}),I()(this,"_checkPermissions",()=>{const e=ee.a.get(),t=e.getRoom(this.props.mxEvent.getRoomId()),s=t.currentState.maySendRedactionForEvent(this.props.mxEvent,e.credentials.userId)&&this.props.mxEvent.getType()!==Lo.a.RoomServerAcl;let n=t.currentState.mayClientSendStateEvent("m.room.pinned_events",e);F.a.getValue("feature_pinning")||(n=!1),this.setState({canRedact:s,canPin:n})}),I()(this,"onResendClick",()=>{$c.resend(this.props.mxEvent),this.closeMenu()}),I()(this,"onResendEditClick",()=>{$c.resend(this.props.mxEvent.replacingEvent()),this.closeMenu()}),I()(this,"onResendRedactionClick",()=>{$c.resend(this.props.mxEvent.localRedactionEvent()),this.closeMenu()}),I()(this,"onResendReactionsClick",()=>{for(const e of this._getUnsentReactions())$c.resend(e);this.closeMenu()}),I()(this,"onReportEventClick",()=>{const e=d.getComponent("dialogs.ReportEventDialog");De.a.createTrackedDialog("Report Event","",e,{mxEvent:this.props.mxEvent},"mx_Dialog_reportEvent"),this.closeMenu()}),I()(this,"onRedactClick",()=>{const e=d.getComponent("dialogs.ConfirmRedactDialog");De.a.createTrackedDialog("Confirm Redact Dialog","",e,{onFinished:async(e,t)=>{if(!e)return;const s=ee.a.get();try{await s.redactEvent(this.props.mxEvent.getRoomId(),this.props.mxEvent.getId(),void 0,t?{reason:t}:{})}catch(e){const t=e.errcode||e.statusCode;if(void 0!==t){const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("You cannot delete this message","",e,{title:Object(l.a)("Error"),description:Object(l.a)("You cannot delete this message. (%(code)s)",{code:t})})}}}},"mx_Dialog_confirmredact"),this.closeMenu()}),I()(this,"onCancelSendClick",()=>{const e=this.props.mxEvent,t=e.replacingEvent(),s=e.localRedactionEvent(),n=this._getPendingReactions();if(t&&Ld(t.status)&&$c.removeFromQueue(t),s&&Ld(s.status)&&$c.removeFromQueue(s),n.length)for(const e of n)$c.removeFromQueue(e);Ld(e.status)&&$c.removeFromQueue(this.props.mxEvent),this.closeMenu()}),I()(this,"onForwardClick",()=>{m.a.dispatch({action:"forward_event",event:this.props.mxEvent}),this.closeMenu()}),I()(this,"onPinClick",()=>{ee.a.get().getStateEvent(this.props.mxEvent.getRoomId(),"m.room.pinned_events","").catch(e=>{if("M_NOT_FOUND"===e.errcode)return null;throw e}).then(e=>{const t=(e?e.pinned:[])||[];t.includes(this.props.mxEvent.getId())?t.splice(t.indexOf(this.props.mxEvent.getId()),1):t.push(this.props.mxEvent.getId());ee.a.get().sendStateEvent(this.props.mxEvent.getRoomId(),"m.room.pinned_events",{pinned:t},"")}),this.closeMenu()}),I()(this,"closeMenu",()=>{this.props.onFinished&&this.props.onFinished()}),I()(this,"onUnhidePreviewClick",()=>{this.props.eventTileOps&&this.props.eventTileOps.unhideWidget(),this.closeMenu()}),I()(this,"onQuoteClick",()=>{m.a.dispatch({action:"quote",event:this.props.mxEvent}),this.closeMenu()}),I()(this,"onPermalinkClick",e=>{e.preventDefault();const t=d.getComponent("dialogs.ShareDialog");De.a.createTrackedDialog("share room message dialog","",t,{target:this.props.mxEvent,permalinkCreator:this.props.permalinkCreator}),this.closeMenu()}),I()(this,"onCollapseReplyThreadClick",()=>{this.props.collapseReplyThread(),this.closeMenu()})}componentDidMount(){ee.a.get().on("RoomMember.powerLevel",this._checkPermissions),this._checkPermissions()}componentWillUnmount(){const e=ee.a.get();e&&e.removeListener("RoomMember.powerLevel",this._checkPermissions)}_isPinned(){const e=ee.a.get().getRoom(this.props.mxEvent.getRoomId()).currentState.getStateEvents("m.room.pinned_events","");if(!e)return!1;const t=e.getContent();return t.pinned&&Array.isArray(t.pinned)&&t.pinned.includes(this.props.mxEvent.getId())}_getReactions(e){const t=ee.a.get().getRoom(this.props.mxEvent.getRoomId()),s=this.props.mxEvent.getId();return t.getPendingEvents().filter(t=>{const n=t.getRelation();return n&&"m.annotation"===n.rel_type&&n.event_id===s&&e(t)})}_getPendingReactions(){return this._getReactions(e=>Ld(e.status))}_getUnsentReactions(){return this._getReactions(e=>e.status===Fe.b.NOT_SENT)}render(){const e=ee.a.get().getUserId(),t=this.props.mxEvent,s=t.status,a=t.replacingEvent()&&t.replacingEvent().status,o=t.localRedactionEvent()&&t.localRedactionEvent().status,r=this._getUnsentReactions().length,c=this._getPendingReactions().length,d=Ld(t.status)||Ld(a)||Ld(o)||0!==c;let m,h,u,p,g,f,b,v,_,y,E,C;const w=!s||s===Fe.b.SENT;let S;t.isRedacted()||(s===Fe.b.NOT_SENT&&(m=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendClick},Object(l.a)("Resend"))),a===Fe.b.NOT_SENT&&(h=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendEditClick},Object(l.a)("Resend edit"))),0!==r&&(u=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendReactionsClick},Object(l.a)("Resend %(unsentCount)s reaction(s)",{unsentCount:r})))),o===Fe.b.NOT_SENT&&(p=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onResendRedactionClick},Object(l.a)("Resend removal"))),w&&this.state.canRedact&&(g=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field mx_MessageContextMenu_field_remove",onClick:this.onRedactClick},Object(l.a)("Remove"))),d&&(f=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onCancelSendClick},Object(l.a)("Cancel Sending"))),Ad(t)&&(b=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field mx_MessageContextMenu_field_forward",onClick:this.onForwardClick},Object(l.a)("Forward Message")),this.state.canPin&&(v=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onPinClick},this._isPinned()?Object(l.a)("Unpin Message"):Object(l.a)("Pin Message")))),this.props.eventTileOps&&this.props.eventTileOps.isWidgetHidden()&&(_=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onUnhidePreviewClick},Object(l.a)("Unhide Preview"))),this.props.permalinkCreator&&(S=this.props.permalinkCreator.forEvent(this.props.mxEvent.getId()));const x=i.a.createElement(n.f,{element:"a",className:"mx_MessageContextMenu_field mx_MessageContextMenu_field_share",onClick:this.onPermalinkClick,href:S,target:"_blank",rel:"noreferrer noopener"},t.isRedacted()||"m.room.message"!==t.getType()?Object(l.a)("Share Permalink"):Object(l.a)("Share Message"));let R;return this.props.eventTileOps&&(E=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field mx_MessageContextMenu_field_quote",onClick:this.onQuoteClick},Object(l.a)("Quote"))),"string"==typeof t.event.content.external_url&&Object(rr.d)(t.event.content.external_url)&&(y=i.a.createElement(n.f,{element:"a",className:"mx_MessageContextMenu_field",target:"_blank",rel:"noreferrer noopener",onClick:this.closeMenu,href:t.event.content.external_url},Object(l.a)("Source URL"))),this.props.collapseReplyThread&&(C=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field",onClick:this.onCollapseReplyThreadClick},Object(l.a)("Collapse Reply Thread"))),t.getSender()!==e&&(R=i.a.createElement(n.f,{className:"mx_MessageContextMenu_field mx_MessageContextMenu_field_report",onClick:this.onReportEventClick},Object(l.a)("Report Content"))),i.a.createElement("div",{className:"mx_MessageContextMenu"},m,h,u,p,g,f,b,v,_,x,E,y,C,R)}}I()(Fd,"propTypes",{mxEvent:xe.a.object.isRequired,eventTileOps:xe.a.object,collapseReplyThread:xe.a.func,onFinished:xe.a.func});class Bd extends i.a.Component{constructor(){super(),this._onViewCommunityClick=this._onViewCommunityClick.bind(this),this._onRemoveClick=this._onRemoveClick.bind(this)}_onViewCommunityClick(){m.a.dispatch({action:"view_group",group_id:this.props.tag}),this.props.onFinished()}_onRemoveClick(){m.a.dispatch(zs.removeTag(this.context,this.props.tag)),this.props.onFinished()}render(){return i.a.createElement("div",null,i.a.createElement(n.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_viewCommunity",onClick:this._onViewCommunityClick},Object(l.a)("View Community")),i.a.createElement("hr",{className:"mx_TagTileContextMenu_separator",role:"separator"}),i.a.createElement(n.f,{className:"mx_TagTileContextMenu_item mx_TagTileContextMenu_hideCommunity",onClick:this._onRemoveClick},Object(l.a)("Hide")))}}I()(Bd,"propTypes",{tag:xe.a.string.isRequired,onFinished:xe.a.func.isRequired}),I()(Bd,"contextType",b.a);const Vd={"mx-user-id":Object(l.b)("Matrix ID"),"mx-room-id":Object(l.b)("Matrix Room ID"),email:Object(l.b)("email address")};class Wd extends i.a.Component{constructor(e){super(e),I()(this,"onButtonClick",()=>{let e=this.state.selectedList.slice();""!==this._textinput.current.value&&(e=this._addAddressesToList([this._textinput.current.value]),null===e)||this.props.onFinished(!0,e)}),I()(this,"onCancel",()=>{this.props.onFinished(!1)}),I()(this,"onKeyDown",e=>{const t=this._textinput.current?this._textinput.current.value:void 0;e.key===_s.a.ESCAPE?(e.stopPropagation(),e.preventDefault(),this.props.onFinished(!1)):e.key===_s.a.ARROW_UP?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.moveSelectionUp()):e.key===_s.a.ARROW_DOWN?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.moveSelectionDown()):this.state.suggestedList.length>0&&[_s.a.COMMA,_s.a.ENTER,_s.a.TAB].includes(e.key)?(e.stopPropagation(),e.preventDefault(),this.addressSelector&&this.addressSelector.chooseSelection()):0===t.length&&this.state.selectedList.length&&e.key===_s.a.BACKSPACE?(e.stopPropagation(),e.preventDefault(),this.onDismissed(this.state.selectedList.length-1)()):e.key===_s.a.ENTER?(e.stopPropagation(),e.preventDefault(),""===t?this.onButtonClick():this._addAddressesToList([t])):!t||e.key!==_s.a.COMMA&&e.key!==_s.a.TAB||(e.stopPropagation(),e.preventDefault(),this._addAddressesToList([t]))}),I()(this,"onQueryChanged",e=>{const t=e.target.value;this.queryChangedDebouncer&&clearTimeout(this.queryChangedDebouncer),t.length>0&&"@"!==t&&t.length>=2?this.queryChangedDebouncer=setTimeout(()=>{"user"===this.props.pickerType?this.props.groupId?this._doNaiveGroupSearch(t):this.state.serverSupportsUserDirectory?this._doUserDirectorySearch(t):this._doLocalSearch(t):"room"===this.props.pickerType?this.props.groupId?this._doNaiveGroupRoomSearch(t):this._doRoomSearch(t):console.error("Unknown pickerType",this.props.pickerType)},200):this.setState({suggestedList:[],query:"",searchError:null})}),I()(this,"onDismissed",e=>()=>{const t=this.state.selectedList.slice();t.splice(e,1),this.setState({selectedList:t,suggestedList:[],query:""}),this._cancelThreepidLookup&&this._cancelThreepidLookup()}),I()(this,"onClick",e=>()=>{this.onSelected(e)}),I()(this,"onSelected",e=>{const t=this.state.selectedList.slice();t.push(this._getFilteredSuggestions()[e]),this.setState({selectedList:t,suggestedList:[],query:""}),this._cancelThreepidLookup&&this._cancelThreepidLookup()}),I()(this,"_onPaste",e=>{e.preventDefault();const t=e.clipboardData.getData("text");this._addAddressesToList(t.split(/[\s,]+/))}),I()(this,"onUseDefaultIdentityServerClick",e=>{e.preventDefault(),Object(hr.d)();const{validAddressTypes:t}=this.state;t.push("email"),this.setState({validAddressTypes:t})}),I()(this,"onManageSettingsClick",e=>{e.preventDefault(),m.a.fire(h.a.ViewUserSettings),this.onCancel()}),this._textinput=Object(a.createRef)();let t=this.props.validAddressTypes;!ee.a.get().getIdentityServerUrl()&&t.includes("email")&&(t=t.filter(e=>"email"!==e)),this.state={invalidAddressError:!1,selectedList:[],busy:!1,searchError:null,serverSupportsUserDirectory:!0,query:"",suggestedList:[],validAddressTypes:t}}componentDidMount(){this.props.focus&&(this._textinput.current.value=this.props.value)}getPlaceholder(){const{placeholder:e}=this.props;return"string"==typeof e?e:e(this.state.validAddressTypes)}_doNaiveGroupSearch(e){const t=e.toLowerCase();this.setState({busy:!0,query:e,searchError:null}),ee.a.get().getGroupUsers(this.props.groupId).then(s=>{const n=[];s.chunk.forEach(e=>{const s=e.user_id.toLowerCase().includes(t),a=(e.displayname||"").toLowerCase().includes(t);(s||a)&&n.push({user_id:e.user_id,avatar_url:e.avatar_url,display_name:e.displayname})}),this._processResults(n,e)}).catch(e=>{console.error("Error whilst searching group rooms: ",e),this.setState({searchError:e.errcode?e.message:Object(l.a)("Something went wrong!")})}).then(()=>{this.setState({busy:!1})})}_doNaiveGroupRoomSearch(e){const t=e.toLowerCase(),s=[];sa.a.getGroupRooms(this.props.groupId).forEach(e=>{const n=(e.name||"").toLowerCase().includes(t),a=(e.topic||"").toLowerCase().includes(t),i=(e.canonical_alias||"").toLowerCase().includes(t);(n||a||i)&&s.push({room_id:e.room_id,avatar_url:e.avatar_url,name:e.name||e.canonical_alias})}),this._processResults(s,e),this.setState({busy:!1})}_doRoomSearch(e){const t=e.toLowerCase(),s=ee.a.get().getRooms(),n=[];s.forEach(e=>{let s=1/0;const a=e.currentState.getStateEvents("m.room.name",""),i=a?a.getContent().name:"",o=e.getCanonicalAlias(),r=e.currentState.getStateEvents("m.room.aliases").map(e=>e.getContent().aliases).reduce((e,t)=>e.concat(t),[]),c=(i||"").toLowerCase().includes(t);let d=!1,m=1/0;if(r.forEach(e=>{(e||"").toLowerCase().includes(t)&&(d=!0,m>e.length&&(m=e.length))}),!c&&!d)return;d&&(s=m);const h=e.currentState.getStateEvents("m.room.avatar",""),u=h?h.getContent().url:void 0;n.push({rank:s,room_id:e.roomId,avatar_url:u,name:i||o||r[0]||Object(l.a)("Unnamed Room")})});const a=n.sort((e,t)=>e.rank-t.rank);this._processResults(a,e),this.setState({busy:!1})}_doUserDirectorySearch(e){this.setState({busy:!0,query:e,searchError:null}),ee.a.get().searchUserDirectory({term:e}).then(t=>{this.state.query===e&&this._processResults(t.results,e)}).catch(t=>{console.error("Error whilst searching user directory: ",t),this.setState({searchError:t.errcode?t.message:Object(l.a)("Something went wrong!")}),"M_UNRECOGNIZED"===t.errcode&&(this.setState({serverSupportsUserDirectory:!1}),this._doLocalSearch(e))}).then(()=>{this.setState({busy:!1})})}_doLocalSearch(e){this.setState({query:e,searchError:null});const t=e.toLowerCase(),s=[];ee.a.get().getUsers().forEach(e=>{-1===e.userId.toLowerCase().indexOf(t)&&-1===e.displayName.toLowerCase().indexOf(t)||s.push({user_id:e.userId,display_name:e.displayName,avatar_url:e.avatarUrl})}),this._processResults(s,e)}_processResults(e,t){const s=[];e.forEach(e=>{if(e.room_id){const t=ee.a.get(),n=t.getRoom(e.room_id);if(n){const e=n.currentState.getStateEvents("m.room.tombstone","");if(e&&e.getContent()&&e.getContent().replacement_room){if(t.getRoom(e.getContent().replacement_room))return}}s.push({addressType:"mx-room-id",address:e.room_id,displayName:e.name,avatarMxc:e.avatar_url,isKnown:!0})}else(this.props.includeSelf||e.user_id!==ee.a.get().credentials.userId)&&s.push({addressType:"mx-user-id",address:e.user_id,displayName:e.display_name,avatarMxc:e.avatar_url,isKnown:!0})});const n=Object(mr.c)(t);if(this.state.validAddressTypes.includes(n)){if("email"===n&&!wa.a(t))return void this.setState({searchError:Object(l.a)("That doesn't look like a valid email address")});s.unshift({addressType:n,address:t,isKnown:!1}),this._cancelThreepidLookup&&this._cancelThreepidLookup(),"email"===n&&this._lookupThreepid(n,t)}this.setState({suggestedList:s,invalidAddressError:!1},()=>{this.addressSelector&&this.addressSelector.moveSelectionTop()})}_addAddressesToList(e){const t=this.state.selectedList.slice();let s=!1;return e.forEach(e=>{e=e.trim();const n=Object(mr.c)(e),a={addressType:n,address:e,isKnown:!1};if(this.state.validAddressTypes.includes(n)){if("mx-user-id"===n){const e=ee.a.get().getUser(a.address);e&&(a.displayName=e.displayName,a.avatarMxc=e.avatarUrl,a.isKnown=!0)}else if("mx-room-id"===n){const e=ee.a.get().getRoom(a.address);e&&(a.displayName=e.name,a.avatarMxc=e.avatarUrl,a.isKnown=!0)}}else s=!0;t.push(a)}),this.setState({selectedList:t,suggestedList:[],query:"",invalidAddressError:!!s||this.state.invalidAddressError}),this._cancelThreepidLookup&&this._cancelThreepidLookup(),s?null:t}async _lookupThreepid(e,t){let s=!1;if(this._cancelThreepidLookup=function(){s=!0},await Object(Et.d)(500),s)return null;try{if(s)return null;const n=await E.a.lookupThreePid(e,t);if(s||null===n||!n.mxid)return null;const a=await ee.a.get().getProfileInfo(n.mxid);if(s||null===a)return null;this.setState({suggestedList:[{addressType:e,address:t,displayName:a.displayname,avatarMxc:a.avatar_url,isKnown:!0}]})}catch(e){console.error(e),this.setState({searchError:Object(l.a)("Something went wrong!")})}}_getFilteredSuggestions(){const e={};return this.state.selectedList.forEach(({address:t,addressType:s})=>{e[s]||(e[s]=new Set),e[s].add(t)}),this.state.suggestedList.filter(({address:t,addressType:s})=>!(e[s]&&e[s].has(t)))}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("elements.AddressSelector");let n;this.scrollElement=null,this.props.description&&(n=i.a.createElement("div",{className:"mx_AddressPickerDialog_label"},i.a.createElement("label",{htmlFor:"textinput"},this.props.description)));const a=[];if(this.state.selectedList.length>0){const e=d.getComponent("elements.AddressTile");for(let t=0;t<this.state.selectedList.length;t++)a.push(i.a.createElement(e,{key:t,address:this.state.selectedList[t],canDismiss:!0,onDismissed:this.onDismissed(t),showAddress:"user"===this.props.pickerType}))}a.push(i.a.createElement("textarea",{key:this.state.selectedList.length,onPaste:this._onPaste,rows:"1",id:"textinput",ref:this._textinput,className:"mx_AddressPickerDialog_input",onChange:this.onQueryChanged,placeholder:this.getPlaceholder(),defaultValue:this.props.value,autoFocus:this.props.focus}));const o=this._getFilteredSuggestions();let r,c,m;if(this.state.invalidAddressError){const e=this.state.validAddressTypes.map(e=>Object(l.a)(Vd[e]));r=i.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(l.a)("You have entered an invalid address."),i.a.createElement("br",null),Object(l.a)("Try using one of the following valid address types: %(validTypesList)s.",{validTypesList:e.join(", ")}))}else this.state.searchError?r=i.a.createElement("div",{className:"mx_AddressPickerDialog_error"},this.state.searchError):this.state.query.length>0&&0===o.length&&!this.state.busy?r=i.a.createElement("div",{className:"mx_AddressPickerDialog_error"},Object(l.a)("No results")):c=i.a.createElement(s,{ref:e=>{this.addressSelector=e},addressList:o,showAddress:"user"===this.props.pickerType,onSelected:this.onSelected,truncateAt:40});if("user"===this.props.pickerType&&!this.state.validAddressTypes.includes("email")&&this.props.validAddressTypes.includes("email")){const e=Object(hr.c)();m=e?i.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. <default>Use the default (%(defaultIdentityServerName)s)</default> or manage in <settings>Settings</settings>.",{defaultIdentityServerName:Object($e.a)(e)},{default:e=>i.a.createElement("a",{href:"#",onClick:this.onUseDefaultIdentityServerClick},e),settings:e=>i.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)})):i.a.createElement("div",{className:"mx_AddressPickerDialog_identityServer"},Object(l.a)("Use an identity server to invite by email. Manage in <settings>Settings</settings>.",{},{settings:e=>i.a.createElement("a",{href:"#",onClick:this.onManageSettingsClick},e)}))}return i.a.createElement(e,{className:"mx_AddressPickerDialog",onKeyDown:this.onKeyDown,onFinished:this.props.onFinished,title:this.props.title},n,i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_AddressPickerDialog_inputContainer"},a),r,c,this.props.extraNode,m),i.a.createElement(t,{primaryButton:this.props.button,onPrimaryButtonClick:this.onButtonClick,onCancel:this.onCancel}))}}I()(Wd,"propTypes",{title:xe.a.string.isRequired,description:xe.a.node,extraNode:xe.a.node,value:xe.a.string,placeholder:xe.a.oneOfType([xe.a.string,xe.a.func]),roomId:xe.a.string,button:xe.a.string,focus:xe.a.bool,validAddressTypes:xe.a.arrayOf(xe.a.oneOf(mr.b)),onFinished:xe.a.func.isRequired,groupId:xe.a.string,pickerType:xe.a.oneOf(["user","room"]),includeSelf:xe.a.bool}),I()(Wd,"defaultProps",{value:"",focus:!0,validAddressTypes:mr.b,pickerType:"user",includeSelf:!1});class Hd extends i.a.Component{constructor(...e){super(...e),I()(this,"_onInviteClicked",()=>{this.props.onInviteAnyways(),this.props.onFinished(!0)}),I()(this,"_onInviteNeverWarnClicked",()=>{F.a.setValue("promptBeforeInviteUnknownUsers",null,Qe.a.ACCOUNT,!1),this.props.onInviteAnyways(),this.props.onFinished(!0)}),I()(this,"_onGiveUpClicked",()=>{this.props.onGiveUp(),this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=this.props.unknownProfileUsers.map(e=>i.a.createElement("li",{key:e.userId},e.userId,": ",e.errorText));return i.a.createElement(e,{className:"mx_RetryInvitesDialog",onFinished:this._onGiveUpClicked,title:Object(l.a)("The following users may not exist"),contentId:"mx_Dialog_content"},i.a.createElement("div",{id:"mx_Dialog_content"},i.a.createElement("p",null,Object(l.a)("Unable to find profiles for the Matrix IDs listed below - would you like to invite them anyway?")),i.a.createElement("ul",null,t)),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this._onGiveUpClicked},Object(l.a)("Close")),i.a.createElement("button",{onClick:this._onInviteNeverWarnClicked},Object(l.a)("Invite anyway and never warn me again")),i.a.createElement("button",{onClick:this._onInviteClicked,autoFocus:!0},Object(l.a)("Invite anyway"))))}}I()(Hd,"propTypes",{unknownProfileUsers:xe.a.array.isRequired,onInviteAnyways:xe.a.func.isRequired,onGiveUp:xe.a.func.isRequired,onFinished:xe.a.func.isRequired});var Gd=s(663);class qd extends i.a.PureComponent{constructor(e){super(e),I()(this,"onParentFinished",async e=>{if(e){this.setState({isRedacting:!0});try{await this.props.redact(),this.props.onFinished(!0)}catch(e){const t=e.errcode||e.statusCode;void 0!==t?this.setState({redactionErrorCode:t}):this.props.onFinished(!0)}}else this.props.onFinished(!1)}),this.state={isRedacting:!1,redactionErrorCode:null}}render(){if(this.state.isRedacting){if(this.state.redactionErrorCode){const e=d.getComponent("dialogs.ErrorDialog"),t=this.state.redactionErrorCode;return i.a.createElement(e,{onFinished:this.props.onFinished,title:Object(l.a)("Error"),description:Object(l.a)("You cannot delete this message. (%(code)s)",{code:t})})}{const e=d.getComponent("dialogs.BaseDialog"),t=d.getComponent("elements.Spinner");return i.a.createElement(e,{onFinished:this.props.onFinished,hasCancel:!1,title:Object(l.a)("Removing…")},i.a.createElement(t,null))}}{const e=d.getComponent("dialogs.ConfirmRedactDialog");return i.a.createElement(e,{onFinished:this.onParentFinished})}}}class Kd extends i.a.Component{render(){const e=d.getComponent("views.dialogs.TextInputDialog");return i.a.createElement(e,{onFinished:this.props.onFinished,title:Object(l.a)("Confirm Removal"),description:Object(l.a)("Are you sure you wish to remove (delete) this event? Note that if you delete a room name or topic change, it could undo the change."),placeholder:Object(l.a)("Reason (optional)"),focus:!0,button:Object(l.a)("Remove")})}}class zd extends i.a.Component{constructor(...e){super(...e),I()(this,"_onConfirm",()=>{this.props.onFinished(!0)}),I()(this,"_onDecline",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return i.a.createElement(e,{className:"mx_ConfirmWipeDeviceDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Clear all data in this session?")},i.a.createElement("div",{className:"mx_ConfirmWipeDeviceDialog_content"},i.a.createElement("p",null,Object(l.a)("Clearing all data from this session is permanent. Encrypted messages will be lost unless their keys have been backed up."))),i.a.createElement(t,{primaryButton:Object(l.a)("Clear all data"),onPrimaryButtonClick:this._onConfirm,primaryButtonClass:"danger",cancelButton:Object(l.a)("Cancel"),onCancel:this._onDecline}))}}I()(zd,"propTypes",{onFinished:xe.a.func.isRequired});class $d extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{groupName:"",groupId:"",groupError:null,creating:!1,createError:null}),I()(this,"_onGroupNameChange",e=>{this.setState({groupName:e.target.value})}),I()(this,"_onGroupIdChange",e=>{this.setState({groupId:e.target.value})}),I()(this,"_onGroupIdBlur",e=>{this._checkGroupId()}),I()(this,"_onFormSubmit",e=>{if(e.preventDefault(),this._checkGroupId())return;const t={};""!==this.state.groupName&&(t.name=this.state.groupName),this.setState({creating:!0}),ee.a.get().createGroup({localpart:this.state.groupId,profile:t}).then(e=>{m.a.dispatch({action:"view_group",group_id:e.group_id,group_is_new:!0}),this.props.onFinished(!0)}).catch(e=>{this.setState({createError:e})}).finally(()=>{this.setState({creating:!1})})}),I()(this,"_onCancel",()=>{this.props.onFinished(!1)})}_checkGroupId(e){let t=null;return this.state.groupId?/^[a-z0-9=_\-./]*$/.test(this.state.groupId)||(t=Object(l.a)("Community IDs may only contain characters a-z, 0-9, or '=_-./'")):t=Object(l.a)("Community IDs cannot be empty."),this.setState({groupIdError:t,createError:null}),t}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner");if(this.state.creating)return i.a.createElement(t,null);let s;return this.state.createError&&(s=i.a.createElement("div",{className:"error",role:"alert"},i.a.createElement("div",null,Object(l.a)("Something went wrong whilst creating your community")),i.a.createElement("div",null,this.state.createError.message))),i.a.createElement(e,{className:"mx_CreateGroupDialog",onFinished:this.props.onFinished,title:Object(l.a)("Create Community")},i.a.createElement("form",{onSubmit:this._onFormSubmit},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},i.a.createElement("div",{className:"mx_CreateGroupDialog_label"},i.a.createElement("label",{htmlFor:"groupname"},Object(l.a)("Community Name"))),i.a.createElement("div",null,i.a.createElement("input",{id:"groupname",className:"mx_CreateGroupDialog_input",autoFocus:!0,size:"64",placeholder:Object(l.a)("Example"),onChange:this._onGroupNameChange,value:this.state.groupName}))),i.a.createElement("div",{className:"mx_CreateGroupDialog_inputRow"},i.a.createElement("div",{className:"mx_CreateGroupDialog_label"},i.a.createElement("label",{htmlFor:"groupid"},Object(l.a)("Community ID"))),i.a.createElement("div",{className:"mx_CreateGroupDialog_input_group"},i.a.createElement("span",{className:"mx_CreateGroupDialog_prefix"},"+"),i.a.createElement("input",{id:"groupid",className:"mx_CreateGroupDialog_input mx_CreateGroupDialog_input_hasPrefixAndSuffix",size:"32",placeholder:Object(l.a)("example"),onChange:this._onGroupIdChange,onBlur:this._onGroupIdBlur,value:this.state.groupId}),i.a.createElement("span",{className:"mx_CreateGroupDialog_suffix"},":",ee.a.get().getDomain()))),i.a.createElement("div",{className:"error"},this.state.groupIdError),s),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("input",{type:"submit",value:Object(l.a)("Create"),className:"mx_Dialog_primary"}),i.a.createElement("button",{onClick:this._onCancel},Object(l.a)("Cancel")))))}}I()($d,"propTypes",{onFinished:xe.a.func.isRequired});class Yd extends i.a.Component{constructor(e){super(e),I()(this,"_onKeyDown",e=>{e.key===_s.a.ENTER&&(this.onOk(),e.preventDefault(),e.stopPropagation())}),I()(this,"onOk",async()=>{const e=document.activeElement;if(e&&e.blur(),await this._nameFieldRef.validate({allowEmpty:!1}),this._aliasFieldRef&&await this._aliasFieldRef.validate({allowEmpty:!1}),await new Promise(e=>this.setState({},e)),!this.state.nameIsValid||this._aliasFieldRef&&!this._aliasFieldRef.isValid){let e;this.state.nameIsValid?this._aliasFieldRef&&!this._aliasFieldRef.isValid&&(e=this._aliasFieldRef):e=this._nameFieldRef,e&&(e.focus(),e.validate({allowEmpty:!1,focused:!0}))}else this.props.onFinished(!0,this._roomCreateOptions())}),I()(this,"onCancel",()=>{this.props.onFinished(!1)}),I()(this,"onNameChange",e=>{this.setState({name:e.target.value})}),I()(this,"onTopicChange",e=>{this.setState({topic:e.target.value})}),I()(this,"onPublicChange",e=>{this.setState({isPublic:e,externAllowedSwitchDisabled:e,externAllowed:!1,noFederate:e})}),I()(this,"onDetailsToggled",e=>{this.setState({detailsOpen:e.target.open})}),I()(this,"onNoFederateChange",e=>{this.setState({noFederate:e})}),I()(this,"onExternAllowedSwitchChange",e=>{this.setState({externAllowed:e})}),I()(this,"collectDetailsRef",e=>{this._detailsRef=e}),I()(this,"onNameValidate",async e=>{const t=await Yd._validateRoomName(e);return this.setState({nameIsValid:t.valid}),t}),I()(this,"onRoomOptionChange",e=>{e.preventDefault();const t=e.target.getAttribute("aria-name");this.setUpRoomOptions(t)}),I()(this,"setUpRoomOptions",e=>{switch(e){case"private":this.setState({isPublic:!1,externAllowed:!1,noFederate:!1,roomOption:e,classesRoomOptionPrivate:this.state.classesRoomOptionPrivate+" tc_CreateRoomDialog_RoomOption_selected",classesRoomOptionExternal:"tc_CreateRoomDialog_RoomOption_external",classesRoomOptionPublic:"tc_CreateRoomDialog_RoomOption_public"});break;case"external":this.setState({isPublic:!1,externAllowed:!0,noFederate:!1,roomOption:e,classesRoomOptionExternal:this.state.classesRoomOptionExternal+" tc_CreateRoomDialog_RoomOption_selected",classesRoomOptionPrivate:"tc_CreateRoomDialog_RoomOption_private",classesRoomOptionPublic:"tc_CreateRoomDialog_RoomOption_public"});break;case"public":this.setState({isPublic:!0,externAllowed:!1,noFederate:!0,roomOption:e,classesRoomOptionPublic:this.state.classesRoomOptionPublic+" tc_CreateRoomDialog_RoomOption_selected",classesRoomOptionPrivate:"tc_CreateRoomDialog_RoomOption_private",classesRoomOptionExternal:"tc_CreateRoomDialog_RoomOption_external"})}});c.a.get();this.state={isPublic:this.props.defaultPublic||!1,isEncrypted:Object(Ct.e)(),name:"",topic:"",alias:"",detailsOpen:!1,noFederate:!0,nameIsValid:!1,externAllowed:!1,externAllowedSwitchDisabled:this.props.defaultPublic||!1,roomOption:this.props.defaultPublic?"public":"private",classesRoomOptionPrivate:"tc_CreateRoomDialog_RoomOption_private",classesRoomOptionExternal:"tc_CreateRoomDialog_RoomOption_external",classesRoomOptionPublic:"tc_CreateRoomDialog_RoomOption_public",canChangeEncryption:!1},ee.a.get().doesServerForceEncryptionForPreset("private").then(e=>this.setState({canChangeEncryption:!e}))}_roomCreateOptions(){const e={},t=e.createOpts={};if(t.name=this.state.name,this.state.isPublic){t.visibility="public",t.preset="public_chat",e.guestAccess=!1;const{alias:s}=this.state,n=s.substr(1,s.indexOf(":")-1);t.room_alias_name=n}return this.state.externAllowed&&!this.state.isPublic&&(t.access_rules="unrestricted"),this.state.topic&&(t.topic=this.state.topic),this.state.noFederate&&(t.creation_content={"m.federate":!1}),this.state.isPublic||(e.encryption=this.state.isEncrypted),e}componentDidMount(){this._nameFieldRef.focus(),this.setUpRoomOptions(this.state.roomOption)}componentWillUnmount(){}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.elements.Field"),n=d.getComponent("views.elements.LabelledToggleSwitch");let a=i.a.createElement("div",{className:"tc_CreateRoomDialog_RoomOption"},i.a.createElement(pe.a,{className:this.state.classesRoomOptionPrivate,onClick:this.onRoomOptionChange,"aria-name":"private"},Object(l.a)("Private room"),i.a.createElement("div",{className:"tc_CreateRoomDialog_RoomOption_descr",onClick:this.onRoomOptionChange,"aria-name":"private"},Object(l.a)("Accessible to all users by invitation from an administrator."))),i.a.createElement(pe.a,{className:this.state.classesRoomOptionExternal,onClick:this.onRoomOptionChange,"aria-name":"external"},Object(l.a)("Private room opened to externals"),i.a.createElement("div",{className:"tc_CreateRoomDialog_RoomOption_descr",onClick:this.onRoomOptionChange,"aria-name":"external"},Object(l.a)("Accessible to all users and to external guests by invitation of an administrator."))),i.a.createElement(pe.a,{className:this.state.classesRoomOptionPublic,onClick:this.onRoomOptionChange,"aria-name":"public"},Object(l.a)("Forum room"),i.a.createElement("div",{className:"tc_CreateRoomDialog_RoomOption_descr",onClick:this.onRoomOptionChange,"aria-name":"public"},Object(l.a)("Accessible to all users from the directory or from a shared link.")),i.a.createElement("div",{className:"tc_CreateRoomDialog_RoomOption_suboption"},i.a.createElement(n,{label:Object(l.a)('Limit access to this room to domain members "%(domain)s"',{domain:E.a.getShortDomain()}),onChange:this.onNoFederateChange,value:this.state.noFederate})))),o="";return o=this.state.isPublic?Object(l.a)("Create a forum room"):!this.state.isPublic&&this.state.externAllowed?Object(l.a)("Create a private room opened to externals"):Object(l.a)("Create a private room"),i.a.createElement(e,{className:"mx_CreateRoomDialog",onFinished:this.props.onFinished,title:o},i.a.createElement("form",{onSubmit:this.onOk,onKeyDown:this._onKeyDown},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(s,{ref:e=>this._nameFieldRef=e,label:Object(l.a)("Name"),onChange:this.onNameChange,onValidate:this.onNameValidate,value:this.state.name,className:"mx_CreateRoomDialog_name"}),i.a.createElement(s,{label:Object(l.a)("Topic (optional)"),onChange:this.onTopicChange,value:this.state.topic,className:"mx_CreateRoomDialog_topic"}),a)),i.a.createElement(t,{primaryButton:Object(l.a)("Create Room"),onPrimaryButtonClick:this.onOk,onCancel:this.onCancel}))}}I()(Yd,"propTypes",{onFinished:xe.a.func.isRequired,defaultPublic:xe.a.bool}),I()(Yd,"_validateRoomName",Object(Ca.a)({rules:[{key:"required",test:async({value:e})=>!!e,invalid:()=>Object(l.a)("Please enter a name for the room")}]}));var Jd=e=>{const t=c.a.get().brand,s=Object(l.a)("You've previously used a newer version of %(brand)s with this session. To use this version again with end to end encryption, you will need to sign out and back in again.",{brand:t}),n=d.getComponent("views.dialogs.BaseDialog"),a=d.getComponent("views.elements.DialogButtons");return i.a.createElement(n,{className:"mx_CryptoStoreTooNewDialog",contentId:"mx_Dialog_content",title:Object(l.a)("Incompatible Database"),hasCancel:!1,onFinished:e.onFinished},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},s),i.a.createElement(a,{primaryButton:Object(l.a)("Continue With Encryption Disabled"),hasCancel:!1,onPrimaryButtonClick:e.onFinished},i.a.createElement("button",{onClick:()=>{const s=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Logout e2e db too new","",s,{title:Object(l.a)("Sign out"),description:Object(l.a)("To avoid losing your chat history, you must export your room keys before logging out. You will need to go back to the newer version of %(brand)s to do this",{brand:t}),button:Object(l.a)("Sign out"),focus:!1,onFinished:t=>{t&&(m.a.dispatch({action:"logout"}),e.onFinished())}})}},Object(l.a)("Sign out"))))};class Qd extends i.a.PureComponent{constructor(e){super(e),this._onChange=this._onChange.bind(this),this.onBack=this.onBack.bind(this)}onBack(){this.state.message?this.setState({message:null}):this.props.onBack()}_onChange(e){this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})}_buttons(){return i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&i.a.createElement("button",{onClick:this._send},Object(l.a)("Send")))}textInput(e,t){return i.a.createElement(ke.a,{id:e,label:t,size:"42",autoFocus:!0,type:"text",autoComplete:"on",value:this.state[e],onChange:this._onChange})}}class Xd extends Qd{static getLabel(){return Object(l.a)("Send Custom Event")}constructor(e){super(e),this._send=this._send.bind(this);const{eventType:t,stateKey:s,evContent:n}=Object.assign({eventType:"",stateKey:"",evContent:"{\n\n}"},this.props.inputs);this.state={isStateEvent:Boolean(this.props.forceStateEvent),eventType:t,stateKey:s,evContent:n}}send(e){const t=this.context;return this.state.isStateEvent?t.sendStateEvent(this.props.room.roomId,this.state.eventType,e,this.state.stateKey):t.sendEvent(this.props.room.roomId,this.state.eventType,e)}async _send(){if(""===this.state.eventType)return void this.setState({message:Object(l.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.send(t),e=Object(l.a)("Event sent!")}catch(t){e=Object(l.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})}render(){return this.state.message?i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this._buttons()):i.a.createElement("div",null,i.a.createElement("div",{className:"mx_DevTools_content"},i.a.createElement("div",{className:"mx_DevTools_eventTypeStateKeyGroup"},this.textInput("eventType",Object(l.a)("Event Type")),this.state.isStateEvent&&this.textInput("stateKey",Object(l.a)("State Key"))),i.a.createElement("br",null),i.a.createElement(ke.a,{id:"evContent",label:Object(l.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this._onChange,element:"textarea"})),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&i.a.createElement("button",{onClick:this._send},Object(l.a)("Send")),!this.state.message&&!this.props.forceStateEvent&&i.a.createElement("div",{style:{float:"right"}},i.a.createElement("input",{id:"isStateEvent",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",onChange:this._onChange,checked:this.state.isStateEvent}),i.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Event","data-tg-on":"State Event",htmlFor:"isStateEvent"}))))}}I()(Xd,"propTypes",{onBack:xe.a.func.isRequired,room:xe.a.instanceOf(Fe.k).isRequired,forceStateEvent:xe.a.bool,inputs:xe.a.object}),I()(Xd,"contextType",b.a);class Zd extends Qd{static getLabel(){return Object(l.a)("Send Account Data")}constructor(e){super(e),this._send=this._send.bind(this);const{eventType:t,evContent:s}=Object.assign({eventType:"",evContent:"{\n\n}"},this.props.inputs);this.state={isRoomAccountData:Boolean(this.props.isRoomAccountData),eventType:t,evContent:s}}send(e){const t=this.context;return this.state.isRoomAccountData?t.setRoomAccountData(this.props.room.roomId,this.state.eventType,e):t.setAccountData(this.state.eventType,e)}async _send(){if(""===this.state.eventType)return void this.setState({message:Object(l.a)("You must specify an event type!")});let e;try{const t=JSON.parse(this.state.evContent);await this.send(t),e=Object(l.a)("Event sent!")}catch(t){e=Object(l.a)("Failed to send custom event.")+" ("+t.toString()+")"}this.setState({message:e})}render(){return this.state.message?i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},this.state.message),this._buttons()):i.a.createElement("div",null,i.a.createElement("div",{className:"mx_DevTools_content"},this.textInput("eventType",Object(l.a)("Event Type")),i.a.createElement("br",null),i.a.createElement(ke.a,{id:"evContent",label:Object(l.a)("Event Content"),type:"text",className:"mx_DevTools_textarea",autoComplete:"off",value:this.state.evContent,onChange:this._onChange,element:"textarea"})),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&i.a.createElement("button",{onClick:this._send},Object(l.a)("Send")),!this.state.message&&i.a.createElement("div",{style:{float:"right"}},i.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",onChange:this._onChange,checked:this.state.isRoomAccountData,disabled:this.props.forceMode}),i.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}I()(Zd,"propTypes",{room:xe.a.instanceOf(Fe.k).isRequired,isRoomAccountData:xe.a.bool,forceMode:xe.a.bool,inputs:xe.a.object}),I()(Zd,"contextType",b.a);class em extends i.a.PureComponent{static filterChildren(e,t){if(!t)return e;const s=t.toLowerCase();return e.filter(e=>e.key.toLowerCase().includes(s))}constructor(e){super(e),I()(this,"showAll",()=>{this.setState({truncateAt:this.state.truncateAt+50})}),I()(this,"createOverflowElement",(e,t)=>i.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",onClick:this.showAll},Object(l.a)("and %(count)s others...",{count:e}))),I()(this,"onQuery",e=>{this.props.onChange&&this.props.onChange(e.target.value)}),I()(this,"getChildren",(e,t)=>this.state.filteredChildren.slice(e,t)),I()(this,"getChildCount",()=>this.state.filteredChildren.length),this.state={filteredChildren:em.filterChildren(this.props.children,this.props.query),truncateAt:20}}UNSAFE_componentWillReceiveProps(e){this.props.children===e.children&&this.props.query===e.query||this.setState({filteredChildren:em.filterChildren(e.children,e.query),truncateAt:20})}render(){const e=d.getComponent("elements.TruncatedList");return i.a.createElement("div",null,i.a.createElement(ke.a,{label:Object(l.a)("Filter results"),autoFocus:!0,size:64,type:"text",autoComplete:"off",value:this.props.query,onChange:this.onQuery,className:"mx_TextInputDialog_input mx_DevTools_RoomStateExplorer_query",key:this.props.children[0]?this.props.children[0].key:""}),i.a.createElement(e,{getChildren:this.getChildren,getChildCount:this.getChildCount,truncateAt:this.state.truncateAt,createOverflowElement:this.createOverflowElement}))}}I()(em,"propTypes",{children:xe.a.any,query:xe.a.string,onChange:xe.a.func});class tm extends i.a.PureComponent{static getLabel(){return Object(l.a)("Explore Room State")}constructor(e){super(e),I()(this,"roomStateEvents",void 0),this.roomStateEvents=this.props.room.currentState.events,this.onBack=this.onBack.bind(this),this.editEv=this.editEv.bind(this),this.onQueryEventType=this.onQueryEventType.bind(this),this.onQueryStateKey=this.onQueryStateKey.bind(this),this.state={eventType:null,event:null,editing:!1,queryEventType:"",queryStateKey:""}}browseEventType(e){return()=>{this.setState({eventType:e})}}onViewSourceClick(e){return()=>{this.setState({event:e})}}onBack(){this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.state.eventType?this.setState({eventType:null}):this.props.onBack()}editEv(){this.setState({editing:!0})}onQueryEventType(e){this.setState({queryEventType:e})}onQueryStateKey(e){this.setState({queryStateKey:e})}render(){if(this.state.event)return this.state.editing?i.a.createElement(Xd,{room:this.props.room,forceStateEvent:!0,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t"),stateKey:this.state.event.getStateKey()}}):i.a.createElement("div",{className:"mx_ViewSource"},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(ad,{className:"json"},JSON.stringify(this.state.event.event,null,2))),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),i.a.createElement("button",{onClick:this.editEv},Object(l.a)("Edit"))));let e=null;const t="mx_DevTools_RoomStateExplorer_button";if(null===this.state.eventType)e=i.a.createElement(em,{query:this.state.queryEventType,onChange:this.onQueryEventType},Array.from(this.roomStateEvents.entries()).map(([e,s])=>{let n;return n=1===s.size&&s.has("")?this.onViewSourceClick(s.get("")):this.browseEventType(e),i.a.createElement("button",{className:t,key:e,onClick:n},e)}));else{const s=this.roomStateEvents.get(this.state.eventType);e=i.a.createElement(em,{query:this.state.queryStateKey,onChange:this.onQueryStateKey},Array.from(s.entries()).map(([e,s])=>i.a.createElement("button",{className:t,key:e,onClick:this.onViewSourceClick(s)},e)))}return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},e),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}}I()(tm,"propTypes",{onBack:xe.a.func.isRequired,room:xe.a.instanceOf(Fe.k).isRequired}),I()(tm,"contextType",b.a);class sm extends i.a.PureComponent{static getLabel(){return Object(l.a)("Explore Account Data")}constructor(e){super(e),this.onBack=this.onBack.bind(this),this.editEv=this.editEv.bind(this),this._onChange=this._onChange.bind(this),this.onQueryEventType=this.onQueryEventType.bind(this),this.state={isRoomAccountData:!1,event:null,editing:!1,queryEventType:""}}getData(){return this.state.isRoomAccountData?this.props.room.accountData:this.context.store.accountData}onViewSourceClick(e){return()=>{this.setState({event:e})}}onBack(){this.state.editing?this.setState({editing:!1}):this.state.event?this.setState({event:null}):this.props.onBack()}_onChange(e){this.setState({[e.target.id]:"checkbox"===e.target.type?e.target.checked:e.target.value})}editEv(){this.setState({editing:!0})}onQueryEventType(e){this.setState({queryEventType:e})}render(){if(this.state.event)return this.state.editing?i.a.createElement(Zd,{room:this.props.room,isRoomAccountData:this.state.isRoomAccountData,onBack:this.onBack,inputs:{eventType:this.state.event.getType(),evContent:JSON.stringify(this.state.event.getContent(),null,"\t")},forceMode:!0}):i.a.createElement("div",{className:"mx_ViewSource"},i.a.createElement("div",{className:"mx_DevTools_content"},i.a.createElement(ad,{className:"json"},JSON.stringify(this.state.event.event,null,2))),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),i.a.createElement("button",{onClick:this.editEv},Object(l.a)("Edit"))));const e=[],t=this.getData();return Object.keys(t).forEach(s=>{const n=t[s];e.push(i.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:s,onClick:this.onViewSourceClick(n)},s))}),i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(em,{query:this.state.queryEventType,onChange:this.onQueryEventType},e)),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back")),!this.state.message&&i.a.createElement("div",{style:{float:"right"}},i.a.createElement("input",{id:"isRoomAccountData",className:"mx_DevTools_tgl mx_DevTools_tgl-flip",type:"checkbox",onChange:this._onChange,checked:this.state.isRoomAccountData}),i.a.createElement("label",{className:"mx_DevTools_tgl-btn","data-tg-off":"Account Data","data-tg-on":"Room Data",htmlFor:"isRoomAccountData"}))))}}I()(sm,"propTypes",{onBack:xe.a.func.isRequired,room:xe.a.instanceOf(Fe.k).isRequired}),I()(sm,"contextType",b.a);class nm extends i.a.PureComponent{static getLabel(){return Object(l.a)("View Servers in Room")}constructor(e){super(e),I()(this,"onQuery",e=>{this.setState({query:e})});const t=this.props.room,s=new Set;t.currentState.getStateEvents("m.room.member").forEach(e=>s.add(e.getSender().split(":")[1])),this.servers=Array.from(s).map(e=>i.a.createElement("button",{key:e,className:"mx_DevTools_ServersInRoomList_button"},e)),this.state={query:""}}render(){return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(em,{query:this.state.query,onChange:this.onQuery},this.servers)),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.props.onBack},Object(l.a)("Back"))))}}I()(nm,"propTypes",{onBack:xe.a.func.isRequired,room:xe.a.instanceOf(Fe.k).isRequired}),I()(nm,"contextType",b.a);const am={[go.g]:"unsent",[go.e]:"requested",[go.d]:"ready",[go.c]:"done",[go.f]:"started",[go.b]:"cancelled"};function im({txnId:e,request:t}){const[,s]=Object(a.useState)(),[n,o]=Object(a.useState)(t.timeout);return Object(f.a)(t,"change",s),Object(a.useEffect)(()=>{if(0==t.timeout)return;const e=setInterval(()=>{o(t.timeout)},500);return()=>{clearInterval(e)}},[t]),i.a.createElement("div",{className:"mx_DevTools_VerificationRequest"},i.a.createElement("dl",null,i.a.createElement("dt",null,"Transaction"),i.a.createElement("dd",null,e),i.a.createElement("dt",null,"Phase"),i.a.createElement("dd",null,am[t.phase]||t.phase),i.a.createElement("dt",null,"Timeout"),i.a.createElement("dd",null,Math.floor(n/1e3)),i.a.createElement("dt",null,"Methods"),i.a.createElement("dd",null,t.methods&&t.methods.join(", ")),i.a.createElement("dt",null,"requestingUserId"),i.a.createElement("dd",null,t.requestingUserId),i.a.createElement("dt",null,"observeOnly"),i.a.createElement("dd",null,JSON.stringify(t.observeOnly))))}class om extends i.a.Component{constructor(...e){super(...e),I()(this,"onNewRequest",()=>{this.forceUpdate()})}static getLabel(){return Object(l.a)("Verification Requests")}componentDidMount(){this.context.on("crypto.verification.request",this.onNewRequest)}componentWillUnmount(){this.context.off("crypto.verification.request",this.onNewRequest)}render(){const e=this.context,t=this.props.room,s=(e._crypto._inRoomVerificationRequests._requestsByRoomId||new Map).get(t.roomId)||new Map;return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},Array.from(s.entries()).reverse().map(([e,t])=>i.a.createElement(im,{txnId:e,request:t,key:e}))),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.props.onBack},Object(l.a)("Back"))))}}I()(om,"contextType",b.a);class rm extends i.a.Component{static getLabel(){return Object(l.a)("Active Widgets")}constructor(e){super(e),I()(this,"onWidgetStoreUpdate",()=>{this.forceUpdate()}),I()(this,"onQueryChange",e=>{this.setState({query:e})}),I()(this,"onEditWidget",e=>{this.setState({editWidget:e})}),I()(this,"onBack",()=>{const e=Wi.a.instance.getApps(this.props.room.roomId);this.state.editWidget&&e.includes(this.state.editWidget)?this.setState({editWidget:null}):this.props.onBack()}),this.state={query:"",editWidget:null}}componentDidMount(){Wi.a.instance.on(g.b,this.onWidgetStoreUpdate)}componentWillUnmount(){Wi.a.instance.off(g.b,this.onWidgetStoreUpdate)}render(){const e=this.props.room,t=this.state.editWidget,s=Wi.a.instance.getApps(e.roomId);if(t&&s.includes(t)){const s=Array.from(Array.from(e.currentState.events.values()).map(e=>e.values())).reduce((e,t)=>(e.push(...t),e),[]).find(e=>e.getId()===t.eventId);return s?i.a.createElement(Xd,{onBack:this.onBack,room:e,forceStateEvent:!0,inputs:{eventType:s.getType(),evContent:JSON.stringify(s.getContent(),null,"\t"),stateKey:s.getStateKey()}}):i.a.createElement("div",null,Object(l.a)("There was an error finding this widget."),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(em,{query:this.state.query,onChange:this.onQueryChange},s.map(e=>i.a.createElement("button",{className:"mx_DevTools_RoomStateExplorer_button",key:e.url+e.eventId,onClick:()=>this.onEditWidget(e)},e.url)))),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onBack},Object(l.a)("Back"))))}}const lm=[Xd,tm,Zd,sm,nm,om,rm];class cm extends i.a.PureComponent{constructor(e){super(e),this.onBack=this.onBack.bind(this),this.onCancel=this.onCancel.bind(this),this.state={mode:null}}componentWillUnmount(){this._unmounted=!0}_setMode(e){return()=>{this.setState({mode:e})}}onBack(){this.prevMode?(this.setState({mode:this.prevMode}),this.prevMode=null):this.setState({mode:null})}onCancel(){this.props.onFinished(!1)}render(){let e;if(this.state.mode)e=i.a.createElement(b.a.Consumer,null,e=>i.a.createElement(i.a.Fragment,null,i.a.createElement("div",{className:"mx_DevTools_label_left"},this.state.mode.getLabel()),i.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),i.a.createElement("div",{className:"mx_DevTools_label_bottom"}),i.a.createElement(this.state.mode,{onBack:this.onBack,room:e.getRoom(this.props.roomId)})));else{const t="mx_DevTools_RoomStateExplorer_button";e=i.a.createElement(i.a.Fragment,null,i.a.createElement("div",null,i.a.createElement("div",{className:"mx_DevTools_label_left"},Object(l.a)("Toolbox")),i.a.createElement("div",{className:"mx_DevTools_label_right"},"Room ID: ",this.props.roomId),i.a.createElement("div",{className:"mx_DevTools_label_bottom"}),i.a.createElement("div",{className:"mx_Dialog_content"},lm.map(e=>{const s=e.getLabel(),n=this._setMode(e);return i.a.createElement("button",{className:t,key:s,onClick:n},s)}))),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("button",{onClick:this.onCancel},Object(l.a)("Cancel"))))}const t=d.getComponent("views.dialogs.BaseDialog");return i.a.createElement(t,{className:"mx_QuestionDialog",onFinished:this.props.onFinished,title:Object(l.a)("Developer Tools")},e)}}I()(cm,"propTypes",{roomId:xe.a.string.isRequired,onFinished:xe.a.func.isRequired});class dm extends i.a.Component{constructor(e){super(e),I()(this,"_onFinished",()=>{this.props.onFinished(3===this.state.phase)}),I()(this,"_onCancelClick",()=>{this.props.onFinished(3===this.state.phase)}),I()(this,"_onContinueClick",()=>{this.setState({phase:2}),this.props.verifier.verify().then(()=>{this.setState({phase:3})}).catch(e=>{console.log("Verification failed",e)})}),I()(this,"_onVerifierShowSas",e=>{this._showSasEvent=e,this.setState({phase:1,sas:e.sas})}),I()(this,"_onVerifierCancel",e=>{this.setState({phase:4})}),I()(this,"_onSasMatchesClick",()=>{this._showSasEvent.confirm(),this.setState({phase:2})}),I()(this,"_onVerifiedDoneClick",()=>{this.props.onFinished(!0)});let t=0;this.props.verifier.cancelled&&(console.log("Verifier was cancelled in the background."),t=4),this._showSasEvent=null,this.state={phase:t,sasVerified:!1,opponentProfile:null,opponentProfileError:null},this.props.verifier.on("show_sas",this._onVerifierShowSas),this.props.verifier.on("cancel",this._onVerifierCancel),this._fetchOpponentProfile()}componentWillUnmount(){4!==this.state.phase&&3!==this.state.phase&&this.props.verifier.cancel("User cancel"),this.props.verifier.removeListener("show_sas",this._onVerifierShowSas)}async _fetchOpponentProfile(){try{const e=await ee.a.get().getProfileInfo(this.props.verifier.userId);this.setState({opponentProfile:e})}catch(e){this.setState({opponentProfileError:e})}}_renderPhaseStart(){const e=d.getComponent("views.elements.DialogButtons"),t=d.getComponent("views.elements.Spinner"),s=d.getComponent("avatars.BaseAvatar"),n=this.props.verifier.userId==ee.a.get().getUserId();let a;a=this.state.opponentProfile?i.a.createElement("div",{className:"mx_IncomingSasDialog_opponentProfile"},i.a.createElement(s,{name:this.state.opponentProfile.displayname,idName:this.props.verifier.userId,url:ee.a.get().mxcUrlToHttp(this.state.opponentProfile.avatar_url,Math.floor(48*window.devicePixelRatio),Math.floor(48*window.devicePixelRatio),"crop"),width:48,height:48,resizeMethod:"crop"}),i.a.createElement("h2",null,this.state.opponentProfile.displayname)):this.state.opponentProfileError?i.a.createElement("div",null,i.a.createElement(s,{name:this.props.verifier.userId.slice(1),idName:this.props.verifier.userId,width:48,height:48}),i.a.createElement("h2",null,this.props.verifier.userId)):i.a.createElement(t,null);const o=[i.a.createElement("p",{key:"p1"},Object(l.a)("Verify this user to mark them as trusted. Trusting users gives you extra peace of mind when using end-to-end encrypted messages.")),i.a.createElement("p",{key:"p2"},Object(l.a)("Verifying this user will mark their session as trusted, and also mark your session as trusted to them."))],r=[i.a.createElement("p",{key:"p1"},Object(l.a)("One of your devices wants to check your current device. By performing this verification, a link of trust will be established between your two devices to facilitate the sharing of encryption keys."))];return i.a.createElement("div",null,a,n?r:o,i.a.createElement(e,{primaryButton:Object(l.a)("Continue"),hasCancel:!0,onPrimaryButtonClick:this._onContinueClick,onCancel:this._onCancelClick}))}_renderPhaseShowSas(){const e=d.getComponent("views.verification.VerificationShowSas");return i.a.createElement(e,{sas:this._showSasEvent.sas,onCancel:this._onCancelClick,onDone:this._onSasMatchesClick,isSelf:this.props.verifier.userId===ee.a.get().getUserId(),inDialog:!0})}_renderPhaseWaitForPartnerToConfirm(){const e=d.getComponent("views.elements.Spinner");return i.a.createElement("div",null,i.a.createElement(e,null),i.a.createElement("p",null,Object(l.a)("Waiting for you to accept on your other device…")))}_renderPhaseVerified(){const e=d.getComponent("views.verification.VerificationComplete");return i.a.createElement(e,{onDone:this._onVerifiedDoneClick})}_renderPhaseCancelled(){const e=d.getComponent("views.verification.VerificationCancelled");return i.a.createElement(e,{onDone:this._onCancelClick})}render(){let e;switch(this.state.phase){case 0:e=this._renderPhaseStart();break;case 1:e=this._renderPhaseShowSas();break;case 2:e=this._renderPhaseWaitForPartnerToConfirm();break;case 3:e=this._renderPhaseVerified();break;case 4:e=this._renderPhaseCancelled()}const t=d.getComponent("dialogs.BaseDialog");return i.a.createElement(t,{title:Object(l.a)("Incoming Verification Request"),onFinished:this._onFinished,fixedWidth:!1},e)}}I()(dm,"propTypes",{verifier:xe.a.object.isRequired});var mm=s(630),hm=s(627);function um({failures:e,source:t,continuation:s,onFinished:n}){const o=d.getComponent("dialogs.BaseDialog"),r=d.getComponent("views.elements.DialogButtons"),m=d.getComponent("elements.Spinner"),[h,u]=Object(a.useState)(2),[p,g]=Object(a.useState)(!1),[f,b]=Object(a.useState)(!1),[v,_]=Object(a.useState)(!1),y=Object(a.useRef)(n),E=new Map([["_afterCrossSigningLocalKeyChange",Object(l.a)("a new master key signature")],["checkOwnCrossSigningTrust",Object(l.a)("a new cross-signing key signature")],["setDeviceVerification",Object(l.a)("a device cross-signing signature")]]),C=Object(l.a)("a key signature"),w=Object(a.useCallback)(async()=>{try{b(!0);const e=new Promise((e,t)=>{y.current=t}).finally(()=>{g(!0)});await Promise.race([s(),e]),_(!0)}catch(e){u(e=>e-1)}finally{y.current=n,b(!1)}},[s,n]);let S;if(!v&&!p&&s&&h>0){const s=E.get(t)||C,n=c.a.get().brand;S=i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("%(brand)s encountered an error during upload of:",{brand:n})),i.a.createElement("p",null,s),f&&i.a.createElement(m,null),i.a.createElement("pre",null,JSON.stringify(e,null,2)),i.a.createElement(r,{primaryButton:"Retry",hasCancel:!0,onPrimaryButtonClick:w,onCancel:y.current,primaryDisabled:f}))}else S=i.a.createElement("div",null,v?i.a.createElement("span",null,Object(l.a)("Upload completed")):p?i.a.createElement("span",null,Object(l.a)("Cancelled signature upload")):i.a.createElement("span",null,Object(l.a)("Unable to upload")),i.a.createElement(r,{primaryButton:Object(l.a)("OK"),hasCancel:!1,onPrimaryButtonClick:n}));return i.a.createElement(o,{title:v?Object(l.a)("Signature upload success"):Object(l.a)("Signature upload failed"),fixedWidth:!1,onFinished:()=>{}},S)}var pm=e=>{const t=c.a.get().brand,s=Object(l.a)("You've previously used %(brand)s on %(host)s with lazy loading of members enabled. In this version lazy loading is disabled. As the local cache is not compatible between these two settings, %(brand)s needs to resync your account.",{brand:t,host:e.host}),n=Object(l.a)("If the other version of %(brand)s is still open in another tab, please close it as using %(brand)s on the same host with both lazy loading enabled and disabled simultaneously will cause issues.",{brand:t});return i.a.createElement(St.a,{hasCancelButton:!1,title:Object(l.a)("Incompatible local cache"),description:i.a.createElement("div",null,i.a.createElement("p",null,s),i.a.createElement("p",null,n)),button:Object(l.a)("Clear cache and resync"),onFinished:e.onFinished})},gm=e=>{const t=c.a.get().brand,s=Object(l.a)("%(brand)s now uses 3-5x less memory, by only loading information about other users when needed. Please wait whilst we resynchronise with the server!",{brand:t});return i.a.createElement(St.a,{hasCancelButton:!1,title:Object(l.a)("Updating %(brand)s",{brand:t}),description:i.a.createElement("div",null,s),button:Object(l.a)("OK"),onFinished:e.onFinished})};class fm extends i.a.Component{constructor(...e){super(...e),I()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),I()(this,"_onLegacyFinished",e=>{e&&ee.a.get().setDeviceVerified(this.props.userId,this.props.device.deviceId,!0),this.props.onFinished(e)})}render(){const e=d.getComponent("dialogs.QuestionDialog");let t;t=ee.a.get().getUserId()===this.props.userId?Object(l.a)("Confirm by comparing the following with the User Settings in your other session:"):Object(l.a)("Confirm this user's session by comparing the following with their User Settings:");const s=q.e(this.props.device.getFingerprint()),n=i.a.createElement("div",null,i.a.createElement("p",null,t),i.a.createElement("div",{className:"mx_DeviceVerifyDialog_cryptoSection"},i.a.createElement("ul",null,i.a.createElement("li",null,i.a.createElement("label",null,Object(l.a)("Session name"),":")," ",i.a.createElement("span",null,this.props.device.getDisplayName())),i.a.createElement("li",null,i.a.createElement("label",null,Object(l.a)("Session ID"),":")," ",i.a.createElement("span",null,i.a.createElement("code",null,this.props.device.deviceId))),i.a.createElement("li",null,i.a.createElement("label",null,Object(l.a)("Session key"),":")," ",i.a.createElement("span",null,i.a.createElement("code",null,i.a.createElement("b",null,s)))))),i.a.createElement("p",null,Object(l.a)("If they don't match, the security of your communication may be compromised.")));return i.a.createElement(e,{title:Object(l.a)("Verify session"),description:n,button:Object(l.a)("Verify session"),onFinished:this._onLegacyFinished})}}I()(fm,"propTypes",{userId:xe.a.string.isRequired,device:xe.a.object.isRequired,onFinished:xe.a.func.isRequired});class bm extends i.a.PureComponent{constructor(e){super(e),I()(this,"loadMoreEdits",async e=>{if(e||!this.state.nextBatch&&!this.state.isLoading)return!1;const t={from:this.state.nextBatch},s=this.props.mxEvent.getRoomId(),n=this.props.mxEvent.getId(),a=ee.a.get();let i,o,r;const l=new Promise((e,t)=>{o=e,r=t});try{i=await a.relations(s,n,"m.replace","m.room.message",t)}catch(e){return e.errcode&&console.error("fetching /relations failed with error",e),this.setState({error:e},()=>r(e)),l}const c=i.events;return this._locallyRedactEventsIfNeeded(c),this.setState({originalEvent:this.state.originalEvent||i.originalEvent,events:this.state.events.concat(c),nextBatch:i.nextBatch,isLoading:!1},()=>{const e=!!this.state.nextBatch;o(e)}),l}),this.state={originalEvent:null,error:null,events:[],nextBatch:null,isLoading:!0,isTwelveHour:F.a.getValue("showTwelveHourTimestamps")}}_locallyRedactEventsIfNeeded(e){const t=this.props.mxEvent.getRoomId(),s=ee.a.get().getRoom(t).getPendingEvents();for(const t of e){const e=s.find(e=>"m.room.redaction"===e.getType()&&e.getAssociatedId()===t.getId());e&&t.markLocallyRedacted(e)}}componentDidMount(){this.loadMoreEdits()}_renderEdits(){const e=d.getComponent("messages.EditHistoryMessage"),t=d.getComponent("messages.DateSeparator"),s=[];let n,a=this.state.events;this.state.originalEvent&&!this.state.nextBatch&&(a=a.concat(this.state.originalEvent));const o=this.props.mxEvent.getId();return a.forEach((r,l)=>{n&&!Object(kc.e)(n.getDate(),r.getDate())||s.push(i.a.createElement("li",{key:r.getTs()+"~"},i.a.createElement(t,{ts:r.getTs()})));const c=r.getId()===o;s.push(i.a.createElement(e,{key:r.getId(),previousEdit:c?null:a[l+1],isBaseEvent:c,mxEvent:r,isTwelveHour:this.state.isTwelveHour})),n=r}),s}render(){let e;if(this.state.error){const{error:t}=this.state;e="M_UNRECOGNIZED"===t.errcode?i.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(l.a)("Your homeserver doesn't seem to support this feature.")):t.errcode?i.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(l.a)("Something went wrong!")):i.a.createElement("p",{className:"mx_MessageEditHistoryDialog_error"},Object(l.a)("Cannot reach homeserver"),i.a.createElement("br",null),Object(l.a)("Ensure you have a stable internet connection, or get in touch with the server admin"))}else if(this.state.isLoading){const t=d.getComponent("elements.Spinner");e=i.a.createElement(t,null)}else{const t=d.getComponent("structures.ScrollPanel");e=i.a.createElement(t,{className:"mx_MessageEditHistoryDialog_scrollPanel",onFillRequest:this.loadMoreEdits,stickyBottom:!1,startAtBottom:!1},i.a.createElement("ul",{className:"mx_MessageEditHistoryDialog_edits mx_MessagePanel_alwaysShowTimestamps"},this._renderEdits()))}const t=d.getComponent("views.dialogs.BaseDialog");return i.a.createElement(t,{className:"mx_MessageEditHistoryDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Message edits")},e)}}I()(bm,"propTypes",{mxEvent:xe.a.object.isRequired});var vm,_m,ym,Em=s(455);let Cm=ya("views.dialogs.NewSessionReviewDialog")((ym=_m=class extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"onCancelClick",()=>{const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Verification failed","insecure",e,{headerImage:s(348),title:Object(l.a)("Your account is not secure"),description:i.a.createElement("div",null,Object(l.a)("One of the following may be compromised:"),i.a.createElement("ul",null,i.a.createElement("li",null,Object(l.a)("Your password")),i.a.createElement("li",null,Object(l.a)("Your homeserver")),i.a.createElement("li",null,Object(l.a)("This session, or the other session")),i.a.createElement("li",null,Object(l.a)("The internet connection either session is using"))),i.a.createElement("div",null,Object(l.a)("We recommend you change your password and Security Key in Settings immediately"))),onFinished:()=>this.props.onFinished(!1)})}),I()(this,"onContinueClick",()=>{const{userId:e,device:t}=this.props,s=ee.a.get(),n=s.requestVerification(e,[t.deviceId]);this.props.onFinished(!0),De.a.createTrackedDialog("New Session Verification","Starting dialog",Em.a,{verificationRequestPromise:n,member:s.getUser(e)})})}render(){const{device:e}=this.props,t=i.a.createElement("span",{className:"mx_NewSessionReviewDialog_headerIcon mx_E2EIcon_warning"}),s=Object(l.a)("New session"),n=i.a.createElement("h2",{className:"mx_NewSessionReviewDialog_header"},t,s);return i.a.createElement(cs.a,{title:n,onFinished:this.props.onFinished},i.a.createElement("div",{className:"mx_NewSessionReviewDialog_body"},i.a.createElement("p",null,Object(l.a)("Use this session to verify your new one, granting it access to encrypted messages:")),i.a.createElement("div",{className:"mx_NewSessionReviewDialog_deviceInfo"},i.a.createElement("div",null,i.a.createElement("span",{className:"mx_NewSessionReviewDialog_deviceName"},e.getDisplayName())," ",i.a.createElement("span",{className:"mx_NewSessionReviewDialog_deviceID"},"(",e.deviceId,")"))),i.a.createElement("p",null,Object(l.a)("If you didn’t sign in to this session, your account may be compromised.")),i.a.createElement(da.a,{cancelButton:Object(l.a)("This wasn't me"),cancelButtonClass:"danger",primaryButton:Object(l.a)("Continue"),onCancel:this.onCancelClick,onPrimaryButtonClick:this.onContinueClick})))}},I()(_m,"propTypes",{userId:xe.a.string.isRequired,device:xe.a.object.isRequired,onFinished:xe.a.func.isRequired}),vm=ym))||vm;var wm=s(1468);const Sm=["sub","sup","del","u"],xm=["text","softbreak","linebreak","paragraph","document"];function Rm(e){if(null!=e.literal&&null!=e.literal.match('^<((div|span) data-mx-maths="[^"]*"|/(div|span))>$'))return!0;const t=/^<\/?(.*)>$/.exec(e.literal);if(t&&2==t.length){const e=t[1];return Sm.indexOf(e)>-1}return!1}function Om(e){Rm(e)?this.lit(e.literal):this.lit(Object(Pa.escape)(e.literal))}function km(e){let t=e;for(;t.parent;)t=t.parent;return t.firstChild!=t.lastChild}class Im{constructor(e){this.input=e;const t=new wm.Parser;this.parsed=t.parse(this.input)}isPlainText(){const e=this.parsed.walker();let t;for(;t=e.next();){const e=t.node;if(!(xm.indexOf(e.type)>-1)){if("html_inline"!=e.type&&"html_block"!=e.type)return!1;if(Rm(e))return!1}}return!0}toHTML({externalLinks:e=!1}={}){const t=new wm.HtmlRenderer({safe:!1,softbreak:"<br />"}),s=t.paragraph;return t.paragraph=function(e,t){km(e)&&s.call(this,e,t)},t.link=function(t,s){const n=this.attrs(t);s?(n.push(["href",this.esc(t.destination)]),t.title&&n.push(["title",this.esc(t.title)]),e&&(n.push(["target","_blank"]),n.push(["rel","noreferrer noopener"])),this.tag("a",n)):this.tag("/a")},t.html_inline=Om,t.html_block=function(e){Om.call(this,e)},t.render(this.parsed)}toPlaintext(){const e=new wm.HtmlRenderer({safe:!1});e.paragraph;return e.paragraph=function(e,t){km(e)&&!t&&e.next&&this.lit("\n\n")},e.html_block=function(e){this.lit(e.literal),km(e)&&e.next&&this.lit("\n\n")},e.render(this.parsed)}}class Tm extends a.PureComponent{constructor(e){super(e),I()(this,"_onReasonChange",({target:{value:e}})=>{this.setState({reason:e})}),I()(this,"_onCancel",()=>{this.props.onFinished(!1)}),I()(this,"_onSubmit",async()=>{if(this.state.reason&&this.state.reason.trim()){this.setState({busy:!0,err:null});try{const e=this.props.mxEvent;await ee.a.get().reportEvent(e.getRoomId(),e.getId(),-100,this.state.reason.trim()),this.props.onFinished(!0)}catch(e){this.setState({busy:!1,err:e.message})}}else this.setState({err:Object(l.a)("Please fill why you're reporting.")})}),this.state={reason:"",busy:!1,err:null}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("elements.Spinner"),n=d.getComponent("elements.Field");let a=null;this.state.err&&(a=i.a.createElement("div",{className:"error"},this.state.err));let o=null;this.state.busy&&(o=i.a.createElement("div",{className:"progress"},i.a.createElement(s,null)));const r=c.a.get().reportEvent&&c.a.get().reportEvent.adminMessageMD;let m;if(r){const e=new Im(r).toHTML({externalLinks:!0});m=i.a.createElement("p",{dangerouslySetInnerHTML:{__html:e}})}return i.a.createElement(e,{className:"mx_BugReportDialog",onFinished:this.props.onFinished,title:Object(l.a)("Report Content to Your Homeserver Administrator"),contentId:"mx_ReportEventDialog"},i.a.createElement("div",{className:"mx_ReportEventDialog",id:"mx_ReportEventDialog"},i.a.createElement("p",null,Object(l.a)("Reporting this message will send its unique 'event ID' to the administrator of your homeserver. If messages in this room are encrypted, your homeserver administrator will not be able to read the message text or view any files or images.")),m,i.a.createElement(n,{className:"mx_ReportEventDialog_reason",element:"textarea",label:Object(l.a)("Reason"),rows:5,onChange:this._onReasonChange,value:this.state.reason,disabled:this.state.busy}),o,a),i.a.createElement(t,{primaryButton:Object(l.a)("Send report"),onPrimaryButtonClick:this._onSubmit,focus:!0,onCancel:this._onCancel,disabled:this.state.busy}))}}function jm(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}I()(Tm,"propTypes",{mxEvent:xe.a.instanceOf(Fe.j).isRequired,onFinished:xe.a.func.isRequired});class Nm extends i.a.Component{constructor(e){super(e),I()(this,"_upgradeRoom",e=>{const t=d.getComponent("dialogs.RoomUpgradeDialog"),s=ee.a.get().getRoom(this.props.roomId);De.a.createTrackedDialog("Upgrade Room Version","",t,{room:s})}),I()(this,"_openDevtools",e=>{const t=d.getComponent("dialogs.DevtoolsDialog");De.a.createDialog(t,{roomId:this.props.roomId})}),I()(this,"_onOldRoomClicked",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"view_room",room_id:this.state.oldRoomId,event_id:this.state.oldEventId}),this.props.closeSettingsFn()}),this.state={upgradeRecommendation:null}}UNSAFE_componentWillMount(){const e=ee.a.get().getRoom(this.props.roomId);e.getRecommendedVersion().then(t=>{const s=e.currentState.getStateEvents("m.room.tombstone",""),n={},a=e.currentState.getStateEvents("m.room.create",""),i=a?a.getContent().predecessor:null;i&&i.room_id&&(n.oldRoomId=i.room_id,n.oldEventId=i.event_id,n.hasPreviousRoom=!0),this.setState(function(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?jm(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):jm(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}({upgraded:s&&s.getContent().replacement_room,upgradeRecommendation:t},n))})}render(){const e=ee.a.get().getRoom(this.props.roomId);let t;const s=e.currentState.getStateEvents("m.room.create","");let n,a;if(s&&!1===s.getContent()["m.federate"]&&(t=i.a.createElement("div",null,Object(l.a)("This room is not accessible by remote Matrix servers"))),this.state.upgradeRecommendation&&this.state.upgradeRecommendation.needsUpgrade&&!this.state.upgraded&&(n=i.a.createElement("div",null,i.a.createElement("p",{className:"mx_SettingsTab_warningText"},Object(l.a)("<b>Warning</b>: Upgrading a room will <i>not automatically migrate room members to the new version of the room.</i> We'll post a link to the new room in the old version of the room - room members will have to click this link to join the new room.",{},{b:e=>i.a.createElement("b",null,e),i:e=>i.a.createElement("i",null,e)})),i.a.createElement(pe.a,{onClick:this._upgradeRoom,kind:"primary"},Object(l.a)("Upgrade this room to the recommended room version")))),this.state.hasPreviousRoom){let e=Object(l.a)("this room");const t=ee.a.get().getRoom(this.props.roomId);t&&t.name&&(e=t.name),a=i.a.createElement(pe.a,{element:"a",onClick:this._onOldRoomClicked},Object(l.a)("View older messages in %(roomName)s.",{roomName:e}))}return i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Advanced")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Room information")),i.a.createElement("div",null,i.a.createElement("span",null,Object(l.a)("Internal room ID:"))," ",this.props.roomId)),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Room version")),i.a.createElement("div",null,i.a.createElement("span",null,Object(l.a)("Room version:"))," ",e.getVersion()),a,n))}}I()(Nm,"propTypes",{roomId:xe.a.string.isRequired,closeSettingsFn:xe.a.func.isRequired});const Pm={"m.room.avatar":Object(l.b)("Change room avatar"),"m.room.name":Object(l.b)("Change room name"),"m.room.power_levels":Object(l.b)("Change permissions"),"m.room.topic":Object(l.b)("Change topic")},Dm={"m.room.avatar":{isState:!0},"m.room.name":{isState:!0},"m.room.power_levels":{isState:!0},"m.room.topic":{isState:!0}};function Am(e,t){const s=parseInt(e);return isNaN(s)?t:s}class Um extends i.a.Component{constructor(...e){super(...e),I()(this,"_onUnbanClick",e=>{ee.a.get().unban(this.props.member.roomId,this.props.member.userId).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to unban: "+e),De.a.createTrackedDialog("Failed to unban","",t,{title:Object(l.a)("Error"),description:Object(l.a)("Failed to unban")})})})}render(){let e;return this.props.canUnban&&(e=i.a.createElement(pe.a,{kind:"danger_sm",onClick:this._onUnbanClick,className:"mx_RolesRoomSettingsTab_unbanBtn"},Object(l.a)("Unban"))),i.a.createElement("li",null,e,i.a.createElement("span",{title:Object(l.a)("Banned by %(displayName)s",{displayName:this.props.by})},i.a.createElement("strong",null,this.props.member.name),this.props.reason?" "+Object(l.a)("Reason")+": "+this.props.reason:""))}}I()(Um,"propTypes",{canUnban:xe.a.bool,member:xe.a.object.isRequired,by:xe.a.string.isRequired,reason:xe.a.string});class Mm extends i.a.Component{constructor(...e){super(...e),I()(this,"_onRoomMembership",(e,t,s)=>{t.roomId===this.props.roomId&&this.forceUpdate()}),I()(this,"_onPowerLevelsChanged",(e,t)=>{const s=ee.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents("m.room.power_levels","");let a=n&&n.getContent()||{};a=Object.assign({},a);if(e=parseInt(e),t.startsWith("event_levels_"))a.events=Object.assign({},a.events||{}),a.events[t.slice("event_levels_".length)]=e;else{const s=t.split(".");let n,i=a;for(const e of s)i[e]||(i[e]={}),n=i,i=i[e];n[s[s.length-1]]=e}s.sendStateEvent(this.props.roomId,"m.room.power_levels",a).catch(e=>{console.error(e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Power level requirement change failed","",t,{title:Object(l.a)("Error changing power level requirement"),description:Object(l.a)("An error occurred changing the room's power level requirements. Ensure you have sufficient permissions and try again.")})})}),I()(this,"_onUserPowerLevelChanged",(e,t)=>{const s=ee.a.get(),n=s.getRoom(this.props.roomId).currentState.getStateEvents("m.room.power_levels","");let a=n&&n.getContent()||{};a=Object.assign({},a),a.users||(a.users={}),a.users[t]=e,s.sendStateEvent(this.props.roomId,"m.room.power_levels",a).catch(e=>{console.error(e);const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Power level change failed","",t,{title:Object(l.a)("Error changing power level"),description:Object(l.a)("An error occurred changing the user's power level. Ensure you have sufficient permissions and try again.")})})})}componentDidMount(){ee.a.get().on("RoomState.members",this._onRoomMembership)}componentWillUnmount(){const e=ee.a.get();e&&e.removeListener("RoomState.members",this._onRoomMembership)}_populateDefaultPlEvents(e,t,s){for(const n of Object.keys(Dm))n in e||(e[n]=Dm[n].isState?t:s)}render(){const e=d.getComponent("elements.PowerSelector"),t=ee.a.get(),s=t.getRoom(this.props.roomId),n=s.currentState.getStateEvents("m.room.power_levels",""),a=n&&n.getContent()||{},o=s.currentState.mayClientSendStateEvent("m.room.power_levels",t),r={users_default:{desc:Object(l.a)("Default role"),defaultValue:0},events_default:{desc:Object(l.a)("Send messages"),defaultValue:0},invite:{desc:Object(l.a)("Invite users"),defaultValue:50},state_default:{desc:Object(l.a)("Change settings"),defaultValue:50},kick:{desc:Object(l.a)("Kick users"),defaultValue:50},ban:{desc:Object(l.a)("Ban users"),defaultValue:50},redact:{desc:Object(l.a)("Remove messages sent by others"),defaultValue:50},"notifications.room":{desc:Object(l.a)("Notify everyone"),defaultValue:50}},c=a.events||{},m=a.users||{},h=Am(a.ban,r.ban.defaultValue),u=Am(a.users_default,r.users_default.defaultValue);let p=m[t.getUserId()];void 0===p&&(p=u),this._populateDefaultPlEvents(c,Am(a.state_default,r.state_default.defaultValue),Am(a.events_default,r.events_default.defaultValue));let g,f=i.a.createElement("div",null,Object(l.a)("No users have specific privileges in this room"));if(Object.keys(m).length){const t=[],s=[];Object.keys(m).forEach(n=>{const a=ee.a.get().getUser(n),r=a.rawDisplayName?a.rawDisplayName:n,l=m[n]<p&&o;m[n]>u?t.push(i.a.createElement(e,{value:m[n],disabled:!l,label:r,key:n,powerLevelKey:n,onChange:this._onUserPowerLevelChanged})):m[n]<u&&s.push(i.a.createElement(e,{value:m[n],disabled:!l,label:r,key:n,powerLevelKey:n,onChange:this._onUserPowerLevelChanged}))});const n=(e,t)=>{const s=m[t.key]-m[e.key];return 0!==s?s:e.key.toLocaleLowerCase().localeCompare(t.key.toLocaleLowerCase())};t.sort(n),s.sort(n),t.length&&(f=i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(l.a)("Privileged Users")),t)),s.length&&(g=i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(l.a)("Muted Users")),s))}const b=s.getMembersWithMembership("ban");let v;if(b.length){const e=p>=h;v=i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(l.a)("Banned users")),i.a.createElement("ul",null,b.map(t=>{const n=t.events.member.getContent(),a=s.getMember(t.events.member.getSender());let o=t.events.member.getSender();return a&&(o=a.name),i.a.createElement(Um,{key:t.userId,canUnban:e,member:t,reason:n.reason,by:o})})))}const _=Object.keys(r).map((t,s)=>{const n=r[t],l=t.split(".");let c=a;for(const e of l){if(void 0===c)break;c=c[e]}const d=Am(c,n.defaultValue);return i.a.createElement("div",{key:s,className:""},i.a.createElement(e,{label:n.desc,value:d,usersDefault:u,disabled:!o||p<d,powerLevelKey:t,onChange:this._onPowerLevelsChanged}))});delete c["m.room.encryption"],delete c["im.vector.modular.widgets"],delete c["m.room.canonical_alias"],delete c["m.room.history_visibility"],delete c["m.room.server_acl"],delete c["m.room.tombstone"];const y=Object.keys(c).map((t,s)=>{let n=Pm[t];return n=n?Object(l.a)(n):Object(l.a)("Send %(eventType)s events",{eventType:t}),i.a.createElement("div",{className:"",key:t},i.a.createElement(e,{label:n,value:c[t],usersDefault:u,disabled:!o||p<c[t],powerLevelKey:"event_levels_"+t,onChange:this._onPowerLevelsChanged}))});return i.a.createElement("div",{className:"mx_SettingsTab mx_RolesRoomSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Roles & Permissions")),f,g,v,i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Permissions")),i.a.createElement("p",null,Object(l.a)("Select the roles required to change various parts of the room")),_,y))}}I()(Mm,"propTypes",{roomId:xe.a.string.isRequired});class Lm extends i.a.Component{constructor(e){super(e),I()(this,"_uploadAvatar",()=>{this._avatarUpload.current.click()}),I()(this,"_removeAvatar",()=>{this._avatarUpload.current.value="",this.setState({avatarUrl:null,avatarFile:null,enableProfileSave:!0})}),I()(this,"_cancelProfileChanges",async e=>{e.stopPropagation(),e.preventDefault(),this.state.enableProfileSave&&this.setState({enableProfileSave:!1,displayName:this.state.originalDisplayName,topic:this.state.originalTopic,avatarUrl:this.state.originalAvatarUrl,avatarFile:null})}),I()(this,"_saveProfile",async e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.enableProfileSave)return;this.setState({enableProfileSave:!1});const t=ee.a.get(),s={};if(this.state.originalDisplayName!==this.state.displayName&&(await t.setRoomName(this.props.roomId,this.state.displayName),s.originalDisplayName=this.state.displayName),this.state.avatarFile){const e=await t.uploadContent(this.state.avatarFile);await t.sendStateEvent(this.props.roomId,"m.room.avatar",{url:e},""),s.avatarUrl=t.mxcUrlToHttp(e,96,96,"crop",!1),s.originalAvatarUrl=s.avatarUrl,s.avatarFile=null}else this.state.originalAvatarUrl!==this.state.avatarUrl&&await t.sendStateEvent(this.props.roomId,"m.room.avatar",{},"");this.state.originalTopic!==this.state.topic&&(await t.setRoomTopic(this.props.roomId,this.state.topic),s.originalTopic=this.state.topic),this.setState(s)}),I()(this,"_onDisplayNameChanged",e=>{this.setState({displayName:e.target.value}),this.state.originalDisplayName===e.target.value?this.setState({enableProfileSave:!1}):this.setState({enableProfileSave:!0})}),I()(this,"_onTopicChanged",e=>{this.setState({topic:e.target.value}),this.state.originalTopic===e.target.value?this.setState({enableProfileSave:!1}):this.setState({enableProfileSave:!0})}),I()(this,"_onAvatarChanged",e=>{if(!e.target.files||!e.target.files.length)return void this.setState({avatarUrl:this.state.originalAvatarUrl,avatarFile:null,enableProfileSave:!1});const t=e.target.files[0],s=new FileReader;s.onload=e=>{this.setState({avatarUrl:e.target.result,avatarFile:t,enableProfileSave:!0})},s.readAsDataURL(t)});const t=ee.a.get(),s=t.getRoom(e.roomId);if(!s)throw new Error("Expected a room for ID: ",e.roomId);const n=s.currentState.getStateEvents("m.room.avatar","");let i=n&&n.getContent()?n.getContent().url:null;i&&(i=t.mxcUrlToHttp(i,96,96,"crop",!1));const o=s.currentState.getStateEvents("m.room.topic",""),r=o&&o.getContent()?o.getContent().topic:"",l=s.currentState.getStateEvents("m.room.name",""),c=l&&l.getContent()?l.getContent().name:"";this.state={originalDisplayName:c,displayName:c,originalAvatarUrl:i,avatarUrl:i,avatarFile:null,originalTopic:r,topic:r,enableProfileSave:!1,canSetName:s.currentState.maySendStateEvent("m.room.name",t.getUserId()),canSetTopic:s.currentState.maySendStateEvent("m.room.topic",t.getUserId()),canSetAvatar:s.currentState.maySendStateEvent("m.room.avatar",t.getUserId())},this._avatarUpload=Object(a.createRef)()}render(){ee.a.get();const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("settings.AvatarSetting");let s;return(this.state.canSetName||this.state.canSetTopic||this.state.canSetAvatar)&&(s=i.a.createElement("div",{className:"mx_ProfileSettings_buttons"},i.a.createElement(e,{onClick:this._cancelProfileChanges,kind:"link",disabled:!this.state.enableProfileSave},Object(l.a)("Cancel")),i.a.createElement(e,{onClick:this._saveProfile,kind:"primary",disabled:!this.state.enableProfileSave},Object(l.a)("Save")))),i.a.createElement("form",{onSubmit:this._saveProfile,autoComplete:"off",noValidate:!0,className:"mx_ProfileSettings_profileForm"},i.a.createElement("input",{type:"file",ref:this._avatarUpload,className:"mx_ProfileSettings_avatarUpload",onChange:this._onAvatarChanged,accept:"image/*"}),i.a.createElement("div",{className:"mx_ProfileSettings_profile"},i.a.createElement("div",{className:"mx_ProfileSettings_controls"},i.a.createElement(ke.a,{label:Object(l.a)("Room Name"),type:"text",value:this.state.displayName,autoComplete:"off",onChange:this._onDisplayNameChanged,disabled:!this.state.canSetName}),i.a.createElement(ke.a,{className:"mx_ProfileSettings_controls_topic",id:"profileTopic",label:Object(l.a)("Room Topic"),disabled:!this.state.canSetTopic,type:"text",value:this.state.topic,autoComplete:"off",onChange:this._onTopicChanged,element:"textarea"})),i.a.createElement(t,{avatarUrl:this.state.avatarUrl,avatarName:this.state.displayName||this.props.roomId,avatarAltText:Object(l.a)("Room avatar"),uploadAvatar:this.state.canSetAvatar?this._uploadAvatar:void 0,removeAvatar:this.state.canSetAvatar?this._removeAvatar:void 0})),s)}}I()(Lm,"propTypes",{roomId:xe.a.string.isRequired});var Fm=s(295),Bm=(s(259),s(178),s(272),s(369));function Vm(e,t){var s=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),s.push.apply(s,n)}return s}function Wm(e){for(var t=1;t<arguments.length;t++){var s=null!=arguments[t]?arguments[t]:{};t%2?Vm(Object(s),!0).forEach((function(t){I()(e,t,s[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(s)):Vm(Object(s)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(s,t))}))}return e}class Hm extends i.a.Component{constructor(e){super(e),I()(this,"_setJoinRules",(e,t)=>{const s=ee.a.get(),n=this;s.sendStateEvent(e.roomId,"m.room.join_rules",{join_rule:t},"").then(()=>{n.setState({linkSharing:"public"===t,joinRules:t}),ee.a.get().emit("RoomState.joinRules",t)}).catch(e=>{if(console.error(e),this.setState({linkSharing:!1}),"M_FORBIDDEN"===e.errcode&&"unrestricted"===this.state.accessRules){const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failure to create room","",e,{title:Object(l.a)("Failed to open link access for this room"),description:Object(l.a)("This change is not currently supported because externs are allowed to join this room.")})}})}),I()(this,"_setUpRoomByLink",e=>{const t=ee.a.get();if(e.getCanonicalAlias())this._setJoinRules(e,"public");else{let s="";if(e.name){const t=e.name.replace(/[^a-z0-9]/gi,"");s=t+Object(Bm.b)(11)}else s=Object(Bm.b)(11);s=`#${s}:${t.getDomain()}`,t.createAlias(s,e.roomId).then(()=>{t.sendStateEvent(e.roomId,"m.room.canonical_alias",{alias:s},"").then(()=>{this._setJoinRules(e,"public")}).catch(e=>{console.error(e)})}).catch(e=>{console.error(e)})}}),I()(this,"_onLinkSharingSwitchChange",e=>{const t=ee.a.get(),s=t.getRoom(this.props.roomId);e?"can_join"===this._getGuestAccessRules(s)?t.sendStateEvent(s.roomId,"m.room.guest_access",{guest_access:"forbidden"},"").then(()=>{this._setUpRoomByLink(s)}).catch(e=>{console.error(e)}):this._setUpRoomByLink(s):this._setJoinRules(s,"invite")}),I()(this,"_onExternAllowedSwitchChange",()=>{const e=this,t=this.state.accessRules,s=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Allow the externals to join this room","",s,{title:Object(l.a)("Allow the externals to join this room"),description:Object(l.a)("This action is irreversible.")+" "+Object(l.a)("Are you sure you want to allow the externals to join this room ?"),onFinished:s=>{s?ee.a.get().sendStateEvent(e.props.roomId,"im.vector.room.access_rules",{rule:"unrestricted"},"").then(()=>{e.setState({accessRules:"unrestricted"})}).catch(s=>{if(console.error(s),e.setState({accessRules:t}),"M_FORBIDDEN"===s.errcode&&"public"===e.state.joinRules){const e=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failure to create room","",e,{title:Object(l.a)("Failed to open this room to externs"),description:Object(l.a)("This change is not currently supported because this room is accessible by link.")})}}):e.setState({accessRules:t})}})}),this._onCopyClick=this._onCopyClick.bind(this),this._onLinkClick=this._onLinkClick.bind(this),this.closeCopiedTooltip=null;const t=ee.a.get(),s=t.getRoom(e.roomId);if(!s)throw new Error("Expected a room for ID: ",e.roomId);const n=new ur.a(s);n.load();const a=n.forRoom();let i=!1;t.isRoomEncrypted(e.roomId)&&"public"===E.a.getJoinRules(e.roomId)&&(i=!0),this.state={room:s,accessRules:E.a.getAccessRules(e.roomId),joinRules:E.a.getJoinRules(e.roomId),isForumRoom:E.a.isRoomForum(e.roomId),linkSharing:i,link:a}}componentWillUnmount(){this.closeCopiedTooltip&&this.closeCopiedTooltip()}_onLinkClick(e){e.preventDefault(),Object(Fm.c)(e.target)}async _onCopyClick(e){e.preventDefault();const t=e.target,s=await Object(Fm.b)(this.state.link),a=t.getBoundingClientRect(),i=d.getComponent("context_menus.GenericTextContextMenu"),{close:o}=n.n(i,Wm(Wm({},Object(n.p)(a,2)),{},{message:s?Object(l.a)("Copied!"):Object(l.a)("Failed to copy")}));this.closeCopiedTooltip=t.onmouseleave=o}_getGuestAccessRules(e){const t=e.currentState.getStateEvents("m.room.guest_access","");if(!t)return"can_join";const s=t.getContent();return"guest_access"in s?s.guest_access:"can_join"}render(){const e=ee.a.get(),t=e.getRoom(this.props.roomId),n=t.getMember(e.getUserId()).powerLevelNorm>=100,a=new ur.a(t);a.load();let o=this.state.link;const r=a.forRoom();o!==r&&this.setState({link:r});let c=null;this.state.isForumRoom||(c=i.a.createElement(Ze.a,{value:"unrestricted"===this.state.accessRules,onChange:this._onExternAllowedSwitchChange,label:Object(l.a)("Allow the externals to join this room"),disabled:"unrestricted"===this.state.accessRules||!n}));let d=null;"unrestricted"===this.state.accessRules&&"public"===this.state.joinRules&&(d=i.a.createElement("div",{className:"tc_ExternSharing_warning"},i.a.createElement("img",{src:s(697),width:"16",height:"16",alt:"warning"}),i.a.createElement("span",null,Object(l.a)("An invitation is still required for externs, although link access is enabled."))));let m=null;this.state.linkSharing&&(m=i.a.createElement("div",{className:"mx_ShareDialog_matrixto tc_ShareDialog"},i.a.createElement("a",{ref:"link",href:this.state.link,onClick:this._onLinkClick,className:"mx_ShareDialog_matrixto_link"},this.state.link),i.a.createElement(B.a,{title:Object(l.a)("Copy"),onClick:this._onCopyClick,className:"mx_ShareDialog_matrixto_copy"})));const h=i.a.createElement("div",null,Object(l.a)("Users can join this room with the following link:"));let u=i.a.createElement("div",null,Object(l.a)("Activate link access to this room"),i.a.createElement(et.a,{tooltip:h,tooltipClass:"mx_Tooltip_dark"},i.a.createElement("img",{className:"tc_LinkSharing_Helper",src:s(350),width:20,height:20,alt:Object(l.a)("Room information")})));const p=i.a.createElement("div",null,i.a.createElement(Ze.a,{value:this.state.linkSharing,onChange:this._onLinkSharingSwitchChange,label:u,disabled:!n||this.state.isForumRoom}),d,m);return i.a.createElement("div",null,c,p)}}I()(Hm,"propTypes",{roomId:xe.a.string.isRequired});class Gm extends i.a.Component{constructor(){super(),I()(this,"_onLeaveClick",()=>{const e=d.getComponent("dialogs.QuestionDialog"),t=this.context.getRoom(this.props.roomId);E.a.isUserLastAdmin(t)?De.a.createTrackedDialog("Last admin leave","",e,{title:Object(l.a)("You are the last administrator"),description:Object(l.a)("Are you sure you want to leave the room? The room will no longer be administered, and you may not be able to join it again."),button:Object(l.a)("Leave"),onFinished:e=>{e&&m.a.dispatch({action:"leave_room",room_id:this.props.roomId})}}):m.a.dispatch({action:"leave_room",room_id:this.props.roomId})})}render(){return i.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("General")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},i.a.createElement(Lm,{roomId:this.props.roomId})),i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Leave room")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(pe.a,{kind:"danger",onClick:this._onLeaveClick},Object(l.a)("Leave room"))))}}I()(Gm,"propTypes",{roomId:xe.a.string.isRequired}),I()(Gm,"contextType",b.a);class qm extends i.a.Component{constructor(){super(),I()(this,"_onStateEvent",e=>{["m.room.join_rules","m.room.guest_access","m.room.history_visibility","m.room.encryption","im.vector.room.access_rules"].includes(e.getType())&&this.forceUpdate()}),I()(this,"_onEncryptionChange",e=>{De.a.createTrackedDialog("Enable encryption","",St.a,{title:Object(l.a)("Enable encryption?"),description:Object(l.a)("Once enabled, encryption for a room cannot be disabled. Messages sent in an encrypted room cannot be seen by the server, only by the participants of the room. Enabling encryption may prevent many bots and bridges from working correctly. <a>Learn more about encryption.</a>",{},{a:e=>i.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:"https://element.io/help#encryption"},e)}),onFinished:e=>{if(!e)return void this.setState({encrypted:!1});const t=this.state.encrypted;this.setState({encrypted:!0}),ee.a.get().sendStateEvent(this.props.roomId,"m.room.encryption",{algorithm:"m.megolm.v1.aes-sha2"}).catch(e=>{console.error(e),this.setState({encrypted:t})})}})}),I()(this,"_fixGuestAccess",e=>{e.preventDefault(),e.stopPropagation();const t=this.state.joinRule,s=this.state.guestAccess;this.setState({joinRule:"invite",guestAccess:"can_join"});const n=ee.a.get();n.sendStateEvent(this.props.roomId,"m.room.join_rules",{join_rule:"invite"},"").catch(e=>{console.error(e),this.setState({joinRule:t})}),n.sendStateEvent(this.props.roomId,"m.room.guest_access",{guest_access:"can_join"},"").catch(e=>{console.error(e),this.setState({guestAccess:s})})}),I()(this,"_onRoomAccessRadioToggle",e=>{let t="invite",s="can_join";switch(e){case"invite_only":break;case"public_no_guests":t="public",s="forbidden";break;case"public_with_guests":t="public",s="can_join"}const n=this.state.joinRule,a=this.state.guestAccess;this.setState({joinRule:t,guestAccess:s});const i=ee.a.get();i.sendStateEvent(this.props.roomId,"m.room.join_rules",{join_rule:t},"").catch(e=>{console.error(e),this.setState({joinRule:n})}),i.sendStateEvent(this.props.roomId,"m.room.guest_access",{guest_access:s},"").catch(e=>{console.error(e),this.setState({guestAccess:a})})}),I()(this,"_onHistoryRadioToggle",e=>{const t=this.state.history;this.setState({history:e}),ee.a.get().sendStateEvent(this.props.roomId,"m.room.history_visibility",{history_visibility:e},"").catch(e=>{console.error(e),this.setState({history:t})})}),I()(this,"_updateBlacklistDevicesFlag",e=>{ee.a.get().getRoom(this.props.roomId).setBlacklistUnverifiedDevices(e)}),this.state={joinRule:"invite",guestAccess:"can_join",history:"shared",hasAliases:!1,encrypted:!1}}async UNSAFE_componentWillMount(){ee.a.get().on("RoomState.events",this._onStateEvent);const e=ee.a.get().getRoom(this.props.roomId).currentState,t=this._pullContentPropertyFromEvent(e.getStateEvents("m.room.join_rules",""),"join_rule","invite"),s=this._pullContentPropertyFromEvent(e.getStateEvents("m.room.guest_access",""),"guest_access","forbidden"),n=this._pullContentPropertyFromEvent(e.getStateEvents("m.room.history_visibility",""),"history_visibility","shared"),a=ee.a.get().isRoomEncrypted(this.props.roomId);this.setState({joinRule:t,guestAccess:s,history:n,encrypted:a});const i=await this._hasAliases();this.setState({hasAliases:i})}_pullContentPropertyFromEvent(e,t,s){return e&&e.getContent()&&e.getContent()[t]||s}componentWillUnmount(){ee.a.get().removeListener("RoomState.events",this._onStateEvent)}async _hasAliases(){const e=ee.a.get();if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const t=(await e.unstableGetLocalAliases(this.props.roomId)).aliases;return Array.isArray(t)&&0!==t.length}return!!(e.getRoom(this.props.roomId).currentState.getStateEvents("m.room.aliases")||[]).find(e=>(e.getContent().aliases||[]).length>0)}_renderRoomAccess(){const e=ee.a.get(),t=e.getRoom(this.props.roomId),n=this.state.joinRule,a=this.state.guestAccess,o=t.currentState.mayClientSendStateEvent("m.room.join_rules",e)&&t.currentState.mayClientSendStateEvent("m.room.guest_access",e);let r=null;"public"!==n&&"forbidden"===a&&(r=i.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},i.a.createElement("img",{src:s(160),width:15,height:15}),i.a.createElement("span",null,Object(l.a)("Guests cannot join this room even if explicitly invited.")," ",i.a.createElement("a",{href:"",onClick:this._fixGuestAccess},Object(l.a)("Click here to fix")))));let c=null;return"public"!==n||this.state.hasAliases||(c=i.a.createElement("div",{className:"mx_SecurityRoomSettingsTab_warning"},i.a.createElement("img",{src:s(160),width:15,height:15}),i.a.createElement("span",null,Object(l.a)("To link to this room, please add an address.")))),i.a.createElement("div",null,r,c,i.a.createElement(bt,{name:"roomVis",value:n,onChange:this._onRoomAccessRadioToggle,definitions:[{value:"invite_only",disabled:!o,label:Object(l.a)("Only people who have been invited"),checked:"public"!==n},{value:"public_no_guests",disabled:!o,label:Object(l.a)("Anyone who knows the room's link, apart from guests"),checked:"public"===n&&"can_join"!==a},{value:"public_with_guests",disabled:!o,label:Object(l.a)("Anyone who knows the room's link, including guests"),checked:"public"===n&&"can_join"===a}]}))}_renderHistory(){const e=ee.a.get(),t=this.state.history,s=e.getRoom(this.props.roomId).currentState.mayClientSendStateEvent("m.room.history_visibility",e);return i.a.createElement("div",null,i.a.createElement("div",null,Object(l.a)("Changes to who can read history will only apply to future messages in this room. The visibility of existing history will be unchanged.")),i.a.createElement(bt,{name:"historyVis",value:t,onChange:this._onHistoryRadioToggle,definitions:[{value:"world_readable",disabled:!s,label:Object(l.a)("Anyone")},{value:"shared",disabled:!s,label:Object(l.a)("Members only (since the point in time of selecting this option)")},{value:"invited",disabled:!s,label:Object(l.a)("Members only (since they were invited)")},{value:"joined",disabled:!s,label:Object(l.a)("Members only (since they joined)")}]}))}render(){const e=d.getComponent("elements.SettingsFlag"),t=ee.a.get(),s=t.getRoom(this.props.roomId),n=this.state.encrypted,a=s.currentState.mayClientSendStateEvent("m.room.encryption",t),o=!n&&a;let r=null;n&&F.a.isEnabled("blacklistUnverifiedDevices")&&(r=i.a.createElement(e,{name:"blacklistUnverifiedDevices",level:Qe.a.ROOM_DEVICE,onChange:this._updateBlacklistDevicesFlag,roomId:this.props.roomId}));let c=i.a.createElement(i.a.Fragment,null,i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Who can read history?")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this._renderHistory()));return F.a.getValue(Xe.a.RoomHistorySettings)||(c=null),i.a.createElement("div",{className:"mx_SettingsTab mx_SecurityRoomSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Security & Privacy")),i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Encryption")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SecurityRoomSettingsTab_encryptionSection"},i.a.createElement("div",null,i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},i.a.createElement("span",null,Object(l.a)("Once enabled, encryption cannot be disabled."))),i.a.createElement(Ze.a,{value:n,onChange:this._onEncryptionChange,label:Object(l.a)("Encrypted"),disabled:!o})),r),i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Who can access this room?")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},this._renderRoomAccess()),c)}}I()(qm,"propTypes",{roomId:xe.a.string.isRequired});class Km extends i.a.Component{constructor(){super(),I()(this,"_soundUpload",Object(a.createRef)()),this.state={currentSound:"default",uploadedFile:null}}UNSAFE_componentWillMount(){const e=Nn.default.getSoundForRoom(this.props.roomId);e&&this.setState({currentSound:e.name||e.url})}async _triggerUploader(e){e.stopPropagation(),e.preventDefault(),this._soundUpload.current.click()}async _onSoundUploadChanged(e){if(!e.target.files||!e.target.files.length)return void this.setState({uploadedFile:null});const t=e.target.files[0];this.setState({uploadedFile:t})}async _onClickSaveSound(e){e.stopPropagation(),e.preventDefault();try{await this._saveSound()}catch(e){console.error("Unable to save notification sound for "+this.props.roomId),console.error(e)}}async _saveSound(){if(!this.state.uploadedFile)return;let e=this.state.uploadedFile.type;"video/ogg"===e&&(e="audio/ogg");const t=await ee.a.get().uploadContent(this.state.uploadedFile,{type:e});await F.a.setValue("notificationSound",this.props.roomId,Qe.a.ROOM_ACCOUNT,{name:this.state.uploadedFile.name,type:e,size:this.state.uploadedFile.size,url:t}),this.setState({uploadedFile:null,currentSound:this.state.uploadedFile.name})}_clearSound(e){e.stopPropagation(),e.preventDefault(),F.a.setValue("notificationSound",this.props.roomId,Qe.a.ROOM_ACCOUNT,null),this.setState({currentSound:"default"})}render(){let e=null;return this.state.uploadedFile&&(e=i.a.createElement("div",null,i.a.createElement("span",null,Object(l.a)("Uploaded sound"),": ",i.a.createElement("code",null,this.state.uploadedFile.name)))),i.a.createElement("div",{className:"mx_SettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Notifications")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_SettingsTab_subsectionText"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Sounds")),i.a.createElement("div",null,i.a.createElement("span",null,Object(l.a)("Notification sound"),": ",i.a.createElement("code",null,this.state.currentSound)),i.a.createElement("br",null),i.a.createElement(pe.a,{className:"mx_NotificationSound_resetSound",disabled:"default"==this.state.currentSound,onClick:this._clearSound.bind(this),kind:"primary"},Object(l.a)("Reset"))),i.a.createElement("div",null,i.a.createElement("h3",null,Object(l.a)("Set a new custom sound")),i.a.createElement("form",{autoComplete:"off",noValidate:!0},i.a.createElement("input",{ref:this._soundUpload,className:"mx_NotificationSound_soundUpload",type:"file",onChange:this._onSoundUploadChanged.bind(this),accept:"audio/*"})),e,i.a.createElement(pe.a,{className:"mx_NotificationSound_browse",onClick:this._triggerUploader.bind(this),kind:"primary"},Object(l.a)("Browse")),i.a.createElement(pe.a,{className:"mx_NotificationSound_save",disabled:null==this.state.uploadedFile,onClick:this._onClickSaveSound.bind(this),kind:"primary"},Object(l.a)("Save")),i.a.createElement("br",null))))}}I()(Km,"propTypes",{roomId:xe.a.string.isRequired});class zm extends i.a.Component{constructor(){super(),I()(this,"_onRoomPublishChange",()=>{const e=this.context,t=e.getRoom(this.props.roomId),s=this,n=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Remove this room from the forums directory","",n,{title:Object(l.a)("Remove this room from the forums directory"),description:Object(l.a)("This action is irreversible.")+" "+Object(l.a)("Are you sure you want to remove this room from the forums directory?"),onFinished:n=>{n&&(e.sendStateEvent(t.roomId,"m.room.encryption",{algorithm:"m.megolm.v1.aes-sha2"}),e.sendStateEvent(t.roomId,"m.room.join_rules",{join_rule:"invite"},""),e.sendStateEvent(t.roomId,"m.room.history_visibility",{history_visibility:"invited"},""),e.setRoomDirectoryVisibility(t.roomId,"private").catch(()=>{this.setState({isRoomPublished:!0})}),s.setState({isRoomPublished:!1}))}})}),this.state={isRoomPublished:!1}}componentDidMount(){this.context.getRoomDirectoryVisibility(this.props.roomId).then(e=>{this.setState({isRoomPublished:"public"===e.visibility})})}render(){const e=this.context;let t=null;return e.getRoom(this.props.roomId).getMember(e.getUserId()).powerLevelNorm>=100&&this.state.isRoomPublished&&(t=i.a.createElement("div",null,i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Remove this room from the forums directory")),i.a.createElement("div",{className:"mx_SettingsTab_section"},i.a.createElement(pe.a,{kind:"primary",onClick:this._onRoomPublishChange},Object(l.a)("Remove this room from the forums directory"))))),i.a.createElement("div",{className:"mx_SettingsTab mx_GeneralRoomSettingsTab"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},Object(l.a)("Type & Access")),i.a.createElement("div",{className:"mx_SettingsTab_subheading"},Object(l.a)("Access")),i.a.createElement("div",{className:"mx_SettingsTab_section mx_GeneralRoomSettingsTab_profileSection"},i.a.createElement(Hm,{roomId:this.props.roomId}),t))}}I()(zm,"propTypes",{roomId:xe.a.string.isRequired}),I()(zm,"contextType",b.a);class $m extends i.a.Component{constructor(...e){super(...e),I()(this,"_onAction",e=>{"view_home_page"===e.action&&this.props.onFinished()})}componentDidMount(){this._dispatcherRef=m.a.register(this._onAction)}componentWillUnmount(){this._dispatcherRef&&m.a.unregister(this._dispatcherRef)}_getTabs(){const e=[];return e.push(new Re("ROOM_GENERAL_TAB",Object(l.b)("General"),"mx_RoomSettingsDialog_settingsIcon",i.a.createElement(Gm,{roomId:this.props.roomId}))),e.push(new Re("ROOM_ACCESS_TAB",Object(l.b)("Type & Access"),"tc_RoomSettingsDialog_accessIcon",i.a.createElement(zm,{roomId:this.props.roomId}))),e.push(new Re("ROOM_ROLES_TAB",Object(l.b)("Roles & Permissions"),"mx_RoomSettingsDialog_rolesIcon",i.a.createElement(Mm,{roomId:this.props.roomId}))),e.push(new Re("ROOM_NOTIFICATIONS_TAB",Object(l.b)("Notifications"),"mx_RoomSettingsDialog_notificationsIcon",i.a.createElement(Km,{roomId:this.props.roomId}))),F.a.getValue("feature_bridge_state")&&e.push(new Re("ROOM_BRIDGES_TAB",Object(l.b)("Bridges"),"mx_RoomSettingsDialog_bridgesIcon",i.a.createElement(ec,{roomId:this.props.roomId}))),e}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=ee.a.get().getRoom(this.props.roomId).name;return i.a.createElement(e,{className:"mx_RoomSettingsDialog tc_RoomSettingsDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Room Settings - %(roomName)s",{roomName:t})},i.a.createElement("div",{className:"ms_SettingsDialog_content"},i.a.createElement(Oe,{tabs:this._getTabs()})))}}I()($m,"propTypes",{roomId:xe.a.string.isRequired,onFinished:xe.a.func.isRequired});class Ym extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{busy:!0}),I()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),I()(this,"_onUpgradeClick",()=>{this.setState({busy:!0}),ee.a.get().upgradeRoom(this.props.room.roomId,this._targetVersion).then(()=>{this.props.onFinished(!0)}).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to upgrade room","",t,{title:Object(l.a)("Failed to upgrade room"),description:e&&e.message?e.message:Object(l.a)("The room upgrade could not be completed")})}).finally(()=>{this.setState({busy:!1})})})}async componentDidMount(){const e=await this.props.room.getRecommendedVersion();this._targetVersion=e.version,this.setState({busy:!1})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=d.getComponent("views.elements.Spinner");let n;return n=this.state.busy?i.a.createElement(s,null):i.a.createElement(t,{primaryButton:Object(l.a)("Upgrade this room to version %(version)s",{version:this._targetVersion}),primaryButtonClass:"danger",hasCancel:!0,onPrimaryButtonClick:this._onUpgradeClick,focus:this.props.focus,onCancel:this._onCancelClick}),i.a.createElement(e,{className:"mx_RoomUpgradeDialog",onFinished:this.props.onFinished,title:Object(l.a)("Upgrade Room Version"),contentId:"mx_Dialog_content",hasCancel:!0},i.a.createElement("p",null,Object(l.a)("Upgrading this room requires closing down the current instance of the room and creating a new room in its place. To give room members the best possible experience, we will:")),i.a.createElement("ol",null,i.a.createElement("li",null,Object(l.a)("Create a new room with the same name, description and avatar")),i.a.createElement("li",null,Object(l.a)("Update any local room aliases to point to the new room")),i.a.createElement("li",null,Object(l.a)("Stop users from speaking in the old version of the room, and post a message advising users to move to the new room")),i.a.createElement("li",null,Object(l.a)("Put a link back to the old room at the start of the new room so people can see old messages"))),n)}}I()(Ym,"propTypes",{room:xe.a.object.isRequired,onFinished:xe.a.func.isRequired});class Jm extends i.a.Component{constructor(e){super(e),I()(this,"_onContinue",()=>{this.props.onFinished({continue:!0,invite:this.state.isPrivate&&this.state.inviteUsersToNewRoom})}),I()(this,"_onCancel",()=>{this.props.onFinished({continue:!1,invite:!1})}),I()(this,"_onInviteUsersToggle",e=>{this.setState({inviteUsersToNewRoom:e})}),I()(this,"_openBugReportDialog",e=>{e.preventDefault(),e.stopPropagation();const t=d.getComponent("dialogs.BugReportDialog");De.a.createTrackedDialog("Bug Report Dialog","",t,{})});const t=ee.a.get().getRoom(this.props.roomId),s=t?t.currentState.getStateEvents("m.room.join_rules",""):null,n=!s||"public"!==s.getContent().join_rule;this.state={currentVersion:t?t.getVersion():"1",isPrivate:n,inviteUsersToNewRoom:!0}}render(){const e=c.a.get().brand,t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons");let n=null;this.state.isPrivate&&(n=i.a.createElement(Ze.a,{value:this.state.inviteUsersToNewRoom,onChange:this._onInviteUsersToggle,label:Object(l.a)("Automatically invite users")}));const a=this.state.isPrivate?Object(l.a)("Upgrade private room"):Object(l.a)("Upgrade forum");return i.a.createElement(t,{className:"mx_RoomUpgradeWarningDialog",hasCancel:!0,fixedWidth:!1,onFinished:this.props.onFinished,title:a},i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Upgrading a room is an advanced action and is usually recommended when a room is unstable due to bugs, missing features or security vulnerabilities.")),i.a.createElement("p",null,Object(l.a)("This usually only affects how the room is processed on the server. If you're having problems with your %(brand)s, please <a>report a bug</a>.",{brand:e},{a:e=>i.a.createElement("a",{href:"#",onClick:this._openBugReportDialog},e)})),i.a.createElement("p",null,Object(l.a)("You'll upgrade this room from <oldVersion /> to <newVersion />.",{},{oldVersion:()=>i.a.createElement("code",null,this.state.currentVersion),newVersion:()=>i.a.createElement("code",null,this.props.targetVersion)})),n),i.a.createElement(s,{primaryButton:Object(l.a)("Upgrade"),onPrimaryButtonClick:this._onContinue,cancelButton:Object(l.a)("Cancel"),onCancel:this._onCancel}))}}I()(Jm,"propTypes",{onFinished:xe.a.func.isRequired,roomId:xe.a.string.isRequired,targetVersion:xe.a.string.isRequired});class Qm extends i.a.Component{constructor(...e){super(...e),I()(this,"_sendBugReport",()=>{const e=d.getComponent("dialogs.BugReportDialog");De.a.createTrackedDialog("Session Restore Error","Send Bug Report Dialog",e,{})}),I()(this,"_onClearStorageClick",()=>{const e=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Session Restore Confirm Logout","",e,{title:Object(l.a)("Sign out"),description:i.a.createElement("div",null,Object(l.a)("Sign out and remove encryption keys?")),button:Object(l.a)("Sign out"),danger:!0,onFinished:this.props.onFinished})}),I()(this,"_onRefreshClick",()=>{window.location.reload(!0)})}render(){const e=c.a.get().brand,t=d.getComponent("views.dialogs.BaseDialog"),s=d.getComponent("views.elements.DialogButtons");this._onClearStorageClick,Object(l.a)("Clear Storage and Sign Out");let n=i.a.createElement(s,{primaryButton:Object(l.a)("Send Logs"),onPrimaryButtonClick:this._sendBugReport,focus:!0,hasCancel:!1});return i.a.createElement(t,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(l.a)("Unable to restore session"),contentId:"mx_Dialog_content",hasCancel:!1},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("p",null,Object(l.a)("We encountered an error trying to restore your previous session.")),i.a.createElement("p",null,Object(l.a)("If you have previously used a more recent version of %(brand)s, your session may be incompatible with this version. Close this window and return to the more recent version.",{brand:e})),i.a.createElement("p",null,Object(l.a)("Clearing your browser's storage may fix the problem, but will sign you out and cause any encrypted chat history to become unreadable."))),n)}}function Xm(){return ee.a.get().idBaseUrl.split("://")[1]}I()(Qm,"propTypes",{error:xe.a.string.isRequired,onFinished:xe.a.func.isRequired});class Zm{constructor(){I()(this,"_makeAddThreepidOnlyRequest",e=>ee.a.get().addThreePidOnly({sid:this.sessionId,client_secret:this.clientSecret,auth:e})),this.clientSecret=ee.a.get().generateClientSecret(),this.sessionId=null,this.submitUrl=null}addEmailAddress(e){return ee.a.get().requestAdd3pidEmailToken(e,this.clientSecret,1).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(l.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindEmailAddress(e){if(this.bind=!0,await ee.a.get().doesServerSupportSeparateAddAndBind()){const t=new ze.a,s=await t.getAccessToken();return ee.a.get().requestEmailToken(e,this.clientSecret,1,void 0,void 0,s).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(l.a)("This email address is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addEmailAddress(e)}addMsisdn(e,t){return ee.a.get().requestAdd3pidMsisdnToken(e,t,this.clientSecret,1).then(e=>(this.sessionId=e.sid,this.submitUrl=e.submit_url,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(l.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}async bindMsisdn(e,t){if(this.bind=!0,await ee.a.get().doesServerSupportSeparateAddAndBind()){const s=new ze.a,n=await s.getAccessToken();return ee.a.get().requestMsisdnToken(e,t,this.clientSecret,1,void 0,void 0,n).then(e=>(this.sessionId=e.sid,e),(function(e){throw"M_THREEPID_IN_USE"===e.errcode?e.message=Object(l.a)("This phone number is already in use"):e.httpStatus&&(e.message=e.message+` (Status ${e.httpStatus})`),e}))}return this.addMsisdn(e,t)}async checkEmailLinkClicked(){try{if(await ee.a.get().doesServerSupportSeparateAddAndBind())if(this.bind){const e=new ze.a,t=await e.getAccessToken();await ee.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Xm(),id_access_token:t})}else try{return void await this._makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s={[Be.c.PHASE_PREAUTH]:{title:Object(l.a)("Use Single Sign On to continue"),body:Object(l.a)("Confirm adding this email address by using Single Sign On to prove your identity."),continueText:Object(l.a)("Single Sign On"),continueKind:"primary"},[Be.c.PHASE_POSTAUTH]:{title:Object(l.a)("Confirm adding email"),body:Object(l.a)("Click the button below to confirm adding this email address."),continueText:Object(l.a)("Confirm"),continueKind:"primary"}},{finished:n}=De.a.createTrackedDialog("Add Email","",t,{title:Object(l.a)("Add Email Address"),matrixClient:ee.a.get(),authData:e.data,makeRequest:this._makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Be.c.LOGIN_TYPE]:s,[Be.c.UNSTABLE_LOGIN_TYPE]:s}});return n}else await ee.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Xm()},this.bind)}catch(e){throw 401===e.httpStatus?e.message=Object(l.a)("Failed to verify email address: make sure you clicked the link in the email"):e.httpStatus&&(e.message+=` (Status ${e.httpStatus})`),e}}async haveMsisdnToken(e){const t=new ze.a,s=await ee.a.get().doesServerSupportSeparateAddAndBind();let n;if(this.submitUrl)n=await ee.a.get().submitMsisdnTokenOtherUrl(this.submitUrl,this.sessionId,this.clientSecret,e);else{if(!this.bind&&s)throw new Error("The add / bind with MSISDN flow is misconfigured");n=await ee.a.get().submitMsisdnToken(this.sessionId,this.clientSecret,e,await t.getAccessToken())}if(n.errcode)throw n;if(s)if(this.bind)await ee.a.get().bindThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Xm(),id_access_token:await t.getAccessToken()});else try{return void await this._makeAddThreepidOnlyRequest()}catch(e){if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s={[Be.c.PHASE_PREAUTH]:{title:Object(l.a)("Use Single Sign On to continue"),body:Object(l.a)("Confirm adding this phone number by using Single Sign On to prove your identity."),continueText:Object(l.a)("Single Sign On"),continueKind:"primary"},[Be.c.PHASE_POSTAUTH]:{title:Object(l.a)("Confirm adding phone number"),body:Object(l.a)("Click the button below to confirm adding this phone number."),continueText:Object(l.a)("Confirm"),continueKind:"primary"}},{finished:n}=De.a.createTrackedDialog("Add MSISDN","",t,{title:Object(l.a)("Add Phone Number"),matrixClient:ee.a.get(),authData:e.data,makeRequest:this._makeAddThreepidOnlyRequest,aestheticsForStagePhases:{[Be.c.LOGIN_TYPE]:s,[Be.c.UNSTABLE_LOGIN_TYPE]:s}});return n}else await ee.a.get().addThreePid({sid:this.sessionId,client_secret:this.clientSecret,id_server:Xm()},this.bind)}}class eh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{emailAddress:"",emailBusy:!1}),I()(this,"onEmailAddressChanged",e=>{this.setState({emailAddress:e})}),I()(this,"onSubmit",()=>{const e=d.getComponent("dialogs.ErrorDialog"),t=d.getComponent("dialogs.QuestionDialog"),s=this.state.emailAddress;wa.a(s)?(this._addThreepid=new Zm,this._addThreepid.addEmailAddress(s).then(()=>{De.a.createTrackedDialog("Verification Pending","",t,{title:Object(l.a)("Verification Pending"),description:Object(l.a)("Please check your email and click on the link it contains. Once this is done, click continue."),button:Object(l.a)("Continue"),onFinished:this.onEmailDialogFinished})},t=>{this.setState({emailBusy:!1}),console.error("Unable to add email address "+s+" "+t),De.a.createTrackedDialog("Unable to add email address","",e,{title:Object(l.a)("Unable to add email address"),description:t&&t.message?t.message:Object(l.a)("Operation failed")})}),this.setState({emailBusy:!0})):De.a.createTrackedDialog("Invalid Email Address","",e,{title:Object(l.a)("Invalid Email Address"),description:Object(l.a)("This doesn't appear to be a valid email address")})}),I()(this,"onCancelled",()=>{this.props.onFinished(!1)}),I()(this,"onEmailDialogFinished",e=>{e?this.verifyEmailAddress():this.setState({emailBusy:!1})})}verifyEmailAddress(){this._addThreepid.checkEmailLinkClicked().then(()=>{this.props.onFinished(!0)},e=>{if(this.setState({emailBusy:!1}),"M_THREEPID_AUTH_FAILED"==e.errcode){const e=d.getComponent("dialogs.QuestionDialog"),t=Object(l.a)("Unable to verify email address.")+" "+Object(l.a)("Please check your email and click on the link it contains. Once this is done, click continue.");De.a.createTrackedDialog("Verification Pending","3pid Auth Failed",e,{title:Object(l.a)("Verification Pending"),description:t,button:Object(l.a)("Continue"),onFinished:this.onEmailDialogFinished})}else{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify email address: "+e),De.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(l.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("elements.Spinner"),s=d.getComponent("elements.EditableText"),n=this.state.emailBusy?i.a.createElement(t,null):i.a.createElement(s,{initialValue:this.state.emailAddress,className:"mx_SetEmailDialog_email_input",autoFocus:"true",placeholder:Object(l.a)("Email address"),placeholderClassName:"mx_SetEmailDialog_email_input_placeholder",blurToCancel:!1,onValueChanged:this.onEmailAddressChanged});return i.a.createElement(e,{className:"mx_SetEmailDialog",onFinished:this.onCancelled,title:this.props.title,contentId:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("p",{id:"mx_Dialog_content"},Object(l.a)("This will allow you to reset your password and receive notifications.")),n),i.a.createElement("div",{className:"mx_Dialog_buttons"},i.a.createElement("input",{className:"mx_Dialog_primary",type:"submit",value:Object(l.a)("Continue"),onClick:this.onSubmit}),i.a.createElement("input",{type:"submit",value:Object(l.a)("Skip"),onClick:this.onCancelled})))}}I()(eh,"propTypes",{onFinished:xe.a.func.isRequired});var th=({onFinished:e})=>{const t=d.getComponent("dialogs.InfoDialog"),s={};xr.forEach(e=>{e.isEnabled()&&(s[e.category]||(s[e.category]=[]),s[e.category].push(e))});const n=Object.values(Er).filter(e=>s[e]).map(e=>{const t=[i.a.createElement("tr",{key:"_category_"+e,className:"mx_SlashCommandHelpDialog_headerRow"},i.a.createElement("td",{colSpan:3},i.a.createElement("h2",null,Object(l.a)(e))))];return s[e].forEach(e=>{t.push(i.a.createElement("tr",{key:e.command},i.a.createElement("td",null,i.a.createElement("strong",null,e.getCommand())),i.a.createElement("td",null,e.args),i.a.createElement("td",null,e.description)))}),t});return i.a.createElement(t,{className:"mx_SlashCommandHelpDialog",title:Object(l.a)("Command Help"),description:i.a.createElement("table",null,i.a.createElement("tbody",null,n)),hasCloseButton:!0,onFinished:e})};class sh extends i.a.Component{constructor(...e){super(...e),I()(this,"_sendBugReport",e=>{e.preventDefault();const t=d.getComponent("dialogs.BugReportDialog");De.a.createTrackedDialog("Storage evicted","Send Bug Report Dialog",t,{})}),I()(this,"_onSignOutClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let s=Object(l.a)("To help us prevent this in future, please <a>send us logs</a>.",{},{a:e=>i.a.createElement("a",{href:"#",onClick:this._sendBugReport},e)});return i.a.createElement(e,{className:"mx_ErrorDialog",onFinished:this.props.onFinished,title:Object(l.a)("Missing session data"),contentId:"mx_Dialog_content",hasCancel:!1},i.a.createElement("div",{className:"mx_Dialog_content",id:"mx_Dialog_content"},i.a.createElement("p",null,Object(l.a)("Some session data, including encrypted message keys, is missing. Sign out and sign in to fix this, restoring keys from backup.")),i.a.createElement("p",null,Object(l.a)("Your browser likely removed this data when running low on disk space.")," ",s)),i.a.createElement(t,{primaryButton:Object(l.a)("Sign out"),onPrimaryButtonClick:this._onSignOutClick,focus:!0,hasCancel:!1}))}}I()(sh,"propTypes",{onFinished:xe.a.func.isRequired});var nh=s(628);class ah extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"onChange",e=>{this.props.onChange(this.props.url,e.target.checked)})}render(){return i.a.createElement("input",{type:"checkbox",onChange:this.onChange,checked:this.props.checked})}}I()(ah,"propTypes",{onChange:xe.a.func.isRequired,url:xe.a.string.isRequired,checked:xe.a.bool.isRequired});class ih extends i.a.PureComponent{constructor(e){super(),I()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),I()(this,"_onNextClick",()=>{this.props.onFinished(!0,Object.keys(this.state.agreedUrls).filter(e=>this.state.agreedUrls[e]))}),I()(this,"_onTermsCheckboxChange",(e,t)=>{this.setState({agreedUrls:Object.assign({},this.state.agreedUrls,{[e]:t})})}),this.state={agreedUrls:{}};for(const t of e.agreedUrls)this.state.agreedUrls[t]=!0}_nameForServiceType(e,t){switch(e){case Fe.q.SERVICE_TYPES.IS:return i.a.createElement("div",null,Object(l.a)("Identity Server"),i.a.createElement("br",null),"(",t,")");case Fe.q.SERVICE_TYPES.IM:return i.a.createElement("div",null,Object(l.a)("Integration Manager"),i.a.createElement("br",null),"(",t,")")}}_summaryForServiceType(e){switch(e){case Fe.q.SERVICE_TYPES.IS:return i.a.createElement("div",null,Object(l.a)("Find others by phone or email"),i.a.createElement("br",null),Object(l.a)("Be found by phone or email"));case Fe.q.SERVICE_TYPES.IM:return i.a.createElement("div",null,Object(l.a)("Use bots, bridges, widgets and sticker packs"))}}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons"),s=[];for(const e of this.props.policiesAndServicePairs){const t=Te.a.parse(e.service.baseUrl),n=Object.values(e.policies);for(let a=0;a<n.length;++a){const o=n[a],r=Object(l.j)(Object.keys(o).filter(e=>"version"!==e));let c,d;0===a&&(c=this._nameForServiceType(e.service.serviceType,t.host),d=this._summaryForServiceType(e.service.serviceType)),s.push(i.a.createElement("tr",{key:o[r].url},i.a.createElement("td",{className:"mx_TermsDialog_service"},c),i.a.createElement("td",{className:"mx_TermsDialog_summary"},d),i.a.createElement("td",null,o[r].name," ",i.a.createElement("a",{rel:"noreferrer noopener",target:"_blank",href:o[r].url},i.a.createElement("span",{className:"mx_TermsDialog_link"}))),i.a.createElement("td",null,i.a.createElement(ah,{url:o[r].url,onChange:this._onTermsCheckboxChange,checked:Boolean(this.state.agreedUrls[o[r].url])}))))}}let n=!1;for(const e of this.props.policiesAndServicePairs){let t=0;for(const s of Object.values(e.policies)){let e=!1;for(const t of Object.keys(s))if("version"!==t&&this.state.agreedUrls[s[t].url]){e=!0;break}e&&++t}if(t===Object.keys(e.policies).length){n=!0;break}}return i.a.createElement(e,{fixedWidth:!1,onFinished:this._onCancelClick,title:Object(l.a)("Terms of Service"),contentId:"mx_Dialog_content",hasCancel:!1},i.a.createElement("div",{id:"mx_Dialog_content"},i.a.createElement("p",null,Object(l.a)("To continue you need to accept the terms of this service.")),i.a.createElement("table",{className:"mx_TermsDialog_termsTable"},i.a.createElement("tbody",null,i.a.createElement("tr",{className:"mx_TermsDialog_termsTableHeader"},i.a.createElement("th",null,Object(l.a)("Service")),i.a.createElement("th",null,Object(l.a)("Summary")),i.a.createElement("th",null,Object(l.a)("Document")),i.a.createElement("th",null,Object(l.a)("Accept"))),s))),i.a.createElement(t,{primaryButton:Object(l.a)("Next"),hasCancel:!0,onCancel:this._onCancelClick,onPrimaryButtonClick:this._onNextClick,primaryDisabled:!n}))}}I()(ih,"propTypes",{policiesAndServicePairs:xe.a.array.isRequired,agreedUrls:xe.a.arrayOf(xe.a.string),onFinished:xe.a.func.isRequired});class oh extends i.a.Component{constructor(e){super(e),I()(this,"onOk",async e=>{if(e.preventDefault(),this.props.validator&&(await this._field.current.validate({allowEmpty:!1}),!this._field.current.state.valid))return this._field.current.focus(),void this._field.current.validate({allowEmpty:!1,focused:!0});this.props.onFinished(!0,this.state.value)}),I()(this,"onCancel",()=>{this.props.onFinished(!1)}),I()(this,"onChange",e=>{this.setState({value:e.target.value})}),I()(this,"onValidate",async e=>{const t=await this.props.validator(e);return this.setState({valid:t.valid}),t}),this._field=Object(a.createRef)(),this.state={value:this.props.value,valid:!1}}componentDidMount(){this.props.focus&&this._field.current.focus()}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return i.a.createElement(e,{className:"mx_TextInputDialog",onFinished:this.props.onFinished,title:this.props.title,fixedWidth:this.props.fixedWidth},i.a.createElement("form",{onSubmit:this.onOk},i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement("div",{className:"mx_TextInputDialog_label"},i.a.createElement("label",{htmlFor:"textinput"}," ",this.props.description," ")),i.a.createElement("div",null,i.a.createElement(ke.a,{className:"mx_TextInputDialog_input",ref:this._field,type:"text",label:this.props.placeholder,value:this.state.value,onChange:this.onChange,onValidate:this.props.validator?this.onValidate:void 0,size:"64"})))),i.a.createElement(t,{primaryButton:this.props.button,onPrimaryButtonClick:this.onOk,onCancel:this.onCancel,hasCancel:this.props.hasCancel}))}}I()(oh,"propTypes",{title:xe.a.string,description:xe.a.oneOfType([xe.a.element,xe.a.string]),value:xe.a.string,placeholder:xe.a.string,button:xe.a.string,focus:xe.a.bool,onFinished:xe.a.func.isRequired,hasCancel:xe.a.bool,validator:xe.a.func,fixedWidth:xe.a.bool}),I()(oh,"defaultProps",{title:"",value:"",description:"",focus:!0,hasCancel:!0});class rh extends i.a.Component{constructor(e){super(e),I()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),I()(this,"_onUploadClick",()=>{this.props.onFinished(!0)}),I()(this,"_onUploadAllClick",()=>{this.props.onFinished(!0,!0)}),this._objectUrl=URL.createObjectURL(e.file)}componentWillUnmount(){this._objectUrl&&URL.revokeObjectURL(this._objectUrl)}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let n,a,o;return n=this.props.totalFiles>1&&void 0!==this.props.currentIndex?Object(l.a)("Upload files (%(current)s of %(total)s)",{current:this.props.currentIndex+1,total:this.props.totalFiles}):Object(l.a)("Upload files"),a=this.props.file.type.startsWith("image/")?i.a.createElement("div",{className:"mx_UploadConfirmDialog_previewOuter"},i.a.createElement("div",{className:"mx_UploadConfirmDialog_previewInner"},i.a.createElement("div",null,i.a.createElement("img",{className:"mx_UploadConfirmDialog_imagePreview",src:this._objectUrl})),i.a.createElement("div",null,this.props.file.name," (",Ki()(this.props.file.size),")"))):i.a.createElement("div",null,i.a.createElement("div",null,i.a.createElement("img",{className:"mx_UploadConfirmDialog_fileIcon",src:s(1469)}),this.props.file.name," (",Ki()(this.props.file.size),")")),this.props.currentIndex+1<this.props.totalFiles&&(o=i.a.createElement("button",{onClick:this._onUploadAllClick},Object(l.a)("Upload all"))),i.a.createElement(e,{className:"mx_UploadConfirmDialog",fixedWidth:!1,onFinished:this._onCancelClick,title:n,contentId:"mx_Dialog_content"},i.a.createElement("div",{id:"mx_Dialog_content"},a),i.a.createElement(t,{primaryButton:Object(l.a)("Upload"),hasCancel:!1,onPrimaryButtonClick:this._onUploadClick,focus:!0},o))}}I()(rh,"propTypes",{file:xe.a.object.isRequired,currentIndex:xe.a.number,totalFiles:xe.a.number,onFinished:xe.a.func.isRequired}),I()(rh,"defaultProps",{totalFiles:1});class lh extends i.a.Component{constructor(...e){super(...e),I()(this,"_onCancelClick",()=>{this.props.onFinished(!1)}),I()(this,"_onUploadClick",()=>{this.props.onFinished(!0)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");let s,n;if(1===this.props.totalFiles&&1===this.props.badFiles.length)s=Object(l.a)("This file is <b>too large</b> to upload. The file size limit is %(limit)s but this file is %(sizeOfThisFile)s.",{limit:Ki()(this.props.contentMessages.getUploadLimit()),sizeOfThisFile:Ki()(this.props.badFiles[0].size)},{b:e=>i.a.createElement("b",null,e)}),n=i.a.createElement(t,{primaryButton:Object(l.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this._onCancelClick,focus:!0});else if(this.props.totalFiles===this.props.badFiles.length)s=Object(l.a)("These files are <b>too large</b> to upload. The file size limit is %(limit)s.",{limit:Ki()(this.props.contentMessages.getUploadLimit())},{b:e=>i.a.createElement("b",null,e)}),n=i.a.createElement(t,{primaryButton:Object(l.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this._onCancelClick,focus:!0});else{s=Object(l.a)("Some files are <b>too large</b> to be uploaded. The file size limit is %(limit)s.",{limit:Ki()(this.props.contentMessages.getUploadLimit())},{b:e=>i.a.createElement("b",null,e)});const e=this.props.totalFiles-this.props.badFiles.length;n=i.a.createElement(t,{primaryButton:Object(l.a)("Upload %(count)s other files",{count:e}),onPrimaryButtonClick:this._onUploadClick,hasCancel:!0,cancelButton:Object(l.a)("Cancel All"),onCancel:this._onCancelClick,focus:!0})}return i.a.createElement(e,{className:"mx_UploadFailureDialog",onFinished:this._onCancelClick,title:Object(l.a)("Upload Error"),contentId:"mx_Dialog_content"},i.a.createElement("div",{id:"mx_Dialog_content"},s,void 0),n)}}I()(lh,"propTypes",{badFiles:xe.a.arrayOf(xe.a.object).isRequired,totalFiles:xe.a.number.isRequired,contentMessages:xe.a.instanceOf(ed.a).isRequired,onFinished:xe.a.func.isRequired});var ch=s(680),dh=s(662);class mh extends i.a.Component{constructor(...e){super(...e),I()(this,"_onConfirm",()=>{this.props.onFinished(!0)}),I()(this,"_onDecline",()=>{this.props.onFinished(!1)})}render(){const e=d.getComponent("views.dialogs.BaseDialog"),t=d.getComponent("views.elements.DialogButtons");return i.a.createElement(e,{className:"mx_ConfirmDestroyCrossSigningDialog",hasCancel:!0,onFinished:this.props.onFinished,title:Object(l.a)("Destroy cross-signing keys?")},i.a.createElement("div",{className:"mx_ConfirmDestroyCrossSigningDialog_content"},i.a.createElement("p",null,Object(l.a)("Deleting cross-signing keys is permanent. Anyone you have verified with will see security alerts. You almost certainly don't want to do this, unless you've lost every device you can cross-sign from."))),i.a.createElement(t,{primaryButton:Object(l.a)("Clear cross-signing keys"),onPrimaryButtonClick:this._onConfirm,primaryButtonClass:"danger",cancelButton:Object(l.a)("Cancel"),onCancel:this._onDecline}))}}I()(mh,"propTypes",{onFinished:xe.a.func.isRequired});var hh=s(661);class uh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{showTooltip:!1}),I()(this,"_onClick",e=>{e.stopPropagation(),_.a.trackEvent("Action Button","click",this.props.action),m.a.dispatch({action:this.props.action})}),I()(this,"_onMouseEnter",()=>{this.props.tooltip&&this.setState({showTooltip:!0}),this.props.mouseOverAction&&m.a.dispatch({action:this.props.mouseOverAction})}),I()(this,"_onMouseLeave",()=>{this.setState({showTooltip:!1})})}render(){const e=d.getComponent("elements.TintableSvg");let t;if(this.state.showTooltip){const e=d.getComponent("elements.Tooltip");t=i.a.createElement(e,{className:"mx_RoleButton_tooltip",label:this.props.label})}const s=this.props.iconPath?i.a.createElement(e,{src:this.props.iconPath,width:this.props.size,height:this.props.size}):void 0,n=["mx_RoleButton"];return this.props.className&&n.push(this.props.className),i.a.createElement(pe.a,{className:n.join(" "),onClick:this._onClick,onMouseEnter:this._onMouseEnter,onMouseLeave:this._onMouseLeave,"aria-label":this.props.label},s,t)}}I()(uh,"propTypes",{size:xe.a.string,tooltip:xe.a.bool,action:xe.a.string.isRequired,mouseOverAction:xe.a.string,label:xe.a.string.isRequired,iconPath:xe.a.string,className:xe.a.string}),I()(uh,"defaultProps",{size:"25",tooltip:!1});class ph extends i.a.Component{constructor(e){super(e),I()(this,"moveSelectionTop",()=>{this.state.selected>0&&this.setState({selected:0,hover:!1})}),I()(this,"moveSelectionUp",()=>{this.state.selected>0&&this.setState({selected:this.state.selected-1,hover:!1})}),I()(this,"moveSelectionDown",()=>{this.state.selected<this._maxSelected(this.props.addressList)&&this.setState({selected:this.state.selected+1,hover:!1})}),I()(this,"chooseSelection",()=>{this.selectAddress(this.state.selected)}),I()(this,"onClick",e=>{this.selectAddress(e)}),I()(this,"onMouseEnter",e=>{this.setState({selected:e,hover:!0})}),I()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),I()(this,"selectAddress",e=>{0!==this.props.addressList.length&&(this.props.onSelected(e),this.setState({hover:!1}))}),this.state={selected:void 0===this.props.selected?0:this.props.selected,hover:!1}}UNSAFE_componentWillReceiveProps(e){const t=this.state.selected,s=this._maxSelected(e.addressList);t>s&&this.setState({selected:s})}componentDidUpdate(){if(this.scrollElement&&this.props.addressList.length>0&&!this.state.hover){const e=this.addressListElement.getBoundingClientRect().height;this.scrollElement.scrollTop=this.state.selected*e-e}}createAddressListTiles(){const e=d.getComponent("elements.AddressTile"),t=this._maxSelected(this.props.addressList),n=[];if(this.props.addressList.length>0)for(let a=0;a<=t;a++){const t=L()({mx_AddressSelector_addressListElement:!0,mx_AddressSelector_selected:this.state.selected===a});n.push(i.a.createElement("div",{className:t,onClick:this.onClick.bind(this,a),onMouseEnter:this.onMouseEnter.bind(this,a),onMouseLeave:this.onMouseLeave,key:this.props.addressList[a].addressType+"/"+this.props.addressList[a].address,ref:e=>{this.addressListElement=e}},i.a.createElement(e,{address:this.props.addressList[a],showAddress:this.props.showAddress,justified:!0,networkName:"vector",networkUrl:s(1470)})))}return n}_maxSelected(e){const t=0===e.length?0:e.length-1;return t>this.props.truncateAt-1?this.props.truncateAt-1:t}render(){const e=L()({mx_AddressSelector:!0,mx_AddressSelector_empty:0===this.props.addressList.length});return i.a.createElement("div",{className:e,ref:e=>{this.scrollElement=e}},this.props.header,this.createAddressListTiles())}}I()(ph,"propTypes",{onSelected:xe.a.func.isRequired,addressList:xe.a.arrayOf(mr.a).isRequired,showAddress:xe.a.bool,truncateAt:xe.a.number.isRequired,selected:xe.a.number,header:xe.a.node});class gh extends i.a.Component{render(){const e=this.props.address,t=e.displayName||e.address,n=[],a=["mx-user-id","mx-room-id"].includes(e.addressType);a&&e.avatarMxc?n.push(ee.a.get().mxcUrlToHttp(e.avatarMxc,25,25,"crop")):"email"===e.addressType&&n.push(s(1471));const o=d.getComponent("avatars.BaseAvatar"),r=d.getComponent("elements.TintableSvg"),c=L()({mx_AddressTile_name:!0,mx_AddressTile_justified:this.props.justified});let m,h=!1;if(a&&e.isKnown){const s=L()({mx_AddressTile_id:!0,mx_AddressTile_justified:this.props.justified});m=i.a.createElement("div",{className:"mx_AddressTile_mx"},i.a.createElement("div",{className:c},t),this.props.showAddress?i.a.createElement("div",{className:s},e.address):i.a.createElement("div",null))}else if(a){const e=L()({mx_AddressTile_unknownMx:!0,mx_AddressTile_justified:this.props.justified});m=i.a.createElement("div",{className:e},this.props.address.address)}else if("email"===e.addressType){const t=L()({mx_AddressTile_email:!0,mx_AddressTile_justified:this.props.justified});let s=null;e.displayName&&(s=i.a.createElement("div",{className:c},e.displayName)),m=i.a.createElement("div",{className:"mx_AddressTile_mx"},i.a.createElement("div",{className:t},e.address),s)}else{h=!0;const e=L()({mx_AddressTile_unknown:!0,mx_AddressTile_justified:this.props.justified});m=i.a.createElement("div",{className:e},Object(l.a)("Unknown Address"))}const u=L()({mx_AddressTile:!0,mx_AddressTile_error:h});let p;return this.props.canDismiss&&(p=i.a.createElement("div",{className:"mx_AddressTile_dismiss",onClick:this.props.onDismissed},i.a.createElement(r,{src:s(1472),width:"9",height:"9"}))),i.a.createElement("div",{className:u},i.a.createElement("div",{className:"mx_AddressTile_avatar"},i.a.createElement(o,{defaultToInitialLetter:!0,width:25,height:25,name:t,title:t,urls:n})),m,p)}}I()(gh,"propTypes",{address:mr.a.isRequired,canDismiss:xe.a.bool,onDismissed:xe.a.func,justified:xe.a.bool}),I()(gh,"defaultProps",{canDismiss:!1,onDismissed:function(){},justified:!1});var fh=s(678),bh=s(679);class vh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{hover:!1,profile:null}),I()(this,"_onFlairStoreUpdated",()=>{this.unmounted||ds.a.getGroupProfileCached(this.context,this.props.tag).then(e=>{this.unmounted||this.setState({profile:e})}).catch(e=>{console.warn("Could not fetch group profile for "+this.props.tag,e)})}),I()(this,"onClick",e=>{e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"select_tag",tag:this.props.tag,ctrlOrCmdKey:Object(_s.c)(e),shiftKey:e.shiftKey}),"+"===this.props.tag[0]&&this._refreshGroup(this.props.tag)}),I()(this,"onMouseOver",()=>{F.a.getValue("feature_communities_v2_prototypes")||this.setState({hover:!0})}),I()(this,"onMouseLeave",()=>{this.setState({hover:!1})}),I()(this,"openMenu",e=>{e.stopPropagation(),e.preventDefault(),F.a.getValue("feature_communities_v2_prototypes")||(this.setState({hover:!1}),this.props.openMenu())})}componentDidMount(){this.unmounted=!1,"+"===this.props.tag[0]&&(ds.a.addListener("updateGroupProfile",this._onFlairStoreUpdated),this._onFlairStoreUpdated(),this._refreshGroup(this.props.tag))}componentWillUnmount(){this.unmounted=!0,"+"===this.props.tag[0]&&ds.a.removeListener("updateGroupProfile",this._onFlairStoreUpdated)}_refreshGroup(e){sa.a.refreshGroupRooms(e),sa.a.refreshGroupMembers(e)}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.state.profile||{},s=t.name||this.props.tag,n=t.avatarUrl?this.context.mxcUrlToHttp(t.avatarUrl,32,32,"crop"):null,a=F.a.getValue("feature_communities_v2_prototypes"),o=L()({mx_TagTile:!0,mx_TagTile_prototype:a,mx_TagTile_selected:this.props.selected&&!a,mx_TagTile_selected_prototype:this.props.selected&&a}),r=P.a.getGroupBadge(this.props.tag);let l;if(r&&!this.state.hover&&!this.props.menuDisplayed){const e=L()({mx_TagTile_badge:!0,mx_TagTile_badgeHighlight:r.highlight});l=i.a.createElement("div",{className:e},q.c(r.count))}const c=this.state.hover||this.props.menuDisplayed?i.a.createElement(pe.a,{className:"mx_TagTile_context_button",onClick:this.openMenu,inputRef:this.props.contextMenuButtonRef},"···"):i.a.createElement("div",{ref:this.props.contextMenuButtonRef}),m=d.getComponent("elements.AccessibleTooltipButton");return i.a.createElement(m,{className:o,onClick:this.onClick,onContextMenu:this.openMenu,title:s},i.a.createElement("div",{className:"mx_TagTile_avatar",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},i.a.createElement(e,{name:s,idName:this.props.tag,url:n,width:32,height:32}),c,l))}}function _h(e){const[t,s,a,o]=Object(n.q)();let r=null;if(t&&s.current){const t=s.current.getBoundingClientRect(),a=d.getComponent("context_menus.TagTileContextMenu");r=i.a.createElement(n.b,se()({},Object(n.p)(t),{onFinished:o}),i.a.createElement(a,{tag:e.tag,onFinished:o}))}return i.a.createElement("div",null,i.a.createElement(U.Draggable,{key:e.tag,draggableId:e.tag,index:e.index,type:"draggable-TagTile"},(n,o)=>i.a.createElement("div",se()({ref:n.innerRef},n.draggableProps,n.dragHandleProps),i.a.createElement(vh,se()({},e,{contextMenuButtonRef:s,menuDisplayed:t,openMenu:a})))),r)}I()(vh,"propTypes",{tag:xe.a.string,contextMenuButtonRef:xe.a.object,openMenu:xe.a.func,menuDisplayed:xe.a.bool,selected:xe.a.bool}),I()(vh,"contextType",b.a);class yh extends i.a.Component{constructor(e){super(e),this._collectInput=this._collectInput.bind(this),this._onClearClick=this._onClearClick.bind(this),this._onChange=this._onChange.bind(this),this._onKeyUp=this._onKeyUp.bind(this),this._onJoinButtonClick=this._onJoinButtonClick.bind(this),this.input=null,this.state={value:this.props.initialText||""}}_collectInput(e){this.input=e}_onClearClick(){this.setState({value:""}),this.input&&(this.input.focus(),this.props.onClear&&this.props.onClear())}_onChange(e){this.input&&(this.setState({value:e.target.value}),this.props.onChange&&this.props.onChange(e.target.value))}_onKeyUp(e){"Enter"==e.key&&this.props.showJoinButton&&this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}_onJoinButtonClick(){this.props.onJoinClick&&this.props.onJoinClick(this.state.value)}render(){const e=d.getComponent("elements.AccessibleButton");let t;return{mx_DirectorySearchBox:!0}[this.props.className]=!0,this.props.showJoinButton&&(t=i.a.createElement(e,{className:"mx_DirectorySearchBox_joinButton",onClick:this._onJoinButtonClick},Object(l.a)("Join"))),i.a.createElement("div",{className:`mx_DirectorySearchBox ${this.props.className} mx_textinput`},i.a.createElement("input",{type:"text",name:"dirsearch",value:this.state.value,className:"mx_textinput_icon mx_textinput_search",ref:this._collectInput,onChange:this._onChange,onKeyUp:this._onKeyUp,placeholder:this.props.placeholder,autoFocus:!0}),t,i.a.createElement(e,{className:"mx_DirectorySearchBox_clear",onClick:this._onClearClick}))}}yh.propTypes={className:xe.a.string,onChange:xe.a.func,onClear:xe.a.func,onJoinClick:xe.a.func,placeholder:xe.a.string,showJoinButton:xe.a.bool,initialText:xe.a.string};class Eh extends i.a.Component{constructor(e){super(e),this._onMouseEnter=this._onMouseEnter.bind(this),this._onClick=this._onClick.bind(this)}_onMouseEnter(){this.props.onMouseEnter(this.props.dropdownKey)}_onClick(e){e.preventDefault(),e.stopPropagation(),this.props.onClick(this.props.dropdownKey)}render(){const e=L()({mx_Dropdown_option:!0,mx_Dropdown_option_highlight:this.props.highlighted});return i.a.createElement("div",{id:this.props.id,className:e,onClick:this._onClick,onMouseEnter:this._onMouseEnter,role:"option","aria-selected":this.props.highlighted,ref:this.props.inputRef},this.props.children)}}I()(Eh,"defaultProps",{disabled:!1}),Eh.propTypes={children:xe.a.oneOfType([xe.a.arrayOf(xe.a.node),xe.a.node]),highlighted:xe.a.bool,dropdownKey:xe.a.string,onClick:xe.a.func.isRequired,onMouseEnter:xe.a.func.isRequired,inputRef:xe.a.any};class Ch extends i.a.Component{constructor(e){super(e),I()(this,"_onInputKeyDown",e=>{let t=!0;switch(e.key){case _s.a.ENTER:this.props.onOptionChange(this.state.highlightedOption);case _s.a.ESCAPE:this._close();break;case _s.a.ARROW_DOWN:this.setState({highlightedOption:this._nextOption(this.state.highlightedOption)});break;case _s.a.ARROW_UP:this.setState({highlightedOption:this._prevOption(this.state.highlightedOption)});break;default:t=!1}t&&(e.preventDefault(),e.stopPropagation())}),this.dropdownRootElement=null,this.ignoreEvent=null,this._onInputClick=this._onInputClick.bind(this),this._onRootClick=this._onRootClick.bind(this),this._onDocumentClick=this._onDocumentClick.bind(this),this._onMenuOptionClick=this._onMenuOptionClick.bind(this),this._onInputChange=this._onInputChange.bind(this),this._collectRoot=this._collectRoot.bind(this),this._collectInputTextBox=this._collectInputTextBox.bind(this),this._setHighlightedOption=this._setHighlightedOption.bind(this),this.inputTextBox=null,this._reindexChildren(this.props.children);const t=i.a.Children.toArray(e.children)[0];this.state={expanded:!1,highlightedOption:t?t.key:null,searchQuery:""}}UNSAFE_componentWillMount(){this._button=Object(a.createRef)(),document.addEventListener("click",this._onDocumentClick,!1)}componentWillUnmount(){document.removeEventListener("click",this._onDocumentClick,!1)}UNSAFE_componentWillReceiveProps(e){if(!e.children||0===e.children.length)return;this._reindexChildren(e.children);const t=e.children[0];this.setState({highlightedOption:t?t.key:null})}_reindexChildren(e){this.childrenByKey={},i.a.Children.forEach(e,e=>{this.childrenByKey[e.key]=e})}_onDocumentClick(e){e!==this.ignoreEvent&&this.setState({expanded:!1})}_onRootClick(e){this.ignoreEvent=e}_onInputClick(e){this.props.disabled||this.state.expanded||(this.setState({expanded:!0}),e.preventDefault())}_close(){this.setState({expanded:!1}),this._button.current&&this._button.current.focus()}_onMenuOptionClick(e){this._close(),this.props.onOptionChange(e)}_onInputChange(e){this.setState({searchQuery:e.target.value}),this.props.onSearchChange&&this.props.onSearchChange(e.target.value)}_collectRoot(e){this.dropdownRootElement&&this.dropdownRootElement.removeEventListener("click",this._onRootClick,!1),e&&e.addEventListener("click",this._onRootClick,!1),this.dropdownRootElement=e}_collectInputTextBox(e){this.inputTextBox=e,e&&e.focus()}_setHighlightedOption(e){this.setState({highlightedOption:e})}_nextOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s+1)%t.length]}_prevOption(e){const t=Object.keys(this.childrenByKey),s=t.indexOf(e);return t[(s-1)%t.length]}_scrollIntoView(e){e&&e.scrollIntoView({block:"nearest",behavior:"auto"})}_getMenuOptions(){const e=i.a.Children.map(this.props.children,e=>{const t=this.state.highlightedOption===e.key;return i.a.createElement(Eh,{id:`${this.props.id}__${e.key}`,key:e.key,dropdownKey:e.key,highlighted:t,onMouseEnter:this._setHighlightedOption,onClick:this._onMenuOptionClick,inputRef:t?this._scrollIntoView:void 0},e)});return 0===e.length?[i.a.createElement("div",{key:"0",className:"mx_Dropdown_option",role:"option"},Object(l.a)("No results"))]:e}render(){let e;const t={};let s;if(this.props.menuWidth&&(t.width=this.props.menuWidth),this.state.expanded&&(this.props.searchEnabled&&(e=i.a.createElement("input",{type:"text",className:"mx_Dropdown_option",ref:this._collectInputTextBox,onKeyDown:this._onInputKeyDown,onChange:this._onInputChange,value:this.state.searchQuery,role:"combobox","aria-autocomplete":"list","aria-activedescendant":`${this.props.id}__${this.state.highlightedOption}`,"aria-owns":this.props.id+"_listbox","aria-disabled":this.props.disabled,"aria-label":this.props.label})),s=i.a.createElement("div",{className:"mx_Dropdown_menu",style:t,role:"listbox",id:this.props.id+"_listbox"},this._getMenuOptions())),!e){const t=this.props.getShortOption?this.props.getShortOption(this.props.value):this.childrenByKey[this.props.value];e=i.a.createElement("div",{className:"mx_Dropdown_option",id:this.props.id+"_value"},t)}const n={mx_Dropdown:!0,mx_Dropdown_disabled:this.props.disabled};return this.props.className&&(n[this.props.className]=!0),i.a.createElement("div",{className:L()(n),ref:this._collectRoot},i.a.createElement(pe.a,{className:"mx_Dropdown_input mx_no_textinput",onClick:this._onInputClick,"aria-haspopup":"listbox","aria-expanded":this.state.expanded,disabled:this.props.disabled,inputRef:this._button,"aria-label":this.props.label,"aria-describedby":this.props.id+"_value"},e,i.a.createElement("span",{className:"mx_Dropdown_arrow"}),s))}}Ch.propTypes={id:xe.a.string.isRequired,menuWidth:xe.a.number,onOptionChange:xe.a.func.isRequired,onSearchChange:xe.a.func,searchEnabled:xe.a.bool,getShortOption:xe.a.func,value:xe.a.string,disabled:xe.a.bool,label:xe.a.string.isRequired};class wh extends i.a.Component{constructor(){super(),I()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),I()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),I()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),this.props.onRemove&&this.props.onRemove(this.props.index),this.setState({verifyRemove:!1})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?i.a.createElement("div",{className:"mx_EditableItem"},i.a.createElement("span",{className:"mx_EditableItem_promptText"},Object(l.a)("Are you sure?")),i.a.createElement(pe.a,{onClick:this._onActuallyRemove,kind:"primary_sm",className:"mx_EditableItem_confirmBtn"},Object(l.a)("Yes")),i.a.createElement(pe.a,{onClick:this._onDontRemove,kind:"danger_sm",className:"mx_EditableItem_confirmBtn"},Object(l.a)("No"))):i.a.createElement("div",{className:"mx_EditableItem"},i.a.createElement("div",{onClick:this._onRemove,className:"mx_EditableItem_delete",title:Object(l.a)("Remove"),role:"button"}),i.a.createElement("span",{className:"mx_EditableItem_item"},this.props.value))}}I()(wh,"propTypes",{index:xe.a.number,value:xe.a.string,onRemove:xe.a.func});class Sh extends i.a.Component{constructor(...e){super(...e),I()(this,"_onItemAdded",e=>{e.stopPropagation(),e.preventDefault(),this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem)}),I()(this,"_onItemRemoved",e=>{this.props.onItemRemoved&&this.props.onItemRemoved(e)}),I()(this,"_onNewItemChanged",e=>{this.props.onNewItemChanged&&this.props.onNewItemChanged(e.target.value)})}_renderNewItemField(){return i.a.createElement("form",{onSubmit:this._onItemAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},i.a.createElement(ke.a,{label:this.props.placeholder,type:"text",autoComplete:"off",value:this.props.newItem||"",onChange:this._onNewItemChanged,list:this.props.suggestionsListId}),i.a.createElement(pe.a,{onClick:this._onItemAdded,kind:"primary",type:"submit",disabled:!this.props.newItem},Object(l.a)("Add")))}render(){const e=this.props.items.map((e,t)=>this.props.canRemove?i.a.createElement(wh,{key:e,index:t,value:e,onRemove:this._onItemRemoved}):i.a.createElement("li",{key:e},e)),t=this.props.canRemove?e:i.a.createElement("ul",null,e),s=this.props.items.length>0?this.props.itemsLabel:this.props.noItemsLabel;return i.a.createElement("div",{className:"mx_EditableItemList"},i.a.createElement("div",{className:"mx_EditableItemList_label"},s),t,this.props.canEdit?this._renderNewItemField():i.a.createElement("div",null))}}I()(Sh,"propTypes",{id:xe.a.string.isRequired,items:xe.a.arrayOf(xe.a.string).isRequired,itemsLabel:xe.a.string,noItemsLabel:xe.a.string,placeholder:xe.a.string,newItem:xe.a.string,onItemAdded:xe.a.func,onItemRemoved:xe.a.func,onNewItemChanged:xe.a.func,canEdit:xe.a.bool,canRemove:xe.a.bool});class xh extends i.a.Component{constructor(e){super(e),I()(this,"state",{phase:xh.Phases.Display}),I()(this,"showPlaceholder",e=>{e?(this._editable_div.current.textContent=this.props.placeholder,this._editable_div.current.setAttribute("class",this.props.className+" "+this.props.placeholderClassName),this.placeholder=!0,this.value=""):(this._editable_div.current.textContent=this.value,this._editable_div.current.setAttribute("class",this.props.className),this.placeholder=!1)}),I()(this,"getValue",()=>this.value),I()(this,"setValue",e=>{this.value=e,this.showPlaceholder(!this.value)}),I()(this,"edit",()=>{this.setState({phase:xh.Phases.Edit})}),I()(this,"cancelEdit",()=>{this.setState({phase:xh.Phases.Display}),this.value=this.props.initialValue,this.showPlaceholder(!this.value),this.onValueChanged(!1),this._editable_div.current.blur()}),I()(this,"onValueChanged",e=>{this.props.onValueChanged(this.value,e)}),I()(this,"onKeyDown",e=>{this.placeholder&&this.showPlaceholder(!1),e.key===_s.a.ENTER&&(e.stopPropagation(),e.preventDefault())}),I()(this,"onKeyUp",e=>{e.target.textContent?this.placeholder||(this.value=e.target.textContent):this.showPlaceholder(!0),e.key===_s.a.ENTER?this.onFinish(e):e.key===_s.a.ESCAPE&&this.cancelEdit()}),I()(this,"onClickDiv",e=>{this.props.editable&&this.setState({phase:xh.Phases.Edit})}),I()(this,"onFocus",e=>{const t=e.target.childNodes[0];if(t){const e=document.createRange();e.setStart(t,0),e.setEnd(t,t.length);const s=window.getSelection();s.removeAllRanges(),s.addRange(e)}}),I()(this,"onFinish",(e,t)=>{const s=this,n=e.key===_s.a.ENTER||t;this.setState({phase:xh.Phases.Display},()=>{this.value!==this.props.initialValue&&s.onValueChanged(n)})}),I()(this,"onBlur",e=>{window.getSelection().removeAllRanges(),this.props.blurToCancel?this.cancelEdit():this.onFinish(e,this.props.blurToSubmit),this.showPlaceholder(!this.value)}),this.value="",this.placeholder=!1,this._editable_div=Object(a.createRef)()}UNSAFE_componentWillReceiveProps(e){e.initialValue!==this.props.initialValue&&(this.value=e.initialValue,this._editable_div.current&&this.showPlaceholder(!this.value))}componentDidMount(){this.value=this.props.initialValue,this._editable_div.current&&this.showPlaceholder(!this.value)}render(){const{className:e,editable:t,initialValue:s,label:n,labelClassName:a}=this.props;let o;return o=!t||this.state.phase===xh.Phases.Display&&(n||a)&&!this.value?i.a.createElement("div",{className:e+" "+a,onClick:this.onClickDiv},n||s):i.a.createElement("div",{ref:this._editable_div,contentEditable:!0,className:e,onKeyDown:this.onKeyDown,onKeyUp:this.onKeyUp,onFocus:this.onFocus,onBlur:this.onBlur}),o}}I()(xh,"propTypes",{onValueChanged:xe.a.func,initialValue:xe.a.string,label:xe.a.string,placeholder:xe.a.string,className:xe.a.string,labelClassName:xe.a.string,placeholderClassName:xe.a.string,blurToCancel:xe.a.bool,blurToSubmit:xe.a.bool,editable:xe.a.bool}),I()(xh,"Phases",{Display:"display",Edit:"edit"}),I()(xh,"defaultProps",{onValueChanged(){},initialValue:"",label:"",placeholder:"",editable:!0,className:"mx_EditableText",placeholderClassName:"mx_EditableText_placeholder",blurToSubmit:!1});class Rh extends i.a.Component{constructor(e){super(e),this._unmounted=!1,this.state={busy:!1,errorString:null,value:e.initialValue},this._onValueChanged=this._onValueChanged.bind(this)}componentDidMount(){void 0!==this.props.getInitialValue&&(this.setState({busy:!0}),this.props.getInitialValue().then(e=>{this._unmounted||this.setState({busy:!1,value:e})},e=>{this._unmounted||this.setState({errorString:e.toString(),busy:!1})}))}componentWillUnmount(){this._unmounted=!0}_onValueChanged(e,t){t&&(this.setState({busy:!0,errorString:null}),this.props.onSubmit(e).then(()=>{this._unmounted||this.setState({busy:!1,value:e})},e=>{this._unmounted||this.setState({errorString:e.toString(),busy:!1})}))}render(){if(this.state.busy){const e=d.getComponent("elements.Spinner");return i.a.createElement(e,null)}if(this.state.errorString)return i.a.createElement("div",{className:"error"},this.state.errorString);{const e=d.getComponent("elements.EditableText");return i.a.createElement(e,{initialValue:this.state.value,placeholder:this.props.placeholder,onValueChanged:this._onValueChanged,blurToSubmit:this.props.blurToSubmit})}}}Rh.propTypes={getInitialValue:xe.a.func,initialValue:xe.a.string,placeholder:xe.a.string,onSubmit:xe.a.func,blurToSubmit:xe.a.bool},Rh.defaultProps={initialValue:"",placeholder:"",blurToSubmit:!1,onSubmit:function(e){return Promise.resolve()}};var Oh=s(703);class kh extends i.a.Component{constructor(){super(),this.onClick=this.onClick.bind(this)}onClick(e){e.preventDefault(),e.stopPropagation(),m.a.dispatch({action:"view_group",group_id:this.props.groupProfile.groupId})}render(){const e=this.context.mxcUrlToHttp(this.props.groupProfile.avatarUrl,16,16,"scale",!1),t=this.props.groupProfile.name?`${this.props.groupProfile.name} (${this.props.groupProfile.groupId})`:this.props.groupProfile.groupId;return i.a.createElement("img",{src:e,width:"16",height:"16",onClick:this.onClick,title:t})}}kh.propTypes={groupProfile:xe.a.shape({groupId:xe.a.string.isRequired,name:xe.a.string,avatarUrl:xe.a.string.isRequired})},kh.contextType=b.a;class Ih extends i.a.Component{constructor(){super(),this.state={profiles:[]}}componentDidMount(){this._unmounted=!1,this._generateAvatars(this.props.groups)}componentWillUnmount(){this._unmounted=!0}UNSAFE_componentWillReceiveProps(e){this._generateAvatars(e.groups)}async _getGroupProfiles(e){const t=[];for(const s of e){let e=null;try{e=await ds.a.getGroupProfileCached(this.context,s)}catch(e){console.error("Could not get profile for group",s,e)}t.push(e)}return t.filter(e=>null!==e)}async _generateAvatars(e){if(!e||0===e.length)return;const t=await this._getGroupProfiles(e);this.unmounted||this.setState({profiles:t.filter(e=>!!e&&e.avatarUrl)})}render(){if(0===this.state.profiles.length)return i.a.createElement("span",{className:"mx_Flair"});const e=this.state.profiles.map((e,t)=>i.a.createElement(kh,{key:t,groupProfile:e}));return i.a.createElement("span",{className:"mx_Flair"},e)}}Ih.propTypes={groups:xe.a.arrayOf(xe.a.string)},Ih.contextType=b.a;var Th=s(238);class jh extends i.a.PureComponent{constructor(e){super(e),I()(this,"_onChange",e=>{this.props.onChange&&this.props.onChange(this._asFullAlias(e.target.value))}),I()(this,"_onValidate",async e=>{const t=await this._validationRules(e);return this.setState({isValid:t.valid}),t}),I()(this,"_validationRules",Object(Ca.a)({rules:[{key:"safeLocalpart",test:async({value:e})=>{if(!e)return!0;const t=this._asFullAlias(e);return!e.includes("#")&&!e.includes(":")&&!e.includes(",")&&encodeURI(t)===t},invalid:()=>Object(l.a)("Some characters not allowed")},{key:"required",test:async({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Please provide a room address")},{key:"taken",final:!0,test:async({value:e})=>{if(!e)return!0;const t=ee.a.get();try{return await t.getRoomIdForAlias(this._asFullAlias(e)),!1}catch(e){return!!e.errcode}},valid:()=>Object(l.a)("This address is available to use"),invalid:()=>Object(l.a)("This address is already in use")}]})),this.state={isValid:!0}}_asFullAlias(e){return`#${e}:${this.props.domain}`}render(){const e=d.getComponent("views.elements.Field"),t=i.a.createElement("span",null,"#"),s=":"+this.props.domain,n=i.a.createElement("span",{title:s},s),a=255-this.props.domain.length-2;return i.a.createElement(e,{label:Object(l.a)("Room address"),className:"mx_RoomAliasField",prefixComponent:t,postfixComponent:n,ref:e=>this._fieldRef=e,onValidate:this._onValidate,placeholder:Object(l.a)("e.g. my-room"),onChange:this._onChange,value:this.props.value.substring(1,this.props.value.length-this.props.domain.length-1),maxLength:a})}get isValid(){return this.state.isValid}validate(e){return this._fieldRef.validate(e)}focus(){this._fieldRef.focus()}}I()(jh,"propTypes",{domain:xe.a.string.isRequired,onChange:xe.a.func,value:xe.a.string.isRequired});const Nh=function(e){const t=d.getComponent("elements.ActionButton");return i.a.createElement(t,{action:h.a.ViewRoomDirectory,mouseOverAction:e.callout?"callout_room_directory":null,label:Object(l.a)("Room directory"),iconPath:s(1473),size:e.size,tooltip:e.tooltip})};Nh.propTypes={size:xe.a.string,tooltip:xe.a.bool};var Ph=Nh;class Dh extends i.a.Component{constructor(e){super(e),this.state={visible:!1}}toggleVisible(e){this.state.visible||(e.preventDefault(),e.stopPropagation()),this.setState({visible:!this.state.visible})}render(){const e=this.props.reason?i.a.createElement("span",{className:"mx_EventTile_spoiler_reason"},"("+this.props.reason+")"):null;return i.a.createElement("span",{className:"mx_EventTile_spoiler"+(this.state.visible?" visible":""),onClick:this.toggleVisible.bind(this)},e," ",i.a.createElement("span",{className:"mx_EventTile_spoiler_content",dangerouslySetInnerHTML:{__html:this.props.contentHtml}}))}}const Ah=function(e){const t=d.getComponent("elements.ActionButton");return i.a.createElement(t,{action:"view_create_chat",mouseOverAction:e.callout?"callout_start_chat":null,label:Object(l.a)("Start chat"),iconPath:s(1474),size:e.size,tooltip:e.tooltip})};Ah.propTypes={size:xe.a.string,tooltip:xe.a.bool};var Uh=Ah;class Mh extends i.a.Component{constructor(...e){super(...e),I()(this,"tint",()=>{Pn.a.applySvgFixups(this.fixups)}),I()(this,"onLoad",e=>{this.fixups=Pn.a.calcSvgFixups([e.target]),Pn.a.applySvgFixups(this.fixups)})}componentDidMount(){this.fixups=[],this.id=Mh.idSequence++,Mh.mounts[this.id]=this}componentWillUnmount(){delete Mh.mounts[this.id]}render(){return i.a.createElement("object",{className:"mx_TintableSvg "+(this.props.className?this.props.className:""),type:"image/svg+xml",data:this.props.src,width:this.props.width,height:this.props.height,onLoad:this.onLoad,tabIndex:"-1"})}}I()(Mh,"propTypes",{src:xe.a.string.isRequired,width:xe.a.string.isRequired,height:xe.a.string.isRequired,className:xe.a.string}),I()(Mh,"mounts",{}),I()(Mh,"idSequence",0),Pn.a.registerTintable((function(){Mh.mounts&&Object.keys(Mh.mounts).forEach(e=>{Mh.mounts[e].tint()})}));var Lh=Mh;class Fh extends i.a.Component{constructor(e){super(e)}render(){let e="mx_TintableSvgButton";return this.props.className&&(e+=" "+this.props.className),i.a.createElement("span",{width:this.props.width,height:this.props.height,className:e},i.a.createElement(Lh,{src:this.props.src,width:this.props.width,height:this.props.height}),i.a.createElement(pe.a,{onClick:this.props.onClick,element:"span",title:this.props.title}))}}Fh.propTypes={src:xe.a.string,title:xe.a.string,className:xe.a.string,width:xe.a.string.isRequired,height:xe.a.string.isRequired,onClick:xe.a.func},Fh.defaultProps={onClick:function(){}};class Bh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{hover:!1}),I()(this,"onMouseOver",()=>{this.setState({hover:!0})}),I()(this,"onMouseLeave",()=>{this.setState({hover:!1})})}render(){const e=d.getComponent("elements.Tooltip"),t=this.state.hover?i.a.createElement(e,{className:"mx_TooltipButton_container",tooltipClassName:"mx_TooltipButton_helpText",label:this.props.helpText}):i.a.createElement("div",null);return i.a.createElement("div",{className:"mx_TooltipButton",onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},"?",t)}}class Vh extends i.a.Component{_getChildren(e,t){return this.props.getChildren&&this.props.getChildCount?this.props.getChildren(e,t):i.a.Children.toArray(this.props.children).filter(e=>null!=e).slice(e,t)}_getChildCount(){return this.props.getChildren&&this.props.getChildCount?this.props.getChildCount():i.a.Children.toArray(this.props.children).filter(e=>null!=e).length}render(){let e=null;const t=this._getChildCount();let s=t;if(this.props.truncateAt>=0){const n=t-this.props.truncateAt;n>1&&(e=this.props.createOverflowElement(n,t),s=this.props.truncateAt)}const n=this._getChildren(0,s);return i.a.createElement("div",{className:this.props.className},n,e)}}I()(Vh,"propTypes",{truncateAt:xe.a.number,className:xe.a.string,getChildren:xe.a.func,getChildCount:xe.a.func,createOverflowElement:xe.a.func}),I()(Vh,"defaultProps",{truncateAt:2,createOverflowElement:(e,t)=>i.a.createElement("div",null,Object(l.a)("And %(count)s more...",{count:e}))});class Wh extends i.a.Component{constructor(e,t){super(e,t),I()(this,"onClick",e=>{m.a.dispatch({action:"view_group",group_id:this.props.group.groupId})}),I()(this,"onMouseEnter",()=>{const e={hover:!0};this.context.isGuest()||(e.badgeHover=!0),this.setState(e)}),I()(this,"onMouseLeave",()=>{this.setState({badgeHover:!1,hover:!1})}),I()(this,"onContextMenuButtonClick",e=>{e.stopPropagation(),e.preventDefault(),this._showContextMenu(e.target.getBoundingClientRect())}),I()(this,"onContextMenu",e=>{e.preventDefault(),this._showContextMenu({right:e.clientX,top:e.clientY,height:0})}),I()(this,"closeMenu",()=>{this.setState({contextMenuPosition:null})}),this.state={hover:!1,badgeHover:!1,menuDisplayed:!1,selected:null===this.props.group.groupId}}_showContextMenu(e){if(ee.a.get().isGuest())return;const t={contextMenuPosition:e};this.props.collapsed&&(t.hover=!1),this.setState(t)}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("avatars.BaseAvatar"),s=this.props.group.name||this.props.group.groupId,a=this.props.group.avatarUrl?this.context.mxcUrlToHttp(this.props.group.avatarUrl,24,24):null,o=i.a.createElement(t,{name:s,width:24,height:24,url:a}),r=Boolean(this.state.contextMenuPosition),c=L()("mx_RoomTile_name mx_RoomTile_invite mx_RoomTile_badgeShown",{mx_RoomTile_badgeShown:this.state.badgeHover||r}),m=i.a.createElement("div",{title:this.props.group.groupId,className:c,tabIndex:-1,dir:"auto"},s),h=this.state.badgeHover||r,u=L()("mx_RoomTile_badge mx_RoomTile_highlight",{mx_RoomTile_badgeButton:h}),p=h?"···":"!";let g;if(this.props.collapsed&&this.state.hover){const e=d.getComponent("elements.Tooltip");g=i.a.createElement(e,{className:"mx_RoomTile_tooltip",label:s,dir:"auto"})}const f=L()("mx_RoomTile mx_RoomTile_highlight",{mx_RoomTile_menuDisplayed:r,mx_RoomTile_selected:this.state.selected,mx_GroupInviteTile:!0});let b;if(r){const e=d.getComponent("context_menus.GroupInviteTileContextMenu");b=i.a.createElement(n.b,se()({},Object(n.p)(this.state.contextMenuPosition),{onFinished:this.closeMenu}),i.a.createElement(e,{group:this.props.group,onFinished:this.closeMenu}))}return i.a.createElement(i.a.Fragment,null,i.a.createElement(Y.d,null,({onFocus:t,isActive:s,ref:a})=>i.a.createElement(e,{onFocus:t,tabIndex:s?0:-1,inputRef:a,className:f,onClick:this.onClick,onMouseEnter:this.onMouseEnter,onMouseLeave:this.onMouseLeave,onContextMenu:this.onContextMenu},i.a.createElement("div",{className:"mx_RoomTile_avatar"},o),i.a.createElement("div",{className:"mx_RoomTile_nameContainer"},m,i.a.createElement(n.c,{className:u,onClick:this.onContextMenuButtonClick,label:Object(l.a)("Options"),isExpanded:r,tabIndex:s?0:-1},p)),g)),b)}}I()(Wh,"propTypes",void 0),I()(Wh,"contextType",b.a);class Hh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{members:null,membersError:null,invitedMembers:null,invitedMembersError:null,truncateAt:30}),I()(this,"_createOverflowTile",(e,t)=>{const n=d.getComponent("rooms.EntityTile"),a=d.getComponent("avatars.BaseAvatar"),o=Object(l.a)("and %(count)s others...",{count:e});return i.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(a,{url:s(487),name:"...",width:36,height:36}),name:o,presenceState:"online",suppressOnHover:!0,onClick:this._showFullMemberList})}),I()(this,"_showFullMemberList",()=>{this.setState({truncateAt:-1})}),I()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),I()(this,"onInviteToGroupButtonClick",()=>{Object(gc.b)(this.props.groupId).then(()=>{m.a.dispatch({action:h.a.SetRightPanelPhase,phase:ls.b.GroupMemberList,refireParams:{groupId:this.props.groupId}})})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0}_initGroupStore(e){sa.a.registerListener(e,()=>{this._fetchMembers()}),sa.a.on("error",(t,s,n)=>{this._unmounted||e!==s||(n===sa.a.STATE_KEY.GroupMembers&&this.setState({membersError:t}),n===sa.a.STATE_KEY.GroupInvitedMembers&&this.setState({invitedMembersError:t}))})}_fetchMembers(){this._unmounted||this.setState({members:sa.a.getGroupMembers(this.props.groupId),invitedMembers:sa.a.getGroupInvitedMembers(this.props.groupId)})}makeGroupMemberTiles(e,t,s){if(s)return i.a.createElement("div",{className:"warning"},Object(l.a)("Failed to load group members"));const n=d.getComponent("groups.GroupMemberTile"),a=d.getComponent("elements.TruncatedList");(e=(e||"").toLowerCase())&&(t=t.filter(t=>{const s=(t.displayname||"").toLowerCase().includes(e),n=t.userId.toLowerCase().includes(e);return!(!s&&!n)}));const o={};t.forEach(e=>{o[e.userId]||(o[e.userId]=e)}),(t=Object.keys(o).map(e=>o[e])).sort((e,t)=>{if(e.isPrivileged===t.isPrivileged){const s=e.displayname||e.userId,n=t.displayname||t.userId;return s<n?-1:s>n?1:0}return e.isPrivileged?-1:1});const r=t.map(e=>i.a.createElement(n,{key:e.userId,groupId:this.props.groupId,member:e}));return i.a.createElement(a,{className:"mx_MemberList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},r)}render(){if(this.state.fetching||this.state.fetchingInvitedMembers){const e=d.getComponent("elements.Spinner");return i.a.createElement("div",{className:"mx_MemberList"},i.a.createElement(e,null))}const e=i.a.createElement("input",{className:"mx_GroupMemberList_query mx_textinput",id:"mx_GroupMemberList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(l.a)("Filter community members"),autoComplete:"off"}),t=this.state.members?i.a.createElement("div",{className:"mx_MemberList_joined"},this.makeGroupMemberTiles(this.state.searchQuery,this.state.members,this.state.membersError)):i.a.createElement("div",null),s=this.state.invitedMembers&&this.state.invitedMembers.length>0?i.a.createElement("div",{className:"mx_MemberList_invited"},i.a.createElement("h2",null,Object(l.a)("Invited")),this.makeGroupMemberTiles(this.state.searchQuery,this.state.invitedMembers,this.state.invitedMembersError)):i.a.createElement("div",null);let n;return sa.a.isUserPrivileged(this.props.groupId)&&(n=i.a.createElement(pe.a,{className:"mx_MemberList_invite mx_MemberList_inviteCommunity",onClick:this.onInviteToGroupButtonClick},i.a.createElement("span",null,Object(l.a)("Invite to this community")))),i.a.createElement("div",{className:"mx_MemberList",role:"tabpanel"},n,i.a.createElement(o.a,null,t,s),e)}}I()(Hh,"propTypes",{groupId:xe.a.string.isRequired});class Gh extends i.a.Component{constructor(...e){super(...e),I()(this,"onClick",e=>{m.a.dispatch({action:"view_group_user",member:this.props.member,groupId:this.props.groupId})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("rooms.EntityTile"),s=this.props.member.displayname||this.props.member.userId,n=this.context.mxcUrlToHttp(this.props.member.avatarUrl,36,36,"crop"),a=i.a.createElement(e,{"aria-hidden":"true",name:this.props.member.displayname||this.props.member.userId,idName:this.props.member.userId,width:36,height:36,url:n});return i.a.createElement(t,{name:s,avatarJsx:a,onClick:this.onClick,suppressOnHover:!0,presenceState:"online",powerStatus:this.props.member.isPrivileged?t.POWER_STATUS_ADMIN:null})}}I()(Gh,"propTypes",{groupId:xe.a.string.isRequired,member:Uo.a.isRequired}),I()(Gh,"contextType",b.a);class qh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{busy:!1,ready:!1,isGroupPublicised:!1}),I()(this,"_onPublicityToggle",()=>{this.setState({busy:!0,isGroupPublicised:!this.state.isGroupPublicised}),sa.a.setGroupPublicity(this.props.groupId,!this.state.isGroupPublicised).then(()=>{this.setState({busy:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}_initGroupStore(e){this._groupStoreToken=sa.a.registerListener(e,()=>{this.setState({isGroupPublicised:Boolean(sa.a.getGroupPublicity(e)),ready:sa.a.isStateReady(e,sa.a.STATE_KEY.Summary)})})}componentWillUnmount(){this._groupStoreToken&&this._groupStoreToken.unregister()}render(){const e=d.getComponent("groups.GroupTile");return i.a.createElement("div",{className:"mx_GroupPublicity_toggle"},i.a.createElement(e,{groupId:this.props.groupId,showDescription:!1,avatarHeight:40,draggable:!1}),i.a.createElement(mt.a,{checked:this.state.isGroupPublicised,disabled:!this.state.ready||this.state.busy,onChange:this._onPublicityToggle}))}}I()(qh,"propTypes",{groupId:xe.a.string.isRequired});class Kh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{isUserPrivilegedInGroup:null,groupRoom:null,groupRoomPublicityLoading:!1,groupRoomRemoveLoading:!1}),I()(this,"onGroupStoreUpdated",()=>{this.setState({isUserPrivilegedInGroup:sa.a.isUserPrivileged(this.props.groupId)}),this._updateGroupRoom()}),I()(this,"_onRemove",e=>{const t=this.props.groupId,s=this.state.groupRoom.displayname;e.preventDefault(),e.stopPropagation();const n=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Confirm removal of group from room","",n,{title:Object(l.a)("Are you sure you want to remove '%(roomName)s' from %(groupId)s?",{roomName:s,groupId:t}),description:Object(l.a)("Removing a room from the community will also remove it from the community page."),button:Object(l.a)("Remove"),onFinished:e=>{if(!e)return;this.setState({groupRoomRemoveLoading:!0});const t=this.props.groupId,n=this.props.groupRoomId;sa.a.removeRoomFromGroup(this.props.groupId,n).then(()=>{m.a.dispatch({action:"view_group_room_list"})}).catch(e=>{console.error(`Error whilst removing ${n} from ${t}`,e);const a=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to remove room from group","",a,{title:Object(l.a)("Failed to remove room from community"),description:Object(l.a)("Failed to remove '%(roomName)s' from %(groupId)s",{groupId:t,roomName:s})})}).finally(()=>{this.setState({groupRoomRemoveLoading:!1})})}})}),I()(this,"_onCancel",e=>{m.a.dispatch({action:"view_group_room_list"})}),I()(this,"_changeGroupRoomPublicity",e=>{const t="public"===e.target.value;this.setState({groupRoomPublicityLoading:!0});const s=this.props.groupId,n=this.props.groupRoomId,a=this.state.groupRoom.displayname;sa.a.updateGroupRoomVisibility(this.props.groupId,n,t).catch(e=>{console.error(`Error whilst changing visibility of ${n} in ${s} to ${t}`,e);const i=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Failed to remove room from group","",i,{title:Object(l.a)("Something went wrong!"),description:Object(l.a)("The visibility of '%(roomName)s' in %(groupId)s could not be updated.",{roomName:a,groupId:s})})}).finally(()=>{this.setState({groupRoomPublicityLoading:!1})})})}componentDidMount(){this._initGroupStore(this.props.groupId)}UNSAFE_componentWillReceiveProps(e){e.groupId!==this.props.groupId&&(this._unregisterGroupStore(this.props.groupId),this._initGroupStore(e.groupId))}componentWillUnmount(){this._unregisterGroupStore(this.props.groupId)}_initGroupStore(e){sa.a.registerListener(e,this.onGroupStoreUpdated)}_unregisterGroupStore(e){sa.a.unregisterListener(this.onGroupStoreUpdated)}_updateGroupRoom(){this.setState({groupRoom:sa.a.getGroupRooms(this.props.groupId).find(e=>e.roomId===this.props.groupRoomId)})}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.InlineSpinner");if(this.state.groupRoomRemoveLoading||!this.state.groupRoom){const e=d.getComponent("elements.Spinner");return i.a.createElement("div",{className:"mx_MemberInfo"},i.a.createElement(e,null))}let n;this.state.isUserPrivilegedInGroup&&(n=i.a.createElement("div",{className:"mx_MemberInfo_adminTools"},i.a.createElement("h3",null,Object(l.a)("Admin Tools")),i.a.createElement("div",{className:"mx_MemberInfo_buttons"},i.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this._onRemove},Object(l.a)("Remove from community"))),i.a.createElement("h3",null,Object(l.a)("Visibility in Room List"),this.state.groupRoomPublicityLoading?i.a.createElement(t,null):i.a.createElement("div",null)),i.a.createElement("div",null,i.a.createElement("label",null,i.a.createElement("input",{type:"radio",value:"public",checked:this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),i.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(l.a)("Visible to everyone")))),i.a.createElement("div",null,i.a.createElement("label",null,i.a.createElement("input",{type:"radio",value:"private",checked:!this.state.groupRoom.isPublic,onChange:this._changeGroupRoomPublicity}),i.a.createElement("div",{className:"mx_MemberInfo_label_text"},Object(l.a)("Only visible to community members"))))));const a=this.state.groupRoom.avatarUrl;let r;if(a){const e=this.context.mxcUrlToHttp(a,800,800);r=i.a.createElement("div",{className:"mx_MemberInfo_avatar"},i.a.createElement("img",{src:e}))}const c=this.state.groupRoom.displayname;return i.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},i.a.createElement(o.a,null,i.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this._onCancel},i.a.createElement("img",{src:s(222),width:"18",height:"18",className:"mx_filterFlipColor"})),r,i.a.createElement("h2",null,c),i.a.createElement("div",{className:"mx_MemberInfo_profile"},i.a.createElement("div",{className:"mx_MemberInfo_profileField"},this.state.groupRoom.canonicalAlias)),n))}}I()(Kh,"contextType",b.a),I()(Kh,"propTypes",{groupId:xe.a.string,groupRoomId:xe.a.string});class zh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{rooms:null,truncateAt:30,searchQuery:""}),I()(this,"onGroupStoreUpdated",()=>{this._unmounted||this.setState({rooms:sa.a.getGroupRooms(this.props.groupId)})}),I()(this,"_createOverflowTile",(e,t)=>{const n=d.getComponent("rooms.EntityTile"),a=d.getComponent("avatars.BaseAvatar"),o=Object(l.a)("and %(count)s others...",{count:e});return i.a.createElement(n,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(a,{url:s(487),name:"...",width:36,height:36}),name:o,presenceState:"online",suppressOnHover:!0,onClick:this._showFullRoomList})}),I()(this,"_showFullRoomList",()=>{this.setState({truncateAt:-1})}),I()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e.target.value})}),I()(this,"onAddRoomToGroupButtonClick",()=>{Object(gc.a)(this.props.groupId).then(()=>{this.forceUpdate()})})}componentDidMount(){this._unmounted=!1,this._initGroupStore(this.props.groupId)}componentWillUnmount(){this._unmounted=!0,this._unregisterGroupStore()}_unregisterGroupStore(){sa.a.unregisterListener(this.onGroupStoreUpdated)}_initGroupStore(e){sa.a.registerListener(e,this.onGroupStoreUpdated),sa.a.on("error",(t,s)=>{s===e&&this.setState({rooms:null})})}makeGroupRoomTiles(e){const t=d.getComponent("groups.GroupRoomTile");e=(e||"").toLowerCase();let s=this.state.rooms;return e&&(s=s.filter(t=>{const s=(t.name||"").toLowerCase().includes(e),n=(t.canonicalAlias||"").toLowerCase().includes(e);return s||n})),s=s.map((e,s)=>i.a.createElement(t,{key:s,groupId:this.props.groupId,groupRoom:e})),s}render(){if(null===this.state.rooms)return null;let e;sa.a.isUserPrivileged(this.props.groupId)&&(e=i.a.createElement(pe.a,{className:"mx_MemberList_invite mx_MemberList_addRoomToCommunity",onClick:this.onAddRoomToGroupButtonClick},i.a.createElement("span",null,Object(l.a)("Add rooms to this community"))));const t=i.a.createElement("input",{className:"mx_GroupRoomList_query mx_textinput",id:"mx_GroupRoomList_query",type:"text",onChange:this.onSearchQueryChanged,value:this.state.searchQuery,placeholder:Object(l.a)("Filter community rooms"),autoComplete:"off"}),s=d.getComponent("elements.TruncatedList");return i.a.createElement("div",{className:"mx_GroupRoomList",role:"tabpanel"},e,i.a.createElement(o.a,{className:"mx_GroupRoomList_joined mx_GroupRoomList_outerWrapper"},i.a.createElement(s,{className:"mx_GroupRoomList_wrapper",truncateAt:this.state.truncateAt,createOverflowElement:this._createOverflowTile},this.makeGroupRoomTiles(this.state.searchQuery))),t)}}I()(zh,"propTypes",{groupId:xe.a.string.isRequired});class $h extends i.a.Component{constructor(...e){super(...e),I()(this,"onClick",e=>{m.a.dispatch({action:"view_group_room",groupId:this.props.groupId,groupRoomId:this.props.groupRoom.roomId})})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),s=this.context.mxcUrlToHttp(this.props.groupRoom.avatarUrl,36,36,"crop"),n=i.a.createElement(e,{name:this.props.groupRoom.displayname,width:36,height:36,url:s});return i.a.createElement(t,{className:"mx_GroupRoomTile",onClick:this.onClick},i.a.createElement("div",{className:"mx_GroupRoomTile_avatar"},n),i.a.createElement("div",{className:"mx_GroupRoomTile_name"},this.props.groupRoom.displayname))}}I()($h,"propTypes",{groupId:xe.a.string.isRequired,groupRoom:Uo.b.isRequired}),I()($h,"contextType",b.a);var Yh=$h;function Jh(){}class Qh extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{profile:null}),I()(this,"onMouseDown",e=>{e.preventDefault(),m.a.dispatch({action:"view_group",group_id:this.props.groupId})})}componentDidMount(){ds.a.getGroupProfileCached(this.context,this.props.groupId).then(e=>{this.setState({profile:e})}).catch(e=>{console.error("Error whilst getting cached profile for GroupTile",e)})}render(){const e=d.getComponent("avatars.BaseAvatar"),t=d.getComponent("elements.AccessibleButton"),s=this.state.profile||{},n=s.name||this.props.groupId,a=this.props.avatarHeight,o=this.props.showDescription?i.a.createElement("div",{className:"mx_GroupTile_desc"},s.shortDescription):i.a.createElement("div",null),r=s.avatarUrl?this.context.mxcUrlToHttp(s.avatarUrl,a,a,"crop"):null;let l=i.a.createElement("div",{className:"mx_GroupTile_avatar"},i.a.createElement(e,{name:n,idName:this.props.groupId,url:r,width:a,height:a}));if(this.props.draggable){const e=l;l=i.a.createElement(U.Droppable,{droppableId:"my-groups-droppable",type:"draggable-TagTile"},(t,s)=>i.a.createElement("div",{ref:t.innerRef},i.a.createElement(U.Draggable,{key:"GroupTile "+this.props.groupId,draggableId:"GroupTile "+this.props.groupId,index:this.props.groupId,type:"draggable-TagTile"},(t,s)=>i.a.createElement("div",null,i.a.createElement("div",se()({ref:t.innerRef},t.draggableProps,t.dragHandleProps),e),t.placeholder?e:i.a.createElement("div",null)))))}return i.a.createElement(t,{className:"mx_GroupTile",onMouseDown:this.onMouseDown,onClick:Jh},l,i.a.createElement("div",{className:"mx_GroupTile_profile"},i.a.createElement("div",{className:"mx_GroupTile_name"},n),o,i.a.createElement("div",{className:"mx_GroupTile_groupId"},this.props.groupId)))}}I()(Qh,"propTypes",{groupId:xe.a.string.isRequired,showDescription:xe.a.bool,avatarHeight:xe.a.number,draggable:xe.a.bool}),I()(Qh,"contextType",b.a),I()(Qh,"defaultProps",{showDescription:!0,avatarHeight:50,draggable:!0});var Xh=Qh;class Zh extends i.a.Component{getLabel(){const e=new Date(this.props.ts),t=new Date,s=new Date,n=[Object(l.a)("Sunday"),Object(l.a)("Monday"),Object(l.a)("Tuesday"),Object(l.a)("Wednesday"),Object(l.a)("Thursday"),Object(l.a)("Friday"),Object(l.a)("Saturday")];return s.setDate(t.getDate()-1),e.toDateString()===t.toDateString()?Object(l.a)("Today"):e.toDateString()===s.toDateString()?Object(l.a)("Yesterday"):t.getTime()-e.getTime()<5184e5?n[e.getDay()]:Object(kc.c)(e)}render(){return i.a.createElement("h2",{className:"mx_DateSeparator",role:"separator",tabIndex:-1},i.a.createElement("hr",{role:"none"}),i.a.createElement("div",null,this.getLabel()),i.a.createElement("hr",{role:"none"}))}}I()(Zh,"propTypes",{ts:xe.a.number.isRequired});var eu=s(1475),tu=s.n(eu),su=s(1476);const nu=function(){let e=null;return function(t){return e||(e=document.createElement("textarea")),e.innerHTML=t,e.value}}();function au(e){const t={stripReplyFallback:!0,returnString:!0};return"org.matrix.custom.html"===e.format?Object(rr.b)(e,null,t):function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(Object(rr.b)(e,null,t))}function iu(e){const t=document.createElement(Object(rr.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_insertion",t.appendChild(e),t}function ou(e){const t=document.createElement(Object(rr.c)(e)?"div":"span");return t.className="mx_EditHistoryMessage_deletion",t.appendChild(e),t}function ru(e){if("#text"===e.nodeName)return mu(e.data);{const t=document.createElement(e.nodeName);if(e.attributes)for(const[s,n]of Object.entries(e.attributes))t.setAttribute(s,n);if(e.childNodes)for(const s of e.childNodes)t.appendChild(ru(s));return t}}function lu(e,t,s){t?e.insertBefore(s,t):e.appendChild(s)}function cu(e,t){for(let s=0;s<e.length-1;++s)if(e[s]!==t[s])return!1;const s=e.length-1;return t[s]>=e[s]}function du(e,t){if("removeTextElement"===e.action||"removeElement"===e.action){const s=1;for(const n of t)cu(e.route,n.route)&&(n.route[e.route.length-1]+=s)}}function mu(e){return document.createTextNode(nu(e))}function hu(e,t,s){const{refNode:n,refParentNode:a}=function(e,t,s){let n,a=e;const i=s?t.length-1:t.length;for(let e=0;e<i;++e)n=a,a=a.childNodes[t[e]];return{refNode:a,refParentNode:n}}(e,t.route);switch(t.action){case"replaceElement":{const e=document.createElement("span"),s=ou(ru(t.oldValue)),a=iu(ru(t.newValue));e.appendChild(s),e.appendChild(a),n.parentNode.replaceChild(e,n);break}case"removeTextElement":{const e=ou(mu(t.value));n.parentNode.replaceChild(e,n);break}case"removeElement":{const e=ou(ru(t.element));n.parentNode.replaceChild(e,n);break}case"modifyTextElement":{const e=s.diff_main(t.oldValue,t.newValue);s.diff_cleanupSemantic(e);const a=document.createElement("span");for(const[t,s]of e){let e=mu(s);t<0?e=ou(e):t>0&&(e=iu(e)),a.appendChild(e)}n.parentNode.replaceChild(a,n);break}case"addElement":lu(a,n,iu(ru(t.element)));break;case"addTextElement":lu(a,n,iu(mu("\n"!==t.value?t.value:"")));break;case"removeAttribute":case"addAttribute":case"modifyAttribute":{const e=ou(n.cloneNode(!0)),s=n.cloneNode(!0);"addAttribute"===t.action||"modifyAttribute"===t.action?s.setAttribute(t.name,t.newValue):s.removeAttribute(t.name);const a=iu(s),i=document.createElement(Object(rr.c)(n)?"div":"span");i.appendChild(e),i.appendChild(a),n.parentNode.replaceChild(i,n);break}default:console.warn("MessageDiffUtils::editBodyDiffToHtml: diff action not supported atm",t)}}function uu(e,t){return e.length===t.length&&!e.some((e,s)=>e!==t[s])}function pu(e,t){const s=`<div>${au(e)}</div>`,n=`<div>${au(t)}</div>`,a=function(e){const t=e.slice();for(let e=0;e<t.length;++e){const s=t[e];if("removeTextElement"===s.action){const n=t[e+1];n&&"addTextElement"===n.action&&n.text===s.text&&uu(n.route,s.route)&&t.splice(e,2)}}return t}((new su.DiffDOM).diff(s,n)),o=new tu.a,r=(new DOMParser).parseFromString(s,"text/html").body.children[0];for(let e=0;e<a.length;++e){const t=a[e];hu(r,t,o),du(t,a.slice(e+1))}const l=r.innerHTML,c=L()({mx_EventTile_body:!0,"markdown-body":!0});return i.a.createElement("span",{key:"body",className:c,dangerouslySetInnerHTML:{__html:l},dir:"auto"})}var gu=s(758);function fu(e){const t=e.getOriginalContent();return t["m.new_content"]||t}class bu extends i.a.PureComponent{constructor(e){super(e),I()(this,"_onAssociatedStatusChanged",()=>{this.setState({sendStatus:this.props.mxEvent.getAssociatedStatus()})}),I()(this,"_onRedactClick",async()=>{const e=this.props.mxEvent,t=ee.a.get(),s=d.getComponent("dialogs.ConfirmAndWaitRedactDialog");De.a.createTrackedDialog("Confirm Redact Dialog","Edit history",s,{redact:()=>t.redactEvent(e.getRoomId(),e.getId())},"mx_Dialog_confirmredact")}),I()(this,"_onViewSourceClick",()=>{const e=d.getComponent("structures.ViewSource");De.a.createTrackedDialog("View Event Source","Edit history",e,{roomId:this.props.mxEvent.getRoomId(),eventId:this.props.mxEvent.getId(),content:this.props.mxEvent.event},"mx_Dialog_viewsource")});const t=ee.a.get(),{userId:s}=t.credentials,n=this.props.mxEvent,i=t.getRoom(n.getRoomId());n.localRedactionEvent()&&n.localRedactionEvent().on("status",this._onAssociatedStatusChanged);const o=i.currentState.maySendRedactionForEvent(n,s);this.state={canRedact:o,sendStatus:n.getAssociatedStatus()},this._content=Object(a.createRef)(),this._pills=[]}pillifyLinks(){this._content.current&&Object(gu.a)(this._content.current.children,this.props.mxEvent,this._pills)}componentDidMount(){this.pillifyLinks()}componentWillUnmount(){Object(gu.b)(this._pills);const e=this.props.mxEvent;e.localRedactionEvent()&&e.localRedactionEvent().off("status",this._onAssociatedStatusChanged)}componentDidUpdate(){this.pillifyLinks()}_renderActionBar(){const e=d.getComponent("elements.AccessibleButton");let t;return this.props.mxEvent.isRedacted()||this.props.isBaseEvent||!this.state.canRedact||(t=i.a.createElement(e,{onClick:this._onRedactClick},Object(l.a)("Remove"))),i.a.createElement("div",{className:"mx_MessageActionBar"},t)}render(){const{mxEvent:e}=this.props,t=fu(e);let s;if(e.isRedacted())s=i.a.createElement(so.a,{mxEvent:this.props.mxEvent});else{let n;if(n=this.props.previousEdit?pu(fu(this.props.previousEdit),t):rr.b(t,null,{stripReplyFallback:!0}),"m.emote"===e.getContent().msgtype){const t=e.sender?e.sender.name:e.getSender();s=i.a.createElement("div",{className:"mx_EventTile_content",ref:this._content},"* ",i.a.createElement("span",{className:"mx_MEmoteBody_sender"},t)," ",n)}else s=i.a.createElement("div",{className:"mx_EventTile_content",ref:this._content},n)}const n=Object(kc.d)(new Date(e.getTs()),this.props.isTwelveHour),a=-1!==["sending","queued","encrypting"].indexOf(this.state.sendStatus),o=L()({mx_EventTile:!0,mx_EventTile_sending:a,mx_EventTile_notSent:"not_sent"===this.state.sendStatus});return i.a.createElement("li",null,i.a.createElement("div",{className:o},i.a.createElement("div",{className:"mx_EventTile_line"},i.a.createElement("span",{className:"mx_MessageTimestamp"},n),s,this._renderActionBar())))}}I()(bu,"propTypes",{mxEvent:xe.a.instanceOf(Fe.j).isRequired,previousEdit:xe.a.instanceOf(Fe.j),isBaseEvent:xe.a.bool});class vu extends i.a.Component{constructor(e){super(e),this.state={playing:!1,decryptedUrl:null,decryptedBlob:null,error:null,isClean:null,contentUrl:null}}onPlayToggle(){this.setState({playing:!this.state.playing})}_getContentUrl(){return void 0!==this.props.mxEvent.getContent().file?this.state.decryptedUrl:this.state.contentUrl}componentDidMount(){const e=this.props.mxEvent.getContent();if(void 0!==e.file&&null===this.state.decryptedUrl){let t;Ns.a.scanContent(e).then(e=>{!0===e.clean&&this.setState({isClean:!0})}),Promise.resolve(Ns.a.downloadEncryptedContent(e)).then(e=>(t=e,URL.createObjectURL(e))).then(e=>{this.setState({decryptedUrl:e,decryptedBlob:t})}).catch(e=>{console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})})}else void 0!==e.url&&null===this.state.contentUrl&&Ns.a.scanContent(e).then(t=>{!0===t.clean?this.setState({contentUrl:Ns.a.getUnencryptedContentUrl(e),isClean:!0}):this.setState({isClean:!1})})}componentWillUnmount(){this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl)}render(){const e=this.props.mxEvent.getContent(),t=this.state.isClean;if(null===t)return i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(247),alt:Object(l.a)("Analysis in progress"),width:"32",height:"32"}),Object(l.a)("Analysis in progress"));if(!1===t)return i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16"}),Object(l.a)("The file %(file)s was rejected by the security policy",{file:e.body}));if(null!==this.state.error)return i.a.createElement("span",{className:"mx_MAudioBody"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16"}),Object(l.a)("Error decrypting audio"));if(void 0!==e.file&&null===this.state.decryptedUrl)return i.a.createElement("span",{className:"mx_MAudioBody"},i.a.createElement(qt.a,null));const n=this._getContentUrl();return i.a.createElement("span",{className:"mx_MAudioBody"},i.a.createElement("audio",{src:n,controls:!0}),i.a.createElement(Zi,se()({},this.props,{decryptedBlob:this.state.decryptedBlob})))}}class _u extends i.a.Component{constructor(e){super(e),this.onImageError=this.onImageError.bind(this),this.onImageLoad=this.onImageLoad.bind(this),this.onImageEnter=this.onImageEnter.bind(this),this.onImageLeave=this.onImageLeave.bind(this),this.onClientSync=this.onClientSync.bind(this),this.onClick=this.onClick.bind(this),this._isGif=this._isGif.bind(this),this.state={decryptedUrl:null,decryptedThumbnailUrl:null,decryptedBlob:null,error:null,imgError:!1,imgLoaded:!1,loadedImageDimensions:null,hover:!1,showImage:F.a.getValue("showImages"),contentUrl:null,isClean:null},this._image=Object(a.createRef)()}onClientSync(e,t){if(this.unmounted)return;"ERROR"!==e&&t!==e&&this.state.imgError&&this.setState({imgError:!1})}showImage(){localStorage.setItem("mx_ShowImage_"+this.props.mxEvent.getId(),"true"),this.setState({showImage:!0}),this._downloadImage()}onClick(e){if(0===e.button&&!e.metaKey){if(e.preventDefault(),!this.state.showImage)return void this.showImage();const t=this.props.mxEvent.getContent(),s=this._getContentUrl(),n=d.getComponent("elements.ImageView"),a={src:s,name:t.body&&t.body.length>0?t.body:Object(l.a)("Attachment"),mxEvent:this.props.mxEvent};t.info&&(a.width=t.info.w,a.height=t.info.h,a.fileSize=t.info.size),De.a.createDialog(n,a,"mx_Dialog_lightbox")}}_isGif(){const e=this.props.mxEvent.getContent();return e&&e.info&&"image/gif"===e.info.mimetype}onImageEnter(e){if(this.setState({hover:!0}),!this.state.showImage||!this._isGif()||F.a.getValue("autoplayGifsAndVideos"))return;e.target.src=this._getContentUrl()}onImageLeave(e){if(this.setState({hover:!1}),!this.state.showImage||!this._isGif()||F.a.getValue("autoplayGifsAndVideos"))return;e.target.src=this._getThumbUrl()}onImageError(){this.setState({imgError:!0})}onImageLoad(){let e;if(this.props.onHeightChanged(),this._image.current){const{naturalWidth:t,naturalHeight:s}=this._image.current;e={naturalWidth:t,naturalHeight:s}}this.setState({imgLoaded:!0,loadedImageDimensions:e})}_getContentUrl(){return void 0!==this.props.mxEvent.getContent().file?this.state.decryptedUrl:this.state.contentUrl}_getThumbUrl(){const e=this.props.mxEvent.getContent();return void 0!==e.file?this.state.decryptedThumbnailUrl?this.state.decryptedThumbnailUrl:this.state.decryptedUrl:(e.info&&"image/svg+xml"===e.info.mimetype&&e.info.thumbnail_url,Ns.a.getUnencryptedContentUrl(e,!0))}_downloadImage(){const e=this.props.mxEvent.getContent();void 0!==e.file&&null===this.state.decryptedUrl?Ns.a.scanContent(e).then(t=>{if(!0===t.clean){this.setState({isClean:!0});let t,s=Promise.resolve(null);e.info&&e.info.thumbnail_file&&(s=Ns.a.downloadEncryptedContent(e,!0).then(e=>URL.createObjectURL(e))),s.then(s=>Promise.resolve(Ns.a.downloadEncryptedContent(e)).then((function(e){return t=e,URL.createObjectURL(e)})).then(e=>{this.setState({decryptedUrl:e,decryptedThumbnailUrl:s,decryptedBlob:t})}).catch(e=>{this.setState({isClean:!1,error:e.error})})).catch(e=>{console.warn("Unable to decrypt attachment: ",e),this.setState({error:e})})}else this.setState({isClean:!1})}).catch(e=>{this.setState({isClean:!1,error:e.error})}):void 0!==e.url&&null===this.state.contentUrl?Ns.a.scanContent(e).then(t=>{!0===t.clean&&this.setState({contentUrl:Ns.a.getUnencryptedContentUrl(e),isClean:!0})}).catch(e=>{this.setState({isClean:!1,error:e.error})}):this.setState({isClean:!1})}componentDidMount(){this.unmounted=!1,this.context.on("sync",this.onClientSync);(this.state.showImage||"true"===localStorage.getItem("mx_ShowImage_"+this.props.mxEvent.getId()))&&(this._downloadImage(),this.setState({showImage:!0})),this._afterComponentDidMount()}_afterComponentDidMount(){}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("sync",this.onClientSync),this._afterComponentWillUnmount(),this.state.decryptedUrl&&URL.revokeObjectURL(this.state.decryptedUrl),this.state.decryptedThumbnailUrl&&URL.revokeObjectURL(this.state.decryptedThumbnailUrl)}_afterComponentWillUnmount(){}_messageContent(e,t,s){let n,a;if(s&&s.info&&s.info.w&&s.info.h)n=s.info.w,a=s.info.h;else{if(!this.state.loadedImageDimensions){let n;return n=this.state.showImage?i.a.createElement("img",{style:{display:"none"},src:t,ref:this._image,alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad}):i.a.createElement(yu,null),this.wrapImage(e,n)}n=this.state.loadedImageDimensions.naturalWidth,a=this.state.loadedImageDimensions.naturalHeight}const o=Math.min(this.props.maxImageHeight||600,a),r=n*o/a;let l=null,c=null,d=null;void 0!==s.file&&null===this.state.decryptedUrl?c=i.a.createElement(qt.a,{w:32,h:32}):this.state.imgLoaded||(c=this.getPlaceholder());let m=Boolean(c);t&&!this.state.imgError&&(l=i.a.createElement("img",{className:"mx_MImageBody_thumbnail",src:t,ref:this._image,style:{maxWidth:r+"px"},alt:s.body,onError:this.onImageError,onLoad:this.onImageLoad,onMouseEnter:this.onImageEnter,onMouseLeave:this.onImageLeave})),this.state.showImage||(l=i.a.createElement(yu,{style:{maxWidth:r+"px"}}),m=!1),!this._isGif()||F.a.getValue("autoplayGifsAndVideos")||this.state.hover||(d=i.a.createElement("p",{className:"mx_MImageBody_gifLabel"},"GIF"));const h=i.a.createElement("div",{className:"mx_MImageBody_thumbnail_container",style:{maxHeight:o+"px"}},i.a.createElement("div",{style:{paddingBottom:100*a/n+"%"}}),m&&i.a.createElement("div",{className:"mx_MImageBody_thumbnail",style:{maxWidth:n+"px"}},i.a.createElement("div",{className:"mx_MImageBody_thumbnail_spinner"},c)),i.a.createElement("div",{style:{display:m?"none":void 0}},l,d),this.state.hover&&this.getTooltip());return this.wrapImage(e,h)}wrapImage(e,t){return i.a.createElement("a",{href:e,onClick:this.onClick},t)}getPlaceholder(){return null}getTooltip(){return null}getFileBody(){return i.a.createElement(Zi,se()({},this.props,{decryptedBlob:this.state.decryptedBlob}))}render(){const e=this.props.mxEvent.getContent(),t=this.state.isClean;if(null!==this.state.error)return i.a.createElement("span",{className:"mx_MImageBody"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16",alt:"warning"}),Object(l.a)(this.state.error));if(null===t)return i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(247),alt:Object(l.a)("Analysis in progress"),width:"32",height:"32"}),Object(l.a)("Analysis in progress"));if(!1===t)return i.a.createElement("span",{className:"mx_MFileBody",ref:"body"},i.a.createElement("img",{src:s(160),className:"tc_MCS_error",width:"16",height:"16",alt:"warning"}),Object(l.a)("The file %(file)s was rejected by the security policy",{file:e.body}));const n=this._getContentUrl();let a;a=this._isGif()&&F.a.getValue("autoplayGifsAndVideos")?n:this._getThumbUrl();const o=this._messageContent(n,a,e),r=this.getFileBody();return i.a.createElement("span",{className:"mx_MImageBody"},o,r)}}I()(_u,"propTypes",{mxEvent:xe.a.object.isRequired,onHeightChanged:xe.a.func.isRequired,maxImageHeight:xe.a.number}),I()(_u,"contextType",b.a);class yu extends i.a.PureComponent{render(){let e="mx_HiddenImagePlaceholder";return this.props.hover&&(e+=" mx_HiddenImagePlaceholder_hover"),i.a.createElement("div",{className:e},i.a.createElement("div",{className:"mx_HiddenImagePlaceholder_button"},i.a.createElement("span",{className:"mx_HiddenImagePlaceholder_eye"}),i.a.createElement("span",null,Object(l.a)("Show image"))))}}I()(yu,"propTypes",{hover:xe.a.bool});class Eu extends i.a.Component{constructor(e){super(e),I()(this,"_onRequestChanged",()=>{this.forceUpdate()}),I()(this,"_onTrustChanged",(e,t)=>{const{mxEvent:s}=this.props,n=s.verificationRequest;n&&n.otherUserId===e&&this.forceUpdate()})}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this._onRequestChanged),ee.a.get().on("userTrustStatusChanged",this._onTrustChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this._onRequestChanged);const t=ee.a.get();t&&t.removeListener("userTrustStatusChanged",this._onTrustChanged)}_shouldRender(e,t){return!!t&&(!("m.key.verification.cancel"===e.getType()&&!t.cancelled)&&(!("m.key.verification.done"===e.getType()&&!t.done)&&(!t.pending&&!!ee.a.get().checkUserTrust(t.otherUserId).isCrossSigningVerified())))}render(){const{mxEvent:e}=this.props,t=e.verificationRequest;if(!this._shouldRender(e,t))return null;const s=ee.a.get().getUserId();let n;if(t.done)n=Object(l.a)("You verified %(name)s",{name:nc(t.otherUserId,e)});else if(t.cancelled){const a=t.cancellingUserId;n=a===s?Object(l.a)("You cancelled verifying %(name)s",{name:nc(t.otherUserId,e)}):Object(l.a)("%(name)s cancelled verifying",{name:nc(a,e)})}if(n){const s=L()("mx_cryptoEvent mx_cryptoEvent_icon",{mx_cryptoEvent_icon_verified:t.done});return i.a.createElement(Fi,{className:s,title:n,subtitle:ac(t.otherUserId,e.getRoomId())})}return null}}Eu.propTypes={mxEvent:xe.a.object.isRequired};class Cu extends i.a.Component{constructor(e){super(e),I()(this,"_openRequest",()=>{const{verificationRequest:e}=this.props.mxEvent,t=ee.a.get().getUser(e.otherUserId);m.a.dispatch({action:h.a.SetRightPanelPhase,phase:ls.b.EncryptionPanel,refireParams:{verificationRequest:e,member:t}})}),I()(this,"_onRequestChanged",()=>{this.forceUpdate()}),I()(this,"_onAcceptClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{this._openRequest(),await e.accept()}catch(e){console.error(e.message)}}),I()(this,"_onRejectClicked",async()=>{const e=this.props.mxEvent.verificationRequest;if(e)try{await e.cancel()}catch(e){console.error(e.message)}}),this.state={}}componentDidMount(){const e=this.props.mxEvent.verificationRequest;e&&e.on("change",this._onRequestChanged)}componentWillUnmount(){const e=this.props.mxEvent.verificationRequest;e&&e.off("change",this._onRequestChanged)}_acceptedLabel(e){return e===ee.a.get().getUserId()?Object(l.a)("You accepted"):Object(l.a)("%(name)s accepted",{name:nc(e,this.props.mxEvent.getRoomId())})}_cancelledLabel(e){const t=ee.a.get().getUserId(),{cancellationCode:s}=this.props.mxEvent.verificationRequest,n="m.user"===s;return e===t?n?Object(l.a)("You declined"):Object(l.a)("You cancelled"):n?Object(l.a)("%(name)s declined",{name:nc(e,this.props.mxEvent.getRoomId())}):Object(l.a)("%(name)s cancelled",{name:nc(e,this.props.mxEvent.getRoomId())})}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.FormButton"),{mxEvent:s}=this.props,n=s.verificationRequest;if(!n||n.invalid)return null;let a,o,r;if(!n.canAccept){let t;n.ready||n.started||n.done?t=i.a.createElement(e,{onClick:this._openRequest},this._acceptedLabel(n.receivingUserId)):n.cancelled?t=this._cancelledLabel(n.cancellingUserId):n.accepting?t=Object(l.a)("Accepting …"):n.declining&&(t=Object(l.a)("Declining …")),r=i.a.createElement("div",{className:"mx_cryptoEvent_state"},t)}if(n.initiatedByMe)a=Object(l.a)("You sent a verification request"),o=ac(n.receivingUserId,s.getRoomId());else{const e=nc(n.requestingUserId,s.getRoomId());a=Object(l.a)("%(name)s wants to verify",{name:e}),o=ac(n.requestingUserId,s.getRoomId()),n.canAccept&&(r=i.a.createElement("div",{className:"mx_cryptoEvent_buttons"},i.a.createElement(t,{kind:"danger",onClick:this._onRejectClicked,label:Object(l.a)("Decline")}),i.a.createElement(t,{onClick:this._onAcceptClicked,label:Object(l.a)("Accept")})))}return a?i.a.createElement(Fi,{className:"mx_cryptoEvent mx_cryptoEvent_icon",title:a,subtitle:o},r):null}}Cu.propTypes={mxEvent:xe.a.object.isRequired};class wu extends _u{onClick(e){e.preventDefault(),this.state.showImage||this.showImage()}wrapImage(e,t){let s=null;return this.state.showImage||(s=this.onClick),i.a.createElement("div",{className:"mx_MStickerBody_wrapper",onClick:s}," ",t," ")}getPlaceholder(){const e=d.getComponent("elements.TintableSvg");return i.a.createElement(e,{src:s(1477),width:"75",height:"75"})}getTooltip(){const e=this.props.mxEvent&&this.props.mxEvent.getContent();if(!(e&&e.body&&e.info&&e.info.w))return null;const t=d.getComponent("elements.Tooltip");return i.a.createElement("div",{style:{left:e.info.w+"px"},className:"mx_MStickerBody_tooltip"},i.a.createElement(t,{label:e.body}))}getFileBody(){return null}}var Su=s(227);const xu=({mxEvent:e,getTile:t,getReplyThread:s,permalinkCreator:o,onFocusChange:r})=>{const[c,m,h,u]=Object(n.q)(),[p,g,f]=Object(Y.e)(m);let b;if(Object(a.useEffect)(()=>{r(c)},[r,c]),c){const a=d.getComponent("context_menus.MessageContextMenu"),r=t&&t(),l=s&&s(),c=m.current.getBoundingClientRect();b=i.a.createElement(n.b,se()({},Object(n.k)(c),{onFinished:u}),i.a.createElement(a,{mxEvent:e,permalinkCreator:o,eventTileOps:r&&r.getEventTileOps?r.getEventTileOps():void 0,collapseReplyThread:l&&l.canCollapse()?l.collapse:void 0,onFinished:u}))}return i.a.createElement(i.a.Fragment,null,i.a.createElement(n.d,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_optionsButton",title:Object(l.a)("Options"),onClick:h,isExpanded:c,inputRef:f,onFocus:p,tabIndex:g?0:-1}),b)},Ru=({mxEvent:e,reactions:t,onFocusChange:s})=>{const[o,r,c,m]=Object(n.q)(),[h,u,p]=Object(Y.e)(r);let g;if(Object(a.useEffect)(()=>{s(o)},[s,o]),o){const s=r.current.getBoundingClientRect(),a=d.getComponent("emojipicker.ReactionPicker");g=i.a.createElement(n.b,se()({},Object(n.k)(s),{onFinished:m,managed:!1}),i.a.createElement(a,{mxEvent:e,reactions:t,onFinished:m}))}return i.a.createElement(i.a.Fragment,null,i.a.createElement(n.d,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_reactButton",title:Object(l.a)("React"),onClick:c,isExpanded:o,inputRef:p,onFocus:h,tabIndex:u?0:-1}),g)};class Ou extends i.a.PureComponent{constructor(...e){super(...e),I()(this,"onDecrypted",()=>{this.forceUpdate()}),I()(this,"onBeforeRedaction",()=>{this.forceUpdate()}),I()(this,"onSent",()=>{this.forceUpdate()}),I()(this,"onFocusChange",e=>{this.props.onFocusChange&&this.props.onFocusChange(e)}),I()(this,"onReplyClick",e=>{m.a.dispatch({action:"reply_to_event",event:this.props.mxEvent})}),I()(this,"onEditClick",e=>{m.a.dispatch({action:"edit_event",event:this.props.mxEvent})})}componentDidMount(){this.props.mxEvent.status&&this.props.mxEvent.status!==Fe.b.SENT&&this.props.mxEvent.on("Event.status",this.onSent),this.props.mxEvent.isBeingDecrypted()&&this.props.mxEvent.once("Event.decrypted",this.onDecrypted),this.props.mxEvent.on("Event.beforeRedaction",this.onBeforeRedaction)}componentWillUnmount(){this.props.mxEvent.off("Event.status",this.onSent),this.props.mxEvent.off("Event.decrypted",this.onDecrypted),this.props.mxEvent.off("Event.beforeRedaction",this.onBeforeRedaction)}render(){let e,t,s;return Ad(this.props.mxEvent)&&(this.context.canReact&&(e=i.a.createElement(Ru,{mxEvent:this.props.mxEvent,reactions:this.props.reactions,onFocusChange:this.onFocusChange})),this.context.canReply&&(t=i.a.createElement(Y.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_replyButton",title:Object(l.a)("Reply"),onClick:this.onReplyClick}))),Ud(this.props.mxEvent)&&(s=i.a.createElement(Y.b,{className:"mx_MessageActionBar_maskButton mx_MessageActionBar_editButton",title:Object(l.a)("Edit"),onClick:this.onEditClick})),i.a.createElement(ys,{className:"mx_MessageActionBar","aria-label":Object(l.a)("Message Actions"),"aria-live":"off"},e,t,s,i.a.createElement(xu,{mxEvent:this.props.mxEvent,getReplyThread:this.props.getReplyThread,getTile:this.props.getTile,permalinkCreator:this.props.permalinkCreator,onFocusChange:this.onFocusChange}))}}I()(Ou,"propTypes",{mxEvent:xe.a.object.isRequired,reactions:xe.a.object,permalinkCreator:xe.a.object,getTile:xe.a.func,getReplyThread:xe.a.func,onFocusChange:xe.a.func}),I()(Ou,"contextType",Su.a);var ku=s(743);class Iu extends i.a.Component{render(){const e=new Date(this.props.ts);return i.a.createElement("span",{className:"mx_MessageTimestamp",title:Object(kc.b)(e,this.props.showTwelveHour),"aria-hidden":!0},Object(kc.d)(e,this.props.showTwelveHour))}}I()(Iu,"propTypes",{ts:xe.a.number.isRequired,showTwelveHour:xe.a.bool});class Tu extends i.a.Component{constructor(){super(),I()(this,"_onAllowClick",e=>{e.preventDefault(),e.stopPropagation();const t=`mx_mjolnir_render_${this.props.mxEvent.getRoomId()}__${this.props.mxEvent.getId()}`;localStorage.setItem(t,"true"),this.props.onMessageAllowed()})}render(){return i.a.createElement("div",{className:"mx_MjolnirBody"},i.a.createElement("i",null,Object(l.a)("You have ignored this user, so their message is hidden. <a>Show anyways.</a>",{},{a:e=>i.a.createElement("a",{href:"#",onClick:this._onAllowClick},e)})))}}I()(Tu,"propTypes",{mxEvent:xe.a.object.isRequired,onMessageAllowed:xe.a.func.isRequired});class ju extends i.a.PureComponent{constructor(e){super(e),I()(this,"onReactionsChange",()=>{this.setState({myReactions:this.getMyReactions()}),this.forceUpdate()}),I()(this,"onShowAllClick",()=>{this.setState({showAll:!0})}),e.reactions&&(e.reactions.on("Relations.add",this.onReactionsChange),e.reactions.on("Relations.remove",this.onReactionsChange),e.reactions.on("Relations.redaction",this.onReactionsChange)),this.state={myReactions:this.getMyReactions(),showAll:!1}}componentDidUpdate(e){e.reactions!==this.props.reactions&&(this.props.reactions.on("Relations.add",this.onReactionsChange),this.props.reactions.on("Relations.remove",this.onReactionsChange),this.props.reactions.on("Relations.redaction",this.onReactionsChange),this.onReactionsChange())}componentWillUnmount(){this.props.reactions&&(this.props.reactions.removeListener("Relations.add",this.onReactionsChange),this.props.reactions.removeListener("Relations.remove",this.onReactionsChange),this.props.reactions.removeListener("Relations.redaction",this.onReactionsChange))}getMyReactions(){const e=this.props.reactions;if(!e)return null;const t=ee.a.get().getUserId(),s=e.getAnnotationsBySender()[t];return s?[...s.values()]:null}render(){const{mxEvent:e,reactions:t}=this.props,{myReactions:s,showAll:n}=this.state;if(!t||!Ad(e))return null;const a=d.getComponent("messages.ReactionsRowButton");let o,r=t.getSortedAnnotationsByKey().map(([t,n])=>{const o=n.size;if(!o)return null;const r=s&&s.find(e=>!e.isRedacted()&&e.getRelation().key===t);return i.a.createElement(a,{key:t,content:t,count:o,mxEvent:e,reactionEvents:n,myReactionEvent:r})}).filter(e=>!!e);return r.length>9&&!n&&(r=r.slice(0,8),o=i.a.createElement("a",{className:"mx_ReactionsRow_showAll",href:"#",onClick:this.onShowAllClick},Object(l.a)("Show all"))),i.a.createElement("div",{className:"mx_ReactionsRow",role:"toolbar","aria-label":Object(l.a)("Reactions")},r,o)}}I()(ju,"propTypes",{mxEvent:xe.a.object.isRequired,reactions:xe.a.object});class Nu extends i.a.PureComponent{constructor(e){super(e),I()(this,"onClick",e=>{const{mxEvent:t,myReactionEvent:s,content:n}=this.props;s?ee.a.get().redactEvent(t.getRoomId(),s.getId()):(ee.a.get().sendEvent(t.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:t.getId(),key:n}}),m.a.dispatch({action:"message_sent"}))}),I()(this,"onMouseOver",()=>{this.setState({tooltipRendered:!0,tooltipVisible:!0})}),I()(this,"onMouseLeave",()=>{this.setState({tooltipVisible:!1})}),this.state={tooltipVisible:!1}}render(){const e=d.getComponent("messages.ReactionsRowButtonTooltip"),{mxEvent:t,content:s,count:n,reactionEvents:a,myReactionEvent:o}=this.props,r=L()({mx_ReactionsRowButton:!0,mx_ReactionsRowButton_selected:!!o});let c;this.state.tooltipRendered&&(c=i.a.createElement(e,{mxEvent:this.props.mxEvent,content:s,reactionEvents:a,visible:this.state.tooltipVisible}));const m=ee.a.get().getRoom(t.getRoomId());let h;if(m){const e=[];for(const t of a){const s=m.getMember(t.getSender()),n=s?s.name:t.getSender();e.push(n)}h=Object(l.a)("<reactors/><reactedWith> reacted with %(content)s</reactedWith>",{content:s},{reactors:()=>Object(q.b)(e,6),reactedWith:e=>s?e:null})}const u=d.getComponent("elements.AccessibleButton");return i.a.createElement(u,{className:r,"aria-label":h,onClick:this.onClick,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave},i.a.createElement("span",{className:"mx_ReactionsRowButton_content","aria-hidden":"true"},s),i.a.createElement("span",{className:"mx_ReactionsRowButton_count","aria-hidden":"true"},n),c)}}I()(Nu,"propTypes",{mxEvent:xe.a.object.isRequired,content:xe.a.string.isRequired,count:xe.a.number.isRequired,reactionEvents:xe.a.object.isRequired,myReactionEvent:xe.a.object});class Pu extends i.a.PureComponent{render(){const e=d.getComponent("elements.Tooltip"),{content:t,reactionEvents:s,mxEvent:n,visible:a}=this.props,o=ee.a.get().getRoom(n.getRoomId());let r,c;if(o){const e=[];for(const t of s){const s=o.getMember(t.getSender()),n=s?s.name:t.getSender();e.push(n)}const n=Object(rr.j)(t);r=i.a.createElement("div",null,Object(l.a)("<reactors/><reactedWith>reacted with %(shortName)s</reactedWith>",{shortName:n},{reactors:()=>i.a.createElement("div",{className:"mx_Tooltip_title"},Object(q.b)(e,6)),reactedWith:e=>n?i.a.createElement("div",{className:"mx_Tooltip_sub"},e):null}))}return r&&(c=i.a.createElement(e,{visible:a,label:r})),c}}I()(Pu,"propTypes",{mxEvent:xe.a.object.isRequired,content:xe.a.string.isRequired,reactionEvents:xe.a.object.isRequired,visible:xe.a.bool.isRequired});class Du extends i.a.Component{constructor(...e){super(...e),I()(this,"onAvatarClick",()=>{const e=ee.a.get(),t=this.props.mxEvent,s=e.mxcUrlToHttp(t.getContent().url),n=e.getRoom(this.props.mxEvent.getRoomId()),a=Object(l.a)("%(senderDisplayName)s changed the avatar for %(roomName)s",{senderDisplayName:t.sender&&t.sender.name?t.sender.name:t.getSender(),roomName:n?n.name:""}),i=d.getComponent("elements.ImageView"),o={src:s,name:a};De.a.createDialog(i,o,"mx_Dialog_lightbox")})}render(){const e=this.props.mxEvent,t=e.sender&&e.sender.name?e.sender.name:e.getSender(),s=d.getComponent("avatars.RoomAvatar");if(!e.getContent().url||0===e.getContent().url.trim().length)return i.a.createElement("div",{className:"mx_TextualEvent"},Object(l.a)("%(senderDisplayName)s removed the room avatar.",{senderDisplayName:t}));const n=ee.a.get().getRoom(e.getRoomId()),a={avatarUrl:e.getContent().url,name:n?n.name:""};return i.a.createElement("div",{className:"mx_RoomAvatarEvent"},Object(l.a)("%(senderDisplayName)s changed the room avatar to <img/>",{senderDisplayName:t},{img:()=>i.a.createElement(pe.a,{key:"avatar",className:"mx_RoomAvatarEvent_avatar",onClick:this.onAvatarClick},i.a.createElement(s,{width:14,height:14,oobData:a}))}))}}I()(Du,"propTypes",{mxEvent:xe.a.object.isRequired});class Au extends i.a.Component{constructor(...e){super(...e),I()(this,"_onLinkClicked",e=>{e.preventDefault();const t=this.props.mxEvent.getContent().predecessor;m.a.dispatch({action:"view_room",event_id:t.event_id,highlighted:!0,room_id:t.room_id})})}render(){const e=this.props.mxEvent.getContent().predecessor;if(void 0===e)return i.a.createElement("div",null);const t=ee.a.get().getRoom(e.room_id),s=new ur.a(t,e.room_id);s.load();const n=s.forEvent(e.event_id),a=i.a.createElement("a",{href:n,onClick:this._onLinkClicked},Object(l.a)("Click here to see older messages."));return i.a.createElement(Fi,{className:"mx_CreateEvent",title:Object(l.a)("This room is a continuation of another conversation."),subtitle:a})}}I()(Au,"propTypes",{mxEvent:xe.a.object.isRequired});class Uu extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{userGroups:null,relatedGroups:[]}),I()(this,"onRoomStateEvents",e=>{"m.room.related_groups"===e.getType()&&e.getRoomId()===this.props.mxEvent.getRoomId()&&this._updateRelatedGroups()})}componentDidMount(){this.unmounted=!1,this._updateRelatedGroups(),ds.a.getPublicisedGroupsCached(this.context,this.props.mxEvent.getSender()).then(e=>{this.unmounted||this.setState({userGroups:e})}),this.context.on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){this.unmounted=!0,this.context.removeListener("RoomState.events",this.onRoomStateEvents)}_updateRelatedGroups(){if(this.unmounted)return;const e=this.context.getRoom(this.props.mxEvent.getRoomId());if(!e)return;const t=e.currentState.getStateEvents("m.room.related_groups","");this.setState({relatedGroups:t&&t.getContent().groups||[]})}_getDisplayedGroups(e,t){let s=e||[];return s=t&&t.length>0?t.filter(e=>s.includes(e)):[],s}render(){const{mxEvent:e}=this.props,t=Object(q.f)(e.getSender()),{msgtype:s}=e.getContent();let n="";const a=ee.a.get().getUser(e.getSender());if(n=a?a.rawDisplayName:e.sender?e.sender.name:e.getSender()?e.getSender():"","m.emote"===s)return i.a.createElement("span",null);let o=i.a.createElement("div",null);if(this.props.enableFlair){const t=this._getDisplayedGroups(this.state.userGroups,this.state.relatedGroups);o=i.a.createElement(Ih,{key:"flair",userId:e.getSender(),groups:t})}const r=n||"",c=i.a.createElement("span",null,i.a.createElement("span",{className:"mx_SenderProfile_name "+t},r),o),d=this.props.text?i.a.createElement("span",null,i.a.createElement("span",{className:"mx_SenderProfile_aux"},Object(l.a)(this.props.text,{senderName:()=>r}))):c;return i.a.createElement("div",{className:"mx_SenderProfile",dir:"auto",onClick:this.props.onClick},i.a.createElement("div",{className:"mx_SenderProfile_hover"},d))}}I()(Uu,"propTypes",{mxEvent:xe.a.object.isRequired,text:xe.a.string,onClick:xe.a.func}),I()(Uu,"contextType",b.a);var Mu=s(1478);class Lu extends i.a.Component{render(){const e=Ic.a(this.props.mxEvent);return null==e||0===e.length?null:i.a.createElement("div",{className:"mx_TextualEvent"},e)}}I()(Lu,"propTypes",{mxEvent:xe.a.object.isRequired});class Fu extends i.a.Component{constructor(e){super(e),I()(this,"_onBugReport",()=>{const e=d.getComponent("dialogs.BugReportDialog");e&&De.a.createTrackedDialog("Bug Report Dialog","",e,{label:"react-soft-crash-tile"})}),this.state={error:null}}static getDerivedStateFromError(e){return{error:e}}render(){if(this.state.error){const{mxEvent:e}=this.props,t={mx_EventTile:!0,mx_EventTile_info:!0,mx_EventTile_content:!0,mx_EventTile_tileError:!0};let s;return c.a.get().bug_report_endpoint_url&&(s=i.a.createElement("a",{onClick:this._onBugReport,href:"#"},Object(l.a)("Submit logs"))),i.a.createElement("div",{className:L()(t)},i.a.createElement("div",{className:"mx_EventTile_line"},i.a.createElement("span",null,Object(l.a)("Can't load this message"),e&&` (${e.getType()})`,s)))}return this.props.children}}var Bu,Vu=s(744);class Wu extends i.a.PureComponent{constructor(e){super(e),I()(this,"onToggle",e=>{e.preventDefault();const{expanded:t}=this.state;this.setState({expanded:!t})}),this.state={expanded:!1}}componentDidMount(){const{mxEvent:e}=this.props;e.isBeingDecrypted()&&e.once("Event.decrypted",()=>this.forceUpdate())}render(){const{mxEvent:e}=this.props,{expanded:t}=this.state;let s;s=t?i.a.createElement("pre",null,JSON.stringify(e,null,4)):i.a.createElement("code",null,`{ "type": ${e.getType()} }`);const n=L()("mx_ViewSourceEvent mx_EventTile_content",{mx_ViewSourceEvent_expanded:t});return i.a.createElement("span",{className:n},s,i.a.createElement("a",{className:"mx_ViewSourceEvent_toggle",href:"#",onClick:this.onToggle}))}}I()(Wu,"propTypes",{mxEvent:xe.a.object.isRequired});let Hu=ya("views.room_settings.RoomPublishSetting")(Bu=class extends i.a.PureComponent{constructor(e){super(e),I()(this,"onRoomPublishChange",e=>{const t=this.state.isRoomPublished,s=!t;this.setState({isRoomPublished:s});ee.a.get().setRoomDirectoryVisibility(this.props.roomId,s?"public":"private").catch(()=>{this.setState({isRoomPublished:t})})}),this.state={isRoomPublished:!1}}componentDidMount(){ee.a.get().getRoomDirectoryVisibility(this.props.roomId).then(e=>{this.setState({isRoomPublished:"public"===e.visibility})})}render(){const e=ee.a.get();return i.a.createElement(Ze.a,{value:this.state.isRoomPublished,onChange:this.onRoomPublishChange,disabled:!this.props.canSetCanonicalAlias,label:Object(l.a)("Publish this room to the %(domain)s's forum directory?",{domain:e.getDomain()})})}})||Bu;class Gu extends Sh{constructor(e){super(e),I()(this,"_onAliasAdded",async()=>{await this._aliasField.current.validate({allowEmpty:!1}),this._aliasField.current.isValid?this.props.onItemAdded&&this.props.onItemAdded(this.props.newItem):(this._aliasField.current.focus(),this._aliasField.current.validate({allowEmpty:!1,focused:!0}))}),this._aliasField=Object(a.createRef)()}_renderNewItemField(){if(!this.props.domain)return super._renderNewItemField();const e=d.getComponent("views.elements.RoomAliasField");return i.a.createElement("form",{onSubmit:this._onAliasAdded,autoComplete:"off",noValidate:!0,className:"mx_EditableItemList_newItem"},i.a.createElement(e,{ref:this._aliasField,onChange:e=>this._onNewItemChanged({target:{value:e}}),value:this.props.newItem||"",domain:this.props.domain}),i.a.createElement(pe.a,{onClick:this._onAliasAdded,kind:"primary"},Object(l.a)("Add")))}}class qu extends i.a.Component{constructor(e){super(e),I()(this,"onNewAliasChanged",e=>{this.setState({newAlias:e})}),I()(this,"onLocalAliasAdded",e=>{if(!e||0===e.length)return;const t=ee.a.get().getDomain();e.includes(":")||(e+=":"+t),ee.a.get().createAlias(e,this.props.roomId).then(()=>{this.setState({localAliases:this.state.localAliases.concat(e),newAlias:null}),this.state.canonicalAlias||this.changeCanonicalAlias(e)}).catch(e=>{console.error(e),De.a.createTrackedDialog("Error creating address","",Ae.a,{title:Object(l.a)("Error creating address"),description:Object(l.a)("There was an error creating that address. It may not be allowed by the server or a temporary failure occurred.")})})}),I()(this,"onLocalAliasDeleted",e=>{const t=this.state.localAliases[e];ee.a.get().deleteAlias(t).then(()=>{const e=this.state.localAliases.filter(e=>e!==t);this.setState({localAliases:e}),this.state.canonicalAlias===t&&this.changeCanonicalAlias(null)}).catch(e=>{let t;console.error(e),t="M_FORBIDDEN"===e.errcode?Object(l.a)("You don't have permission to delete the address."):Object(l.a)("There was an error removing that address. It may no longer exist or a temporary error occurred."),De.a.createTrackedDialog("Error removing address","",Ae.a,{title:Object(l.a)("Error removing address"),description:t})})}),I()(this,"onLocalAliasesToggled",e=>{e.target.open&&(this.props.canSetCanonicalAlias||0!==this.state.localAliases.length||this.loadLocalAliases()),this.setState({detailsOpen:e.target.open})}),I()(this,"onCanonicalAliasChange",e=>{this.changeCanonicalAlias(e.target.value)}),I()(this,"onNewAltAliasChanged",e=>{this.setState({newAltAlias:e})}),I()(this,"onAltAliasAdded",e=>{const t=this.state.altAliases.slice();t.some(t=>t.trim()===e.trim())||(t.push(e.trim()),this.changeAltAliases(t),this.setState({newAltAlias:""}))}),I()(this,"onAltAliasDeleted",e=>{const t=this.state.altAliases.slice();t.splice(e,1),this.changeAltAliases(t)});const t={altAliases:[],localAliases:[],canonicalAlias:null,updatingCanonicalAlias:!1,localAliasesLoading:!1,detailsOpen:!1};if(e.canonicalAliasEvent){const s=e.canonicalAliasEvent.getContent(),n=s.alt_aliases;Array.isArray(n)&&(t.altAliases=n.slice()),t.canonicalAlias=s.alias}this.state=t}componentDidMount(){this.props.canSetCanonicalAlias&&this.loadLocalAliases()}async loadLocalAliases(){this.setState({localAliasesLoading:!0});try{const e=ee.a.get();let t=[];if(await e.doesServerSupportUnstableFeature("org.matrix.msc2432")){const s=await e.unstableGetLocalAliases(this.props.roomId);Array.isArray(s.aliases)&&(t=s.aliases)}this.setState({localAliases:t})}finally{this.setState({localAliasesLoading:!1})}}changeCanonicalAlias(e){if(!this.props.canSetCanonicalAlias)return;const t=this.state.canonicalAlias;this.setState({canonicalAlias:e,updatingCanonicalAlias:!0});const s={alt_aliases:this.state.altAliases};e&&(s.alias=e),ee.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",s,"").catch(e=>{console.error(e),De.a.createTrackedDialog("Error updating main address","",Ae.a,{title:Object(l.a)("Error updating main address"),description:Object(l.a)("There was an error updating the room's main address. It may not be allowed by the server or a temporary failure occurred.")}),this.setState({canonicalAlias:t})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}changeAltAliases(e){if(!this.props.canSetCanonicalAlias)return;this.setState({updatingCanonicalAlias:!0,altAliases:e});const t={};this.state.canonicalAlias&&(t.alias=this.state.canonicalAlias),e&&(t.alt_aliases=e),ee.a.get().sendStateEvent(this.props.roomId,"m.room.canonical_alias",t,"").catch(e=>{console.error(e),De.a.createTrackedDialog("Error updating alternative addresses","",Ae.a,{title:Object(l.a)("Error updating main address"),description:Object(l.a)("There was an error updating the room's alternative addresses. It may not be allowed by the server or a temporary failure occurred.")})}).finally(()=>{this.setState({updatingCanonicalAlias:!1})})}_getAliases(){return this.state.altAliases.concat(this._getLocalNonAltAliases())}_getLocalNonAltAliases(){const{altAliases:e}=this.state;return this.state.localAliases.filter(t=>!e.includes(t))}render(){const e=ee.a.get().getDomain();let t=!1;const s=this.state.canonicalAlias||"",n=i.a.createElement(ke.a,{onChange:this.onCanonicalAliasChange,value:s,disabled:this.state.updatingCanonicalAlias||!this.props.canSetCanonicalAlias,element:"select",id:"canonicalAlias",label:Object(l.a)("Main address")},i.a.createElement("option",{value:"",key:"unset"},Object(l.a)("not specified")),this._getAliases().map((e,s)=>(e===this.state.canonicalAlias&&(t=!0),i.a.createElement("option",{value:e,key:s},e))),t||!this.state.canonicalAlias?"":i.a.createElement("option",{value:this.state.canonicalAlias,key:"arbitrary"},this.state.canonicalAlias));let a;if(this.state.localAliasesLoading){const e=d.getComponent("elements.Spinner");a=i.a.createElement(e,null)}else a=i.a.createElement(Gu,{id:"roomAliases",className:"mx_RoomSettings_localAliases",items:this.state.localAliases,newItem:this.state.newAlias,onNewItemChanged:this.onNewAliasChanged,canRemove:this.props.canSetAliases,canEdit:this.props.canSetAliases,onItemAdded:this.onLocalAliasAdded,onItemRemoved:this.onLocalAliasDeleted,noItemsLabel:Object(l.a)("This room has no local addresses"),placeholder:Object(l.a)("Local address"),domain:e});return i.a.createElement("div",{className:"mx_AliasSettings"},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},Object(l.a)("Published Addresses")),i.a.createElement("p",null,Object(l.a)("Published addresses can be used by anyone on any server to join your room. To publish an address, it needs to be set as a local address first.")),n,i.a.createElement(Hu,{roomId:this.props.roomId,canSetCanonicalAlias:this.props.canSetCanonicalAlias}),i.a.createElement("datalist",{id:"mx_AliasSettings_altRecommendations"},this._getLocalNonAltAliases().map(e=>i.a.createElement("option",{value:e,key:e})),";"),i.a.createElement(Gu,{id:"roomAltAliases",className:"mx_RoomSettings_altAliases",items:this.state.altAliases,newItem:this.state.newAltAlias,onNewItemChanged:this.onNewAltAliasChanged,canRemove:this.props.canSetCanonicalAlias,canEdit:this.props.canSetCanonicalAlias,onItemAdded:this.onAltAliasAdded,onItemRemoved:this.onAltAliasDeleted,suggestionsListId:"mx_AliasSettings_altRecommendations",itemsLabel:Object(l.a)("Other published addresses:"),noItemsLabel:Object(l.a)("No other published addresses yet, add one below"),placeholder:Object(l.a)("New published address (e.g. #alias:server)")}),i.a.createElement("span",{className:"mx_SettingsTab_subheading mx_AliasSettings_localAliasHeader"},Object(l.a)("Local Addresses")),i.a.createElement("p",null,Object(l.a)("Set addresses for this room so users can find this room through your homeserver (%(localDomain)s)",{localDomain:e})),i.a.createElement("details",{onToggle:this.onLocalAliasesToggled},i.a.createElement("summary",null,this.state.detailsOpen?Object(l.a)("Show less"):Object(l.a)("Show more")),a))}}I()(qu,"propTypes",{roomId:xe.a.string.isRequired,canSetCanonicalAlias:xe.a.bool.isRequired,canSetAliases:xe.a.bool.isRequired,canonicalAliasEvent:xe.a.object}),I()(qu,"defaultProps",{canSetAliases:!1,canSetCanonicalAlias:!1,aliasEvents:[]});const Ku=/\+\S+:\S+/;class zu extends i.a.Component{constructor(e){super(e),I()(this,"onNewGroupChanged",e=>{this.setState({newGroupId:e})}),I()(this,"onGroupAdded",e=>{if(0===e.length||!this.validateGroupId(e))return;const t=[...this.state.newGroupsList,e];this.setState({newGroupsList:t,newGroupId:""}),this.updateGroups(t)}),I()(this,"onGroupDeleted",e=>{const t=this.state.newGroupsList[e],s=this.state.newGroupsList.filter(e=>e!==t);this.setState({newGroupsList:s}),this.updateGroups(s)}),this.state={newGroupId:"",newGroupsList:e.relatedGroupsEvent&&e.relatedGroupsEvent.getContent().groups||[]}}updateGroups(e){this.context.sendStateEvent(this.props.roomId,"m.room.related_groups",{groups:e},"").catch(e=>{console.error(e),De.a.createTrackedDialog("Error updating flair","",Ae.a,{title:Object(l.a)("Error updating flair"),description:Object(l.a)("There was an error updating the flair for this room. The server may not allow it or a temporary error occurred.")})})}validateGroupId(e){if(!Ku.test(e)){const t=d.getComponent("dialogs.ErrorDialog");return De.a.createTrackedDialog("Invalid related community ID","",t,{title:Object(l.a)("Invalid community ID"),description:Object(l.a)("'%(groupId)s' is not a valid community ID",{groupId:e})}),!1}return!0}render(){const e=this.context.getDomain(),t=d.getComponent("elements.EditableItemList");return i.a.createElement("div",null,i.a.createElement(t,{id:"relatedGroups",items:this.state.newGroupsList,className:"mx_RelatedGroupSettings",newItem:this.state.newGroupId,canRemove:this.props.canSetRelatedGroups,canEdit:this.props.canSetRelatedGroups,onNewItemChanged:this.onNewGroupChanged,onItemAdded:this.onGroupAdded,onItemRemoved:this.onGroupDeleted,itemsLabel:Object(l.a)("Showing flair for these communities:"),noItemsLabel:Object(l.a)("This room is not showing flair for any communities"),placeholder:Object(l.a)("New community ID (e.g. +foo:%(localDomain)s)",{localDomain:e})}))}}I()(zu,"propTypes",{roomId:xe.a.string.isRequired,canSetRelatedGroups:xe.a.bool.isRequired,relatedGroupsEvent:xe.a.instanceOf(Fe.j)}),I()(zu,"contextType",b.a),I()(zu,"defaultProps",{canSetRelatedGroups:!1});class $u extends i.a.Component{constructor(...e){super(...e),I()(this,"_onClickUserSettings",e=>{e.preventDefault(),e.stopPropagation(),m.a.fire(h.a.ViewUserSettings)})}render(){const e=d.getComponent("elements.SettingsFlag"),t=this.props.room.roomId,s=ee.a.get().isRoomEncrypted(t);let n=null,a=null;if(s)n=Object(l.a)("In encrypted rooms, like this one, URL previews are disabled by default to ensure that your homeserver (where the previews are generated) cannot gather information about links you see in this room.");else{if(n=F.a.getValueAt(Qe.a.ACCOUNT,"urlPreviewsEnabled")?Object(l.a)("You have <a>enabled</a> URL previews by default.",{},{a:e=>i.a.createElement("a",{onClick:this._onClickUserSettings,href:""},e)}):Object(l.a)("You have <a>disabled</a> URL previews by default.",{},{a:e=>i.a.createElement("a",{onClick:this._onClickUserSettings,href:""},e)}),F.a.canSetValue("urlPreviewsEnabled",t,"room"))a=i.a.createElement("label",null,i.a.createElement(e,{name:"urlPreviewsEnabled",level:Qe.a.ROOM,roomId:t,isExplicit:!0}));else{let e=Object(l.b)("URL previews are enabled by default for participants in this room.");F.a.getValueAt(Qe.a.ROOM,"urlPreviewsEnabled",t,!0)||(e=Object(l.b)("URL previews are disabled by default for participants in this room.")),a=i.a.createElement("label",null,Object(l.a)(e))}}const o=i.a.createElement(e,{name:s?"urlPreviewsEnabled_e2ee":"urlPreviewsEnabled",level:Qe.a.ROOM_ACCOUNT,roomId:t});return i.a.createElement("div",null,i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("When someone puts a URL in their message, a URL preview can be shown to give more information about that link such as the title, description, and an image from the website.")),i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},n),a,i.a.createElement("label",null,o))}}I()($u,"propTypes",{room:xe.a.object});var Yu=s(766);function Ju(e,t){const s=Math.min(e.length,t.length);for(let n=0;n<s;++n)if(e[n]!==t[n])return n;return s}function Qu(e,t,s){const n=s-(t.length-e.length);return function(e,t){const s=Math.min(e.length,t.length),n=e.substr(0,s)===t.substr(0,s);if(n&&e.length>t.length)return{removed:e.substr(s),at:s};if(n&&e.length<t.length)return{added:t.substr(s),at:s};{const s=Ju(e,t);return{removed:e.substr(s),added:t.substr(s),at:s}}}(e.substr(0,n),t.substr(0,s))}class Xu{constructor(e,t){this.index=e,this.offset=t}compare(e){return this.index===e.index?this.offset-e.offset:this.index-e.index}iteratePartsBetween(e,t,s){if(-1===this.index||-1===e.index)return;const[n,a]=this.compare(e)<0?[this,e]:[e,this];if(n.index===a.index)s(t.parts[this.index],n.offset,a.offset);else{const e=t.parts[n.index];s(e,n.offset,e.text.length);for(let e=n.index+1;e<a.index;++e){const n=t.parts[e];s(n,0,n.text.length)}s(t.parts[a.index],0,a.offset)}}forwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const{parts:a}=e;for(;s<a.length;){const e=a[s];for(;n<e.text.length;){if(!t(s,n,e))return new Xu(s,n);n+=1}if(s===a.length-1)return new Xu(s,n);s+=1,n=0}}backwardsWhile(e,t){if(-1===this.index)return this;let{index:s,offset:n}=this;const a=e.parts;for(;s>=0;){const e=a[s];for(;n>0;){if(!t(s,n-1,e))return new Xu(s,n);n-=1}if(0===s)return new Xu(s,n);s-=1,n=a[s].text.length}}asOffset(e){if(-1===this.index)return new pl(0,!0);let t=0;for(let s=0;s<this.index;++s)t+=e.parts[s].text.length;t+=this.offset;const s=e.parts[this.index],n=!s||t>=s.text.length;return new pl(t,n)}isAtEnd(e){if(0===e.parts.length)return!0;const t=e.parts.length-1,s=e.parts[t];return this.index===t&&this.offset===s.text.length}isAtStart(){return 0===this.index&&0===this.offset}}class Zu{constructor(e,t,s=null){this.updateCallback=s,I()(this,"_parts",void 0),I()(this,"_partCreator",void 0),I()(this,"activePartIdx",null),I()(this,"_autoComplete",null),I()(this,"autoCompletePartIdx",null),I()(this,"autoCompletePartCount",0),I()(this,"transformCallback",null),I()(this,"onAutoComplete",({replaceParts:e,close:t})=>{let s;if(e){this._parts.splice(this.autoCompletePartIdx,this.autoCompletePartCount,...e),this.autoCompletePartCount=e.length;const t=e[e.length-1],n=this.autoCompletePartIdx+e.length-1;s=new Xu(n,t.text.length)}t&&(this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0),this.updateCallback(s)}),this._parts=e,this._partCreator=t,this.transformCallback=null}setTransformCallback(e){this.transformCallback=e}setUpdateCallback(e){this.updateCallback=e}get partCreator(){return this._partCreator}get isEmpty(){return 0===this._parts.reduce((e,t)=>e+t.text.length,0)}clone(){return new Zu(this._parts,this._partCreator,this.updateCallback)}insertPart(e,t){this._parts.splice(e,0,t),this.activePartIdx>=e&&++this.activePartIdx,this.autoCompletePartIdx>=e&&++this.autoCompletePartIdx}removePart(e){this._parts.splice(e,1),e===this.activePartIdx?this.activePartIdx=null:this.activePartIdx>e&&--this.activePartIdx,e===this.autoCompletePartIdx?this.autoCompletePartIdx=null:this.autoCompletePartIdx>e&&--this.autoCompletePartIdx}replacePart(e,t){this._parts.splice(e,1,t)}get parts(){return this._parts}get autoComplete(){return this.activePartIdx===this.autoCompletePartIdx?this._autoComplete:null}getPositionAtEnd(){if(this._parts.length){const e=this._parts.length-1,t=this._parts[e];return new Xu(e,t.text.length)}return new Xu(-1,0)}serializeParts(){return this._parts.map(e=>e.serialize())}diff(e,t,s){const n=this.parts.reduce((e,t)=>e+t.text,"");return"deleteByDrag"===t?function(e,t){if(e===t)return{};const s=Ju(e,t),n=e.length-t.length;return{at:s,removed:e.substr(s,n)}}(n,e):Qu(n,e,s.offset)}reset(e,t,s){this._parts=e.map(e=>this._partCreator.deserializePart(e)),t||(t=this.getPositionAtEnd()),this._autoComplete&&(this._autoComplete=null,this.autoCompletePartIdx=null),this.updateCallback(t,s)}insert(e,t){const s=this.splitAt(t);let n=0;for(let t=0;t<e.length;++t){const a=e[t];n+=a.text.length,this.insertPart(s+t,a)}return n}update(e,t,s){const n=this.diff(e,t,s),a=this.positionForOffset(n.at,s.atNodeEnd);let i=0;n.removed&&(i=this.removeText(a,n.removed.length));let o=0;n.added&&(o=this.addText(a,n.added,t)),this.mergeAdjacentParts();const r=n.at-i+o;let l=this.positionForOffset(r,!0);const c="insertFromPaste"!==t&&"insertFromDrop"!==t,d=this.setActivePart(l,c);if(this.transformCallback){const e=this.getTransformAddedLen(l,t,n);l=this.positionForOffset(r+e,!0)}return this.updateCallback(l,t,n),d}getTransformAddedLen(e,t,s){const n=this.transformCallback(e,t,s);return Number.isFinite(n)?n:0}setActivePart(e,t){const{index:s}=e,n=this._parts[s];if(n){if(s!==this.activePartIdx&&(this.activePartIdx=s,t&&this.activePartIdx!==this.autoCompletePartIdx)){const e=n.createAutoComplete(this.onAutoComplete);e&&(this._autoComplete=e,this.autoCompletePartIdx=s,this.autoCompletePartCount=1)}if(this.autoComplete)return this.autoComplete.onPartUpdate(n,e)}else this.activePartIdx=null,this._autoComplete=null,this.autoCompletePartIdx=null,this.autoCompletePartCount=0;return Promise.resolve()}mergeAdjacentParts(){let e;for(let t=0;t<this._parts.length;++t){let s=this._parts[t];const n=!s.text.length,a=!n&&e&&e.merge(s);(n||a)&&(s=e,this.removePart(t),--t),e=s}}removeText(e,t){let{index:s,offset:n}=e,a=0;for(;t>0;){let e=this._parts[s];const i=Math.min(t,e.text.length-n);if(i)if(e.canEdit){const t=e.remove(n,i);"string"==typeof t&&this.replacePart(s,this._partCreator.createDefaultPart(t)),e=this._parts[s],e.text.length?s+=1:this.removePart(s)}else a+=n,this.removePart(s);else s+=1;t-=i,n=0}return a}splitAt(e){if(-1===e.index)return 0;if(0===e.offset)return e.index;const t=this._parts[e.index];if(e.offset>=t.text.length)return e.index+1;const s=t.split(e.offset);return this.insertPart(e.index+1,s),e.index+1}addText(e,t,s){let{index:n}=e;const{offset:a}=e;let i=t.length;const o=this._parts[n];if(o)if(o.canEdit)if(o.validateAndInsert(a,t,s))t=null;else{const e=o.split(a);n+=1,this.insertPart(n,e)}else 0!==a&&(i+=o.text.length-a,n+=1);else n<0&&(n=0);for(;t;){const e=this._partCreator.createPartForInput(t,n,s);t=e.appendUntilRejected(t,s),this.insertPart(n,e),n+=1}return i}positionForOffset(e,t){let s=0;const n=this._parts.findIndex(n=>{const a=n.text.length;return!!(t&&s+a>=e||!t&&s+a>e)||(s+=a,!1)});return-1===n?this.getPositionAtEnd():new Xu(n,e-s)}startRange(e,t=e){return new al(this,e,t)}replaceRange(e,t,s){const n=t.asOffset(this),a=this.splitAt(e);t=n.asPosition(this);for(let e=this.splitAt(t)-1;e>=a;--e)this.removePart(e);let i=a;for(const e of s)this.insertPart(i,e),i+=1;this.mergeAdjacentParts()}transform(e){const t=e();let s=null;return s=t instanceof al?Promise.resolve():this.setActivePart(t,!0),this.updateCallback(t),s}}var ep=s(410),tp=s(412),sp=s.n(tp);function np(e,{forceHTML:t=!1}={}){let s=function(e){return e.parts.reduce((e,t)=>{switch(t.type){case"newline":return e+"\n";case"plain":case"command":case"pill-candidate":case"at-room-pill":return e+t.text;case"room-pill":case"user-pill":return e+`[${t.text.replace(/[[\\\]]/g,e=>"\\"+e)}](${Object(ur.d)(t.resourceId)})`}},"")}(e);if(F.a.getValue("feature_latex_maths")){const e=(c.a.get().latex_maths_delims||{}).display_pattern||"\\$\\$(([^$]|\\\\\\$)*)\\$\\$",t=(c.a.get().latex_maths_delims||{}).inline_pattern||"\\$(([^$]|\\\\\\$)*)\\$";s=s.replace(RegExp(e,"gm"),(function(e,t){return`<div data-mx-maths="${ep.AllHtmlEntities.encode(t)}">\n\n</div>\n\n`})),s=s.replace(RegExp(t,"gm"),(function(e,t){return`<span data-mx-maths="${ep.AllHtmlEntities.encode(t)}"></span>`})),s=s.replace(/(.)<div/g,(function(e,t){return t+"\n<div"}))}const n=new Im(s);if(!n.isPlainText()||t){const e=sp.a.load(n.toHTML(),{_useHtmlParser2:!0,decodeEntities:!1});return e("div, span").each((function(t,s){const n=e(s).attr("data-mx-maths");n&&e(s).html(`<code>${n}</code>`)})),e.html()}return s.indexOf("\\")>-1||s.indexOf("\\")>-1?n.toPlaintext():void 0}function ap(e){return e.parts.reduce((e,t)=>{switch(t.type){case"newline":return e+"\n";case"plain":case"command":case"pill-candidate":case"at-room-pill":return e+t.text;case"room-pill":case"user-pill":return e+""+t.text}},"")}function ip(e){return op(e,"/me ",!1)}function op(e,t,s=!0){const n=e.parts[0];let a=n&&n.text;return s||(t=t.toLowerCase(),a=a.toLowerCase()),n&&("plain"===n.type||"command"===n.type)&&a.startsWith(t)}function rp(e){return lp(e,"/me ")}function lp(e,t){return(e=e.clone()).removeText({index:0,offset:0},t.length),e}var cp=s(702);function dp(e,t){const s=ip(e);s&&(e=rp(e));const n=function(e){const t=e.getContent()["m.relates_to"];return!(!t||!t["m.in_reply_to"])}(t);let a="",i="";n&&(a=function(e){const t=e.getContent().body.split("\n").map(e=>e.trim());return t.length>2&&t[0].startsWith("> ")&&0===t[1].length?t[0]+"\n\n":""}(t),i=function(e){const t=e.getContent().formatted_body;if(!t)return"";const s=(new DOMParser).parseFromString(t,"text/html").body.querySelector("mx-reply");return s&&s.outerHTML||""}(t));const o=ap(e),r={msgtype:s?"m.emote":"m.text",body:o},l={msgtype:r.msgtype,body:`${a} * ${o}`},c=np(e,{forceHTML:n});return c&&(r.format="org.matrix.custom.html",r.formatted_body=c,l.format=r.format,l.formatted_body=`${i} * ${c}`),Object.assign({"m.new_content":r,"m.relates_to":{rel_type:"m.replace",event_id:t.getId()}},l)}class mp extends i.a.Component{constructor(e,t){super(e,t),I()(this,"_setEditorRef",e=>{this._editorRef=e}),I()(this,"_onKeyDown",e=>{if(this._editorRef.isComposing(e))return;if(e.metaKey||e.altKey||e.shiftKey)return;if(!!F.a.getValue("MessageComposerInput.ctrlEnterToSend")?e.key===_s.a.ENTER&&Object(_s.d)(e):e.key===_s.a.ENTER)this._sendEdit(),e.preventDefault();else if(e.key===_s.a.ESCAPE)this._cancelEdit();else if(e.key===_s.a.ARROW_UP){if(this._editorRef.isModified()||!this._editorRef.isCaretAtStart())return;const t=Md(this._getRoom(),!1,this.props.editState.getEvent().getId());t&&(m.a.dispatch({action:"edit_event",event:t}),e.preventDefault())}else if(e.key===_s.a.ARROW_DOWN){if(this._editorRef.isModified()||!this._editorRef.isCaretAtEnd())return;const t=Md(this._getRoom(),!0,this.props.editState.getEvent().getId());t?m.a.dispatch({action:"edit_event",event:t}):(m.a.dispatch({action:"edit_event",event:null}),m.a.fire(h.a.FocusComposer)),e.preventDefault()}}),I()(this,"_cancelEdit",()=>{m.a.dispatch({action:"edit_event",event:null}),m.a.fire(h.a.FocusComposer)}),I()(this,"_sendEdit",()=>{const e=y.a.getTimestamp(),t=this.props.editState.getEvent(),s=dp(this.model,t),n=s["m.new_content"];if(this._isContentModified(n)){const n=t.getRoomId();this._cancelPreviousPendingEdit();const a=this.context.sendMessage(n,s);m.a.dispatch({action:"message_sent"}),y.a.instance.trackSendMessage(e,a,n,!0,!1,s)}m.a.dispatch({action:"edit_event",event:null}),m.a.fire(h.a.FocusComposer)}),I()(this,"_onChange",()=>{this.state.saveDisabled&&this._editorRef&&this._editorRef.isModified()&&this.setState({saveDisabled:!1})}),this.model=null,this._editorRef=null,this.state={saveDisabled:!0},this._createEditorModel()}_getRoom(){return this.context.getRoom(this.props.editState.getEvent().getRoomId())}_isContentModified(e){const t=this.props.editState.getEvent().getContent();return!(!this._editorRef.isModified()||t.msgtype===e.msgtype&&t.body===e.body&&t.format===e.format&&t.formatted_body===e.formatted_body)}_cancelPreviousPendingEdit(){const e=this.props.editState.getEvent().replacingEvent();!e||e.status!==Fe.b.QUEUED&&e.status!==Fe.b.NOT_SENT||this.context.cancelPendingEvent(e)}componentWillUnmount(){const e=document.getSelection();let t;e.focusNode&&(t=fl(this._editorRef,e).caret);const s=this.model.serializeParts();this.props.editState.setEditorState(t,s)}_createEditorModel(){const{editState:e}=this.props,t=this._getRoom(),s=new Tl(t,this.context);let n;n=e.hasEditorState()?e.getSerializedParts().map(e=>s.deserializePart(e)):Ll(e.getEvent(),s),this.model=new Zu(n,s)}_getInitialCaretPosition(){const{editState:e}=this.props;let t;if(e.hasEditorState()&&e.getCaret()){const s=e.getCaret();t=this.model.positionForOffset(s.offset,s.atNodeEnd)}else t=this.model.getPositionAtEnd();return t}render(){const e=d.getComponent("elements.AccessibleButton");return i.a.createElement("div",{className:L()("mx_EditMessageComposer",this.props.className),onKeyDown:this._onKeyDown},i.a.createElement(zl,{ref:this._setEditorRef,model:this.model,room:this._getRoom(),initialCaret:this.props.editState.getCaret(),label:Object(l.a)("Edit message"),onChange:this._onChange}),i.a.createElement("div",{className:"mx_EditMessageComposer_buttons"},i.a.createElement(e,{kind:"secondary",onClick:this._cancelEdit},Object(l.a)("Cancel")),i.a.createElement(e,{kind:"primary",onClick:this._sendEdit,disabled:this.state.saveDisabled},Object(l.a)("Save"))))}}I()(mp,"propTypes",{editState:xe.a.instanceOf(cp.a).isRequired}),I()(mp,"contextType",b.a);const hp={offline:"mx_EntityTile_offline",online:"mx_EntityTile_online",unavailable:"mx_EntityTile_unavailable"};class up extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{hover:!1})}shouldComponentUpdate(e,t){return this.state.hover!==t.hover||this.props.shouldComponentUpdate(e,t)}render(){const e={mx_EntityTile:!0,mx_EntityTile_noHover:this.props.suppressOnHover};this.props.className&&(e[this.props.className]=!0);var t,n;let a;e[(t=this.props.presenceState,n=this.props.presenceLastActiveAgo,!1===this.props.showPresence?"mx_EntityTile_online_beenactive":"offline"==t?n?hp.offline+"_beenactive":hp.offline+"_neveractive":t?hp[t]:hp.offline+"_neveractive")]=!0;const{name:o}=this.props;if(this.props.suppressOnHover)a=this.props.subtextLabel?i.a.createElement("div",{className:"mx_EntityTile_details"},i.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},o),i.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)):i.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},o);else{const e=this.props.presenceLastActiveAgo?Date.now()-(this.props.presenceLastTs-this.props.presenceLastActiveAgo):-1,t=d.getComponent("rooms.PresenceLabel");let s=null;this.props.showPresence&&(s=i.a.createElement(t,{activeAgo:e,currentlyActive:this.props.presenceCurrentlyActive,presenceState:this.props.presenceState})),this.props.subtextLabel&&(s=i.a.createElement("span",{className:"mx_EntityTile_subtext"},this.props.subtextLabel)),a=i.a.createElement("div",{className:"mx_EntityTile_details"},i.a.createElement("div",{className:"mx_EntityTile_name",dir:"auto"},o),s)}let r,c;this.props.showInviteButton&&(r=i.a.createElement("div",{className:"mx_EntityTile_invite"},i.a.createElement("img",{src:s(1479),width:"16",height:"16"})));const m=this.props.powerStatus;if(m){const e={[up.POWER_STATUS_MODERATOR]:Object(l.a)("Mod"),[up.POWER_STATUS_ADMIN]:Object(l.a)("Admin")}[m];c=i.a.createElement("div",{className:"mx_EntityTile_power"},e)}let h;const{e2eStatus:u}=this.props;u&&(h=i.a.createElement(po.b,{status:u,isUser:!0,bordered:!0}));const p=d.getComponent("avatars.BaseAvatar"),g=this.props.avatarJsx||i.a.createElement(p,{name:this.props.name,width:36,height:36,"aria-hidden":"true"});return i.a.createElement("div",{ref:e=>this.container=e},i.a.createElement(pe.a,{className:L()(e),title:this.props.title,onClick:this.props.onClick},i.a.createElement("div",{className:"mx_EntityTile_avatar"},g),a,c,r))}}I()(up,"propTypes",{name:xe.a.string,title:xe.a.string,avatarJsx:xe.a.any,className:xe.a.string,presenceState:xe.a.string,presenceLastActiveAgo:xe.a.number,presenceLastTs:xe.a.number,presenceCurrentlyActive:xe.a.bool,showInviteButton:xe.a.bool,shouldComponentUpdate:xe.a.func,onClick:xe.a.func,suppressOnHover:xe.a.bool,showPresence:xe.a.bool,subtextLabel:xe.a.string,e2eStatus:xe.a.string}),I()(up,"defaultProps",{shouldComponentUpdate:function(e,t){return!0},onClick:function(){},presenceState:"offline",presenceLastActiveAgo:0,presenceLastTs:0,showInviteButton:!1,suppressOnHover:!1,showPresence:!1}),up.POWER_STATUS_MODERATOR="moderator",up.POWER_STATUS_ADMIN="admin";var pp=up,gp=s(739),fp=e=>{const t=L()({mx_JumpToBottomButton:!0,mx_JumpToBottomButton_highlight:e.highlight});let s;return e.numUnreadMessages&&(s=React.createElement("div",{className:"mx_JumpToBottomButton_badge"},e.numUnreadMessages)),React.createElement("div",{className:t},React.createElement(pe.a,{className:"mx_JumpToBottomButton_scrollDown",title:Object(l.a)("Scroll to most recent messages"),onClick:e.onScrollToBottomClick}),s)};class bp extends i.a.Component{constructor(e){super(e),I()(this,"onImageClick",e=>{const t=this.state.preview;if(0!=e.button||e.metaKey)return;e.preventDefault();const s=d.getComponent("elements.ImageView");let n=t["og:image"];n&&n.startsWith("mxc://")&&(n=ee.a.get().mxcUrlToHttp(n));const a={src:n,width:t["og:image:width"],height:t["og:image:height"],name:t["og:title"]||t["og:description"]||this.props.link,fileSize:t["matrix:image:size"],link:this.props.link};De.a.createDialog(s,a,"mx_Dialog_lightbox")}),this.state={preview:null},this.unmounted=!1,ee.a.get().getUrlPreview(this.props.link,this.props.mxEvent.getTs()).then(e=>{this.unmounted||this.setState({preview:e},this.props.onHeightChanged)},e=>{console.error("Failed to get URL preview: "+e)}),this._description=Object(a.createRef)()}componentDidMount(){this._description.current&&Object(rr.f)(this._description.current)}componentDidUpdate(){this._description.current&&Object(rr.f)(this._description.current)}componentWillUnmount(){this.unmounted=!0}render(){const e=this.state.preview;if(!e||0===Object.keys(e).length)return i.a.createElement("div",null);let t=e["og:image"];F.a.getValue("showImages")||(t=null);t&&t.startsWith("mxc://")&&(t=ee.a.get().mxcUrlToHttp(t,100,100));let n,a=100;e["og:image:width"]&&e["og:image:height"]&&(a=function(e,t,s,n){if(!e||!t)return null;if(e<s&&t<n)return t;const a=s/e,i=n/t;return a<i?Math.floor(a*t):Math.floor(i*t)}(e["og:image:width"],e["og:image:height"],100,100)),t&&(n=i.a.createElement("div",{className:"mx_LinkPreviewWidget_image",style:{height:a}},i.a.createElement("img",{style:{maxWidth:100,maxHeight:100},src:t,onClick:this.onImageClick})));const o=ep.AllHtmlEntities.decode(e["og:description"]||""),r=d.getComponent("elements.AccessibleButton");return i.a.createElement("div",{className:"mx_LinkPreviewWidget"},n,i.a.createElement("div",{className:"mx_LinkPreviewWidget_caption"},i.a.createElement("div",{className:"mx_LinkPreviewWidget_title"},i.a.createElement("a",{href:this.props.link,target:"_blank",rel:"noreferrer noopener"},e["og:title"])),i.a.createElement("div",{className:"mx_LinkPreviewWidget_siteName"},e["og:site_name"]?" - "+e["og:site_name"]:null),i.a.createElement("div",{className:"mx_LinkPreviewWidget_description",ref:this._description},o)),i.a.createElement(r,{className:"mx_LinkPreviewWidget_cancel",onClick:this.props.onCancelClick,"aria-label":Object(l.a)("Close preview")},i.a.createElement("img",{className:"mx_filterFlipColor",alt:"",role:"presentation",src:s(222),width:"18",height:"18"})))}}I()(bp,"propTypes",{link:xe.a.string.isRequired,mxEvent:xe.a.object.isRequired,onCancelClick:xe.a.func,onHeightChanged:xe.a.func});var vp=s(254);const _p=/[\x21-\x2F\x3A-\x40\x5B-\x60\x7B-\x7E]+/g;class yp extends i.a.Component{constructor(e){super(e),I()(this,"onUserPresenceChange",(e,t)=>{this.refs[t.userId]&&this._updateList()}),I()(this,"onRoom",e=>{e.roomId===this.props.roomId&&this._showMembersAccordingToMembershipWithLL()}),I()(this,"onMyMembership",(e,t,s)=>{e.roomId===this.props.roomId&&"join"===t&&this._showMembersAccordingToMembershipWithLL()}),I()(this,"onRoomStateMember",(e,t,s)=>{s.roomId===this.props.roomId&&this._updateList()}),I()(this,"onRoomMemberName",(e,t)=>{t.roomId===this.props.roomId&&this._updateList()}),I()(this,"onRoomStateEvent",(e,t)=>{e.getRoomId()===this.props.roomId&&"m.room.third_party_invite"===e.getType()&&this._updateList()}),I()(this,"_updateList",Object(vp.a)(()=>{this._updateListNow()},500)),I()(this,"_createOverflowTileJoined",(e,t)=>this._createOverflowTile(e,t,this._showMoreJoinedMemberList)),I()(this,"_createOverflowTileInvited",(e,t)=>this._createOverflowTile(e,t,this._showMoreInvitedMemberList)),I()(this,"_createOverflowTile",(e,t,n)=>{const a=d.getComponent("rooms.EntityTile"),o=d.getComponent("avatars.BaseAvatar"),r=Object(l.a)("and %(count)s others...",{count:e});return i.a.createElement(a,{className:"mx_EntityTile_ellipsis",avatarJsx:i.a.createElement(o,{url:s(487),name:"...",width:36,height:36}),name:r,presenceState:"online",suppressOnHover:!0,onClick:n})}),I()(this,"_showMoreJoinedMemberList",()=>{this.setState({truncateAtJoined:this.state.truncateAtJoined+100})}),I()(this,"_showMoreInvitedMemberList",()=>{this.setState({truncateAtInvited:this.state.truncateAtInvited+100})}),I()(this,"memberSort",(e,t)=>{const s=e.user,n=t.user;if(!s&&!n)return 0;if(s&&!n)return-1;if(!s&&n)return 1;if(this._showPresence){const e=e=>"unavailable"===e?"online":e,t=t=>{const s=["active","online","offline"],n=s.indexOf(e(t));return-1===n?s.length:n},a=t(s.currentlyActive?"active":s.presence),i=t(n.currentlyActive?"active":n.presence);if(a!==i)return a-i}if(e.powerLevel!==t.powerLevel)return t.powerLevel-e.powerLevel;if(this._showPresence&&s.getLastActiveTs()!==n.getLastActiveTs())return n.getLastActiveTs()-s.getLastActiveTs();const a=("@"===e.name[0]?e.name.substr(1):e.name).replace(_p,""),i=("@"===t.name[0]?t.name.substr(1):t.name).replace(_p,"");return a.localeCompare(i,{ignorePunctuation:!0,sensitivity:"base"})}),I()(this,"onSearchQueryChanged",e=>{this.setState({searchQuery:e,filteredJoinedMembers:this._filterMembers(this.state.members,"join",e),filteredInvitedMembers:this._filterMembers(this.state.members,"invite",e)})}),I()(this,"_onPending3pidInviteClick",e=>{m.a.dispatch({action:"view_3pid_invite",event:e})}),I()(this,"_getChildrenJoined",(e,t)=>this._makeMemberTiles(this.state.filteredJoinedMembers.slice(e,t))),I()(this,"_getChildCountJoined",()=>this.state.filteredJoinedMembers.length),I()(this,"_getChildrenInvited",(e,t)=>{let s=this.state.filteredInvitedMembers;return t>this.state.filteredInvitedMembers.length&&(s=s.concat(this._getPending3PidInvites())),this._makeMemberTiles(s.slice(e,t))}),I()(this,"_getChildCountInvited",()=>this.state.filteredInvitedMembers.length+(this._getPending3PidInvites()||[]).length),I()(this,"onInviteButtonClick",()=>{ee.a.get().isGuest()?m.a.dispatch({action:"require_registration"}):m.a.dispatch({action:"view_invite",roomId:this.props.roomId})});const t=ee.a.get();t.hasLazyLoadMembersEnabled()?this.state=this._getMembersState([]):this.state=this._getMembersState(this.roomMembers()),t.on("Room",this.onRoom);const n=c.a.get().enable_presence_by_hs_url,a=ee.a.get().baseUrl;this._showPresence=!1,n&&void 0!==n[a]&&(this._showPresence=n[a])}UNSAFE_componentWillMount(){const e=ee.a.get();this._mounted=!0,e.hasLazyLoadMembersEnabled()?(this._showMembersAccordingToMembershipWithLL(),e.on("Room.myMembership",this.onMyMembership)):this._listenForMembersChanges()}_listenForMembersChanges(){const e=ee.a.get();e.on("RoomState.members",this.onRoomStateMember),e.on("RoomMember.name",this.onRoomMemberName),e.on("RoomState.events",this.onRoomStateEvent),e.on("User.lastPresenceTs",this.onUserPresenceChange),e.on("User.presence",this.onUserPresenceChange),e.on("User.currentlyActive",this.onUserPresenceChange)}componentWillUnmount(){this._mounted=!1;const e=ee.a.get();e&&(e.removeListener("RoomState.members",this.onRoomStateMember),e.removeListener("RoomMember.name",this.onRoomMemberName),e.removeListener("Room.myMembership",this.onMyMembership),e.removeListener("RoomState.events",this.onRoomStateEvent),e.removeListener("Room",this.onRoom),e.removeListener("User.lastPresenceTs",this.onUserPresenceChange),e.removeListener("User.presence",this.onUserPresenceChange),e.removeListener("User.currentlyActive",this.onUserPresenceChange)),this._updateList.cancelPendingCall()}async _showMembersAccordingToMembershipWithLL(){if(ee.a.get().hasLazyLoadMembersEnabled()){const e=ee.a.get().getRoom(this.props.roomId);if("join"===(e&&e.getMyMembership())){this.setState({loading:!0});try{await e.loadMembersIfNeeded()}catch(e){}this._mounted&&(this.setState(this._getMembersState(this.roomMembers())),this._listenForMembersChanges())}else this.setState(this._getMembersState(this.roomMembers()))}}_getMembersState(e){return{loading:!1,members:e,filteredJoinedMembers:this._filterMembers(e,"join"),filteredInvitedMembers:this._filterMembers(e,"invite"),truncateAtJoined:30,truncateAtInvited:5,searchQuery:""}}_updateListNow(){const e={loading:!1,members:this.roomMembers()};e.filteredJoinedMembers=this._filterMembers(e.members,"join",this.state.searchQuery),e.filteredInvitedMembers=this._filterMembers(e.members,"invite",this.state.searchQuery),this.setState(e)}getMembersWithUser(){if(!this.props.roomId)return[];const e=ee.a.get(),t=e.getRoom(this.props.roomId);if(!t)return[];const s=Object.values(t.currentState.members);return s.forEach((function(t){null===t.user&&(t.user=e.getUser(t.userId))})),s}roomMembers(){const e=this.getMembersWithUser().filter(e=>"join"===e.membership||"invite"===e.membership);return e.sort(this.memberSort),e}memberString(e){if(e){const t=e.user;return"("+e.name+", "+e.powerLevel+", "+(t?t.lastActiveAgo:"<null>")+", "+(t?t.getLastActiveTs():"<null>")+", "+(t?t.currentlyActive:"<null>")+", "+(t?t.presence:"<null>")+")"}return"(null)"}_filterMembers(e,t,s){return e.filter(e=>{if(s){s=s.toLowerCase();const t=-1!==e.name.toLowerCase().indexOf(s),n=-1!==e.userId.toLowerCase().indexOf(s);if(!t&&!n)return!1}return e.membership===t})}_getPending3PidInvites(){const e=ee.a.get().getRoom(this.props.roomId);if(e)return e.currentState.getStateEvents("m.room.third_party_invite").filter((function(t){if(!Object(rs.c)(t))return!1;return!e.currentState.getInviteForThreePidToken(t.getStateKey())}))}_makeMemberTiles(e){const t=d.getComponent("rooms.MemberTile"),s=d.getComponent("rooms.EntityTile");return e.map(e=>e.userId?i.a.createElement(t,{key:e.userId,member:e,ref:e.userId,showPresence:this._showPresence}):i.a.createElement(s,{key:e.getStateKey(),name:e.getContent().display_name,suppressOnHover:!0,onClick:()=>this._onPending3pidInviteClick(e)}))}render(){if(this.state.loading){const e=d.getComponent("elements.Spinner");return i.a.createElement(no.b,{className:"mx_MemberList",onClose:this.props.onClose,previousPhase:ls.b.RoomSummary},i.a.createElement(e,null))}const e=d.getComponent("structures.SearchBox"),t=d.getComponent("elements.TruncatedList"),s=ee.a.get(),n=s.getRoom(this.props.roomId);let a,o,r;if(n&&"join"===n.getMyMembership()){let e=!0;const t=n.currentState.getStateEvents("m.room.power_levels",""),o=n.getMember(s.getUserId());if(t&&o){const s=t.getContent();s&&s.invite>o.powerLevel&&(e=!1)}E.a.isCurrentUserExtern()&&(e=!1);let r=Object(l.a)("Invite to this room");const c=ge.a.instance.getSelectedCommunityGeneralChat();c&&c.roomId===this.props.roomId&&(r=Object(l.a)("Invite to this community"));const m=d.getComponent("elements.AccessibleButton"),h=new qn.a(ee.a.get());Boolean(h.getUserIdForRoomId(n.roomId))||(a=i.a.createElement(m,{className:"mx_MemberList_invite",onClick:this.onInviteButtonClick,disabled:!e},i.a.createElement("span",null,r)))}this._getChildCountInvited()>0&&(o=i.a.createElement("h2",null,Object(l.a)("Invited")),r=i.a.createElement(t,{className:"mx_MemberList_section mx_MemberList_invited",truncateAt:this.state.truncateAtInvited,createOverflowElement:this._createOverflowTileInvited,getChildren:this._getChildrenInvited,getChildCount:this._getChildCountInvited}));const c=i.a.createElement(e,{className:"mx_MemberList_query mx_textinput_icon mx_textinput_search",placeholder:Object(l.a)("Filter room members"),onSearch:this.onSearchQueryChanged});return i.a.createElement(no.b,{className:"mx_MemberList",header:a,footer:c,onClose:this.props.onClose,previousPhase:ls.b.RoomSummary},i.a.createElement("div",{className:"mx_MemberList_wrapper"},i.a.createElement(t,{className:"mx_MemberList_section mx_MemberList_joined",truncateAt:this.state.truncateAtJoined,createOverflowElement:this._createOverflowTileJoined,getChildren:this._getChildrenJoined,getChildCount:this._getChildCountJoined}),o,r))}}class Ep extends i.a.Component{constructor(e){super(e),I()(this,"onRoomStateEvents",e=>{if("m.room.encryption"!==e.getType())return;const{roomId:t}=this.props.member;if(e.getRoomId()!==t)return;ee.a.get().removeListener("RoomState.events",this.onRoomStateEvents),this.setState({isRoomEncrypted:!0}),this.updateE2EStatus()}),I()(this,"onUserTrustStatusChanged",(e,t)=>{e===this.props.member.userId&&this.updateE2EStatus()}),I()(this,"onDeviceVerificationChanged",(e,t,s)=>{e===this.props.member.userId&&this.updateE2EStatus()}),I()(this,"_onStatusMessageCommitted",()=>{this.setState({statusMessage:this.getStatusMessage()})}),I()(this,"onClick",e=>{m.a.dispatch({action:h.a.ViewUser,member:this.props.member})}),this.state={statusMessage:this.getStatusMessage(),isRoomEncrypted:!1,e2eStatus:null,userExpired:!1}}componentDidMount(){const e=ee.a.get();if(F.a.getValue("feature_custom_status")){const{user:e}=this.props.member;e&&e.on("User._unstable_statusMessage",this._onStatusMessageCommitted)}const{roomId:t}=this.props.member;if(t){const s=e.isRoomEncrypted(t);this.setState({isRoomEncrypted:s}),s?(e.on("userTrustStatusChanged",this.onUserTrustStatusChanged),e.on("deviceVerificationChanged",this.onDeviceVerificationChanged),this.updateE2EStatus()):e.on("RoomState.events",this.onRoomStateEvents)}}componentWillUnmount(){const e=ee.a.get(),{user:t}=this.props.member;t&&t.removeListener("User._unstable_statusMessage",this._onStatusMessageCommitted),e&&(e.removeListener("RoomState.events",this.onRoomStateEvents),e.removeListener("userTrustStatusChanged",this.onUserTrustStatusChanged),e.removeListener("deviceVerificationChanged",this.onDeviceVerificationChanged))}async updateE2EStatus(){const e=ee.a.get(),{userId:t}=this.props.member,s=t===e.getUserId(),n=e.checkUserTrust(t);if(!n.isCrossSigningVerified())return void this.setState({e2eStatus:n.wasCrossSigningVerified()?"warning":"normal"});const a=e.getStoredDevicesForUser(t).some(n=>{const{deviceId:a}=n,i=e.checkDeviceTrust(t,a);return s?!i.isCrossSigningVerified():!i.isVerified()});this.setState({e2eStatus:a?"warning":"verified"})}getStatusMessage(){const{user:e}=this.props.member;return e?e._unstable_statusMessage:""}shouldComponentUpdate(e,t){return void 0===this.member_last_modified_time||this.member_last_modified_time<e.member.getLastModifiedTime()||(!(!e.member.user||!(void 0===this.user_last_modified_time||this.user_last_modified_time<e.member.user.getLastModifiedTime()))||(t.isRoomEncrypted!==this.state.isRoomEncrypted||t.e2eStatus!==this.state.e2eStatus))}_getDisplayName(){return this.props.member.name}getPowerLabel(){return Object(l.a)("%(userName)s (power %(powerLevelNumber)s)",{userName:this.props.member.rawDisplayName,powerLevelNumber:this.props.member.powerLevel})}_getExpired(){E.a.isUserExpired(this.props.member.userId).then(e=>{!0===e&&this.setState({userExpired:e})})}render(){const e=d.getComponent("avatars.MemberAvatar"),t=d.getComponent("rooms.EntityTile"),s=this.props.member,n=this._getDisplayName(),a=s.user?s.user.presence:null;this._getExpired();let o=null;s.user&&F.a.getValue("feature_custom_status")&&(o=this.state.statusMessage);const r=i.a.createElement(e,{title:this.props.member.rawDisplayName,member:s,width:36,height:36,"aria-hidden":"true"});s.user&&(this.user_last_modified_time=s.user.getLastModifiedTime()),this.member_last_modified_time=s.getLastModifiedTime();const l=new Map([[100,t.POWER_STATUS_ADMIN],[50,t.POWER_STATUS_MODERATOR]]);let c=this.props.member.powerLevel;for(const[e]of l)if(this.props.member.powerLevel>=e){c=e;break}const m=l.get(c);let h;return this.state.isRoomEncrypted&&(h=this.state.e2eStatus),i.a.createElement(t,se()({},this.props,{presenceState:a,presenceLastActiveAgo:s.user?s.user.lastActiveAgo:0,presenceLastTs:s.user?s.user.lastPresenceTs:0,presenceCurrentlyActive:!!s.user&&s.user.currentlyActive,avatarJsx:r,title:this.getPowerLabel(),name:n,powerStatus:m,showPresence:this.props.showPresence,subtextLabel:o,userExpired:this.state.userExpired,e2eStatus:h,onClick:this.onClick}))}}I()(Ep,"propTypes",{member:xe.a.any.isRequired,showPresence:xe.a.bool}),I()(Ep,"defaultProps",{showPresence:!0});var Cp=s(164),wp=s(260);class Sp extends i.a.Component{constructor(e){super(e),this._onShowStickersClick=this._onShowStickersClick.bind(this),this._onHideStickersClick=this._onHideStickersClick.bind(this),this._launchManageIntegrations=this._launchManageIntegrations.bind(this),this._removeStickerpickerWidgets=this._removeStickerpickerWidgets.bind(this),this._updateWidget=this._updateWidget.bind(this),this._onWidgetAction=this._onWidgetAction.bind(this),this._onResize=this._onResize.bind(this),this._onFinished=this._onFinished.bind(this),this.popoverWidth=300,this.popoverHeight=300,this.scalarClient=null,this.state={showStickers:!1,imError:null,stickerpickerX:null,stickerpickerY:null,stickerpickerWidget:null,widgetId:null}}_acquireScalarClient(){return this.scalarClient?Promise.resolve(this.scalarClient):Cp.a.sharedInstance().hasManager()?(this.scalarClient=Cp.a.sharedInstance().getPrimaryManager().getScalarClient(),this.scalarClient.connect().then(()=>(this.forceUpdate(),this.scalarClient)).catch(e=>{this._imError(Object(l.b)("Failed to connect to integration manager"),e)})):void Cp.a.sharedInstance().openNoManagerDialog()}async _removeStickerpickerWidgets(){const e=await this._acquireScalarClient();console.log("Removing Stickerpicker widgets"),this.state.widgetId?e?e.disableWidgetAssets(pr.a.STICKERPICKER,this.state.widgetId).then(()=>{console.log("Assets disabled")}).catch(e=>{console.error("Failed to disable assets")}):console.error("Cannot disable assets: no scalar client"):console.warn("No widget ID specified, not disabling assets"),this.setState({showStickers:!1}),Os.a.removeStickerpickerWidgets().then(()=>{this.forceUpdate()}).catch(e=>{console.error("Failed to remove sticker picker widget",e)})}componentDidMount(){window.addEventListener("resize",this._onResize),this.dispatcherRef=m.a.register(this._onWidgetAction),ee.a.get().on("accountData",this._updateWidget),this._updateWidget()}componentWillUnmount(){const e=ee.a.get();e&&e.removeListener("accountData",this._updateWidget),window.removeEventListener("resize",this._onResize),this.dispatcherRef&&m.a.unregister(this.dispatcherRef)}componentDidUpdate(e,t){this._sendVisibilityToWidget(this.state.showStickers)}_imError(e,t){console.error(e,t),this.setState({showStickers:!1,imError:Object(l.a)(e)})}_updateWidget(){const e=Os.a.getStickerpickerWidgets()[0];if(!e)return Sp.currentWidget=null,void this.setState({stickerpickerWidget:null,widgetId:null});const t=Sp.currentWidget;let s=null;t&&t.content&&t.content.url&&(s=t.content.url);let n=null;e&&e.content&&e.content.url&&(n=e.content.url),n!==s&&_n.a.destroyElement("stickerPicker"),Sp.currentWidget=e,this.setState({stickerpickerWidget:e,widgetId:e?e.id:null})}_onWidgetAction(e){switch(e.action){case"user_widget_updated":this.forceUpdate();break;case"stickerpicker_close":this.setState({showStickers:!1});break;case h.a.AfterRightPanelPhaseChange:case"show_left_panel":case"hide_left_panel":this.setState({showStickers:!1})}}_defaultStickerpickerContent(){return i.a.createElement(pe.a,{onClick:this._launchManageIntegrations,className:"mx_Stickers_contentPlaceholder"},i.a.createElement("p",null,Object(l.a)("You don't currently have any stickerpacks enabled")),i.a.createElement("p",{className:"mx_Stickers_addLink"},Object(l.a)("Add some now")),i.a.createElement("img",{src:s(1480),alt:""}))}_errorStickerpickerContent(){return i.a.createElement("div",{style:{"text-align":"center"},className:"error"},i.a.createElement("p",null," ",this.state.imError," "))}_sendVisibilityToWidget(e){if(!this.state.stickerpickerWidget)return;const t=wp.a.instance.getMessagingForId(this.state.stickerpickerWidget.id);t&&e!==this._prevSentVisibility&&(t.updateVisibility(e).catch(e=>{console.error("Error updating widget visibility: ",e)}),this._prevSentVisibility=e)}_getStickerpickerContent(){if(this.state._imError)return this._errorStickerpickerContent();const e=this.state.stickerpickerWidget;let t;const s=d.getComponent("elements.PersistedElement");if(e&&e.content&&e.content.url){e.content.name=e.name||Object(l.a)("Stickerpack");const n={id:e.id,url:e.content.url,name:e.content.name,type:e.content.type,data:e.content.data};t=i.a.createElement("div",{className:"mx_Stickers_content_container"},i.a.createElement("div",{id:"stickersContent",className:"mx_Stickers_content",style:{border:"none",height:this.popoverHeight,width:this.popoverWidth}},i.a.createElement(s,{persistKey:"stickerPicker",zIndex:3500},i.a.createElement(Is.a,{app:n,room:this.props.room,fullWidth:!0,userId:ee.a.get().credentials.userId,creatorUserId:e.sender||ee.a.get().credentials.userId,waitForIframeLoad:!0,showMenubar:!0,onEditClick:this._launchManageIntegrations,onDeleteClick:this._removeStickerpickerWidgets,showTitle:!1,showCancel:!1,showPopout:!1,onMinimiseClick:this._onHideStickersClick,handleMinimisePointerEvents:!0,userWidget:!0}))))}else t=this._defaultStickerpickerContent();return t}_onShowStickersClick(e){if(!F.a.getValue("integrationProvisioning"))return Cp.a.sharedInstance().showDisabledDialog();const t=e.target.getBoundingClientRect();let s=t.right+window.pageXOffset-41;s=Math.min(s,document.body.clientWidth-312);const n=Math.max(10,2+window.pageXOffset+t.left-s),a=t.top+t.height/2+window.pageYOffset-19;this.setState({showStickers:!0,stickerPickerX:s,stickerPickerY:a,stickerPickerChevronOffset:n})}_onHideStickersClick(e){this.setState({showStickers:!1})}_onResize(){this.setState({showStickers:!1})}_onFinished(){this.setState({showStickers:!1})}_launchManageIntegrations(){F.a.getValue("feature_many_integration_managers")?Cp.a.sharedInstance().openAll(this.props.room,"type_"+pr.a.STICKERPICKER.preferred,this.state.widgetId):Cp.a.sharedInstance().getPrimaryManager().open(this.props.room,"type_"+pr.a.STICKERPICKER.preferred,this.state.widgetId)}render(){let e,t;const s=L()("mx_MessageComposer_button","mx_MessageComposer_stickers","mx_Stickers_hideStickers","mx_MessageComposer_button_highlight");if(this.state.showStickers){t=i.a.createElement(pe.a,{id:"stickersButton",key:"controls_hide_stickers",className:s,onClick:this._onHideStickersClick,active:this.state.showStickers,title:Object(l.a)("Hide Stickers")});const a=d.getComponent("context_menus.GenericElementContextMenu");e=i.a.createElement(n.b,{chevronOffset:this.state.stickerPickerChevronOffset,chevronFace:"bottom",left:this.state.stickerPickerX,top:this.state.stickerPickerY,menuWidth:this.popoverWidth,menuHeight:this.popoverHeight,onFinished:this._onFinished,menuPaddingTop:0,menuPaddingLeft:0,menuPaddingRight:0,zIndex:3500},i.a.createElement(a,{element:this._getStickerpickerContent(),onResize:this._onFinished}))}else t=i.a.createElement(B.a,{id:"stickersButton",key:"controls_show_stickers",className:"mx_MessageComposer_button mx_MessageComposer_stickers",onClick:this._onShowStickersClick,title:Object(l.a)("Show Stickers")});return i.a.createElement(i.a.Fragment,null,t,e)}}function xp(){m.a.dispatch({action:"reply_to_event",event:null})}I()(Sp,"currentWidget",void 0);class Rp extends i.a.Component{constructor(e){super(e),this.unmounted=!1,this.state={event:Q.a.getQuotingEvent()},this._onRoomViewStoreUpdate=this._onRoomViewStoreUpdate.bind(this),this._roomStoreToken=Q.a.addListener(this._onRoomViewStoreUpdate)}componentWillUnmount(){this.unmounted=!0,this._roomStoreToken&&this._roomStoreToken.remove()}_onRoomViewStoreUpdate(){if(this.unmounted)return;const e=Q.a.getQuotingEvent();this.state.event!==e&&this.setState({event:e})}render(){if(!this.state.event)return null;const e=d.getComponent("rooms.EventTile");return i.a.createElement("div",{className:"mx_ReplyPreview"},i.a.createElement("div",{className:"mx_ReplyPreview_section"},i.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_title"},Object(l.a)("Replying")),i.a.createElement("div",{className:"mx_ReplyPreview_header mx_ReplyPreview_cancel"},i.a.createElement("img",{className:"mx_filterFlipColor",src:s(222),width:"18",height:"18",onClick:xp})),i.a.createElement("div",{className:"mx_ReplyPreview_clear"}),i.a.createElement(e,{last:!0,tileShape:"reply_preview",mxEvent:this.state.event,permalinkCreator:this.props.permalinkCreator,isTwelveHour:F.a.getValue("showTwelveHourTimestamps"),enableFlair:F.a.getValue(Xe.a.Flair)})))}}function Op(e){const t=d.getComponent("avatars.MemberStatusMessageAvatar");return i.a.createElement("div",{className:"mx_MessageComposer_avatar"},i.a.createElement(t,{member:e.me,width:24,height:24}))}function kp(e){return i.a.createElement(B.a,{className:"mx_MessageComposer_button mx_MessageComposer_voicecall",onClick:t=>{m.a.dispatch({action:"place_call",type:fe.a.Voice,room_id:e.roomId})},title:Object(l.a)("Voice call")})}function Ip(e){return i.a.createElement(B.a,{className:"mx_MessageComposer_button mx_MessageComposer_videocall",onClick:t=>{m.a.dispatch({action:"place_call",type:t.shiftKey?fe.a.ScreenSharing:fe.a.Video,room_id:e.roomId})},title:Object(l.a)("Video call")})}function Tp(e){let t=Object(l.a)("Hangup");e.isConference&&e.canEndConference&&(t=Object(l.a)("End conference"));const s=!e.isConference||e.isInConference;return i.a.createElement(B.a,{className:"mx_MessageComposer_button mx_MessageComposer_hangup",onClick:()=>{if(e.isConference)return void m.a.dispatch({action:e.canEndConference?"end_conference":"hangup_conference",room_id:e.roomId});const t=fe.b.sharedInstance().getCallForRoom(e.roomId);if(!t)return;const s=t.state===ln.e.Ringing?"reject":"hangup";m.a.dispatch({action:s,room_id:e.roomId})},title:t,disabled:!s})}I()(Rp,"propTypes",{permalinkCreator:xe.a.instanceOf(ur.a).isRequired}),Op.propTypes={me:xe.a.object.isRequired},kp.propTypes={roomId:xe.a.string.isRequired},Ip.propTypes={roomId:xe.a.string.isRequired},Tp.propTypes={roomId:xe.a.string.isRequired,isConference:xe.a.bool.isRequired,canEndConference:xe.a.bool,isInConference:xe.a.bool};const jp=({addEmoji:e})=>{const[t,s,a,o]=Object(n.q)();let r;if(t){const t=s.current.getBoundingClientRect(),a=d.getComponent("emojipicker.EmojiPicker");r=i.a.createElement(n.b,se()({},Object(n.k)(t),{onFinished:o,catchTab:!1}),i.a.createElement(a,{onChoose:e,showQuickReactions:!0}))}const c=L()("mx_MessageComposer_button","mx_MessageComposer_emoji",{mx_MessageComposer_button_highlight:t});return i.a.createElement(i.a.Fragment,null,i.a.createElement(n.d,{className:c,onClick:a,isExpanded:t,title:Object(l.a)("Emoji picker"),inputRef:s}),r)};class Np extends i.a.Component{constructor(e){super(e),I()(this,"onAction",e=>{"upload_file"===e.action&&this.onUploadClick()}),this.onUploadClick=this.onUploadClick.bind(this),this.onUploadFileInputChange=this.onUploadFileInputChange.bind(this),this._uploadInput=Object(a.createRef)(),this._dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){m.a.unregister(this._dispatcherRef)}onUploadClick(e){ee.a.get().isGuest()?m.a.dispatch({action:"require_registration"}):this._uploadInput.current.click()}onUploadFileInputChange(e){if(0===e.target.files.length)return;const t=[];for(let s=0;s<e.target.files.length;++s)t.push(e.target.files[s]);ed.a.sharedInstance().sendContentListToRoom(t,this.props.roomId,ee.a.get()),e.target.value=""}render(){return i.a.createElement(B.a,{className:"mx_MessageComposer_button mx_MessageComposer_upload",onClick:this.onUploadClick,title:Object(l.a)("Upload file")},i.a.createElement("input",{ref:this._uploadInput,type:"file",style:{display:"none"},multiple:!0,onChange:this.onUploadFileInputChange}))}}I()(Np,"propTypes",{roomId:xe.a.string.isRequired});class Pp extends i.a.Component{constructor(e){super(e),I()(this,"onAction",e=>{"reply_to_event"===e.action&&setTimeout(()=>{this.props.resizeNotifier.notifyTimelineHeightChanged()},100)}),I()(this,"_onWidgetUpdate",()=>{this.setState({hasConference:Wi.a.instance.doesRoomHaveConference(this.props.room)})}),I()(this,"_onActiveWidgetUpdate",()=>{this.setState({joinedConference:Wi.a.instance.isJoinedToConferenceIn(this.props.room)})}),this.onInputStateChanged=this.onInputStateChanged.bind(this),this._onRoomStateEvents=this._onRoomStateEvents.bind(this),this._onTombstoneClick=this._onTombstoneClick.bind(this),this.renderPlaceholderText=this.renderPlaceholderText.bind(this),Wi.a.instance.on(g.b,this._onWidgetUpdate),mn.a.on("update",this._onActiveWidgetUpdate),this._dispatcherRef=null,this.state={tombstone:this._getRoomTombstone(),canSendMessages:this.props.room.maySendMessage(),showCallButtons:F.a.getValue("showCallButtonsInComposer"),hasConference:Wi.a.instance.doesRoomHaveConference(this.props.room),joinedConference:Wi.a.instance.isJoinedToConferenceIn(this.props.room)}}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction),ee.a.get().on("RoomState.events",this._onRoomStateEvents),this._waitForOwnMember()}_waitForOwnMember(){const e=this.props.room.getMember(ee.a.get().getUserId());e?this.setState({me:e}):this.props.room.loadMembersIfNeeded().then(()=>{const e=this.props.room.getMember(ee.a.get().getUserId());this.setState({me:e})})}componentWillUnmount(){ee.a.get()&&ee.a.get().removeListener("RoomState.events",this._onRoomStateEvents),Wi.a.instance.removeListener(g.b,this._onWidgetUpdate),mn.a.removeListener("update",this._onActiveWidgetUpdate),m.a.unregister(this.dispatcherRef)}_onRoomStateEvents(e,t){e.getRoomId()===this.props.room.roomId&&("m.room.tombstone"===e.getType()&&this.setState({tombstone:this._getRoomTombstone()}),"m.room.power_levels"===e.getType()&&this.setState({canSendMessages:this.props.room.maySendMessage()}))}_getRoomTombstone(){return this.props.room.currentState.getStateEvents("m.room.tombstone","")}onInputStateChanged(e){e=Object.assign({},this.state.inputState,e),this.setState({inputState:e})}_onTombstoneClick(e){e.preventDefault();const t=this.state.tombstone.getContent().replacement_room,s=ee.a.get().getRoom(t);let n=null;if(s){const e=s.currentState.getStateEvents("m.room.create","");e&&e.getId()&&(n=e.getId())}const a=[this.state.tombstone.getSender().split(":").splice(1).join(":")];m.a.dispatch({action:"view_room",highlighted:!0,event_id:n,room_id:t,auto_join:!0,_type:"tombstone",via_servers:a,opts:{viaServers:a}})}renderPlaceholderText(){return this.props.replyToEvent?this.props.e2eStatus?Object(l.a)("Send an encrypted reply…"):Object(l.a)("Send a reply…"):this.props.e2eStatus?Object(l.a)("Send an encrypted message…"):Object(l.a)("Send a message…")}addEmoji(e){m.a.dispatch({action:"insert_emoji",emoji:e})}render(){const e=[this.state.me?i.a.createElement(Op,{key:"controls_avatar",me:this.state.me}):null];if(!this.state.tombstone&&this.state.canSendMessages){const t=d.getComponent("rooms.SendMessageComposer"),s=this.props.callState&&"ended"!==this.props.callState;if(e.push(i.a.createElement(t,{ref:e=>this.messageComposerInput=e,key:"controls_input",room:this.props.room,placeholder:this.renderPlaceholderText(),resizeNotifier:this.props.resizeNotifier,permalinkCreator:this.props.permalinkCreator,replyToEvent:this.props.replyToEvent}),i.a.createElement(Np,{key:"controls_upload",roomId:this.props.room.roomId}),i.a.createElement(jp,{key:"emoji_button",addEmoji:this.addEmoji})),F.a.getValue(Xe.a.Widgets)&&F.a.getValue("MessageComposerInput.showStickersButton")&&e.push(i.a.createElement(Sp,{key:"stickerpicker_controls_button",room:this.props.room})),this.state.showCallButtons)if(this.state.hasConference){const t=Os.a.canUserModifyWidgets(this.props.room.roomId);e.push(i.a.createElement(Tp,{key:"controls_hangup",roomId:this.props.room.roomId,isConference:!0,canEndConference:t,isInConference:this.state.joinedConference}))}else s?e.push(i.a.createElement(Tp,{key:"controls_hangup",roomId:this.props.room.roomId,isConference:!1})):e.push(i.a.createElement(kp,{key:"controls_call",roomId:this.props.room.roomId}),i.a.createElement(Ip,{key:"controls_videocall",roomId:this.props.room.roomId}))}else if(this.state.tombstone){const t=this.state.tombstone.getContent().replacement_room,n=t?i.a.createElement("a",{href:Object(ur.f)(t),className:"mx_MessageComposer_roomReplaced_link",onClick:this._onTombstoneClick},Object(l.a)("The conversation continues here.")):"";e.push(i.a.createElement("div",{className:"mx_MessageComposer_replaced_wrapper",key:"room_replaced"},i.a.createElement("div",{className:"mx_MessageComposer_replaced_valign"},i.a.createElement("img",{className:"mx_MessageComposer_roomReplaced_icon",src:s(1481)}),i.a.createElement("span",{className:"mx_MessageComposer_roomReplaced_header"},Object(l.a)("This room has been replaced and is no longer active.")),i.a.createElement("br",null),n)))}else e.push(i.a.createElement("div",{key:"controls_error",className:"mx_MessageComposer_noperm_error"},Object(l.a)("You do not have permission to post to this room")));return i.a.createElement("div",{className:"mx_MessageComposer mx_GroupLayout"},i.a.createElement("div",{className:"mx_MessageComposer_wrapper"},i.a.createElement(Rp,{permalinkCreator:this.props.permalinkCreator}),i.a.createElement("div",{className:"mx_MessageComposer_row"},e)))}}Pp.propTypes={room:xe.a.object.isRequired,callState:xe.a.string,showApps:xe.a.bool};var Dp=s(742),Ap=s(765),Up=s(1482);function Mp(e){return e.canonicalAlias||(e.aliases?e.aliases[0]:"")}const Lp=xe.a.shape({name:xe.a.string,topic:xe.a.string,roomId:xe.a.string,avatarUrl:xe.a.string,numJoinedMembers:xe.a.number,canonicalAlias:xe.a.string,aliases:xe.a.arrayOf(xe.a.string),worldReadable:xe.a.bool,guestCanJoin:xe.a.bool});class Fp extends i.a.Component{constructor(e){super(e),I()(this,"onClick",e=>{e.preventDefault(),this.props.onClick&&this.props.onClick(e,this.props.room)}),I()(this,"onTopicClick",e=>{e.stopPropagation()}),this._topic=Object(a.createRef)()}componentDidMount(){this._linkifyTopic()}componentDidUpdate(){this._linkifyTopic()}_linkifyTopic(){this._topic.current&&Object(rr.f)(this._topic.current)}render(){const e=d.getComponent("avatars.BaseAvatar"),t=this.props.room,s=t.name||Mp(t)||Object(l.a)("Unnamed room"),n=t.worldReadable?i.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(l.a)("World readable")):i.a.createElement("div",null),a=t.guestCanJoin?i.a.createElement("div",{className:"mx_RoomDirectory_perm"},Object(l.a)("Guests can join")):i.a.createElement("div",null),o=n||a?i.a.createElement("div",{className:"mx_RoomDirectory_perms"},n," ",a):i.a.createElement("div",null);return i.a.createElement("tr",{key:t.roomId,onClick:this.onClick,onMouseDown:this.props.onMouseDown},i.a.createElement("td",{className:"mx_RoomDirectory_roomAvatar"},i.a.createElement(e,{width:24,height:24,resizeMethod:"crop",name:s,idName:s,url:Object(Jl.a)(ee.a.get().getHomeserverUrl(),t.avatarUrl,24,24,"crop")})),i.a.createElement("td",{className:"mx_RoomDirectory_roomDescription"},i.a.createElement("div",{className:"mx_RoomDirectory_name"},s)," ",o,i.a.createElement("div",{className:"mx_RoomDirectory_topic",ref:this._topic,onClick:this.onTopicClick},t.topic),i.a.createElement("div",{className:"mx_RoomDirectory_alias"},Mp(t))),i.a.createElement("td",{className:"mx_RoomDirectory_roomMemberCount"},t.numJoinedMembers))}}I()(Fp,"propTypes",{room:Lp,onClick:xe.a.func,onMouseDown:xe.a.func});class Bp extends i.a.Component{constructor(...e){super(...e),I()(this,"onDetailsClick",(e,t)=>{m.a.dispatch({action:"view_room",room_id:t.roomId,room_alias:t.canonicalAlias||(t.aliases||[])[0]})})}getRows(){if(!this.props.rooms)return[];const e=d.getComponent("rooms.RoomDetailRow");return this.props.rooms.map((t,s)=>i.a.createElement(e,{key:s,room:t,onClick:this.onDetailsClick}))}render(){let e;return e=0===this.getRows().length?i.a.createElement("i",null,Object(l.a)("No rooms to show")):i.a.createElement("table",{className:"mx_RoomDirectory_table"},i.a.createElement("tbody",null,this.getRows())),i.a.createElement("div",{className:L()("mx_RoomDetailList",this.props.className)},e)}}I()(Bp,"propTypes",{rooms:xe.a.arrayOf(Lp),className:xe.a.string});var Vp=s(747),Wp=s(704),Hp=s(741),Gp=s(740);class qp extends i.a.Component{render(){const e=d.getComponent("messages.DateSeparator"),t=d.getComponent("rooms.EventTile"),s=this.props.searchResult,n=s.context.getEvent(),a=n.getId(),o=n.getTs(),r=[i.a.createElement(e,{key:o+"-search",ts:o})],l=s.context.getTimeline();for(let e=0;e<l.length;e++){const n=l[e];let o;const c=e!=s.context.getOurEventIndex();c||(o=this.props.searchHighlights),Object(gt.b)(n)&&r.push(i.a.createElement(t,{key:`${a}+${e}`,mxEvent:n,contextual:c,highlights:o,permalinkCreator:this.props.permalinkCreator,highlightLink:this.props.resultLink,onHeightChanged:this.props.onHeightChanged,isTwelveHour:F.a.getValue("showTwelveHourTimestamps"),enableFlair:F.a.getValue(Xe.a.Flair)}))}return i.a.createElement("li",{"data-scroll-tokens":a},r)}}I()(qp,"propTypes",{searchResult:xe.a.object.isRequired,searchHighlights:xe.a.array,resultLink:xe.a.string,onHeightChanged:xe.a.func});class Kp{constructor(e,t){I()(this,"history",[]),I()(this,"prefix",void 0),I()(this,"lastIndex",0),I()(this,"currentIndex",0),this.prefix=t+e;let s,n=0;for(;s=sessionStorage.getItem(`${this.prefix}[${n}]`);){try{this.history.push(JSON.parse(s))}catch(e){console.warn("Throwing away unserialisable history",e);break}++n}this.lastIndex=this.history.length-1,this.currentIndex=this.lastIndex+1}static createItem(e,t){return{parts:e.serializeParts(),replyEventId:t?t.getId():void 0}}save(e,t){const s=Kp.createItem(e,t);this.history.push(s),this.currentIndex=this.history.length,this.lastIndex+=1,sessionStorage.setItem(`${this.prefix}[${this.lastIndex}]`,JSON.stringify(s))}getItem(e){return this.currentIndex=Object(Pa.clamp)(this.currentIndex+e,0,this.history.length-1),this.history[this.currentIndex]}}var zp=s(292),$p=s(590),Yp=s.n($p);function Jp(e,t,s){const n=ip(e);n&&(e=rp(e)),op(e,"//")&&(e=lp(e,"/"));const a={msgtype:n?"m.emote":"m.text",body:ap(e=function(e){const{parts:t}=e;if(t.length){const s=t[0];"plain"===s.type&&s.text.startsWith("\\/")&&(e=e.clone()).removeText({index:0,offset:0},1)}return e}(e))},i=np(e,{forceHTML:!!s});return i&&(a.format="org.matrix.custom.html",a.formatted_body=i),s&&function(e,t,s){const n=Th.a.makeReplyMixIn(t);Object.assign(e,n);const a=Th.a.getNestedReplyText(t,s);a&&(e.formatted_body&&(e.formatted_body=a.html+e.formatted_body),e.body=a.body+e.body)}(a,s,t),a}class Qp extends i.a.Component{constructor(e,t){super(e,t),I()(this,"_setEditorRef",e=>{this._editorRef=e}),I()(this,"_onKeyDown",e=>{if(this._editorRef.isComposing(e))return;const t=e.altKey||e.ctrlKey||e.metaKey||e.shiftKey;(!!F.a.getValue("MessageComposerInput.ctrlEnterToSend")?e.key===_s.a.ENTER&&Object(_s.d)(e):e.key===_s.a.ENTER&&!t)?(this._sendMessage(),e.preventDefault()):e.key===_s.a.ARROW_UP?this.onVerticalArrow(e,!0):e.key===_s.a.ARROW_DOWN?this.onVerticalArrow(e,!1):e.key===_s.a.ESCAPE?m.a.dispatch({action:"reply_to_event",event:null}):this._prepareToEncrypt&&this._prepareToEncrypt()}),I()(this,"_saveStoredEditorState",()=>{if(this.model.isEmpty)this._clearStoredEditorState();else{const e=Kp.createItem(this.model,this.props.replyToEvent);localStorage.setItem(this._editorStateKey,JSON.stringify(e))}}),I()(this,"onAction",e=>{switch(e.action){case"reply_to_event":case h.a.FocusComposer:this._editorRef&&this._editorRef.focus();break;case"insert_mention":this._insertMention(e.user_id);break;case"quote":this._insertQuotedMessage(e.event);break;case"insert_emoji":this._insertEmoji(e.emoji)}}),I()(this,"_insertEmoji",e=>{const{model:t}=this,{partCreator:s}=t,n=this._editorRef.getCaret(),a=t.positionForOffset(n.offset,n.atNodeEnd);t.transform(()=>{const i=t.insert([s.plain(e)],a);return t.positionForOffset(n.offset+i,!0)})}),I()(this,"_onPaste",e=>{const{clipboardData:t}=e;if(t.files.length&&!t.types.some(e=>"text/plain"===e))return ed.a.sharedInstance().sendContentListToRoom(Array.from(t.files),this.props.room.roomId,this.context),!0}),this.model=null,this._editorRef=null,this.currentlyComposedEditorState=null,this.context.isCryptoEnabled()&&this.context.isRoomEncrypted(this.props.room.roomId)&&(this._prepareToEncrypt=new vp.a(()=>{this.context.prepareToEncrypt(this.props.room)},6e4)),window.addEventListener("beforeunload",this._saveStoredEditorState)}onVerticalArrow(e,t){if(e.shiftKey||e.metaKey)return;const s=e.altKey&&e.ctrlKey,n=!e.altKey&&!e.ctrlKey&&t&&!this.props.replyToEvent;if(s){this.selectSendHistory(t)&&e.preventDefault()}else if(n&&this._editorRef.isSelectionCollapsed()&&this._editorRef.isCaretAtStart()){const t=Md(this.props.room,!1);t&&(e.preventDefault(),m.a.dispatch({action:"edit_event",event:t}))}}selectSendHistory(e){const t=e?-1:1;if(this.sendHistoryManager.currentIndex===this.sendHistoryManager.history.length){if(!e)return;this.currentlyComposedEditorState=this.model.serializeParts()}else if(this.sendHistoryManager.currentIndex+t===this.sendHistoryManager.history.length)return this.model.reset(this.currentlyComposedEditorState),void(this.sendHistoryManager.currentIndex=this.sendHistoryManager.history.length);const{parts:s,replyEventId:n}=this.sendHistoryManager.getItem(t);m.a.dispatch({action:"reply_to_event",event:n?this.props.room.findEventById(n):null}),s&&(this.model.reset(s),this._editorRef.focus())}_isSlashCommand(){const e=this.model.parts[0];if(e){if("command"===e.type&&e.text.startsWith("/")&&!e.text.startsWith("//"))return!0;if(e.text.startsWith("/")&&!e.text.startsWith("//")&&("plain"===e.type||"pill-candidate"===e.type))return!0}return!1}_sendQuickReaction(){const e=this.props.room.getLiveTimeline().getEvents(),t=this.model.parts[1].text;for(let s=e.length-1;s>=0;s--)if("m.room.message"===e[s].getType()){let n=!0;const a=e[s],i=ee.a.get().getUserId(),o=this.props.room.getUnfilteredTimelineSet().getRelationsForEvent(a.getId(),"m.annotation","m.reaction");if(o){n=![...o.getAnnotationsBySender()[i]||[]].filter(e=>!e.isRedacted()).map(e=>e.getRelation().key).includes(t)}n&&(ee.a.get().sendEvent(a.getRoomId(),"m.reaction",{"m.relates_to":{rel_type:"m.annotation",event_id:a.getId(),key:t}}),m.a.dispatch({action:"message_sent"}));break}}_getSlashCommand(){const e=this.model.parts.reduce((e,t)=>"user-pill"===t.type?e+t.resourceId:e+t.text,"");return[kr(this.props.room.roomId,e),e]}async _runSlashCommand(e){const t=e();let s=t.error;if(t.promise)try{await t.promise}catch(e){s=e}if(s){console.error("Command failure: %s",s);const e=d.getComponent("dialogs.ErrorDialog"),n=!!t.promise?Object(l.b)("Server error"):Object(l.b)("Command error");let a;a="string"==typeof s?s:s.message?s.message:Object(l.a)("Server unavailable, overloaded, or something else went wrong."),De.a.createTrackedDialog(n,"",e,{title:Object(l.a)(n),description:a})}else console.log("Command success.")}async _sendMessage(){if(this.model.isEmpty)return;let e=!0;if(!ip(this.model)&&this._isSlashCommand()){const[t,s]=this._getSlashCommand();if(t)e=!1,this._runSlashCommand(t);else{const e=d.getComponent("dialogs.QuestionDialog"),{finished:t}=De.a.createTrackedDialog("Unknown command","",e,{title:Object(l.a)("Unknown Command"),description:i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("Unrecognised command: %(commandText)s",{commandText:s})),i.a.createElement("p",null,Object(l.a)("You can use <code>/help</code> to list available commands. Did you mean to send this as a message?",{},{code:e=>i.a.createElement("code",null,e)})),i.a.createElement("p",null,Object(l.a)("Hint: Begin your message with <code>//</code> to start it with a slash.",{},{code:e=>i.a.createElement("code",null,e)}))),button:Object(l.a)("Send as message")}),[n]=await t;if(!n)return}}(function(e){const t=e.parts;if(0==t.length)return!1;const s=ap(e);if(t.length<=2){const e=s.startsWith("+")||s.startsWith("+ "),t=s.match(Yp.a);if(e&&t&&1==t.length)return t[0]===s.substring(1)||t[0]===s.substring(2)}return!1})(this.model)&&(e=!1,this._sendQuickReaction());const t=this.props.replyToEvent;if(e){const e=y.a.getTimestamp(),{roomId:s}=this.props.room,n=Jp(this.model,this.props.permalinkCreator,t);if(!n.body.trim())return;const a=this.context.sendMessage(s,n);t&&m.a.dispatch({action:"reply_to_event",event:null}),m.a.dispatch({action:"message_sent"}),br.CHAT_EFFECTS.forEach(e=>{Object(zp.containsEmoji)(n,e.emojis)&&m.a.dispatch({action:"effects."+e.command})}),y.a.instance.trackSendMessage(e,a,s,!1,!!t,n)}this.sendHistoryManager.save(this.model,t),this.model.reset([]),this._editorRef.clearUndoHistory(),this._editorRef.focus(),this._clearStoredEditorState(),m.a.dispatch({action:"scroll_to_bottom"})}componentWillUnmount(){m.a.unregister(this.dispatcherRef),window.removeEventListener("beforeunload",this._saveStoredEditorState),this._saveStoredEditorState()}UNSAFE_componentWillMount(){const e=new jl(this.props.room,this.context),t=this._restoreStoredEditorState(e)||[];this.model=new Zu(t,e),this.dispatcherRef=m.a.register(this.onAction),this.sendHistoryManager=new Kp(this.props.room.roomId,"mx_cider_history_")}get _editorStateKey(){return"mx_cider_state_"+this.props.room.roomId}_clearStoredEditorState(){localStorage.removeItem(this._editorStateKey)}_restoreStoredEditorState(e){const t=localStorage.getItem(this._editorStateKey);if(t)try{const{parts:s,replyEventId:n}=JSON.parse(t),a=s.map(t=>e.deserializePart(t));return n&&m.a.dispatch({action:"reply_to_event",event:this.props.room.findEventById(n)}),a}catch(e){console.error(e)}}_insertMention(e){const{model:t}=this,{partCreator:s}=t,n=this.props.room.getMember(e),a=n?n.rawDisplayName:e,i=this._editorRef.getCaret(),o=t.positionForOffset(i.offset,i.atNodeEnd),r=o.index>0?o.index:0,l=s.createMentionParts(r,a,e);t.transform(()=>{const e=t.insert(l,o);return t.positionForOffset(i.offset+e,!0)}),this._editorRef&&this._editorRef.focus()}_insertQuotedMessage(e){const{model:t}=this,{partCreator:s}=t,n=Ll(e,s,{isQuotedMessage:!0});n.push(s.newline()),n.push(s.newline()),t.transform(()=>{const e=t.insert(n,t.positionForOffset(0));return t.positionForOffset(e,!0)}),this._editorRef&&this._editorRef.focus()}render(){return i.a.createElement("div",{className:"mx_SendMessageComposer",onClick:this.focusComposer,onKeyDown:this._onKeyDown},i.a.createElement(zl,{ref:this._setEditorRef,model:this.model,room:this.props.room,label:this.props.placeholder,placeholder:this.props.placeholder,onPaste:this._onPaste}))}}I()(Qp,"propTypes",{room:xe.a.object.isRequired,placeholder:xe.a.string,permalinkCreator:xe.a.object.isRequired,replyToEvent:xe.a.object}),I()(Qp,"contextType",b.a);var Xp=s(748);class Zp extends i.a.Component{constructor(e){super(e),I()(this,"onRoomStateEvents",e=>{if("m.room.third_party_invite"===e.getType()&&e.getStateKey()===this.state.stateKey){const t=e.getContent().display_name,s={invited:Object(rs.c)(e)};t&&(s.displayName=t),this.setState(s)}}),I()(this,"onCancel",()=>{m.a.dispatch({action:"view_3pid_invite",event:null})}),I()(this,"onKickClick",()=>{ee.a.get().sendStateEvent(this.state.roomId,"m.room.third_party_invite",{},this.state.stateKey).catch(e=>{console.error(e),this.setState({invited:!0});const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Revoke 3pid invite failed","",t,{title:Object(l.a)("Failed to revoke invite"),description:Object(l.a)("Could not revoke the invite. The server may be experiencing a temporary problem or you do not have sufficient permissions to revoke the invite.")})}),this.setState({invited:!1})});const t=ee.a.get().getRoom(this.props.event.getRoomId()),s=t.getMember(ee.a.get().getUserId()),n=t.currentState.getStateEvents("m.room.power_levels","");let a=n?n.getContent().kick:50;"number"!=typeof a&&(a=50);const i=t.getMember(this.props.event.getSender());this.state={stateKey:this.props.event.getStateKey(),roomId:this.props.event.getRoomId(),displayName:this.props.event.getContent().display_name,invited:!0,canKick:!!s&&s.powerLevel>a,senderName:i?i.name:this.props.event.getSender()}}componentDidMount(){ee.a.get().on("RoomState.events",this.onRoomStateEvents)}componentWillUnmount(){const e=ee.a.get();e&&e.removeListener("RoomState.events",this.onRoomStateEvents)}render(){const e=d.getComponent("elements.AccessibleButton");let t=null;return this.state.canKick&&this.state.invited&&(t=i.a.createElement("div",{className:"mx_MemberInfo_container"},i.a.createElement("h3",null,Object(l.a)("Admin Tools")),i.a.createElement("div",{className:"mx_MemberInfo_buttons"},i.a.createElement(e,{className:"mx_MemberInfo_field",onClick:this.onKickClick},Object(l.a)("Revoke invite"))))),i.a.createElement("div",{className:"mx_MemberInfo",role:"tabpanel"},i.a.createElement("div",{className:"mx_MemberInfo_name"},i.a.createElement(e,{className:"mx_MemberInfo_cancel",onClick:this.onCancel,title:Object(l.a)("Close")}),i.a.createElement("h2",null,this.state.displayName)),i.a.createElement("div",{className:"mx_MemberInfo_container"},i.a.createElement("div",{className:"mx_MemberInfo_profile"},i.a.createElement("div",{className:"mx_MemberInfo_profileField"},Object(l.a)("Invited by %(sender)s",{sender:this.state.senderName})))),t)}}I()(Zp,"propTypes",{event:xe.a.instanceOf(Fe.j).isRequired});class eg extends i.a.Component{render(){return i.a.createElement("div",{className:"mx_TopUnreadMessagesBar"},i.a.createElement(pe.a,{className:"mx_TopUnreadMessagesBar_scrollUp",title:Object(l.a)("Jump to first unread message."),onClick:this.props.onScrollUpClick}),i.a.createElement(pe.a,{className:"mx_TopUnreadMessagesBar_markAsRead",title:Object(l.a)("Mark all as read"),onClick:this.props.onCloseClick}))}}function tg(e,t=[]){const s=[],n=Object.keys(e.currentState.members);for(let a=0;a<n.length;++a){const i=n[a];e.currentState.members[i].typing&&-1===t.indexOf(i)&&s.push(e.currentState.members[i])}return s}I()(eg,"propTypes",{onScrollUpClick:xe.a.func,onCloseClick:xe.a.func});var sg=s(250);class ng extends i.a.Component{constructor(...e){var t;super(...e),I()(this,"state",{usersTyping:(t=this.props.room,tg(t,[ee.a.get().getUserId()])),delayedStopTypingTimers:{}}),I()(this,"isVisible",()=>this._isVisible(this.state)),I()(this,"onRoomTimeline",(e,t)=>{var s;if((null==t?void 0:t.roomId)===(null===(s=this.props.room)||void 0===s?void 0:s.roomId)){const t=e.getSender(),s=this.state.usersTyping.filter(e=>e.userId!==t);this.setState({usersTyping:s}),this._abortUserTimer(t)}}),I()(this,"onRoomMemberTyping",(e,t)=>{const s=function(e){return tg(e,[ee.a.get().getUserId()].concat(ee.a.get().getIgnoredUsers()))}(this.props.room);this.setState({delayedStopTypingTimers:this._updateDelayedStopTypingTimers(s),usersTyping:s})})}componentDidMount(){ee.a.get().on("RoomMember.typing",this.onRoomMemberTyping),ee.a.get().on("Room.timeline",this.onRoomTimeline)}componentDidUpdate(e,t){const s=this._isVisible(t),n=this._isVisible(this.state);this.props.onShown&&!s&&n?this.props.onShown():this.props.onHidden&&s&&!n&&this.props.onHidden()}componentWillUnmount(){const e=ee.a.get();e&&(e.removeListener("RoomMember.typing",this.onRoomMemberTyping),e.removeListener("Room.timeline",this.onRoomTimeline)),Object.values(this.state.delayedStopTypingTimers).forEach(e=>e.abort())}_isVisible(e){return 0!==e.usersTyping.length||0!==Object.keys(e.delayedStopTypingTimers).length}_updateDelayedStopTypingTimers(e){const t=this.state.usersTyping.filter(t=>!e.some(e=>t.userId===e.userId)),s=e.filter(e=>!this.state.usersTyping.some(t=>e.userId===t.userId));s.forEach(e=>{const t=this.state.delayedStopTypingTimers[e.userId];t&&t.abort()});let n=Object.assign({},this.state.delayedStopTypingTimers);return n=s.reduce((e,t)=>(delete e[t.userId],e),n),n=t.reduce((e,t)=>{if(!e[t.userId]){const s=new sg.a(5e3);e[t.userId]=s,s.start(),s.finished().then(()=>this._removeUserTimer(t.userId),()=>{})}return e},n),n}_abortUserTimer(e){const t=this.state.delayedStopTypingTimers[e];t&&(t.abort(),this._removeUserTimer(e))}_removeUserTimer(e){if(this.state.delayedStopTypingTimers[e]){const t=Object.assign({},this.state.delayedStopTypingTimers);delete t[e],this.setState({delayedStopTypingTimers:t})}}_renderTypingIndicatorAvatars(e,t){let s=0;e.length>t&&(s=e.length-t+1,e=e.slice(0,t-1));const n=e.map(e=>i.a.createElement(Wa.a,{key:e.userId,member:e,width:24,height:24,resizeMethod:"crop",viewUserOnClick:!0}));return s>0&&n.push(i.a.createElement("span",{className:"mx_WhoIsTypingTile_remainingAvatarPlaceholder",key:"others"},"+",s)),n}render(){let e=this.state.usersTyping;const t=Object.keys(this.state.delayedStopTypingTimers).map(e=>this.props.room.getMember(e));e=e.concat(t),e.sort((e,t)=>e.name.localeCompare(t.name));const s=function(e,t){let s=0;if(e.length>t&&(s=e.length-t+1),0===e.length)return"";if(1===e.length)return Object(l.a)("%(displayName)s is typing …",{displayName:e[0].name});const n=e.map(e=>e.name);if(s>=1)return Object(l.a)("%(names)s and %(count)s others are typing …",{names:n.slice(0,t-1).join(", "),count:s});{const e=n.pop();return Object(l.a)("%(names)s and %(lastPerson)s are typing …",{names:n.join(", "),lastPerson:e})}}(e,this.props.whoIsTypingLimit);return s?i.a.createElement("li",{className:"mx_WhoIsTypingTile","aria-atomic":"true"},i.a.createElement("div",{className:"mx_WhoIsTypingTile_avatars"},this._renderTypingIndicatorAvatars(e,this.props.whoIsTypingLimit)),i.a.createElement("div",{className:"mx_WhoIsTypingTile_label"},s)):i.a.createElement("div",{className:"mx_WhoIsTypingTile_empty"})}}I()(ng,"propTypes",{room:xe.a.object.isRequired,onShown:xe.a.func,onHidden:xe.a.func,whoIsTypingLimit:xe.a.number}),I()(ng,"defaultProps",{whoIsTypingLimit:3});const ag=({avatarUrl:e,avatarAltText:t,avatarName:s,uploadAvatar:n,removeAvatar:o})=>{const[r,c]=Object(a.useState)(!1),d={onMouseEnter:()=>c(!0),onMouseLeave:()=>c(!1)};let m,h,u=i.a.createElement(pe.a,se()({element:"div",onClick:n,className:"mx_AvatarSetting_avatarPlaceholder"},d));if(e){let s=e;e.startsWith("data:")||(s=Ns.a.getUnencryptedContentUrl({url:E.a.imgUrlToUri(e)},!0)),u=i.a.createElement(pe.a,se()({element:"img",src:s,alt:t,"aria-label":t,onClick:n},d))}n&&(m=i.a.createElement(pe.a,se()({onClick:n,className:"mx_AvatarSetting_uploadButton"},d))),e&&o&&(h=i.a.createElement(pe.a,{onClick:o,kind:"link_sm"},Object(l.a)("Remove")));const p=L()({mx_AvatarSetting_avatar:!0,mx_AvatarSetting_avatar_hovering:r&&n});return i.a.createElement("div",{className:p},u,i.a.createElement("div",{className:"mx_AvatarSetting_hover"},i.a.createElement("div",{className:"mx_AvatarSetting_hoverBg"}),i.a.createElement("span",null,Object(l.a)("Upload"))),m,h)};ag.propTypes={avatarUrl:xe.a.string,avatarName:xe.a.string.isRequired,uploadAvatar:xe.a.func,removeAvatar:xe.a.func,avatarAltText:xe.a.string.isRequired};var ig=ag;class og extends i.a.Component{constructor(e){super(e),I()(this,"onRoomStateEvents",e=>{this.props.room&&e.getRoomId()===this.props.room.roomId&&"m.room.avatar"===e.getType()&&e.getSender()===ee.a.get().getUserId()&&(e.getContent().url||(this.avatarSet=!1,this.setState({})))}),I()(this,"onFileSelected",e=>(this.avatarSet=!0,this.setAvatarFromFile(e.target.files[0]))),I()(this,"onError",e=>{this.setState({errorText:Object(l.a)("Failed to upload profile picture!")})}),this.state={avatarUrl:this.props.initialAvatarUrl,phase:og.Phases.Display}}componentDidMount(){ee.a.get().on("RoomState.events",this.onRoomStateEvents)}UNSAFE_componentWillReceiveProps(e){this.avatarSet||this.setState({avatarUrl:e.initialAvatarUrl})}componentWillUnmount(){ee.a.get()&&ee.a.get().removeListener("RoomState.events",this.onRoomStateEvents)}setAvatarFromFile(e){let t=null;this.setState({phase:og.Phases.Uploading});const s=this,n=ee.a.get().uploadContent(e).then((function(e){return t=e,s.props.room?ee.a.get().sendStateEvent(s.props.room.roomId,"m.room.avatar",{url:e},""):ee.a.get().setAvatarUrl(e)}));return n.then((function(){s.setState({phase:og.Phases.Display,avatarUrl:ee.a.get().mxcUrlToHttp(t)})}),(function(e){s.setState({phase:og.Phases.Error}),s.onError(e)})),n}render(){let e,t;if(this.props.room&&!this.avatarSet){const t=d.getComponent("avatars.RoomAvatar");e=i.a.createElement(t,{room:this.props.room,width:this.props.width,height:this.props.height,resizeMethod:"crop"})}else{const t=d.getComponent("avatars.BaseAvatar");e=i.a.createElement(t,{width:this.props.width,height:this.props.height,resizeMethod:"crop",name:"?",idName:ee.a.get().getUserIdLocalpart(),url:this.state.avatarUrl})}switch(this.props.showUploadSection&&(t=i.a.createElement("div",{className:this.props.className},Object(l.a)("Upload new:"),i.a.createElement("input",{type:"file",accept:"image/*",onChange:this.onFileSelected}),this.state.errorText)),this.state.phase){case og.Phases.Display:case og.Phases.Error:return i.a.createElement("div",null,i.a.createElement("div",{className:this.props.className},e),t);case og.Phases.Uploading:return i.a.createElement(Je.a,null)}}}I()(og,"propTypes",{initialAvatarUrl:xe.a.string,room:xe.a.object,showUploadSection:xe.a.bool,width:xe.a.number,height:xe.a.number,className:xe.a.string}),I()(og,"Phases",{Display:"display",Uploading:"uploading",Error:"error"}),I()(og,"defaultProps",{showUploadSection:!0,className:"",width:80,height:80});class rg extends i.a.Component{constructor(...e){super(...e),I()(this,"_getDisplayName",async()=>{const e=ee.a.get();try{return(await e.getProfileInfo(e.getUserId())).displayname}catch(e){throw new Error("Failed to fetch display name")}}),I()(this,"_changeDisplayName",e=>ee.a.get().setDisplayName(e).catch((function(e){throw new Error("Failed to set display name",e)})))}render(){const e=d.getComponent("elements.EditableTextContainer");return i.a.createElement(e,{getInitialValue:this._getDisplayName,placeholder:Object(l.a)("No display name"),blurToSubmit:!0,onSubmit:this._changeDisplayName})}}class lg extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{fieldValid:{},phase:lg.Phases.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""}),I()(this,"_onExportE2eKeysClicked",()=>{De.a.createTrackedDialogAsync("Export E2E Keys","Change Password",s.e(3).then(s.bind(null,1506)),{matrixClient:ee.a.get()})}),I()(this,"onChangeOldPassword",e=>{this.setState({oldPassword:e.target.value})}),I()(this,"onOldPasswordValidate",async e=>{const t=await this.validateOldPasswordRules(e);return this.markFieldValid("field_old_password",t.valid),t}),I()(this,"validateOldPasswordRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Passwords can't be empty")}]})),I()(this,"onChangeNewPassword",e=>{this.setState({newPassword:e.target.value})}),I()(this,"onNewPasswordValidate",e=>{this.markFieldValid("field_new_password",e.valid)}),I()(this,"onChangeNewPasswordConfirm",e=>{this.setState({newPasswordConfirm:e.target.value})}),I()(this,"onNewPasswordConfirmValidate",async e=>{const t=await this.validatePasswordConfirmRules(e);return this.markFieldValid("field_new_password_confirm",t.valid),t}),I()(this,"validatePasswordConfirmRules",Object(Ca.a)({rules:[{key:"required",test:({value:e,allowEmpty:t})=>t||!!e,invalid:()=>Object(l.a)("Confirm password")},{key:"match",test({value:e}){return!e||e===this.state.newPassword},invalid:()=>Object(l.a)("Passwords don't match")}]})),I()(this,"onClickChange",async e=>{e.preventDefault();if(!await this.verifyFieldsBeforeSubmit())return void y.a.instance.track("onboarding_registration_submit_failed");const t=this,s=this.state.oldPassword,n=this.state.newPassword,a=this.state.newPasswordConfirm,o=this.props.onCheckPassword(s,n,a);if(o)this.props.onError(o);else{if(Ma.a.isPasswordValid(n).isValid)t.changePassword(s,n);else{const e=d.getComponent("dialogs.InfoDialog");De.a.createTrackedDialog("Password too weak ","Password too weak",e,{title:Object(l.a)("Password too weak !"),description:i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("This password is too weak. It must include a lower-case letter, an upper-case letter, a number and a symbol and be at a minimum 8 characters in length.")))})}}})}changePassword(e,t){const s=ee.a.get();if(!this.props.confirm)return void this._changePassword(s,e,t);const n=d.getComponent("dialogs.QuestionDialog");De.a.createTrackedDialog("Change Password","",n,{title:Object(l.a)("Warning!"),description:i.a.createElement("div",null,Object(l.a)("Changing password will currently reset any end-to-end encryption keys on all sessions, making encrypted chat history unreadable, unless you first export your room keys and re-import them afterwards. In future this will be improved.")," ",i.a.createElement("a",{href:"https://github.com/vector-im/element-web/issues/2671",target:"_blank",rel:"noreferrer noopener"},"https://github.com/vector-im/element-web/issues/2671")),button:Object(l.a)("Continue"),extraButtons:[i.a.createElement("button",{key:"exportRoomKeys",className:"mx_Dialog_primary",onClick:this._onExportE2eKeysClicked},Object(l.a)("Export E2E room keys"))],onFinished:n=>{n&&this._changePassword(s,e,t)}})}_changePassword(e,t,s){const n={type:"m.login.password",identifier:{type:"m.id.user",user:e.credentials.userId},user:e.credentials.userId,password:t};this.setState({phase:lg.Phases.Uploading}),e.setPassword(n,s).then(()=>{if(this.props.shouldAskForEmail)return this._optionallySetEmail().then(e=>{this.props.onFinished({didSetEmail:e})});this.props.onFinished()},e=>{this.props.onError(e)}).finally(()=>{this.setState({phase:lg.Phases.Edit,oldPassword:"",newPassword:"",newPasswordConfirm:""})})}_optionallySetEmail(){const e=d.getComponent("dialogs.SetEmailDialog");return De.a.createTrackedDialog("Do you want to set an email address?","",e,{title:Object(l.a)("Do you want to set an email address?")}).finished.then(([e])=>e)}markFieldValid(e,t){const{fieldValid:s}=this.state;s[e]=t,this.setState({fieldValid:s})}async verifyFieldsBeforeSubmit(){const e=document.activeElement;e&&e.blur();const t=["field_old_password","field_new_password","field_new_password_confirm"];for(const e of t){const t=this[e];t&&await t.validate({allowEmpty:!1})}if(await new Promise(e=>this.setState({},e)),this.allFieldsValid())return!0;const s=this.findFirstInvalidField(t);return!s||(s.focus(),s.validate({allowEmpty:!1,focused:!0}),!1)}allFieldsValid(){const e=Object.keys(this.state.fieldValid);for(let t=0;t<e.length;++t)if(!this.state.fieldValid[e[t]])return!1;return!0}findFirstInvalidField(e){for(const t of e)if(!this.state.fieldValid[t]&&this[t])return this[t];return null}render(){const e=this.props.rowClassName,t=this.props.buttonClassName;switch(this.state.phase){case lg.Phases.Edit:return i.a.createElement("form",{className:this.props.className,onSubmit:this.onClickChange},i.a.createElement("div",{className:e},i.a.createElement(ke.a,{ref:e=>this.field_old_password=e,type:"password",label:Object(l.a)("Current password"),value:this.state.oldPassword,onChange:this.onChangeOldPassword,onValidate:this.onOldPasswordValidate})),i.a.createElement("div",{className:e},i.a.createElement(Ba.a,{fieldRef:e=>this.field_new_password=e,type:"password",label:"New Password",minScore:3,value:this.state.newPassword,autoFocus:this.props.autoFocusNewPasswordInput,onChange:this.onChangeNewPassword,onValidate:this.onNewPasswordValidate,autoComplete:"new-password"})),i.a.createElement("div",{className:e},i.a.createElement(ke.a,{ref:e=>this.field_new_password_confirm=e,type:"password",label:Object(l.a)("Confirm password"),value:this.state.newPasswordConfirm,onChange:this.onChangeNewPasswordConfirm,onValidate:this.onNewPasswordConfirmValidate,autoComplete:"new-password"})),i.a.createElement(pe.a,{className:t,kind:this.props.buttonKind,onClick:this.onClickChange},this.props.buttonLabel||Object(l.a)("Change Password")));case lg.Phases.Uploading:return i.a.createElement("div",{className:"mx_Dialog_content"},i.a.createElement(Je.a,null))}}}I()(lg,"propTypes",{onFinished:xe.a.func,onError:xe.a.func,onCheckPassword:xe.a.func,rowClassName:xe.a.string,buttonClassName:xe.a.string,buttonKind:xe.a.string,buttonLabel:xe.a.string,confirm:xe.a.bool,autoFocusNewPasswordInput:xe.a.bool}),I()(lg,"Phases",{Edit:"edit",Uploading:"uploading",Error:"error"}),I()(lg,"defaultProps",{onFinished(){},onError(){},onCheckPassword:(e,t,s)=>t!==s?{error:Object(l.a)("New passwords don't match")}:t&&0!==t.length?void 0:{error:Object(l.a)("Passwords can't be empty")},confirm:!0});class cg extends i.a.PureComponent{constructor(e){super(e),I()(this,"onAccountData",e=>{const t=e.getType();(t.startsWith("m.cross_signing")||t.startsWith("m.secret_storage"))&&this._getUpdatedStatus()}),I()(this,"_onBootstrapClick",()=>{this._bootstrapCrossSigning({forceReset:!1})}),I()(this,"onStatusChanged",()=>{this._getUpdatedStatus()}),I()(this,"_bootstrapCrossSigning",async({forceReset:e=!1})=>{this.setState({error:null});try{const t=ee.a.get();await t.bootstrapCrossSigning({authUploadDeviceSigningKeys:async e=>{const{finished:s}=De.a.createTrackedDialog("Cross-signing keys dialog","",dd,{title:Object(l.a)("Setting up keys"),matrixClient:t,makeRequest:e}),[n]=await s;if(!n)throw new Error("Cross-signing key upload auth canceled")},setupNewCrossSigning:e})}catch(e){this.setState({error:e}),console.error("Error bootstrapping cross-signing",e)}this._unmounted||this._getUpdatedStatus()}),I()(this,"_resetCrossSigning",()=>{De.a.createDialog(mh,{onFinished:e=>{e&&this._bootstrapCrossSigning({forceReset:!0})}})}),this._unmounted=!1,this.state={error:null,crossSigningPublicKeysOnDevice:null,crossSigningPrivateKeysInStorage:null,masterPrivateKeyCached:null,selfSigningPrivateKeyCached:null,userSigningPrivateKeyCached:null,homeserverSupportsCrossSigning:null,crossSigningReady:null}}componentDidMount(){const e=ee.a.get();e.on("accountData",this.onAccountData),e.on("userTrustStatusChanged",this.onStatusChanged),e.on("crossSigning.keysChanged",this.onStatusChanged),this._getUpdatedStatus()}componentWillUnmount(){this._unmounted=!0;const e=ee.a.get();e&&(e.removeListener("accountData",this.onAccountData),e.removeListener("userTrustStatusChanged",this.onStatusChanged),e.removeListener("crossSigning.keysChanged",this.onStatusChanged))}async _getUpdatedStatus(){const e=ee.a.get(),t=e.getCrossSigningCacheCallbacks(),s=e._crypto._crossSigningInfo,n=e._crypto._secretStorage,a=s.getId(),i=await s.isStoredInSecretStorage(n),o=!(!t||!await t.getCrossSigningKeyCache("master")),r=!(!t||!await t.getCrossSigningKeyCache("self_signing")),l=!(!t||!await t.getCrossSigningKeyCache("user_signing")),c=await e.doesServerSupportUnstableFeature("org.matrix.e2e_cross_signing"),d=await e.isCrossSigningReady();this.setState({crossSigningPublicKeysOnDevice:a,crossSigningPrivateKeysInStorage:i,masterPrivateKeyCached:o,selfSigningPrivateKeyCached:r,userSigningPrivateKeyCached:l,homeserverSupportsCrossSigning:c,crossSigningReady:d})}render(){const e=d.getComponent("elements.AccessibleButton"),{error:t,crossSigningPublicKeysOnDevice:s,crossSigningPrivateKeysInStorage:n,masterPrivateKeyCached:a,selfSigningPrivateKeyCached:o,userSigningPrivateKeyCached:r,homeserverSupportsCrossSigning:c,crossSigningReady:m}=this.state;let h,u;t&&(h=i.a.createElement("div",{className:"error"},t.toString())),u=void 0===c?i.a.createElement(Je.a,null):c?m?i.a.createElement("p",null,"✅ ",Object(l.a)("Cross-signing is ready for use.")):n?i.a.createElement("p",null,Object(l.a)("Your account has a cross-signing identity in secret storage, but it is not yet trusted by this session.")):i.a.createElement("p",null,Object(l.a)("Cross-signing is not set up.")):i.a.createElement("p",null,Object(l.a)("Your homeserver does not support cross-signing."));const p=s||n||a||o||r,g=[];let f;return!(s&&n&&a&&o&&r)&&c&&g.push(i.a.createElement(e,{key:"setup",kind:"primary",onClick:this._onBootstrapClick},Object(l.a)("Set up"))),p&&g.push(i.a.createElement(e,{key:"reset",kind:"danger",onClick:this._resetCrossSigning},Object(l.a)("Reset"))),g.length&&(f=i.a.createElement("div",{className:"mx_CrossSigningPanel_buttonRow"},g)),i.a.createElement("div",null,u,i.a.createElement("details",null,i.a.createElement("summary",null,Object(l.a)("Advanced")),i.a.createElement("table",{className:"mx_CrossSigningPanel_statusList"},i.a.createElement("tbody",null,i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Cross-signing public keys:")),i.a.createElement("td",null,s?Object(l.a)("in memory"):Object(l.a)("not found"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Cross-signing private keys:")),i.a.createElement("td",null,n?Object(l.a)("in secret storage"):Object(l.a)("not found in storage"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Master private key:")),i.a.createElement("td",null,a?Object(l.a)("cached locally"):Object(l.a)("not found locally"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Self signing private key:")),i.a.createElement("td",null,o?Object(l.a)("cached locally"):Object(l.a)("not found locally"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("User signing private key:")),i.a.createElement("td",null,r?Object(l.a)("cached locally"):Object(l.a)("not found locally"))),i.a.createElement("tr",null,i.a.createElement("td",null,Object(l.a)("Homeserver feature support:")),i.a.createElement("td",null,c?Object(l.a)("exists"):Object(l.a)("not found")))))),h,f)}}class dg extends i.a.Component{constructor(e){super(e),this.state={devices:void 0,deviceLoadError:void 0,selectedDevices:[],deleting:!1},this._unmounted=!1,this._renderDevice=this._renderDevice.bind(this),this._onDeviceSelectionToggled=this._onDeviceSelectionToggled.bind(this),this._onDeleteClick=this._onDeleteClick.bind(this)}componentDidMount(){this._loadDevices()}componentWillUnmount(){this._unmounted=!0}_loadDevices(){ee.a.get().getDevices().then(e=>{this._unmounted||this.setState({devices:e.devices||[]})},e=>{if(this._unmounted)return;let t;404==e.httpStatus?t=Object(l.a)("Your homeserver does not support session management."):(console.error("Error loading sessions:",e),t=Object(l.a)("Unable to load session list")),this.setState({deviceLoadError:t})})}_deviceCompare(e,t){const s=(t.last_seen_ts||0)-(e.last_seen_ts||0);if(0!==s)return s;const n=e.device_id,a=t.device_id;return n<a?-1:n>a?1:0}_onDeviceSelectionToggled(e){if(this._unmounted)return;const t=e.device_id;this.setState((e,s)=>{const n=e.selectedDevices.slice(),a=n.indexOf(t);return-1===a?n.push(t):n.splice(a,1),{selectedDevices:n}})}_onDeleteClick(){this.setState({deleting:!0}),this._makeDeleteRequest(null).catch(e=>{if(this._unmounted)return;if(401!==e.httpStatus||!e.data||!e.data.flows)throw e;const t=d.getComponent("dialogs.InteractiveAuthDialog"),s=this.state.selectedDevices.length,n={[Be.c.PHASE_PREAUTH]:{title:Object(l.a)("Use Single Sign On to continue"),body:Object(l.a)("Confirm deleting these sessions by using Single Sign On to prove your identity.",{count:s}),continueText:Object(l.a)("Single Sign On"),continueKind:"primary"},[Be.c.PHASE_POSTAUTH]:{title:Object(l.a)("Confirm deleting these sessions"),body:Object(l.a)("Click the button below to confirm deleting these sessions.",{count:s}),continueText:Object(l.a)("Delete sessions",{count:s}),continueKind:"danger"}};De.a.createTrackedDialog("Delete Device Dialog","",t,{title:Object(l.a)("Authentication"),matrixClient:ee.a.get(),authData:e.data,makeRequest:this._makeDeleteRequest.bind(this),aestheticsForStagePhases:{[Be.c.LOGIN_TYPE]:n,[Be.c.UNSTABLE_LOGIN_TYPE]:n}})}).catch(e=>{console.error("Error deleting sessions",e),this._unmounted}).finally(()=>{this.setState({deleting:!1})})}_makeDeleteRequest(e){return ee.a.get().deleteMultipleDevices(this.state.selectedDevices,e).then(()=>{this.setState({devices:this.state.devices.filter(e=>!this.state.selectedDevices.includes(e.device_id)),selectedDevices:[]})})}_renderDevice(e){const t=d.getComponent("settings.DevicesPanelEntry");return i.a.createElement(t,{key:e.device_id,device:e,selected:this.state.selectedDevices.includes(e.device_id),onDeviceToggled:this._onDeviceSelectionToggled})}render(){const e=d.getComponent("elements.Spinner"),t=d.getComponent("elements.AccessibleButton");if(void 0!==this.state.deviceLoadError){const e=L()(this.props.className,"error");return i.a.createElement("div",{className:e},this.state.deviceLoadError)}const s=this.state.devices;if(void 0===s){const t=this.props.className;return i.a.createElement(e,{className:t})}s.sort(this._deviceCompare);const n=this.state.deleting?i.a.createElement(e,{w:22,h:22}):i.a.createElement(t,{onClick:this._onDeleteClick,kind:"danger_sm"},Object(l.a)("Delete %(count)s sessions",{count:this.state.selectedDevices.length})),a=L()(this.props.className,"mx_DevicesPanel");return i.a.createElement("div",{className:a},i.a.createElement("div",{className:"mx_DevicesPanel_header"},i.a.createElement("div",{className:"mx_DevicesPanel_deviceId"},Object(l.a)("ID")),i.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},Object(l.a)("Public Name")),i.a.createElement("div",{className:"mx_DevicesPanel_deviceLastSeen"},Object(l.a)("Last seen")),i.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},this.state.selectedDevices.length>0?n:null)),s.map(this._renderDevice))}}dg.propTypes={className:xe.a.string};class mg extends i.a.Component{constructor(e){super(e),this._unmounted=!1,this.onDeviceToggled=this.onDeviceToggled.bind(this),this._onDisplayNameChanged=this._onDisplayNameChanged.bind(this)}componentWillUnmount(){this._unmounted=!0}_onDisplayNameChanged(e){const t=this.props.device;return ee.a.get().setDeviceDetails(t.device_id,{display_name:e}).catch(e=>{throw console.error("Error setting session display name",e),new Error(Object(l.a)("Failed to set display name"))})}onDeviceToggled(){this.props.onDeviceToggled(this.props.device)}render(){const e=d.getComponent("elements.EditableTextContainer"),t=this.props.device;let s="";if(t.last_seen_ts){s=Object(kc.a)(new Date(t.last_seen_ts)).toLocaleString()}let n="";return t.device_id===ee.a.get().getDeviceId()&&(n=" mx_DevicesPanel_myDevice"),i.a.createElement("div",{className:"mx_DevicesPanel_device"+n},i.a.createElement("div",{className:"mx_DevicesPanel_deviceId"},t.device_id),i.a.createElement("div",{className:"mx_DevicesPanel_deviceName"},i.a.createElement(e,{initialValue:t.display_name,onSubmit:this._onDisplayNameChanged,placeholder:t.device_id})),i.a.createElement("div",{className:"mx_DevicesPanel_lastSeen"},s),i.a.createElement("div",{className:"mx_DevicesPanel_deviceButtons"},i.a.createElement(He.a,{onChange:this.onDeviceToggled,checked:this.props.selected})))}}mg.propTypes={device:xe.a.object.isRequired,onDeviceToggled:xe.a.func},mg.defaultProps={onDeviceToggled:function(){}};class hg extends i.a.Component{constructor(){super(),I()(this,"updateCurrentRoom",async e=>{const t=cc.a.get();let s;try{s=await t.getStats()}catch{return}this.setState({eventIndexSize:s.size,roomCount:s.roomCount})}),I()(this,"_onManage",async()=>{De.a.createTrackedDialogAsync("Message search","Message search",s.e(22).then(s.bind(null,1510)),{onFinished:()=>{}},null,!1,!0)}),I()(this,"_onEnable",async()=>{this.setState({enabling:!0}),await cc.a.initEventIndex(),await cc.a.get().addInitialCheckpoints(),await cc.a.get().startCrawler(),await F.a.setValue("enableEventIndexing",null,Qe.a.DEVICE,!0),await this.updateState()}),this.state={enabling:!1,eventIndexSize:0,roomCount:0,eventIndexingEnabled:F.a.getValueAt(Qe.a.DEVICE,"enableEventIndexing")}}componentWillUnmount(){const e=cc.a.get();null!==e&&e.removeListener("changedCheckpoint",this.updateCurrentRoom)}async componentDidMount(){this.updateState()}async updateState(){const e=cc.a.get(),t=F.a.getValueAt(Qe.a.DEVICE,"enableEventIndexing");let s=0,n=0;if(null!==e){e.on("changedCheckpoint",this.updateCurrentRoom);try{const t=await e.getStats();s=t.size,n=t.roomCount}catch{}}this.setState({enabling:!1,eventIndexSize:s,roomCount:n,eventIndexingEnabled:t})}render(){let e=null;const t=d.getComponent("elements.InlineSpinner"),s=c.a.get().brand;if(null!==cc.a.get())e=i.a.createElement("div",null,i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Securely cache encrypted messages locally for them to appear in search results, using %(size)s to store messages from %(rooms)s rooms.",{size:Object(q.a)(this.state.eventIndexSize,0),count:this.state.roomCount,rooms:Object(q.d)(this.state.roomCount)})),i.a.createElement("div",null,i.a.createElement(pe.a,{kind:"primary",onClick:this._onManage},Object(l.a)("Manage"))));else if(!this.state.eventIndexingEnabled&&cc.a.supportIsInstalled())e=i.a.createElement("div",null,i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Securely cache encrypted messages locally for them to appear in search results.")),i.a.createElement("div",null,i.a.createElement(pe.a,{kind:"primary",disabled:this.state.enabling,onClick:this._onEnable},Object(l.a)("Enable")),this.state.enabling?i.a.createElement(t,null):i.a.createElement("div",null)));else if(cc.a.platformHasSupport()&&!cc.a.supportIsInstalled()){const t="https://github.com/vector-im/element-web/blob/develop/docs/native-node-modules.md#adding-seshat-for-search-in-e2e-encrypted-rooms";e=i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("%(brand)s is missing some components required for securely caching encrypted messages locally. If you'd like to experiment with this feature, build a custom %(brand)s Desktop with <nativeLink>search components added</nativeLink>.",{brand:s},{nativeLink:e=>i.a.createElement("a",{href:t,target:"_blank",rel:"noreferrer noopener"},e)}))}else e=i.a.createElement("div",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("%(brand)s can't securely cache encrypted messages locally while running in a web browser. Use <desktopLink>%(brand)s Desktop</desktopLink> for encrypted messages to appear in search results.",{brand:s},{desktopLink:e=>i.a.createElement("a",{href:"https://element.io/get-started",target:"_blank",rel:"noreferrer noopener"},e)}));return e}}var ug=s(626);let pg,gg,fg,bg;!function(e){e.AllMessages="all_messages",e.DirectMessagesMentionsKeywords="dm_mentions_keywords",e.MentionsKeywordsOnly="mentions_keywords",e.Never="never"}(pg||(pg={})),function(e){e.Notify="notify",e.DontNotify="dont_notify",e.Coalesce="coalesce",e.MarkUnread="mark_unread"}(gg||(gg={})),function(e){e.Override="override",e.ContentSpecific="content",e.RoomSpecific="room",e.SenderSpecific="sender",e.Underride="underride"}(fg||(fg={})),function(e){e.MasterRule=".m.rule.master",e.MessageRule=".m.rule.message",e.EncryptedMessageRule=".m.rule.encrypted",e.RoomOneToOneRule=".m.rule.room_one_to_one",e.EncryptedRoomOneToOneRule=".m.rule.room_one_to_one"}(bg||(bg={}));class vg{static encodeActions(e){const t=e.notify,s=e.sound,n=e.highlight;if(t){const e=[gg.Notify];return s&&e.push({set_tweak:"sound",value:s}),n?e.push({set_tweak:"highlight"}):e.push({set_tweak:"highlight",value:!1}),e}return[gg.DontNotify]}static decodeActions(e){let t=!1,s=null,n=!1;for(let a=0;a<e.length;++a){const i=e[a];if(i===gg.Notify)t=!0;else if(i===gg.DontNotify)t=!1;else{if("object"!=typeof i)return null;if("sound"===i.set_tweak)s=i.value;else{if("highlight"!==i.set_tweak)return null;n=i.value}}}void 0===n&&(n=!0);const a={notify:t,highlight:n};return null!==s&&(a.sound=s),a}}const _g=vg.encodeActions;class yg{}let Eg;I()(yg,"ACTION_NOTIFY",_g({notify:!0})),I()(yg,"ACTION_NOTIFY_DEFAULT_SOUND",_g({notify:!0,sound:"default"})),I()(yg,"ACTION_NOTIFY_RING_SOUND",_g({notify:!0,sound:"ring"})),I()(yg,"ACTION_HIGHLIGHT",_g({notify:!0,highlight:!0})),I()(yg,"ACTION_HIGHLIGHT_DEFAULT_SOUND",_g({notify:!0,sound:"default",highlight:!0})),I()(yg,"ACTION_DONT_NOTIFY",_g({notify:!1})),I()(yg,"ACTION_DISABLED",null),function(e){e.Off="off",e.On="on",e.Loud="loud"}(Eg||(Eg={}));class Cg{static actionsFor(e){return e===Eg.On?yg.ACTION_NOTIFY:e===Eg.Loud?yg.ACTION_HIGHLIGHT_DEFAULT_SOUND:void 0}static contentRuleVectorStateKind(e){const t=vg.decodeActions(e.actions);if(!t)return null;let s=0;t.sound&&s++,t.highlight&&s++;let n=null;switch(s){case 0:n=Eg.On;break;case 2:n=Eg.Loud}return n}}I()(Cg,"OFF",Eg.Off),I()(Cg,"ON",Eg.On),I()(Cg,"LOUD",Eg.Loud),I()(Cg,"states",Eg);class wg{constructor(e){this.kind=e.kind,this.description=e.description,this.vectorStateToActions=e.vectorStateToActions}ruleToVectorState(e){let t=!1;e&&(t=e.enabled);for(const s in Cg.states){const n=Cg.states[s],a=this.vectorStateToActions[n];if(a){if(t&&JSON.stringify(vg.decodeActions(e.actions))===JSON.stringify(vg.decodeActions(a)))return n}else if(!t)return n}console.error(`Cannot translate rule actions into Vector rule state. Rule: ${JSON.stringify(e)}, Expected: `+JSON.stringify(this.vectorStateToActions))}}const Sg={".m.rule.contains_display_name":new wg({kind:"override",description:Object(l.b)("Messages containing my display name"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_HIGHLIGHT_DEFAULT_SOUND,off:yg.ACTION_DISABLED}}),".m.rule.contains_user_name":new wg({kind:"override",description:Object(l.b)("Messages containing my username"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_HIGHLIGHT_DEFAULT_SOUND,off:yg.ACTION_DISABLED}}),".m.rule.roomnotif":new wg({kind:"override",description:Object(l.b)("Messages containing @room"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_HIGHLIGHT,off:yg.ACTION_DISABLED}}),".m.rule.room_one_to_one":new wg({kind:"underride",description:Object(l.b)("Messages in one-to-one chats"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_NOTIFY_DEFAULT_SOUND,off:yg.ACTION_DONT_NOTIFY}}),".m.rule.encrypted_room_one_to_one":new wg({kind:"underride",description:Object(l.b)("Encrypted messages in one-to-one chats"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_NOTIFY_DEFAULT_SOUND,off:yg.ACTION_DONT_NOTIFY}}),".m.rule.message":new wg({kind:"underride",description:Object(l.b)("Messages in group chats"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_NOTIFY_DEFAULT_SOUND,off:yg.ACTION_DONT_NOTIFY}}),".m.rule.encrypted":new wg({kind:"underride",description:Object(l.b)("Encrypted messages in group chats"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_NOTIFY_DEFAULT_SOUND,off:yg.ACTION_DONT_NOTIFY}}),".m.rule.invite_for_me":new wg({kind:"underride",description:Object(l.b)("When I'm invited to a room"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_NOTIFY_DEFAULT_SOUND,off:yg.ACTION_DISABLED}}),".m.rule.call":new wg({kind:"underride",description:Object(l.b)("Call invitation"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_NOTIFY_RING_SOUND,off:yg.ACTION_DISABLED}}),".m.rule.suppress_notices":new wg({kind:"override",description:Object(l.b)("Messages sent by bot"),vectorStateToActions:{on:yg.ACTION_DISABLED,loud:yg.ACTION_NOTIFY_DEFAULT_SOUND,off:yg.ACTION_DONT_NOTIFY}}),".m.rule.tombstone":new wg({kind:"override",description:Object(l.b)("When rooms are upgraded"),vectorStateToActions:{on:yg.ACTION_NOTIFY,loud:yg.ACTION_HIGHLIGHT,off:yg.ACTION_DISABLED}})};const xg={"im.vector.rule.contains_display_name":".m.rule.contains_display_name","im.vector.rule.room_one_to_one":".m.rule.room_one_to_one","im.vector.rule.room_message":".m.rule.message","im.vector.rule.invite_for_me":".m.rule.invite_for_me","im.vector.rule.call":".m.rule.call","im.vector.rule.notices":".m.rule.suppress_notices"};function Rg(e){const t=vg.decodeActions(e);return null!==t?vg.encodeActions(t):e}class Og extends i.a.Component{constructor(...e){super(...e),I()(this,"state",{phase:Og.phases.LOADING,masterPushRule:void 0,vectorPushRules:[],vectorContentRules:{vectorState:Cg.ON,rules:[]},externalPushRules:[],externalContentRules:[],threepids:[]}),I()(this,"onEnableNotificationsChange",e=>{const t=this;this.setState({phase:Og.phases.LOADING}),ee.a.get().setPushRuleEnabled("global",t.state.masterPushRule.kind,t.state.masterPushRule.rule_id,!e).then((function(){t._refreshFromServer()}))}),I()(this,"onEnableDesktopNotificationsChange",e=>{F.a.setValue("notificationsEnabled",null,Qe.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),I()(this,"onEnableDesktopNotificationBodyChange",e=>{F.a.setValue("notificationBodyEnabled",null,Qe.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),I()(this,"onEnableAudioNotificationsChange",e=>{F.a.setValue("audioNotificationsEnabled",null,Qe.a.DEVICE,e).finally(()=>{this.forceUpdate()})}),I()(this,"onEnableEmailNotificationsChange",(e,t)=>{let s;if(t){const t={};t.brand=c.a.get().brand,s=ee.a.get().setPusher({kind:"email",app_id:"m.email",pushkey:e,app_display_name:"Email Notifications",device_display_name:e,lang:navigator.language,data:t,append:!0})}else{const t=this.getEmailPusher(this.state.pushers,e);t.kind=null,s=ee.a.get().setPusher(t)}s.then(()=>{this._refreshFromServer()},e=>{const t=d.getComponent("dialogs.ErrorDialog");De.a.createTrackedDialog("Error saving email notification preferences","",t,{title:Object(l.a)("Error saving email notification preferences"),description:Object(l.a)("An error occurred whilst saving your email notification preferences.")})})}),I()(this,"onNotifStateButtonClicked",e=>{const t=e.target.className.split("-")[0],s=e.target.className.split("-")[1];if("_keywords"===t)this._setKeywordsPushRuleVectorState(s);else{const e=this.getRule(t);e&&this._setPushRuleVectorState(e,s)}}),I()(this,"onKeywordsClicked",e=>{let t=[];for(const e in this.state.vectorContentRules.rules){const s=this.state.vectorContentRules.rules[e];t.push(s.pattern)}t.length?(t.sort(),t=t.join(", ")):t="";const s=d.getComponent("dialogs.TextInputDialog");De.a.createTrackedDialog("Keywords Dialog","",s,{title:Object(l.a)("Keywords"),description:Object(l.a)("Enter keywords separated by a comma:"),button:Object(l.a)("OK"),value:t,onFinished:(e,s)=>{if(e&&s!==t){let e=s.split(",");for(const t in e)e[t]=e[t].trim();e=e.reduce((function(e,t){return""!==t&&e.indexOf(t)<0&&e.push(t),e}),[]),this._setKeywords(e)}}})}),I()(this,"_refreshFromServer",()=>{const e=this,t=ee.a.get().getPushRules().then(e._portRulesToNewAPI).then((function(t){ee.a.get().pushRules=t;const s={".m.rule.master":"master",".m.rule.contains_display_name":"vector",".m.rule.contains_user_name":"vector",".m.rule.roomnotif":"vector",".m.rule.room_one_to_one":"vector",".m.rule.encrypted_room_one_to_one":"vector",".m.rule.message":"vector",".m.rule.encrypted":"vector",".m.rule.invite_for_me":"vector",".m.rule.call":"vector",".m.rule.suppress_notices":"vector",".m.rule.tombstone":"vector"},n={master:[],vector:{},others:[]};for(const e in t.global)for(let a=0;a<Object.keys(t.global[e]).length;++a){const i=t.global[e][a],o=s[i.rule_id];i.kind=e,"."===i.rule_id[0]&&("vector"===o?n.vector[i.rule_id]=i:"master"===o?n.master.push(i):n.others.push(i))}n.master.length>0&&(e.state.masterPushRule=n.master[0]);const a=class{static parseContentRules(e){const t=this._categoriseContentRules(e);return t.loud.length?{vectorState:Eg.Loud,rules:t.loud,externalRules:[...t.loud_but_disabled,...t.on,...t.on_but_disabled,...t.other]}:t.loud_but_disabled.length?{vectorState:Eg.Off,rules:t.loud_but_disabled,externalRules:[...t.on,...t.on_but_disabled,...t.other]}:t.on.length?{vectorState:Eg.On,rules:t.on,externalRules:[...t.on_but_disabled,...t.other]}:t.on_but_disabled.length?{vectorState:Eg.Off,rules:t.on_but_disabled,externalRules:t.other}:{vectorState:Eg.On,rules:[],externalRules:t.other}}static _categoriseContentRules(e){const t={on:[],on_but_disabled:[],loud:[],loud_but_disabled:[],other:[]};for(const s in e.global)for(let n=0;n<Object.keys(e.global[s]).length;++n){const a=e.global[s][n];if("."!==a.rule_id[0]&&"content"===s)switch(a.kind=s,Cg.contentRuleVectorStateKind(a)){case Eg.On:a.enabled?t.on.push(a):t.on_but_disabled.push(a);break;case Eg.Loud:a.enabled?t.loud.push(a):t.loud_but_disabled.push(a);break;default:t.other.push(a)}}return t}}.parseContentRules(t);e.state.vectorContentRules={vectorState:a.vectorState,rules:a.rules},e.state.externalContentRules=a.externalRules,e.state.vectorPushRules=[],e.state.externalPushRules=[];const o=[".m.rule.contains_display_name",".m.rule.contains_user_name",".m.rule.roomnotif","_keywords",".m.rule.room_one_to_one",".m.rule.encrypted_room_one_to_one",".m.rule.message",".m.rule.encrypted",".m.rule.invite_for_me",".m.rule.call",".m.rule.suppress_notices",".m.rule.tombstone"];for(const t in o){const s=o[t];if("_keywords"===s)e.state.vectorPushRules.push({vectorRuleId:"_keywords",description:i.a.createElement("span",null,Object(l.a)("Messages containing <span>keywords</span>",{},{span:t=>i.a.createElement("span",{className:"mx_UserNotifSettings_keywords",onClick:e.onKeywordsClicked},t)})),vectorState:e.state.vectorContentRules.vectorState});else{const t=Sg[s],a=n.vector[s],i=t.ruleToVectorState(a);e.state.vectorPushRules.push({vectorRuleId:s,description:Object(l.a)(t.description),rule:a,vectorState:i}),a&&!i&&(a.description=t.description,e.state.externalPushRules.push(a))}}const r={".m.rule.message":Object(l.a)("Notify for all other messages/rooms"),".m.rule.fallback":Object(l.a)("Notify me for anything else")};for(const t in n.others){const s=n.others[t],a=r[s.rule_id];a&&s.enabled&&!s.default&&(s.description=a,e.state.externalPushRules.push(s))}})),s=ee.a.get().getPushers().then((function(t){e.setState({pushers:t.pushers})}));Promise.all([t,s]).then((function(){e.setState({phase:Og.phases.DISPLAY})}),(function(t){console.error(t),e.setState({phase:Og.phases.ERROR})})).finally(()=>{e.setState({masterPushRule:e.state.masterPushRule,vectorContentRules:e.state.vectorContentRules,vectorPushRules:e.state.vectorPushRules,externalContentRules:e.state.externalContentRules,externalPushRules:e.state.externalPushRules})}),ee.a.get().getThreePids().then(e=>this.setState({threepids:e.threepids}))}),I()(this,"_onClearNotifications",()=>{const e=ee.a.get();e.getRooms().forEach(t=>{if(t.getUnreadNotificationCount()>0){const s=t.getLiveTimeline().getEvents();s.length&&e.sendReadReceipt(s.pop())}})})}componentDidMount(){this._refreshFromServer()}getEmailPusher(e,t){if(void 0!==e)for(let s=0;s<e.length;++s)if("email"===e[s].kind&&e[s].pushkey===t)return e[s]}getRule(e){for(const t in this.state.vectorPushRules){const s=this.state.vectorPushRules[t];if(s.vectorRuleId===e)return s}}_setPushRuleVectorState(e,t){if(e&&e.vectorState!==t){this.setState({phase:Og.phases.LOADING});const s=this,n=ee.a.get(),a=[],i=Sg[e.vectorRuleId];if(e.rule){const s=i.vectorStateToActions[t];s?a.push(this._updatePushRuleActions(e.rule,s,!0)):a.push(n.setPushRuleEnabled("global",e.rule.kind,e.rule.rule_id,!1))}Promise.all(a).then((function(){s._refreshFromServer()}),(function(e){const t=d.getComponent("dialogs.ErrorDialog");console.error("Failed to change settings: "+e),De.a.createTrackedDialog("Failed to change settings","",t,{title:Object(l.a)("Failed to change settings"),description:e&&e.message?e.message:Object(l.a)("Operation failed"),onFinished:s._refreshFromServer})}))}}_setKeywordsPushRuleVectorState(e){if(this.state.vectorContentRules.vectorState===e||0===this.state.vectorContentRules.rules.length)return;const t=this,s=ee.a.get();this.setState({phase:Og.phases.LOADING});const n=[];for(const t in this.state.vectorContentRules.rules){const a=this.state.vectorContentRules.rules[t];let i,o;switch(e){case Cg.ON:1!==a.actions.length&&(o=Cg.actionsFor(Cg.ON)),this.state.vectorContentRules.vectorState===Cg.OFF&&(i=!0);break;case Cg.LOUD:3!==a.actions.length&&(o=Cg.actionsFor(Cg.LOUD)),this.state.vectorContentRules.vectorState===Cg.OFF&&(i=!0);break;case Cg.OFF:i=!1}o?n.push(this._updatePushRuleActions(a,o,i)):null!=i&&n.push(s.setPushRuleEnabled("global",a.kind,a.rule_id,i))}Promise.all(n).then((function(e){t._refreshFromServer()}),(function(e){const s=d.getComponent("dialogs.ErrorDialog");console.error("Can't update user notification settings: "+e),De.a.createTrackedDialog("Can't update user notifcation settings","",s,{title:Object(l.a)("Can't update user notification settings"),description:e&&e.message?e.message:Object(l.a)("Operation failed"),onFinished:t._refreshFromServer})}))}_setKeywords(e){this.setState({phase:Og.phases.LOADING});const t=this,s=ee.a.get(),n=[],a=[];for(const i in t.state.vectorContentRules.rules){const o=t.state.vectorContentRules.rules[i];a.push(o.pattern),e.indexOf(o.pattern)<0&&n.push(s.deletePushRule("global",o.kind,o.rule_id))}for(const a in t.state.externalContentRules){const i=t.state.externalContentRules[a];e.indexOf(i.pattern)>=0&&n.push(s.deletePushRule("global",i.kind,i.rule_id))}const i=function(e){const s=d.getComponent("dialogs.ErrorDialog");console.error("Failed to update keywords: "+e),De.a.createTrackedDialog("Failed to update keywords","",s,{title:Object(l.a)("Failed to update keywords"),description:e&&e.message?e.message:Object(l.a)("Operation failed"),onFinished:t._refreshFromServer})};Promise.all(n).then((function(n){const o=[];let r=t.state.vectorContentRules.vectorState;r===Cg.OFF&&(r=t.state.vectorContentRules.rules.length?Cg.contentRuleVectorStateKind(t.state.vectorContentRules.rules[0]):Cg.ON);for(const n in e){const i=e[n];a.indexOf(i)<0&&(t.state.vectorContentRules.vectorState!==Cg.OFF?o.push(s.addPushRule("global","content",i,{actions:Cg.actionsFor(r),pattern:i})):o.push(t._addDisabledPushRule("global","content",i,{actions:Cg.actionsFor(r),pattern:i})))}Promise.all(o).then((function(e){t._refreshFromServer()}),i)}),i)}_addDisabledPushRule(e,t,s,n){const a=ee.a.get();return a.addPushRule(e,t,s,n).then(()=>a.setPushRuleEnabled(e,t,s,!1))}_portRulesToNewAPI(e){const t=[],s=ee.a.get();for(const n in e.global){const a=e.global[n];for(let e=0;e<a.length;++e){const i=a[e];i.rule_id in xg&&(console.log("Porting legacy rule",i),t.push(function(e,t){return s.setPushRuleActions("global",e,xg[t.rule_id],Rg(t.actions)).then(()=>s.deletePushRule("global",e,t.rule_id)).catch(e=>{console.warn("Error when porting legacy rule: "+e)})}(n,i)))}}return t.length>0?Promise.all(t).then(()=>s.getPushRules()):e}_updatePushRuleActions(e,t,s){const n=ee.a.get();return n.setPushRuleActions("global",e.kind,e.rule_id,t).then((function(){if(null!=s)return n.setPushRuleEnabled("global",e.kind,e.rule_id,s)}))}renderNotifRulesTableRow(e,t,s){return i.a.createElement("tr",{key:t},i.a.createElement("th",null,e),i.a.createElement("th",null,i.a.createElement("input",{className:t+"-"+Cg.OFF,type:"radio",checked:s===Cg.OFF,onChange:this.onNotifStateButtonClicked})),i.a.createElement("th",null,i.a.createElement("input",{className:t+"-"+Cg.ON,type:"radio",checked:s===Cg.ON,onChange:this.onNotifStateButtonClicked})),i.a.createElement("th",null,i.a.createElement("input",{className:t+"-"+Cg.LOUD,type:"radio",checked:s===Cg.LOUD,onChange:this.onNotifStateButtonClicked})))}renderNotifRulesTableRows(){const e=[];for(const t in this.state.vectorPushRules){const s=this.state.vectorPushRules[t];void 0===s.rule&&s.vectorRuleId.startsWith(".m.")?console.warn(`Skipping render of rule ${s.vectorRuleId} due to no underlying rule`):e.push(this.renderNotifRulesTableRow(s.description,s.vectorRuleId,s.vectorState))}return e}hasEmailPusher(e,t){if(void 0===e)return!1;for(let s=0;s<e.length;++s)if("email"===e[s].kind&&e[s].pushkey===t)return!0;return!1}emailNotificationsRow(e,t){return i.a.createElement(Ze.a,{value:this.hasEmailPusher(this.state.pushers,e),onChange:this.onEnableEmailNotificationsChange.bind(this,e),label:t,key:"emailNotif_"+t})}render(){let e,t,s;if(this.state.phase===Og.phases.LOADING){const t=d.getComponent("elements.Spinner");e=i.a.createElement(t,null)}if(this.state.masterPushRule&&(t=i.a.createElement(Ze.a,{value:!this.state.masterPushRule.enabled,onChange:this.onEnableNotificationsChange,label:Object(l.a)("Enable notifications for this account")})),ee.a.get().getRooms().some(e=>e.getUnreadNotificationCount()>0)&&(s=i.a.createElement(pe.a,{onClick:this._onClearNotifications,kind:"danger"},Object(l.a)("Clear notifications"))),this.state.masterPushRule&&this.state.masterPushRule.enabled)return i.a.createElement("div",null,t,i.a.createElement("div",{className:"mx_UserNotifSettings_notifTable"},Object(l.a)("All notifications are currently disabled for all targets.")),s);const n=this.state.threepids.filter(e=>"email"===e.medium);let a;n.length>0?a=n.map(e=>this.emailNotificationsRow(e.address,`${Object(l.a)("Enable email notifications")} (${e.address})`)):F.a.getValue(Xe.a.ThirdPartyID)&&(a=i.a.createElement("div",null,Object(l.a)("Add an email address to configure email notifications")));const o=[];for(const e in this.state.externalPushRules){const t=this.state.externalPushRules[e];o.push(i.a.createElement("li",null,Object(l.a)(t.description)))}let r,m,h=[];for(const e in this.state.externalContentRules){const t=this.state.externalContentRules[e];h.push(t.pattern)}if(h.length&&(h=h.join(", "),o.push(i.a.createElement("li",null,Object(l.a)("Notifications on the following keywords follow rules which can’t be displayed here:"),h))),void 0===this.state.pushers)r=i.a.createElement("div",{className:"error"},Object(l.a)("Unable to fetch notification target list"));else if(0===this.state.pushers.length)r=null;else{const e=[];for(let t=0;t<this.state.pushers.length;++t)e.push(i.a.createElement("tr",{key:t},i.a.createElement("td",null,this.state.pushers[t].app_display_name),i.a.createElement("td",null,this.state.pushers[t].device_display_name)));r=i.a.createElement("table",{className:"mx_UserNotifSettings_devicesTable"},i.a.createElement("tbody",null,e))}if(r&&(r=i.a.createElement("div",null,i.a.createElement("h3",null,Object(l.a)("Notification targets")),r)),o.length){const e=c.a.get().brand;m=i.a.createElement("div",null,i.a.createElement("h3",null,Object(l.a)("Advanced notification settings")),Object(l.a)("There are advanced notifications which are not shown here."),i.a.createElement("br",null),Object(l.a)("You might have configured them in a client other than %(brand)s. You cannot tune them in %(brand)s but they still apply.",{brand:e}),i.a.createElement("ul",null,o))}return i.a.createElement("div",null,t,i.a.createElement("div",{className:"mx_UserNotifSettings_notifTable"},e,i.a.createElement(Ze.a,{value:F.a.getValue("notificationsEnabled"),onChange:this.onEnableDesktopNotificationsChange,label:Object(l.a)("Enable desktop notifications for this session")}),i.a.createElement(Ze.a,{value:F.a.getValue("notificationBodyEnabled"),onChange:this.onEnableDesktopNotificationBodyChange,label:Object(l.a)("Show message in desktop notification")}),i.a.createElement(Ze.a,{value:F.a.getValue("audioNotificationsEnabled"),onChange:this.onEnableAudioNotificationsChange,label:Object(l.a)("Enable audible notifications for this session")}),a,i.a.createElement("div",{className:"mx_UserNotifSettings_pushRulesTableWrapper"},i.a.createElement("table",{className:"mx_UserNotifSettings_pushRulesTable"},i.a.createElement("thead",null,i.a.createElement("tr",null,i.a.createElement("th",{width:"55%"}),i.a.createElement("th",{width:"15%"},Object(l.a)("Off")),i.a.createElement("th",{width:"15%"},Object(l.a)("On")),i.a.createElement("th",{width:"15%"},Object(l.a)("Noisy")))),i.a.createElement("tbody",null,this.renderNotifRulesTableRows()))),m,r,s))}}I()(Og,"phases",{LOADING:"LOADING",DISPLAY:"DISPLAY",ERROR:"ERROR"});class kg extends i.a.Component{constructor(){super(),I()(this,"onAction",e=>{"id_server_changed"===e.action&&this.setState({currentClientIdServer:ee.a.get().getIdentityServerUrl()})}),I()(this,"_onIdentityServerChanged",e=>{const t=e.target.value;this.setState({idServer:t})}),I()(this,"_getTooltip",()=>{if(this.state.checking){const e=d.getComponent("views.elements.InlineSpinner");return i.a.createElement("div",null,i.a.createElement(e,null),Object(l.a)("Checking server"))}return this.state.error?i.a.createElement("span",{className:"warning"},this.state.error):null}),I()(this,"_idServerChangeEnabled",()=>!!this.state.idServer&&!this.state.busy),I()(this,"_saveIdServer",e=>{ee.a.get().setAccountData("m.identity_server",{base_url:e}),this.setState({busy:!1,error:null,currentClientIdServer:e,idServer:""})}),I()(this,"_checkIdServer",async e=>{e.preventDefault();const{idServer:t,currentClientIdServer:s}=this.state;this.setState({busy:!0,checking:!0,error:null});const n=Object($e.b)(t);let a=await async function(e){if("https:"!==Te.a.parse(e).protocol)return Object(l.a)("Identity Server URL must be HTTPS");try{const t=await fetch(e+"/_matrix/identity/api/v1");return t.ok?null:t.status<200||t.status>=300?Object(l.a)("Not a valid Identity Server (status code %(code)s)",{code:t.status}):Object(l.a)("Could not connect to Identity Server")}catch(e){return Object(l.a)("Could not connect to Identity Server")}}(n);if(!a)try{this.setState({checking:!1});const e=new ze.a(n);await e.getAccessToken();let a=!0;if(!await Object(hr.b)(n)){const[e]=await this._showNoTermsWarning(n);a=e}if(a&&s&&n!==s){const[e]=await this._showServerChangeWarning({title:Object(l.a)("Change identity server"),unboundMessage:Object(l.a)("Disconnect from the identity server <current /> and connect to <new /> instead?",{},{current:e=>i.a.createElement("b",null,Object($e.a)(s)),new:e=>i.a.createElement("b",null,Object($e.a)(t))}),button:Object(l.a)("Continue")});a=e}a&&this._saveIdServer(n)}catch(e){console.error(e),a=Object(l.a)("Terms of service not accepted or the identity server is invalid.")}this.setState({busy:!1,checking:!1,error:a,currentClientIdServer:ee.a.get().getIdentityServerUrl()})}),I()(this,"_onDisconnectClicked",async()=>{this.setState({disconnectBusy:!0});try{const[e]=await this._showServerChangeWarning({title:Object(l.a)("Disconnect identity server"),unboundMessage:Object(l.a)("Disconnect from the identity server <idserver />?",{},{idserver:e=>i.a.createElement("b",null,Object($e.a)(this.state.currentClientIdServer))}),button:Object(l.a)("Disconnect")});e&&this._disconnectIdServer()}finally{this.setState({disconnectBusy:!1})}}),I()(this,"_disconnectIdServer",()=>{ee.a.get().setAccountData("m.identity_server",{base_url:null});let e="";Object(hr.c)()&&(e=Object($e.a)(Object(hr.c)())),this.setState({busy:!1,error:null,currentClientIdServer:ee.a.get().getIdentityServerUrl(),idServer:e})});let e="";!ee.a.get().getIdentityServerUrl()&&Object(hr.c)()&&(e=Object($e.a)(Object(hr.c)())),this.state={defaultIdServer:e,currentClientIdServer:ee.a.get().getIdentityServerUrl(),idServer:"",error:null,busy:!1,disconnectBusy:!1,checking:!1}}componentDidMount(){this.dispatcherRef=m.a.register(this.onAction)}componentWillUnmount(){m.a.unregister(this.dispatcherRef)}_showNoTermsWarning(e){const t=d.getComponent("views.dialogs.QuestionDialog"),{finished:s}=De.a.createTrackedDialog("No Terms Warning","",t,{title:Object(l.a)("Identity server has no terms of service"),description:i.a.createElement("div",null,i.a.createElement("span",{className:"warning"},Object(l.a)("The identity server you have chosen does not have any terms of service.")),i.a.createElement("span",null," ",Object(l.a)("Only continue if you trust the owner of the server."))),button:Object(l.a)("Continue")});return s}async _showServerChangeWarning({title:e,unboundMessage:t,button:s}){const{currentClientIdServer:n}=this.state;let a=[],o=!0;try{a=await Object(Et.e)(Ye(ee.a.get()),Promise.reject(new Error("Timeout attempting to reach identity server")),1e4)}catch(e){o=!1,console.warn(`Unable to reach identity server at ${n} to check for 3PIDs during IS change flow`),console.warn(e)}const r=a.filter(e=>e.bound);let c,m=!1;const h={idserver:e=>i.a.createElement("b",null,Object($e.a)(n)),b:e=>i.a.createElement("b",null,e)};o?r.length?(c=i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("You are still <b>sharing your personal data</b> on the identity server <idserver />.",{},h)),i.a.createElement("p",null,Object(l.a)("We recommend that you remove your email addresses and phone numbers from the identity server before disconnecting."))),m=!0,s=Object(l.a)("Disconnect anyway")):c=t:(c=i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("You should <b>remove your personal data</b> from identity server <idserver /> before disconnecting. Unfortunately, identity server <idserver /> is currently offline or cannot be reached.",{},h)),i.a.createElement("p",null,Object(l.a)("You should:")),i.a.createElement("ul",null,i.a.createElement("li",null,Object(l.a)("check your browser plugins for anything that might block the identity server (such as Privacy Badger)")),i.a.createElement("li",null,Object(l.a)("contact the administrators of identity server <idserver />",{},{idserver:h.idserver})),i.a.createElement("li",null,Object(l.a)("wait and try again later")))),m=!0,s=Object(l.a)("Disconnect anyway"));const u=d.getComponent("dialogs.QuestionDialog"),{finished:p}=De.a.createTrackedDialog("Identity Server Bound Warning","",u,{title:e,description:c,button:s,cancelButton:Object(l.a)("Go back"),danger:m});return p}render(){const e=d.getComponent("views.elements.AccessibleButton"),t=d.getComponent("elements.Field"),s=this.state.currentClientIdServer;let n,a,o;if(s?(n=Object(l.a)("Identity Server (%(server)s)",{server:Object($e.a)(s)}),a=Object(l.a)("You are currently using <server></server> to discover and be discoverable by existing contacts you know. You can change your identity server below.",{},{server:e=>i.a.createElement("b",null,Object($e.a)(s))}),this.props.missingTerms&&(a=Object(l.a)("If you don't want to use <server /> to discover and be discoverable by existing contacts you know, enter another identity server below.",{},{server:e=>i.a.createElement("b",null,Object($e.a)(s))}))):(n=Object(l.a)("Identity Server"),a=Object(l.a)("You are not currently using an identity server. To discover and be discoverable by existing contacts you know, add one below.")),s){let t=Object(l.a)("Disconnect"),s=Object(l.a)("Disconnecting from your identity server will mean you won't be discoverable by other users and you won't be able to invite others by email or phone.");if(this.props.missingTerms&&(s=Object(l.a)("Using an identity server is optional. If you choose not to use an identity server, you won't be discoverable by other users and you won't be able to invite others by email or phone."),t=Object(l.a)("Do not use an identity server")),this.state.disconnectBusy){const e=d.getComponent("views.elements.InlineSpinner");t=i.a.createElement(e,null)}o=i.a.createElement("div",null,i.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},s),i.a.createElement(e,{onClick:this._onDisconnectClicked,kind:"danger_sm"},t))}return i.a.createElement("form",{className:"mx_SettingsTab_section mx_SetIdServer",onSubmit:this._checkIdServer},i.a.createElement("span",{className:"mx_SettingsTab_subheading"},n),i.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},a),i.a.createElement(t,{label:Object(l.a)("Enter a new identity server"),type:"text",autoComplete:"off",placeholder:this.state.defaultIdServer,value:this.state.idServer,onChange:this._onIdentityServerChanged,tooltipContent:this._getTooltip(),tooltipClassName:"mx_SetIdServer_tooltip",disabled:this.state.busy,forceValidity:!this.state.error&&null}),i.a.createElement(e,{type:"submit",kind:"primary_sm",onClick:this._checkIdServer,disabled:!this._idServerChangeEnabled()},Object(l.a)("Change")),o)}}I()(kg,"propTypes",{missingTerms:xe.a.bool});class Ig extends i.a.Component{constructor(){super(),I()(this,"onProvisioningToggled",()=>{const e=this.state.provisioningEnabled;F.a.setValue("integrationProvisioning",null,Qe.a.ACCOUNT,!e).catch(t=>{console.error("Error changing integration manager provisioning"),console.error(t),this.setState({provisioningEnabled:e})}),this.setState({provisioningEnabled:!e})});const e=Cp.a.sharedInstance().getPrimaryManager();this.state={currentManager:e,provisioningEnabled:F.a.getValue("integrationProvisioning")}}render(){const e=d.getComponent("views.elements.ToggleSwitch"),t=this.state.currentManager;let s,n;return t?(s=`(${t.name})`,n=Object(l.a)("Use an Integration Manager <b>(%(serverName)s)</b> to manage bots, widgets, and sticker packs.",{serverName:t.name},{b:e=>i.a.createElement("b",null,e)})):n=Object(l.a)("Use an Integration Manager to manage bots, widgets, and sticker packs."),i.a.createElement("div",{className:"mx_SetIntegrationManager"},i.a.createElement("div",{className:"mx_SettingsTab_heading"},i.a.createElement("span",null,Object(l.a)("Manage integrations")),i.a.createElement("span",{className:"mx_SettingsTab_subheading"},s),i.a.createElement(e,{checked:this.state.provisioningEnabled,onChange:this.onProvisioningToggled})),i.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},n,i.a.createElement("br",null),i.a.createElement("br",null),Object(l.a)("Integration Managers receive configuration data, and can modify widgets, send room invites, and set power levels on your behalf.")))}}class Tg extends i.a.Component{constructor(){super(),I()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),I()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),I()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),ee.a.get().deleteThreePid(this.props.email.medium,this.props.email.address).then(()=>this.props.onRemoved(this.props.email)).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to remove contact information: "+e),De.a.createTrackedDialog("Remove 3pid failed","",t,{title:Object(l.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?i.a.createElement("div",{className:"mx_ExistingEmailAddress"},i.a.createElement("span",{className:"mx_ExistingEmailAddress_promptText"},Object(l.a)("Remove %(email)s?",{email:this.props.email.address})),i.a.createElement(pe.a,{onClick:this._onActuallyRemove,kind:"danger_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(l.a)("Remove")),i.a.createElement(pe.a,{onClick:this._onDontRemove,kind:"link_sm",className:"mx_ExistingEmailAddress_confirmBtn"},Object(l.a)("Cancel"))):i.a.createElement("div",{className:"mx_ExistingEmailAddress"},i.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},this.props.email.address),i.a.createElement(pe.a,{onClick:this._onRemove,kind:"danger_sm"},Object(l.a)("Remove")))}}I()(Tg,"propTypes",{email:xe.a.object.isRequired,onRemoved:xe.a.func.isRequired});class jg extends i.a.Component{constructor(e){super(e),I()(this,"_onRemoved",e=>{const t=this.props.emails.filter(t=>t!==e);this.props.onEmailsChange(t)}),I()(this,"_onChangeNewEmailAddress",e=>{this.setState({newEmailAddress:e.target.value})}),I()(this,"_onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newEmailAddress)return;const t=d.getComponent("dialogs.ErrorDialog"),s=this.state.newEmailAddress;if(!wa.a(s))return void De.a.createTrackedDialog("Invalid email address","",t,{title:Object(l.a)("Invalid Email Address"),description:Object(l.a)("This doesn't appear to be a valid email address")});const n=new Zm;this.setState({verifying:!0,continueDisabled:!0,addTask:n}),n.addEmailAddress(s).then(()=>{this.setState({continueDisabled:!1})}).catch(e=>{console.error("Unable to add email address "+s+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),De.a.createTrackedDialog("Unable to add email address","",t,{title:Object(l.a)("Unable to add email address"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}),I()(this,"_onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0}),this.state.addTask.checkEmailLinkClicked().then(()=>{const e=this.state.newEmailAddress;this.setState({addTask:null,continueDisabled:!1,verifying:!1,newEmailAddress:""});const t=[...this.props.emails,{address:e,medium:"email"}];this.props.onEmailsChange(t)}).catch(e=>{this.setState({continueDisabled:!1});const t=d.getComponent("dialogs.ErrorDialog");"M_THREEPID_AUTH_FAILED"===e.errcode?De.a.createTrackedDialog("Email hasn't been verified yet","",t,{title:Object(l.a)("Your email address hasn't been verified yet"),description:Object(l.a)("Click the link in the email you received to verify and then click continue again.")}):(console.error("Unable to verify email address: ",e),De.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(l.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(l.a)("Operation failed")}))})}),this.state={verifying:!1,addTask:null,continueDisabled:!1,newEmailAddress:""}}render(){const e=this.props.emails.map(e=>i.a.createElement(Tg,{email:e,onRemoved:this._onRemoved,key:e.address}));let t=i.a.createElement(pe.a,{onClick:this._onAddClick,kind:"primary"},Object(l.a)("Add"));return this.state.verifying&&(t=i.a.createElement("div",null,i.a.createElement("div",null,Object(l.a)("We've sent you an email to verify your address. Please follow the instructions there and then click the button below.")),i.a.createElement(pe.a,{onClick:this._onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(l.a)("Continue")))),i.a.createElement("div",{className:"mx_EmailAddresses"},e,i.a.createElement("form",{onSubmit:this._onAddClick,autoComplete:"off",noValidate:!0,className:"mx_EmailAddresses_new"},i.a.createElement(ke.a,{type:"text",label:Object(l.a)("Email Address"),autoComplete:"off",disabled:this.state.verifying,value:this.state.newEmailAddress,onChange:this._onChangeNewEmailAddress}),t))}}I()(jg,"propTypes",{emails:xe.a.array.isRequired,onEmailsChange:xe.a.func.isRequired});class Ng extends i.a.Component{constructor(){super(),I()(this,"_onRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!0})}),I()(this,"_onDontRemove",e=>{e.stopPropagation(),e.preventDefault(),this.setState({verifyRemove:!1})}),I()(this,"_onActuallyRemove",e=>{e.stopPropagation(),e.preventDefault(),ee.a.get().deleteThreePid(this.props.msisdn.medium,this.props.msisdn.address).then(()=>this.props.onRemoved(this.props.msisdn)).catch(e=>{const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to remove contact information: "+e),De.a.createTrackedDialog("Remove 3pid failed","",t,{title:Object(l.a)("Unable to remove contact information"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}),this.state={verifyRemove:!1}}render(){return this.state.verifyRemove?i.a.createElement("div",{className:"mx_ExistingPhoneNumber"},i.a.createElement("span",{className:"mx_ExistingPhoneNumber_promptText"},Object(l.a)("Remove %(phone)s?",{phone:this.props.msisdn.address})),i.a.createElement(pe.a,{onClick:this._onActuallyRemove,kind:"danger_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(l.a)("Remove")),i.a.createElement(pe.a,{onClick:this._onDontRemove,kind:"link_sm",className:"mx_ExistingPhoneNumber_confirmBtn"},Object(l.a)("Cancel"))):i.a.createElement("div",{className:"mx_ExistingPhoneNumber"},i.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",this.props.msisdn.address),i.a.createElement(pe.a,{onClick:this._onRemove,kind:"danger_sm"},Object(l.a)("Remove")))}}I()(Ng,"propTypes",{msisdn:xe.a.object.isRequired,onRemoved:xe.a.func.isRequired});class Pg extends i.a.Component{constructor(e){super(e),I()(this,"_onRemoved",e=>{const t=this.props.msisdns.filter(t=>t!==e);this.props.onMsisdnsChange(t)}),I()(this,"_onChangeNewPhoneNumber",e=>{this.setState({newPhoneNumber:e.target.value})}),I()(this,"_onChangeNewPhoneNumberCode",e=>{this.setState({newPhoneNumberCode:e.target.value})}),I()(this,"_onAddClick",e=>{if(e.stopPropagation(),e.preventDefault(),!this.state.newPhoneNumber)return;const t=d.getComponent("dialogs.ErrorDialog"),s=this.state.newPhoneNumber,n=this.state.phoneCountry,a=new Zm;this.setState({verifying:!0,continueDisabled:!0,addTask:a}),a.addMsisdn(n,s).then(e=>{this.setState({continueDisabled:!1,verifyMsisdn:e.msisdn})}).catch(e=>{console.error("Unable to add phone number "+s+" "+e),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),De.a.createTrackedDialog("Add Phone Number Error","",t,{title:Object(l.a)("Error"),description:e&&e.message?e.message:Object(l.a)("Operation failed")})})}),I()(this,"_onContinueClick",e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.newPhoneNumberCode,s=this.state.verifyMsisdn;this.state.addTask.haveMsisdnToken(t).then(()=>{this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyMsisdn:"",verifyError:null,newPhoneNumber:"",newPhoneNumberCode:""});const e=[...this.props.msisdns,{address:s,medium:"msisdn"}];this.props.onMsisdnsChange(e)}).catch(e=>{if(this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode){const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify phone number: "+e),De.a.createTrackedDialog("Unable to verify phone number","",t,{title:Object(l.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}else this.setState({verifyError:Object(l.a)("Incorrect verification code")})})}),I()(this,"_onCountryChanged",e=>{this.setState({phoneCountry:e.iso2})}),this.state={verifying:!1,verifyError:!1,verifyMsisdn:"",addTask:null,continueDisabled:!1,phoneCountry:"",newPhoneNumber:"",newPhoneNumberCode:""}}render(){const e=this.props.msisdns.map(e=>i.a.createElement(Ng,{msisdn:e,onRemoved:this._onRemoved,key:e.address}));let t=i.a.createElement(pe.a,{onClick:this._onAddClick,kind:"primary"},Object(l.a)("Add"));if(this.state.verifying){const e=this.state.verifyMsisdn;t=i.a.createElement("div",null,i.a.createElement("div",null,Object(l.a)("A text message has been sent to +%(msisdn)s. Please enter the verification code it contains.",{msisdn:e}),i.a.createElement("br",null),this.state.verifyError),i.a.createElement("form",{onSubmit:this._onContinueClick,autoComplete:"off",noValidate:!0},i.a.createElement(ke.a,{type:"text",label:Object(l.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.newPhoneNumberCode,onChange:this._onChangeNewPhoneNumberCode}),i.a.createElement(pe.a,{onClick:this._onContinueClick,kind:"primary",disabled:this.state.continueDisabled},Object(l.a)("Continue"))))}const s=i.a.createElement(Ia,{onOptionChange:this._onCountryChanged,className:"mx_PhoneNumbers_country",value:this.state.phoneCountry,disabled:this.state.verifying,isSmall:!0,showPrefix:!0});return i.a.createElement("div",{className:"mx_PhoneNumbers"},e,i.a.createElement("form",{onSubmit:this._onAddClick,autoComplete:"off",noValidate:!0,className:"mx_PhoneNumbers_new"},i.a.createElement("div",{className:"mx_PhoneNumbers_input"},i.a.createElement(ke.a,{type:"text",label:Object(l.a)("Phone Number"),autoComplete:"off",disabled:this.state.verifying,prefixComponent:s,value:this.state.newPhoneNumber,onChange:this._onChangeNewPhoneNumber}))),t)}}I()(Pg,"propTypes",{msisdns:xe.a.array.isRequired,onMsisdnsChange:xe.a.func.isRequired});class Dg extends i.a.Component{constructor(e){super(e),I()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(l.a)("Unable to revoke sharing for email address")})}),I()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(l.a)("Unable to share email address")})}),I()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});try{await this.state.addTask.checkEmailLinkClicked(),this.setState({addTask:null,continueDisabled:!1,verifying:!1})}catch(e){this.setState({continueDisabled:!1});const t=d.getComponent("dialogs.ErrorDialog");"M_THREEPID_AUTH_FAILED"===e.errcode?De.a.createTrackedDialog("E-mail hasn't been verified yet","",t,{title:Object(l.a)("Your email address hasn't been verified yet"),description:Object(l.a)("Click the link in the email you received to verify and then click continue again.")}):(console.error("Unable to verify email address: "+e),De.a.createTrackedDialog("Unable to verify email address","",t,{title:Object(l.a)("Unable to verify email address."),description:e&&e.message?e.message:Object(l.a)("Operation failed")}))}});const{bound:t}=e.email;this.state={verifying:!1,addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.email;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await ee.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const n=d.getComponent("dialogs.ErrorDialog"),{medium:a,address:i}=this.props.email;try{if(e){const e=new Zm;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindEmailAddress(i),this.setState({continueDisabled:!1})}else await ee.a.get().unbindThreePid(a,i);this.setState({bound:e})}catch(e){console.error(`Unable to ${t} email address ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),De.a.createTrackedDialog(`Unable to ${t} email address`,"",n,{title:s,description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const n=d.getComponent("dialogs.ErrorDialog"),{medium:a,address:i}=this.props.email,o=new Zm;this.setState({verifying:!0,continueDisabled:!0,addTask:o});try{await ee.a.get().deleteThreePid(a,i),e?await o.bindEmailAddress(i):await o.addEmailAddress(i),this.setState({continueDisabled:!1,bound:e})}catch(e){console.error(`Unable to ${t} email address ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),De.a.createTrackedDialog(`Unable to ${t} email address`,"",n,{title:s,description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}render(){const e=d.getComponent("elements.AccessibleButton"),{address:t}=this.props.email,{verifying:s,bound:n}=this.state;let a;return a=s?i.a.createElement("span",null,Object(l.a)("Verify the link in your inbox"),i.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onContinueClick},Object(l.a)("Complete"))):n?i.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(l.a)("Revoke")):i.a.createElement(e,{className:"mx_ExistingEmailAddress_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(l.a)("Share")),i.a.createElement("div",{className:"mx_ExistingEmailAddress"},i.a.createElement("span",{className:"mx_ExistingEmailAddress_email"},t),a)}}I()(Dg,"propTypes",{email:xe.a.object.isRequired});class Ag extends i.a.Component{render(){let e;return e=this.props.emails.length>0?this.props.emails.map(e=>i.a.createElement(Dg,{email:e,key:e.address})):i.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Discovery options will appear once you have added an email above.")),i.a.createElement("div",{className:"mx_EmailAddresses"},e)}}I()(Ag,"propTypes",{emails:xe.a.array.isRequired});class Ug extends i.a.Component{constructor(e){super(e),I()(this,"onRevokeClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!1,label:"revoke",errorTitle:Object(l.a)("Unable to revoke sharing for phone number")})}),I()(this,"onShareClick",e=>{e.stopPropagation(),e.preventDefault(),this.changeBinding({bind:!0,label:"share",errorTitle:Object(l.a)("Unable to share phone number")})}),I()(this,"onVerificationCodeChange",e=>{this.setState({verificationCode:e.target.value})}),I()(this,"onContinueClick",async e=>{e.stopPropagation(),e.preventDefault(),this.setState({continueDisabled:!0});const t=this.state.verificationCode;try{await this.state.addTask.haveMsisdnToken(t),this.setState({addTask:null,continueDisabled:!1,verifying:!1,verifyError:null,verificationCode:""})}catch(e){if(this.setState({continueDisabled:!1}),"M_THREEPID_AUTH_FAILED"!==e.errcode){const t=d.getComponent("dialogs.ErrorDialog");console.error("Unable to verify phone number: "+e),De.a.createTrackedDialog("Unable to verify phone number","",t,{title:Object(l.a)("Unable to verify phone number."),description:e&&e.message?e.message:Object(l.a)("Operation failed")})}else this.setState({verifyError:Object(l.a)("Incorrect verification code")})}});const{bound:t}=e.msisdn;this.state={verifying:!1,verificationCode:"",addTask:null,continueDisabled:!1,bound:t}}UNSAFE_componentWillReceiveProps(e){const{bound:t}=e.msisdn;this.setState({bound:t})}async changeBinding({bind:e,label:t,errorTitle:s}){if(!await ee.a.get().doesServerSupportSeparateAddAndBind())return this.changeBindingTangledAddBind({bind:e,label:t,errorTitle:s});const n=d.getComponent("dialogs.ErrorDialog"),{medium:a,address:i}=this.props.msisdn;try{if(e){const e=new Zm;this.setState({verifying:!0,continueDisabled:!0,addTask:e}),await e.bindMsisdn(null,"+"+i),this.setState({continueDisabled:!1})}else await ee.a.get().unbindThreePid(a,i);this.setState({bound:e})}catch(e){console.error(`Unable to ${t} phone number ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),De.a.createTrackedDialog(`Unable to ${t} phone number`,"",n,{title:s,description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}async changeBindingTangledAddBind({bind:e,label:t,errorTitle:s}){const n=d.getComponent("dialogs.ErrorDialog"),{medium:a,address:i}=this.props.msisdn,o=new Zm;this.setState({verifying:!0,continueDisabled:!0,addTask:o});try{await ee.a.get().deleteThreePid(a,i),e?await o.bindMsisdn(null,"+"+i):await o.addMsisdn(null,"+"+i),this.setState({continueDisabled:!1,bound:e})}catch(e){console.error(`Unable to ${t} phone number ${i} ${e}`),this.setState({verifying:!1,continueDisabled:!1,addTask:null}),De.a.createTrackedDialog(`Unable to ${t} phone number`,"",n,{title:s,description:e&&e.message?e.message:Object(l.a)("Operation failed")})}}render(){const e=d.getComponent("elements.AccessibleButton"),t=d.getComponent("elements.Field"),{address:s}=this.props.msisdn,{verifying:n,bound:a}=this.state;let o;return o=n?i.a.createElement("span",{className:"mx_ExistingPhoneNumber_verification"},i.a.createElement("span",null,Object(l.a)("Please enter verification code sent via text."),i.a.createElement("br",null),this.state.verifyError),i.a.createElement("form",{onSubmit:this.onContinueClick,autoComplete:"off",noValidate:!0},i.a.createElement(t,{type:"text",label:Object(l.a)("Verification code"),autoComplete:"off",disabled:this.state.continueDisabled,value:this.state.verificationCode,onChange:this.onVerificationCodeChange}))):a?i.a.createElement(e,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"danger_sm",onClick:this.onRevokeClick},Object(l.a)("Revoke")):i.a.createElement(e,{className:"mx_ExistingPhoneNumber_confirmBtn",kind:"primary_sm",onClick:this.onShareClick},Object(l.a)("Share")),i.a.createElement("div",{className:"mx_ExistingPhoneNumber"},i.a.createElement("span",{className:"mx_ExistingPhoneNumber_address"},"+",s),o)}}I()(Ug,"propTypes",{msisdn:xe.a.object.isRequired});class Mg extends i.a.Component{render(){let e;return e=this.props.msisdns.length>0?this.props.msisdns.map(e=>i.a.createElement(Ug,{msisdn:e,key:e.address})):i.a.createElement("span",{className:"mx_SettingsTab_subsectionText"},Object(l.a)("Discovery options will appear once you have added a phone number above.")),i.a.createElement("div",{className:"mx_PhoneNumbers"},e)}}I()(Mg,"propTypes",{msisdns:xe.a.array.isRequired});class Lg extends i.a.Component{constructor(){super(),I()(this,"_togglePolicy",e=>{const t=Object(ue.a)(this.state.policies);t[e].checked=!t[e].checked,this.setState({policies:t})}),I()(this,"_onContinue",()=>{!!this.state.policies.some(e=>!e.checked)||(this.setState({busy:!0}),this.props.onFinished(this.state.policies.map(e=>e.url)))}),this.state={policies:[],busy:!1}}componentDidMount(){const e=[];for(const t of this.props.policiesAndServicePairs){const s=Object.values(t.policies);for(const t of s){const s=Object(l.j)(Object.keys(t).filter(e=>"version"!==e)),n={checked:!1,url:t[s].url,name:t[s].name};e.push(n)}}this.setState({policies:e})}_renderCheckboxes(){const e=[];for(let t=0;t<this.state.policies.length;t++){const s=this.state.policies[t],n=Object(l.a)("Accept <policyLink /> to continue:",{},{policyLink:()=>i.a.createElement("a",{href:s.url,rel:"noreferrer noopener",target:"_blank"},s.name,i.a.createElement("span",{className:"mx_InlineTermsAgreement_link"}))});e.push(i.a.createElement("div",{key:t,className:"mx_InlineTermsAgreement_cbContainer"},i.a.createElement("div",null,n),i.a.createElement("div",{className:"mx_InlineTermsAgreement_checkbox"},i.a.createElement(He.a,{onChange:()=>this._togglePolicy(t),checked:s.checked},Object(l.a)("Accept")))))}return e}render(){const e=d.getComponent("views.elements.AccessibleButton"),t=!!this.state.policies.some(e=>!e.checked);return i.a.createElement("div",null,this.props.introElement,this._renderCheckboxes(),i.a.createElement(e,{onClick:this._onContinue,disabled:t||this.state.busy,kind:"primary_sm"},Object(l.a)("Continue")))}}I()(Lg,"propTypes",{policiesAndServicePairs:xe.a.array.isRequired,agreedUrls:xe.a.array.isRequired,onFinished:xe.a.func.isRequired,introElement:xe.a.node});class Fg extends i.a.Component{render(){const e=d.getComponent("views.elements.DialogButtons");return i.a.createElement("div",null,i.a.createElement("p",null,Object(l.a)("The other party cancelled the verification.")),i.a.createElement(e,{primaryButton:Object(l.a)("OK"),hasCancel:!1,onPrimaryButtonClick:this.props.onDone}))}}I()(Fg,"propTypes",{onDone:xe.a.func.isRequired});class Bg extends i.a.Component{render(){const e=d.getComponent("elements.AccessibleButton");return i.a.createElement("div",{className:"mx_UserInfo_container mx_VerificationPanel_verified_section"},i.a.createElement("h3",null,Object(l.a)("Verified")),i.a.createElement("p",null,Object(l.a)("You've successfully verified your device!")),i.a.createElement(po.b,{isUser:!0,status:"verified",size:128,hideTooltip:!0}),i.a.createElement(e,{kind:"primary",className:"mx_UserInfo_wideButton",onClick:this.props.onDone},Object(l.a)("Got it")))}}var Vg,Wg,Hg;I()(Bg,"propTypes",{onDone:xe.a.func.isRequired});let Gg=ya("views.verification.VerificationQREmojiOptions")((Hg=Wg=class extends i.a.Component{render(){const{request:e}=this.props;let t;return t=e.otherPartySupportsMethod(mo.c)?i.a.createElement(ho,{qrCodeData:e.qrCodeData}):i.a.createElement("div",{className:"mx_VerificationQREmojiOptions_noQR"},i.a.createElement(Je.a,null)),i.a.createElement("div",null,Object(l.a)("Verify this device by completing one of the following:"),i.a.createElement("div",{className:"mx_IncomingSasDialog_startOptions"},i.a.createElement("div",{className:"mx_IncomingSasDialog_startOption"},i.a.createElement("p",null,Object(l.a)("Scan this unique code")),t),i.a.createElement("div",{className:"mx_IncomingSasDialog_betweenText"},Object(l.a)("or")),i.a.createElement("div",{className:"mx_IncomingSasDialog_startOption"},i.a.createElement("p",null,Object(l.a)("Compare unique emoji")),i.a.createElement("span",{className:"mx_IncomingSasDialog_helpText"},Object(l.a)("Compare a unique set of emoji if you don't have a camera on either device")),i.a.createElement(pe.a,{onClick:this.props.onStartEmoji,kind:"primary"},Object(l.a)("Start")))),i.a.createElement(pe.a,{onClick:this.props.onCancel,kind:"danger"},Object(l.a)("Cancel")))}},I()(Wg,"propTypes",{request:xe.a.object.isRequired,onCancel:xe.a.func.isRequired,onStartEmoji:xe.a.func.isRequired}),Vg=Hg))||Vg;class qg extends i.a.Component{constructor(e){super(e),I()(this,"onMatchClick",()=>{this.setState({pending:!0}),this.props.onDone()}),I()(this,"onDontMatchClick",()=>{this.setState({cancelling:!0}),this.props.onCancel()}),this.state={pending:!1}}componentWillMount(){Gs()}render(){let e,t,s;if(this.props.sas.emoji){const s=this.props.sas.emoji.map((e,t)=>{return i.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_block",key:t},i.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_emoji"},e[0]),i.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_label"},Object(l.a)((s=e[1]).charAt(0).toUpperCase()+s.slice(1))));var s});e=i.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas"},s.slice(0,4),i.a.createElement("div",{className:"mx_VerificationShowSas_emojiSas_break"}),s.slice(4)),t=this.props.isSelf?Object(l.a)("Verify this device by confirming the following emoji appear on their screen:"):Object(l.a)("Verify this user by confirming the following emoji appear on their screen.")}else{if(!this.props.sas.decimal)return i.a.createElement("div",null,Object(l.a)("Unable to find a supported verification method."),i.a.createElement(pe.a,{kind:"primary",onClick:this.props.onCancel,className:"mx_UserInfo_wideButton"},Object(l.a)("Cancel")));{const s=this.props.sas.decimal.map((e,t)=>i.a.createElement("span",{key:t},e));e=i.a.createElement("div",{className:"mx_VerificationShowSas_decimalSas"},s),t=this.props.isSelf?Object(l.a)("Verify this device by confirming the following number appears on their screen:"):Object(l.a)("Verify this user by confirming the following number appears on their screen.")}}if(this.state.pending||this.state.cancelling){let e;if(this.state.pending)if(this.props.isSelf)e=this.props.device?Object(l.a)("Waiting for your other device, %(deviceName)s (%(deviceId)s), to verify…",{deviceName:this.props.device?this.props.device.getDisplayName():"",deviceId:this.props.device?this.props.device.deviceId:""}):Object(l.a)("Waiting for your other device to verify…");else{const{displayName:t}=this.props;e=Object(l.a)("Waiting for %(displayName)s to verify…",{displayName:t})}else e=Object(l.a)("Cancelling…");s=i.a.createElement(ao,{text:e})}else s=this.props.inDialog?i.a.createElement(da.a,{primaryButton:Object(l.a)("They match"),onPrimaryButtonClick:this.onMatchClick,primaryButtonClass:"mx_UserInfo_wideButton mx_VerificationShowSas_matchButton",cancelButton:Object(l.a)("They don't match"),onCancel:this.onDontMatchClick,cancelButtonClass:"mx_UserInfo_wideButton mx_VerificationShowSas_noMatchButton"}):i.a.createElement(i.a.Fragment,null,i.a.createElement(pe.a,{onClick:this.onDontMatchClick,kind:"danger"},Object(l.a)("They don't match")),i.a.createElement(pe.a,{onClick:this.onMatchClick,kind:"primary"},Object(l.a)("They match")));return i.a.createElement("div",{className:"mx_VerificationShowSas"},i.a.createElement("p",null,t),e,i.a.createElement("p",null,this.props.isSelf?"":Object(l.a)("To be secure, do this in person or use a trusted way to communicate.")),s)}}I()(qg,"propTypes",{pending:xe.a.bool,displayName:xe.a.string,device:xe.a.object,onDone:xe.a.func.isRequired,onCancel:xe.a.func.isRequired,sas:xe.a.object.isRequired,isSelf:xe.a.bool,inDialog:xe.a.bool}),Object(l.b)("Dog"),Object(l.b)("Cat"),Object(l.b)("Lion"),Object(l.b)("Horse"),Object(l.b)("Unicorn"),Object(l.b)("Pig"),Object(l.b)("Elephant"),Object(l.b)("Rabbit"),Object(l.b)("Panda"),Object(l.b)("Rooster"),Object(l.b)("Penguin"),Object(l.b)("Turtle"),Object(l.b)("Fish"),Object(l.b)("Octopus"),Object(l.b)("Butterfly"),Object(l.b)("Flower"),Object(l.b)("Tree"),Object(l.b)("Cactus"),Object(l.b)("Mushroom"),Object(l.b)("Globe"),Object(l.b)("Moon"),Object(l.b)("Cloud"),Object(l.b)("Fire"),Object(l.b)("Banana"),Object(l.b)("Apple"),Object(l.b)("Strawberry"),Object(l.b)("Corn"),Object(l.b)("Pizza"),Object(l.b)("Cake"),Object(l.b)("Heart"),Object(l.b)("Smiley"),Object(l.b)("Robot"),Object(l.b)("Hat"),Object(l.b)("Glasses"),Object(l.b)("Spanner"),Object(l.b)("Santa"),Object(l.b)("Thumbs up"),Object(l.b)("Umbrella"),Object(l.b)("Hourglass"),Object(l.b)("Clock"),Object(l.b)("Gift"),Object(l.b)("Light bulb"),Object(l.b)("Book"),Object(l.b)("Pencil"),Object(l.b)("Paperclip"),Object(l.b)("Scissors"),Object(l.b)("Lock"),Object(l.b)("Key"),Object(l.b)("Hammer"),Object(l.b)("Telephone"),Object(l.b)("Flag"),Object(l.b)("Train"),Object(l.b)("Bicycle"),Object(l.b)("Aeroplane"),Object(l.b)("Rocket"),Object(l.b)("Trophy"),Object(l.b)("Ball"),Object(l.b)("Guitar"),Object(l.b)("Trumpet"),Object(l.b)("Bell"),Object(l.b)("Anchor"),Object(l.b)("Headphones"),Object(l.b)("Folder"),Object(l.b)("Pin");let Kg={};n.o&&(Kg["structures.ContextMenu"]=n.o),O&&(Kg["structures.HomePage"]=O),N&&(Kg["structures.HostSignupAction"]=N),Ds&&(Kg["structures.LeftPanel"]=Ds),js&&(Kg["structures.LeftPanelWidget"]=js),xn&&(Kg["structures.LoggedInView"]=xn),ga&&(Kg["structures.MatrixChat"]=ga),vn&&(Kg["structures.NonUrgentToastContainer"]=vn),us.a&&(Kg["structures.RoomSearch"]=us.a),fa.a&&(Kg["structures.RoomView"]=fa.a),Oe&&(Kg["structures.TabbedView"]=Oe),ba&&(Kg["structures.ToastContainer"]=ba),hs&&(Kg["structures.UserMenu"]=hs),Ua&&(Kg["structures.auth.Login"]=Ua),La&&(Kg["structures.auth.Registration"]=La),Ba.a&&(Kg["views.auth.PassphraseField"]=Ba.a),Na&&(Kg["views.auth.PasswordLogin"]=Na),Va&&(Kg["views.auth.RegistrationForm"]=Va),u.a&&(Kg["views.avatars.BaseAvatar"]=u.a),bs.a&&(Kg["views.avatars.DecoratedRoomAvatar"]=bs.a),ie&&(Kg["views.avatars.GroupAvatar"]=ie),Wa.a&&(Kg["views.avatars.MemberAvatar"]=Wa.a),Ha&&(Kg["views.avatars.PulsedAvatar"]=Ha),on.a&&(Kg["views.avatars.RoomAvatar"]=on.a),Ga.a&&(Kg["views.avatars.WidgetAvatar"]=Ga.a),qa.a&&(Kg["views.context_menus.CallContextMenu"]=qa.a),Ka.a&&(Kg["views.context_menus.DialpadContextMenu"]=Ka.a),T.e&&(Kg["views.context_menus.IconizedContextMenu"]=T.e),za.a&&(Kg["views.context_menus.WidgetContextMenu"]=za.a),$a.a&&(Kg["views.dialogs.CommunityPrototypeInviteDialog"]=$a.a),na&&(Kg["views.dialogs.CreateCommunityPrototypeDialog"]=na),ms&&(Kg["views.dialogs.EditCommunityPrototypeDialog"]=ms),En&&(Kg["views.dialogs.HostSignupDialog"]=En),Ya.d&&(Kg["views.dialogs.InviteDialog"]=Ya.d),Ja.a&&(Kg["views.dialogs.ModalWidgetDialog"]=Ja.a),Xa&&(Kg["views.dialogs.RegistrationEmailPromptDialog"]=Xa),Za.a&&(Kg["views.dialogs.ServerOfflineDialog"]=Za.a),ti&&(Kg["views.dialogs.ServerPickerDialog"]=ti),si.a&&(Kg["views.dialogs.ShareDialog"]=si.a),ni.a&&(Kg["views.dialogs.WidgetCapabilitiesPromptDialog"]=ni.a),pe.a&&(Kg["views.elements.AccessibleButton"]=pe.a),B.a&&(Kg["views.elements.AccessibleTooltipButton"]=B.a),ai.b&&(Kg["views.elements.DesktopBuildsNotice"]=ai.b),ii.a&&(Kg["views.elements.DesktopCapturerSourcePicker"]=ii.a),oi&&(Kg["views.elements.Draggable"]=oi),ri.a&&(Kg["views.elements.EffectsOverlay"]=ri.a),ci&&(Kg["views.elements.EventListSummary"]=ci),ft&&(Kg["views.elements.EventTilePreview"]=ft),ke.a&&(Kg["views.elements.Field"]=ke.a),di&&(Kg["views.elements.IRCTimelineProfileResizer"]=di),ta&&(Kg["views.elements.InfoTooltip"]=ta),mi&&(Kg["views.elements.MemberEventListSummary"]=mi),v.b&&(Kg["views.elements.MiniAvatarUploader"]=v.b),hi&&(Kg["views.elements.ProgressBar"]=hi),ui.a&&(Kg["views.elements.QRCode"]=ui.a),Aa&&(Kg["views.elements.SSOButtons"]=Aa),gi&&(Kg["views.elements.ServerPicker"]=gi),ht&&(Kg["views.elements.SettingsFlag"]=ht),ot&&(Kg["views.elements.Slider"]=ot),He.a&&(Kg["views.elements.StyledCheckbox"]=He.a),dt.a&&(Kg["views.elements.StyledRadioButton"]=dt.a),bt&&(Kg["views.elements.StyledRadioGroup"]=bt),mt.a&&(Kg["views.elements.ToggleSwitch"]=mt.a),ea.a&&(Kg["views.elements.Tooltip"]=ea.a),V&&(Kg["views.elements.UserTagTile"]=V),Ca.a&&(Kg["views.elements.Validation"]=Ca.a),Ui&&(Kg["views.emojipicker.Category"]=Ui),Ri&&(Kg["views.emojipicker.Emoji"]=Ri),Ni&&(Kg["views.emojipicker.EmojiPicker"]=Ni),yi&&(Kg["views.emojipicker.Header"]=yi),Si&&(Kg["views.emojipicker.Preview"]=Si),Ii&&(Kg["views.emojipicker.QuickReactions"]=Ii),Li&&(Kg["views.emojipicker.ReactionPicker"]=Li),Ci&&(Kg["views.emojipicker.Search"]=Ci),Cn&&(Kg["views.host_signup.HostSignupContainer"]=Cn),Bi&&(Kg["views.messages.AccessRulesEvent"]=Bi),Vi&&(Kg["views.messages.EncryptionEvent"]=Vi),Fi&&(Kg["views.messages.EventTileBubble"]=Fi),Gi&&(Kg["views.messages.MJitsiWidgetEvent"]=Gi),to&&(Kg["views.messages.MVideoBody"]=to),so.a&&(Kg["views.messages.RedactedBody"]=so.a),no.b&&(Kg["views.right_panel.BaseCard"]=no.b),lo&&(Kg["views.right_panel.EncryptionInfo"]=lo),vo&&(Kg["views.right_panel.EncryptionPanel"]=vo),wo&&(Kg["views.right_panel.GroupHeaderButtons"]=wo),_o.a&&(Kg["views.right_panel.HeaderButton"]=_o.a),yo.b&&(Kg["views.right_panel.HeaderButtons"]=yo.b),So.a&&(Kg["views.right_panel.RoomHeaderButtons"]=So.a),xo.a&&(Kg["views.right_panel.RoomSummaryCard"]=xo.a),Zo&&(Kg["views.right_panel.UserInfo"]=Zo),fo&&(Kg["views.right_panel.VerificationPanel"]=fo),er.a&&(Kg["views.right_panel.WidgetCard"]=er.a),Kr&&(Kg["views.rooms.Autocomplete"]=Kr),zr.a&&(Kg["views.rooms.AuxPanel"]=zr.a),zl&&(Kg["views.rooms.BasicMessageComposer"]=zl),$l.a&&(Kg["views.rooms.NewRoomIntro"]=$l.a),oe.a&&(Kg["views.rooms.NotificationBadge"]=oe.a),Es&&(Kg["views.rooms.RoomBreadcrumbs"]=Es),we&&(Kg["views.rooms.RoomList"]=we),ws&&(Kg["views.rooms.RoomListNumResults"]=ws),Z.b&&(Kg["views.rooms.RoomSublist"]=Z.b),Yl.a&&(Kg["views.rooms.RoomTile"]=Yl.a),re&&(Kg["views.rooms.TemporaryTile"]=re),Xl&&(Kg["views.settings.BridgeTile"]=Xl),$t&&(Kg["views.settings.UpdateCheckButton"]=$t),ec&&(Kg["views.settings.tabs.room.BridgeSettingsTab"]=ec),yt&&(Kg["views.settings.tabs.user.AppearanceUserSettingsTab"]=yt),tc.a&&(Kg["views.toasts.GenericExpiringToast"]=tc.a),tn.a&&(Kg["views.toasts.GenericToast"]=tn.a),sc.a&&(Kg["views.toasts.NonUrgentEchoFailureToast"]=sc.a),ic&&(Kg["views.toasts.VerificationRequestToast"]=ic),fn&&(Kg["views.voip.CallContainer"]=fn),gn&&(Kg["views.voip.CallPreview"]=gn),dn.a&&(Kg["views.voip.CallView"]=dn.a),oc.a&&(Kg["views.voip.CallViewForRoom"]=oc.a),ia.a&&(Kg["views.voip.DialPad"]=ia.a),oa&&(Kg["views.voip.DialPadModal"]=oa),cn&&(Kg["views.voip.IncomingCallBox"]=cn),rc.b&&(Kg["views.voip.VideoFeed"]=rc.b),o.a&&(Kg["structures.AutoHideScrollbar"]=o.a),$&&(Kg["structures.CustomRoomTagPanel"]=$),lc.a&&(Kg["structures.EmbeddedPage"]=lc.a),mc&&(Kg["structures.FilePanel"]=mc),hc&&(Kg["structures.GenericErrorPage"]=hc),H&&(Kg["structures.GroupFilterPanel"]=H),Sc&&(Kg["structures.GroupView"]=Sc),Cs&&(Kg["structures.IndicatorScrollbar"]=Cs),We&&(Kg["structures.InteractiveAuth"]=We),uc.a&&(Kg["structures.MainSplit"]=uc.a),Nc&&(Kg["structures.MessagePanel"]=Nc),Uc&&(Kg["structures.MyGroups"]=Uc),Lc&&(Kg["structures.NotificationPanel"]=Lc),pc.a&&(Kg["structures.RightPanel"]=pc.a),Kc&&(Kg["structures.RoomDirectory"]=Kc),Jc&&(Kg["structures.RoomStatusBar"]=Jc),Qc.a&&(Kg["structures.ScrollPanel"]=Qc.a),Xc&&(Kg["structures.SearchBox"]=Xc),Zc.a&&(Kg["structures.TimelinePanel"]=Zc.a),td&&(Kg["structures.UploadBar"]=td),sd&&(Kg["structures.UserView"]=sd),id&&(Kg["structures.ViewSource"]=id),ld&&(Kg["structures.auth.CompleteSecurity"]=ld),hd&&(Kg["structures.auth.E2eSetup"]=hd),pd&&(Kg["structures.auth.ForgotPassword"]=pd),rd.a&&(Kg["structures.auth.SetupEncryptionBody"]=rd.a),Ed&&(Kg["structures.auth.SoftLogout"]=Ed),Cd&&(Kg["views.auth.AuthBody"]=Cd),wd&&(Kg["views.auth.AuthFooter"]=wd),Sd&&(Kg["views.auth.AuthHeader"]=Sd),xd&&(Kg["views.auth.AuthHeaderLogo"]=xd),Ea&&(Kg["views.auth.AuthPage"]=Ea),Rd.a&&(Kg["views.auth.CaptchaForm"]=Rd.a),cd&&(Kg["views.auth.CompleteSecurityBody"]=cd),Ia&&(Kg["views.auth.CountryDropdown"]=Ia),Be.d&&(Kg["views.auth.InteractiveAuthEntryComponents"]=Be.d),kd&&(Kg["views.auth.LanguageSelector"]=kd),Id&&(Kg["views.auth.Welcome"]=Id),jd&&(Kg["views.avatars.MemberStatusMessageAvatar"]=jd),Nd&&(Kg["views.context_menus.GenericElementContextMenu"]=Nd),Pd&&(Kg["views.context_menus.GenericTextContextMenu"]=Pd),Dd&&(Kg["views.context_menus.GroupInviteTileContextMenu"]=Dd),Fd&&(Kg["views.context_menus.MessageContextMenu"]=Fd),Td&&(Kg["views.context_menus.StatusMessageContextMenu"]=Td),Bd&&(Kg["views.context_menus.TagTileContextMenu"]=Bd),Wd&&(Kg["views.dialogs.AddressPickerDialog"]=Wd),Hd&&(Kg["views.dialogs.AskInviteAnywayDialog"]=Hd),cs.a&&(Kg["views.dialogs.BaseDialog"]=cs.a),ns&&(Kg["views.dialogs.BugReportDialog"]=ns),Gd.a&&(Kg["views.dialogs.ChangelogDialog"]=Gd.a),qd&&(Kg["views.dialogs.ConfirmAndWaitRedactDialog"]=qd),Kd&&(Kg["views.dialogs.ConfirmRedactDialog"]=Kd),Mo&&(Kg["views.dialogs.ConfirmUserActionDialog"]=Mo),zd&&(Kg["views.dialogs.ConfirmWipeDeviceDialog"]=zd),$d&&(Kg["views.dialogs.CreateGroupDialog"]=$d),Yd&&(Kg["views.dialogs.CreateRoomDialog"]=Yd),Jd&&(Kg["views.dialogs.CryptoStoreTooNewDialog"]=Jd),Ge&&(Kg["views.dialogs.DeactivateAccountDialog"]=Ge),cm&&(Kg["views.dialogs.DevtoolsDialog"]=cm),Ae.a&&(Kg["views.dialogs.ErrorDialog"]=Ae.a),is&&(Kg["views.dialogs.FeedbackDialog"]=is),dm&&(Kg["views.dialogs.IncomingSasDialog"]=dm),as.a&&(Kg["views.dialogs.InfoDialog"]=as.a),mm.a&&(Kg["views.dialogs.IntegrationsDisabledDialog"]=mm.a),hm.a&&(Kg["views.dialogs.IntegrationsImpossibleDialog"]=hm.a),dd&&(Kg["views.dialogs.InteractiveAuthDialog"]=dd),um&&(Kg["views.dialogs.KeySignatureUploadFailedDialog"]=um),pm&&(Kg["views.dialogs.LazyLoadingDisabledDialog"]=pm),gm&&(Kg["views.dialogs.LazyLoadingResyncDialog"]=gm),os&&(Kg["views.dialogs.LogoutDialog"]=os),fm&&(Kg["views.dialogs.ManualDeviceKeyVerificationDialog"]=fm),bm&&(Kg["views.dialogs.MessageEditHistoryDialog"]=bm),Cm&&(Kg["views.dialogs.NewSessionReviewDialog"]=Cm),St.a&&(Kg["views.dialogs.QuestionDialog"]=St.a),Tm&&(Kg["views.dialogs.ReportEventDialog"]=Tm),$m&&(Kg["views.dialogs.RoomSettingsDialog"]=$m),Ym&&(Kg["views.dialogs.RoomUpgradeDialog"]=Ym),Jm&&(Kg["views.dialogs.RoomUpgradeWarningDialog"]=Jm),Qm&&(Kg["views.dialogs.SessionRestoreErrorDialog"]=Qm),eh&&(Kg["views.dialogs.SetEmailDialog"]=eh),th&&(Kg["views.dialogs.SlashCommandHelpDialog"]=th),sh&&(Kg["views.dialogs.StorageEvictedDialog"]=sh),nh.a&&(Kg["views.dialogs.TabbedIntegrationManagerDialog"]=nh.a),ih&&(Kg["views.dialogs.TermsDialog"]=ih),oh&&(Kg["views.dialogs.TextInputDialog"]=oh),rh&&(Kg["views.dialogs.UploadConfirmDialog"]=rh),lh&&(Kg["views.dialogs.UploadFailureDialog"]=lh),ts&&(Kg["views.dialogs.UserSettingsDialog"]=ts),Em.a&&(Kg["views.dialogs.VerificationRequestDialog"]=Em.a),ch.a&&(Kg["views.dialogs.WidgetOpenIDPermissionsDialog"]=ch.a),dh.a&&(Kg["views.dialogs.security.AccessSecretStorageDialog"]=dh.a),mh&&(Kg["views.dialogs.security.ConfirmDestroyCrossSigningDialog"]=mh),md&&(Kg["views.dialogs.security.CreateCrossSigningDialog"]=md),xt.a&&(Kg["views.dialogs.security.RestoreKeyBackupDialog"]=xt.a),hh.a&&(Kg["views.dialogs.security.SetupEncryptionDialog"]=hh.a),Gc&&(Kg["views.directory.NetworkDropdown"]=Gc),uh&&(Kg["views.elements.ActionButton"]=uh),ph&&(Kg["views.elements.AddressSelector"]=ph),gh&&(Kg["views.elements.AddressTile"]=gh),fh.a&&(Kg["views.elements.AppPermission"]=fh.a),Is.a&&(Kg["views.elements.AppTile"]=Is.a),bh.a&&(Kg["views.elements.AppWarning"]=bh.a),_h&&(Kg["views.elements.DNDTagTile"]=_h),da.a&&(Kg["views.elements.DialogButtons"]=da.a),yh&&(Kg["views.elements.DirectorySearchBox"]=yh),Ch&&(Kg["views.elements.Dropdown"]=Ch),Sh&&(Kg["views.elements.EditableItemList"]=Sh),xh&&(Kg["views.elements.EditableText"]=xh),Rh&&(Kg["views.elements.EditableTextContainer"]=Rh),Oh.a&&(Kg["views.elements.ErrorBoundary"]=Oh.a),Ih&&(Kg["views.elements.Flair"]=Ih),rn.a&&(Kg["views.elements.FormButton"]=rn.a),Po.a&&(Kg["views.elements.ImageView"]=Po.a),qt.a&&(Kg["views.elements.InlineSpinner"]=qt.a),Ze.a&&(Kg["views.elements.LabelledToggleSwitch"]=Ze.a),Me&&(Kg["views.elements.LanguageDropdown"]=Me),Di&&(Kg["views.elements.LazyRenderList"]=Di),_n.a&&(Kg["views.elements.PersistedElement"]=_n.a),hn&&(Kg["views.elements.PersistentApp"]=hn),Ql.a&&(Kg["views.elements.Pill"]=Ql.a),Do&&(Kg["views.elements.PowerSelector"]=Do),Th.a&&(Kg["views.elements.ReplyThread"]=Th.a),Ys.a&&(Kg["views.elements.ResizeHandle"]=Ys.a),jh&&(Kg["views.elements.RoomAliasField"]=jh),Ph&&(Kg["views.elements.RoomDirectoryButton"]=Ph),Je.a&&(Kg["views.elements.Spinner"]=Je.a),Dh&&(Kg["views.elements.Spoiler"]=Dh),Uh&&(Kg["views.elements.StartChatButton"]=Uh),ad&&(Kg["views.elements.SyntaxHighlight"]=ad),vh&&(Kg["views.elements.TagTile"]=vh),et.a&&(Kg["views.elements.TextWithTooltip"]=et.a),Lh&&(Kg["views.elements.TintableSvg"]=Lh),Fh&&(Kg["views.elements.TintableSvgButton"]=Fh),Bh&&(Kg["views.elements.TooltipButton"]=Bh),Vh&&(Kg["views.elements.TruncatedList"]=Vh),ho&&(Kg["views.elements.crypto.VerificationQRCode"]=ho),Wh&&(Kg["views.groups.GroupInviteTile"]=Wh),Hh&&(Kg["views.groups.GroupMemberList"]=Hh),Gh&&(Kg["views.groups.GroupMemberTile"]=Gh),qh&&(Kg["views.groups.GroupPublicityToggle"]=qh),Kh&&(Kg["views.groups.GroupRoomInfo"]=Kh),zh&&(Kg["views.groups.GroupRoomList"]=zh),Yh&&(Kg["views.groups.GroupRoomTile"]=Yh),Xh&&(Kg["views.groups.GroupTile"]=Xh),Jt&&(Kg["views.groups.GroupUserSettings"]=Jt),Zh&&(Kg["views.messages.DateSeparator"]=Zh),bu&&(Kg["views.messages.EditHistoryMessage"]=bu),vu&&(Kg["views.messages.MAudioBody"]=vu),Zi&&(Kg["views.messages.MFileBody"]=Zi),_u&&(Kg["views.messages.MImageBody"]=_u),Eu&&(Kg["views.messages.MKeyVerificationConclusion"]=Eu),Cu&&(Kg["views.messages.MKeyVerificationRequest"]=Cu),wu&&(Kg["views.messages.MStickerBody"]=wu),Ou&&(Kg["views.messages.MessageActionBar"]=Ou),ku.a&&(Kg["views.messages.MessageEvent"]=ku.a),Iu&&(Kg["views.messages.MessageTimestamp"]=Iu),Tu&&(Kg["views.messages.MjolnirBody"]=Tu),ju&&(Kg["views.messages.ReactionsRow"]=ju),Nu&&(Kg["views.messages.ReactionsRowButton"]=Nu),Pu&&(Kg["views.messages.ReactionsRowButtonTooltip"]=Pu),Du&&(Kg["views.messages.RoomAvatarEvent"]=Du),Au&&(Kg["views.messages.RoomCreate"]=Au),Uu&&(Kg["views.messages.SenderProfile"]=Uu),Mu.a&&(Kg["views.messages.TextualBody"]=Mu.a),Lu&&(Kg["views.messages.TextualEvent"]=Lu),Fu&&(Kg["views.messages.TileErrorBoundary"]=Fu),Vu.a&&(Kg["views.messages.UnknownBody"]=Vu.a),Wu&&(Kg["views.messages.ViewSourceEvent"]=Wu),qu&&(Kg["views.room_settings.AliasSettings"]=qu),zu&&(Kg["views.room_settings.RelatedGroupSettings"]=zu),Hm&&(Kg["views.room_settings.RoomAccessSettings"]=Hm),Lm&&(Kg["views.room_settings.RoomProfileSettings"]=Lm),Hu&&(Kg["views.room_settings.RoomPublishSetting"]=Hu),$u&&(Kg["views.room_settings.UrlPreviewSettings"]=$u),Yu.a&&(Kg["views.rooms.AppsDrawer"]=Yu.a),po.b&&(Kg["views.rooms.E2EIcon"]=po.b),mp&&(Kg["views.rooms.EditMessageComposer"]=mp),pp&&(Kg["views.rooms.EntityTile"]=pp),gt.a&&(Kg["views.rooms.EventTile"]=gt.a),gp.a&&(Kg["views.rooms.ForwardMessage"]=gp.a),fp&&(Kg["views.rooms.JumpToBottomButton"]=fp),bp&&(Kg["views.rooms.LinkPreviewWidget"]=bp),yp&&(Kg["views.rooms.MemberList"]=yp),Ep&&(Kg["views.rooms.MemberTile"]=Ep),Pp&&(Kg["views.rooms.MessageComposer"]=Pp),Bl&&(Kg["views.rooms.MessageComposerFormatBar"]=Bl),Dp.a&&(Kg["views.rooms.PinnedEventTile"]=Dp.a),Ap.a&&(Kg["views.rooms.PinnedEventsPanel"]=Ap.a),Ao&&(Kg["views.rooms.PresenceLabel"]=Ao),Up.a&&(Kg["views.rooms.ReadReceiptMarker"]=Up.a),Rp&&(Kg["views.rooms.ReplyPreview"]=Rp),Bp&&(Kg["views.rooms.RoomDetailList"]=Bp),Fp&&(Kg["views.rooms.RoomDetailRow"]=Fp),Vp.a&&(Kg["views.rooms.RoomHeader"]=Vp.a),Wp.a&&(Kg["views.rooms.RoomPreviewBar"]=Wp.a),Hp.a&&(Kg["views.rooms.RoomUpgradeWarningBar"]=Hp.a),Gp.a&&(Kg["views.rooms.SearchBar"]=Gp.a),qp&&(Kg["views.rooms.SearchResultTile"]=qp),Qp&&(Kg["views.rooms.SendMessageComposer"]=Qp),Xp.b&&(Kg["views.rooms.SimpleRoomHeader"]=Xp.b),Sp&&(Kg["views.rooms.Stickerpicker"]=Sp),Zp&&(Kg["views.rooms.ThirdPartyMemberInfo"]=Zp),eg&&(Kg["views.rooms.TopUnreadMessagesBar"]=eg),ng&&(Kg["views.rooms.WhoIsTypingTile"]=ng),ig&&(Kg["views.settings.AvatarSetting"]=ig),og&&(Kg["views.settings.ChangeAvatar"]=og),rg&&(Kg["views.settings.ChangeDisplayName"]=rg),lg&&(Kg["views.settings.ChangePassword"]=lg),cg&&(Kg["views.settings.CrossSigningPanel"]=cg),dg&&(Kg["views.settings.DevicesPanel"]=dg),mg&&(Kg["views.settings.DevicesPanelEntry"]=mg),kt&&(Kg["views.settings.E2eAdvancedPanel"]=kt),hg&&(Kg["views.settings.EventIndexPanel"]=hg),ug.a&&(Kg["views.settings.IntegrationManager"]=ug.a),Og&&(Kg["views.settings.Notifications"]=Og),Ue&&(Kg["views.settings.ProfileSettings"]=Ue),Ot&&(Kg["views.settings.SecureBackupPanel"]=Ot),kg&&(Kg["views.settings.SetIdServer"]=kg),Ig&&(Kg["views.settings.SetIntegrationManager"]=Ig),jg&&(Kg["views.settings.account.EmailAddresses"]=jg),Pg&&(Kg["views.settings.account.PhoneNumbers"]=Pg),Ag&&(Kg["views.settings.discovery.EmailAddresses"]=Ag),Mg&&(Kg["views.settings.discovery.PhoneNumbers"]=Mg),Nm&&(Kg["views.settings.tabs.room.AdvancedRoomSettingsTab"]=Nm),Gm&&(Kg["views.settings.tabs.room.GeneralRoomSettingsTab"]=Gm),Km&&(Kg["views.settings.tabs.room.NotificationSettingsTab"]=Km),Mm&&(Kg["views.settings.tabs.room.RolesRoomSettingsTab"]=Mm),qm&&(Kg["views.settings.tabs.room.SecurityRoomSettingsTab"]=qm),Qt&&(Kg["views.settings.tabs.user.FlairUserSettingsTab"]=Qt),tt&&(Kg["views.settings.tabs.user.GeneralUserSettingsTab"]=tt),Yt&&(Kg["views.settings.tabs.user.HelpUserSettingsTab"]=Yt),nt&&(Kg["views.settings.tabs.user.LabsUserSettingsTab"]=nt),es&&(Kg["views.settings.tabs.user.MjolnirUserSettingsTab"]=es),jt&&(Kg["views.settings.tabs.user.NotificationUserSettingsTab"]=jt),Nt&&(Kg["views.settings.tabs.user.PreferencesUserSettingsTab"]=Nt),Tt&&(Kg["views.settings.tabs.user.SecurityUserSettingsTab"]=Tt),Wt&&(Kg["views.settings.tabs.user.VoiceUserSettingsTab"]=Wt),Lg&&(Kg["views.terms.InlineTermsAgreement"]=Lg),Fg&&(Kg["views.verification.VerificationCancelled"]=Fg),Bg&&(Kg["views.verification.VerificationComplete"]=Bg),Gg&&(Kg["views.verification.VerificationQREmojiOptions"]=Gg),qg&&(Kg["views.verification.VerificationShowSas"]=qg)},function(e,t,s){"use strict";s.d(t,"b",(function(){return T})),s.d(t,"a",(function(){return N}));var n=s(82),a=s.n(n),i=s(1),o=s(109),r=s(6),l=s(120),c=s(552),d=s(125),m=s(314),h=s(171),u=s(237);var p=s(86),g=s(554);const f={[u.b.Recent]:new class{async sortRooms(e,t){let s="";p.a.get()&&(s=p.a.get().getUserId());const n={},a=e=>{if(n[e.roomId])return n[e.roomId];const t=(()=>{if(!e||!e.timeline)return Number.MAX_SAFE_INTEGER;if(Object(h.b)(e.getMyMembership())!==h.a.Join){const t=e.currentState.getStateEvents("m.room.member",s);if(t&&!Array.isArray(t))return t.getTs()}for(let t=e.timeline.length-1;t>=0;--t){const n=e.timeline[t];if(n.getTs()&&(n.getSender()===s||g.b(n)))return n.getTs()}return e.timeline.length&&e.timeline[0].getTs()?e.timeline[0].getTs():Number.MAX_SAFE_INTEGER})();return n[e.roomId]=t,t};return e.sort((e,t)=>a(t)-a(e))}},[u.b.Alphabetic]:new class{async sortRooms(e,t){return e.sort((e,t)=>e.name.localeCompare(t.name))}},[u.b.Manual]:new class{async sortRooms(e,t){const s=e=>e.tags[t].order||0;return e.sort((e,t)=>s(e)-s(t))}}};function b(e,t,s){return function(e){if(!f[e])throw new Error(e+" is not a known algorithm");return f[e]}(s).sortRooms(e,t)}var v=s(505),_=s.n(v);class y{constructor(e,t){this.tagId=e,a()(this,"cachedOrderedRooms",void 0),a()(this,"sortingAlgorithm",void 0),a()(this,"updateLock",new _.a),this.setSortAlgorithm(t)}get orderedRooms(){return this.cachedOrderedRooms||[]}async setSortAlgorithm(e){if(!e)throw new Error("A sorting algorithm must be defined");this.sortingAlgorithm=e,await this.setRooms(this.orderedRooms)}getRoomIndex(e){let t=this.cachedOrderedRooms.indexOf(e);return-1===t&&(console.warn(`Degrading performance to find missing room in "${this.tagId}": ${e.roomId}`),t=this.cachedOrderedRooms.findIndex(t=>t.roomId===e.roomId)),t}}var E=s(245),C=s(176);const w=[E.a.Red,E.a.Grey,E.a.Bold,E.a.None];class S extends y{constructor(e,t){super(e,t),a()(this,"indices",{})}categorizeRooms(e){const t={[E.a.Red]:[],[E.a.Grey]:[],[E.a.Bold]:[],[E.a.None]:[]};for(const s of e){t[this.getRoomCategory(s)].push(s)}return t}getRoomCategory(e){return C.a.instance.getRoomState(e).color}async setRooms(e){if(this.sortingAlgorithm===u.b.Manual)this.cachedOrderedRooms=await b(e,this.tagId,this.sortingAlgorithm);else{const t=this.categorizeRooms(e);for(const e of Object.keys(t)){const s=t[e];t[e]=await b(s,this.tagId,this.sortingAlgorithm)}const s=[],n={};for(const e of w)n[e]=s.length,s.push(...t[e]);this.indices=n,this.cachedOrderedRooms=s}}async handleSplice(e,t){if(t===d.c.NewRoom){const t=this.getRoomCategory(e);this.alterCategoryPositionBy(t,1,this.indices),this.cachedOrderedRooms.splice(this.indices[t],0,e),await this.sortCategory(t)}else{if(t!==d.c.RoomRemoved)throw new Error("Unhandled splice: "+t);{const t=this.getRoomIndex(e);if(-1===t)return console.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`),!1;const s=this.getCategoryFromIndices(t,this.indices);this.alterCategoryPositionBy(s,-1,this.indices),this.cachedOrderedRooms.splice(t,1)}}return!0}async handleRoomUpdate(e,t){try{if(await this.updateLock.acquireAsync(),t===d.c.NewRoom||t===d.c.RoomRemoved)return this.handleSplice(e,t);if(t!==d.c.Timeline&&t!==d.c.ReadReceipt)throw new Error("Unsupported update cause: "+t);const s=this.getRoomCategory(e);if(this.sortingAlgorithm===u.b.Manual)return;const n=this.getRoomIndex(e);if(-1===n)throw new Error(`Room ${e.roomId} has no index in ${this.tagId}`);const a=this.getCategoryFromIndices(n,this.indices);return a!==s&&(this.moveRoomIndexes(1,a,s,this.indices),this.cachedOrderedRooms.splice(n,1),this.cachedOrderedRooms.splice(this.indices[s],0,e)),await this.sortCategory(s),!0}finally{await this.updateLock.release()}}async sortCategory(e){const t=e===w[w.length-1]?Number.MAX_SAFE_INTEGER:this.indices[w[w.indexOf(e)+1]],s=this.indices[e],n=t-s,a=this.cachedOrderedRooms.splice(s,n),i=await b(a,this.tagId,this.sortingAlgorithm);this.cachedOrderedRooms.splice(s,0,...i)}getCategoryFromIndices(e,t){for(let s=0;s<w.length;s++){const n=w[s],a=s===w.length-1,i=t[n],o=a?Number.MAX_SAFE_INTEGER:t[w[s+1]];if(e>=i&&e<o)return n}throw new Error("Programming error: somehow you've ended up with an index that isn't in a category")}moveRoomIndexes(e,t,s,n){this.alterCategoryPositionBy(t,-e,n),this.alterCategoryPositionBy(s,+e,n)}alterCategoryPositionBy(e,t,s){const n=w.indexOf(e)+1;if(t>0)for(let e=n;e<w.length;e++){s[w[e]]+=Math.abs(t)}else if(t<0)for(let e=n;e<w.length;e++){s[w[e]]-=Math.abs(t)}for(let e=1;e<=w.length;e++){const t=w[e-1],n=w[e];s[t]>s[n]&&console.warn(`!! Room list index corruption: ${t} (i:${s[t]}) is greater than ${n} (i:${s[n]}) - category indices are likely desynced from reality`)}}}class x extends y{constructor(e,t){super(e,t)}async setRooms(e){this.cachedOrderedRooms=await b(e,this.tagId,this.sortingAlgorithm)}async handleRoomUpdate(e,t){try{await this.updateLock.acquireAsync();const s=t===d.c.NewRoom||t===d.c.RoomRemoved,n=t===d.c.Timeline||t===d.c.ReadReceipt;if(!s&&!n)throw new Error("Unsupported update cause: "+t);if(t===d.c.NewRoom)this.cachedOrderedRooms.push(e);else if(t===d.c.RoomRemoved){const t=this.getRoomIndex(e);t>=0?this.cachedOrderedRooms.splice(t,1):console.warn(`Tried to remove unknown room from ${this.tagId}: ${e.roomId}`)}return this.cachedOrderedRooms=await b(this.cachedOrderedRooms,this.tagId,this.sortingAlgorithm),!0}finally{await this.updateLock.release()}}}const R={[u.a.Natural]:(e,t)=>new x(e,t),[u.a.Importance]:(e,t)=>new S(e,t)};function O(e,t,s){if(!R[e])throw new Error(e+" is not a known algorithm");return R[e](t,s)}var k=s(88),I=s(770);const T="list_updated_event",j=[d.c.Timeline,d.c.ReadReceipt];class N extends r.EventEmitter{constructor(){super(),a()(this,"_cachedRooms",{}),a()(this,"_cachedStickyRooms",{}),a()(this,"filteredRooms",{}),a()(this,"_stickyRoom",null),a()(this,"_lastStickyRoom",null),a()(this,"sortAlgorithms",void 0),a()(this,"listAlgorithms",void 0),a()(this,"algorithms",void 0),a()(this,"rooms",[]),a()(this,"roomIdsToTags",{}),a()(this,"allowedByFilter",new Map),a()(this,"allowedRoomsByFilters",new Set)}get stickyRoom(){return this._stickyRoom?this._stickyRoom.room:null}get hasFilters(){return this.allowedByFilter.size>0}set cachedRooms(e){this._cachedRooms=e,this.recalculateFilteredRooms(),this.recalculateStickyRoom()}get cachedRooms(){return this._cachedRooms}async setStickyRoom(e){await this.updateStickyRoom(e)}getTagSorting(e){return this.sortAlgorithms?this.sortAlgorithms[e]:null}async setTagSorting(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.sortAlgorithms[e]=t;const s=this.algorithms[e];await s.setSortAlgorithm(t),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}getListOrdering(e){return this.listAlgorithms?this.listAlgorithms[e]:null}async setListOrdering(e,t){if(!e)throw new Error("Tag ID must be defined");if(!t)throw new Error("Algorithm must be defined");this.listAlgorithms[e]=t;const s=O(t,e,this.sortAlgorithms[e]);this.algorithms[e]=s,await s.setRooms(this._cachedRooms[e]),this._cachedRooms[e]=s.orderedRooms,this.recalculateFilteredRoomsForTag(e),this.recalculateStickyRoom(e)}addFilterCondition(e){this.allowedByFilter.set(e,this.rooms.filter(t=>e.isVisible(t))),this.recalculateFilteredRooms(),e.on(m.a,this.handleFilterChange.bind(this))}removeFilterCondition(e){e.off(m.a,this.handleFilterChange.bind(this)),this.allowedByFilter.has(e)&&(this.allowedByFilter.delete(e),this.recalculateFilteredRooms(),this.hasFilters||this.emit(T))}async handleFilterChange(){await this.recalculateFilteredRooms(),this.emit(m.a)}async updateStickyRoom(e){try{return await this.doUpdateStickyRoom(e)}finally{this._lastStickyRoom=null}}async doUpdateStickyRoom(e){if(e&&!I.a.instance.isRoomVisible(e)&&(e=null),this._lastStickyRoom=this._stickyRoom||{},!e){if(this._stickyRoom){const e=this._stickyRoom.room;return this._stickyRoom=null,void await this.handleRoomUpdate(e,d.c.NewRoom)}return}let t=this.roomIdsToTags[e.roomId][0];if(!t)throw new Error(e.roomId+" does not belong to a tag and cannot be sticky");let s=(this.getOrderedRoomsWithoutSticky()[t]||[]).indexOf(e);const n=!!this._lastStickyRoom.room&&this._lastStickyRoom.room.roomId===e.roomId;if(this._lastStickyRoom.tag&&t!==this._lastStickyRoom.tag&&n&&s<0&&(console.warn(`Sticky room ${e.roomId} changed tags during sticky room handling`),s=0),s<0)throw new Error(e.roomId+" does not appear to be known and cannot be sticky");const a=this._stickyRoom;if(this._stickyRoom=null,this.recalculateStickyRoom(),a&&a.room&&a.room.roomId!==e.roomId&&await this.handleRoomUpdate(a.room,d.c.NewRoom),await this.handleRoomUpdate(e,d.c.RoomRemoved),this._stickyRoom){if(this._stickyRoom.room!==e){if(this._stickyRoom.room.roomId!==e.roomId)throw new Error("Sticky room changed while the sticky room was changing");console.warn("Sticky room changed references")}console.warn(`Sticky room changed tag & position from ${t} / ${s} to ${this._stickyRoom.tag} / ${this._stickyRoom.position}`),t=this._stickyRoom.tag,s=this._stickyRoom.position}a&&a.tag===t&&a.position<=s&&s++,this._stickyRoom={room:e,position:s,tag:t},this.recalculateFilteredRoomsForTag(t),a&&a.tag!==t&&this.recalculateFilteredRoomsForTag(a.tag),this.recalculateStickyRoom(),this.emit(T)}recalculateFilteredRooms(){if(!this.hasFilters)return;console.warn("Recalculating filtered room list");const e=Array.from(this.allowedByFilter.keys()),t=new l.a(e).groupBy(e=>e.relativePriority).orderBy(Object(c.a)(m.b)).value,s={};for(const e of Object.keys(this.cachedRooms)){const n=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(n,e);let a=n.map(e=>e),i=[],o=t[0].relativePriority;for(const e of t){e.relativePriority!==o&&(a=i,i=[],o=e.relativePriority);const t=a.filter(t=>e.isVisible(t));for(const e of t){const t=a.indexOf(e);t>=0&&a.splice(t,1),i.push(e)}}s[e]=i,k.a.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] ${s[e].length}/${n.length} rooms filtered into ${e}`)}const n=Object.values(s).reduce((e,t)=>(e.push(...t),e),[]);this.allowedRoomsByFilters=new Set(n),this.filteredRooms=s,this.emit(T)}recalculateFilteredRoomsForTag(e){if(!this.hasFilters)return;k.a.getValue("advancedRoomListLogging")&&console.log("Recalculating filtered rooms for "+e),delete this.filteredRooms[e];const t=this.cachedRooms[e].map(e=>e);this.tryInsertStickyRoomToFilterSet(t,e);const s=t.filter(e=>this.allowedRoomsByFilters.has(e));s.length>0&&(this.filteredRooms[e]=s),k.a.getValue("advancedRoomListLogging")&&console.log(`[DEBUG] ${s.length}/${t.length} rooms filtered into ${e}`)}tryInsertStickyRoomToFilterSet(e,t){if(!this._stickyRoom||!this._stickyRoom.room||this._stickyRoom.tag!==t)return;const s=this._stickyRoom.position;s>=e.length?e.push(this._stickyRoom.room):e.splice(s,0,this._stickyRoom.room)}recalculateStickyRoom(e=null){if(!this._stickyRoom)return void(this._cachedStickyRooms&&(this._cachedStickyRooms=null,this.emit(T)));if(!this._cachedStickyRooms||!e){k.a.getValue("advancedRoomListLogging")&&console.log("Generating clone of cached rooms for sticky room handling");const e={};for(const t of Object.keys(this.cachedRooms))e[t]=this.cachedRooms[t].map(e=>e);this._cachedStickyRooms=e}e&&(k.a.getValue("advancedRoomListLogging")&&console.log("Replacing cached sticky rooms for "+e),this._cachedStickyRooms[e]=this.cachedRooms[e].map(e=>e));const t=this._stickyRoom;e&&e!==t.tag||(k.a.getValue("advancedRoomListLogging")&&console.log(`Inserting sticky room ${t.room.roomId} at position ${t.position} in ${t.tag}`),this._cachedStickyRooms[t.tag].splice(t.position,0,t.room)),this.emit(T)}async populateTags(e,t){if(!e)throw new Error("Sorting map cannot be null or empty");if(!t)throw new Error("Ordering ma cannot be null or empty");if(Object(l.d)(Object.keys(e),Object.keys(t)))throw new Error("Both maps must contain the exact same tags");this.sortAlgorithms=e,this.listAlgorithms=t,this.algorithms={};for(const t of Object.keys(e))this.algorithms[t]=O(this.listAlgorithms[t],t,this.sortAlgorithms[t]);return this.setKnownRooms(this.rooms)}getOrderedRooms(){return this.hasFilters?this.filteredRooms:this._cachedStickyRooms||this.cachedRooms}getUnfilteredRooms(){return this._cachedStickyRooms||this.cachedRooms}getOrderedRoomsWithoutSticky(){return this.hasFilters?this.filteredRooms:this.cachedRooms}async setKnownRooms(e){if(Object(i.r)(e))throw new Error("Array of rooms cannot be null");if(!this.sortAlgorithms)throw new Error("Cannot set known rooms without a tag sorting map");console.warn("Resetting known rooms, initiating regeneration");const t=this._stickyRoom;await this.updateStickyRoom(null),this.rooms=e;const s={};for(const e in this.sortAlgorithms)s[e]=[];if(!e.length)return await this.generateFreshTags(s),void(this.cachedRooms=s);const n=Object(h.e)(e);for(const e of n[h.a.Invite])s[d.a.Invite].push(e);for(const e of n[h.a.Leave])s[d.a.Archived].push(e);for(const e of n[h.a.Join]){const t=this.getTagsOfJoinedRoom(e);let n=!1;if(t.length>0)for(const a of t)Object(i.r)(s[a])||(a===d.a.ServerNotice?s[d.a.DM].push(e):s[a].push(e),n=!0);n||(o.a.shared().getUserIdForRoomId(e.roomId)?s[d.a.DM].push(e):s[d.a.Untagged].push(e))}await this.generateFreshTags(s),this.cachedRooms=s,this.updateTagsFromCache(),this.recalculateFilteredRooms(),t&&t.room&&(await this.updateStickyRoom(t.room),this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.tag!==t.tag&&(this._stickyRoom.position=0,this.recalculateStickyRoom(this._stickyRoom.tag)))}getTagsForRoom(e){const t=[],s=Object(h.b)(e.getMyMembership());return s===h.a.Invite?t.push(d.a.Invite):s===h.a.Leave?t.push(d.a.Archived):t.push(...this.getTagsOfJoinedRoom(e)),t.length||t.push(d.a.Untagged),t}getTagsOfJoinedRoom(e){let t=Object.keys(e.tags||{});return 0===t.length&&o.a.shared().getUserIdForRoomId(e.roomId)&&(t=[d.a.DM]),t}updateTagsFromCache(){const e={},t=Object.keys(this.cachedRooms);for(const s of t){const t=this.cachedRooms[s];for(const n of t)e[n.roomId]||(e[n.roomId]=[]),e[n.roomId].push(s)}this.roomIdsToTags=e}async generateFreshTags(e){if(!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");for(const t of Object.keys(e)){const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.setRooms(e[t]),e[t]=s.orderedRooms}}async handleRoomUpdate(e,t){if(k.a.getValue("advancedRoomListLogging")&&console.log(`Handle room update for ${e.roomId} called with cause ${t}`),!this.algorithms)throw new Error("Not ready: no algorithms to determine tags from");const s=this._stickyRoom&&this._stickyRoom.room&&this._stickyRoom.room.roomId===e.roomId;if(t===d.c.NewRoom){const n=this._lastStickyRoom&&this._lastStickyRoom.room===e,a=this.roomIdsToTags[e.roomId],i=a&&a.length>0;i&&!n&&(console.warn(e.roomId+" is reportedly new but is already known - assuming TagChange instead"),t=d.c.PossibleTagChange);let o=this.rooms.includes(e);if(i&&!o&&(console.warn(e.roomId+" might be a reference change - attempting to update reference"),this.rooms=this.rooms.map(t=>t.roomId===e.roomId?e:t),o=this.rooms.includes(e),o||console.warn(e.roomId+" is still not referenced. It may be sticky.")),i&&!o&&!s)throw new Error(e.roomId+" is missing from room array but is known - trying to find duplicate");i&&s&&(this._stickyRoom.room=e),t!==d.c.NewRoom||s||o||this.rooms.push(e)}let n=!1;if(t===d.c.PossibleTagChange){const a=this.roomIdsToTags[e.roomId]||[],i=this.getTagsForRoom(e),o=Object(l.b)(a,i);if(o.removed.length>0||o.added.length>0){for(const t of o.removed){k.a.getValue("advancedRoomListLogging")&&console.log(`Removing ${e.roomId} from ${t}`);const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.handleRoomUpdate(e,d.c.RoomRemoved),this._cachedRooms[t]=s.orderedRooms,this.recalculateFilteredRoomsForTag(t),this.recalculateStickyRoom(t)}for(const t of o.added){k.a.getValue("advancedRoomListLogging")&&console.log(`Adding ${e.roomId} to ${t}`);const s=this.algorithms[t];if(!s)throw new Error("No algorithm for "+t);await s.handleRoomUpdate(e,d.c.NewRoom),this._cachedRooms[t]=s.orderedRooms}this.roomIdsToTags[e.roomId]=i,k.a.getValue("advancedRoomListLogging")&&console.log(`Changing update cause for ${e.roomId} to Timeline to sort rooms`),t=d.c.Timeline,n=!0}else k.a.getValue("advancedRoomListLogging")&&console.log(`Received no-op update for ${e.roomId} - changing to Timeline update`),t=d.c.Timeline;n&&s&&(this._lastStickyRoom?this._stickyRoom={room:e,tag:this.roomIdsToTags[e.roomId][0],position:0}:await this.setStickyRoom(e))}if(t!==d.c.NewRoom&&t!==d.c.RoomRemoved&&this.stickyRoom===e)return k.a.getValue("advancedRoomListLogging")&&console.warn(`[RoomListDebug] Received ${t} update for sticky room ${e.roomId} - ignoring`),!1;if(!this.roomIdsToTags[e.roomId]){if(j.includes(t))return k.a.getValue("advancedRoomListLogging")&&console.warn(`Skipping tag update for ${e.roomId} because we don't know about the room`),!1;k.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Updating tags for room ${e.roomId} (${e.name})`);const s=this.getTagsForRoom(e).filter(e=>!Object(i.r)(this.cachedRooms[e]));if(!s.length)throw new Error("Tags cannot be determined for "+e.roomId);this.roomIdsToTags[e.roomId]=s,k.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Updated tags for ${e.roomId}:`,s)}k.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Reached algorithmic handling for ${e.roomId} and cause ${t}`);const a=this.roomIdsToTags[e.roomId];if(!a)return console.warn(`No tags known for "${e.name}" (${e.roomId})`),!1;let o=n;for(const s of a){const n=this.algorithms[s];if(!n)throw new Error("No algorithm for "+s);await n.handleRoomUpdate(e,t),this._cachedRooms[s]=n.orderedRooms,this.recalculateFilteredRoomsForTag(s),this.recalculateStickyRoom(s),o=!0}return k.a.getValue("advancedRoomListLogging")&&console.log(`[RoomListDebug] Finished handling ${e.roomId} with cause ${t} (changed=${o})`),o}}},function(e,t,s){"use strict";s.d(t,"a",(function(){return E}));var n=s(82),a=s.n(n),i=s(147),o=s(87),r=s(83),l=s(86),c=s(125);function d(e){const t=l.a.get().getUserId();return"m.room.member"===e.getType()?e.getStateKey()===t:e.getSender()===t}function m(e,t){if(t!==c.a.DM)return!0;const s=l.a.get().getRoom(e);return!s||2!==s.currentState.getJoinedMemberCount()}function h(e){return e.sender?e.sender.name:e.getSender()}var u=s(238),p=s(121);var g=s(1);var f=s(88),b=s(109);var v=s(113);const _={"m.room.message":{isState:!1,previewer:new class{getTextFor(e,t){let s=e.getContent();if(e.isRelation("m.replace")&&(s=e.getContent()["m.new_content"]),!s||!s.body)return null;let n=(s.body||"").trim();const a=s.msgtype;if(!n||!a)return null;const i="org.matrix.custom.html"===s.format&&s.formatted_body;i&&(n=s.formatted_body);const o=e.getWireContent()["m.relates_to"];return o&&o["m.in_reply_to"]&&(n=i?(u.a.stripHTMLReply(n)||"").trim():(u.a.stripPlainReply(n)||"").trim(),!n)?null:(i&&(n=Object(p.h)(n)),"m.emote"===a?Object(r.a)("* %(senderName)s %(emote)s",{senderName:h(e),emote:n}):d(e)||!m(e.getRoomId(),t)?n:Object(r.a)("%(senderName)s: %(message)s",{senderName:h(e),message:n}))}}},"m.call.invite":{isState:!1,previewer:new class{getTextFor(e,t){return m(e.getRoomId(),t)?d(e)?Object(r.a)("You started a call"):Object(r.a)("%(senderName)s started a call",{senderName:h(e)}):d(e)?Object(r.a)("Waiting for answer"):Object(r.a)("%(senderName)s is calling",{senderName:h(e)})}}},"m.call.answer":{isState:!1,previewer:new class{getTextFor(e,t){return m(e.getRoomId(),t)?d(e)?Object(r.a)("You joined the call"):Object(r.a)("%(senderName)s joined the call",{senderName:h(e)}):Object(r.a)("Call in progress")}}},"m.call.hangup":{isState:!1,previewer:new class{getTextFor(e,t){return m(e.getRoomId(),t)?d(e)?Object(r.a)("You ended the call"):Object(r.a)("%(senderName)s ended the call",{senderName:h(e)}):Object(r.a)("Call ended")}}},"m.sticker":{isState:!1,previewer:new class{getTextFor(e,t){const s=e.getContent().body;return s?d(e)||!m(e.getRoomId(),t)?s:Object(r.a)("%(senderName)s: %(stickerName)s",{senderName:h(e),stickerName:s}):null}}},"m.reaction":{isState:!1,previewer:new class{getTextFor(e,t){const s=f.a.getValue("feature_roomlist_preview_reactions_dms");if(!(f.a.getValue("feature_roomlist_preview_reactions_all")||s&&b.a.shared().getUserIdForRoomId(e.getRoomId())))return null;const n=e.getRelation();if(!n)return null;const a=n.key;return a?d(e)||!m(e.getRoomId(),t)?a:Object(r.a)("%(senderName)s: %(reaction)s",{senderName:h(e),reaction:a}):null}}}},y="im.vector.any";class E extends i.a{constructor(){super(o.a,{}),a()(this,"previews",new Map)}static get instance(){return E.internalInstance}static getPreviewChangedEventName(e){return"room_preview_changed:"+(null==e?void 0:e.roomId)}getPreviewForRoom(e,t){if(!e)return null;this.previews.has(e.roomId)||this.generatePreview(e,t);const s=this.previews.get(e.roomId);return s?s.has(t)?s.get(t):s.get(y):null}generatePreview(e,t){const s=e.timeline;if(!s)return;let n=this.previews.get(e.roomId);n||(n=new Map,this.previews.set(e.roomId,n)),n.has(y)||n.set(y,null),t&&!n.has(t)&&n.set(t,null);let a=!1;for(let t=s.length-1;t>=0;t--){if(t===s.length-50)return;const i=s[t],o=_[i.getType()];if(!o)continue;if(o.isState&&Object(g.r)(i.getStateKey()))continue;const r=o.previewer.getTextFor(i,null);if(!r)continue;a=a||r!==n.get(y),n.set(y,r);const l=Array.from(n.keys()).filter(e=>e!==y);for(const e of l){const t=e===y?null:e,s=o.previewer.getTextFor(i,t);s===r?(a=a||r!==n.get(e),n.delete(e)):(a=a||s!==n.get(e),n.set(e,s))}return void(a&&(this.previews.set(e.roomId,n),this.emit(v.b,this),this.emit(E.getPreviewChangedEventName(e),e)))}this.previews.set(e.roomId,new Map),this.emit(v.b,this),this.emit(E.getPreviewChangedEventName(e),e)}async onAction(e){if(this.matrixClient&&("MatrixActions.Room.timeline"===e.action||"MatrixActions.Event.decrypted"===e.action)){const t=e.event;if(!this.previews.has(t.getRoomId()))return;this.generatePreview(this.matrixClient.getRoom(t.getRoomId()),y)}}}a()(E,"internalInstance",new E)},function(e,t,s){"use strict";s.d(t,"a",(function(){return b}));var n=s(82),a=s.n(n),i=s(86),o=s(87),r=s(89),l=(s(85),s(83)),c=(s(661),s(175)),d=s(138),m=s(158);s(248);let h;!function(e){e.SET_UP_ENCRYPTION="set_up_encryption",e.UPGRADE_ENCRYPTION="upgrade_encryption",e.VERIFY_THIS_SESSION="verify_this_session"}(h||(h={}));var u=s(455);function p(e){return"unverified_session_"+e}const g=e=>{const t=i.a.get(),s=t.getStoredDevice(t.getUserId(),e);d.a.sharedInstance().addOrReplaceToast({key:p(e),title:Object(l.a)("New login. Was this you?"),icon:"verification_warning",props:{description:Object(l.a)("Verify the new login accessing your account: %(name)s",{name:s.getDisplayName()}),acceptLabel:Object(l.a)("Verify"),onAccept:()=>{const s=t.requestVerification(t.getUserId(),[e]);r.a.createTrackedDialog("New Session Verification","Starting dialog",u.a,{verificationRequestPromise:s,member:t.getUser(t.getUserId())})},rejectLabel:Object(l.a)("Later"),onReject:()=>{b.sharedInstance().dismissUnverifiedSessions([e])}},component:m.a,priority:80})},f=e=>{d.a.sharedInstance().dismissToast(p(e))};class b{constructor(){a()(this,"dispatcherRef",void 0),a()(this,"dismissed",new Set),a()(this,"dismissedThisDeviceToast",!1),a()(this,"keyBackupInfo",null),a()(this,"keyBackupFetchedAt",null),a()(this,"ourDeviceIdsAtStart",null),a()(this,"displayingToastsForDeviceIds",new Set),a()(this,"_onWillUpdateDevices",async(e,t)=>{if(t)return;const s=i.a.get().getUserId();e.includes(s)&&this._ensureDeviceIdsAtStartPopulated()}),a()(this,"_onDevicesUpdated",e=>{e.includes(i.a.get().getUserId())&&this._recheck()}),a()(this,"_onDeviceVerificationChanged",e=>{e===i.a.get().getUserId()&&this._recheck()}),a()(this,"_onUserTrustStatusChanged",e=>{e===i.a.get().getUserId()&&this._recheck()}),a()(this,"_onCrossSingingKeysChanged",()=>{this._recheck()}),a()(this,"_onAccountData",e=>{(e.getType().startsWith("m.secret_storage.")||e.getType().startsWith("m.cross_signing."))&&this._recheck()}),a()(this,"_onSync",(e,t)=>{"PREPARED"===e&&null===t&&this._recheck()}),a()(this,"_onRoomStateEvents",e=>{"m.room.encryption"===e.getType()&&this._recheck()}),a()(this,"_onAction",({action:e})=>{"on_logged_in"===e&&this._recheck()})}static sharedInstance(){return window.mxDeviceListener||(window.mxDeviceListener=new b),window.mxDeviceListener}start(){i.a.get().on("crypto.willUpdateDevices",this._onWillUpdateDevices),i.a.get().on("crypto.devicesUpdated",this._onDevicesUpdated),i.a.get().on("deviceVerificationChanged",this._onDeviceVerificationChanged),i.a.get().on("userTrustStatusChanged",this._onUserTrustStatusChanged),i.a.get().on("crossSigning.keysChanged",this._onCrossSingingKeysChanged),i.a.get().on("accountData",this._onAccountData),i.a.get().on("sync",this._onSync),i.a.get().on("RoomState.events",this._onRoomStateEvents),this.dispatcherRef=o.a.register(this._onAction),this._recheck()}stop(){i.a.get()&&(i.a.get().removeListener("crypto.willUpdateDevices",this._onWillUpdateDevices),i.a.get().removeListener("crypto.devicesUpdated",this._onDevicesUpdated),i.a.get().removeListener("deviceVerificationChanged",this._onDeviceVerificationChanged),i.a.get().removeListener("userTrustStatusChanged",this._onUserTrustStatusChanged),i.a.get().removeListener("crossSigning.keysChanged",this._onCrossSingingKeysChanged),i.a.get().removeListener("accountData",this._onAccountData),i.a.get().removeListener("sync",this._onSync),i.a.get().removeListener("RoomState.events",this._onRoomStateEvents)),this.dispatcherRef&&(o.a.unregister(this.dispatcherRef),this.dispatcherRef=null),this.dismissed.clear(),this.dismissedThisDeviceToast=!1,this.keyBackupInfo=null,this.keyBackupFetchedAt=null,this.ourDeviceIdsAtStart=null,this.displayingToastsForDeviceIds=new Set}async dismissUnverifiedSessions(e){for(const t of e)this.dismissed.add(t);this._recheck()}dismissEncryptionSetup(){this.dismissedThisDeviceToast=!0,this._recheck()}_ensureDeviceIdsAtStartPopulated(){if(null===this.ourDeviceIdsAtStart){const e=i.a.get();this.ourDeviceIdsAtStart=new Set(e.getStoredDevicesForUser(e.getUserId()).map(e=>e.deviceId))}}async _getKeyBackupInfo(){const e=(new Date).getTime();return(!this.keyBackupInfo||this.keyBackupFetchedAt<e-3e5)&&(this.keyBackupInfo=await i.a.get().getKeyBackupVersion(),this.keyBackupFetchedAt=e),this.keyBackupInfo}shouldShowSetupEncryptionToast(){if(Object(c.d)())return!1;const e=i.a.get();return e&&e.getRooms().some(t=>e.isRoomEncrypted(t.roomId))}async _recheck(){const e=i.a.get();if(!e.isCryptoEnabled())return;if(!e.isInitialSyncComplete())return;await e.isCrossSigningReady(),await e.isSecretStorageReady();d.a.sharedInstance().dismissToast("setupencryption"),this._ensureDeviceIdsAtStartPopulated();const t=new Set,s=new Set,n=e.getStoredDevicesForUser(e.getUserId());for(const a of n){if(a.deviceId===e.deviceId)continue;await e.checkDeviceTrust(e.getUserId(),a.deviceId);this.dismissed.has(a.deviceId)||(this.ourDeviceIdsAtStart.has(a.deviceId)?t.add(a.deviceId):s.add(a.deviceId))}for(const e of s)g(e);for(const e of this.displayingToastsForDeviceIds)s.has(e)||f(e);this.displayingToastsForDeviceIds=s}}},,,function(e,t,s){"use strict";s.d(t,"a",(function(){return h}));var n=s(82),a=s.n(n),i=s(181),o=s(314),r=s(6),l=s(114),c=s(120),d=s(109);class m extends r.EventEmitter{constructor(e){super(),this.community=e,a()(this,"roomIds",[]),a()(this,"userIds",[]),a()(this,"onStoreUpdate",async()=>{const e=this.roomIds;this.roomIds=(await l.a.getGroupRooms(this.community.groupId)).map(e=>e.roomId);const t=this.userIds;this.userIds=(await l.a.getGroupMembers(this.community.groupId)).map(e=>e.userId),(Object(c.d)(e,this.roomIds)||Object(c.d)(t,this.userIds))&&this.emit(o.a)}),l.a.on("update",this.onStoreUpdate),this.onStoreUpdate()}get relativePriority(){return o.b.Lowest}isVisible(e){return this.roomIds.includes(e.roomId)||this.userIds.includes(d.a.shared().getUserIdForRoomId(e.roomId))}destroy(){l.a.off("update",this.onStoreUpdate)}}class h{constructor(e){this.store=e,a()(this,"filters",new Map),a()(this,"onTagsUpdated",()=>{const e=Array.from(this.filters.keys()),t=i.a.getSelectedTags();if(Object(c.d)(e,t)){if(!this.store.matrixClient)return void console.warn("Tag update without an associated matrix client - ignoring");const s=new Map,n=t.filter(e=>e.startsWith("+"));for(const e of n){const t=this.store.matrixClient.getGroup(e);if(!t){console.warn("Group selected with no group object available: "+e);continue}let n=this.filters.get(e);n||(n=new m(t)),s.set(e,n)}const a=Object(c.b)(e,t);for(const e of a.added){const t=s.get(e);t&&this.store.addFilter(t)}for(const e of a.removed){const t=this.filters.get(e);t&&(this.store.removeFilter(t),t.destroy())}this.filters=s}}),i.a.addListener(this.onTagsUpdated)}}}]]);
//# sourceMappingURL=init.js.map